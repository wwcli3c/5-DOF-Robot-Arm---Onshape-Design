"use strict";(self.webpackChunkNewton=self.webpackChunkNewton||[]).push([[88],{54784:function(e,t,i){i.d(t,{d:function(){return s}});class s{constructor(){this.activeMateConnectorMap=new Map}addMateConnector(e){e&&e.length>0&&this.activeMateConnectorMap.set(e,null)}removeMateConnector(e){if(e&&e.length>0&&this.activeMateConnectorMap.has(e)){const t=this.activeMateConnectorMap.get(e);this.activeMateConnectorMap.delete(e),t&&!t.isHidden&&t.muteIfActive()}}removeAllMateConnectors(){for(const e of this.activeMateConnectorMap.keys())this.removeMateConnector(e)}resetMateConnectors(e){this.removeAllMateConnectors();for(const t of e)this.addMateConnector(t)}isMateConnectorActive(e,t){const i=this.activeMateConnectorMap.has(e);return i&&!this.activeMateConnectorMap.get(e)&&this.activeMateConnectorMap.set(e,t),i}destroy(){this.removeAllMateConnectors()}}},75269:function(e,t,i){i.d(t,{o7:function(){return m}});var s=i(35589),n=i(36222),r=i(94205);class a{constructor(){this.subGeometries=[],this.positions=void 0}}class o{constructor(){this.matrixIndex=0,this.geometryIndex=0,this.subGeometries=[]}}class h{}class c{constructor(){this.geometries=[],this.matrices=[],this.instances=[]}}function l(e,t){!function(e,t,i){let s="";for(let t=0;t<e.length;t+=3)s+=`v ${e[t+0]} ${e[t+1]} ${e[t+2]}\n`;for(let e=0;e<t.length;e+=3)s+=`f ${t[e+0]+1} ${t[e+1]+1} ${t[e+2]+1}\n`;i(new Blob([s],{type:"text/json"}),"model.obj")}(e.positions,e.indices,t)}var d=i(1509);function u(e,t,i){let s=!0,n=0;for(let r=0;r<e.length-2;r++)e[r+2]!==e[r+1]&&e[r+1]!==e[r]?(s&&(s=!1,n=0),0==n%2?(i.push(t+e[r+2]),i.push(t+e[r+1]),i.push(t+e[r+0])):(i.push(t+e[r+2]),i.push(t+e[r+0]),i.push(t+e[r+1])),n++):s=!0}class g{constructor(){this.bodyGeometryMap=new Map}}function p(e,t,i,n,c,l){const d=e+i.getFullElementId();let g=-1;if(l.bodyGeometryMap.has(d))g=l.bodyGeometryMap.get(d);else{g=c.geometries.length;const s=function(e,t,i){const s=t.getEntitiesForBody(e);if(!s)return;const n=new a;let o=0;const h=[],c=[];for(const e of s){const t=i.retrieveEntityMetaData(e).getMeshIncrement();if(r.PrimitiveType.TRIANGLE_STRIP===t.primitiveType){for(const e of t.points)h.push(e);const e=c.length;u(t.indices,o/3,c);const i=c.length-e;o+=t.points.length,n.subGeometries.push({offset:e,count:i})}}return n.positions=new Float32Array(h),n.indices=new Uint32Array(c),n}(e,t,i);if(!s)return;c.geometries.push(s),l.bodyGeometryMap.set(d,g)}const p=new o;p.geometryIndex=g;const m=s.create();n.occurrenceData.transform.getGlMatrix(m);const f=new h;f.world=function(e){return new Float32Array(e)}(m),p.matrixIndex=c.matrices.length,c.matrices.push(f),c.instances.push(p)}function m(e=!1,t=!1){const i=new c,s=new g;if(Object.values((0,n.getDrawers)()).forEach((e=>{const t=e.getModelViewManagers().getManager(),n=t.getDisplayedElement();if(!e.isHidden()&&t.displayingAssembly()){if(!n)return;const e=n.getOccurrences();Object.values(e).forEach((e=>{const n=t.getPartStudio(e.fullElementId);if(n){const t=n.getBodyComponent();for(let r=0;r<e.partIds.length;r++){const a=e.partIds[r],o=t.retrieveBodyMetaData(a).meshIncrement;o?o.points:p(a,t,n,e,i,s)}}}))}})),t){const e=function(e){const t=[],i=[];for(const s of e.geometries){const e=t.length/3;if(s.positions)for(const e of s.positions)t.push(e);if(s.indices)for(const t of s.indices)i.push(t+e)}return{positions:t,indices:i}}(i);l(e,d.G)}var r;e?function(e,t){const i=[];for(const t of e.geometries)i.push({numPositions:t.positions?t.positions.length:0,numIndices:t.indices?t.indices.length:0,subGeometries:t.subGeometries});const s={matrices:e.matrices,instances:e.instances,geometryMetaDataList:i};t(new Blob([JSON.stringify(s)],{type:"text/json"}),"modelext.json");const n=[],r=[];for(const t of e.geometries)t.positions&&n.push(t.positions),t.indices&&r.push(t.indices);const a={type:"application/octet-stream"};t(new Blob(n,a),"positions_blob.bin"),t(new Blob(r,a),"indices_blob.bin")}(i,d.G):(r=i,(0,d.G)(new Blob([JSON.stringify(r)],{type:"text/json"}),"model.json"))}},59403:function(e,t,i){i.d(t,{$:function(){return l}});var s=i(18600),n=i(99669),r=i(94205);if(666==i.j)var a=i(34015);if(666==i.j)var o=i(81578);if(666==i.j)var h=i(68100);var c=i(68434);class l extends(666==i.j?r.PolarDimension:null){constructor(e,t,i){super(e,t,i),this.displayData=null,this.id="AngularDimension"}updateFromDisplayData(e){this.displayData=e,this.isBad=e.isOverDefined,this.isDriven=e.isDriven,this.updateDimensionMatrices(),this.viewer.requestDraw()}getDisplayValue(e,t){return(0,s.KZ)(e,t.getAngleUnits())}getValueSuffix(e){const t=e.getAngleUnits();t?.toLowerCase();return(0,r.getAngularValueSuffix)(t)}addArcLengthAnnotation(e,t,i,s,n,r,a,o){return 0}isArcLengthDimension(){return!1}getPosition(){return this.polarToDimension(this.displayData.positionT,this.displayData.positionR)}getDefaultPrecision(e){return this.isArcLengthDimension()?e.getLengthUnitsDisplayPrecision():e.getAngleUnitsDisplayPrecision()}setPosition(e){this.displayData.positionR=Math.sqrt(e[0]*e[0]+e[1]*e[1]),this.displayData.positionT=Math.atan2(e[1],e[0])}getLabelPositionInPlane(){const e=this.polarToDimension(this.displayData.positionT,this.displayData.positionR);return c.xB.multiplyVec2(this.dimensionMatrix,[e[0],e[1]],a.create())}getDimensionUnits(e){return e.getAngleUnits()}addPointAtOffsetFromDimensionPoint(e,t,i,s,n,r){let a=this.polarToDimension(s,n);const h=[Math.cos(s),Math.sin(s)],l=[-h[1]*e,h[0]*e];a=c.gv.add(a,c.gv.add(c.gv.scale(h,i,o.create()),c.gv.scale(l,t,o.create())));const d=this.getModelPoint(a[0],a[1]);for(let e=0;e<3;++e)r.push(d[e])}updateAngleValueTextures(e){const t=this.displayData.value,i=this.getDisplayValue(t,e),s=this.getValuePrefix(e),n=this.getValueSuffix(e);this.updateValueTexture(i,e,s,n),this.updateToleranceTextureWithSuffix(e,n)}addAngleArrow(e,t,i,s,n,r){this.addPointAtOffsetFromDimensionPoint(e,0,0,s,this.displayData.positionR,r),this.addPointAtOffsetFromDimensionPoint(e,0,.5*-i,s+n*e*(t?-1:1),this.displayData.positionR,r),this.addPointAtOffsetFromDimensionPoint(e,0,.5*i,s+n*e*(t?-1:1),this.displayData.positionR,r)}addAngleArrows(e,t,i,s){let n=this.getConstantsManager().getNumber("DIMENSION_ARROW_HEIGHT_PIXELS")*e,a=this.getConstantsManager().getNumber("DIMENSION_ARROW_WIDTH_PIXELS")*e;const o=s-i,h=Math.abs(o*this.displayData.positionR)*this.getConstantsManager().getNumber("DIMENSION_ARROW_MAX_PROPORTION");if(a>h){const e=h/a;n*=e,a*=e}const c=[],l=a/this.displayData.positionR;this.addAngleArrow(t,!1,n,i,l,c),this.addAngleArrow(t,!0,n,s,l,c),this.updateDimensionComponent(r.DimensionConstants.ARROWS_ID,r.DimensionConstants.NO_SELECTION_ID,(0,r.createTriangles)(c,[0,1,2,3,4,5],void 0,this.getArrowColor()),r.DimensionConstants.ARROW_PROPERTIES)}addAngleWitnessLines(e,t,i,s){const n=this.getScreenSpaceParameters(e,t),a=this.displayData.positionR+(this.displayData.witnessEndPoint0r<this.displayData.positionR?n.extension:-n.extension),o=this.displayData.positionR+(this.displayData.witnessEndPoint1r<this.displayData.positionR?n.extension:-n.extension);let h,c;if(this.isArcLengthDimension())h=this.displayData.witnessEndPoint0r+(this.displayData.witnessEndPoint0r>this.displayData.positionR?-n.gap:n.gap),c=this.displayData.witnessEndPoint1r+(this.displayData.witnessEndPoint1r>this.displayData.positionR?-n.gap:n.gap);else{const e=this.displayData.witnessMaxPoint0r+n.gap,t=this.displayData.witnessMinPoint0r-n.gap,i=this.displayData.witnessMaxPoint1r+n.gap,s=this.displayData.witnessMinPoint1r-n.gap;h=this.displayData.positionR>e?e:this.displayData.positionR<t?t:a,c=this.displayData.positionR>i?i:this.displayData.positionR<s?s:o}const l=(e,t,i,s)=>{this.updateDimensionLineComponent(e,this.getModelPointFromPolar(t,i),this.getModelPointFromPolar(t,s))};l(r.DimensionConstants.WITNESS0_ID,i,h,a),l(r.DimensionConstants.WITNESS1_ID,s,c,o)}addAngleArcs(e,t,i,s,a){const o=this.getPosition(),h=-Math.sin(this.displayData.positionT),l=Math.cos(this.displayData.positionT),d=c.S4.normalize(c.S4.subtract(this.getModelPoint(o[0]+h,o[1]+l),e)),u=new r.Arc,g=this.getVisualRightVector(),p=this.getValueGapWithIcon(d,g,s,a,.5*t,0)+i;let m=0,f=!0;if(Math.abs(this.displayData.positionR)>n.W.ZERO_LENGTH){const e=.5*p/this.displayData.positionR;Math.abs(e)<1&&(m=Math.abs(2*Math.asin(e)),f=!1)}const I=this.putAnglesInRange([this.displayData.witnessEndPoint0t,this.displayData.witnessEndPoint1t]);let E=I[0],S=I[1];if(E>S){const e=E;E=S,S=e}const T=2*Math.PI,D=Math.floor((this.displayData.positionT-E)/T),C=this.displayData.positionT-D*T,M=C+m/2,y=C-m/2;if(f||M<E||y>S){const e=this.generateArcParamters(E,S,C);0!==e.secondAngle&&(e.secondAngle+=e.firstAngle>e.secondAngle?m/2:-m/2),this.makeArc(e.firstAngle,e.secondAngle,u),this.makeArc(E,S,u)}else y>E&&this.makeArc(E,y,u),M<S&&this.makeArc(M,S,u);const A=new r.MeshIncrement(r.PrimitiveType.LINES,u.points,u.indices);(0,r.addColorToIncrement)(this.getLineColor(),A),(0,r.addSizeToIncrement)(this.getLineWidth(),A),this.getLineStyle()&&(0,r.addStyleToIncrement)(this.getLineStyle(),A),this.updateDimensionComponent(r.DimensionConstants.ARC_PRIMITIVE_ID,r.DimensionConstants.LINE_SELECTION_ID,A,r.DimensionConstants.LINE_PROPERTIES)}update(e,t){if(!this.displayData)return;const i=this.getPosition(),s=this.putAngleInRange(this.displayData.witnessEndPoint0t),n=this.putAngleInRange(this.displayData.witnessEndPoint1t),a=e.getPixelSizeAtWorldPoint(this.transformPoint(this.getModelPoint(i[0],i[1])));this.updateAngleValueTextures(t);const o=this.valueTextureInfo.getTexture(),c=this.toleranceTextureInfo.getTexture(),l=new r.TolerantDimensionLayout(a,o,c);let d=1;s>n&&(d=-1),this.addAngleArrows(a,d,s,n),this.addAngleWitnessLines(t,a,s,n);const u=this.getModelPointFromPolar(this.displayData.positionT,this.displayData.positionR),g=this.getVisualRightVector(),p=this.getVisualUpVector(),m=(0,r.orientText)(e,g,p,this.transform),f=h.scale(h.create(),p,.5*l.combinedWorldSize.height),I=h.subtract(h.create(),u,f),E=h.scale(h.create(),g,.5*l.combinedWorldSize.width),S=h.subtract(h.create(),I,E),T=h.add(h.create(),I,E),D=h.scale(h.create(),p,l.combinedWorldSize.height),C=h.add(h.create(),S,D),M=h.add(h.create(),T,D),y=h.add(h.create(),m[0]?T:S,f),A=this.addArcLengthAnnotation(m[1],-this.displayData.coordinateSystem.m00,-this.displayData.coordinateSystem.m01,l.combinedWorldSize.width,l.combinedWorldSize.height,this.displayData.positionT,this.displayData.positionR,this.displayData.clockwise),P=this.updateIconDimensionComponent(a,y,g,p,m);if(this.addAngleArcs(u,P,A,l.combinedWorldSize.width,l.combinedWorldSize.height),this.updateBasicBox([S,C,M,T]),c){const e=l.getValueCorners(S,p,g,m[0]);this.updateValueDimensionComponent(o,e.lowerLeft,e.lowerRight,e.upperLeft,m);const t=l.getToleranceCorners(S,p,g,m[0]);this.updateToleranceDimensionComponent(c,t.lowerLeft,t.lowerRight,t.upperLeft,m)}else this.updateValueDimensionComponent(o,S,T,C,m),this.removeToleranceDimensionComponent();const O=m[1]?I:h.add(h.create(),I,D);this.updateExpressionDimensionComponent(a,O,g,p,m)}getFitBounds(){const e=new r.BoundingBox;return this.addPointToBounds(this.getModelPointFromPolar(this.displayData.witnessEndPoint0t,this.displayData.witnessEndPoint0r),e),this.addPointToBounds(this.getModelPointFromPolar(this.displayData.witnessEndPoint1t,this.displayData.witnessEndPoint1r),e),this.addPointToBounds(this.getModelPointFromPolar(this.displayData.witnessEndPoint0t,this.displayData.positionR),e),this.addPointToBounds(this.getModelPointFromPolar(this.displayData.witnessEndPoint1t,this.displayData.positionR),e),this.addPointToBounds(this.getModelPointFromPolar(this.displayData.positionT,this.displayData.positionR),e),e}makeArc(e,t,i){const s=i.getIndexOffset();let r=e,a=Math.max(Math.floor(n.W.NUMBER_OF_POINTS_IN_FULL_CIRCLE*Math.abs(t-e)/(2*Math.PI)+1),0);isNaN(a)&&(a=0);const o=new Array(3*(a+1)),h=(t-e)/a;for(let e=0;e<a+1;++e){const t=this.getModelPointFromPolar(r,this.displayData.positionR);for(let i=0;i<3;++i)o[3*e+i]=t[i];r+=h}const c=new Array(2*a);let l;for(c[0]=s,l=1;l<a;l++)c[2*l-1]=l+s,c[2*l]=l+s;c[c.length-1]=l+s,i.concat(o,c)}}},94199:function(e,t,i){i.d(t,{$D:function(){return b},CO:function(){return N},Jq:function(){return v},Ro:function(){return J},_p:function(){return X},io:function(){return _},t_:function(){return z},wN:function(){return ee}});var s=i(86925),n=i(32606),r=i(72372),a=i(18600),o=i(22681),h=i(19027),c=i(29327);if(666==i.j)var l=i(88892);var d=i(99669),u=i(8255),g=i(94205);if(666==i.j)var p=i(81578);if(666==i.j)var m=i(35589);if(666==i.j)var f=i(68100);if(666==i.j)var I=i(34015);if(666==i.j)var E=i(60482);var S=i(68434),T=i(21512),D=i(9851),C=i(97511),M=i(13265);const y="expression",A="tolerance",P="icon";let O=!0,R=!1,w=!1;function v(e){O=e}function _(e){R=e}function N(e){w=e}function b(e){return"degree"===e?"°":"radian"===e?" radian":""}const L={isVisible:!0,isTwoSided:!0,priority:g.RenderOrderPriority.HIGHER,primitiveType:g.PrimitiveType.TRIANGLES,isShowThrough:!0,isDepthTested:!1,isMuted:!1,isStencilTested:!1,isStencilWritten:!1},F=[Object.assign((0,s.Z)(L),{isPickable:!0}),Object.assign((0,s.Z)(L),{isPickable:!1,priority:g.RenderOrderPriority.HIGHEST}),Object.assign((0,s.Z)(L),{isPickable:!0,priority:g.RenderOrderPriority.DEFAULT,isShowThrough:!1,isDepthTested:!0,isStencilWritten:!0}),Object.assign((0,s.Z)(L),{isPickable:!0,priority:g.RenderOrderPriority.LOWER,isMuted:!0,isStencilTested:!0})],x="value",B="expression",V="tolerance",U="icon",H=1.25*d.W.MAX_MODEL_SIZE,G="dt.",k="#",W=/^\s*-?[0-9]*[.,]?[0-9]*([eE]-?[0-9]+)?[fFdD]?\s*\*?\s*[a-z]*\s*$/;var z;function X(e){return e.includes(k)?z.WITH_VARIABLES:W.test(e)?z.VALUE_ONLY:z.WITHOUT_VARIABLES}!function(e){e[e.VALUE_ONLY=0]="VALUE_ONLY",e[e.WITH_VARIABLES=1]="WITH_VARIABLES",e[e.WITHOUT_VARIABLES=2]="WITHOUT_VARIABLES"}(z||(z={}));const Z=n.default.getManager();class q{constructor(){this.standardTexture=null,this.mutedTexture=null,this.mutedMaterial=null,this.mutedTextureOptions=null,this.mutedTextureText="",this.standardMaterial=(0,g.createTextureMaterial)()}destroyTextures(){this.standardTexture&&(this.standardTexture.destroy(),this.standardTexture=null),this.mutedTexture&&(this.mutedTexture.destroy(),this.mutedTexture=null)}hasTexture(){return!!this.standardTexture}getTexture(){return this.standardTexture}getStandardMaterial(){return this.standardMaterial}getMutedMaterial(e){return!this.mutedMaterial&&this.mutedTextureOptions&&(this.mutedMaterial=(0,g.createTextureMaterial)(),this.mutedTexture=(0,g.createTextureFromText)(e,this.mutedTextureText,this.mutedTextureOptions),this.mutedMaterial.ambientTexture=this.mutedTexture),this.mutedMaterial}destroyAll(){this.destroyTextures(),this.standardMaterial&&(this.standardMaterial.destroy(),this.standardMaterial=null),this.mutedMaterial&&(this.mutedMaterial.destroy(),this.mutedMaterial=null)}createTextures(e,t,i){this.destroyTextures(),this.standardTexture=(0,g.createTextureFromText)(e,t,i),this.standardMaterial.ambientTexture=this.standardTexture,this.mutedTextureOptions={...i,color:Z.getColor("DIMENSION_INACTIVE_OCCLUDED_COLOR")},this.mutedTextureText=t,this.mutedMaterial&&(this.mutedTexture=(0,g.createTextureFromText)(e,t,this.mutedTextureOptions),this.mutedMaterial.ambientTexture=this.mutedTexture)}}function Y(e,t){return e===z.VALUE_ONLY?"":"expression-"+(e===z.WITH_VARIABLES?"external":"internal")+(t?":bad":":normal")}function K(e){const t=(e,t)=>{const i=new g.ImageData;return i.id=Y(e,t),i.svgToStyle=function(e,t){if(e===z.VALUE_ONLY)return"";let i=e===z.WITH_VARIABLES?"dimension-expression":"function";return t&&(i+="-error"),i+=".svg",i}(e,t),i},i=[t(z.WITH_VARIABLES,!1),t(z.WITHOUT_VARIABLES,!1),t(z.WITH_VARIABLES,!0),t(z.WITHOUT_VARIABLES,!0)];return(0,g.createAtlasFromResources)(e,Z.getNumber("DIMENSION_ICON_SIZE_PIXELS"),i,{sourcesHaveTransparency:!0})}const j=666==i.j?[]:null;let Q=0;function $(e,t){if(null==e.getResources().dimensionAtlas&&j.push(t),e.getResources().dimensionAtlasCreationInitiated)return;e.getResources().dimensionAtlasCreationInitiated=!0;const i=Q++;e.getResources().dimensionAtlasCreationId=i;e.getTextureAtlasFactory().getAtlas(g.DIMENSION_ATLAS,K.bind(void 0,e)).then((t=>{i===e.getResources().dimensionAtlasCreationId&&(t?(e.getResources().dimensionAtlas=t,e.getResources().dimensionMaterial.ambientTexture=t.texture,j.forEach((e=>e())),j.length=0):D.log.warn("Could not load texture atlas"))}),(e=>D.log.error(e)))}class J extends(666==i.j?g.UIElement:null){constructor(e,t,i){super(e),this.displayData=null,this.updateOnNextDraw=!0,this.lastPixelSizeWorld=0,this.lastFlips=[],this.lastFadeAlphaScaling=1,this.featureIsActive=!1,this.isBad=!1,this.isDriven=!1,this.value=0,this.expression="",this.expressionType=z.VALUE_ONLY,this.hovered=!1,this.isConfigured=!1,this.lastValueProperties=null,this.lastExpressionProperties=null,this.lastToleranceProperties=null,this.valueTextureInfo=new q,this.expressionTextureInfo=new q,this.toleranceTextureInfo=new q,this.textDragging=!1,this.textDragOffset=p.create(),this.preferences=null,this.selected=!1,this.pushedMoveCursor=!1,this.forPreview=t??!1,this.listenTo(this,g.UiEvents.MOUSE_ENTER+g.DimensionConstants.LINE_SELECTION_ID,this.onMouseEnterLines),this.listenTo(this,g.UiEvents.MOUSE_LEAVE+g.DimensionConstants.LINE_SELECTION_ID,this.onMouseLeaveLines),this.listenTo(this,g.UiEvents.CLICK+g.DimensionConstants.LINE_SELECTION_ID,this.onClick),this.listenTo(this,g.UiEvents.SELECT+g.DimensionConstants.LINE_SELECTION_ID,this.onSelect),this.listenTo(this,g.UiEvents.DESELECT+g.DimensionConstants.LINE_SELECTION_ID,this.onDeselect),this.listenTo(this,g.UiEvents.MOUSE_ENTER+g.DimensionConstants.VALUE_SELECTION_ID,this.onMouseEnterText),this.listenTo(this,g.UiEvents.MOUSE_ENTER+y,this.onMouseEnterText),this.listenTo(this,g.UiEvents.MOUSE_ENTER+A,this.onMouseEnterText),this.listenTo(this,g.UiEvents.MOUSE_ENTER+P,this.onMouseEnterText),this.listenTo(this,g.UiEvents.MOUSE_LEAVE+g.DimensionConstants.VALUE_SELECTION_ID,this.onMouseLeaveText),this.listenTo(this,g.UiEvents.MOUSE_LEAVE+y,this.onMouseLeaveText),this.listenTo(this,g.UiEvents.MOUSE_LEAVE+A,this.onMouseLeaveText),this.listenTo(this,g.UiEvents.MOUSE_LEAVE+P,this.onMouseLeaveText),this.listenTo(this,g.UiEvents.CLICK+g.DimensionConstants.VALUE_SELECTION_ID,this.onClick),this.listenTo(this,g.UiEvents.CLICK+y,this.onClick),this.listenTo(this,g.UiEvents.CLICK+A,this.onClick),this.listenTo(this,g.UiEvents.CLICK+P,this.onClick),this.listenTo(this,g.UiEvents.SELECT+g.DimensionConstants.VALUE_SELECTION_ID,this.onSelect),this.listenTo(this,g.UiEvents.SELECT+y,this.onSelect),this.listenTo(this,g.UiEvents.SELECT+A,this.onSelect),this.listenTo(this,g.UiEvents.SELECT+P,this.onSelect),this.listenTo(this,g.UiEvents.DESELECT+g.DimensionConstants.VALUE_SELECTION_ID,this.onDeselect),this.listenTo(this,g.UiEvents.DESELECT+y,this.onDeselect),this.listenTo(this,g.UiEvents.DESELECT+A,this.onDeselect),this.listenTo(this,g.UiEvents.DESELECT+P,this.onDeselect),this.listenTo(this,g.UiEvents.DOUBLE_CLICK+g.DimensionConstants.LINE_SELECTION_ID,this.onDoubleClick),this.listenTo(this,g.UiEvents.DOUBLE_CLICK+g.DimensionConstants.VALUE_SELECTION_ID,this.onDoubleClick),this.listenTo(this,g.UiEvents.DOUBLE_CLICK+y,this.onDoubleClick),this.listenTo(this,g.UiEvents.DOUBLE_CLICK+A,this.onDoubleClick),this.listenTo(this,g.UiEvents.DOUBLE_CLICK+P,this.onDoubleClick),this.listenTo(this,g.UiEvents.DRAG_START+g.DimensionConstants.VALUE_SELECTION_ID,this.onDragStartText),this.listenTo(this,g.UiEvents.DRAG_START+y,this.onDragStartText),this.listenTo(this,g.UiEvents.DRAG_START+A,this.onDragStartText),this.listenTo(this,g.UiEvents.DRAG_START+P,this.onDragStartText),this.listenTo(this,g.UiEvents.DRAG+g.DimensionConstants.VALUE_SELECTION_ID,this.onDragText),this.listenTo(this,g.UiEvents.DRAG+y,this.onDragText),this.listenTo(this,g.UiEvents.DRAG+A,this.onDragText),this.listenTo(this,g.UiEvents.DRAG+P,this.onDragText),this.listenTo(this,g.UiEvents.DRAG_STOP+g.DimensionConstants.VALUE_SELECTION_ID,this.onDragStopText),this.listenTo(this,g.UiEvents.DRAG_STOP+y,this.onDragStopText),this.listenTo(this,g.UiEvents.DRAG_STOP+A,this.onDragStopText),this.listenTo(this,g.UiEvents.DRAG_STOP+P,this.onDragStopText),this.listenTo(this.viewer.getEventDispatcher(),g.DIMENSION_EDIT_CLOSED,this.onDimensionEditClosed),this.listenTo(this.viewer.getEventDispatcher(),g.SHOW_DIMENSION_EXPRESSIONS_CHANGED,this.onShowExpressionsChanged),this.elementId=i??"",this.valueTextureInfo=new q,this.expressionTextureInfo=new q,this.toleranceTextureInfo=new q,this.dimensionMatrix=m.create(),this.planeMatrix=m.create(),this.computedInverse=m.create(),this.appliedTransform=m.create(),this.valueNodeProperties=F.map((e=>{const t=e.isMuted?null:this.valueTextureInfo.getStandardMaterial();return new g.NodeProperties(Object.assign({material:t},e))})),this.expressionNodeProperties=F.map((e=>{const t=e.isMuted?null:this.expressionTextureInfo.getStandardMaterial();return new g.NodeProperties(Object.assign({material:t},e))})),this.toleranceNodeProperties=F.map((e=>{const t=e.isMuted?null:this.toleranceTextureInfo.getStandardMaterial();return new g.NodeProperties(Object.assign({material:t},e))})),$(this.viewer,this.onTextureAtlasChanged.bind(this))}isDimension(){return!0}hide(){this.isHighlighted()||(super.hide(),this.hovered=!1,this.selected=!1,this.textDragging=!1)}setFeatureActive(e){this.featureIsActive=e,this.viewer.requestDraw()}setAppliedTransform(e){this.appliedTransform=e,S.w$.inverse(this.getPlaneMatrix(),this.computedInverse)}getPlaneMatrix(){return S.w$.multiply(this.appliedTransform,this.planeMatrix,m.create())}getPlaneMatrixInverse(){return this.computedInverse}getConstantsManager(){return Z}onDevicePixelRatioChanged(e){this.lastValueProperties&&(this.valueTextureInfo.destroyTextures(),this.updateRawValueTexture(this.lastValueProperties.textRendered)),this.lastExpressionProperties&&(this.expressionTextureInfo.destroyTextures(),this.updateRawExpressionTexture(this.lastExpressionProperties.textRendered)),this.lastToleranceProperties&&(this.toleranceTextureInfo.destroyTextures(),this.updateRawToleranceTexture(this.lastToleranceProperties.textRendered)),$(this.viewer,this.onTextureAtlasChanged.bind(this))}remove(){this.hovered&&!w&&this.viewer.popCursor(),this.pushedMoveCursor&&this.removeMoveCursor(),this.valueTextureInfo.destroyAll(),this.expressionTextureInfo.destroyAll(),this.toleranceTextureInfo.destroyAll(),super.remove()}hasValueChanged(e){return!this.valueTextureInfo.hasTexture()||null==this.lastValueProperties||this.lastValueProperties.textRendered!==e||this.lastValueProperties.isBad!==this.isBad||this.lastValueProperties.hoveredOrTextDragging!==(this.hovered||this.textDragging)||this.lastValueProperties.isDriven!==this.isDriven||this.lastValueProperties.isConfigured!==this.isConfigured}hasExpressionChanged(e){return!this.expressionTextureInfo.hasTexture()||null==this.lastExpressionProperties||this.lastExpressionProperties.textRendered!==e||this.lastExpressionProperties.isBad!==this.isBad||this.lastExpressionProperties.hoveredOrTextDragging!==(this.hovered||this.textDragging)||this.lastExpressionProperties.selected!==this.selected}hasToleranceChanged(e){return!this.toleranceTextureInfo.hasTexture()||null==this.lastToleranceProperties||this.lastToleranceProperties.textRendered!==e||this.lastToleranceProperties.isBad!==this.isBad||this.lastToleranceProperties.hoveredOrTextDragging!==(this.hovered||this.textDragging)||this.lastToleranceProperties.selected!==this.selected||this.lastToleranceProperties.isDriven!==this.isDriven}getPickPriority(e){return R?g.PickPriority.REDUCED_DIMENSION_PRIORITY:g.PickPriority.DIMENSION}updateDimensionMatrices(){this.displayData&&(this.updateOnNextDraw=!0,this.dimensionMatrix=this.displayData.coordinateSystem.getGlMatrix(),this.planeMatrix=this.displayData.planeMatrix.getGlMatrix(),S.w$.inverse(this.getPlaneMatrix(),this.computedInverse),this.value=this.displayData.value)}getFeatureId(){return this.displayData?this.displayData.featureId:""}getPartId(){return this.displayData?this.displayData.partId:""}getElementId(){return this.elementId}getDimensionId(){return this.displayData?this.displayData.id:""}getParameterId(){return this.displayData?this.displayData.parameterId:""}getIsAnnotationDimension(){return!!this.displayData&&this.displayData.isAnnotationDimension}getHasTolerances(){return!!this.displayData&&(this.displayData.toleranceType!==o.gkc.NONE&&this.displayData.toleranceType!==o.gkc.UNKNOWN)}canPickThrough(){return!this.isInteractionEnabled()||R}isInteractionEnabled(){return!this.forPreview&&O&&this.lastFadeAlphaScaling>0}isForPreview(){return this.forPreview}isSelected(){return this.selected}destroyAllTextures(){this.destroyValueTexture(),this.destroyExpressionTexture(),this.destroyToleranceTexture()}destroyValueTexture(){this.valueTextureInfo&&(this.valueTextureInfo.destroyTextures(),this.updateOnNextDraw=!0)}destroyExpressionTexture(){this.expressionTextureInfo&&(this.expressionTextureInfo.destroyTextures(),this.updateOnNextDraw=!0)}destroyToleranceTexture(){this.toleranceTextureInfo&&(this.toleranceTextureInfo.destroyTextures(),this.updateOnNextDraw=!0)}onDefaultUnitsChanged(){this.destroyAllTextures(),this.viewer.requestDraw()}onTextureAtlasChanged(){this.expressionType!==z.VALUE_ONLY&&(this.updateOnNextDraw=!0,this.viewer.requestDraw())}onViewWillDraw(e,t){if(this.isHidden||!this.displayData)return;const i=this.getPosition(),s=e.getPixelSizeAtWorldPoint(this.transformPoint(this.getModelPoint(i[0],i[1]))),n=(0,g.orientText)(e,this.getVisualRightVector(),this.getVisualUpVector(),this.transform),r=this.calculateFadeAlphaScaling(e);r!==this.lastFadeAlphaScaling&&(this.lastFadeAlphaScaling=r,this.updateOnNextDraw=!0);const a=this.preferences&&this.preferences.displayLimitRangeTicks;(this.updateOnNextDraw||Math.abs(this.lastPixelSizeWorld-s)>d.W.ZERO_LENGTH||!(0,h.arraysEqual)(this.lastFlips,n)||a)&&(this.update(e,t),this.updateOnNextDraw=!1,this.lastPixelSizeWorld=s,this.lastFlips=n)}textIsReadOnly(){return this.preferences?.textReadOnly??!1}onMouseEnterText(e,t){this.textIsReadOnly()||(this.hovered=!0,this.destroyAllTextures(),this.pushMoveCursor(),(0,g.requestDraw)())}onMouseLeaveText(e,t){this.textIsReadOnly()||(this.hovered=!1,this.destroyAllTextures(),this.removeMoveCursor(),(0,g.requestDraw)())}pushMoveCursor(){w||this.pushedMoveCursor||(this.viewer.pushCursor(g.Cursor.MOVE),this.pushedMoveCursor=!0)}removeMoveCursor(){this.pushedMoveCursor&&(this.viewer.removeTopOccurrenceOfCursor(g.Cursor.MOVE),this.pushedMoveCursor=!1)}onDoubleClick(e,t){if(r.Jq.FeatureConfigurationService.getIsInConfigureFeatureMode())return;if(this.isConfigured)return void r.Jq.MessageBubbleService.showMessageWithAutoDismiss(i18n("Configured dimensions can be edited in the configuration table"));if(this.textIsReadOnly())return;const i=this.getLabelCanvasCoordinates();this.viewer.getEventDispatcher()?.trigger(g.DIMENSION_TEXT_DOUBLE_CLICKED,{featureId:this.getFeatureId(),dimensionId:this.getDimensionId(),parameterId:this.getParameterId(),positionX:i[0],positionY:i[1],dimension:this}),(0,g.requestDraw)()}onDragStartText(e,t,i){if(w)return;const s=this.mouseToDimensionCoordinates(t.mouseX,t.mouseY,t.camera);s?p.subtract(this.textDragOffset,s,this.getPosition()):p.zero(this.textDragOffset),this.textDragging=!0,this.destroyAllTextures(),i.requestDrag=!0}onDragText(e,t){if(w)return;const i=this.mouseToDimensionCoordinates(t.mouseX,t.mouseY,t.camera);i&&(p.subtract(i,i,this.textDragOffset),this.setPosition(i),this.updateOnNextDraw=!0,(0,g.requestDraw)())}startDrag(){this.forPreview=!0}finishDrag(){this.forPreview=!1,(0,g.requestDraw)()}dragToCanvasPosition(e){const t=this.viewer.getCamera(),i=this.mouseToDimensionCoordinates(e[0],e[1],t);i&&(this.setPosition(i),this.updateOnNextDraw=!0,(0,g.requestDraw)())}onMouseEnterLines(e,t){this.textIsReadOnly()||(this.hovered=!0,this.destroyAllTextures(),w||this.viewer.pushCursor(g.Cursor.DEFAULT),(0,g.requestDraw)())}onMouseLeaveLines(e,t){this.textIsReadOnly()||(this.hovered=!1,this.destroyAllTextures(),w||this.viewer.removeTopOccurrenceOfCursor(g.Cursor.DEFAULT),(0,g.requestDraw)())}onClick(e,t,i){w||(i.requestSelectedStatus=!0);const s=this.getLabelCanvasCoordinates();this.viewer.getEventDispatcher()?.trigger(g.DIMENSION_TEXT_SINGLE_CLICKED,{featureId:this.getFeatureId(),dimensionId:this.getDimensionId(),parameterId:this.getParameterId(),positionX:s[0],positionY:s[1],dimension:this})}onSelect(e,t){this.viewer.getEventDispatcher()?.trigger(g.DIMENSION_SELECTED,{featureId:this.getFeatureId(),parameterId:this.getParameterId(),partId:this.getPartId()});r.Jq.CapabilitiesService.checkConstraintManagerCurrentlyEnabled()&&((0,g.getActiveViewerEventDispatcher)().trigger(g.PICK_CONSTRAINT_SELECTED,e.sourcePick),e.uiElement instanceof J&&(0,C.m)().trigger(M.C.CONSTRAINT_MANAGER_FOCUS_CONSTRAINT,e.uiElement.getDisplayData().id)),this.selected=!0,this.destroyAllTextures(),(0,g.requestDraw)()}onDeselect(e,t){this.viewer.getEventDispatcher()?.trigger(g.DIMENSION_DESELECTED,{featureId:this.getFeatureId(),parameterId:this.getParameterId(),partId:this.getPartId()});r.Jq.CapabilitiesService.checkConstraintManagerCurrentlyEnabled()&&e.uiElement instanceof J&&(0,C.m)().trigger(M.C.CONSTRAINT_MANAGER_UNFOCUS_CONSTRAINT,e.uiElement.getDisplayData().id),this.selected=!1,this.destroyAllTextures(),(0,g.requestDraw)()}onDragStopText(e,t){if(w)return;if(""===this.getElementId())return;const i=this.getLabelPositionInPlane();this.viewer.getEventDispatcher()?.trigger(g.DIMENSION_TEXT_DRAG_ENDED,{featureId:this.getFeatureId(),dimensionId:this.getDimensionId(),parameterId:this.getParameterId(),positionX:i[0],positionY:i[1],isAnnotationDimension:this.getIsAnnotationDimension(),featureIsActive:this.featureIsActive,partId:this.getPartId()}),this.textDragging=!1,p.zero(this.textDragOffset),this.destroyAllTextures()}onDimensionEditClosed(e){!this.textIsReadOnly()&&this.hovered&&!w&&this.pushedMoveCursor&&(this.viewer.removeTopOccurrenceOfCursor(g.Cursor.MOVE),this.viewer.pushCursor(g.Cursor.MOVE),(0,g.requestDraw)())}addPointToBounds(e,t){for(let t=0;t<3;++t)if(e[t]>H||e[t]<-H)return;t.addPoint(e)}isDrivenDimension(){return this.isDriven}setIsDriven(e){this.isDriven=e,this.viewer.requestDraw()}canBeDrivenDimension(){return!0}isConfiguredDimension(){return this.isConfigured}setIsConfigured(e){this.isConfigured!==e&&(this.isConfigured=e,this.updateOnNextDraw=!0,this.viewer.requestDraw())}setExpression(e){this.expression!==e&&(this.expression=e,this.expressionType=X(e),this.updateOnNextDraw=!0,this.viewer.requestDraw())}onShowExpressionsChanged(e){this.updateOnNextDraw=!0,this.viewer.requestDraw()}getIsBad(){return this.isBad}setIsBad(e){this.isBad=e,this.updateOnNextDraw=!0,this.viewer.requestDraw()}getLabelPositionInPlane(){return[0,0]}getPlaneOrigin(){return S.w$.multiplyVec3(this.getPlaneMatrix(),[0,0,0],f.create())}getVisualVector(e){const t=this.getPlaneOrigin(),i=f.transformMat4(f.create(),e,this.getPlaneMatrix());return f.subtract(i,i,t),f.normalize(i,i)}getVisualUpVector(){return this.getVisualVector([0,1,0])}getVisualRightVector(){return this.getVisualVector([1,0,0])}getVisualNormal(){return this.getVisualVector([0,0,1])}getModelPoint(e,t,i){const s=S.xB.multiplyVec2(this.dimensionMatrix,[e,t],I.create());return S.w$.multiplyVec3(this.getPlaneMatrix(),[s[0],s[1],i??0],f.create())}getUiSelectionForText(){return new g.UISelection(this,g.DimensionConstants.VALUE_SELECTION_ID,"")}planeToDimensionCoordinates(e,t){const i=E.fromValues(this.dimensionMatrix[0],this.dimensionMatrix[3],this.dimensionMatrix[1],this.dimensionMatrix[4]),s=p.fromValues(this.dimensionMatrix[6],this.dimensionMatrix[7]);return p.subtract(s,p.fromValues(e,t),s),p.transformMat2(s,s,i)}mouseToDimensionCoordinates(e,t,i){const s=i.getRay(e,t),n=(0,g.intersectRayPlaneMatrix)(s,this.getPlaneMatrix());if(!n)return null;const r=S.w$.multiplyVec3(this.getPlaneMatrixInverse(),n,f.create());return r?this.planeToDimensionCoordinates(r[0],r[1]):null}getLabelCanvasCoordinates(){const e=this.getLabelPositionInPlane(),t=S.w$.multiplyVec3(this.getPlaneMatrix(),[e[0],e[1],0]),i=this.viewer.getPrimaryViewController().camera.projectWorldPointToCanvas(t),s=(0,l.x_)();return i[0]/=s,i[1]/=s,i}onAppearanceConstantsUpdated(){this.destroyAllTextures(),$(this.viewer,this.onTextureAtlasChanged.bind(this)),this.updateOnNextDraw=!0}ensureMutedTexturePresence(e,t){!this.getIsAnnotationDimension()||this.featureIsActive||t[3].material||(t[3].material=e.getMutedMaterial(this.viewer),t[3].updateId())}updateValueDimensionComponent(e,t,i,s,n){!this.needsValueTexture()||this.lastFadeAlphaScaling<d.W.ZERO_LENGTH?this.removeDimensionComponent(x):(this.ensureMutedTexturePresence(this.valueTextureInfo,this.valueNodeProperties),this.updateDimensionComponent(x,g.DimensionConstants.VALUE_SELECTION_ID,(0,g.createQuad)(t,i,s,void 0,[n[0]?e.rightCoordinate:e.leftCoordinate,n[1]?e.topCoordinate:e.bottomCoordinate],[n[0]?e.leftCoordinate:e.rightCoordinate,n[1]?e.bottomCoordinate:e.topCoordinate]),this.valueNodeProperties))}updateExpressionDimensionComponent(e,t,i,s,n){if(this.expressionType===z.VALUE_ONLY||!this.hovered&&!this.viewer.getSketch()?.showDimensionExpressions||this.lastFadeAlphaScaling<d.W.ZERO_LENGTH)return void this.removeDimensionComponent(B);this.updateExpressionTexture();const r=this.expressionTextureInfo.getTexture(),a=e*r.filledWidthPx,o=e*r.filledHeightPx,h=f.scale(f.create(),i,.5*a),c=f.scale(f.create(),s,n[1]?-o:o),l=f.subtract(f.create(),t,h),u=f.add(f.create(),t,h),p=f.add(f.create(),l,c);this.ensureMutedTexturePresence(this.expressionTextureInfo,this.expressionNodeProperties),this.updateDimensionComponent(B,y,(0,g.createQuad)(l,u,p,void 0,[n[0]?r.rightCoordinate:r.leftCoordinate,r.bottomCoordinate],[n[0]?r.leftCoordinate:r.rightCoordinate,r.topCoordinate]),this.expressionNodeProperties)}removeToleranceDimensionComponent(){this.removeDimensionComponent(V)}updateToleranceDimensionComponent(e,t,i,s,n){!this.needsToleranceTexture()||this.lastFadeAlphaScaling<d.W.ZERO_LENGTH?this.removeDimensionComponent(V):(this.ensureMutedTexturePresence(this.toleranceTextureInfo,this.toleranceNodeProperties),this.updateDimensionComponent(V,A,(0,g.createQuad)(t,i,s,void 0,[n[0]?e.rightCoordinate:e.leftCoordinate,n[1]?e.topCoordinate:e.bottomCoordinate],[n[0]?e.leftCoordinate:e.rightCoordinate,n[1]?e.bottomCoordinate:e.topCoordinate]),this.toleranceNodeProperties))}updateIconDimensionComponent(e,t,i,s,n){if(null==this.viewer.getResources().dimensionAtlas)return 0;if(this.expressionType===z.VALUE_ONLY)return this.removeDimensionComponent(U),0;const r=this.viewer.getResources().dimensionAtlas?.getTextureCoords(Y(this.expressionType,this.isBad));if(!r)return 0;const a=e*Z.getNumber("DIMENSION_ICON_SIZE_PIXELS"),o=f.scale(f.create(),i,n[0]?-a:a),h=f.scale(f.create(),s,.5*a),c=f.scale(f.create(),s,a),l=f.subtract(f.create(),t,h),d=f.subtract(f.create(),l,o),u=f.add(f.create(),d,c),p=(0,g.createQuad)(d,l,u,void 0,[r.lowS,n[1]?r.lowT:r.highT],[r.highS,n[1]?r.highT:r.lowT]);return this.updateDimensionComponent(U,P,p,this.viewer.getResources().dimensionNodeProperties),a}updateValueTexture(e,t,i,s){const n=i??"";let r=s??"";if(!this.preferences||this.preferences&&this.preferences.displayLimitRangeText){if(this.displayData?.hasMinimumLimit){const e=(0,a.KZ)(this.displayData.minimumLimit,this.getDimensionUnits(t));r+=", "+i18n("Min")+": "+this.getRoundedDimensionValueForTextDisplay(e,t),s&&(r+=s)}if(this.displayData?.hasMaximumLimit){const e=(0,a.KZ)(this.displayData.maximumLimit,this.getDimensionUnits(t));r+=", "+i18n("Max")+": "+this.getRoundedDimensionValueForTextDisplay(e,t),s&&(r+=s)}}this.getHasTolerances()&&(r+=this.getInlineToleranceText(t,s??""));const o=this.getRoundedDimensionValueForTextDisplay(e,t);let h=n+this.convertNumberToTextWithCommasAndPadding(o,t)+r;this.hasLimitTolerance()&&(h=n),this.updateRawValueTexture(h)}updateRawValueTexture(e){if(!this.hasValueChanged(e))return;if(this.destroyValueTexture(),!this.needsValueTexture())return;this.lastValueProperties={textRendered:e,isBad:this.isBad,hoveredOrTextDragging:this.hovered||this.textDragging,selected:this.selected,isDriven:this.isDriven,isConfigured:this.isConfigured};const{borderColor:t,borderThickness:i}=this.getValueBorderProperties(),s={color:this.getValueTextColor(),font:Z.getString("DIMENSION_VALUE_FONT"),size:Z.getNumber("DIMENSION_VALUE_HEIGHT_PIXELS"),paddingWithinBorder:Z.getNumber("DIMENSION_VALUE_BACKGROUND_PADDING"),backgroundColor:this.getValueBackgroundColor(),backgroundOpacity:Z.getNumber("DIMENSION_VALUE_BACKGROUND_OPACITY"),backgroundRadius:Z.getNumber("DIMENSION_VALUE_BACKGROUND_BORDER_RADIUS"),borderColor:t,borderThickness:i,dashLength:Z.getNumber("DIMENSION_CONFIGURED_DASH_LENGTH"),dashGapLength:Z.getNumber("DIMENSION_CONFIGURED_DASH_GAP_LENGTH")};this.valueTextureInfo.createTextures(this.viewer,e,s)}updateExpressionTexture(){const e=(0,T.truncate)(this.expression,70);this.updateRawExpressionTexture(e)}updateRawExpressionTexture(e){if(!this.hasExpressionChanged(e))return;this.destroyExpressionTexture(),this.lastExpressionProperties={textRendered:e,isBad:this.isBad,hoveredOrTextDragging:this.hovered||this.textDragging,selected:this.selected};const{borderColor:t,borderThickness:i}=this.getExpressionBorderProperties();let s=Z.getNumber("DIMENSION_EXPRESSION_BACKGROUND_PADDING");i&&(s-=i);const n={color:this.getExpressionTextColor(),font:Z.getString("DIMENSION_EXPRESSION_FONT"),size:Z.getNumber("DIMENSION_EXPRESSION_HEIGHT_PIXELS"),paddingWithinBorder:s,backgroundColor:this.getExpressionBackgroundColor(),backgroundOpacity:Z.getNumber("DIMENSION_EXPRESSION_BACKGROUND_OPACITY"),backgroundRadius:Z.getNumber("DIMENSION_EXPRESSION_BACKGROUND_BORDER_RADIUS"),borderColor:t,borderThickness:i};this.expressionTextureInfo.createTextures(this.viewer,e,n)}getInlineToleranceText(e,t){return this.displayData.toleranceType===o.gkc.MIN?" MIN":this.displayData.toleranceType===o.gkc.MAX?" MAX":this.displayData.toleranceType===o.gkc.FIT||this.displayData.toleranceType===o.gkc.FIT_WITH_TOLERANCE?""!==this.displayData.fitClass?" "+this.displayData.fitClass:"":this.displayData.toleranceType!==o.gkc.SYMMETRICAL?"":"±"+this.convertDimensionValueToText(e,this.displayData.upperTolerance)+t}convertDimensionValueToText(e,t){const i=(0,a.KZ)(t,this.getDimensionUnits(e)),s=this.getRoundedDimensionValueForTextDisplay(i,e);return this.convertNumberToTextWithCommasAndPadding(s,e)}convertNumberToTextWithCommasAndPadding(e,t){let i=e+"";return(this.getHasTolerances()||this.hasPrecisionOverride())&&(i=e.toFixed(this.getPrecision(t))),u.c.convertToCommaFormatIfNeeded(i)}needsToleranceTexture(){return this.getHasTolerances()&&(this.displayData.toleranceType===o.gkc.LIMITS||this.displayData.toleranceType===o.gkc.DEVIATION||this.displayData.toleranceType===o.gkc.FIT_TOLERANCE_ONLY||this.displayData.toleranceType===o.gkc.FIT_WITH_TOLERANCE)}needsValueTexture(){return!this.hasLimitTolerance()}hasLimitTolerance(){return this.getHasTolerances()&&this.displayData.toleranceType===o.gkc.LIMITS}updateToleranceTexture(e){this.updateToleranceTextureWithSuffix(e,"")}getNumberTextWithGuaranteedPlusOrMinus(e,t,i){const s=this.convertDimensionValueToText(e,Math.abs(t));return t>(i?-d.W.ZERO_LENGTH:d.W.ZERO_LENGTH)?"+"+s:"−"+s}updateToleranceTextureWithSuffix(e,t){if(this.needsToleranceTexture()){if(this.displayData.toleranceType===o.gkc.DEVIATION||this.displayData.toleranceType===o.gkc.FIT_TOLERANCE_ONLY||this.displayData.toleranceType===o.gkc.FIT_WITH_TOLERANCE){const i=this.getNumberTextWithGuaranteedPlusOrMinus(e,this.displayData.upperTolerance,!0),s=this.getNumberTextWithGuaranteedPlusOrMinus(e,this.displayData.lowerTolerance,!1);return this.updateRawToleranceTexture(i+t+"\n"+s+t)}if(this.displayData.toleranceType===o.gkc.LIMITS){const i=this.convertDimensionValueToText(e,this.displayData.value+this.displayData.upperTolerance),s=this.convertDimensionValueToText(e,this.displayData.value+this.displayData.lowerTolerance);this.updateRawToleranceTexture(i+t+"\n"+s+t)}}}updateRawToleranceTexture(e){if(!this.hasToleranceChanged(e))return;if(this.destroyToleranceTexture(),this.lastToleranceProperties={textRendered:e,isBad:this.isBad,hoveredOrTextDragging:this.hovered||this.textDragging,selected:this.selected,isDriven:this.isDriven},!this.needsToleranceTexture())return;const{borderColor:t,borderThickness:i}=this.getValueBorderProperties(),s={color:this.getValueTextColor(),font:Z.getString("DIMENSION_VALUE_FONT"),size:Z.getNumber("DIMENSION_VALUE_HEIGHT_PIXELS"),paddingWithinBorder:Z.getNumber("DIMENSION_VALUE_BACKGROUND_PADDING"),backgroundColor:this.getValueBackgroundColor(),backgroundOpacity:Z.getNumber("DIMENSION_VALUE_BACKGROUND_OPACITY"),backgroundRadius:Z.getNumber("DIMENSION_VALUE_BACKGROUND_BORDER_RADIUS"),borderColor:t,borderThickness:0,dashLength:Z.getNumber("DIMENSION_CONFIGURED_DASH_LENGTH"),dashGapLength:Z.getNumber("DIMENSION_CONFIGURED_DASH_GAP_LENGTH")};this.toleranceTextureInfo.createTextures(this.viewer,e,s)}getValueTextColor(){let e;return e=this.preferences?.colorName?this.preferences.colorName:this.isBad?"OVERCONSTRAINED_LINE_POINT_COLOR":this.isDriven?this.shouldHighlightDimensionWithSelectedColor()?"DIMENSION_DRIVING_VALUE_TEXT_COLOR":"DIMENSION_DRIVEN_LINE_POINT_COLOR":"DIMENSION_DRIVING_VALUE_TEXT_COLOR",Z.getColor(e)}shouldHighlightDimensionWithSelectedColor(){return!(!this.selected&&this.getHighlight()?.type!==g.HighlightType.SECONDARY)}getValueBackgroundColor(){return this.shouldHighlightDimensionWithSelectedColor()?Z.getColor("DIMENSION_VALUE_SELECTED_BACKGROUND_COLOR"):this.hovered||this.textDragging?this.isDriven?Z.getColor("DIMENSION_DRIVEN_VALUE_HOVERED_BACKGROUND_COLOR"):Z.getColor("DIMENSION_DRIVING_VALUE_HOVERED_BACKGROUND_COLOR"):null}getValueBorderProperties(){return this.isConfigured?{borderColor:Z.getColor("DIMENSION_CONFIGURED_COLOR"),borderThickness:Z.getNumber("DIMENSION_CONFIGURED_BORDER_THICKNESS")}:{}}getExpressionTextColor(){let e;return e=this.isBad?this.shouldHighlightDimensionWithSelectedColor()?"DIMENSION_EXPRESSION_BAD_SELECTED_TEXT_COLOR":this.hovered||this.textDragging?"DIMENSION_EXPRESSION_BAD_HOVERED_TEXT_COLOR":"DIMENSION_EXPRESSION_BAD_TEXT_COLOR":"DIMENSION_EXPRESSION_TEXT_COLOR",Z.getColor(e)}getExpressionBackgroundColor(){let e;return e=this.isBad?this.shouldHighlightDimensionWithSelectedColor()?"DIMENSION_EXPRESSION_BAD_SELECTED_BACKGROUND_COLOR":this.hovered||this.textDragging?"DIMENSION_EXPRESSION_BAD_HOVERED_BACKGROUND_COLOR":"DIMENSION_EXPRESSION_BAD_BACKGROUND_COLOR":this.expressionType===z.WITH_VARIABLES?this.shouldHighlightDimensionWithSelectedColor()?"DIMENSION_EXPRESSION_WITH_VARIABLES_SELECTED_BACKGROUND_COLOR":this.hovered||this.textDragging?"DIMENSION_EXPRESSION_WITH_VARIABLES_HOVERED_BACKGROUND_COLOR":"DIMENSION_EXPRESSION_WITH_VARIABLES_BACKGROUND_COLOR":this.shouldHighlightDimensionWithSelectedColor()?"DIMENSION_EXPRESSION_WITHOUT_VARIABLES_SELECTED_BACKGROUND_COLOR":this.hovered||this.textDragging?"DIMENSION_EXPRESSION_WITHOUT_VARIABLES_HOVERED_BACKGROUND_COLOR":"DIMENSION_EXPRESSION_WITHOUT_VARIABLES_BACKGROUND_COLOR",Z.getColor(e)}getExpressionBorderProperties(){return this.expressionType!==z.WITHOUT_VARIABLES||this.isBad||this.selected||this.hovered||this.textDragging?{}:{borderColor:Z.getColor("DIMENSION_EXPRESSION_WITHOUT_VARIABLES_BACKGROUND_BORDER_COLOR"),borderThickness:Z.getNumber("DIMENSION_EXPRESSION_BACKGROUND_BORDER_THICKNESS")}}getScreenSpaceParameters(e,t){const i={gap:Z.getNumber("DIMENSION_WITNESS_MODEL_GAP"),extension:Z.getNumber("DIMENSION_WITNESS_EXTENSION")};return this.preferences&&this.preferences.ignoreSpaceParameters?(i.gap=0,i.extension=0):t&&(i.gap*=t,i.extension*=t),i}getAlphaAdjustedArrowColor(e,t){if(!t.opaque){const t=Z.getNumber("DIMENSION_VALUE_ARROW_OPACITY");e[3]=t}return t.fade?this.applyAngleFadeToColor(e):e}getArrowColor(){return this.preferences&&this.preferences.colorName?Z.getColor(this.preferences.colorName):this.shouldHighlightDimensionWithSelectedColor()?this.getAlphaAdjustedArrowColor(Z.getColor("DIMENSION_SELECTED_LINE_ARROW_COLOR"),{opaque:!1,fade:!1}):this.hovered?this.isDriven?this.getAlphaAdjustedArrowColor(Z.getColor("DIMENSION_DRIVEN_HOVERED_LINE_ARROW_COLOR"),{opaque:!1,fade:!1}):this.getAlphaAdjustedArrowColor(Z.getColor("DIMENSION_DRIVING_HOVERED_LINE_ARROW_COLOR"),{opaque:!1,fade:!1}):this.isBad?this.getAlphaAdjustedArrowColor(Z.getColor("OVERCONSTRAINED_LINE_POINT_COLOR"),{opaque:!0,fade:!0}):this.isDriven?this.getAlphaAdjustedArrowColor(Z.getColor("DIMENSION_DRIVEN_LINE_POINT_COLOR"),{opaque:!1,fade:!0}):this.getAlphaAdjustedArrowColor(Z.getColor("DIMENSION_DRIVING_LINE_ARROW_COLOR"),{opaque:!0,fade:!0})}addHighlight(e){super.addHighlight(e),this.destroyAllTextures(),this.updateHideState(),this.viewer.requestDraw()}removeHighlight(e){return!!e&&(!!super.removeHighlight(e)&&(this.destroyAllTextures(),this.viewer.requestDraw(),this.updateHideState(),!0))}updateHideState(){!this.isVisibleToUser()&&this.isHighlighted()&&this.show()}getLineColor(){return this.getArrowColor()}static getAlphaScaling(e,t){const i=Math.abs(f.dot(e,t)),s=Z.getNumber("DIMENSION_SIDE_FADE_UPPER_DOT"),n=Z.getNumber("DIMENSION_SIDE_FADE_LOWER_DOT");let r=1;return i<n?r=0:i<s&&(r=(i-n)/(s-n)),r}calculateFadeAlphaScaling(e){return J.getAlphaScaling(this.getVisualNormal(),e.getDirection())}applyAngleFadeToColor(e){return[e[0],e[1],e[2],e[3]*this.lastFadeAlphaScaling]}getLineWidth(){return this.selected||this.hovered?Z.getNumber("DIMENSION_SELECTED_LINE_WIDTH"):Z.getNumber("DIMENSION_LINE_WIDTH")}getShowZExtensions(){return this.selected||this.hovered}getLineStyle(){return this.preferences?this.preferences.lineStyle:null}getTextGap(e,t,i,s){let n=i,r=(0,c.acos)(f.dot(e,t),d.W.ZERO_LENGTH);r>Math.PI/2&&(r=(0,c.acos)(f.dot(S.S4.scale(e,-1,f.create()),t),d.W.ZERO_LENGTH));const a=s/2/(i/2);return n=Math.tan(r)>a?s/Math.sin(r):i/Math.cos(r),n}getValueGapWithIcon(e,t,i,s,n,r){const a=i+2*(n+r);return this.getTextGap(e,t,a,s)}getIconPadding(e){return Z.getNumber("DIMENSION_VALUE_BACKGROUND_PADDING")*e}createComponentLine(e,t){return(0,g.createLine)(e,t,void 0,this.getLineColor(),this.getLineWidth(),this.getLineStyle())}updateDimensionComponent(e,t,i,s){let n=0;this.forPreview?n=1:this.getIsAnnotationDimension()&&!this.featureIsActive&&(n=3);const r=i.clone();3===n&&((0,g.addStyleToIncrement)(Z.getStipple("DIMENSION_INACTIVE_OCCLUDED_WITNESS_STIPPLE"),r),(0,g.addColorToIncrement)(this.applyAngleFadeToColor(Z.getColor("DIMENSION_INACTIVE_OCCLUDED_COLOR")),r)),this.updateMeshIncrement("st."+e,t,r,s[n]),3===n?this.updateMeshIncrement(G+e,t,i.clone(),s[2]):this.removeMeshIncrement(G+e)}removeDimensionComponent(e){this.removeMeshIncrement("st."+e),this.removeMeshIncrement(G+e)}updateDimensionLineComponent(e,t,i){this.updateDimensionComponent(e,g.DimensionConstants.LINE_SELECTION_ID,this.createComponentLine(t,i),g.DimensionConstants.LINE_PROPERTIES)}makeThreePointArc(e,t,i,s){const n=(0,g.createArcPolyline)(e.slice(),t.slice(),i.slice(),[],!0);if(n){const e=n.linePoints,t=new Array(3*e.length),i=new Array(2*(e.length-1)),r=s.getIndexOffset();i[0]=r;for(let t=1;t<e.length-1;t++)i[2*t-1]=t+r,i[2*t]=t+r;for(let i=0;i<e.length;i++){const s=e[i],n=this.getModelPoint(s[0],s[1]);for(let e=0;e<3;++e)t[3*i+e]=n[e]}i[i.length-1]=i.length-1+r,s.concat(t,i)}}getValuePrefix(e){return this.preferences?.textPrefix??""}isOfType(e){return this.constructor===e}setPreferences(e){this.preferences=e}getDisplayData(){return this.displayData}getRoundedDimensionValueForTextDisplay(e,t){return(0,c.roundTo)(e,this.getPrecision(t))}hasPrecisionOverride(){return this.displayData?.precision!==o.d_N.DEFAULT&&this.displayData?.precision!==o.d_N.UNKNOWN}getPrecision(e){const t=this.getDefaultPrecision(e);return this.hasPrecisionOverride()?J.getPrecisionDigitCount(this.displayData.precision):t}static getPrecisionDigitCount(e){switch(e){case o.d_N.DEFAULT:case o.d_N.UNKNOWN:return 3;case o.d_N.ONES:return 0;case o.d_N.TENTHS:return 1;case o.d_N.HUNDREDTHS:return 2;case o.d_N.THOUSANDTHS:return 3;case o.d_N.TEN_THOUSANDTHS:return 4;case o.d_N.HUNDRED_THOUSANDTHS:return 5;case o.d_N.MILLIONTHS:return 6}}updateBasicBox(e){const t=g.DimensionConstants.DIMENSION_LINE0_ID+"_BASIC";this.getHasTolerances()&&this.displayData.toleranceType===o.gkc.BASIC?this.updateDimensionComponent(t,g.DimensionConstants.LINE_SELECTION_ID,(0,g.createLineLoop)(e,void 0,this.getLineColor(),this.getLineWidth()),g.DimensionConstants.LINE_PROPERTIES):this.removeDimensionComponent(t)}getShouldBeRecreated(e){return!1}}class ee{constructor(){this.points=[],this.indices=[]}concat(e,t){this.points=this.points.concat(e),this.indices=this.indices.concat(t)}getIndexOffset(){return this.points.length/3}}},75755:function(e,t,i){i.d(t,{JT:function(){return h},Lc:function(){return a},Nq:function(){return f},PF:function(){return p},Q8:function(){return d},TN:function(){return c},U2:function(){return l},YQ:function(){return n},_i:function(){return o},bU:function(){return m},dG:function(){return E},kQ:function(){return u},n7:function(){return s},sr:function(){return I},u5:function(){return r},xH:function(){return g},yH:function(){return S}});const s="_annotation_base_element_id",n="_annotation_base_selection_id",r="_annotation_leader_element_id",a="_annotation_leader_selection_id",o="_annotation_detail_element_id",h="_annotation_detail_selection_id",c="_annotation_gtol_detail_element_id",l="_annotation_gtol_detail_selection_id",d="_annotation_weld_extended_leader_element_id",u="_annotation_weld_extended_leader_selection_id",g="_annotation_weld_detail_element_id",p="_annotation_weld_detail_selection_id",m="_annotation_iso_leader_element_id",f="_annotation_iso_leader_selection_id",I="_annotation_detail_cell_element_id",E="_annotation_detail_cell_selection_id";class S{constructor(e){this.annotationDisplay=e}getAnnotationDisplayData(){return this.annotationDisplay.getAnnotationDisplayData()}getPlaneCoordinateSystem(){return this.annotationDisplay.getPlaneCoordinateSystem()}getBaseCoordinateSystem(){return this.annotationDisplay.getBaseCoordinateSystem()}setNextStartPoint(e){this.annotationDisplay.setNextStartPoint(e)}getNextStartPoint(){return this.annotationDisplay.getNextStartPoint()}setLeaderStartDirection(e){this.annotationDisplay.setLeaderStartDirection(e)}getLeaderStartDirection(){return this.annotationDisplay.getLeaderStartDirection()}getSideEdgeLength(e){return this.annotationDisplay.getSideEdgeLength(e)}setExtendedLeaderStartPoint(e){this.annotationDisplay.setExtendedLeaderStartPoint(e)}getExtendedLeaderStartPoint(){return this.annotationDisplay.getExtendedLeaderStartPoint()}getPixelSizeAtWorldPoint(e,t){return this.annotationDisplay.getPixelSizeAtWorldPoint(e,t)}isHighlighted(){return this.annotationDisplay.isHighlighted()}getHighlight(){return this.annotationDisplay.getHighlight()}getColor(){return this.annotationDisplay.getColor()}getLineWidth(){return this.annotationDisplay.getLineWidth()}getLineStyle(){return this.annotationDisplay.getLineStyle()}getFont(){return this.annotationDisplay.getFont()}getFontSize(){return this.annotationDisplay.getFontSize()}getDefaultValueColor(){return this.annotationDisplay.getDefaultValueColor()}getBackgroundPadding(){return this.annotationDisplay.getBackgroundPadding()}getBackgroundColor(){return this.annotationDisplay.getBackgroundColor()}getHoveredBackgroundColor(){return this.annotationDisplay.getHoveredBackgroundColor()}getSelectedBackgroundColor(){return this.annotationDisplay.getSelectedBackgroundColor()}destroy(){}}},15130:function(e,t,i){i.d(t,{IK:function(){return f},XH:function(){return T},l_:function(){return S},lv:function(){return D},po:function(){return m}});var s=i(42200),n=i(32606),r=i(60559),a=i(22681),o=i(68176),h=i(90219),c=i(53545),l=i(36889),d=i(94205);const u=r.O.createLogger("BodyMetaData",a.bVy.GRAPHICS),g=[a.ls1.ANGULAR_TOLERANCE_COARSE,a.ls1.ANGULAR_TOLERANCE_MEDIUM,a.ls1.ANGULAR_TOLERANCE_FINE,a.ls1.ANGULAR_TOLERANCE_VERY_FINE,a.ls1.ANGULAR_TOLERANCE_CURVATURE_ANALYSIS],p=[a.ls1.CHORDAL_TOLERANCE_RATIO_COARSE,a.ls1.CHORDAL_TOLERANCE_RATIO_MEDIUM,a.ls1.CHORDAL_TOLERANCE_RATIO_FINE,a.ls1.CHORDAL_TOLERANCE_RATIO_VERY_FINE,a.ls1.CHORDAL_TOLERANCE_RATIO_CURVATURE_ANALYSIS];var m;function f(e,t){switch(e){case m.PART:return t?i18n("parts"):i18n("part");case m.SURFACE:return t?i18n("surfaces"):i18n("surface");case m.MESH:return t?i18n("meshes"):i18n("mesh");case m.CURVE:return t?i18n("curves"):i18n("curve");case m.POINT:return t?i18n("points"):i18n("point");case m.SKETCH:return t?i18n("sketches"):i18n("sketch");default:return""}}function I(e){const t=1/e;return a.ls1.ESTIMATION_COEFFICIENT_0+a.ls1.ESTIMATION_COEFFICIENT_1*t+a.ls1.ESTIMATION_COEFFICIENT_2*t*t}!function(e){e[e.PART=0]="PART",e[e.SURFACE=1]="SURFACE",e[e.MESH=2]="MESH",e[e.CURVE=3]="CURVE",e[e.POINT=4]="POINT",e[e.SKETCH=5]="SKETCH",e[e.NUMBER_OF_TYPES=6]="NUMBER_OF_TYPES"}(m||(m={}));const E=I(a.ls1.ANGULAR_TOLERANCE_COARSE);function S(e,t,i){const s=I(g[i]);return t/E*s+e}class T{constructor(e){this.id=e,this.name="",this.meshState=a.W6T.NO_MESH,this.constituentsContainMesh=!1,this.isModifiable=!0,this.foundInPreview=!1,this.appearance=null,this.defaultColorHash="",this.meshIncrement=null,this.tessellationSettings=null,this.isFlattenedSheetMetalBody=!1,this.isBendCenterLineBody=!1,this.ownerFlattenedBodyId="",this.sheetMetalModelId="",this.isActiveSheetMetal=!1,this.sheetMetalOrderId="",this.sheetMetalOrder=0,this.isTessellationLoaded=!1,this.coarseTriangleCount=0,this.coarsePlanarFaceTriangleCount=0,this.isAssociatedWithFlat=!1,this.colorCycle=null,this.totalEntityCount=0,this.lastViewTime=0,this.lastViewportOccupancy=0,this.partStudioVisibility=d.Visibility.VISIBLE,this.isComposite=!1,this.isClosedComposite=!1,this.constituentBodyIds_=null,this.consumingClosedCompositeData=null,this.referencingOpenCompositeData_=null,this.isSketchBody=!1,this.type=a.wG2.UNKNOWN,this.bounds=new d.BoundingBox,this.bestAvailableTessellationSetting=a.XiJ.UNKNOWN,this.tessellationSettingOverride=a.XiJ.AUTO,this.constituentTypeCounts=new Array(m.NUMBER_OF_TYPES).fill(0)}getId(){return this.id}setAppearanceFromDisplayData(e){e?(e.appearance&&e.appearance.color&&(this.appearance=(0,l.shallowClone)(e.appearance),this.appearance.color=new Uint8Array(e.appearance.color)),this.defaultColorHash=e.defaultColorHash):u.warn("setAppearanceFromDisplayData called without valid display data")}setColorCycle(e){this.colorCycle=e}getColorCycle(){return this.colorCycle}getColor(){const e=n.default.getManager();if(this.containsOnlyWireBodies()){if(!this.isModifiableBody())return e.getColor("REFERENCE_GEOMETRY_COLOR");if(!(0,s.r)())return e.getColor("LINE_POINT_COLOR");if(3!==this.appearance?.color?.length)return e.getColor("LINE_POINT_COLOR")}if(3===this.appearance?.color?.length){const e=this.appearance.color;return[e[0]/255,e[1]/255,e[2]/255,this.appearance.opacity/255]}{if(!this.isModifiableBody())return e.getColor("REFERENCE_GEOMETRY_COLOR");const t=(0,c.ek)(this.defaultColorHash,this.colorCycle);return this.appearance?this.appearance.color=new Uint8Array(t.slice(0,3)):u.warn("No appearance object associated with BodyMetaData"),(0,d.convertRGBA255ToRGBA)(t)}}isTranslucent(){return null!==this.appearance&&this.appearance.opacity<255}clone(){const e=new T(this.id);return(0,l.overwriteMatchingProperties)(e,this),e.bounds=new d.BoundingBox(this.bounds.getMin(),this.bounds.getMax()),this.referencingOpenCompositeData_&&(e.referencingOpenCompositeData_=new Map(this.referencingOpenCompositeData_)),e}setIsTessellationLoaded(e){this.isTessellationLoaded=e}getIsTessellationLoaded(){return this.consumingClosedCompositeData?this.consumingClosedCompositeData.getIsTessellationLoaded():this.isTessellationLoaded}setLastViewTime(e){this.lastViewTime=e}getLastViewTime(){return this.lastViewTime}setLastViewportOccupancy(e){this.lastViewportOccupancy=e}getLastViewportOccupancy(){return this.lastViewportOccupancy}getType(){return this.type}isSolidBody(){return!this.isComposite&&this.containsOnlySolidBodies()}containsOnlySolidBodies(){return this.type===a.wG2.SOLID}isSheetBody(){return!this.isComposite&&this.containsOnlySheetBodies()}containsOnlySheetBodies(){return this.type===a.wG2.SHEET}isWireBody(){return!this.isComposite&&this.containsOnlyWireBodies()}containsOnlyWireBodies(){return this.type===a.wG2.WIRE}isPointBody(){return!this.isComposite&&this.containsOnlyPointBodies()}containsOnlyPointBodies(){return this.type===a.wG2.POINT}containsMesh(){return this.constituentsContainMesh||a.QsM.containsMesh(this.meshState)}getMeshState(){return this.meshState}getMeshIncrement(){return this.meshIncrement}isModifiableBody(){return this.isModifiable}getBounds(){return this.bounds}resetMeshIncrement(){this.meshIncrement=null}getIsFlattenedSheetMetalBody(){return this.isFlattenedSheetMetalBody}getIsActiveSheetMetal(){return this.isActiveSheetMetal}getIsBendCenterLineBody(){return this.isBendCenterLineBody}isForFlattenedView(){return this.isFlattenedSheetMetalBody||this.isBendCenterLineBody||this.isAssociatedWithFlat}isSubsidiaryBody(){return this.isBendCenterLineBody}getOwnerBodyId(){return this.ownerFlattenedBodyId}get isOpenCompositeBody(){return this.isComposite&&!this.isClosedComposite}get constituentBodyIds(){return this.constituentBodyIds_}removeOpenCompositeBodyReferences(e){if(this.constituentBodyIds_)for(let t=0;t<this.constituentBodyIds_.length;++t){const i=e[this.constituentBodyIds_[t]];i&&i.removeReferencingOpenCompositeBody(this.id)}}updateConstituentBodyIds(e,t){if(this.removeOpenCompositeBodyReferences(t),this.constituentBodyIds_=e,this.constituentBodyIds_&&this.isOpenCompositeBody)for(let e=0;e<this.constituentBodyIds_.length;++e){const i=t[this.constituentBodyIds_[e]];i&&i.addReferencingOpenCompositeBody(this)}}get referencingOpenCompositeData(){return this.referencingOpenCompositeData_}addReferencingOpenCompositeBody(e){this.referencingOpenCompositeData_||(this.referencingOpenCompositeData_=new Map),this.referencingOpenCompositeData_.set(e.id,e)}removeReferencingOpenCompositeBody(e){this.referencingOpenCompositeData_&&this.referencingOpenCompositeData_.delete(e)}get isCompositeConstituent(){return this.isClosedCompositeConstituent||this.hasReferencingOpenCompositeBody}get hasReferencingOpenCompositeBody(){return!!this.referencingOpenCompositeData_&&this.referencingOpenCompositeData_.size>0}get isClosedCompositeConstituent(){return!!this.consumingClosedCompositeData}get closedCompositeParentId(){return this.consumingClosedCompositeData?this.consumingClosedCompositeData.id:null}get isGroupableCompositeBody(){return this.isClosedComposite&&this.type!==a.wG2.UNKNOWN}get isNonGroupingCompositeBody(){return!!this.isComposite&&(!this.isClosedComposite||!this.isGroupableCompositeBody)}get canBeGroupedWithOtherConstituents(){return!!this.consumingClosedCompositeData&&this.consumingClosedCompositeData.isGroupableCompositeBody}get meshGroupId(){return this.canBeGroupedWithOtherConstituents?this.consumingClosedCompositeData.id:this.id}hasFaces(){return this.containsOnlySolidBodies()||this.containsOnlySheetBodies()}hasEdges(){return this.hasFaces()||this.containsOnlyWireBodies()}hasPoints(){return this.hasEdges()||this.containsOnlyPointBodies()}hasTessellationSettings(){return null!==this.getFinestTessellationSettingInMemory()}canEntitiesBeLoaded(){return this.hasTessellationSettings()||this.isWireBody()||this.isClosedComposite&&this.containsOnlyWireBodies()}getFinestTessellationSettingInMemory(){let e=null;for(let t=0;this.tessellationSettings&&t<this.tessellationSettings.length;++t)this.tessellationSettings[t]!==a.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING&&(null===e||this.tessellationSettings[t]>e)&&(e=this.tessellationSettings[t]);return e}getBestAvailableTessellationSettingIndex(e){return e?a.ls1.getTessellationSettingIndexFromEnum(a.XiJ.VERY_FINE):this.bestAvailableTessellationSetting===a.XiJ.AUTO||this.bestAvailableTessellationSetting===a.XiJ.UNKNOWN?null:Math.min(this.bestAvailableTessellationSetting,a.XiJ.VERY_FINE)-1}getTessellationSettingOverride(){return this.tessellationSettingOverride}getChordalTolerance(){const e=this.getFinestTessellationSettingInMemory();return null===e?null:this.getChordalToleranceForSetting(e)}getChordalToleranceForSetting(e){return e<0||e>=p.length?(u.warn("Attempt to retrieve chordal tolerance for invalid tessellation setting"),0):this.getBounds().diameter()/2*p[e]}estimateTriangleCountAtSettingIndex(e){return S(this.coarsePlanarFaceTriangleCount,this.coarseTriangleCount,e)}getEstimatedMemoryUsage(e){if(!e&&this.hasTessellationSettings()&&(e=this.tessellationSettings),!e||0===e.length)return 0;let t=0,i=!1;for(let s=0;s<e.length;++s)e[s]!==a.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING&&(t+=this.estimateTriangleCountAtSettingIndex(e[s])*a.ls1.BYTES_PER_TRIANGLE,i=!0);return t+(i?this.totalEntityCount*a.ls1.BYTES_PER_ENTITY:0)}shouldProduceLocalThumbnail(){const e=!this.isOpenCompositeBody;return this.isModifiable&&!this.isClosedCompositeConstituent&&!this.isForFlattenedView()&&(!e||this.hasTessellationSettings())}updateConstituentTypeCounts(e){if(!this.isComposite)return;this.constituentTypeCounts.fill(0);const t=new Set;for(let i=0;i<this.constituentBodyIds_.length;i++){const s=this.constituentBodyIds_[i],n=e.getBodyType(s);n===a.wG2.SOLID?this.constituentTypeCounts[m.PART]++:n===a.wG2.SHEET?this.constituentTypeCounts[m.SURFACE]++:n===a.wG2.WIRE?this.constituentTypeCounts[m.CURVE]++:n===a.wG2.POINT?this.constituentTypeCounts[m.POINT]++:null===n&&e.accumulateSketchIdsFromBodyId(s,t)}this.constituentTypeCounts[m.SKETCH]=t.size}updateDataDerivedFromConstituents(e,t){if(!this.isComposite)return;this.constituentsContainMesh=!1,this.type=null;const i=e=>{null===this.type?this.type=e:this.type!==e&&(this.type=a.wG2.UNKNOWN)};for(let s=0;s<this.constituentBodyIds_.length;++s){const n=this.constituentBodyIds_[s],r=t[n];if(r){this.constituentsContainMesh=this.constituentsContainMesh||a.QsM.containsMesh(r.closedConstituentPartData.meshState),i(r.closedConstituentPartData.bodyType);continue}const o=e[n];o&&(this.constituentsContainMesh=this.constituentsContainMesh||a.QsM.containsMesh(o.meshState),i(o.type))}null===this.type&&(this.type=a.wG2.UNKNOWN)}getConstituentsContainMesh(){return this.constituentsContainMesh}getName(){return this.name}getIsFromSketch(){return this.isSketchBody}getSketchFeatureId(){return this.sketchFeatureId}getPartStudioVisibility(){return this.partStudioVisibility}findAllLeafBodies(e){const t=[];if(this.isComposite){const i=1e7,s=new Array,n=new WeakSet;s.push(this);for(let r=0;r<s.length;r++){if(r>i){u.info("composite graph has cycle");break}const a=s[r];if(!n.has(a))if(n.add(a),a.isComposite)for(const t of a.constituentBodyIds)s.push(e.retrieveBodyMetaData(t));else t.push(a.getId())}}return 0===t.length&&t.push(this.getId()),t}}function D(e){return(0,h.dS)(e?e.type:a.wG2.UNKNOWN)}(0,o.s)((function(e,t){const i=t.getBodyId(),s=t.getMeshIncrement();if(!i||!s)return null;const n=new T(i);return n.type=e,n.bounds=s.getBounds(),n}))},59701:function(e,t,i){i.d(t,{BW:function(){return w},EH:function(){return R},QQ:function(){return v},QV:function(){return b},XX:function(){return P},gm:function(){return _},ol:function(){return O},rY:function(){return N},wA:function(){return L}});var s=i(21409),n=i(47061),r=i(32606),a=i(68100);if(666==i.j)var o=i(34015);if(666==i.j)var h=i(35589);var c=i(60559);if(666==i.j)var l=i(4889);var d=i(22681),u=i(29327),g=i(1190),p=i(82630),m=i(40869),f=i(68434),I=i(94205),E=i(88155);if(666==i.j)var S=i(14488);const T=c.O.createLogger("featuremanipulator",d.bVy.GRAPHICS),D=r.default.getManager();let C=1;const M=a.fromValues(1,0,0),y=a.fromValues(0,1,0),A=a.fromValues(0,0,1);class P extends(666==i.j?n.T:null){constructor(e){super(),this.viewer=e,this.dragManipulator=null,this.lockedManipulator=null,this.sequenceId=0,(0,I.viewerCheck)(e)}setIsManipulatorEnabled(e){this.dragManipulator?.setIsEnabled(e)}remove(){this.stopListening(),this.removeGraphicsManipulator()}show(){this.lockedManipulator?.show(),this.dragManipulator?.show()}hide(){this.lockedManipulator?.hide(),this.dragManipulator?.hide()}removeGraphicsManipulator(){this.dragManipulator&&(this.dragManipulator.remove(),this.dragManipulator=null),this.lockedManipulator&&(this.lockedManipulator.remove(),this.lockedManipulator=null)}getManipulatorId(){return this.manipulatorData?this.manipulatorData.manipulatorId:""}removeGraphicsManipulatorIfCannotBeDisplayed(){return!(0,I.canPointBeDisplayed)(this.manipulatorData.getDisplayLocation())&&(this.removeGraphicsManipulator(),T.info("Did not display feature manipulator(s), likely because it was out of bounds."),!0)}setManipulatorData(e,t){this.manipulatorData=e,this.removeGraphicsManipulatorIfCannotBeDisplayed()||(this.dragManipulator&&this.dragManipulator.isBeingManipulated()?this.updateLockedManipulator():this.updateDragManipulator(t))}updateDragManipulator(e){}updateLockedManipulator(){}sendValue(e,t){this.manipulatorData&&this.trigger(g.jC.VALUE_CHANGED,this.manipulatorData.manipulatorId,e,this.sequenceId,!!t)}onManipulationStarted(){this.sequenceId=C++,this.trigger(g.jC.MANIPULATION_STARTED,this.manipulatorData.manipulatorId,this.sequenceId,this.manipulatorData.primaryParameterId)}onManipulationEnded(){this.lockedManipulator&&(this.lockedManipulator.remove(),this.lockedManipulator=null),this.trigger(g.jC.MANIPULATION_ENDED,this.manipulatorData.manipulatorId,this.sequenceId,this.manipulatorData.primaryParameterId)}sendValueWithNoDrag(e){this.onManipulationStarted(),this.sendValue(e,!0),this.onManipulationEnded()}computeCenterOfOccurrenceBounds(e,t){let i=0,s=a.create();return e.forEach((e=>{const n=d._oC.getOccurrenceFromPathString(e),r=t.getOccurrenceBounds(n);let a=null;r&&r.isFinite()&&(a=r.center(),f.S4.add(a,s,s),++i)})),i<1?null:(i>1&&(s=f.S4.scale(s,1/i)),s)}}class O extends(666==i.j?P:null){constructor(e){super(e),this.dragManipulator=null,this.lockedManipulator=null,this.manipulatorData=null,this.cachedBaseOccurrenceTransform=null}isManipulatorInGlobalCoordinateSystem(e){return!e.useCenterOfBoundsOfSourceIds&&(null===e.baseOccurrencePath||0===e.baseOccurrencePath.length)}convertLocalToWorldManipulatorData(e){if(this.isManipulatorInGlobalCoordinateSystem(e))return e;const t=e.clone(),i=(0,E.uQ)();if(!i)return e;const s=i.getModelViewManagers().getManager();if(!s)return e;if(!d._oC.getOccurrenceFromPathString(e.baseOccurrencePath))return e;if(0===e.sourceIds.length)return e;const n=i.getOccurrenceIdManager().getIdForName(e.baseOccurrencePath);if(n===m.Qy)return e;const r=this.viewer.getOccurrenceDataManager().getOccurrenceTransform(n),h=new d.d0F,c=f.w$.toMat3(r,o.create());let l=f.xB.multiplyVec3(c,e.direction.getVec3(),a.create());l=f.S4.normalize(l,a.create()),h.updateFromArray(l),t.direction=h;const u=new d.d0F,g=this.computeCenterOfOccurrenceBounds(e.sourceIds,s);return g&&(u.updateFromArray(g),t.base=u),t}updateManipulatorFromDefinition(e){if(this.manipulatorData){if(e.setId(this.manipulatorData.manipulatorId),e.setStyle(this.manipulatorData.style),this.isManipulatorInGlobalCoordinateSystem(this.manipulatorData))e.updateDefinition(this.manipulatorData.base.getVec3(),this.manipulatorData.direction.getVec3(),this.manipulatorData.getValue().offset);else{const t=this.cachedBaseOccurrenceTransform?this.cachedBaseOccurrenceTransform:this.convertLocalToWorldManipulatorData(this.manipulatorData);if(this.cachedBaseOccurrenceTransform)e.updateDefinition(t.base.getVec3(),t.direction.getVec3(),this.manipulatorData.getValue().offset);else{const i=this.manipulatorData.getValue().offset<0;e.updateDefinitionForLocalManipulatorAtRest(t.base.getVec3(),t.direction.getVec3(),i)}}e.updateLimits(this.manipulatorData.minValue,this.manipulatorData.maxValue)}}setManipulatorData(e){this.manipulatorData=e,this.removeGraphicsManipulatorIfCannotBeDisplayed()||(!this.isManipulatorInGlobalCoordinateSystem(this.manipulatorData)&&this.dragManipulator||this.updateDragManipulator(),this.isManipulatorInGlobalCoordinateSystem(this.manipulatorData)&&this.dragManipulator&&this.dragManipulator.isBeingManipulated()&&this.updateLockedManipulator())}onManipulationStarted(){super.onManipulationStarted(),this.isManipulatorInGlobalCoordinateSystem(this.manipulatorData)||(this.cachedBaseOccurrenceTransform=this.convertLocalToWorldManipulatorData(this.manipulatorData))}onManipulationEnded(){super.onManipulationEnded(),this.cachedBaseOccurrenceTransform&&(this.cachedBaseOccurrenceTransform=null,this.updateManipulatorFromDefinition(this.dragManipulator))}getFlipDirectionWhenNegative(){return this.manipulatorData?.style!==d.xKD.SIMPLE}updateDragManipulator(){this.dragManipulator||(this.dragManipulator=new I.Linear(this.viewer),this.dragManipulator.setFlipDirectionWhenNegative(this.getFlipDirectionWhenNegative()),this.listenTo(this.dragManipulator,g.Wb.VALUE_CHANGED,this.onManipulatorValueChanged),this.listenTo(this.dragManipulator,g.Wb.VALUE_EDITED,this.onManipulatorValueEdited),this.listenTo(this.dragManipulator,g.Wb.MANIPULATION_STARTED,this.onManipulationStarted),this.listenTo(this.dragManipulator,g.Wb.MANIPULATION_ENDED,this.onManipulationEnded),this.listenTo(this.dragManipulator,g.Wb.CLICKED,this.onManipulatorFlipped)),this.updateManipulatorFromDefinition(this.dragManipulator)}updateLockedManipulator(){this.lockedManipulator||(this.lockedManipulator=new I.Linear(this.viewer),this.lockedManipulator.setFlipDirectionWhenNegative(this.getFlipDirectionWhenNegative()),this.lockedManipulator.setIsEnabled(!1)),this.updateManipulatorFromDefinition(this.lockedManipulator)}onManipulatorValueChanged(){if(!this.dragManipulator)return;const e=new d.Ygf;e.offset=this.dragManipulator.getOffset(),this.sendValue(e)}onManipulatorValueEdited(){if(!this.dragManipulator)return;const e=new d.Ygf;e.offset=this.dragManipulator.getEditOffset(),this.sendValueWithNoDrag(e)}onManipulatorFlipped(){if(!this.dragManipulator)return;const e=-this.manipulatorData.getValue().offset;if(e<this.manipulatorData.minValue||e>this.manipulatorData.maxValue||0===e)return;const t=new d.Ygf;t.offset=e,this.sendValueWithNoDrag(t);const i=this.manipulatorData?.getValue();i.offset=-i.offset,this.manipulatorData?.updateClientGraphicsOnFlip&&this.updateDragManipulator(),this.viewer.doPreHighlightPick()}}class R extends(666==i.j?P:null){constructor(e){super(e),this.dragManipulator=null,this.lockedManipulator=null,this.manipulatorData=null,this.cachedManipulatorData=null}setManipulatorData(e){this.manipulatorData=e,this.removeGraphicsManipulatorIfCannotBeDisplayed()||(this.updateDragManipulator(),this.dragManipulator&&this.dragManipulator.isBeingManipulated()&&this.updateLockedManipulator())}isManipulatorInGlobalCoordinateSystem(e){return!e.useCenterOfBoundsOfSourceIds&&(null===e.baseOccurrencePath||0===e.baseOccurrencePath.length)}convertLocalToWorldManipulatorData(e){if(this.isManipulatorInGlobalCoordinateSystem(e))return e;const t=(0,E.uQ)();if(!t)return e;const i=t.getModelViewManagers().getManager();if(!i)return e;if(!d._oC.getOccurrenceFromPathString(e.baseOccurrencePath))return e;if(0===e.sourceIds.length)return e;const s=t.getOccurrenceIdManager().getIdForName(e.baseOccurrencePath);if(s===m.Qy)return e;const n=this.viewer.getOccurrenceDataManager().getOccurrenceTransform(s),r=f.w$.toMat3(n,o.create()),c=e.axisDirection.getVec3(),l=f.xB.multiplyVec3(r,c,a.create());f.S4.normalize(l);const g=e.clone();g.axisDirection.updateFromArray(l);const p=this.computeCenterOfOccurrenceBounds(e.sourceIds,i);if(!p)return e;let I=null,S=f.w$.multiplyVec3(n,e.axisOrigin.getVec3(),a.create());const T=f.S4.subtract(p,S,a.create()),D=(0,u.areUnitVectorsParallel)(f.S4.normalize(T,a.create()),l);if((0,u.arePointsCoincident)(S,p)||D){I=this.getVectorNormalTo(c);const e=.01;f.S4.scale(I,e),I=f.xB.multiplyVec3(r,I,a.create()),g.axisOrigin.updateFromArray(p),S=p}else{const e=a.dot(T,l),t=f.S4.add(S,f.S4.scale(l,e,a.create()));g.axisOrigin.updateFromArray(t),I=f.S4.subtract(p,t,a.create())}if(I){const t=f.Jb.toMat4(f.Jb.fromAngleAxis(-e.getValue().angle,l),h.create());I=f.w$.multiplyVec3(t,I);const i=f.S4.add(I,S,a.create());g.rotationOrigin.updateFromArray(i)}return g}getVectorNormalTo(e){return(0,u.areUnitVectorsParallel)(M,e)?a.clone(y):(0,u.areUnitVectorsParallel)(y,e)?a.clone(A):(0,u.areUnitVectorsParallel)(A,e)?a.clone(M):f.S4.normalize(f.S4.getAPerpendicularVector(e))}updateManipulatorFromDefinition(e){if(this.manipulatorData)if(this.isManipulatorInGlobalCoordinateSystem(this.manipulatorData)){const t=f.S4.subtract(this.manipulatorData.rotationOrigin.getVec3(),this.manipulatorData.axisOrigin.getVec3(),a.create()),i=f.S4.length(t);f.S4.normalize(t),e.setId(this.manipulatorData.manipulatorId),e.updateDefinition(this.manipulatorData.axisOrigin.getVec3(),this.manipulatorData.axisDirection.getVec3(),t,i,this.manipulatorData.getValue().angle),e.updateLimits(this.manipulatorData.minValue,this.manipulatorData.maxValue),e.setStyle(this.manipulatorData.style),e.setDisableMinimumOffset(this.manipulatorData.disableMinimumOffset)}else{const t=this.cachedManipulatorData?this.cachedManipulatorData:this.convertLocalToWorldManipulatorData(this.manipulatorData),i=f.S4.subtract(t.rotationOrigin.getVec3(),t.axisOrigin.getVec3(),a.create()),s=f.S4.length(i);f.S4.normalize(i),e.setId(t.manipulatorId),e.updateDefinition(t.axisOrigin.getVec3(),t.axisDirection.getVec3(),i,s,t.getValue().angle),e.updateLimits(t.minValue,t.maxValue),e.setStyle(t.style),e.setDisableMinimumOffset(t.disableMinimumOffset)}}createManipulator(){return this.manipulatorData?.style===d.xKD.SIMPLE?new I.Angular(this.viewer):new I.AngularWithArrow(this.viewer)}updateDragManipulator(){this.dragManipulator||(this.dragManipulator=this.createManipulator(),this.listenTo(this.dragManipulator,g.Wb.VALUE_CHANGED,this.onManipulatorValueChanged),this.listenTo(this.dragManipulator,g.Wb.VALUE_EDITED,this.onManipulatorValueEdited),this.listenTo(this.dragManipulator,g.Wb.MANIPULATION_STARTED,this.onManipulationStarted),this.listenTo(this.dragManipulator,g.Wb.MANIPULATION_ENDED,this.onManipulationEnded),this.listenTo(this.dragManipulator,g.Wb.CLICKED,this.onManipulatorFlipped)),this.updateManipulatorFromDefinition(this.dragManipulator)}updateLockedManipulator(){this.lockedManipulator||(this.lockedManipulator=this.createManipulator(),this.lockedManipulator.setIsEnabled(!1)),this.updateManipulatorFromDefinition(this.lockedManipulator)}onManipulationStarted(){super.onManipulationStarted(),this.isManipulatorInGlobalCoordinateSystem(this.manipulatorData)||(this.cachedManipulatorData=this.convertLocalToWorldManipulatorData(this.manipulatorData))}onManipulationEnded(){super.onManipulationEnded(),this.cachedManipulatorData&&(this.cachedManipulatorData=null,this.updateManipulatorFromDefinition(this.dragManipulator))}onManipulatorValueChanged(){if(!this.dragManipulator)return;const e=new d.N1L;e.angle=this.dragManipulator.getAngle(),this.sendValue(e)}onManipulatorValueEdited(){if(!this.dragManipulator)return;const e=new d.N1L;e.angle=this.dragManipulator.getAngle(),this.sendValueWithNoDrag(e)}onManipulatorFlipped(){if(!this.dragManipulator||this.manipulatorData.minValue*this.manipulatorData.maxValue>=0)return;const e=new d.N1L;e.angle=-this.manipulatorData.getValue().angle,this.sendValueWithNoDrag(e);const t=this.manipulatorData.getValue();t.angle=-t.angle,this.manipulatorData?.updateClientGraphicsOnFlip&&this.updateDragManipulator(),this.viewer.doPreHighlightPick()}}class w extends(666==i.j?P:null){constructor(e){super(e),this.dragManipulator=null,this.lockedManipulator=null,this.manipulatorData=null}updateManipulatorFromDefinition(e){if(!this.manipulatorData)return;let t=this.manipulatorData.direction.getVec3();if(this.manipulatorData.getValue().flipped){const e=this.manipulatorData.otherDirection.getVec3();f.S4.length(e)>0?t=e:f.S4.scale(t,-1)}e.setId(this.manipulatorData.manipulatorId),e.setStyle(this.manipulatorData.style),e.updateDefinition(this.manipulatorData.base.getVec3(),t,0)}updateDragManipulator(){this.dragManipulator||(this.dragManipulator=new I.Linear(this.viewer),this.dragManipulator.setShaftLength(D.getNumber("MANIPULATOR_FLIP_SHAFT_LENGTH_PX")),this.dragManipulator.setIsDraggable(!1),this.listenTo(this.dragManipulator,g.Wb.CLICKED,this.onManipulatorFlipped)),this.updateManipulatorFromDefinition(this.dragManipulator)}updateLockedManipulator(){this.lockedManipulator||(this.lockedManipulator=new I.Linear(this.viewer),this.lockedManipulator.setShaftLength(D.getNumber("MANIPULATOR_FLIP_SHAFT_LENGTH_PX")),this.dragManipulator?.setIsDraggable(!1),this.lockedManipulator.setFlipDirectionWhenNegative(!0),this.lockedManipulator.setIsEnabled(!1)),this.updateManipulatorFromDefinition(this.lockedManipulator)}onManipulatorFlipped(){if(!this.dragManipulator)return;const e=new d.OHR;e.flipped=!this.manipulatorData?.getValue().flipped,this.sendValueWithNoDrag(e);const t=this.manipulatorData?.getValue();t.flipped=!t?.flipped,this.manipulatorData?.updateClientGraphicsOnFlip&&this.updateDragManipulator(),this.viewer.doPreHighlightPick()}}class v extends(666==i.j?P:null){constructor(e){super(e),this.manipulatorData=null,this.dragManipulator=null}updateManipulatorFromDefinition(e){if(!this.manipulatorData)return;const t=this.manipulatorData.points.map((e=>a.fromValues(e.x,e.y,e.z)));e.setId(this.manipulatorData.manipulatorId),e.setStyle(this.manipulatorData.style),e.updateDefinition(t,new Set([this.manipulatorData.getValue().index]))}updateDragManipulator(){this.dragManipulator||(this.dragManipulator=new I.PointSelection(this.viewer,!1),this.listenTo(this.dragManipulator,g.Wb.VALUE_CHANGED,this.onManipulatorValueChanged)),this.updateManipulatorFromDefinition(this.dragManipulator)}onManipulatorValueChanged(e){const t=new d.DxO;t.index=e.findIndex((e=>e)),this.sendValueWithNoDrag(t)}}class _ extends(666==i.j?P:null){constructor(e){super(e),this.manipulatorData=null,this.dragManipulator=null}updateManipulatorFromDefinition(e){if(!this.manipulatorData)return;const t=this.manipulatorData.points.map((e=>a.fromValues(e.x,e.y,e.z)));e.setId(this.manipulatorData.manipulatorId),e.setStyle(this.manipulatorData.style);const i=this.manipulatorData.getValue();e.updateDefinition(t,new Set(i?.selectedIndices),new Set(this.manipulatorData.suppressedIndices))}updateDragManipulator(e){this.dragManipulator||(this.dragManipulator=new I.PointSelection(this.viewer,!0,e),this.listenTo(this.dragManipulator,g.Wb.VALUE_CHANGED,this.onManipulatorValueChanged)),this.updateManipulatorFromDefinition(this.dragManipulator)}onManipulatorValueChanged(e){const t=new d.kr3;t.selectedIndices=e.reduce(((e,t,i)=>(t&&e.push(i),e)),[]),this.sendValueWithNoDrag(t)}}class N extends(666==i.j?P:null){constructor(e,t){super(t),this.dragManipulator=null,this.lockedManipulator=null,this.manipulatorData=null,this.dragStart=e.getValue().offset.getVec3()}updateManipulatorFromDefinition(e){if(!this.manipulatorData)return;const t=this.manipulatorData.base,i=this.manipulatorData.getValue().offset,s=h.create();s[12]=i.x+t.x,s[13]=i.y+t.y,s[14]=i.z+t.z,e.setId(this.manipulatorData.manipulatorId),e.setStyle(this.manipulatorData.style),e.updateDefinition(s)}updateDragManipulator(){if(!this.dragManipulator){const e={displayEditView:!1};this.dragManipulator=new I.Triad(this.viewer,g.Ak.DRAG,e),this.dragManipulator.setDisableInactiveComponents(!0),this.listenTo(this.dragManipulator,g.Wb.MANIPULATION_STARTED,this.onManipulationStarted),this.listenTo(this.dragManipulator,g.Wb.MANIPULATION_ENDED,this.onManipulationEnded),this.listenTo(this.dragManipulator,p.w0.TRANSLATION_START,this.translationStart),this.listenTo(this.dragManipulator,p.w0.TRANSLATION_CHANGE,this.translationChange),this.listenTo(this.dragManipulator,p.w0.TRANSLATION_END,this.translationEnd)}this.dragStart=this.manipulatorData?.getValue().offset.getVec3(),this.updateManipulatorFromDefinition(this.dragManipulator)}updateLockedManipulator(){this.lockedManipulator||(this.lockedManipulator=new I.Triad(this.viewer,g.Ak.DRAG),this.lockedManipulator.setIsEnabled(!1)),this.updateManipulatorFromDefinition(this.lockedManipulator)}translationStart(){this.dragManipulator.isDragging=!0}translationChange(e){if(!this.dragManipulator)return;const t=new d.Kxj;t.offset=new d.d0F,t.offset.x=e[0]+this.dragStart[0],t.offset.y=e[1]+this.dragStart[1],t.offset.z=e[2]+this.dragStart[2],this.sendValue(t)}translationEnd(){this.dragManipulator.isDragging=!1}}class b extends(666==i.j?P:null){constructor(e,t,i){super(t),this.dragManipulator=null,this.lockedManipulator=null,this.manipulatorData=null,this.inferenceController=null,this.baseTransform=null,this.valueTransform=null,this.preRepositionTransform=null,this.lastSentPosition=null,this.receivedLastUpdate=!1,this.activeManipulatorEnum=d.pMe.NONE,this.editViewInputSubject=new l.x,this.editViewInputSubscription=null,this.manipulatorData=e,this.valueTransform=h.clone(e.getValue().transform.getGlMatrix()),this.baseTransform=h.clone(e.base.getGlMatrix()),this.coordinateDisplayFactory=(e,t)=>t.createInferenceDisplay(e),this.inferenceController=new s.ae(i,this.coordinateDisplayFactory,!0,!0,this.viewer,!0),this.listenTo(this.inferenceController,s.lp.MOUSE_ENTER,this.onEnterInference),this.listenTo(this.inferenceController,s.lp.MOUSE_LEAVE,this.onLeaveInference)}sendEditValue(){const e=new d.SP9;e.transform=new d.u8g;const t=h.multiply(h.create(),h.invert(h.create(),this.baseTransform),this.dragManipulator.transform);e.transform.updateFromGlMatrix(t),e.dragType=d.pMe.NONE,this.sendValueWithNoDrag(e),this.lastSentPosition=t,this.receivedLastUpdate=!1,this.editViewInputSubscription.unsubscribe()}updateManipulatorFromDefinition(e){if(!this.manipulatorData)return;const t=this.manipulatorData.getValue().transform.getGlMatrix(),i=this.manipulatorData.base.getGlMatrix();e.setId(this.manipulatorData.manipulatorId),e.setStyle(this.manipulatorData.style),e.updateDefinition(h.multiply(h.create(),i,t)),h.equals(i,this.baseTransform)||(this.valueTransform=h.clone(t),this.baseTransform=h.clone(i),e.removeEditViewAndHighlights()),this.lastSentPosition&&(h.equals(t,this.lastSentPosition)?this.receivedLastUpdate=!0:this.receivedLastUpdate&&e.removeEditViewAndHighlights())}updateDragManipulator(){if(!this.dragManipulator){const e={displayEditView:this.manipulatorData.displayEditView};this.dragManipulator=new I.Triad(this.viewer,g.Ak.FULL,e),this.dragManipulator.updateAngleRange(-2*Math.PI,2*Math.PI),this.dragManipulator.updateEditAngleRange(-2*Math.PI,2*Math.PI),this.dragManipulator.setDisableInactiveComponents(!0),this.listenTo(this.dragManipulator,g.Wb.MANIPULATION_STARTED,this.onManipulationStarted),this.listenTo(this.dragManipulator,g.Wb.MANIPULATION_ENDED,this.onManipulationEnded),this.listenTo(this.dragManipulator,p.w0.TRANSLATION_START,this.onDragStart),this.listenTo(this.dragManipulator,p.w0.TRANSLATION_CHANGE,this.onTransformDragEdit),this.listenTo(this.dragManipulator,p.w0.TRANSLATION_EDIT,this.onTransformEdit),this.listenTo(this.dragManipulator,p.w0.TRANSLATION_END,this.onDragEnd),this.listenTo(this.dragManipulator,p.w0.ROTATION_START,this.onDragStart),this.listenTo(this.dragManipulator,p.w0.ROTATION_CHANGE,this.onTransformDragEdit),this.listenTo(this.dragManipulator,p.w0.ROTATION_EDIT,this.onTransformEdit),this.listenTo(this.dragManipulator,p.w0.ROTATION_END,this.onDragEnd),this.listenTo(this.dragManipulator,p.w0.REPOSITION_START,this.onTriadRepositionStarted),this.listenTo(this.dragManipulator,p.w0.REPOSITION_END,this.onTriadRepositionEnded)}this.updateManipulatorFromDefinition(this.dragManipulator),this.valueTransform=h.clone(this.manipulatorData?.getValue()?.transform?.getGlMatrix()),this.baseTransform=h.clone(this.manipulatorData?.base?.getGlMatrix())}updateLockedManipulator(){this.lockedManipulator||(this.lockedManipulator=new I.Triad(this.viewer,g.Ak.FULL),this.lockedManipulator.setIsEnabled(!1)),this.updateManipulatorFromDefinition(this.lockedManipulator)}getActiveManipulatorDragType(){switch(this.dragManipulator.activeManipulator.getId()){case"TRIAD_X_ROTATION":return d.pMe.ROTATION_X;case"TRIAD_Y_ROTATION":return d.pMe.ROTATION_Y;case"TRIAD_Z_ROTATION":return d.pMe.ROTATION_Z;case"TRIAD_X_DIRECTION":return d.pMe.LINEAR_X;case"TRIAD_Y_DIRECTION":return d.pMe.LINEAR_Y;case"TRIAD_Z_DIRECTION":return d.pMe.LINEAR_Z;case"TRIAD_XY_PLANE":return d.pMe.PLANAR_XY;case"TRIAD_XZ_PLANE":return d.pMe.PLANAR_XZ;case"TRIAD_YZ_PLANE":return d.pMe.PLANAR_YZ;case"TRIAD_FREE_DRAG":return d.pMe.REPOSITION;default:return d.pMe.NONE}}onDragStart(){this.dragManipulator.isDragging=!0,this.receivedLastUpdate=!1,this.activeManipulatorEnum=this.getActiveManipulatorDragType()}onTransformDragEdit(){if(!this.dragManipulator||!this.dragManipulator.isDragging||this.dragManipulator.getIsLocked())return;const e=new d.SP9;e.transform=new d.u8g,e.transform.updateFromGlMatrix(h.multiply(h.create(),h.invert(h.create(),this.baseTransform),this.dragManipulator.transform)),e.dragType=this.activeManipulatorEnum,this.sendValue(e)}onDragEnd(){this.dragManipulator.isDragging=!1,this.lastSentPosition=h.multiply(h.create(),h.invert(h.create(),this.baseTransform),this.dragManipulator.transform),this.activeManipulatorEnum=d.pMe.NONE}onTransformEdit(){this.editViewInputSubscription&&!this.editViewInputSubscription.closed||(this.editViewInputSubscription=this.editViewInputSubject.pipe((0,S.b)(250)).subscribe((()=>this.sendEditValue()))),this.editViewInputSubject.next()}onTriadRepositionStarted(){this.inferenceController?.startInferencing(),this.preRepositionTransform=h.clone(this.valueTransform)}sendRepositionStartTranform(){if(null===this.preRepositionTransform)return;const e=new d.SP9;e.transform=new d.u8g,e.transform.updateFromGlMatrix(this.preRepositionTransform),this.sendValue(e)}onTriadRepositionEnded(e){this.inferenceController?.stopInferencing(),this.preRepositionTransform=null}onEnterInference(e){if(!e)return;const t=new d.SP9;t.transform=new d.u8g;const i=e.coordinateSystem.getGlMatrix();t.transform.updateFromGlMatrix(h.mul(h.create(),h.invert(h.create(),this.baseTransform),i)),this.sendValue(t),this.dragManipulator?.setIsLocked(!0)}onLeaveInference(e){this.dragManipulator?.setIsLocked(!1),this.sendRepositionStartTranform()}stopInferencing(){this.inferenceController?.stopInferencing()}}function L(e,t,i){return e instanceof d.EyX?new O(t):e instanceof d.AyX?new R(t):e instanceof d.bD3?new w(t):e instanceof d.CXU?new N(e,t):e instanceof d.Y6l?new v(t):e instanceof d.GR3?new _(t):e instanceof d.nBh?new b(e,t,i):null}},51227:function(e,t,i){function s(e,t,i){e.enable(e.STENCIL_TEST),e.stencilFunc(e.GREATER,t,i),e.stencilMask(0),e.stencilOp(e.KEEP,e.KEEP,e.KEEP)}function n(e,t,i){e.enable(e.STENCIL_TEST),e.stencilFunc(e.ALWAYS,t,255),e.stencilMask(i),e.stencilOp(e.KEEP,e.KEEP,e.REPLACE)}function r(e,t,i){e.enable(e.STENCIL_TEST),e.stencilFunc(e.GREATER,t,i),e.stencilMask(i),e.stencilOp(e.KEEP,e.KEEP,e.REPLACE)}function a(e){e.clearStencil(0),e.stencilMask(255),e.clear(e.STENCIL_BUFFER_BIT)}function o(e,t){e.clearStencil(0),e.stencilMask(t),e.clear(e.STENCIL_BUFFER_BIT)}i.d(t,{EZ:function(){return a},Ig:function(){return r},LL:function(){return s},Pq:function(){return o},U$:function(){return n}})},14456:function(e,t,i){var s;i.d(t,{Z:function(){return s}}),function(e){e[e.ONGOING=0]="ONGOING",e[e.COMPLETE=1]="COMPLETE"}(s||(s={}))},71615:function(e,t,i){var s;i.d(t,{H:function(){return s}}),function(e){e.Top="Top",e.Front="Front",e.Right="Right",e.UseFace="UseFace"}(s||(s={}))},72229:function(e,t,i){var s;i.d(t,{I:function(){return s}}),function(e){e[e.OUTSIDE=0]="OUTSIDE",e[e.INSIDE=1]="INSIDE",e[e.INTERSECTING=2]="INTERSECTING"}(s||(s={}))},58648:function(e,t,i){i.d(t,{Wz:function(){return n},w:function(){return r},xV:function(){return s}});const s="curvatureColorMap",n="curvature-analysis-canvas-controls-preferred-location",r="curvatureAnalysis-canvas-controls"},61027:function(e,t,i){i.d(t,{DA:function(){return d},FZ:function(){return s},Xc:function(){return h},Yn:function(){return o},dN:function(){return a},je:function(){return r},nY:function(){return c},rx:function(){return u},uA:function(){return l},vM:function(){return n}});class s{constructor(){this.ignoreSpaceParameters=!1,this.displayLimitRangeText=!0,this.displayLimitRangeTicks=!1,this.textReadOnly=!1,this.textPrefix=""}}function n(e){return e&&e.isDimension()}function r(e){return e&&"AngularDimension"===e.getId()}function a(e){return e&&"ArcLengthDimension"===e.getId()}function o(e){return e&&"CurveLengthDimension"===e.getId()}function h(e){return e&&"EllipseDiameterDimension"===e.getId()}function c(e){return e&&"LinearDimension"===e.getId()}function l(e){return e&&"CenterlineDimension"===e.getId()}function d(e){return e&&"RadialDimension"===e.getId()}function u(e){return e&&"CountDimension"===e.getId()}},53074:function(e,t,i){i.d(t,{i:function(){return s}});const s=function(e){return e.isEdge()&&!e.isInternalEdge()&&e.isFromBody()&&!e.isFromWireBody()&&e.getBodyMetaData()?.isModifiableBody()}},22764:function(e,t,i){var s;i.d(t,{Q:function(){return s}}),function(e){e.FULL="full",e.INTERACTIVE="interactive",e.MANIPULATING="manipulating"}(s||(s={}))},14873:function(e,t,i){i.d(t,{M:function(){return s}});const s=.3},93615:function(e,t,i){var s;i.d(t,{Po:function(){return n},aU:function(){return r},o2:function(){return s}}),function(e){e.UI="UI",e.RELATED_OCCURRENCE="RELATED_OCCURRENCE",e.RELATED_OCCURRENCE_MATE="RELATED_OCCURRENCE_MATE",e.ACCUMULATED_SMART_SELECTION="ACCUMULATED_SMART_SELECTION",e.SMART_SELECTION="SMART_SELECTION",e.ENTITY="ENTITY",e.UI_RELATED_ENTITY="UI_RELATED_ENTITY",e.FEATURE="FEATURE",e.PART="PART",e.OCCURRENCE="OCCURRENCE",e.OCCURRENCE_COMMENT="OCCURRENCE_COMMENT",e.COMMENT="COMMENT",e.FILTERED_ENTITIES="FILTERED_ENTITIES",e.OCCURRENCE_PRE="OCCURRENCE_PRE",e.PRE="PRE",e.ERROR="ERROR",e.SECONDARY="SECONDARY",e.SECONDARY_PRE="SECONDARY_PRE",e.OCCURRENCE_SECONDARY_PRE="OCCURRENCE_SECONDARY_PRE",e.ASSOCIATED_OCCURRENCE="ASSOCIATED_OCCURRENCE",e.ASSOCIATED_OCCURRENCE_PRE="ASSOCIATED_OCCURRENCE_PRE",e.INCONTEXT_REFERENCE="INCONTEXT_REFERENCE",e.INCONTEXT_REFERENCE_PRE="INCONTEXT_REFERENCE_PRE",e.RETRIEVAL="RETRIEVAL",e.OPERATION_PERSISTENT="OPERATION_PERSISTENT",e.REPAIR="REPAIR",e.REPAIR_HOVER="REPAIR_HOVER",e.PROFILE_INSPECTOR="PROFILE_INSPECTOR",e.PROFILE_INSPECTOR_FOCUS="PROFILE_INSPECTOR_FOCUS",e.ANNOTATION_REFERENCES="ANNOTATION_REFERENCES"}(s||(s={}));const n=[s.UI,s.ACCUMULATED_SMART_SELECTION,s.SMART_SELECTION,s.ENTITY,s.FEATURE,s.PART,s.OCCURRENCE,s.SECONDARY];var r;!function(e){e[e.REMOVE=0]="REMOVE",e[e.ADD=1]="ADD"}(r||(r={}))},55647:function(e,t,i){var s;i.d(t,{t:function(){return s}}),function(e){e[e.LEFT=1]="LEFT",e[e.MIDDLE=2]="MIDDLE",e[e.RIGHT=3]="RIGHT"}(s||(s={}))},42812:function(e,t,i){var s;i.d(t,{P:function(){return s}}),function(e){e[e.MAKE_TRANSPARENT=0]="MAKE_TRANSPARENT",e[e.ISOLATE=1]="ISOLATE"}(s||(s={}))},1190:function(e,t,i){var s,n,r;function a(e){return e.isManipulator()}function o(e){return void 0!==e.getAngle}function h(e){return void 0!==e.ray}function c(e){return void 0!==e.origin}function l(e){return void 0!==e.lastMouseRay}i.d(t,{Ak:function(){return s},Kg:function(){return o},Kl:function(){return h},LD:function(){return a},MJ:function(){return l},Wb:function(){return n},jC:function(){return r},xD:function(){return c}}),function(e){e.EXPLODE_CONVENIENCE_MANIPULATOR="explodeConvenienceManipulator",e.DRAG="drag",e.FULL="full",e.PLANE="plane",e.SKETCH="sketch",e.UNKNOWN="unknown"}(s||(s={})),function(e){e.MANIPULATION_STARTED="manipulationstarted",e.MANIPULATION_ENDED="manipulationended",e.VALUE_CHANGED="valuechanged",e.VALUE_EDITED="valueedited",e.CACHE_TRANSFORM="cachetransform",e.CLICKED="clicked",e.DOUBLE_CLICKED="doubleclicked",e.MANIPULATOR_ENTER="enter",e.MANIPULATOR_LEAVE="leave"}(n||(n={})),function(e){e.MANIPULATION_STARTED="manipulationstarted",e.VALUE_CHANGED="valuechanged",e.MANIPULATION_ENDED="manipulationended"}(r||(r={}))},4644:function(e,t,i){i.d(t,{G2:function(){return a},X5:function(){return n},ZB:function(){return r},s_:function(){return s}});const s="sectionPlaneSelection";let n=!1;function r(){n=!0}function a(){n=!1}},50208:function(e,t,i){i.d(t,{I:function(){return n},S:function(){return s}});const s="simulationColorMap",n="sim-canvas-controls"},81788:function(e,t,i){i.d(t,{LI:function(){return n},_s:function(){return r},bY:function(){return a},d0:function(){return s}});const s="thicknessColorMap",n="thickness-analysis-canvas-controls-panel",r="thicknessAnalysis-canvas-controls";var a;!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.PROCESSING=1]="PROCESSING",e[e.RETRIEVING=2]="RETRIEVING",e[e.PREPARING=3]="PREPARING",e[e.CALCULATING=4]="CALCULATING",e[e.REFINING=5]="REFINING",e[e.POSTPROCESSING=6]="POSTPROCESSING",e[e.COMPLETE=7]="COMPLETE"}(a||(a={}))},82630:function(e,t,i){var s,n,r;i.d(t,{tF:function(){return r},vn:function(){return n},w0:function(){return s}}),function(e){e.REPOSITION_START="repositionStart",e.REPOSITION="reposition",e.REPOSITION_END="repositionEnd",e.ROTATION_START="rotationStart",e.ROTATION_CHANGE="rotationChange",e.ROTATION_END="rotationEnd",e.ROTATION_EDIT="rotationEdit",e.TRANSLATION_START="translationStart",e.TRANSLATION_CHANGE="translationChange",e.TRANSLATION_END="translationEnd",e.TRANSLATION_EDIT="translationEdit",e.SCALING_START="scalingStart",e.SCALING_CHANGE="scalingChange",e.SCALING_END="scalingEnd",e.SCALING_EDIT="scalingEdit",e.COMMAND="componentCommand",e.ENTER_INFERENCE="enterInference",e.LEAVE_INFERENCE="leaveInference",e.DOUBLE_CLICKED="doubleClicked"}(s||(s={})),function(e){e.X_ROTATION="TRIAD_X_ROTATION",e.Y_ROTATION="TRIAD_Y_ROTATION",e.Z_ROTATION="TRIAD_Z_ROTATION",e.X_DIRECTION="TRIAD_X_DIRECTION",e.Y_DIRECTION="TRIAD_Y_DIRECTION",e.Z_DIRECTION="TRIAD_Z_DIRECTION",e.XY_PLANE="TRIAD_XY_PLANE",e.XZ_PLANE="TRIAD_XZ_PLANE",e.YZ_PLANE="TRIAD_YZ_PLANE",e.FREE_DRAG="TRIAD_FREE_DRAG",e.SCALING="SCALING"}(n||(n={})),function(e){e[e.Origin=0]="Origin",e[e.X=1]="X",e[e.Y=2]="Y",e[e.Z=3]="Z"}(r||(r={}))},51310:function(e,t,i){function s(e){return e&&e.getId&&"image"===e.getId()}i.d(t,{AW:function(){return r},Eg:function(){return s},Wf:function(){return n}});class n{constructor(e,t,i,s,n,r,a,o,h){this.deterministicId=e,this.secondDeterministicId=t,this.occurrence=i,this.inferenceType=s,this.coordinateSystem=n,this.sourceIsFeature=r,this.meshPointData=null,this.isInContextEntity=!!a,this.isPartStudioMateConnector=!!o,this.isInstanceOrigin=!!h}}const r="clicked"},27124:function(e,t,i){var s;i.d(t,{k:function(){return s}}),function(e){e.NONE="none",e.ROTATE="rotate",e.AXIS_ROTATE="axisRotate",e.PAN="pan",e.ZOOM="zoom"}(s||(s={}))},46252:function(e,t,i){var s,n;i.d(t,{C:function(){return n},V:function(){return s}}),function(e){e[e.DEFAULT=0]="DEFAULT",e[e.COARSE=1]="COARSE",e[e.FINE=2]="FINE"}(s||(s={})),function(e){e.DEFAULT="default",e.CROSSHAIR="url(/images/crosshair-cursor.svg) 7.5 7.5,crosshair",e.HAND="hand",e.GRAB="grab",e.GRABBING="grabbing",e.POINTER="pointer",e.ZOOM_IN="zoom-in",e.MOVE="move",e.TEXT="text",e.WAIT="wait",e.HELP="help",e.N_RESIZE="n-resize",e.NE_RESIZE="ne-resize",e.NS_RESIZE="ns-resize",e.E_RESIZE="e-resize",e.EW_RESIZE="ew-resize",e.SE_RESIZE="se-resize",e.S_RESIZE="s-resize",e.SW_RESIZE="sw-resize",e.W_RESIZE="w-resize",e.NW_RESIZE="nw-resize",e.PROGRESS="progress",e.NOT_ALLOWED="not-allowed",e.NO_DROP="no-drop",e.VERTICAL_TEXT="vertical-text",e.ALL_SCROLL="all-scroll",e.COL_RESIZE="col-resize",e.ROW_RESIZE="row-resize",e.SNAPMATE_GENERIC="url(/images/cursors/macSnapMate_Cursor.svg) 7.5 7.5,url(/images/cursors/SnapMate_Cursor.png) 7.5 7.5,nesw-resize",e.CONFIRMATION_GENERIC="url(/images/cursors/macConfirmation_Cursor.svg) 1 1,url(/images/cursors/Confirmation_Cursor.png) 1 1,default",e.SNAPMATE_WINDOWS="url(/images/cursors/winSnapMate_Cursor.svg) 7.5 7.5,url(/images/cursors/SnapMate_Cursor.png) 7.5 7.5,nesw-resize",e.CONFIRMATION_WINDOWS="url(/images/cursors/winConfirmation_Cursor.svg) 1 1,url(/images/cursors/Confirmation_Cursor.png) 1 1,default",e.BOXDESELECTION_CURSORS_GENERIC="url(/images/cursors/macRemoveSelectionCursor.svg) 3 3,url(/images/cursors/macRemoveSelectionCursor-mdpi.png) 3 3,auto",e.BOXDESELECTION_CURSORS_WINDOWS="url(/images/cursors/winRemoveSelectionCursor.svg) 1 2,url(/images/cursors/winRemoveSelectionCursor-mdpi.png) 1 2,auto"}(n||(n={}))},84685:function(e,t,i){var s;i.d(t,{$:function(){return s}}),function(e){e.VR="immersive-vr",e.AR="immersive-ar"}(s||(s={}))},23172:function(e,t,i){var s;i.d(t,{L:function(){return s}}),function(e){e[e.BASE=0]="BASE",e[e.PREVIEW=1]="PREVIEW"}(s||(s={}))},46406:function(e,t,i){var s;i.d(t,{N:function(){return s}}),function(e){e.MINIMUM_RADIUS="minimum_radius",e.CURVATURE_COMBS="show_curvature",e.INFLECTION_POINTS="inflection_points",e.U_CURVES="u_curves",e.V_CURVES="v_curves",e.CROSS_FACE="cross_face",e.CPT_GRIDS="control_point_grids",e.KNOT_POINTS="knot_points",e.DETAILS="details"}(s||(s={}))},84013:function(e,t,i){var s;i.d(t,{K:function(){return s},Y:function(){return n}}),function(e){e[e.EDGE_U=0]="EDGE_U",e[e.FACE_U=1]="FACE_U",e[e.FACE_V=2]="FACE_V"}(s||(s={}));class n{constructor(e,t){this.curvatureType=e,this.curvatureData=t}isEdgeCurvature(){return this.curvatureType===s.EDGE_U}isFaceUCurve(){return this.curvatureType===s.FACE_U}isFaceVCurve(){return this.curvatureType===s.FACE_V}isFaceCurvature(){return this.isFaceUCurve()||this.isFaceVCurve()}}},65915:function(e,t,i){i.d(t,{$_:function(){return S},A1:function(){return $e},AD:function(){return U},Aw:function(){return it},CD:function(){return z},CJ:function(){return ce},Cg:function(){return ve},Cr:function(){return ue},Cv:function(){return qe},F5:function(){return me},FM:function(){return u},Fc:function(){return Me},GO:function(){return at},Gf:function(){return nt},Hq:function(){return Le},Hv:function(){return m},Ip:function(){return Ge},JF:function(){return G},JH:function(){return Qe},Jm:function(){return Ve},Jp:function(){return Ne},KB:function(){return lt},KO:function(){return Ie},LA:function(){return Q},M1:function(){return fe},Mp:function(){return ct},NM:function(){return x},Nf:function(){return st},Nw:function(){return Je},P1:function(){return ie},PX:function(){return He},Q6:function(){return A},Qe:function(){return Re},R1:function(){return rt},RV:function(){return Ae},Rq:function(){return N},Sr:function(){return ge},Sz:function(){return ae},T$:function(){return le},TN:function(){return ye},Uj:function(){return be},Ut:function(){return pt},V1:function(){return Ce},Vp:function(){return M},W2:function(){return W},WB:function(){return Ze},WY:function(){return j},Wp:function(){return D},Xc:function(){return Oe},YW:function(){return ze},_h:function(){return H},a:function(){return B},aI:function(){return Ye},ad:function(){return q},am:function(){return _e},b3:function(){return re},b9:function(){return f},bh:function(){return Ee},bs:function(){return V},cW:function(){return L},cp:function(){return C},cu:function(){return P},cy:function(){return Z},d:function(){return ke},dP:function(){return R},eR:function(){return g},f4:function(){return ht},fd:function(){return je},fu:function(){return Se},gV:function(){return Pe},gW:function(){return tt},h0:function(){return se},hj:function(){return K},i$:function(){return y},iH:function(){return et},ib:function(){return Ke},kl:function(){return De},kt:function(){return we},m2:function(){return Fe},nh:function(){return xe},nu:function(){return ut},oG:function(){return te},oL:function(){return he},og:function(){return dt},ox:function(){return J},pB:function(){return c},pF:function(){return T},pK:function(){return O},pO:function(){return F},pU:function(){return $},pj:function(){return Ue},rw:function(){return oe},s4:function(){return _},sJ:function(){return X},sd:function(){return ne},so:function(){return b},t0:function(){return Y},tS:function(){return Te},u:function(){return w},u5:function(){return ee},u9:function(){return I},uv:function(){return E},v9:function(){return mt},vc:function(){return gt},vk:function(){return Xe},vu:function(){return We},wf:function(){return k},xA:function(){return d},xy:function(){return Be},yB:function(){return v},ye:function(){return de},zK:function(){return pe},zT:function(){return p},zi:function(){return ot}});var s=i(88155),n=i(47061);if(666==i.j)var r=i(99429);if(666==i.j)var a=i(45065);if(666==i.j)var o=i(69835);if(666==i.j)var h=i(41662);class c extends n.T{constructor(){super()}}let l=new c;function d(){if(s.uQ){const e=(0,s.uQ)();if(e)return e.getEventDispatcher()}return l}function u(e,t){t&&(t.setEventDispatcher(l),l=new c),e&&!t&&(l=e.getEventDispatcher(),e.setEventDispatcher(new c))}function g(e){return(0,r.R)((function(t){return d().on(e,t)}),(function(t){return d().off(e,t)}),(function(e){return arguments}))}const p="ACTIVE_VIEWER_SET",m="VIEW_WILL_DRAW",f="VIEW_WILL_PICK",I="VIEW_DID_DRAW",E="ASSEMBLY_TIMES",S="PART_STUDIO_TIMES",T="EVENT_NEEDS_ANGULAR_BROADCAST",D="ELEMENT_GRAPHICS_LOADING",C="ELEMENT_VIEW_INITIALIZED",M="ELEMENT_PREVIEW_GRAPHICS_LOADED",y="CLOSE_ANNOTATION_EDIT",A="DIMENSION_TEXT_SINGLE_CLICKED",P="DIMENSION_TEXT_DOUBLE_CLICKED",O="DIMENSION_EDIT_CLOSED",R="CLOSE_DIMENSION_EDIT",w="DIMENSION_DELETE_REQUEST",v="SHOW_DIMENSION_EXPRESSIONS_CHANGED",_="DIMENSION_TEXT_DRAG_ENDED",N="HOLE_CALLOUT_DRAG_ENDED",b="SESSION_ENDED",L="GL_CONTEXT_LOST",F="GL_CONTEXT_RESTORED",x="SELECT_OTHER",B="SELECT_OTHER_REVERSE",V="SHOW_SMART_SELECTION",U="CLOSE_SELECT_OTHER",H="SHOW_SKETCH_TEXT",G="SKETCH_COMMAND_ACTIVATED",k="CLOSE_SKETCH_SUB_DIALOG",W="NEW_PART_LIST",z="NON_TRIVIAL_PART_STUDIO_DATA_PROCESSED",X="PART_STUDIO_PART_VISIBILITY_CHANGED",Z="PART_STUDIO_DATA_AND_SELECTION_REMAP_PROCESSED",q="DISPLAYED_PART_STUDIO",Y="DISPLAYED_ASSEMBLY",K="ASSEMBLY_DATA_PROCESSED",j="DIMENSION_VALUE_CHANGED",Q="BODIES_LOADED",$="CANVAS_CLICK",J="CANVAS_MOUSEENTER",ee="CANVAS_MOUSELEAVE",te="CANVAS_MOUSEMOVE",ie="CHANGE_FEATURE_APPEARANCE",se="CHANGE_VIEW",ne="GRAPHICS_HANDLED_CLICK_EVENT",re="DEVICE_PIXEL_RATIO_CHANGED",ae="SELECTION_REJECTED",oe="CLOSE_MATE_DOF_CHOOSER",he="VIEW_CONTAINER_MENU_INVOKED",ce="ANALYSIS_MENU_INVOKED",le="CREATE_SECTION_PLANE_INFERENCE_CONTROLLER",de="DESTROY_SECTION_PLANE_INFERENCE_CONTROLLER",ue="DEFAULT_UNITS_CHANGED",ge="SECTION_PLANE_ADDED",pe="SECTION_PLANE_REMOVED",me="MAXIMUM_NUMBER_OF_SECTION_PLANES_REACHED",fe="SECTION_VIEW_DIALOG_OPENED",Ie="SECTION_VIEW_DIALOG_CLOSED",Ee="UPDATE_INCONTEXT_ISOLATION",Se="UI_ELEMENT_CLICK",Te="VIEWER_CANVAS_ATTACHED_TO_CONTAINER",De="ASSEMBLY_ANIMATE_MATE_STARTED",Ce="ASSEMBLY_ANIMATE_MATE_ENDED",Me="SPACEMOUSE_ACTION_SET_CHANGED",ye="SPACEMOUSE_COMMANDS_RECEIVED",Ae="SPACEMOUSE_COMMAND",Pe="WILL_RENDER_THUMBNAILS",Oe="DID_RENDER_THUMBNAILS",Re="RETRIEVE_OCCURRENCE_DISPLAY_DATA",we="REPORT_MEMORY_USAGE",ve="RETRIEVE_ELEMENT_DISPLAY_DATA",_e="ADD_TEMPORARY_TESSELLATION_OVERRIDE",Ne="CLEAR_TEMPORARY_TESSELLATION_OVERRIDES",be="RETRIEVE_SMOOTH_EDGE_INFORMATION",Le="ACTIVE_SHEETMETAL_MODEL_CHANGED",Fe="BEFORE_PRINT_IMAGE_GENERATION",xe="AFTER_PRINT_IMAGE_GENERATION",Be="SIMULATION_MINIMUM_CLICKED",Ve="SIMULATION_MAXIMUM_CLICKED",Ue="SIMULATION_RANGE_CHANGED",He="SIMULATION_LEGEND_OPENED",Ge="SIMULATION_LEGEND_CLOSED",ke="THICKNESS_ANALYSIS_COLOR_MAPPING_CHANGED",We="THICKNESS_ANALYSIS_DISPLAYED_FIELD_CHANGED",ze="THICKNESS_ANALYSIS_MINIMUM_CLICKED",Xe="THICKNESS_ANALYSIS_MAXIMUM_CLICKED",Ze="THICKNESS_ANALYSIS_RANGE_CHANGED",qe="THICKNESS_ANALYSIS_LEGEND_OPENED",Ye="THICKNESS_ANALYSIS_LEGEND_CLOSED",Ke="CURVATURE_ANALYSIS_LEGEND_MINIMUM_CLICKED",je="CURVATURE_ANALYSIS_LEGEND_MAXIMUM_CLICKED",Qe="CURVATURE_ANALYSIS_RANGE_CHANGED",$e="CURVATURE_ANALYSIS_LEGEND_OPENED",Je="CURVATURE_ANALYSIS_LEGEND_CLOSED",et="CURVATURE_ANALYSIS_COLOR_MAPPING_CHANGED",tt="CURVATURE_ANALYSIS_CURVATURE_CONTROL_CHANGED",it="FOLLOW_MODE_LEADER_MOUSE_MOVED",st="FOLLOW_MODE_LEADER_MOUSE_OUT",nt="FOLLOW_MODE_DEACTIVATED",rt="SIMULATION_RESULTS_DISPLAYED",at="SIMULATION_CONNECTIONS_DISPLAYED",ot="NAMED_VIEW_APPLIED",ht="PICKS_BOX_SELECTED",ct="PICK_CONSTRAINT_SELECTED",lt="BOX_SELECTION_FINISHED",dt="ANNOTATION_DRAG_COMPLETE",ut="ANNOTATION_DRAG_LEADER_COMPLETE",gt="DIMENSION_SELECTED",pt="DIMENSION_DESELECTED";function mt(){const e=g(q).pipe((0,a.h)((e=>e[1]))),t=g(Y).pipe((0,a.h)((e=>e[1])));return e.pipe((0,o.b)(t),(0,h.q)(1))}},13480:function(e,t,i){i.d(t,{JE:function(){return n},U2:function(){return h},UQ:function(){return g},_6:function(){return o},c2:function(){return p},lm:function(){return a},nD:function(){return d},qR:function(){return l},rp:function(){return u},s:function(){return m},si:function(){return c},vN:function(){return r}});var s=i(19027);const n=666==i.j?[]:null,r=0,a=[1];var o,h;!function(e){e[e.DEFAULT=32]="DEFAULT",e[e.ENTITY=20]="ENTITY",e[e.OCCURRENCE_SLICE=12]="OCCURRENCE_SLICE",e[e.OCCURRENCE_ID=24]="OCCURRENCE_ID",e[e.HIGHLIGHT=16]="HIGHLIGHT"}(o||(o={})),function(e){e[e.ENTITY=1048575]="ENTITY",e[e.OCCURRENCE_SLICE=4095]="OCCURRENCE_SLICE"}(h||(h={}));class c{constructor(e){this.freeIds=[],this.nextId=a.slice(0);const t=e||o.DEFAULT;this.maximumElementSize=Math.pow(2,t)-1}clone(){const e=new c;return e.nextId=this.nextId.slice(0),e.freeIds=this.freeIds.slice(0),e.maximumElementSize=this.maximumElementSize,e}reset(){this.nextId=a.slice(0),this.freeIds=[]}getId(){if(this.freeIds.length>1)return this.freeIds.pop();const e=this.nextId.slice(0);let t,i=!1;for(t=0;t<this.nextId.length;++t)if(this.nextId[t]<this.maximumElementSize){this.nextId[t]=this.nextId[t]+1;for(let e=0;e<t;++e)this.nextId[e]=1;i=!0;break}if(!i){for(t=0;t<this.nextId.length;++t)this.nextId[t]=1;this.nextId.push(1)}return e}freeId(e){u(e)&&this.freeIds.push(e)}}function l(e){return e}function d(e,t){return(0,s.arraysEqual)(e,t)}function u(e){if(!e||e.length<1)return!1;for(let t=0;t<e.length;++t)if(e[t]===r)return!1;return!0}function g(e){const t=e.split(","),i=[];for(let e=0;e<t.length;e++)i.push(+t[e]);return i}const p=0;class m{constructor(e){this.freeIds=[],this.nextId=1;const t=e||o.DEFAULT;this.maximumNumberSize=Math.pow(2,t)-1}reset(){this.nextId=1,this.freeIds=[]}getId(){if(this.freeIds.length>1)return this.freeIds.pop();if(this.nextId===p)return p;const e=this.nextId++;return this.nextId>=this.maximumNumberSize&&(this.nextId=p),e}isIdValid(e){return e!==p}freeId(e){this.isIdValid(e)&&this.freeIds.push(e)}}},4087:function(e,t,i){i.d(t,{HqE:function(){return n.Hq},zTe:function(){return n.zT},am2:function(){return n.am},nhj:function(){return n.nh},ogA:function(){return n.og},nuS:function(){return n.nu},V11:function(){return n.V1},klk:function(){return n.kl},hjy:function(){return n.hj},uvd:function(){return n.uv},aUM:function(){return u.aU},ZK6:function(){return r.Z},m2d:function(){return n.m2},KB0:function(){return n.KB},AWD:function(){return D.AW},Pmj:function(){return p.P},LgS:function(){return O.L},pUS:function(){return n.pU},oxn:function(){return n.ox},u5l:function(){return n.u5},oGi:function(){return n.oG},P1w:function(){return n.P1},h02:function(){return n.h0},JpA:function(){return n.Jp},i$n:function(){return n.i$},dPN:function(){return n.dP},rwQ:function(){return n.rw},AD7:function(){return n.AD},wfd:function(){return n.wf},T$E:function(){return n.T$},Wzm:function(){return I.Wz},wao:function(){return I.w},iHz:function(){return n.iH},gWk:function(){return n.gW},Nwl:function(){return n.Nw},fdd:function(){return n.fd},ibh:function(){return n.ib},A1q:function(){return n.A1},JHq:function(){return n.JH},xV6:function(){return I.xV},CF9:function(){return A.C},CrY:function(){return n.Cr},ye3:function(){return n.ye},b3:function(){return n.b3},Xc0:function(){return n.Xc},uav:function(){return n.u},Utg:function(){return n.Ut},pKY:function(){return n.pK},vcd:function(){return n.vc},cu9:function(){return n.cu},s4e:function(){return n.s4},Q6T:function(){return n.Q6},WYs:function(){return n.WY},t0J:function(){return n.t0},adC:function(){return n.ad},FZj:function(){return o.FZ},Wp_:function(){return n.Wp},Vpt:function(){return n.Vp},cpE:function(){return n.cp},pFt:function(){return n.pF},Gfg:function(){return n.Gf},Awy:function(){return n.Aw},NfU:function(){return n.Nf},QpP:function(){return c.Q},cWC:function(){return n.cW},pOz:function(){return n.pO},sdI:function(){return n.sd},Rng:function(){return s},Rqr:function(){return n.Rq},$Ky:function(){return _.$K},o2L:function(){return u.o2},JE9:function(){return v.JE},Qyk:function(){return w.Qy},UKE:function(){return d},siw:function(){return v.si},_6$:function(){return v._6},Wfq:function(){return D.Wf},IiW:function(){return a.I},i8U:function(){return h.i},lLv:function(){return _.lL},F59:function(){return n.F5},kJR:function(){return y.k},tcH:function(){return g.t},ziX:function(){return n.zi},W2m:function(){return n.W2},CDm:function(){return n.CD},EBu:function(){return R.E},M81:function(){return l.M},sJs:function(){return n.sJ},$_3:function(){return n.$_},f4Y:function(){return n.f4},Mpj:function(){return n.Mp},ktd:function(){return n.kt},Cgl:function(){return n.Cg},Qeo:function(){return n.Qe},Uj6:function(){return n.Uj},Vf$:function(){return A.V},s_Y:function(){return E.s_},Srw:function(){return n.Sr},zKA:function(){return n.zK},KOV:function(){return n.KO},M1t:function(){return n.M1},SzR:function(){return n.Sz},NMw:function(){return n.NM},aat:function(){return n.a},_hB:function(){return n._h},bsB:function(){return n.bs},GOH:function(){return n.GO},Ipz:function(){return n.Ip},PXv:function(){return n.PX},Jml:function(){return n.Jm},xy2:function(){return n.xy},pjn:function(){return n.pj},R1N:function(){return n.R1},JFj:function(){return n.JF},TN9:function(){return n.TN},vjd:function(){return S},LIN:function(){return T.LI},_s_:function(){return T._s},daY:function(){return n.d},vu3:function(){return n.vu},aIt:function(){return n.aI},CvC:function(){return n.Cv},vkO:function(){return n.vk},YWe:function(){return n.YW},WBF:function(){return n.WB},d07:function(){return T.d0},bY7:function(){return T.bY},bhj:function(){return n.bh},tSV:function(){return n.tS},oLC:function(){return n.oL},u9p:function(){return n.u9},Hvz:function(){return n.Hv},gV9:function(){return n.gV},dPT:function(){return C},qT7:function(){return M},$Xk:function(){return P.$},ZBF:function(){return E.ZB},G29:function(){return E.G2},uQB:function(){return b.uQ},xA2:function(){return n.xA},IOg:function(){return b.IO},v93:function(){return n.v9},N9r:function(){return b.N9},eRd:function(){return n.eR},PoX:function(){return u.Po},rp5:function(){return v.rp},nD6:function(){return v.nD},jeL:function(){return o.je},jep:function(){return o.dN},uAu:function(){return o.uA},rxY:function(){return o.rx},Yn_:function(){return o.Yn},vMe:function(){return o.vM},Xc1:function(){return o.Xc},Egl:function(){return D.Eg},nYd:function(){return o.nY},wLR:function(){return f},DAH:function(){return o.DA},tYI:function(){return N.t},Ykz:function(){return b.Yk}});var s,n=i(65915);!function(e){e[e.NORMAL=0]="NORMAL",e[e.AGGRESSIVE_USER_CAUSED=1]="AGGRESSIVE_USER_CAUSED"}(s||(s={}));var r=i(14456),a=i(72229);if(666==i.j)var o=i(61027);if(666==i.j)var h=i(53074);var c=i(22764);if(666==i.j)var l=i(14873);var d,u=i(93615),g=i(55647),p=i(42812),m=i(22681);function f(e){return e&&e.getElementType()===m.GNh.PARTSTUDIO}if(666==i.j)var I=i(58648);if(666==i.j)var E=i(4644);!function(e){e[e.NOT_SELECTED=0]="NOT_SELECTED",e[e.PREHILITE=1]="PREHILITE",e[e.SELECTED=2]="SELECTED",e[e.MUTED=3]="MUTED"}(d||(d={}));class S{constructor(){this.lowerLeft=null,this.lowerRight=null,this.upperLeft=null,this.pixelSize=1}}var T=i(81788);if(666==i.j)var D=i(51310);var C,M,y=i(27124),A=i(46252),P=i(84685);!function(e){e[e.DOMINANT=0]="DOMINANT",e[e.NON_DOMINANT=1]="NON_DOMINANT"}(C||(C={})),function(e){e[e.TRIGGER=0]="TRIGGER",e[e.SQUEEZE=1]="SQUEEZE",e[e.TOUCH_PAD_PRESS=2]="TOUCH_PAD_PRESS",e[e.THUMBSTICK_PRESS=3]="THUMBSTICK_PRESS",e[e.A=4]="A",e[e.B=5]="B"}(M||(M={}));var O=i(23172),R=i(97248),w=i(40869),v=i(13480);i(40828);if(666==i.j)var _=i(90548);var N=i(10392),b=i(88155);i(71615)},97248:function(e,t,i){if(i.d(t,{E:function(){return r}}),666==i.j)var s=i(86925);var n=i(4087);class r{constructor(e){this.nameToId={},this.idToName={},this.idManager=new n.siw(e)}reset(){this.nameToId={},this.idToName={},this.idManager.reset()}clone(){const e=new r;return e.nameToId=(0,s.Z)(this.nameToId),e.idToName=(0,s.Z)(this.idToName),e.idManager=this.idManager.clone(),e}getOrCreateIdForName(e){let t=this.nameToId[e];return t||(t=this.idManager.getId(),this.nameToId[e]=t,this.idToName[t]=e),t}getIdForName(e){const t=this.nameToId[e];return t||n.JE9}getNameForId(e){const t=this.idToName[e];return t||null}removeName(e){const t=this.nameToId[e];t&&(this.idManager.freeId(t),delete this.nameToId[e],delete this.idToName[t])}}},40869:function(e,t,i){i.d(t,{$J:function(){return u},KF:function(){return c},QC:function(){return h},Qy:function(){return o},yx:function(){return d}});var s=i(88155),n=i(13480),r=i(97248),a=i(9851);const o=666==i.j?-1:null,h=0,c=0,l=1<<n._6.OCCURRENCE_SLICE;class d{constructor(e){this.viewer=e,(0,s.Yk)(e),this.namedIdManager=new r.E(n._6.OCCURRENCE_ID)}reset(){this.namedIdManager.reset()}convertToOccurrenceId(e){if(!(0,n.rp)(e))return o;if(e.length>1)return a.log.warn("More than the allowed number of occurrences have been allocated"),o;let t=e[0],i=1;for(;t>=l;)++i,t/=l;return this.viewer.notifyOfPickPassCount(i),e[0]}getOrCreateIdForName(e){return this.convertToOccurrenceId(this.namedIdManager.getOrCreateIdForName(e))}getIdForName(e){return this.convertToOccurrenceId(this.namedIdManager.getIdForName(e))}getNameForId(e){return this.namedIdManager.getNameForId([e])}removeName(e){this.namedIdManager.removeName(e)}}function u(e){return null!=e&&e!==o}},9757:function(e,t,i){var s;i.d(t,{E1:function(){return r},JB:function(){return a},MX:function(){return s},ip:function(){return n}}),function(e){e[e.POINTS=0]="POINTS",e[e.LINES=1]="LINES",e[e.INFINITE_LINES=2]="INFINITE_LINES",e[e.TRIANGLES=3]="TRIANGLES",e[e.TRIANGLE_STRIP=4]="TRIANGLE_STRIP",e[e.SILHOUETTES=5]="SILHOUETTES",e[e.COUNT=6]="COUNT",e[e.PRIMITIVE_UNKNOWN=-1]="PRIMITIVE_UNKNOWN"}(s||(s={}));const n=Math.ceil(Math.log(s.COUNT)/Math.log(2));function r(e){switch(e){case s.POINTS:return"POINTS";case s.LINES:return"LINES";case s.INFINITE_LINES:return"INFINITE_LINES";case s.TRIANGLES:return"TRIANGLES";case s.TRIANGLE_STRIP:return"TRIANGLE_STRIP";case s.SILHOUETTES:return"SILHOUETTES";default:return"PRIMITIVE_UNKNOWN"}}function a(e){switch(e){case s.POINTS:return s.POINTS;case s.LINES:return s.LINES;case s.INFINITE_LINES:return s.INFINITE_LINES;case s.TRIANGLES:return s.TRIANGLES;case s.TRIANGLE_STRIP:return s.TRIANGLE_STRIP;case s.SILHOUETTES:return s.SILHOUETTES}return s.PRIMITIVE_UNKNOWN}},40828:function(e,t,i){i.d(t,{HN:function(){return l},Vp:function(){return c},Xd:function(){return h},oA:function(){return s}});var s,n=i(88892);!function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON",e[e.AUTO=2]="AUTO"}(s||(s={}));let r,a=s.AUTO,o=null;function h(e){switch(a=e,a){case s.OFF:(0,n.Ko)(!0);break;case s.ON:(0,n.Ko)(!1);break;case s.AUTO:l()}}function c(e){o=e,l()}function l(){if(a!==s.AUTO)return;let e=(void 0===r&&(r=navigator.platform.indexOf("Mac")>-1),!r);const t=new RegExp(".*intel.*","i");o&&t.test(o.glRenderer)&&(e=!0),(0,n.Ko)(e)}l()},90548:function(e,t,i){i.d(t,{$K:function(){return a},EG:function(){return r},Jh:function(){return o},Vv:function(){return n},lL:function(){return s}});const s="mainSceneGraph",n="previewSceneGraph",r="hudSceneGraph",a="hudModelSceneGraph",o="inferencePickerSceneGraph"},93565:function(e,t,i){i.d(t,{kW:function(){return s},qn:function(){return o},xv:function(){return r}});var s,n=i(4889);!function(e){e.UPDATES="counter updates",e.DRAW_CALLS="draw calls",e.TRIANGLES="triangles",e.LINES="lines",e.POINTS="points"}(s||(s={}));class r{constructor(){this.countersSubject=new n.x,this.counters={}}increment(e,t){void 0===t&&(t=1);let i=this.counters[e];i||(i=0),this.counters[e]=i+t}resetCounters(){this.counters={}}updateModel(){this.increment(s.UPDATES),this.countersSubject.next(this.counters)}get countersObservable(){return this.countersSubject.asObservable()}}const a=new r;function o(){return a}},10392:function(e,t,i){i.d(t,{t:function(){return o}});var s=i(40828),n=i(88155);class r{constructor(){this.retinaDisplaySetting=s.oA.AUTO}getRetinaDisplaySetting(){return this.retinaDisplaySetting}setRetinaDisplaySetting(e){this.retinaDisplaySetting=e,(0,s.Xd)(this.retinaDisplaySetting),(0,n.uQ)().requestDraw()}setUserWebPreference(e){const t=s.oA[e.retinaDisplaySetting];this.setRetinaDisplaySetting(t)}}let a=null;function o(){return a||(a=new r),a}},88155:function(e,t,i){i.d(t,{IO:function(){return l},KO:function(){return o},N9:function(){return d},Yk:function(){return u},e$:function(){return h},uQ:function(){return c}});var s=i(9851),n=i(65915);let r=null,a=null;function o(e){a=e,a?a.getPrimaryViewController()&&r?.getPrimaryViewController()&&(a.getPrimaryViewController().forcedManipulationMode=r.getPrimaryViewController().forcedManipulationMode):a=r}function h(e){(0,n.FM)(r,e),r&&e&&s.log.warn("A second viewer was set to be active before the first was deactivated."),r=e,o(e)}function c(){return r}function l(){const e=c();return e?e.getModelViewManagers():null}function d(){return a}function u(e){return!!e||(s.log.warn("viewer is null or undefined"),!1)}},68734:function(e,t,i){i.d(t,{G9:function(){return r},SG:function(){return n},zp:function(){return s}});class s{isFromWireBody(){return!1}isFromPointBody(){return!1}isCompositeBody(){return!1}isFromConstructionGeometry(){return!1}isInternalEdge(){return!1}isAnnotation(){return!1}isPlanar(){return!1}getPlanarNormal(){return null}isFromBody(){return!1}isFromSolidBody(){return!1}isFromSheetBody(){return!1}isFace(){return!1}canContainFace(){return!1}isEdge(){return!1}canContainEdge(){return!1}isVertex(){return!1}canContainVertex(){return!1}isDegenerateEdge(){return!1}isDefinedBySMVertex(){return!1}isDefinedBySMEdge(){return!1}isDefinedBySMFace(){return!1}isMateConnector(){return!1}isMate(){return!1}containsMesh(){return!1}isFlattened(){return!1}isFromActiveSheetMetal(){return!1}isBody(){return!1}isFromSketch(){return!1}isSketchTextEntity(){return!1}isSketchTextStroke(){return!1}isSketchImageEntity(){return!1}isSketchGroup(){return!1}getSketchGroupSelection(){return null}isUserSketchEntity(){return!1}getFeatureIds(){return[]}makeBodySelection(){return null}makeCompositeBodySelections(){return null}makeSketchFeatureSelection(){return null}isFromOccurrence(){return!1}isOccurrence(){return!1}makeOccurrenceSelection(e){return null}isClosedCurve(){return!1}isFromClick(){return!1}isEntity(){return!1}hasMateQueryData(){return!1}isGeometryMate(){return!1}isWidthMate(){return!1}getMateType(){return null}isMateGroup(){return!1}isMateConnectorBasedMate(){return!1}isFeature(){return!1}getFeatureType(){return null}isLine(){return!1}isCircle(){return!1}isEllipse(){return!1}isConic(){return!1}isCylinder(){return!1}isCone(){return!1}isSphere(){return!1}isTorus(){return!1}isRevolved(){return!1}isExtruded(){return!1}isAssemblyPattern(){return!1}isParametricInstance(){return!1}isParametricPartStudioInstance(){return!1}isParametricPartStudioChildInstance(){return!1}isParametricChildInstance(){return!1}isReplicatedInstance(){return!1}isMirrorOrDerivedMirrorInstance(){return!1}isMirrorOrDerivMirroredDescendant(){return!1}isNonSolidPartOccurrence(){return!1}isTemporaryGeometry(){return!1}isModifiable(){return!1}isNonModifiable(){return!1}isEdgePoint(){return!1}isPatternedOccurrence(){return!1}isAssemblyOccurrence(){return!1}isPartOccurrence(){return!1}isSuppressedOccurrence(){return!1}isFlattenedOccurrence(){return!1}isStandardContentOccurrence(){return!1}getOccurrence(){return null}getOwnerAssemblyOccurrence(){return null}makeMateConnectorSelection(){return null}isSpline(){return!1}isAssemblySketch(){return!1}isFromSplineHandle(){return!1}isInternalSplinePoint(){return!1}isFromSplineControlPolygon(){return!1}isSolveStatusUnknown(){return!1}isSolveStatusUnderDefined(){return!1}isSolveStatusWellDefined(){return!1}isSolveStatusFixed(){return!1}isSolveStatusOverDefined(){return!1}isSolveStatusNotConsistent(){return!1}isSectionEntity(){return!1}getBodyId(){return""}getIdString(){return""}getType(){}getUsage(){}isConstructionPlane(){return!1}getDeterministicId(e){return""}getBodyMetaData(){}getSketchGroupFeatureId(){return null}isProperty(){return!1}isTableItem(){return!1}getChildSelections(){return[]}getDeterministicIdList(){return[]}}class n extends(666==i.j?s:null){isFromBody(){return!0}isFromSolidBody(){return!0}isVertex(){return!0}canContainVertex(){return!0}isEntity(){return!0}}class r extends(666==i.j?n:null){isEdgePoint(){return!0}isInContextSelection(){return!1}}},68434:function(e,t,i){i.d(t,{Jb:function(){return c},S4:function(){return n},cD:function(){return a},gv:function(){return s},jA:function(){return r},w$:function(){return h},xB:function(){return o}});var s,n,r,a,o,h,c,l=i(81578),d=i(68100),u=i(75920),g=i(35589),p=i(60482),m=i(34015),f=i(67185),I=i(99669);function E(e){return(t,i,s)=>(s||(s=t),e(s,t,i))}function S(e){return t=>e(t)}function T(e){return(t,i,s)=>(s||(s=t),e(s,t,i))}function D(e){return(t,i)=>e(t,i)}function C(e){return(t,i)=>(i||(i=t),e(i,t))}function M(e){return(t,i)=>(i||(i=t),e(i,t))}function y(e){return(t,i)=>e(t,i)}function A(e){return(t,i)=>e(i,t)}function P(e){return(t,i)=>e(t,i)}function O(e){return(t,i,s)=>(s||(s=i),e(s,i,t))}function R(e){return(t,i)=>(i||(i=t),e(i,t))}function w(e){return(t,i,s)=>(s||(s=t),e(s,t,i))}function v(e){return(t,i,s)=>(s||(s=t),e(s,t,i))}!function(e){var t;e.subtract=E(l.subtract),e.length=S(l.length),e.scale=T(l.scale),e.add=(t=l.add,(e,i,s)=>(s||(s=i),t(s,e,i))),e.dot=D(l.dot),e.normalize=C(l.normalize),e.negate=M(l.negate),e.dist=y(l.dist),e.direction=(e,t,i)=>{i||(i=e);const s=e[0]-t[0],n=e[1]-t[1];let r=s*s+n*n;return r?(r=1/Math.sqrt(r),i[0]=s*r,i[1]=n*r,i):(i[0]=0,i[1]=0,i[2]=0,i)},e.squaredLength=e=>l.squaredLength(e),e.set=A(l.copy),e.distanceSquared=P(l.squaredDistance),e.cross=(e,t)=>{const i=d.create();return l.cross(i,e,t),i[2]}}(s||(s={})),function(e){e.getAPerpendicularVector=e=>{const t=e[0],i=e[1];return Math.abs(t)<I.W.ZERO_LENGTH&&Math.abs(i)<I.W.ZERO_LENGTH?d.fromValues(1,0,0):d.fromValues(-i,t,0)},e.equal=d.equals,e.subtract=E(d.subtract),e.dist=y(d.dist),e.setXYZ=(e,t,i,s)=>(d.set(s,e,t,i),s),e.set=A(d.copy),e.scale=T(d.scale),e.dot=D(d.dot),e.add=(e,t,i)=>(i||(i=e),d.add(i,e,t)),e.negate=M(d.negate),e.normalize=C(d.normalize),e.length=S(d.length),e.cross=(e,t,i)=>(i||(i=e),d.cross(i,e,t)),e.distanceSquared=P(d.squaredDistance),e.squaredLength=e=>d.squaredLength(e),e.linComb=(e,t,i,s,n)=>(n||(n=e),n[0]=e[0]*t+i[0]*s,n[1]=e[1]*t+i[1]*s,n[2]=e[2]*t+i[2]*s,n);let t=null;const i=u.create();e.unproject=(e,s,n,r,a)=>{a||(a=e),t||(t=g.create());const o=t,h=i;return h[0]=2*(e[0]-r[0])/r[2]-1,h[1]=2*(e[1]-r[1])/r[3]-1,h[2]=2*e[2]-1,h[3]=1,g.multiply(o,n,s),g.invert(o,o)?(u.transformMat4(h,h,o),0===h[3]?null:(a[0]=h[0]/h[3],a[1]=h[1]/h[3],a[2]=h[2]/h[3],a)):null}}(n||(n={})),function(e){e.negate=M(u.negate),e.setXYZW=(e,t,i,s,n)=>(u.set(n,e,t,i,s),n),e.distanceSquared=P(u.squaredDistance),e.subtract=E(u.subtract),e.set=A(u.copy)}(r||(r={})),function(e){e.multiplyVec2=(e,t,i)=>{i||(i=t);const s=t[0],n=t[1];return i[0]=s*e[0]+n*e[1],i[1]=s*e[2]+n*e[3],i},e.transpose=R(p.transpose)}(a||(a={})),function(e){e.multiplyVec2=O(l.transformMat3),e.transpose=R(m.transpose),e.multiply=w(m.multiply),e.multiplyVec3=O(d.transformMat3)}(o||(o={})),function(e){e.createFrom=g.fromValues,e.equal=g.equals,e.multiply=w(g.multiply),e.multiplyVec4=O(u.transformMat4),e.multiplyVec3=O(d.transformMat4),e.inverse=(e,t)=>(t||(t=e),g.invert(t,e)),e.toRotationMat=(e,t)=>(t||(t=g.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=0,t[13]=0,t[14]=0,t[15]=1,t),e.translate=(e,t,i)=>(i||(i=e),g.translate(i,e,t)),e.rotate=(e,t,i,s)=>(s||(s=e),g.rotate(s,e,t,i)),e.toMat3=(e,t)=>(t||(t=m.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t),e.fromRotationTranslation=(e,t,i)=>(i||(i=g.create()),g.fromRotationTranslation(i,e,t)),e.scale=(e,t,i)=>(i||(i=e),g.scale(i,e,t)),e.rotateX=v(g.rotateX),e.rotateY=v(g.rotateY),e.rotateZ=v(g.rotateZ),e.lookAt=(e,t,i,s)=>(s||(s=g.create()),g.lookAt(s,e,t,i)),e.perspective=(e,t,i,s,n)=>{n||(n=g.create());const r=i*Math.tan(e*Math.PI/360),a=r*t;return g.frustum(n,-a,a,-r,r,i,s)},e.ortho=(e,t,i,s,n,r,a)=>(a||(a=g.create()),g.ortho(a,e,t,i,s,n,r)),e.set=(e,t)=>g.copy(t,t)}(h||(h={})),function(e){e.normalize=C(f.normalize),e.multiply=(e,t,i)=>(i||(i=e),f.multiply(i,e,t)),e.toMat4=(e,t)=>(t||(t=g.create()),g.fromQuat(t,e)),e.dot=f.dot,e.multiplyVec3=(e,t,i)=>(i||(i=t),d.transformQuat(i,t,e)),e.fromAngleAxis=(e,t,i)=>{i||(i=f.create());const s=.5*e,n=Math.sin(s);return i[3]=Math.cos(s),i[0]=n*t[0],i[1]=n*t[1],i[2]=n*t[2],i}}(c||(c={}))},8232:function(e,t,i){i.d(t,{m:function(){return c}});var s=i(32606),n=i(94205);if(666==i.j)var r=i(81578);if(666==i.j)var a=i(68100);if(666==i.j)var o=i(35589);var h=i(68434);class c extends(666==i.j?n.UIElement:null){constructor(e,t,i){super(i,n.HUD_SCENEGRAPH_ID),this.iconNodeProperties=this.viewer.getResources().typeToNodeProperties[n.sketchinformation.nodePropertiesTypes.OK],this.worldLocation=t;const r=s.default.getManager();this.iconSizeConstantName="CONSTRAINT_INDICATOR_PIXEL_SIZE",this.iconSize=r.getNumber(this.iconSizeConstantName),this.icon=e,this.listenTo(this.viewer.getEventDispatcher(),n.VIEW_WILL_PICK,this.onViewWillDraw),(0,n.ensureTextureAtlas)(this.viewer),this.invalidateDisplay()}invalidateDisplay(){this.removeMeshIncrements(),(0,n.requestDraw)()}getOffset(e){const t=r.fromValues(0,1),i=function(e,i){return r.dot(r.fromValues(e,i),t)},a=-Math.abs(i(.5,.5)),o=-Math.abs(i(.5,-.5)),h=s.default.getManager().getNumber("TEMPORARY_INFERENCE_OFFSET")-Math.min(a,o),c=-.99*(0,n.getHudLayerDepthRange)(e.getViewport())[1];return[t[0]*h,t[1]*h,c]}onDevicePixelRatioChanged(e){const t=s.default.getManager();this.iconSize=t.getNumber(this.iconSizeConstantName),this.invalidateDisplay()}onViewWillDraw(e,t){if(!this.viewer.getResources().constraintAtlas)return;const i=this.getOffset(e),s=this.getDefaultTransform(e);h.w$.translate(s,i),s[12]=Math.floor(s[12]),s[13]=Math.floor(s[13]),this.setTransform(s),this.updateIconGraphics()}getDefaultTransform(e){let t=e.projectWorldPointToViewport(this.worldLocation);t[2]=0;const i=a.fromValues(0,0,0);t=h.S4.add(t,i);const s=h.w$.translate(o.create(),t),n=this.iconSize;return h.w$.scale(s,[n,n,1]),s}updateIconGraphics(){if(!this.viewer.getResources().constraintAtlas)return;const e=-.5,t=this.icon.id,i=this.viewer.getResources().constraintAtlas.getTextureCoords(t);if(!i)return;const s=(0,n.createQuad)([e,-.5,0],[.5,-.5,0],[e,.5,0],t,[i.lowS,i.highT],[i.highS,i.lowT]);this.updateMeshIncrement(t,"0",s,this.iconNodeProperties)}}},36222:function(e,t,i){i.r(t),i.d(t,{ACTIVE_SHEETMETAL_MODEL_CHANGED:function(){return o.HqE},ACTIVE_VIEWER_SET:function(){return o.zTe},ADD_TEMPORARY_TESSELLATION_OVERRIDES:function(){return o.am2},ASSEMBLY_ANIMATE_MATE_ENDED:function(){return o.V11},ASSEMBLY_ANIMATE_MATE_STARTED:function(){return o.klk},ASSEMBLY_DATA_PROCESSED:function(){return o.hjy},Action:function(){return o.aUM},AnimationCallbackStatus:function(){return o.ZK6},BTGraphicsUsage:function(){return o.LgS},CANVAS_CLICK:function(){return o.pUS},CANVAS_MOUSELEAVE:function(){return o.u5l},CANVAS_MOUSEMOVE:function(){return o.oGi},CHANGE_FEATURE_APPEARANCE:function(){return o.P1w},CHANGE_VIEW:function(){return o.h02},CLEAR_TEMPORARY_TESSELLATION_OVERRIDES:function(){return o.JpA},CLOSE_ANNOTATION_EDIT:function(){return o.i$n},CLOSE_DIMENSION_EDIT:function(){return o.dPN},CLOSE_MATE_DOF_CHOOSER:function(){return o.rwQ},CLOSE_SELECT_OTHER:function(){return o.AD7},CLOSE_SKETCH_SUB_DIALOG:function(){return o.wfd},CREATE_SECTION_PLANE_INFERENCE_CONTROLLER:function(){return o.T$E},CursorAppendage:function(){return a.CursorAppendage},CursorAppendageLeader:function(){return a.CursorAppendageLeader},DEFAULT_PREVIEW_OPACITY:function(){return a.DEFAULT_PREVIEW_OPACITY},DEFAULT_SIMULATION_COLOR_MAPPING:function(){return a.DEFAULT_SIMULATION_COLOR_MAPPING},DEFAULT_UNITS_CHANGED:function(){return o.CrY},DESTROY_SECTION_PLANE_INFERENCE_CONTROLLER:function(){return o.ye3},DEVICE_PIXEL_RATIO_CHANGED:function(){return o.b3},DID_RENDER_THUMBNAILS:function(){return o.Xc0},DIMENSION_DELETE_REQUEST:function(){return o.uav},DIMENSION_EDIT_CLOSED:function(){return o.pKY},DIMENSION_TEXT_DOUBLE_CLICKED:function(){return o.cu9},DIMENSION_TEXT_SINGLE_CLICKED:function(){return o.Q6T},DIMENSION_VALUE_CHANGED:function(){return o.WYs},DISPLAYED_PART_STUDIO:function(){return o.adC},DragTrimLine:function(){return a.DragTrimLine},ELEMENT_GRAPHICS_LOADING:function(){return o.Wp_},ELEMENT_PREVIEW_GRAPHICS_LOADED:function(){return o.Vpt},ELEMENT_VIEW_INITIALIZED:function(){return o.cpE},EntityData:function(){return a.EntityData},ExplodeLine:function(){return a.ExplodeLine},ExplodeLineArcSegment:function(){return a.ExplodeLineArcSegment},ExplodeLineLineSegment:function(){return a.ExplodeLineLineSegment},FrameType:function(){return o.QpP},GL_CONTEXT_LOST:function(){return o.cWC},GL_CONTEXT_RESTORED:function(){return o.pOz},GRAPHICS_HANDLED_CLICK_EVENT:function(){return o.sdI},GraphicsRefinementMode:function(){return o.Rng},HUD_MODEL_SCENEGRAPH_ID:function(){return o.$Ky},HighlightType:function(){return o.o2L},INVALID_ID:function(){return o.JE9},INVALID_OCCURRENCE_ID:function(){return o.Qyk},IdManager:function(){return o.siw},IdSizes:function(){return o._6$},IntersectionType:function(){return o.IiW},IsolatedOccurrencesManager:function(){return a.IsolatedOccurrencesManager},MAIN_SCENEGRAPH_ID:function(){return o.lLv},MAXIMUM_NUMBER_OF_SECTION_PLANES_REACHED:function(){return o.F59},ManipulationMode:function(){return o.kJR},NAMED_VIEW_APPLIED:function(){return o.ziX},NEW_PART_LIST:function(){return o.W2m},NON_TRIVIAL_PART_STUDIO_DATA_PROCESSED:function(){return o.CDm},NamedIdManager:function(){return o.EBu},PART_STUDIO_PART_VISIBILITY_CHANGED:function(){return o.sJs},PREVIOUS_VERSION_CANVAS_SELECTOR:function(){return a.PREVIOUS_VERSION_CANVAS_SELECTOR},REPORT_MEMORY_USAGE:function(){return o.ktd},RETRIEVE_ELEMENT_DISPLAY_DATA:function(){return o.Cgl},RETRIEVE_OCCURRENCE_DISPLAY_DATA:function(){return o.Qeo},RETRIEVE_SMOOTH_EDGE_INFORMATION:function(){return o.Uj6},SECTIONPLANE_SELECTION_ID:function(){return o.s_Y},SECTION_PLANE_ADDED:function(){return o.Srw},SECTION_PLANE_REMOVED:function(){return o.zKA},SECTION_VIEW_DIALOG_CLOSED:function(){return o.KOV},SECTION_VIEW_DIALOG_OPENED:function(){return o.M1t},SELECTION_REJECTED:function(){return o.SzR},SELECT_OTHER:function(){return o.NMw},SELECT_OTHER_REVERSE:function(){return o.aat},SHOW_SKETCH_TEXT:function(){return o._hB},SHOW_SMART_SELECTION:function(){return o.bsB},SKETCH_COMMAND_ACTIVATED:function(){return o.JFj},SPACEMOUSE_COMMANDS_RECEIVED:function(){return o.TN9},Sketch:function(){return a.Sketch},SketchPlaneDisplay:function(){return a.SketchPlaneDisplay},SplineHandle:function(){return a.SplineHandle},StandardViews:function(){return a.StandardViews},TemporarySketchComponent:function(){return a.TemporarySketchComponent},Text:function(){return a.Text},UIElement:function(){return a.UIElement},UISelection:function(){return a.UISelection},UPDATE_INCONTEXT_ISOLATION:function(){return o.bhj},UiEvents:function(){return a.UiEvents},VIEWER_CANVAS_ATTACHED_TO_CONTAINER:function(){return o.tSV},VIEW_CONTAINER_MENU_INVOKED:function(){return o.oLC},VIEW_DID_DRAW:function(){return o.u9p},VIEW_WILL_DRAW:function(){return o.Hvz},View:function(){return a.View},WILL_RENDER_THUMBNAILS:function(){return o.gV9},addStyleToIncrement:function(){return a.addStyleToIncrement},angleBetweenVectors:function(){return a.angleBetweenVectors},are2dPointsEqual:function(){return a.are2dPointsEqual},areAnySectionPlanesSelectedOrPreselected:function(){return a.areAnySectionPlanesSelectedOrPreselected},areMatricesEqual:function(){return a.areMatricesEqual},basicPickSort:function(){return h.G},btTs:function(){return c},cacheCapabilities:function(){return a.cacheCapabilities},clearSavedSectionPlaneParameters:function(){return a.clearSavedSectionPlaneParameters},collectGraphicsDataForHeapDump:function(){return a.collectGraphicsDataForHeapDump},createArcPolyline:function(){return a.createArcPolyline},createCirclePolyline:function(){return a.createCirclePolyline},createDimensionForDisplayData:function(){return a.createDimensionForDisplayData},createInferenceIcon:function(){return a.createInferenceIcon},createPolyline:function(){return a.createPolyline},createTestViewer:function(){return a.createTestViewer},deselectEntities:function(){return a.deselectEntities},disableSectionPlaneSelection:function(){return o.ZBF},displayEntity:function(){return a.displayEntity},distanceSquaredBetweenPoints:function(){return a.distanceSquaredBetweenPoints},distanceSquaredToLineSegment2d:function(){return a.distanceSquaredToLineSegment2d},enableSectionPlaneSelection:function(){return o.G29},estimateTriangleCountAtSettingIndexUsingTriangleCounts:function(){return a.estimateTriangleCountAtSettingIndexUsingTriangleCounts},forEachActiveSectionPlane:function(){return a.forEachActiveSectionPlane},getActiveSectionPlane:function(){return a.getActiveSectionPlane},getActiveSectionViewState:function(){return a.getActiveSectionViewState},getActiveViewer:function(){return o.uQB},getActiveViewerEventDispatcher:function(){return o.xA2},getActiveViewerHasSketch:function(){return a.getActiveViewerHasSketch},getActiveViewerModelViewManagers:function(){return o.IOg},getAngle:function(){return a.getAngle},getColorStringArray:function(){return a.getColorStringArray},getCounters:function(){return a.getCounters},getCurrentSectionPlaneParameters:function(){return a.getCurrentSectionPlaneParameters},getDefaultNameForBody:function(){return a.getDefaultNameForBody},getDisplayedElementObservable:function(){return o.v93},getDrawer:function(){return a.getDrawer},getDrawers:function(){return a.getDrawers},getEditState:function(){return a.getEditState},getFeatureThumbnailKey:function(){return a.getFeatureThumbnailKey},getFocusedViewer:function(){return o.N9r},getHasFeatureQLVFacePatternCapability:function(){return a.getHasFeatureQLVFacePatternCapability},getMaxSectionPlanes:function(){return a.getMaxSectionPlanes},getMostRecentActiveSectionPlaneParameters:function(){return a.getMostRecentActiveSectionPlaneParameters},getMouseSettingsManager:function(){return a.getMouseSettingsManager},getObservableFromActiveViewerForEvent:function(){return o.eRd},getOrCreateViewerSet:function(){return a.getOrCreateViewerSet},getPartStudioThumbnailKey:function(){return a.getPartStudioThumbnailKey},getPartThumbnailKey:function(){return a.getPartThumbnailKey},getPerpendicularBisector2d:function(){return a.getPerpendicularBisector2d},getPlaneIndexToAlignNormalTo:function(){return a.getPlaneIndexToAlignNormalTo},getPointAtAngle:function(){return a.getPointAtAngle},getRendererInfo:function(){return a.getRendererInfo},getSectionPlaneCount:function(){return a.getSectionPlaneCount},getSectionedItemsSize:function(){return a.getSectionedItemsSize},getSerializablePlaneData:function(){return a.getSerializablePlaneData},getSerializableSectionViewData:function(){return a.getSerializableSectionViewData},getThumbnailForKey:function(){return a.getThumbnailForKey},getTimeInMilliseconds:function(){return a.getTimeInMilliseconds},getUnavailableRendererInfo:function(){return a.getUnavailableRendererInfo},getZoomToWindowState:function(){return a.getZoomToWindowState},graphicsTakesSelectionPrecedence:function(){return a.graphicsTakesSelectionPrecedence},idIsValid:function(){return o.rp5},idsEqual:function(){return o.nD6},initializePreviousVersionViewer:function(){return a.initializePreviousVersionViewer},intersectLineSegmentRay:function(){return a.intersectLineSegmentRay},intersectTwoLineSegments2d:function(){return a.intersectTwoLineSegments2d},intersectTwoLines2d:function(){return a.intersectTwoLines2d},isInSectionPlaneMode:function(){return a.isInSectionPlaneMode},isMapEmpty:function(){return a.isMapEmpty},isSectionPlaneModeEnabled:function(){return a.isSectionPlaneModeEnabled},isUsageBase:function(){return a.isUsageBase},isUsageCompare:function(){return a.isUsageCompare},isUsagePreview:function(){return a.isUsagePreview},loadSectionPlanesFromParameters:function(){return a.loadSectionPlanesFromParameters},logMemoryStatistics:function(){return a.logMemoryStatistics},preserveViewersForDocumentId:function(){return a.preserveViewersForDocumentId},projectToLine:function(){return a.projectToLine},removeGraphicsViewers:function(){return a.removeGraphicsViewers},removeSectionPlane:function(){return a.removeSectionPlane},removeSectionPlanes:function(){return a.removeSectionPlanes},requestDraw:function(){return a.requestDraw},resetUsage:function(){return a.resetUsage},setBaseHighlightsEnabled:function(){return a.setBaseHighlightsEnabled},setBoxSelectionEnabled:function(){return a.setBoxSelectionEnabled},setDimensionToolActive:function(){return a.setDimensionToolActive},setForceHideInteriorSelections:function(){return a.setForceHideInteriorSelections},setFromSerializablePlaneData:function(){return a.setFromSerializablePlaneData},setFromSerializableSectionViewData:function(){return a.setFromSerializableSectionViewData},setInteractionEnabled:function(){return a.setInteractionEnabled},setIsInFollowMode:function(){return a.setIsInFollowMode},setIsInSectionPlaneMode:function(){return a.setIsInSectionPlaneMode},setSectionEntitiesEnabled:function(){return a.setSectionEntitiesEnabled},setSectionPlaneOnMateConnector:function(){return a.setSectionPlaneOnMateConnector},setSectionPlaneOnMatrix:function(){return a.setSectionPlaneOnMatrix},setShowDimensionsMode:function(){return a.setShowDimensionsMode},setThumbnailForKey:function(){return a.setThumbnailForKey},setTransparencyTransition:function(){return a.setTransparencyTransition},setViewCubeMenuMgrInstance:function(){return a.setViewCubeMenuMgrInstance},setZoomModeEnabled:function(){return a.setZoomModeEnabled},snapshotScenegraph:function(){return a.snapshotScenegraph},tessellateArc:function(){return a.tessellateArc},timeRendering:function(){return a.timeRendering},toggleZoomModifierEnabled:function(){return a.toggleZoomModifierEnabled},unprojectPlaneToWorld:function(){return a.unprojectPlaneToWorld},unprojectVectorToWorld:function(){return a.unprojectVectorToWorld},userWebPreferencesGetManager:function(){return o.tYI},viewerCheck:function(){return o.Ykz}});var s,n=i(8339),r=i(88155),a=i(94205);!function(e){!function(e){e.camera=a,e.frametimer=a,e.math=a,e.editstate=a,e.debugTools=a,e.eventdispatcher=a,e.utilities=(0,n.Z)({},a,{RetinaDisplayMode:a.RetinaDisplayMode},{pixelscaling:a}),e.viewcontroller=a,e.measurementdisplay=a,e.sectionplane=a,e.statistics=a,e.sketchdisplaydata=a,e.imagedisplay=a,e.sketchcomponent=a,e.splinehandle=a,e.zoomToWindowState=a,e.dimensions=a,e.coordinatesysteminference=a,e.triad=a,e.mateconnector=a,e.animationcontroller=a,e.occurrence=a,e.manipulators=a,e.idmanager=a,e.inferencepicker=a,e.mateindicator=a,e.viewerset=a,e.viewmanipulator=a,e.axes=a,e.inputhandler=a}(e.graphics||(e.graphics={}))}(s||(s={})),function(e){!function(e){!function(e){e.getActiveViewer=r.uQ,e.viewerCheck=r.Yk,e.getFocusedViewer=a.getFocusedViewer,e.getActiveViewerModelViewManagers=r.IO,e.retrieveViewportAsImage=a.retrieveViewportAsImage,e.getActiveViewerOccurrenceDataManager=a.getActiveViewerOccurrenceDataManager}(e.viewer||(e.viewer={}))}(e.graphics||(e.graphics={}))}(s||(s={})),function(e){!function(e){!function(e){e.setRefinementMode=a.setRefinementMode,e.RefinementMode=a.RefinementMode}(e.bodymanager||(e.bodymanager={}))}(e.graphics||(e.graphics={}))}(s||(s={})),function(e){!function(e){!function(e){e.View=a.View}(e.sketchinformation||(e.sketchinformation={}))}(e.graphics||(e.graphics={}))}(s||(s={})),function(e){!function(e){!function(e){e.PrimitiveType=a.PrimitiveType}(e.meshattr||(e.meshattr={}))}(e.graphics||(e.graphics={}))}(s||(s={})),function(e){!function(e){!function(e){e.EdgePoint=a.EdgePoint}(e.edgepoint||(e.edgepoint={}))}(e.graphics||(e.graphics={}))}(s||(s={})),function(e){!function(e){!function(e){e.Manager=a.DetailManager}(e.detail||(e.detail={}))}(e.graphics||(e.graphics={}))}(s||(s={})),function(e){!function(e){!function(e){e.visualizePicks=a.visualizePicks}(e.debug||(e.debug={}))}(e.graphics||(e.graphics={}))}(s||(s={}));var o=i(4087),h=i(74029);const c=(0,n.Z)({},s)},94205:function(e,t,i){i.r(t),i.d(t,{ACTIVE_SHEETMETAL_MODEL_CHANGED:function(){return nM.Hq},ACTIVE_VIEWER_SET:function(){return nM.zT},ADD_TEMPORARY_TESSELLATION_OVERRIDES:function(){return nM.am},AFTER_MARKUP_IMAGE_GENERATION:function(){return nM.nh},ANALYSIS_MENU_INVOKED:function(){return nM.CJ},ANNOTATION_BASE_ELEMENT_ID:function(){return qd.n7},ANNOTATION_BASE_SELECTION_ID:function(){return qd.YQ},ANNOTATION_DETAIL_CELL_ELEMENT_ID:function(){return qd.sr},ANNOTATION_DETAIL_CELL_SELECTION_ID:function(){return qd.dG},ANNOTATION_DETAIL_ELEMENT_ID:function(){return qd._i},ANNOTATION_DETAIL_SELECTION_ID:function(){return qd.JT},ANNOTATION_DRAG_COMPLETE:function(){return nM.og},ANNOTATION_DRAG_LEADER_COMPLETE:function(){return nM.nu},ANNOTATION_GTOL_DETAIL_ELEMENT_ID:function(){return qd.TN},ANNOTATION_GTOL_DETAIL_SELECTION_ID:function(){return qd.U2},ANNOTATION_ISO_LEADER_ELEMENT_ID:function(){return qd.bU},ANNOTATION_ISO_LEADER_SELECTION_ID:function(){return qd.Nq},ANNOTATION_LEADER_ELEMENT_ID:function(){return qd.u5},ANNOTATION_LEADER_SELECTION_ID:function(){return qd.Lc},ANNOTATION_WELD_DETAIL_ELEMENT_ID:function(){return qd.xH},ANNOTATION_WELD_DETAIL_SELECTION_ID:function(){return qd.PF},ANNOTATION_WELD_EXTENDED_LEADER_ELEMENT_ID:function(){return qd.Q8},ANNOTATION_WELD_EXTENDED_LEADER_SELECTION_ID:function(){return qd.kQ},ASSEMBLY_ANIMATE_MATE_ENDED:function(){return nM.V1},ASSEMBLY_ANIMATE_MATE_STARTED:function(){return nM.kl},ASSEMBLY_DATA_PROCESSED:function(){return nM.hj},ASSEMBLY_PREFIX:function(){return NE},ASSEMBLY_TIMES:function(){return nM.uv},ATTRIBUTES:function(){return vT},ATTRIBUTE_LAYOUT:function(){return _T},AXES_ID:function(){return ji},Action:function(){return Cn.aU},ActionIds:function(){return ts},ActionSetController:function(){return is},AngleDisplay:function(){return KM},Angular:function(){return Ur},AngularDimension:function(){return EA.$},AngularFeatureManipulator:function(){return Wl.EH},AngularToolPreview:function(){return $s},AngularWithArrow:function(){return kr},AnimationController:function(){return OC},AnnotationComponent:function(){return Rd},AnnotationDisplay:function(){return Bd},AnnotationDisplayDatum:function(){return Vd},AnnotationDisplayGTol:function(){return Ud},AnnotationDisplayHoleCallout:function(){return Hd},AnnotationDisplayWeld:function(){return Gd},AnnotationTextDisplay:function(){return Zd},Arc:function(){return pA.wN},ArcLengthDimension:function(){return SA},Arrow:function(){return fd},Assembly:function(){return Ig},AssemblyEnabledPartStudioComponent:function(){return Kg},AssemblyIsolateManager:function(){return KC},AssemblyIsolateManagerBase:function(){return YC},AssemblyMakeTransparentManager:function(){return jC},AssignIdGLContext:function(){return xC},AtlasTexture:function(){return Ms.KL},Attribute:function(){return AS},AttributeBinding:function(){return AI},AttributeNames:function(){return PS},AttributeProperties:function(){return OS},Attributes:function(){return RS},Axes:function(){return Ji},AxisLabel:function(){return $i},BEFORE_MARKUP_IMAGE_GENERATION:function(){return nM.m2},BODIES_LOADED:function(){return nM.LA},BODY_MANAGER_NONISOLATED_INCREMENT_GROUP_ID:function(){return Qc},BODY_MANAGER_OPAQUE_INCREMENT_GROUP_ID:function(){return Kc},BODY_MANAGER_TRANSPARENT_INCREMENT_GROUP_ID:function(){return jc},BOUNDING_BOX_MESH_INCREMENT_NAME:function(){return MC},BOX_SELECTION_FINISHED:function(){return nM.KB},BTGraphicsUsage:function(){return ys.L},BackFaceSilhouettePass:function(){return Ft},BackFaceStencilPass:function(){return xt},Ball:function(){return zp},Base:function(){return md},BezierDegreeDimension:function(){return TA},BitShiftId:function(){return Oi},BlendFilter:function(){return n},BlendMode:function(){return u},BlitBlendMode:function(){return p},BlitBufferedPass:function(){return E},BlitFramebufferPass:function(){return S},BlitPass:function(){return I},BodyCheckCustomPass:function(){return It},BodyCheckPass:function(){return Et},BodyComponent:function(){return _m},BodyComponentId:function(){return om},BodyLoadTasks:function(){return Cl},BodyLoader:function(){return Dl},BodyManager:function(){return ml},BodyMetaData:function(){return xh.XH},BodyOccurrence:function(){return ul},BodyToProcess:function(){return Tl},BooleanIterator:function(){return sT.Y},BoundingBox:function(){return wi.kB},BoundingBox2D:function(){return wi.tO},BoundingSpot:function(){return wi.iK},BoxSelector:function(){return mn},BrowserRefreshRate:function(){return GI},Budget:function(){return RC},Buffer:function(){return OT},BufferAllocationPolicy:function(){return AE},BufferMemoryMetrics:function(){return sD},BufferSet:function(){return zT},BufferSetBase:function(){return NT},BufferedPass:function(){return T},CANVAS_CLICK:function(){return nM.pU},CANVAS_MOUSEENTER:function(){return nM.ox},CANVAS_MOUSELEAVE:function(){return nM.u5},CANVAS_MOUSEMOVE:function(){return nM.oG},CHANGE_FEATURE_APPEARANCE:function(){return nM.P1},CHANGE_VIEW:function(){return nM.h0},CLEAR_TEMPORARY_TESSELLATION_OVERRIDES:function(){return nM.Jp},CLOSE_ANNOTATION_EDIT:function(){return nM.i$},CLOSE_DIMENSION_EDIT:function(){return nM.dP},CLOSE_MATE_DOF_CHOOSER:function(){return nM.rw},CLOSE_SELECT_OTHER:function(){return nM.AD},CLOSE_SKETCH_SUB_DIALOG:function(){return nM.wf},COLLECTION_ID_PREFIX:function(){return XE.Q},COLOR_MAP_TESSELLATION_SETTING_INDEX:function(){return bc},CONSTANTS:function(){return mg},CREATE_SECTION_PLANE_INFERENCE_CONTROLLER:function(){return nM.T$},CURVATURE_ANALYSIS_COLOR_MAPPING_CHANGED:function(){return nM.iH},CURVATURE_ANALYSIS_CURVATURE_CONTROL_CHANGED:function(){return nM.gW},CURVATURE_ANALYSIS_LEGEND_CLOSED:function(){return nM.Nw},CURVATURE_ANALYSIS_LEGEND_MAXIMUM_CLICKED:function(){return nM.fd},CURVATURE_ANALYSIS_LEGEND_MINIMUM_CLICKED:function(){return nM.ib},CURVATURE_ANALYSIS_LEGEND_OPENED:function(){return nM.A1},CURVATURE_ANALYSIS_RANGE_CHANGED:function(){return nM.JH},CURVATURE_VISUALIZATION_MANAGER_NODE_ID:function(){return Nc},CachedOccurrenceState:function(){return fg},CalculateOcclusionPass:function(){return Ie},CallCountingGLContext:function(){return FC},Camera:function(){return Ph},CanvasTextureDefinition:function(){return yo},CenterOfMassIndicator:function(){return Rg},CenterlineDimension:function(){return DA},ChainedOperator:function(){return jr},ClippingPlaneNames:function(){return cr},CombDisplay:function(){return jM},CombinedPickPass:function(){return we},CommentIndicator:function(){return Og},CompareBlendPass:function(){return Ye},ComponentNames:function(){return hA.vn},ConnectionVisualizationManager:function(){return Gh},ConstituentType:function(){return xh.po},ConstructionPlaneDisplay:function(){return cy},ControlPointGridDisplay:function(){return Qm},CosmeticThreadComponent:function(){return wg},CosmeticThreadGeometryHandler:function(){return vg},CountDimension:function(){return CA},CounterNames:function(){return Ln.kW},Counters:function(){return Ln.xv},CullFace:function(){return bh},CullingState:function(){return Xs.uc},Cursor:function(){return kn.C},CursorAppendage:function(){return as},CursorAppendageLeader:function(){return hs},CurvatureAnalysisLegend:function(){return Ac},CurvatureAnalysisManager:function(){return Lc},CurvatureAnalysisScenegraphManager:function(){return Bc},CurveLengthDimension:function(){return MA},CustomPass:function(){return ie},CustomSwitchPass:function(){return lA},Cylindrical:function(){return kp},DEFAULT_MATERIAL:function(){return Ui},DEFAULT_OPTIONS:function(){return Po},DEFAULT_PERSPECTIVE_FOV:function(){return Oh},DEFAULT_PREVIEW_OPACITY:function(){return _s},DEFAULT_SIMULATION_COLOR_MAPPING:function(){return Vf},DEFAULT_UNITS_CHANGED:function(){return nM.Cr},DEPTH_PASS_CLEAR_COLOR:function(){return Xs.XD},DESTROY_SECTION_PLANE_INFERENCE_CONTROLLER:function(){return nM.ye},DEVICE_PIXEL_RATIO_CHANGED:function(){return nM.b3},DID_RENDER_THUMBNAILS:function(){return nM.Xc},DIMENSION_ATLAS:function(){return QM.Xh},DIMENSION_DELETE_REQUEST:function(){return nM.u},DIMENSION_DESELECTED:function(){return nM.Ut},DIMENSION_EDIT_CLOSED:function(){return nM.pK},DIMENSION_SELECTED:function(){return nM.vc},DIMENSION_TEXT_DOUBLE_CLICKED:function(){return nM.cu},DIMENSION_TEXT_DRAG_ENDED:function(){return nM.s4},DIMENSION_TEXT_SINGLE_CLICKED:function(){return nM.Q6},DIMENSION_VALUE_CHANGED:function(){return nM.WY},DIRECTION:function(){return C},DISPLAYED_ASSEMBLY:function(){return nM.t0},DISPLAYED_PART_STUDIO:function(){return nM.ad},DataManager:function(){return Nh},DebugPickPass:function(){return ht},Decal:function(){return xg},DecalComponent:function(){return Bg},DefaultPassUsage:function(){return be},DefaultPasses:function(){return Le},DepthClearPass:function(){return V},DepthRetrievalPass:function(){return Ze},DepthSamplingPass:function(){return ce},DepthTestMode:function(){return g},DetailManager:function(){return pa},DihedralCombDisplay:function(){return Ff},DihedralExtremaDisplay:function(){return Bf},Dimension:function(){return pA.Ro},DimensionComponent:function(){return Wg},DimensionConstants:function(){return rA},DimensionPreferences:function(){return os.FZj},DirectionalScreenFacingSpaceQuadGlyphComponent:function(){return hd},Display:function(){return SE},DisplayElement:function(){return qd.yH},DisplayElementBase:function(){return jd},DisplayElementBaseDatum:function(){return Qd},DisplayElementBaseGTol:function(){return $d},DisplayElementBaseHoleCallout:function(){return Jd},DisplayElementBaseWeld:function(){return eu},DisplayElementDetail:function(){return tu},DisplayElementDetailDatum:function(){return iu},DisplayElementDetailGTol:function(){return ru},DisplayElementDetailGTolCell:function(){return au},DisplayElementDetailGTolCellIcon:function(){return ou},DisplayElementDetailGTolCellText:function(){return hu},DisplayElementDetailHoleCallout:function(){return xu},DisplayElementDetailWeld:function(){return tg},DisplayElementLeader:function(){return sg},DisplayElementLeaderDatum:function(){return ng},DisplayElementLeaderGTol:function(){return rg},DisplayElementLeaderHoleCallout:function(){return ag},DisplayElementLeaderWeld:function(){return og},DistanceDisplay:function(){return YM},DoubleClickHandler:function(){return zE},DraftAnalysisDrawPass:function(){return Pt},DraftAnalysisShadowTestPass:function(){return yt},DraftAnalysisShadowTestPasses:function(){return At},DraftAngleRetrievalPass:function(){return dt},DragTrimLine:function(){return En},DrawPass:function(){return f},DrawPassVisibility:function(){return o},DropdownButton:function(){return pC},ELEMENT_GRAPHICS_LOADING:function(){return nM.Wp},ELEMENT_PREVIEW_GRAPHICS_LOADED:function(){return nM.Vp},ELEMENT_PREVIEW_NODE_ID:function(){return Ul},ELEMENT_VIEW_INITIALIZED:function(){return nM.cp},ELLIPSIS_ID:function(){return Ms.WD},EMPTY_HIGHLIGHT_STYLE:function(){return mT},EVENT_NEEDS_ANGULAR_BROADCAST:function(){return nM.pF},EXCELLENT_GPU_RESULTS:function(){return BI},EdgeAndHiddenEdgePass:function(){return K},EdgeCurvatureDisplay:function(){return Cf},EdgeDetectAndBlurPass:function(){return _},EdgeDetectBufferPass:function(){return w},EdgeDetectPass:function(){return O},EdgePoint:function(){return lg},EdgePointController:function(){return Ci},Element:function(){return dg},ElementLoadState:function(){return yD},ElementPreviewManager:function(){return Hl},EllipseDiameterDimension:function(){return yA},EntityData:function(){return $a},ErrorComponent:function(){return Nm},EventDispatcher:function(){return nM.pB},Events:function(){return vs},ExplodeLine:function(){return eA},ExplodeLineArcSegment:function(){return iA},ExplodeLineLineSegment:function(){return nA},ExpressionType:function(){return pA.t_},FALSE_INT_UNIFORM:function(){return II},FIRST_ID:function(){return Mi.lm},FOLLOW_MODE_DEACTIVATED:function(){return nM.Gf},FOLLOW_MODE_LEADER_MOUSE_MOVED:function(){return nM.Aw},FOLLOW_MODE_LEADER_MOUSE_OUT:function(){return nM.Nf},FaceAllHighlightsDrawPass:function(){return re},FaceEdgePointPass:function(){return H},FaceHighlightBufferPass:function(){return Rt},FaceHighlightMaskPass:function(){return wt},FaceSingleHighlightDrawPass:function(){return St},FacesShadeMode:function(){return h},Factory:function(){return QM.Fk},Fastened:function(){return Bp},FeatureManipulator:function(){return Wl.XX},FilterCandidate:function(){return lI.zp},FilterEdgePointCandidate:function(){return lI.G9},FilterOcclusionPass:function(){return Ee},FilterVertexCandidate:function(){return lI.SG},FilteredEntitiesHighlightController:function(){return Iy},Fixed:function(){return Sd},FixedMateIndicator:function(){return qp},Flip:function(){return Wl.BW},FormattedValueOptions:function(){return xd},FrameBuffer:function(){return ih},FrameTimer:function(){return eh},FreeDrag:function(){return Wr},FullTriadFeatureManipulator:function(){return Wl.QV},GLContext:function(){return LC},GLYPH_SELECTION_ID:function(){return nd},GL_CONTEXT_LOST:function(){return nM.cW},GL_CONTEXT_RESTORED:function(){return nM.pO},GRAPHICS_HANDLED_CLICK_EVENT:function(){return nM.sd},Gauge:function(){return kI},GenerativeDesignManager:function(){return cI},GeometryMate:function(){return Ed},GhostParentPass:function(){return ot},GlDataType:function(){return Ht},GlPixelFormat:function(){return Xt},GlRenderBufferType:function(){return zt},GlyphComponent:function(){return rd},GlyphHighlightStates:function(){return td},GlyphResources:function(){return sd},GlyphStateTextureSuffixes:function(){return ed},GlyphStates:function(){return Jl},GraphicsRefinementMode:function(){return os.Rng},GraphicsWebAssemblyUtils:function(){return uI},GroupRanges:function(){return ZT},HIGHLIGHTED_LINE_PROPERTIES:function(){return Ol},HIGHLIGHTED_TRIANGLE_PROPERTIES:function(){return _l},HOLE_CALLOUT_DRAG_ENDED:function(){return nM.Rq},HUD_MODEL_SCENEGRAPH_ID:function(){return uh.$K},HUD_SCENEGRAPH_ID:function(){return uh.EG},Highlight:function(){return An},HighlightFlag:function(){return yn},HighlightManager:function(){return vn},HighlightPriority:function(){return Mn},HighlightType:function(){return Cn.o2},HudModelPass:function(){return N},HudPass:function(){return b},IDENTITY_MATRIX:function(){return wi.Ad},INFERENCE_LINE_PROPERTIES:function(){return Pl},INFERENCE_PICKER_SCENEGRAPH_ID:function(){return uh.Jh},INFERENCE_TRIANGLE_PROPERTIES:function(){return wl},INFINITE_CURVATURE_CUTOFF:function(){return _c},INVALID_FRAME_ID:function(){return sS},INVALID_ID:function(){return Mi.JE},INVALID_ID_ELEMENT:function(){return Mi.vN},INVALID_NUMBER_ID:function(){return Mi.c2},INVALID_OCCURRENCE_ID:function(){return TE.Qy},IconBorderState:function(){return Ms.Te},IconData:function(){return Ms.b2},IconSelectionType:function(){return os.UKE},IdManager:function(){return Mi.si},IdMasks:function(){return Mi.U2},IdSizes:function(){return Mi._6},ImageComponent:function(){return kl},ImageData:function(){return Zl},ImageDisplay:function(){return jn},IncrementDetails:function(){return HT},IncrementId:function(){return bl},IncrementRanges:function(){return qT},InferenceData:function(){return os.Wfq},InferenceDisplay:function(){return tp},InferenceDisplayWithoutHover:function(){return ip},InferencePickPass:function(){return ve},InferencePicker:function(){return DC},InputHandler:function(){return Cs},InsertableIncrementType:function(){return qg},InteractionTypes:function(){return Jo},InterferenceDisplay:function(){return yC},IntersectIterator:function(){return nT},IntersectOperator:function(){return rT},IntersectionType:function(){return lr.I},IsolateContextPass:function(){return at},IsolateFlag:function(){return tM},IsolatedManagerBase:function(){return WC},IsolatedManagersUtils:function(){return eM},IsolatedOccurrencesManager:function(){return sM},KnotPointDisplay:function(){return tf},LARGEST_REPRESENTABLE_INTEGER:function(){return wi.s9},LINE_PROPERTIES:function(){return Al},LOADED_TESSELLATION_SETTING:function(){return ol},LineDisplay:function(){return an},LinePointAllHighlightsDrawPass:function(){return oe},LinePointSingleHighlightDrawPass:function(){return ae},Linear:function(){return Lr},Linear1d:function(){return Wl.ol},LinearDimension:function(){return mA},LinearDisplacement:function(){return Br},LinearToolPreview:function(){return en},Listener:function(){return lh},LoadTextures:function(){return up},Lod:function(){return wS},MAIN_SCENEGRAPH_ID:function(){return uh.lL},MANIPULATOR_BUTTONS_ID:function(){return aC},MANIPULATOR_ID:function(){return rC},MATE_INDICATOR_ATLAS:function(){return QM.Bm},MAXIMUM_NUMBER_OF_SECTION_PLANES_REACHED:function(){return nM.F5},MAX_COLLAPSED_ICONS:function(){return Ms.eL},MBD_ATLAS:function(){return QM.di},MEDIUM_INTERACTIVE_BUDGET:function(){return vC},MESH_EDGE_NODE_PROPERTIES:function(){return pm},MINIMUM_REFRESH_RATE_FPS:function(){return HI},MODEL_MESH_MANAGER_SETTINGS:function(){return FE},MainDrawPass:function(){return Ot},Manager:function(){return Sn.d},ManipulationMode:function(){return aA.k},Manipulator:function(){return br},MateConnector:function(){return xl},MateConnectorComponent:function(){return Fp},MateGroup:function(){return Id},MateGroupMateIndicator:function(){return Xp},MateIndicator:function(){return xp},MateIndicatorComponent:function(){return pd},Material:function(){return Bi},MemoryGauge:function(){return zI},Mesh:function(){return OE},MeshIncrement:function(){return eT},MeshManager:function(){return eD},MeshPointController:function(){return Zn},ModelStatistics:function(){return sm},ModelViewManager:function(){return Ch},ModelViewManagers:function(){return Mh},MouseButton:function(){return os.tcH},MouseEvents:function(){return WE},NAMED_VIEW_APPLIED:function(){return nM.zi},NEW_PART_LIST:function(){return nM.W2},NON_TRIVIAL_PART_STUDIO_DATA_PROCESSED:function(){return nM.CD},NO_ID:function(){return TE.QC},NO_RANGE_OPERATOR:function(){return CS},NO_RETRIEVAL_SENT_FOR_OCCURRENCE:function(){return il},NO_SECTION_SHADER_ID_SUFFIX:function(){return SI},NO_SELECTION_ID:function(){return yi.ZJ},NUMBER_INTEGER_BITS:function(){return wi.tl},NamedIdManager:function(){return DE.E},NoRangeOperator:function(){return DS},Node:function(){return Gi.NB},NodeOccurrence:function(){return wT},NodeProperties:function(){return Gi.hF},NodePropertiesTypes:function(){return bn},NonInstantiatedBody:function(){return hl},NormalDepthFilter:function(){return fe},NormalDepthPass:function(){return F},NormalDepthWithMaskPass:function(){return G},NumberIdManager:function(){return Mi.s},OCCURRENCE_SOURCE:function(){return bE},OFFSET_DIRECTION_PIXEL_TOLERANCE:function(){return Ms.wm},OITBufferPass:function(){return qe},OITColorPass:function(){return L},OITComponent:function(){return r},OITCompositePass:function(){return Ue},OS_TO_Y_UP:function(){return qy},OccurrenceData:function(){return $r},OccurrenceHighlights:function(){return fT},OccurrenceIdManager:function(){return TE.yx},OccurrenceRetrievalRequest:function(){return $c},Opacity:function(){return a},OriginAxesIndex:function(){return hA.tF},OriginElement:function(){return Xc},OrthographicCamera:function(){return wh},OrthographicController:function(){return hr},OutlineMeshId:function(){return hy},PART_STUDIO_DATA_AND_SELECTION_REMAP_PROCESSED:function(){return nM.cy},PART_STUDIO_ELEMENT_ID:function(){return TE.KF},PART_STUDIO_OCCURRENCE_ID:function(){return LE},PART_STUDIO_PART_VISIBILITY_CHANGED:function(){return nM.sJ},PART_STUDIO_PREFIX:function(){return _E},PART_STUDIO_TIMES:function(){return nM.$_},PICKS_BOX_SELECTED:function(){return nM.f4},PICK_CLEAR_COLOR:function(){return Xs.o0},PICK_CONSTRAINT_SELECTED:function(){return nM.Mp},PREVIEW_SCENEGRAPH_ID:function(){return uh.Vv},PREVIOUS_VERSION_CANVAS_SELECTOR:function(){return LM.TC},PRIMITIVE_TYPE_BITS:function(){return Ai.ip},Parallel:function(){return Hp},PartComparePass:function(){return ze},PartPreviewPass:function(){return Ke},PartStudio:function(){return kg},PartStudioBlendPass:function(){return W},PartStudioComponent:function(){return Yg},PartStudioIsolateManager:function(){return $C},PartStudioIsolateManagerBase:function(){return QC},PartStudioMakeTransparentManager:function(){return JC},PartStudioScalarVisualizationLegend:function(){return Mc},PartStudioScalarVisualizationManager:function(){return yc},PerspectiveCamera:function(){return Rh},PerspectiveController:function(){return or},Pick:function(){return gI.D},PickAlternates:function(){return Xe},PickPass:function(){return Pe},PickPriority:function(){return gI.z},PinSlot:function(){return Wp},Planar:function(){return Vr},PlanarMateIndicator:function(){return Up},PlaneComponent:function(){return $g},PlaneComponentId:function(){return jg},PlaneIdPass:function(){return Tt},PlaneMeshId:function(){return oy},PlaneProperties:function(){return ry},PointBodyComponent:function(){return em},PointDimension:function(){return fA},PointElement:function(){return Cd},PointSelection:function(){return qr},PointsFeatureManipulator:function(){return Wl.QQ},PolarDimension:function(){return IA},PreviewBlendPass:function(){return le},Primitive:function(){return s},PrimitiveType:function(){return Ai.MX},Quad:function(){return AC},QualityVisualizationPass:function(){return ne},REFRESH_RATE_MEASURE_SAMPLE_START_TIME_MS:function(){return VI},REFRESH_RATE_MEASURE_TIME_MS:function(){return UI},REPORT_MEMORY_USAGE:function(){return nM.kt},RETRIEVE_ELEMENT_DISPLAY_DATA:function(){return nM.Cg},RETRIEVE_OCCURRENCE_DISPLAY_DATA:function(){return nM.Qe},RETRIEVE_SMOOTH_EDGE_INFORMATION:function(){return nM.Uj},ROOT_ELEMENT_NODE_ID:function(){return RE},ROOT_ELEMENT_PREVIEW_NODE_ID:function(){return wE},RadialDimension:function(){return AA},RadialDistanceDimension:function(){return PA},RangeSetIterator:function(){return tT.I},Ranges:function(){return iT},Ray:function(){return wi.zH},RayVisualization:function(){return wI},ReferenceHighlights:function(){return wn},RefinementMode:function(){return Jc},RenderContext:function(){return oS},RenderOrderPriority:function(){return Gi.DO},ResizeManipulator:function(){return fy},ResizeManipulatorIds:function(){return ny},ResourceManager:function(){return fE},Resources:function(){return Hn},Results:function(){return xI},RetinaDisplayMode:function(){return Fh.oA},RetrievalRequestSource:function(){return sl},Revolute:function(){return Vp},RhoDimension:function(){return OA},RotationComponentToAxesIndexMap:function(){return Kr.L},RotationPrecision:function(){return kn.V},SCALAR_VISUALIZATION_FACE_SOLID_NODE_PROPERTIES:function(){return lm},SCALAR_VISUALIZATION_FACE_SURFACE_NODE_PROPERTIES:function(){return dm},SECTION_PLANE_ADDED:function(){return nM.Sr},SECTION_PLANE_REMOVED:function(){return nM.zK},SECTION_VIEW_DIALOG_CLOSED:function(){return nM.KO},SECTION_VIEW_DIALOG_OPENED:function(){return nM.M1},SELECTION_ID:function(){return cn},SELECTION_REJECTED:function(){return nM.Sz},SELECT_OTHER:function(){return nM.NM},SELECT_OTHER_REVERSE:function(){return nM.a},SESSION_ENDED:function(){return nM.so},SHEET_FACE_NODE_PROPERTIES:function(){return Em},SHEET_FACE_NODE_PROPERTIES_TRANSPARENT:function(){return Sm},SHOW_DIMENSION_EXPRESSIONS_CHANGED:function(){return nM.yB},SHOW_SKETCH_TEXT:function(){return nM._h},SHOW_SMART_SELECTION:function(){return nM.bs},SIMULATION_CONNECTIONS_DISPLAYED:function(){return nM.GO},SIMULATION_LEGEND_CANVAS_CONTROLS_PANEL_ID:function(){return Uf},SIMULATION_LEGEND_CLOSED:function(){return nM.Ip},SIMULATION_LEGEND_OPENED:function(){return nM.PX},SIMULATION_MAXIMUM_CLICKED:function(){return nM.Jm},SIMULATION_MINIMUM_CLICKED:function(){return nM.xy},SIMULATION_RANGE_CHANGED:function(){return nM.pj},SIMULATION_RESULTS_DISPLAYED:function(){return nM.R1},SKETCH_COMMAND_ACTIVATED:function(){return nM.JF},SKETCH_CONSTRAINT_TEXTURE_ATLAS:function(){return QM.GH},SMALL_INTERACTIVE_BUDGET:function(){return wC},SOLID_FACE_NODE_PROPERTIES:function(){return fm},SOLID_FACE_NODE_PROPERTIES_TRANSPARENT:function(){return Im},SPACEMOUSE_ACTION_SET_CHANGED:function(){return nM.Fc},SPACEMOUSE_COMMAND:function(){return nM.RV},SPACEMOUSE_COMMANDS_RECEIVED:function(){return nM.TN},SVG_TOKENS_FOR_STYLE:function(){return Kl},ScalarRetrievalPass:function(){return _t},ScalarVisualizationLegend:function(){return Ec},ScalarVisualizationManager:function(){return Dc},ScalingManipulator:function(){return Yr},SceneGraph:function(){return gh},SceneGraphs:function(){return ph},ScreenFacingSpaceQuadGlyphComponent:function(){return od},ScreenOccupancyMap:function(){return Li},ScreenSpaceData:function(){return os.vjd},ScreenSpaceQuadGlyphComponent:function(){return ad},SectionPlane:function(){return Fa.O},SectionPlaneEndcapDrawPass:function(){return A},SectionPlaneEndcapDrawPasses:function(){return P},SectionPlaneEndcapMaskDrawPass:function(){return ut},SectionPlaneEndcapMaskPass:function(){return Be},SectionViewState:function(){return lD.aA},SectionedItemType:function(){return lD.oj},SelectionIds:function(){return WD},SeparatedGaussianFilterBufferPass:function(){return v},SeparatedGaussianFilterPass:function(){return R},Settings:function(){return ga},ShaderProgram:function(){return OI},Silhouette:function(){return ME},SilhouettePass:function(){return Bt},SilhouetteTask:function(){return pE},SimulationLegend:function(){return Hf},SimulationLoadDisplay:function(){return wp},SimulationLoadDisplayGroup:function(){return _p},SimulationLoadDisplayManager:function(){return Np},SimulationLoadGlyphResources:function(){return bp},SimulationManager:function(){return zf},Sketch:function(){return ds},SketchComponent:function(){return Um},SketchComponentId:function(){return Vm},SketchPlaneDisplay:function(){return SC},SkipProgramsGLContext:function(){return BC},Slider:function(){return Gp},SnapIndicator:function(){return rp},SpaceballConnection:function(){return ka},SplineHandle:function(){return Gc},StandardViews:function(){return sr},State:function(){return ui},StateCachingGLContext:function(){return HC},StateRepeatingGLContext:function(){return VC},StencilMode:function(){return c},StencilRefMask:function(){return d},StencilRefValue:function(){return l},Style:function(){return mS.bg},StyleMergeIterator:function(){return fS.q},StyleModificationOperator:function(){return hT},StyleModifierIterator:function(){return oT},StyleOverwriteIterator:function(){return cT},StyleOverwriteOperator:function(){return lT},StyleResetIterator:function(){return IS},StyleResetOperator:function(){return ES},StyleUnionIterator:function(){return ET},StyleUnionOperator:function(){return ST},StyledMeshRanges:function(){return TS},SubtractIterator:function(){return XT},SubtractMeshRanges:function(){return KT},SubtractOperator:function(){return tD},SwitchPass:function(){return cA},TEMPORARY_SKETCH_COMPONENT_NODE_ID:function(){return vE},THICKNESS_ANALYSIS_COLOR_MAPPING_CHANGED:function(){return nM.d},THICKNESS_ANALYSIS_DISPLAYED_FIELD_CHANGED:function(){return nM.vu},THICKNESS_ANALYSIS_LEGEND_CLOSED:function(){return nM.aI},THICKNESS_ANALYSIS_LEGEND_OPENED:function(){return nM.Cv},THICKNESS_ANALYSIS_MAXIMUM_CLICKED:function(){return nM.vk},THICKNESS_ANALYSIS_MINIMUM_CLICKED:function(){return nM.YW},THICKNESS_ANALYSIS_RANGE_CHANGED:function(){return nM.WB},TINT_TEST_TYPE:function(){return De},TOOL_EDGE_PROPERTIES:function(){return Ys},TOOL_FACE_PROPERTIES:function(){return qs},TRANSLUCENT_MESH_EDGE_NODE_PROPERTIES:function(){return mm},TRIANGLE_PROPERTIES:function(){return vl},TRUE_INT_UNIFORM:function(){return fI},Tangent:function(){return Zp},TaskManager:function(){return _C},TemporarySketchComponent:function(){return Gm},Text:function(){return xa},Text2D:function(){return Ba},TextTexture:function(){return Ao},Texture:function(){return Io},TextureAtlas:function(){return ql},TextureDefinition:function(){return mo},ThicknessAnalysisManager:function(){return eI},TimingDetails:function(){return $o},TintedPass:function(){return Ce},TogglePointsFeatureManipulator:function(){return Wl.gm},TolerantDimensionLayout:function(){return gA},ToolDisplay:function(){return Ks},TrackedGraphicsComponents:function(){return _M},TranslucentPass:function(){return Ve},TransparencySwitchPass:function(){return dA},TransparentFaceDepth:function(){return Vt},Triad:function(){return Kr._},TriadFeatureManipulator:function(){return Wl.rY},UIElement:function(){return yi.u1},UISelection:function(){return Lh.i},UISelectionManager:function(){return Lh.z},UI_ELEMENT_CLICK:function(){return nM.fu},UNKNOWN_DEPTH:function(){return Xs.BG},UNLIT_COLOR_FROM_ATTRIBUTE:function(){return Vi},UNLOADED_BODY_OPACITY_FACTOR:function(){return nl},UPDATE_INCONTEXT_ISOLATION:function(){return nM.bh},UiEvents:function(){return yi.zw},UniformAttribRepeatingGLContext:function(){return UC},VIEWER_CANVAS_ATTACHED_TO_CONTAINER:function(){return nM.tS},VIEW_CONTAINER_MENU_INVOKED:function(){return nM.oL},VIEW_DID_DRAW:function(){return nM.u9},VIEW_MANIPULATOR_EVENT:function(){return HD},VIEW_WILL_DRAW:function(){return nM.Hv},VIEW_WILL_PICK:function(){return nM.b9},View:function(){return Ms.G7},ViewController:function(){return ar},ViewFrustum:function(){return ur},ViewManipulator:function(){return mC},ViewManipulatorButtons:function(){return hC},Viewer:function(){return ND},ViewerUsage:function(){return oa},Visibility:function(){return Xs.EE},WEBGL_ERROR_LOG_TAG:function(){return cM},WILL_RENDER_THUMBNAILS:function(){return nM.gV},WidthMateIndicator:function(){return Yp},WidthMateIndicatorComponent:function(){return Td},XR_POINTER_TIP_Z_OFFSET:function(){return Ay},XrCamera:function(){return _h},XrCommentController:function(){return yy},XrController:function(){return Dy},XrEventEnum:function(){return _y},XrGamepadButtonPressEvent:function(){return by},XrInputDispatcher:function(){return xy},XrInputDisplay:function(){return wy},XrInputEvent:function(){return Ny},XrLineMarkup:function(){return Vy},XrMarkupController:function(){return Hy},XrSelectionHandler:function(){return ky},XrTeleportPreview:function(){return Zy},XrViewController:function(){return $y},Y_UP_TO_OS:function(){return Yy},ZoomToWindowState:function(){return fh.tG},activeViewerChanging:function(){return nM.FM},addByteColorToIncrement:function(){return Yd.CO},addChildDebugObjectsFromProperties:function(){return Xs.Ir},addColorToIncrement:function(){return Yd.Ab},addDebuggableChild:function(){return Xs.n9},addDrawer:function(){return Xs.jo},addHighlightToList:function(){return _n},addLineToMesh:function(){return Yd.L4},addLinesToMesh:function(){return Yd.Ug},addNormalToIncrement:function(){return Yd.b1},addPackedIntegerToIncrement:function(){return Yd.FT},addParentlessNode:function(){return Gi.hn},addQuadToMesh:function(){return Yd.tn},addSizeToIncrement:function(){return Yd.VQ},addStyleToIncrement:function(){return Yd.KZ},addTextureCoordinateToIncrement:function(){return Yd.Zx},addTriangleNormals:function(){return Yd.wK},afterPrint:function(){return li.py},angleBetweenVectors:function(){return wi.FE},are2dPointsEqual:function(){return wi.tm},areAnySectionPlanesSelectedOrPreselected:function(){return lD.cP},areMatricesEqual:function(){return wi.cl},areTexturesPendingLoad:function(){return po},areVectorsEqual:function(){return wi.nP},arraySubtract:function(){return Xs.iq},beforePrint:function(){return li.lp},binarySearchRanges:function(){return qE},bindTexture:function(){return Eo},buildEdgeFromTriangleStrip:function(){return Yd.Gn},buildFacesLinesPointsPasses:function(){return Te},buildHudPass:function(){return Fe},byteToMbString:function(){return al},cacheCapabilities:function(){return Xs.B2},canPointBeDisplayed:function(){return wi.fB},ceilAwayFromZero:function(){return wi.S_},checkError:function(){return vM},clamp:function(){return wi.uZ},cleanUpParentlessNodes:function(){return Gi.Gy},clearPlaneEquationIds:function(){return Yd.G0},clearSavedSectionPlaneParameters:function(){return lD.ny},clearStencilBuffer:function(){return ct.EZ},clearStencilBufferBit:function(){return ct.Pq},cloneStyledRangeSet:function(){return pS},closestAngle:function(){return wi._k},closestAngleGreaterThanOrEqual:function(){return wi.Tu},closestAngleInRange:function(){return wi.Kf},closestAngleLessThanOrEqual:function(){return wi.Kb},closestPointOnLine:function(){return wi.vu},collectGraphicsDataForHeapDump:function(){return NM},compareOutlineNodeProperties:function(){return ey},concatenateFloat32Arrays:function(){return Xs.Mz},concatenateUint8Arrays:function(){return Xs.Lf},constituentTypeToString:function(){return xh.IK},constructEntityPick:function(){return Xs.ft},convertIntToUcharArray:function(){return Xs.fA},convertRGBA255ToRGBA:function(){return Xs.zF},convertRGBAToRGBA255:function(){return Xs.Db},convertRGBToRGBA255:function(){return Xs.C2},createAngularToolPreview:function(){return Js},createArc:function(){return Yd.QV},createArcPolyline:function(){return no},createArrow:function(){return Yd.AD},createArrowPrimitives:function(){return Fr},createAtlasFromResources:function(){return Ql},createBox:function(){return Yd.dO},createCircle:function(){return Yd.y},createCirclePolyline:function(){return Ja},createConicPolyline:function(){return ro},createDimensionForDisplayData:function(){return RA},createDisc:function(){return Yd.$},createDoubleHeadArrow:function(){return Yd.KE},createEdgesFromTriangleStrip:function(){return Yd.sp},createEdgesFromTriangles:function(){return Yd.EK},createEllipsePolyline:function(){return eo},createEntityMetaData:function(){return ho},createInferenceIcon:function(){return Ms.wg},createLine:function(){return Yd.W5},createLineLoop:function(){return Yd.qT},createLinearToolPreview:function(){return tn},createLines:function(){return Yd.pf},createManipulator:function(){return Wl.wA},createMateIndicator:function(){return Kp},createMeshIncrementForEntityData:function(){return UE},createMeshIncrementForPolylineLines:function(){return co},createOffsetTileViewportMatrix:function(){return wi.zD},createPickMatrix:function(){return wi.zL},createPoint:function(){return Yd.Pu},createPointsIncrement:function(){return Yd.mg},createPolyline:function(){return oo},createQuad:function(){return Yd.fQ},createQuadOutline:function(){return Yd.PU},createRGBATexture:function(){return Do},createRing:function(){return Yd.I$},createRoundedRectangle:function(){return Yd.Dw},createSplinePolyline:function(){return ao},createTestViewer:function(){return bD},createTextCanvas:function(){return Vo},createTextDebugObject:function(){return Xs.z4},createTextureFromText:function(){return jo},createTextureMaterial:function(){return Hi},createTileViewportMatrix:function(){return wi.vG},createTriangle:function(){return Yd.aT},createTriangleStrip:function(){return Yd.VO},createTriangles:function(){return Yd.ut},createWireBox:function(){return Yd.U0},crossProduct2d:function(){return wi.tV},database:function(){return ca},debugIdCount:function(){return WT},debugToPostOnLoad:function(){return yM},decodeAngle:function(){return Xs.Pm},decodeDepth:function(){return Xs.Rg},decodeFloat:function(){return Xs.NP},decodePickingIndex:function(){return Xs.EI},deselectEntities:function(){return Ms.Wt},difference2d:function(){return wi.r7},disableSectionPlaneSelection:function(){return oA.ZB},displayCanvasInDom:function(){return Zo},displayEntity:function(){return lo},distanceSquaredBetweenPoints:function(){return wi.B$},distanceSquaredToLineSegment2d:function(){return wi.o5},doesNodeContainPlaneEntities:function(){return ay},drawBackgroundIntoCanvas:function(){return Uo},drawBorderIntoCanvas:function(){return Ho},drawTextIntoCanvas:function(){return Wo},dumpShader:function(){return RI},enableSectionPlaneSelection:function(){return oA.G2},encodePickingIndex:function(){return Xs.ow},ensureMateIndicatorResources:function(){return gd},ensureTextureAtlas:function(){return Ms.bt},estimateTriangleCountAtSettingIndexUsingTriangleCounts:function(){return xh.l_},executePerformanceTests:function(){return WI},extractPlaneFromMatrix:function(){return wi.sc},fillCanvasWithTransparentColor:function(){return Lo},fillHighlightWithDefault:function(){return On},fillInDefaultAttributes:function(){return yi._J},filterActiveSectionPlanes:function(){return lD.HX},filterEntitiesWithData:function(){return GE},findTextBounds:function(){return qo},flipImageVertically:function(){return Xs.Dy},floorTowardsZero:function(){return wi.Tc},forEachActiveSectionPlane:function(){return lD.Lz},forceRequestDraw:function(){return Xs.tj},generateThumbnails:function(){return La},getActiveSectionPlane:function(){return lD.tz},getActiveSectionViewState:function(){return lD.Ky},getActiveViewer:function(){return li.uQ},getActiveViewerCanvasCoordinateFromEvent:function(){return li.P6},getActiveViewerEventDispatcher:function(){return nM.xA},getActiveViewerHasSketch:function(){return li.aN},getActiveViewerOccurrenceDataManager:function(){return li.x},getActiveViewerSceneGraphs:function(){return li.KX},getAlphaModifierFunction:function(){return aT},getAngle:function(){return wi._O},getAngularValueSuffix:function(){return pA.$D},getAssemblyInContextElementId:function(){return Xs.HL},getBitForPlaneEquation:function(){return Yd.X},getBitForPlaneEquationId:function(){return Yd.JP},getBlankCanvas:function(){return Oo},getBlendAmount:function(){return vt},getChannelCountOfGlPixelFormat:function(){return qt},getCirclePoints:function(){return Yd.zl},getCollectionId:function(){return Sl},getColorFromDebugEntityColor:function(){return BE},getColorString:function(){return Xs.o3},getColorStringArray:function(){return Xs.p7},getCosineOfAngleBetweenTwoVectors:function(){return wi.g7},getCounters:function(){return Ln.qn},getCurrentActiveViewerSet:function(){return LM.w5},getCurrentSectionPlaneParameters:function(){return lD.nL},getDataUri:function(){return Na},getDefaultNameForBody:function(){return xh.lv},getDisplayDataTimerLoggingOptions:function(){return LD},getDisplayedElementObservable:function(){return nM.v9},getDrawer:function(){return Xs.HB},getDrawerForId:function(){return Xs.Jb},getDrawers:function(){return Xs.u4},getEditState:function(){return Ls},getEntityPrimitiveType:function(){return HE},getEulerAnglesFromMatrix:function(){return wi.df},getExpressionType:function(){return pA._p},getFeatureThumbnailKey:function(){return _a},getFocusedViewer:function(){return Sh.N9},getFramerateFromTime:function(){return Qo},getGLTarget:function(){return Wt},getGpuMemoryUsage:function(){return wM},getHasFeatureQLVFacePatternCapability:function(){return Xs.XM},getHasLongPressHandlerCapability:function(){return Xs.x4},getHudLayerDepthRange:function(){return vh},getIncrementIntersections:function(){return wi.E7},getIndexBufferType:function(){return ai},getIndexElementSize:function(){return hi},getIndexElementType:function(){return oi},getIntersectionParameters:function(){return wi.dm},getLatestDisplayDataUsage:function(){return Gs},getManipulatorDisplacementDisplayManager:function(){return dh.a},getMatrixFromEulerAngles:function(){return wi.Wm},getMaxSectionPlanes:function(){return lD.j1},getMaximumVerticesPerVbo:function(){return ci},getMeshIncrementForEntityData:function(){return xE},getMostRecentActiveSectionPlaneParameters:function(){return lD.tb},getMouseSettingsManager:function(){return oM},getNewOwnerId:function(){return JT},getNextPowerOfTwo:function(){return wi.cP},getNodeProperties:function(){return EE},getObservableFromActiveViewerForEvent:function(){return nM.eR},getOrCreateViewerSet:function(){return LM.G$},getPartStudioThumbnailKey:function(){return wa},getPartThumbnailKey:function(){return va},getPartstudioElementIdFromContextId:function(){return Xs.dV},getPerpendicularBisector2d:function(){return wi.eB},getPickUsage:function(){return Vs},getPlaneEquationColor:function(){return Yd.KJ},getPlaneEquationId:function(){return Yd.Tf},getPlaneIndexToAlignNormalTo:function(){return lD.qT},getPointAtAngle:function(){return wi.iD},getPreviewAlpha:function(){return xs},getPrimitiveTypeDescription:function(){return Ai.E1},getRendererInfo:function(){return Qt},getScaleFromMatrix:function(){return wi.g9},getSceneGraphIdForUsage:function(){return mh},getScratchSpace:function(){return AT},getSectionPlaneCount:function(){return lD.ti},getSectionPlaneOccurrenceIds:function(){return lD.WC},getSectionedItemsSize:function(){return lD.rv},getSelectedSectionPlane:function(){return Fa.C},getSerializablePlaneData:function(){return lD.OR},getSerializableSectionViewData:function(){return lD.p$},getSerializableSectionViewDataWithPersistentQueries:function(){return lD.bm},getSettingsKey:function(){return ha},getShaderIdWithExtension:function(){return yI},getSilhouetteIncrement:function(){return gE},getSilhouettesId:function(){return uE},getStaticIncrements:function(){return Bl},getTagIntCount:function(){return Xs.q7},getTestingBuffers:function(){return CT},getTextureSize:function(){return To},getThumbnailForKey:function(){return ya},getTimeElapsed:function(){return Xs.Es},getTimeInMilliseconds:function(){return Xs.Wj},getTransparencyTransition:function(){return $e},getUnavailableRendererInfo:function(){return Kt},getUnitBoxIncrement:function(){return pl},getUtilityContext:function(){return wo},getViewerFitPoints:function(){return ba},getViewerForDebugOrTestPurposes:function(){return li.f1},getXrSystem:function(){return Ky},getZoomModeEnabled:function(){return fh.Fo},getZoomToWindowState:function(){return fh.Dx},graphicsTakesSelectionPrecedence:function(){return Xs.Ec},hasSpaceballConnected:function(){return qa},hashPoint:function(){return Yd.HR},hashXYZ:function(){return Yd.nw},hidePartNodesThatDoNotAddToBoundsFilter:function(){return se},hideSectionPlaneFromPick:function(){return lD.Mi},highlightsEqual:function(){return Pn},idFromString:function(){return Mi.UQ},idIsValid:function(){return Mi.rp},idsEqual:function(){return Mi.nD},imageCaptureToJpeg:function(){return Xs.Z$},inZoom:function(){return fh.aD},incrementListenerIdCounter:function(){return kT},initialize32BitIndexSupport:function(){return ri},initializePreviousVersionViewer:function(){return LM.fT},initializeSpaceballConnection:function(){return Xa},insertRange:function(){return YE},insertRangeStartEnd:function(){return jE},insertStyledRange:function(){return dS},interpolateInArray:function(){return wi.HO},intersectLineSegmentRay:function(){return wi.wd},intersectRayBox:function(){return wi.Lr},intersectRayPlane:function(){return wi.fE},intersectRayPlaneMatrix:function(){return wi.bZ},intersectRaySphere:function(){return wi.ss},intersectRayTriangle:function(){return wi.AF},intersectTwoLineSegments2d:function(){return wi.u3},intersectTwoLines2d:function(){return wi.TE},intervalsOverlap:function(){return wi.Ao},isCpuRenderer:function(){return Yt},isEffectivelyAnUnknownGPU:function(){return Jt},isFeatureIdCompound:function(){return kE},isFinite:function(){return wi.xV},isFiniteVector:function(){return wi.Cu},isHighPrecisionFragmentShaderSupported:function(){return Xs.J5},isIdValid:function(){return TE.$J},isInFollowMode:function(){return Xs.sW},isInSectionPlaneMode:function(){return Xs.SU},isMapEmpty:function(){return Xs.hW},isMatrixIdentity:function(){return wi.n_},isNodeForDecal:function(){return Fg},isNodeForSurfaceBody:function(){return ym},isOccurrenceNameForUi:function(){return XE.E},isOrderIndependentTransparencyEnabled:function(){return Xs.Z},isRetrievalDebuggingEnabled:function(){return rl},isRunningIntelGpu:function(){return $t},isSSAOSupported:function(){return Xs.pc},isSceneDebuggerWindowLoaded:function(){return MM},isSectionPlaneModeEnabled:function(){return lD.eQ},isTrimetricCorner:function(){return zD},isUnitVector:function(){return wi.jP},isUsageBase:function(){return Us},isUsageCompare:function(){return Hs},isUsagePreview:function(){return ks},isUsagePreviewAfter:function(){return Ws},isUsagePreviewFinal:function(){return zs},isValidForBounding:function(){return wi.rQ},lastFrameTimeRendering:function(){return OM},loadAndApplySectionViewState:function(){return lD.Wh},loadFonts:function(){return _o},loadSectionPlanesFromParameters:function(){return lD.F6},log:function(){return aa},logMemoryStatistics:function(){return bM},logToInfo:function(){return ra},makeBufferedNormalDepthPass:function(){return B},makeBufferedNormalDepthWithMaskPass:function(){return xe},makeBufferedPass:function(){return D},makeCone:function(){return Yd.QF},makeCylinder:function(){return Yd.Z4},makeDepthClearPass:function(){return U},makeFullId:function(){return VS},makeId:function(){return Mi.qR},makePlaneEquationMatrixDirty:function(){return lD.qf},makeRoundedRectanglePath:function(){return Go},makeSSAOPass:function(){return Se},makeSceneDebugObjectFromObject:function(){return Xs.bN},makeSphere:function(){return Yd.E3},mapRange:function(){return wi.KK},mapRangeAndClamp:function(){return wi.IH},measureFontAlphabeticBaselineVerticalOffset:function(){return Bo},measureTextWidth:function(){return Fo},merge:function(){return mS.TS},mix:function(){return wi.CD},nextOwnerId:function(){return $T},normalDepthClearColor:function(){return x},numberToFixedPointString:function(){return Yd.PF},numberToPrimitiveType:function(){return Ai.JB},occurrenceSortFunction:function(){return fl},off:function(){return ch},on:function(){return hh},onViewerDraw:function(){return Ya},orientText:function(){return zo},outlineNodeProperties:function(){return JM},packedNormalsToFloatArray:function(){return wi.w5},pickFromPreview:function(){return Bs},planeToWorld:function(){return wi.qm},prepareShaderCode:function(){return MI},preserveViewersForDocumentId:function(){return LM.cv},projectToLine:function(){return wi.WW},projectWorldToPlane:function(){return wi.Oh},recordWebClientCapabilities:function(){return xM},registerDragHelper:function(){return ms},releaseScratchSpace:function(){return PT},removeDrawer:function(){return Xs.Dz},removeGraphicsViewers:function(){return LM.jB},removeHighlightFromList:function(){return Nn},removeRange:function(){return QE},removeSectionPlane:function(){return lD.v5},removeSectionPlanes:function(){return lD.UB},removeStyledRange:function(){return uS},removeThumbnailForKey:function(){return Pa},requestDraw:function(){return Xs.vm},requestDrawForInteractiveProcessing:function(){return Xs.et},requestDrawUsingAnimationFrame:function(){return Xs.HK},requestDrawUsingTimer:function(){return Xs.Sd},resetSectionPlanesHiddenFromPick:function(){return lD.X9},resetSharedOperators:function(){return IT},resetStaticSilhouetteState:function(){return mE},resetUsage:function(){return Fs},retrieveViewportAsImage:function(){return li.Xs},saveAndClearSectionViewState:function(){return lD.o_},sceneDebuggerWindow:function(){return CM},scratchSpaces:function(){return yT},sectionPlaneSelectionDisabled:function(){return oA.X5},setBaseHighlightsEnabled:function(){return li.GB},setBoxSelectionEnabled:function(){return un},setDimensionToolActive:function(){return pA.io},setFocusedViewer:function(){return Sh.KO},setForceHideInteriorSelections:function(){return li.iM},setForcePredictableHatching:function(){return lD.jf},setFromSerializablePlaneData:function(){return lD.Rb},setFromSerializableSectionViewData:function(){return lD.rH},setIncrementOpacity:function(){return Yd.Ae},setInteractionEnabled:function(){return pA.Jq},setIsInFollowMode:function(){return Xs.NC},setIsInSectionPlaneMode:function(){return Xs.km},setOrderIndependentTransparencyEnabled:function(){return Xs.uP},setPartThumbnailNeedsToBeRerendered:function(){return Ma},setRefinementMode:function(){return tl},setRendererInfo:function(){return Fh.Vp},setRetinaDisplayMode:function(){return Fh.Xd},setSectionEntitiesEnabled:function(){return lD.CF},setSectionPlaneOnMateConnector:function(){return lD.hJ},setSectionPlaneOnMatrix:function(){return lD.N3},setSerializableDataDirty:function(){return lD.P_},setShowDimensionsMode:function(){return pA.CO},setSketchNeedsThumbnail:function(){return Oa},setSubtract:function(){return Xs.R},setTestingBuffers:function(){return MT},setThumbnailForKey:function(){return Aa},setTransparencyTransition:function(){return Qe},setViewCubeMenuMgrInstance:function(){return kD},setZoomModeEnabled:function(){return fh.CR},setupContextForText:function(){return No},setupDatabase:function(){return la},setupStencilForTestAndWrite:function(){return ct.Ig},setupStencilForTestWithoutWrite:function(){return ct.LL},setupStencilForWriteWithoutTest:function(){return ct.U$},shaderExistsForId:function(){return PI},sign:function(){return Er.sign},sizeOfGlRenderBufferType:function(){return Zt},sizeOfGlType:function(){return kt},sketchinformation:function(){return Gn},smoothstep:function(){return wi.CW},snapshotScenegraph:function(){return PM},sortHighlights:function(){return Rn},spherePlaneTest:function(){return gr},spliceRangesFromArray:function(){return $E},stopActionController:function(){return Za},styleMapsEqual:function(){return mS.Gb},stylesEqual:function(){return mS.d8},tessellateArc:function(){return so},timeRendering:function(){return RM},toDegrees:function(){return wi.Ux},toRadians:function(){return wi.Yr},toRotationMat:function(){return wi.iM},toString:function(){return gS},toggleZoomModifierEnabled:function(){return fh.AA},unbindTexture:function(){return So},unitBoxIncrement:function(){return gl},unprojectPlaneToWorld:function(){return wi.KU},unprojectVectorToWorld:function(){return wi.$o},updateAutoSetting:function(){return Fh.HN},updateMateConnectorSelectedColor:function(){return Vl},updateShaderClippingUniforms:function(){return lD.qS},updateShaderEndcapPatternUniforms:function(){return lD.cV},updateShaderEndcapPickingUniforms:function(){return lD.fI},updateShaderEndcapUniforms:function(){return lD.le},userWebPreferencesGetManager:function(){return Fn.t},vec4FromVec3:function(){return wi.Ot},viewCubeMenuMgrInstance:function(){return GD},viewManipulationSettingsGetManager:function(){return lS},viewerCheck:function(){return Sh.Yk},visibilityDescriptor:function(){return Xs._I},visualizeCoordinateSystem:function(){return TM},visualizeDebugBox:function(){return EM},visualizeDebugPoint:function(){return IM},visualizeLine:function(){return SM},visualizePicks:function(){return DM},visualizeVisiblePicks:function(){return dM},worldToPlane:function(){return wi.LK},zeroOutArrayBuffer:function(){return Xs.rS}});var s,n,r,a,o,h,c,l,d,u,g,p,m=i(47061);!function(e){e[e.POINTS=0]="POINTS",e[e.EDGES=1]="EDGES",e[e.FACES=2]="FACES",e[e.SILHOUETTES=3]="SILHOUETTES"}(s||(s={})),function(e){e[e.BLEND_ONLY=0]="BLEND_ONLY",e[e.NON_BLEND_ONLY=1]="NON_BLEND_ONLY",e[e.ALL=2]="ALL"}(n||(n={})),function(e){e.ACCUMULATION="Accumulation",e.REVEALAGE="Revealage"}(r||(r={})),function(e){e[e.OPAQUE=0]="OPAQUE",e[e.TRANSPARENT=1]="TRANSPARENT",e[e.ALL=2]="ALL"}(a||(a={})),function(e){e[e.VISIBLE=0]="VISIBLE",e[e.SHOWTHROUGH=1]="SHOWTHROUGH"}(o||(o={})),function(e){e[e.OPAQUE=0]="OPAQUE",e[e.ZEBRA_STRIPES=1]="ZEBRA_STRIPES",e[e.DRAFT=2]="DRAFT",e[e.QUALITY_VISUALIZATION=3]="QUALITY_VISUALIZATION"}(h||(h={})),function(e){e[e.WRITE=0]="WRITE",e[e.TEST=1]="TEST",e[e.WRITE_AND_TEST_ISOLATE_CONTEXT=2]="WRITE_AND_TEST_ISOLATE_CONTEXT",e[e.OFF=3]="OFF"}(c||(c={})),function(e){e[e.LOW_PRIORITY_EDGES=1]="LOW_PRIORITY_EDGES",e[e.EDGES=2]="EDGES",e[e.POINTS=4]="POINTS",e[e.FACES=8]="FACES",e[e.ISOLATE_CONTEXT=16]="ISOLATE_CONTEXT"}(l||(l={})),function(e){e[e.EDGES=3]="EDGES",e[e.POINTS=4]="POINTS",e[e.FACES=8]="FACES",e[e.ISOLATE_CONTEXT=16]="ISOLATE_CONTEXT"}(d||(d={})),function(e){e[e.OVER_WITH_SEPARATE_ALPHA=0]="OVER_WITH_SEPARATE_ALPHA",e[e.ADD=1]="ADD",e[e.DEST_ALPHA_PASSTHROUGH=2]="DEST_ALPHA_PASSTHROUGH"}(u||(u={})),function(e){e[e.NEVER=512]="NEVER",e[e.LESS=513]="LESS",e[e.EQUAL=514]="EQUAL",e[e.LEQUAL=515]="LEQUAL",e[e.GREATER=516]="GREATER",e[e.NOTEQUAL=517]="NOTEQUAL",e[e.GEQUAL=518]="GEQUAL",e[e.ALWAYS=519]="ALWAYS"}(g||(g={}));class f extends m.T{constructor(e,t){super(),this.viewer=e,this.childPasses=null,this.shaderTag=null,this.inputs={},this.enabled=!0,this.checkFrameId=!1,this.hideSelectionInterior=!1,(0,Sh.Yk)(e),this.parentPass=t,this.lastRenderedFrame=sS}reloadShaders(){if(this.shader&&this.viewer&&(this.shader=this.viewer.getShader(this.shader.getId())),this.childPasses)for(let e=0;e<this.childPasses.length;e++)this.childPasses[e].reloadShaders();Object.values(this.inputs).forEach((function(e){e.reloadShaders()}))}prepareShaders(){if(!this.shader&&this.getEnabled()&&this.viewer){if(this.usesShader()&&this.initializeShader(),this.childPasses)for(let e=0;e<this.childPasses.length;e++)this.childPasses[e].prepareShaders();Object.values(this.inputs).forEach((function(e){e.prepareShaders()}))}}usesShader(){return!1}initializeShader(){this.shader||(this.shader=this.viewer.getShader(this.getShaderId()))}setShaderUniform(e,t){if(this.childPasses)for(let i=0;i<this.childPasses.length;++i)this.childPasses[i].setShaderUniform(e,t)}onSessionEnded(){this.stopListening()}destroy(){if(this.onSessionEnded(),this.childPasses)for(let e=0;e<this.childPasses.length;++e)this.childPasses[e].destroy(),this.childPasses[e]=null;this.childPasses=null;for(const e in this.inputs)this.inputs[e].destroy(),this.inputs[e]=null;this.inputs=null,this.parentPass=null}setEnabled(e){this.enabled=e}getEnabled(){return this.enabled}setCheckFrameId(e){this.checkFrameId=e}getSceneGraph(){return this.parentPass?this.parentPass.getSceneGraph():this.viewer.getSceneGraphs().getMainSceneGraph()}getLastRenderedFrame(){return this.lastRenderedFrame}setInput(e,t){this.inputs[e]=t}drawInputs(e){if(this.getEnabled()){if(this.childPasses)for(let t=0;t<this.childPasses.length;++t)this.childPasses[t].drawInputs(e);Object.values(this.inputs).forEach((function(t){t.drawInputs(e),t.draw(e)}))}}preDraw(e){return(0,Sh.Yk)(this.viewer),(!this.checkFrameId||e.getFrameId()!==this.lastRenderedFrame)&&(this.lastRenderedFrame=e.getFrameId(),!0)}justBeforeDraw(e){this.parentPass&&this.parentPass.justBeforeDraw(e)}postDraw(e){}onShaderActivated(e,t){}justAfterDraw(e){this.parentPass&&this.parentPass.justAfterDraw(e)}draw(e){if(!this.getEnabled())return;const t=this;if(this.childPasses||this.getSceneGraph().passesNodeFilter((function(e){return t.nodeFilter(e)})))if(e.setActivePass(this),e.getState().capture(),this.preDraw(e)){if(this.childPasses)for(let t=0;t<this.childPasses.length;++t)this.childPasses[t].draw(e);else this.justBeforeDraw(e),this.getSceneGraph().draw(e),this.justAfterDraw(e);this.postDraw(e),e.getState().restore()}else e.getState().restore()}isPickPass(){return!!this.parentPass&&this.parentPass.isPickPass()}isHighlightPass(){return!!this.parentPass&&this.parentPass.isHighlightPass()}getActiveHighlightType(){return this.parentPass?this.parentPass.getActiveHighlightType():null}isShowthroughPass(){return!!this.parentPass&&this.parentPass.isShowthroughPass()}testIsolation(e){return!1}forIsolate(){return!this.parentPass||this.parentPass.forIsolate()}forSectionPlaneEndcapMask(){return!!this.parentPass&&this.parentPass.forSectionPlaneEndcapMask()}getShaderId(){let e="";return this.parentPass&&(e=this.parentPass.getShaderId()),this.shaderTag&&(e+="-"+this.shaderTag),e}needsAttribute(e){return!!this.parentPass&&this.parentPass.needsAttribute(e)}getPickIteration(){return this.parentPass?this.parentPass.getPickIteration():-1}nodeFilter(e){return!this.parentPass||this.parentPass.nodeFilter(e)}addChildPass(e){this.childPasses||(this.childPasses=[]),this.childPasses.push(e)}getChildPass(e){return this.childPasses&&e<this.childPasses.length?this.childPasses[e]:null}getChildPassCount(){return this.childPasses?this.childPasses.length:0}setBlendFilter(e){for(let t=0;this.childPasses&&t<this.childPasses.length;++t)this.childPasses[t].setBlendFilter(e)}getPerformIsolationTest(){for(let e=0;this.childPasses&&e<this.childPasses.length;++e)if(this.childPasses[e].getPerformIsolationTest())return!0;return!1}setPerformIsolationTest(e){for(let t=0;this.childPasses&&t<this.childPasses.length;++t)this.childPasses[t].setPerformIsolationTest(e)}setHideSelectionInterior(e){this.hideSelectionInterior=e}createExcludeForNonBodyFilter(e){const t=this.viewer.getModelViewManagers().getManager();return i=>i.getParent()&&t.isNodeForBody(i.getParent(),e)}createExcludeForNonBodyFilterNoDecals(e){const t=this.viewer.getModelViewManagers().getManager();return i=>i.getParent()&&t.isNodeForBody(i.getParent(),e)&&!Fg(i)}createOnlyDecalsFilter(){const e=this.viewer.getModelViewManagers().getManager();return t=>t.getParent()&&e.isNodeForBody(t.getParent())&&Fg(t)}createExcludeForBodyFilter(){const e=this.viewer.getModelViewManagers().getManager();return t=>t.getParent()&&!e.isNodeForBody(t.getParent())}needsFaceAppearances(){return!0}setNodeOccurrenceFilterFunction(e){if(this.childPasses)for(let t=0;t<this.childPasses.length;++t)this.childPasses[t].setNodeOccurrenceFilterFunction(e)}onAppearanceConstantsUpdated(){if(this.childPasses)for(let e=0;e<this.childPasses.length;++e)this.childPasses[e].onAppearanceConstantsUpdated()}}!function(e){e[e.BLEND_ALL=0]="BLEND_ALL",e[e.BLEND_ALPHA=1]="BLEND_ALPHA",e[e.BLEND_OFF=2]="BLEND_OFF"}(p||(p={}));class I extends f{constructor(e){super(e,null),this.blendMode=p.BLEND_ALL}usesShader(){return!0}preDraw(e){this.initializeShader(),e.getState().capture();const t=this.viewer.getGlContext();switch(this.blendMode){case p.BLEND_ALL:t.enable(t.BLEND),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA);break;case p.BLEND_ALPHA:t.enable(t.BLEND),t.blendFuncSeparate(t.ONE,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA);break;case p.BLEND_OFF:t.disable(t.BLEND)}t.disable(t.DEPTH_TEST),e.getState().callGl("depthMask",!1),e.activateShader(this.shader);const i=this;return Object.entries(this.inputs).forEach((([e,t])=>{i.shader.useTexture(e,t.getColorTexture())})),e.nodeFilter=function(e){return!0},!0}drawBlitNodes(e){this.viewer.getResources().getBlitNode().draw(e)}draw(e){this.enabled&&(e.setActivePass(this),this.preDraw(e)&&(this.justBeforeDraw(e),this.drawBlitNodes(e),this.justAfterDraw(e),this.postDraw(e)))}postDraw(e){const t=this.viewer.getGlContext();t.disable(t.BLEND),t.enable(t.DEPTH_TEST),e.getState().restore()}}class E extends I{constructor(e,t,i){super(e),i=i||{},this.shaderTag=i.shaderTag?i.shaderTag:"drawTexture",this.inputs.uTexture=t,this.performDrawInputs=void 0!==i.performDrawInputs,this.viewport=i.viewport}drawInputs(e){}preDraw(e){return this.performDrawInputs&&super.drawInputs(e),this.viewport&&e.pushViewport(this.viewport),!!super.preDraw(e)||(this.viewport&&e.popViewport(),!1)}postDraw(e){this.viewport&&e.popViewport(),super.postDraw(e)}}class S extends I{constructor(e,t){super(e),this.frameBuffer=t,this.shaderTag="drawTexture"}preDraw(e){this.initializeShader(),e.getState().capture();const t=this.viewer.getGlContext();return t.disable(t.BLEND),e.getState().callGl("depthMask",!1),e.activateShader(this.shader),this.shader.useTexture("uTexture",this.frameBuffer.getTexture()),e.nodeFilter=function(){return!0},!0}}class T extends f{constructor(e,t){super(e,null),this.clearColor=[0,0,0,0],this.viewportScale=1,this.checkFrameId=!0,this.frameBuffer=null;let i=!0;t&&(this.id=t.id,i=!t.hasOwnProperty("makeFrameBuffer")||!!t.makeFrameBuffer),this.makeFrameBuffer=!!i;const s=this.viewer.getGlContext();i&&s&&this.initializeFrameBuffer(s),this.listenTo(this.viewer.getEventDispatcher(),nM.pO,this.onGlContextRestored),this.listenTo(this.viewer.getEventDispatcher(),nM.so,this.onSessionEnded)}onGlContextRestored(e){!this.frameBuffer&&this.makeFrameBuffer&&this.initializeFrameBuffer(e),this.resetBuffer()}getColorTexture(){return this.colorTexture}getWidth(){return this.frameBuffer?.getWidth()}getHeight(){return this.frameBuffer?.getHeight()}initializeFrameBuffer(e){this.frameBuffer=this.viewer.getOrCreateFrameBuffer(this.textureType?this.textureType:e.UNSIGNED_BYTE,this.id,{storageType:this.storageType?this.storageType:e.DEPTH_STENCIL,attachmentType:this.attachmentType?this.attachmentType:e.DEPTH_STENCIL_ATTACHMENT})}resetBuffer(){this.frameBuffer?.resetBuffer()}preDraw(e){if(!super.preDraw(e))return!1;if(1!==this.viewportScale){const t=e.getViewport().slice(0);t[2]=Math.max(1,Math.floor(t[2]*this.viewportScale)),t[3]=Math.max(1,Math.floor(t[3]*this.viewportScale)),e.pushViewport(t)}this.frameBuffer?.update(e),this.colorTexture=this.frameBuffer?.getTexture();const t=this.viewer.getGlContext();return this.oldBufferBinding=t.getParameter(t.FRAMEBUFFER_BINDING),this.frameBuffer?.bindBuffer(),this.clearBuffer(e),!0}clearBuffer(e){const t=this.viewer.getGlContext();t.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],this.clearColor[3]),t.clearStencil(0),t.stencilMask(255),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT)}postDraw(e){1!==this.viewportScale&&e.popViewport();const t=this.viewer.getGlContext();t.bindFramebuffer(t.FRAMEBUFFER,this.oldBufferBinding?this.oldBufferBinding:null)}getFrameBuffer(){return this.frameBuffer}setFrameBuffer(e){this.frameBuffer=e}}function D(e,t,i,s){const n=new T(e,{id:s});return n.childPasses=[t],n.viewportScale=i,n}var C,M=i(68100),y=i(75920);class A extends I{constructor(e,t,i,s,n){super(e),this.shaderTag="endcap",this.forDepthTesting=!1,this.parentPass=t,this.planeIndex=i,this.inputs.uEndcapMaskTexture=s,n&&(this.inputs.uEdgeDetectTexture=n)}setEndcapMaskPass(e){this.inputs.uEndcapMaskTexture=e}getEnabled(){return!!super.getEnabled()&&(0,lD.ti)()>this.planeIndex}isFacingTheViewer(e){const t=e.getActiveCamera().getForward(),i=(0,lD.tz)(this.planeIndex).normal;return M.dot(t,i)<0}preDraw(e){return!((0,lD.ti)()<=this.planeIndex||this.isFacingTheViewer(e)||!this.inputs.uEndcapMaskTexture.getColorTexture())&&(!!super.preDraw(e)&&(e.setOverrideFaceCullingMode(bh.NONE),!0))}justBeforeDraw(e){super.justBeforeDraw(e);const t=this.viewer.getGlContext();this.inputs.uEdgeDetectTexture&&e.detailSettings.enableSectionPlaneEdgeDetection||this.shader.useBlankTexture("uEdgeDetectTexture"),this.shader.uniformMatrix4fv("uPMatrix",!1,e.getProjectionMatrix());const i=y.create();i[this.planeIndex]=1,this.shader.uniform4fv("uPlaneSelector",i);const s=e.getActiveCamera().getSceneBounds().diameter();this.shader.uniform1f("uSceneDiameter",s),(0,lD.qS)(this.viewer,!0),(0,lD.le)(e,this.planeIndex),this.isPickPass()?(this.shader.uniform4fv("uPickRect",this.parentPass.pickRect),this.shader.uniform2f("uPickRectScale",this.parentPass.pickRect[2]/this.parentPass.pickViewportWidthHeight[0],this.parentPass.pickRect[3]/this.parentPass.pickViewportWidthHeight[1]),this.shader.uniform2f("uMaskTextureDimensions",this.inputs.uEndcapMaskTexture.getWidth(),this.inputs.uEndcapMaskTexture.getHeight()),(0,lD.fI)(e,this.planeIndex),t.disable(t.BLEND)):(0,lD.cV)(e,this.planeIndex),t.enable(t.DEPTH_TEST)}draw(e){if(!this.enabled)return;if(e.setActivePass(this),!this.preDraw(e))return;this.justBeforeDraw(e);const t=this.viewer.getGlContext();this.isPickPass()||((0,ct.U$)(t,l.LOW_PRIORITY_EDGES,d.EDGES),this.forDepthTesting||this.shader.uniform1f("uDiscardPatternBackground",1),t.colorMask(!1,!1,!1,!1),e.getState().callGl("depthMask",!1),this.drawBlitNodes(e),t.colorMask(!0,!0,!0,!0),this.forDepthTesting||this.shader.uniform1f("uDiscardPatternBackground",0),t.disable(t.STENCIL_TEST)),e.getState().callGl("depthMask",!0),this.forDepthTesting&&t.colorMask(!1,!1,!1,!1),this.drawBlitNodes(e),this.justAfterDraw(e),this.postDraw(e)}postDraw(e){super.postDraw(e);const t=this.viewer.getGlContext();this.isPickPass()&&t.enable(t.BLEND),t.colorMask(!0,!0,!0,!0),e.clearOverrideFaceCullingMode()}}class P extends f{constructor(e,t,i,s){super(e,t),this.childPasses=[new A(e,t,0,i,s),new A(e,t,1,i,s),new A(e,t,2,i,s),new A(e,t,3,i,s)]}setEndcapMaskPass(e){for(let t=0;t<this.childPasses.length;++t)this.childPasses[t].setEndcapMaskPass(e)}}class O extends I{constructor(e,t){super(e),this.shaderTag="edgeDetect",this.inputs.uSourceBuffer=t}justBeforeDraw(e){super.justBeforeDraw(e);const t=e.getViewport();this.shader.uniform2f("uPixelScale",1/t[2],1/t[3]),this.shader.uniform1f("uDoEdgeDetection",1)}}!function(e){e.X="X",e.Y="Y"}(C||(C={}));class R extends I{constructor(e,t,i){super(e),this.direction=i,this.shaderTag="gaussianFilter",this.inputs.uSourceBuffer=t}justBeforeDraw(e){super.justBeforeDraw(e);const t=e.getViewport();this.shader.uniform2f("uPixelScale",1/t[2],1/t[3]),this.direction===C.X?this.shader.uniform2f("uDirection",1,0):this.shader.uniform2f("uDirection",0,1)}}class w extends T{constructor(e,t){super(e,{id:"edgeDetectAndBlurPassBufferA"}),this.childPasses=[new O(e,t)]}}class v extends T{constructor(e,t,i){super(e,{id:"edgeDetectAndBlurPassBufferB"}),this.childPasses=[new R(e,t,i)]}}class _ extends T{constructor(e,t){super(e,{id:"edgeDetectAndBlurPassBufferA"}),this.edgeDetect=new w(e,t),this.filterX=new v(e,this.edgeDetect,C.X),this.filterY=new R(e,this.filterX,C.Y),this.childPasses=[this.filterY]}preDraw(e){return!!e.detailSettings.enableSectionPlaneEdgeDetection&&super.preDraw(e)}}class N extends f{constructor(e,t){super(e,t),this.previousModelViewMatrix=null,this.previousProjectionMatrix=null;const i=new H(this.viewer,this,{opacity:a.ALL});this.childPasses=[i]}getSceneGraph(){return this.viewer.getSceneGraphs().getHudModelSceneGraph()}preDraw(e){return this.previousModelViewMatrix=e.getModelViewMatrix(),this.previousProjectionMatrix=e.getProjectionMatrix(),e.popProjectionMatrix(),e.popModelViewMatrix(),!0}postDraw(e){e.pushModelViewMatrix(this.previousModelViewMatrix),e.pushProjectionMatrix(this.previousProjectionMatrix)}}class b extends f{constructor(e,t){let i;super(e,t);const s=new Le(this.viewer,this,null,be.HUD,!0);for(this.childPasses=[],this.childPasses.push(s.opaqueFaces),this.childPasses.push(new N(this.viewer,this)),this.childPasses.push(s.nonOitTransparentFaces),this.childPasses.push(s.opaqueEdges),this.childPasses.push(s.opaquePoints),i=0;i<this.childPasses.length;++i){const e=this.childPasses[i];e instanceof ie&&(e.clipToSectionPlanes=!1)}this.childPasses.push(s.showThroughStencilTested),this.childPasses.push(s.showThroughNotStencilTested)}getSceneGraph(){return this.viewer.getSceneGraphs().getHudSceneGraph()}preDraw(e){const t=this.viewer.getGlContext();t.clear(t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT);const i=this.isPickPass()&&this.parentPass&&this.parentPass.oldViewport&&this.parentPass.pickRect;let s,n,r,a,o=i?this.parentPass.oldViewport:e.getViewport();const h=e.getActiveCamera(),c=h.getTileViewport();let l;i?l=this.parentPass.pickRect:c&&(l=c,o=h.getViewport(!0)),l?(s=l[0],n=l[0]+l[2],r=o[3]-(l[1]+l[3]),a=o[3]-l[1]):(s=o[0],n=o[0]+o[2],r=o[1],a=o[1]+o[3]);const d=vh(o),u=new wh({eye:[0,0,0],direction:[0,0,-1],up:[0,1,0],left:s,right:n,bottom:r,top:a,near:d[0],far:d[1]});return e.pushModelViewMatrix(u.getViewMatrix()),e.pushProjectionMatrix(u.getProjectionMatrix()),!0}postDraw(e){e.popProjectionMatrix(),e.popModelViewMatrix()}}class L extends f{constructor(e,t){super(e,null),this.component=t,this.applyTranslucentAlphaToAll=!1,this.sceneGraph=null,this.tintColor=[1,1,1],this.tintFactor=0,this.performIsolationTest=!1,this.shaderTag="OIT"+t,this.blendFilter=n.ALL;const i=this.component===r.ACCUMULATION?[{name:"uHighlightColorTextureWidth",value:this.viewer.getReferenceHighlights().getHighlightTextureWidth()}]:[],o={opacity:a.TRANSPARENT,blendMode:t===r.ACCUMULATION?u.ADD:u.DEST_ALPHA_PASSTHROUGH,extraShaderUniforms:i,disableDepthTest:!1,oitComponent:t,performIsolationTest:!0},h=new ie(e,this,{...o,primitiveType:s.FACES}),l=new ie(e,this,{...o,primitiveType:s.FACES,shaderTagSuffix:SI}),d=new ie(e,this,{...o,primitiveType:s.FACES,stencilMode:c.WRITE}),g=new ie(e,this,{...o,primitiveType:s.FACES,stencilMode:c.WRITE,shaderTagSuffix:SI}),p=new ie(e,this,{...o,primitiveType:s.EDGES,stencilMode:c.OFF}),m=new ie(e,this,{...o,primitiveType:s.EDGES,stencilMode:c.OFF,shaderTagSuffix:SI});this.edgePass=new lA(e,p,m,lD.eQ),this.facePass=new lA(e,h,l,lD.eQ),this.faceStencilPass=new lA(e,d,g,lD.eQ),this.silhouettesPass=new Bt(e,this,this.sceneGraph,o),this.edgePass.setExtraMeshNodeFilter(this.createExcludeForNonBodyFilter()),this.addChildPass(this.facePass),this.addChildPass(this.edgePass),this.addChildPass(this.silhouettesPass),this.addChildPass(this.faceStencilPass),this.setSilhouettesEnabled(!1)}justBeforeDraw(e){for(const e of this.childPasses)e.setShaderUniform("uTintFactor",this.tintFactor),e.setShaderUniform("uTintColor",this.tintColor)}setSilhouettesEnabled(e){this.silhouettesPass.setEnabled(e)}setEdgesEnabled(e){this.edgePass.setEnabled(e)}appliesTranslucentAlphaToAll(e){this.applyTranslucentAlphaToAll=e,this.facePass.appliesTranslucentAlphaToAll(e),this.edgePass.appliesTranslucentAlphaToAll(e),this.silhouettesPass.appliesTranslucentAlphaToAll(e),this.faceStencilPass.appliesTranslucentAlphaToAll(e)}setSceneGraph(e){this.sceneGraph=e,this.facePass.setSceneGraph(e),this.edgePass.setSceneGraph(e),this.faceStencilPass.setSceneGraph(e),this.silhouettesPass.setSceneGraph(e)}getSceneGraph(){return this.sceneGraph?this.sceneGraph:super.getSceneGraph()}setBlendFilter(e){this.blendFilter=e,this.facePass.setBlendFilter(e),this.edgePass.setBlendFilter(e),this.silhouettesPass.setBlendFilter(e),this.faceStencilPass.setBlendFilter(e)}setExtraFaceMeshNodeFilter(e){this.facePass.setExtraMeshNodeFilter(e),this.faceStencilPass.setExtraMeshNodeFilter(e)}setTintColor(e){this.tintColor=e,this.facePass.setShaderUniform("tintColor",e),this.edgePass.setShaderUniform("tintColor",e),this.silhouettesPass.setShaderUniform("tintColor",e),this.faceStencilPass.setShaderUniform("tintColor",e)}setTintFactor(e){this.tintFactor=e,this.facePass.setShaderUniform("tintFactor",e),this.edgePass.setShaderUniform("tintFactor",e),this.silhouettesPass.setShaderUniform("tintFactor",e),this.faceStencilPass.setShaderUniform("tintFactor",e)}setHideSelectionInterior(e){this.facePass.setHideSelectionInterior(e),this.edgePass.setHideSelectionInterior(e),this.silhouettesPass.setHideSelectionInterior(e),this.faceStencilPass.setHideSelectionInterior(e)}testIsolation(e){return this.performIsolationTest&&e.getHasIsolate()}}class F extends f{constructor(e){super(e,null),this.shaderTag="normalDepth",this.childPasses=[],this.points=[],this.scenegraph=null,this.opaqueFacePass=new ie(this.viewer,this,{}),this.childPasses.push(this.opaqueFacePass)}setSceneGraph(e){this.sceneGraph=e,this.opaqueFacePass.setSceneGraph(e)}getSceneGraph(){return this.sceneGraph?this.sceneGraph:super.getSceneGraph()}setOpacity(e){this.opaqueFacePass.setOpacity(e)}justBeforeDraw(e){const t=this.viewer.getGlContext();t.disable(t.BLEND),super.justBeforeDraw(e)}nodeFilter(e){const t=this.viewer.getModelViewManagers().getManager();return!!(!e.isMeshNode()||t.isNodeForModel(e)&&t.isNodeForFaces(e))&&e.getIsVisible()}}const x=[.5,.5,1,1];function B(e,t,i){const s=D(e,new F(e),t,i);return s.clearColor=x,s}class V extends f{constructor(e,t){super(e,t),this.childPasses=[]}preDraw(e){const t=this.viewer.getGlContext();return t.clear(t.DEPTH_BUFFER_BIT),!0}}function U(e,t){return new V(e,t)}class H extends f{constructor(e,t,i){super(e,t),this.childPasses=Te(e,this,i)}}class G extends F{constructor(e,t){super(e),this.shaderTag="normalDepthWithMask",this.tintedEdges=new ie(this.viewer,this,{primitiveType:s.EDGES}),this.tintedEdges.setExtraMeshNodeFilter((function(e){return e.getIsTintedByCompare()})),this.tintedPoints=new ie(this.viewer,this,{primitiveType:s.POINTS}),this.tintedPoints.setExtraMeshNodeFilter((function(e){return e.getIsTintedByCompare()})),this.childPasses.push(this.tintedEdges),this.childPasses.push(this.tintedPoints),t&&(this.inputs.uMask=t)}justBeforeDraw(e){const t=e.getActiveShader();if(this.inputs.uMask){t.useTexture("uMask",this.inputs.uMask.getColorTexture());const i=e.getViewport();t.uniform2f("uMaskWidthHeight",i[2],i[3]),t.uniform1f("uUseMask",1)}else t.uniform1f("uUseMask",0),t.useBlankTexture("uMask");super.justBeforeDraw(e)}nodeFilter(e){return!!e.isMeshNode()&&e.getIsVisible()}}var k=i(22681);class W extends f{constructor(e,t){super(e,t);const i=this.viewer.getSceneGraphs().getMainSceneGraph(),n=this.viewer.getSceneGraphs().getPreviewSceneGraph();this.baseDefaultPasses=new Le(this.viewer,this,i,be.RENDERING),this.compareDefaultPasses=new Le(this.viewer,this,n,be.RENDERING),this.baseDefaultPasses.depthTransparentFaces.setEnabled(!1),this.compareDefaultPasses.depthTransparentFaces.setEnabled(!1),this.nonEditedFaceDepthPass=new ie(this.viewer,this,{primitiveType:s.FACES,disableColorWrites:!0}),this.nonEditedEdgeDepthPass=new ie(this.viewer,this,{primitiveType:s.EDGES,disableColorWrites:!0}),this.setRenderingMode(k.P1.SHADED_WITH_EDGES),this.baseDefaultPasses.disableNonOitTransparentEdgesForBodies(),this.compareDefaultPasses.disableNonOitTransparentEdgesForBodies()}setBlendFilters(){this.baseDefaultPasses.setBlendFilter(n.BLEND_ONLY),this.compareDefaultPasses.setBlendFilter(n.BLEND_ONLY),this.nonEditedFaceDepthPass.setBlendFilter(n.NON_BLEND_ONLY),this.nonEditedEdgeDepthPass.setBlendFilter(n.NON_BLEND_ONLY)}setHideSelectionInterior(e){this.baseDefaultPasses.setHideSelectionInterior(e),this.compareDefaultPasses.setHideSelectionInterior(e)}pushOpaqueDepthPassWithAlpha(){xs()>.5?(this.childPasses.push(this.compareDefaultPasses.depthFaces),this.childPasses.push(this.compareDefaultPasses.sectionPlaneEndcap),this.childPasses.push(this.compareDefaultPasses.depthEdges)):(this.childPasses.push(this.baseDefaultPasses.depthFaces),this.childPasses.push(this.baseDefaultPasses.sectionPlaneEndcap),this.childPasses.push(this.baseDefaultPasses.depthEdges))}setRenderingMode(e){this.baseDefaultPasses.setRenderingMode(e),this.compareDefaultPasses.setRenderingMode(e)}getBaseEndcapMaskPass(){return this.baseDefaultPasses.sectionPlaneEndcapMask}getPreviewEndcapMaskPass(){return this.compareDefaultPasses.sectionPlaneEndcapMask}}var z=i(86925),X=i(32606);const Z=function(e){if(!e.isMeshNode())return!1;if(this.blendFilter===n.BLEND_ONLY){if(!e.getIncludedInBlend())return!1}else if(this.blendFilter===n.NON_BLEND_ONLY&&e.getIncludedInBlend())return!1;return!!e.getIsDepthTested()&&(!e.hasTransparency()&&(!(e.getIsStencilTested()||!e.getIsStencilWritten())&&(this.priority===e.getRenderOrderPriority()&&this.parentPass.nodeFilter(e))))},q=function(e){const t=this.viewer.getModelViewManagers().getManager(),i=e.getParent();return!!(e.isEdges()&&i&&t.isNodeForBody(i))&&Z.call(this,e)},Y=function(e){return!!e.isSilhouettes()&&Z.call(this,e)};class K extends f{constructor(e,t,i){super(e,t),this.childPasses=[];const n=X.default.getManager(),r=(0,z.Z)(i);r.extraShaderUniforms=[{name:"uBackgroundMixProportion",value:0}];const a=(0,z.Z)(i);a.stencilMode=c.TEST,a.stencilRefValue=l.LOW_PRIORITY_EDGES,a.visibility=o.SHOWTHROUGH,a.disableDepthTest=!0,a.extraShaderUniforms=[{name:"uBackgroundMixProportion",value:n.getNumber("HIDDEN_LINE_FADE_AMOUNT")}],this.visibleEdgePass1=new ie(this.viewer,this,r),r.shaderTagSuffix=SI,this.visibleEdgePass2=new ie(this.viewer,this,r),this.visibleEdgePass=new lA(this.viewer,this.visibleEdgePass1,this.visibleEdgePass2,lD.eQ),this.childPasses.push(this.visibleEdgePass),this.hiddenEdgePass=new ie(this.viewer,this,a),i.primitiveType===s.EDGES?this.hiddenEdgePass.setNodeFilter(q):this.hiddenEdgePass.setNodeFilter(Y),this.hiddenEdgePass.setEnabled(!1),this.childPasses.push(this.hiddenEdgePass)}setDrawHidden(e){this.hiddenEdgePass.setEnabled(e),this.updateMixColor()}onAppearanceConstantsUpdated(){this.updateMixColor()}updateMixColor(){this.hiddenEdgePass.getEnabled()&&this.setShaderUniform("uBackgroundColor",X.default.getManager().getColor("BACKGROUND_COLOR"))}setDrawVisibleParts(e){e?this.visibleEdgePass.setNodeFilter(null):this.visibleEdgePass.setNodeFilter(se)}setBlendFilter(e){this.visibleEdgePass.setBlendFilter(e),this.hiddenEdgePass.setBlendFilter(e)}setExtraMeshNodeFilter(e){this.visibleEdgePass.setExtraMeshNodeFilter(e),this.hiddenEdgePass.setExtraMeshNodeFilter(e)}set nodeOccurrenceFilterFunction(e){this.visibleEdgePass1.nodeOccurrenceFilterFunction=e,this.visibleEdgePass1.nodeOccurrenceFilterFunction=e,this.hiddenEdgePass.nodeOccurrenceFilterFunction=e}appliesTranslucentAlphaToAll(e){this.visibleEdgePass.appliesTranslucentAlphaToAll(e)}setSceneGraph(e){this.visibleEdgePass.setSceneGraph(e)}}var j=i(36889),Q=i(81578);const $=X.default.getManager(),J=Q.create(),ee=M.create(),te=y.create();class ie extends f{constructor(e,t,i){switch(super(e,t),this.stencilRefValue=null,this.extraShaderUniforms=[],this.disableColorWrites=!1,this.clipToSectionPlanes=!0,this.disableDepthTest=!1,this.performIsolationTest=!1,this.sceneGraph=null,this.shaderTag="points",this.forDepth=!1,this.oitComponent=null,this.shader=null,this.occlusionMapTextureUnit=0,this.applyTranslucentAlphaToAll=!1,this.nodeOccurrenceFilterFunction=null,this.primitiveType=s.FACES,this.opacity=a.OPAQUE,this.visibility=o.VISIBLE,this.stencilMode=c.WRITE,this.priority=Gi.DO.DEFAULT,this.facesShader=h.OPAQUE,this.blendMode=u.OVER_WITH_SEPARATE_ALPHA,this.blendFilter=n.ALL,this.depthTestMode=g.LESS,i&&(0,j.overwriteMatchingProperties)(this,i),this.primitiveType){case s.POINTS:break;case s.EDGES:this.shaderTag="edges";break;case s.FACES:switch(this.facesShader){case h.OPAQUE:this.shaderTag="faces";break;case h.ZEBRA_STRIPES:this.shaderTag="zebraStripes";break;case h.DRAFT:this.shaderTag="draftAnalysis";break;case h.QUALITY_VISUALIZATION:this.shaderTag="qualityVisualization"}break;case s.SILHOUETTES:this.shaderTag="silhouettes"}i.shaderTagSuffix&&(this.shaderTag=this.shaderTag+i.shaderTagSuffix),this.primitiveType!==s.FACES||i.hasOwnProperty("stencilMode")||(this.stencilMode=c.OFF)}setExtraMeshNodeFilter(e){this.extraMeshNodeFilter=e}setSceneGraph(e){this.sceneGraph=e}setBlendFilter(e){this.blendFilter=e}getPerformIsolationTest(){return this.performIsolationTest}setPerformIsolationTest(e){this.performIsolationTest=e}getSceneGraph(){return this.sceneGraph?this.sceneGraph:super.getSceneGraph()}setEnableColorWrites(e){this.disableColorWrites=!e}setOpacity(e){this.opacity=e}setShaderUniform(e,t){for(const i of this.extraShaderUniforms)if(i.name===e)return void(i.value=t);this.extraShaderUniforms.push({name:e,value:t})}appliesTranslucentAlphaToAll(e){this.applyTranslucentAlphaToAll=e}isShowthroughPass(){return this.visibility===o.SHOWTHROUGH||!!this.parentPass&&this.parentPass.isShowthroughPass()}rendersPoints(){return this.primitiveType===s.POINTS}rendersEdges(){return this.primitiveType===s.EDGES||this.primitiveType===s.SILHOUETTES}rendersFaces(){return this.primitiveType===s.FACES}testIsolation(e){return this.performIsolationTest&&e.getHasIsolate()}usesShader(){return!0}setNodeOccurrenceFilterFunction(e){this.nodeOccurrenceFilterFunction=e}preDraw(e){if(!super.preDraw(e))return!1;const t=this.viewer.getGlContext();this.initializeShader(),e.activateShader(this.shader),this.isPickPass()||e.setMaterial();const i=this;switch(e.nodeFilter=function(e){return i.nodeFilter(e)},this.blendMode){case u.OVER_WITH_SEPARATE_ALPHA:t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA);break;case u.ADD:t.blendFunc(t.ONE,t.ONE);break;case u.DEST_ALPHA_PASSTHROUGH:t.blendFunc(t.ZERO,t.ONE_MINUS_SRC_ALPHA);break;default:throw"Unrecognized blend mode"}t.enable(t.BLEND),this.updateIsolationUniform(e,this.shader);const s=this.parentPass&&"depth"===this.parentPass.shaderTag,n=this.opacity===a.TRANSPARENT&&!this.disableColorWrites,r=this.rendersPoints()||this.rendersEdges(),o=s||this.forDepth||!n&&!r;e.getState().callGl("depthMask",o),this.disableDepthTest||this.applyTranslucentAlphaToAll?(t.disable(t.DEPTH_TEST),e.getState().callGl("depthMask",!1)):(t.enable(t.DEPTH_TEST),e.getState().callGl("depthMask",o),t.depthFunc(this.depthTestMode));const h=!this.isPickPass()&&!this.isHighlightPass(),l=(this.rendersEdges()||this.rendersPoints())&&h,d=this.rendersFaces()&&h;return this.stencilMode===c.TEST&&(l||d)?(0,ct.LL)(t,this.getStencilRefValue(),this.getStencilRefMask()):this.stencilMode===c.WRITE&&(l||d)?(0,ct.U$)(t,this.getStencilRefValue(),this.getStencilRefMask()):this.stencilMode===c.WRITE_AND_TEST_ISOLATE_CONTEXT&&d?(0,ct.Ig)(t,this.getStencilRefValue(),this.getStencilRefMask()):t.disable(t.STENCIL_TEST),this.isPickPass()&&(e.getState().callGl("depthMask",!0),t.disable(t.BLEND)),this.disableColorWrites&&t.colorMask(!1,!1,!1,!1),this.rendersPoints()&&this.shader.uniform1f("uPointFilterWidth",$.getNumber("POINT_FILTER_WIDTH")),this.rendersEdges()&&(this.forDepth?this.shader.uniform1f("uLineFilterWidth",0):this.shader.uniform1f("uLineFilterWidth",$.getNumber("LINE_FILTER_WIDTH"))),this.nodeOccurrenceFilterFunction&&e.setNodeOccurrenceFilterFunction(this.nodeOccurrenceFilterFunction),!0}onShaderActivated(e,t){e.getDetailSettings().enableSSAO&&this.inputs.hasOwnProperty("uOcclusionMap")&&!e.getHasIsolate()?(t.useTexture("uOcclusionMap",this.inputs.uOcclusionMap.getColorTexture()),t.uniform1f("uOcclusionFactor",$.getNumber("AMBIENT_OCCLUSION_EFFECT_FACTOR"))):t.uniform1f("uOcclusionFactor",0),this.updateIsolationUniform(e,t);const i=this.viewer.getResources().getHighlightTexture();t.useTexture("uHighlightColorTexture",i),t.uniform1f("uHighlightColorTextureWidth",this.viewer.getReferenceHighlights().getHighlightTextureWidth()),(0,lD.qS)(this.viewer,this.clipToSectionPlanes),this.rendersFaces()&&(t.uniform1f("uTintFactor",0),t.uniform3f("uTintColor",1,1,1),t.uniform1i("uApplyTranslucentAlphaToAll",this.applyTranslucentAlphaToAll?1:0),t.uniform1i("uHideSelectionInterior",this.hideSelectionInterior?1:0)),this.applyExtraUniforms(t)}updateIsolationUniform(e,t){this.testIsolation(e)?t.uniform1i("uOutsideIsolation",this.forIsolate()?0:1):t.uniform1i("uOutsideIsolation",0)}getStencilRefValue(){return this.stencilRefValue?this.stencilRefValue:this.stencilMode===c.WRITE_AND_TEST_ISOLATE_CONTEXT?l.ISOLATE_CONTEXT:this.rendersEdges()?l.EDGES:this.rendersFaces()?l.FACES:l.POINTS}getStencilRefMask(){return this.stencilMode===c.WRITE_AND_TEST_ISOLATE_CONTEXT?d.ISOLATE_CONTEXT:this.rendersEdges()?d.EDGES:this.rendersFaces()?d.FACES:d.POINTS}justBeforeDraw(e){super.justBeforeDraw(e),this.applyExtraUniforms(this.shader)}applyExtraUniforms(e){for(const t of this.extraShaderUniforms)if(t.value)switch(t.value.length){case 4:e.uniform4fv(t.name,t.value);break;case 3:e.uniform3fv(t.name,t.value);break;case 2:e.uniform2fv(t.name,t.value);break;default:e.uniform1f(t.name,t.value)}}justAfterDraw(e){super.justAfterDraw(e);const t=e.getActiveShader();this.extraShaderUniforms.forEach((function(e){if(e.value)switch(e.value.length){case 4:t.uniform4fv(e.name,te);break;case 3:t.uniform3fv(e.name,ee);break;case 2:t.uniform2fv(e.name,J);break;default:t.uniform1f(e.name,0)}}),this)}postDraw(e){const t=this.viewer.getGlContext();t.disable(t.STENCIL_TEST),t.enable(t.DEPTH_TEST),t.disable(t.BLEND),t.colorMask(!0,!0,!0,!0),this.nodeOccurrenceFilterFunction&&e.setNodeOccurrenceFilterFunction(null)}nodeFilter(e){if(!e.isMeshNode())return!1;if(this.blendFilter===n.BLEND_ONLY){if(!e.getIncludedInBlend())return!1}else if(this.blendFilter===n.NON_BLEND_ONLY&&e.getIncludedInBlend())return!1;if(this.extraMeshNodeFilter&&!this.extraMeshNodeFilter(e))return!1;if(this.disableDepthTest===e.getIsDepthTested())return!1;switch(this.primitiveType){case s.POINTS:if(!e.isPoints())return!1;break;case s.EDGES:if(!e.isEdges())return!1;break;case s.FACES:if(!e.isFaces())return!1;break;case s.SILHOUETTES:if(!e.isSilhouettes())return!1}switch(this.visibility){case o.VISIBLE:if(e.getIsShowThrough())return!1;switch(this.opacity){case a.OPAQUE:if(e.hasTransparency())return!1;break;case a.TRANSPARENT:if(!e.hasTransparency()&&!this.applyTranslucentAlphaToAll)return!1}break;case o.SHOWTHROUGH:if(!e.getIsShowThrough())return!1}const t=e.getIsStencilTested(),i=e.getIsStencilWritten();return!(this.stencilMode===c.TEST&&!t)&&(!(this.stencilMode===c.WRITE&&(!i||t))&&((this.stencilMode!==c.OFF||!t&&!i)&&(this.priority===e.getRenderOrderPriority()&&this.parentPass.nodeFilter(e))))}setNodeFilter(e){this.nodeFilter=e||ie.prototype.nodeFilter}}function se(e){const t=this.viewer.getModelViewManagers().getManager(),i=e.getParent();return!(i&&t.isNodeForBody(i)&&!e.getAddsToBounds())&&ie.prototype.nodeFilter.call(this,e)}class ne extends ie{constructor(e,t,i,s){super(e,t,{facesShader:h.QUALITY_VISUALIZATION,performIsolationTest:i}),this.setSceneGraph(s)}}class re extends f{constructor(e,t,i,s,n){super(e,t),this.childPasses=[];const r=!!n;this.scenegraph=this.viewer.getSceneGraphs().getMainSceneGraph(),s===ys.L.PREVIEW&&(this.scenegraph=this.viewer.getSceneGraphs().getPreviewSceneGraph()),this.usage=s||ys.L.BASE;const a=this.viewer.getReferenceHighlights().sortedHighlights;for(let e=0;e<a.length;++e){const t=a[e].type;if(n&&!n.has(t))continue;Cn.o2.FILTERED_ENTITIES;const s=t===Cn.o2.FILTERED_ENTITIES&&!r,o=new St(this.viewer,t,i,s);o.setSceneGraph(this.scenegraph),this.childPasses.push(o)}}setInteriorHighlightOpacity(e){for(let t=0;t<this.childPasses.length;++t)this.childPasses[t].setInteriorHighlightOpacity(e)}getSceneGraph(){return this.scenegraph}drawInputs(e){}draw(e){if(this.usage!==ys.L.BASE||e.getBaseHighlightsEnabled())for(let t=0;t<this.childPasses.length;++t)this.viewer.getHighlightManager(this.usage).highlightHasSelections(this.childPasses[t].highlightType)&&(this.childPasses[t].drawInputs(e),this.childPasses[t].draw(e))}setHideSelectionInterior(e){for(let t=0;t<this.childPasses.length;++t)this.childPasses[t].setHideSelectionInterior(!!e&&this.childPasses[t].highlightType!==Cn.o2.PRE)}setMaskOpaqueFaces(e){for(let t=0;t<this.childPasses.length;t++)this.childPasses[t].setMaskOpaqueFaces(e)}}class ae extends f{constructor(e,t,i,n,r,h,l){let d;super(e,i),this.highlightType=t,this.useDepthTest=n,this.stippleOverride=r,this.clipAgainstSectionPlane=h,this.disableDuringPreview=l,this.shaderTag="highlightDraw",this.childPasses=[],h||(d=SI);const u=X.default.getManager();for(let e=0;e<Gi.DO.COUNT;++e)this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.EDGES,visibility:o.SHOWTHROUGH,stencilMode:c.TEST,disableDepthTest:!0,priority:e,shaderTagSuffix:d})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.POINTS,visibility:o.SHOWTHROUGH,stencilMode:c.TEST,disableDepthTest:!0,priority:e,shaderTagSuffix:d})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.EDGES,visibility:o.SHOWTHROUGH,disableDepthTest:!0,priority:e,shaderTagSuffix:d})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.POINTS,visibility:o.SHOWTHROUGH,disableDepthTest:!0,priority:e,shaderTagSuffix:d})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.EDGES,visibility:o.SHOWTHROUGH,priority:e,shaderTagSuffix:d})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.POINTS,visibility:o.SHOWTHROUGH,priority:e,shaderTagSuffix:d}));this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.EDGES,shaderTagSuffix:d})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.EDGES,opacity:a.TRANSPARENT,stencilMode:c.OFF,extraShaderUniforms:[{name:"uHighlightLineWidthMin",value:u.getNumber("HIGHLIGHT_LINE_WIDTH_TRANSPARENT_MIN")}],shaderTagSuffix:d})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.POINTS,shaderTagSuffix:d}))}isHighlightPass(){return!0}getActiveHighlightType(){return this.highlightType}needsAttribute(e){const t=e===PS.HIGHLIGHT_ID;return this.parentPass?t||this.parentPass.needsAttribute(e):t}getHighlight(){return this.viewer.getReferenceHighlights().highlights[this.highlightType]}getEnabled(){return this.enabled&&(!this.disableDuringPreview||!ks())}nodeFilter(e){return this.getHighlight().forOccurrences?e.getParent()&&!this.viewer.getModelViewManagers().getManager().isNodeForBody(e.getParent()):f.prototype.nodeFilter.apply(this,[e])}justBeforeDraw(e){const t=X.default.getManager();super.justBeforeDraw(e);const i=e.getActiveShader(),s=this.getHighlight(),n=s.type===Cn.o2.FILTERED_ENTITIES;i.uniform1f("uActiveHighlightIndex",s.index),i.uniform4fv("uHighlightColor",s.color1),i.uniform1f("uHighlightLineWidthMin",n?t.getNumber("HIGHLIGHT_LINE_WIDTH_REDUCED_PX"):t.getNumber("HIGHLIGHT_LINE_WIDTH_MIN_PX")),i.uniform1f("uHighlightPointSizeMin",t.getNumber("HIGHLIGHT_POINT_SIZE_MIN_PX")),this.stippleOverride?(i.uniform4fv("uHighlightLineStipple",this.stippleOverride),i.uniform1f("uUseHighlightLineStipple",1),e.setUseHiddenOpacityForEdgeHighlights(!0)):(i.uniform1f("uUseHighlightLineStipple",0),e.setUseHiddenOpacityForEdgeHighlights(!1)),i.uniform1i("uClippedBySectionPlanes",this.clipAgainstSectionPlane?1:0);const r=this.viewer.getGlContext();r.enable(r.BLEND),r.blendFuncSeparate(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA,r.ONE,r.ONE_MINUS_SRC_ALPHA),this.useDepthTest?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST),e.getState().callGl("depthMask",!1)}}class oe extends f{constructor(e,t,i,s){super(e,null),this.childPasses=[];const n=X.default.getManager();this.usage=t||ys.L.BASE,this.scenegraph=this.viewer.getSceneGraphs().getMainSceneGraph(),t===ys.L.PREVIEW&&(this.scenegraph=this.viewer.getSceneGraphs().getPreviewSceneGraph());const r=!!s;for(let e=0;e<this.viewer.getReferenceHighlights().sortedHighlights.length;++e){const t=this.viewer.getReferenceHighlights().sortedHighlights[e].type;if(s&&!s.has(t))continue;const a=t===Cn.o2.FILTERED_ENTITIES,o=t===Cn.o2.FILTERED_ENTITIES,h=t===Cn.o2.FILTERED_ENTITIES&&!r;i?a&&this.childPasses.push(new ae(this.viewer,t,this,!0,null,o,h)):a?this.childPasses.push(new ae(this.viewer,t,this,!1,n.getStipple("HIGHLIGHT_HIDDEN_LINE_STIPPLE"),o,h)):this.childPasses.push(new ae(this.viewer,t,this,!1,null,o,h))}}preDraw(e){return!(this.usage===ys.L.BASE&&!e.getBaseHighlightsEnabled())&&super.preDraw(e)}drawInputs(e){for(let e=0;e<this.childPasses.length;++e)this.childPasses[e].setEnabled(this.viewer.getHighlightManager(this.usage).highlightHasSelections(this.childPasses[e].highlightType));f.prototype.drawInputs.apply(this,[e])}setSceneGraph(e){this.scenegraph=e}getSceneGraph(){return this.scenegraph}}const he=X.default.getManager();class ce extends T{constructor(e){super(e),this.checkFrameId=!1,this.shaderTag="depth",this.useHighlightsOnly=!1,this.childPasses=[],this.points=[],this.numSamples=0,this.includePlanes=!0,this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.FACES,performIsolationTest:!0,extraShaderUniforms:[{name:"uUseHighlightsOnly",value:0}]})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.FACES,opacity:a.TRANSPARENT,performIsolationTest:!0,extraShaderUniforms:[{name:"uUseHighlightsOnly",value:0}]})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.EDGES,performIsolationTest:!0,extraShaderUniforms:[{name:"uUseHighlightsOnly",value:0}]})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.EDGES,performIsolationTest:!0,opacity:a.TRANSPARENT,stencilMode:c.OFF,extraShaderUniforms:[{name:"uUseHighlightsOnly",value:0}]})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.POINTS,performIsolationTest:!0,extraShaderUniforms:[{name:"uUseHighlightsOnly",value:0}]})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.POINTS,performIsolationTest:!0,visibility:o.SHOWTHROUGH,extraShaderUniforms:[{name:"uUseHighlightsOnly",value:0}]})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.FACES,performIsolationTest:!0,sceneGraph:this.viewer.getSceneGraphs().getPreviewSceneGraph(),extraShaderUniforms:[{name:"uUseHighlightsOnly",value:0}]})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.FACES,performIsolationTest:!0,opacity:a.TRANSPARENT,sceneGraph:this.viewer.getSceneGraphs().getPreviewSceneGraph(),extraShaderUniforms:[{name:"uUseHighlightsOnly",value:0}]})),this.clearColor=Xs.XD}setIncludePlanes(e){this.includePlanes=e}nodeFilter(e){return!!e.getIsVisible()&&(!e.isMeshNode()||!ay(e)||this.includePlanes)}needsAttribute(e){const t=e===PS.HIGHLIGHT_ID&&this.useHighlightsOnly;return this.parentPass?t||this.parentPass.needsAttribute(e):t}isHighlightPass(){return this.useHighlightsOnly}getActiveHighlightType(){return Cn.o2.ENTITY}setUseHighlightsOnly(e){this.useHighlightsOnly=e;const t=e?1:0;for(let e=0;e<this.childPasses.length;e++)this.childPasses[e].setShaderUniform("uUseHighlightsOnly",t)}draw(e){throw"Use DepthSamplingPass retrieve method instead"}retrieve(e,t){t=t||{},this.numSamples=void 0===t.numSamples?he.getNumber("DEPTH_SAMPLES_PER_VIEWPORT"):t.numSamples,this.includePlanes=void 0===t.includePlanes||t.includePlanes,this.setPerformIsolationTest(void 0===t.performIsolationTest||t.performIsolationTest),this.setUseHighlightsOnly(void 0!==t.useHighlightsOnly&&t.useHighlightsOnly),super.draw(e)}preDraw(e){const t=e.getViewport(),i=Math.min(Math.sqrt(this.numSamples/(t[2]*t[3])),1);return this.horizontalScale=Math.ceil(t[2]*i)/t[2],this.verticalScale=Math.ceil(t[3]*i)/t[3],this.fullViewport=t,this.shrunkViewport=[0,0,Math.max(Math.round(this.horizontalScale*t[2]),1),Math.max(Math.round(this.verticalScale*t[3]),1)],e.pushViewport(this.shrunkViewport),super.preDraw(e)}postDraw(e){const t=this.shrunkViewport[2]*this.shrunkViewport[3]*4,i=new Uint8Array(t),s=this.viewer.getGlContext();s.readPixels(0,0,this.shrunkViewport[2],this.shrunkViewport[3],s.RGBA,s.UNSIGNED_BYTE,i),this.points=[];for(let e=0;e<t/4;e++){const t=4*e,s=(0,Xs.Rg)([i[t],i[t+1],i[t+2],i[t+3]],this.viewer.isHighPrecisionSupportedInFragmentShader());if(s===Xs.BG)continue;const n=e%this.shrunkViewport[2]+.5,r=this.shrunkViewport[3]-Math.floor(e/this.shrunkViewport[2])-.5,a=this.fullViewport[0]+n/this.horizontalScale,o=this.fullViewport[1]+r/this.verticalScale;this.points.push([a,o,s])}e.popViewport(),super.postDraw(e)}}class le extends I{constructor(e,t,i){super(e),this.shaderTag="previewBlend",this.inputs.uBaseTexture=t,this.inputs.uPreviewTexture=i,this.blendMode=p.BLEND_ALPHA}justBeforeDraw(e){super.justBeforeDraw(e),this.shader.uniform1f("uPreviewAlpha",Ls().previewAlpha)}}var de=i(76048),ue=i(35589),ge=i(68434);const pe=64,me=function(e){const t=new de.H(0),i=new Uint8Array(4096);for(let e=0;e<4096;++e)i[e]=Math.floor(256*t.random());const s=new mo(e);return s.internalFormat=e.LUMINANCE,s.format=e.LUMINANCE,s.bytes=i,s.width=pe,s.height=pe,s.minificationFilter=e.LINEAR,s.magnificationFilter=e.LINEAR,s.wrapS=e.REPEAT,s.wrapT=e.REPEAT,s};class fe extends I{constructor(e,t){super(e),this.shaderTag="normalDepthFilter",this.blendMode=p.BLEND_OFF,this.inputs.uNormalDepthTexture=t}}class Ie extends I{constructor(e,t,i){super(e),this.shaderTag="occlusion",this.inputs.uNormalDepthTexture=i||t,this.normalDepthPass=t,this.filteredNormalDepthPass=i,this.randomTexture=new Io(this.viewer,me)}drawInputs(e){const t=e.getDetailSettings();this.filteredNormalDepthPass&&t.enableSSAOFilter?this.inputs.uNormalDepthTexture=this.filteredNormalDepthPass:this.inputs.uNormalDepthTexture=this.normalDepthPass,I.prototype.drawInputs.call(this,e)}justBeforeDraw(e){const t=X.default.getManager();super.justBeforeDraw(e),this.shader.useTexture("uRandomTexture",this.randomTexture);const i=e.getViewport(),s=i[2],n=i[3],r=Math.sqrt(s*s+n*n);this.shader.uniform2fv("uRandomTextureScale",[(s-1)/pe,(n-1)/pe]);const a=ge.w$.inverse(e.getProjectionMatrix(),ue.create());a&&this.shader.uniformMatrix4fv("uPMatrixInv_fs",!1,a),this.shader.uniform1f("uIntensity",t.getNumber("AMBIENT_OCCLUSION_INTENSITY")),this.shader.uniform1f("uBias",t.getNumber("AMBIENT_OCCLUSION_BIAS")),this.shader.uniform1f("uScale",t.getNumber("AMBIENT_OCCLUSION_SCALE")),this.shader.uniform1f("uRadiusNear",Math.max(t.getNumber("AMBIENT_OCCLUSION_RADIUS_NEAR")*r,2)),this.shader.uniform1f("uRadiusFar",Math.max(t.getNumber("AMBIENT_OCCLUSION_RADIUS_FAR")*r,2))}}class Ee extends I{constructor(e,t){super(e),this.shaderTag="occlusionFilter",this.blendMode=p.BLEND_OFF,this.inputs.uOcclusionMap=t}}function Se(e){const t=X.default.getManager(),i=B(e,t.getNumber("AMBIENT_OCCLUSION_VIEWPORT_RATIO"),"ssaoBuffer1");let s=null;if(e.isSSAOFilteringSupported()){s=D(e,new fe(e,i),t.getNumber("AMBIENT_OCCLUSION_VIEWPORT_RATIO"),"ssaoFilterBuffer")}const n=D(e,new Ie(e,i,s),t.getNumber("AMBIENT_OCCLUSION_VIEWPORT_RATIO"),"ssaoBuffer2");return D(e,new Ee(e,n),t.getNumber("AMBIENT_OCCLUSION_VIEWPORT_RATIO"),"ssaoBuffer1")}function Te(e,t,i){const n=[],r=!!i.hasOwnProperty("usePickAlternates")&&i.usePickAlternates;return i.primitiveType=s.FACES,n.push(new ie(e,t,i)),r&&n.push(new Xe(e,t,i)),i.primitiveType=s.EDGES,n.push(new ie(e,t,i)),r&&n.push(new Xe(e,t,i)),i.primitiveType=s.POINTS,n.push(new ie(e,t,i)),n}var De;!function(e){e[e.DEPTH_AND_NORMAL=0]="DEPTH_AND_NORMAL",e[e.DEPTH_ONLY=1]="DEPTH_ONLY",e[e.PLANE_ID=2]="PLANE_ID"}(De||(De={}));class Ce extends ie{constructor(e,t,i,n,r,o){super(e,t,i),this.tintOpacity=1,this.tintColor=n,this.matchesCompareColor=r,this.inputs.uCompareBuffer=o,this.tintTestType=De.DEPTH_ONLY,this.primitiveType===s.FACES&&(this.opacity===a.TRANSPARENT?this.tintTestType=De.PLANE_ID:this.tintTestType=De.DEPTH_AND_NORMAL),this.opacity===a.TRANSPARENT&&(this.tintOpacity=X.default.getManager().getNumber("COMPARE_TRANSLUCENT_FACE_OPACITY")),this.tintTestType===De.DEPTH_ONLY&&this.setExtraMeshNodeFilter((function(e){return e.getIsTintedByCompare()}))}getShaderId(){return this.tintTestType===De.PLANE_ID?"-tintByPlaneId-"+this.shaderTag:this.tintTestType===De.DEPTH_AND_NORMAL?"-tintByNormalDepth-"+this.shaderTag:"-tintByDepth-"+this.shaderTag}onShaderActivated(e,t){super.onShaderActivated(e,t),t.uniform3f("uTintColor",this.tintColor[0],this.tintColor[1],this.tintColor[2]),t.uniform1f("uTintOpacity",this.tintOpacity),t.uniform1f("uBlendOverdrawAdjustment",1/(1+vt())),t.uniform3f("uMatchesCompareColor",this.matchesCompareColor[0],this.matchesCompareColor[1],this.matchesCompareColor[2]),this.inputs.uCompareBuffer&&t.useTexture("uCompareBuffer",this.inputs.uCompareBuffer.getColorTexture())}}var Me=i(64880),ye=i(45065);const Ae=X.default.getManager();class Pe extends T{constructor(e,t){super(e),this.mainDrawPass=t,this.TEMP_VEC4=y.create(),this.TEMP_MAT4=ue.create(),this.shaderTag="pick",this.checkFrameId=!1,this.pickBuffer=null,this.pickRect=[0,0,1,1],this.pickViewportWidthHeight=[1,1],this.enablePickViewportScaling=!0,this.oldViewport=[0,0,1,1],this.isBoxSelecting=!1,this.suppressNonIsolatedPicks=!0,this.childrenPerformIsolationTest=null,this.childPassIsolateTests=[],this.nodeFilterOverride=null,this.pickFromPreview=!1,this.pickFrustum=new ur;const i=new Le(this.viewer,this,null,be.PICKING);this.opaqueFacePass=i.opaqueFaces,this.opaqueFaceAlternatePass=new Xe(this.viewer,this,{performIsolationTest:!0}),this.previewStateChangeSubscription=Ls().stateChangedObservable.pipe((0,ye.h)((e=>e===vs.PREVIEW_STATE_CHANGE))).subscribe((()=>this.onPreviewStateChange())),this.childPasses=[],this.childPasses.push(this.opaqueFacePass),this.childPasses.push(this.opaqueFaceAlternatePass),this.childPasses.push(i.stencilWritingOpaqueFaces);const n=new Xe(this.viewer,this,{performIsolationTest:!0,stencilMode:c.WRITE});this.childPasses.push(n),t&&(this.sectionPlaneEndcapDrawPasses=new P(this.viewer,this,t.sectionPlaneEndcapMaskPass),this.childPasses.push(this.sectionPlaneEndcapDrawPasses)),this.transparentFacePass=i.nonOitTransparentFaces,this.transparentFaceAlternatePass=new Xe(this.viewer,this,{opacity:a.TRANSPARENT,performIsolationTest:!0}),this.childPasses.push(this.transparentFacePass),this.childPasses.push(this.transparentFaceAlternatePass),this.childPasses.push(i.sketchImageFaces),this.postOpaqueFaceDepthClearPass=U(this.viewer,this),this.postOpaqueFaceDepthClearPass.setEnabled(!1),this.childPasses.push(this.postOpaqueFaceDepthClearPass),this.opaqueEdgesPass=new ie(this.viewer,this,{primitiveType:s.EDGES,performIsolationTest:!0}),this.opaqueEdgesAlternatesPass=new Xe(this.viewer,this,{primitiveType:s.EDGES,performIsolationTest:!0}),this.childPasses.push(this.opaqueEdgesPass),this.childPasses.push(this.opaqueEdgesAlternatesPass),this.childPasses.push(i.nonOitTransparentEdges),this.childPasses.push(new Xe(this.viewer,this,{primitiveType:s.EDGES,opacity:a.TRANSPARENT,performIsolationTest:!0})),this.opaquePointsPass=i.opaquePoints,this.childPasses.push(this.opaquePointsPass),this.childPasses.push(U(this.viewer,this));for(let e=0;e<Gi.DO.COUNT;++e)this.childPasses.push(i.showThroughStencilTested.getChildPass(e)),this.childPasses.push(i.showThroughNotStencilTested.getChildPass(e)),this.childPasses.push(i.showThroughDepthTested.getChildPass(e));this.childPasses.push(Fe(this.viewer,this)),this.clearColor=Xs.o0;for(let e=0;e<this.childPasses.length;e++)this.childPassIsolateTests[e]=this.childPasses[e].getPerformIsolationTest();this.isolatedNodeOccurrenceFilter=e=>this.viewer.isolateEffectPickFilter(e.occurrenceData)}onSessionEnded(){this.previewStateChangeSubscription.unsubscribe(),super.onSessionEnded()}setPickFromPreview(e){this.pickFromPreview!==e&&(this.pickFromPreview=e,this.onPreviewStateChange())}setPickAlternatesEnabled(e){for(let t=0;t<this.childPasses.length;++t)if(this.childPasses[t]instanceof Xe)this.childPasses[t].setEnabled(e);else if(this.childPasses[t]instanceof H)for(let i=0;i<this.childPasses[t].childPasses.length;++i)this.childPasses[t].childPasses[i]instanceof Xe&&this.childPasses[t].childPasses[i].setEnabled(e)}setPerformIsolationTest(e){if(this.childrenPerformIsolationTest!==e)if(this.childrenPerformIsolationTest=e,this.childrenPerformIsolationTest)for(let e=0;e<this.childPasses.length;e++)this.childPasses[e].setPerformIsolationTest(this.childPassIsolateTests[e]);else for(let e=0;e<this.childPasses.length;e++)this.childPasses[e].setPerformIsolationTest(!1)}setSuppressNonIsolatedPicks(e){this.suppressNonIsolatedPicks=e}setIsBoxSelecting(e){this.isBoxSelecting=e}setRenderingMode(e){const t=this,i=function(e){e?(t.opaqueEdgesPass.setNodeFilter(null),t.opaqueEdgesAlternatesPass.setNodeFilter(null),t.opaquePointsPass.setNodeFilter(null)):(t.opaqueEdgesPass.setNodeFilter(se),t.opaqueEdgesAlternatesPass.setNodeFilter(se),t.opaquePointsPass.setNodeFilter(se))};switch(e){case k.P1.SHADED_WITH_EDGES:case k.P1.DRAFT_ANALYSIS:case k.P1.SHADED_CURVATURE_VISUALIZATION:case k.P1.CURVATURE_VISUALIZATION:case k.P1.SIMULATION_RESULTS:case k.P1.SHADED_WITHOUT_EDGES:this.postOpaqueFaceDepthClearPass.setEnabled(!1),i(!0);break;case k.P1.SHADED_WITH_HIDDEN_EDGES:this.postOpaqueFaceDepthClearPass.setEnabled(!0),i(!0);break;case k.P1.HIDDEN_LINE_REMOVED:this.postOpaqueFaceDepthClearPass.setEnabled(!1),i(!0);break;case k.P1.HIDDEN_LINE_VISIBLE:case k.P1.WIREFRAME:case k.P1.TRANSLUCENT:this.postOpaqueFaceDepthClearPass.setEnabled(!0),i(!0)}}isPickPass(){return!0}setEnablePickViewportScaling(e){this.enablePickViewportScaling=e}getMaxHighResPickViewportSamples(){return Ae.getNumber("MAX_HIGH_RES_PICKING_RECT_SAMPLES")}setPickRect(e,t,i,s,n){this.pickRect=[e,t,i,s];const r=i*s;if(n&&r>n){const e=Math.sqrt(n/r),t=Math.floor((i-1)*e)+1,a=Math.floor((s-1)*e)+1;this.pickViewportWidthHeight=[t,a]}else if(this.enablePickViewportScaling&&r>this.getMaxHighResPickViewportSamples()){const e=Ae.getNumber("LOW_RES_PICKING_RECT_SCALE"),t=1/Math.min(i,s),n=Math.max(e,t),r=Math.floor((i-1)*n)+1,a=Math.floor((s-1)*n)+1;this.pickViewportWidthHeight=[r,a]}else this.pickViewportWidthHeight=[i,s]}getPickRect(){return this.pickRect}getPickViewportWidthHeight(){return this.pickViewportWidthHeight}getPickFrustum(e,t){const i=this.TEMP_VEC4;i[0]=this.pickRect[0]-t,i[1]=this.pickRect[1]-t,i[2]=this.pickRect[2]+2*t,i[3]=this.pickRect[3]+2*t;const s=(0,wi.zL)(i,e.getViewport(),e.getActiveCamera().getCanvasHeight()),n=ge.w$.multiply(s,e.getProjectionMatrix(),this.TEMP_MAT4);return this.pickFrustum.updateClippingPlanes(e.getModelViewMatrix(),n),this.pickFrustum}preDraw(e){e.setNodeOccurrenceFilterFunction(this.isolatedNodeOccurrenceFilter);const t=this.getAllowedSelections(),i=this.suppressNonIsolatedPicks||!1===t.allowsNonModifiableGeometry;this.setPerformIsolationTest(i),this.oldViewport=e.getViewport();const s=(0,wi.zL)(this.pickRect,this.oldViewport,e.getActiveCamera().getCanvasHeight()),n=ge.w$.multiply(s,e.getProjectionMatrix(),this.TEMP_MAT4);return e.pushProjectionMatrix(n),e.pushViewport([0,0,this.pickViewportWidthHeight[0],this.pickViewportWidthHeight[1]]),super.preDraw(e)}getAllowedSelections(){return this.isBoxSelecting?(0,Me.Ac)():(0,Me.y0)()}setNodeFilterOverride(e){this.nodeFilterOverride=e||null}nodeFilter(e){if(this.nodeFilterOverride)return this.nodeFilterOverride(e);const t=this.getAllowedSelections(),i=this.viewer.getModelViewManagers().getManagerForUsage(this.getUsage());if(t&&i.isNodeForModel(e)){const s=e.getParent();if(!1===t.allowsBodies&&!1===t.allowsSketchEntities&&i.isNodeForSketch(s))return!1;if(!1===t.allowsBodyEntities&&!1===t.allowsBodies&&i.isNodeForBody(s))return!1;if(e.isMeshNode()){if(!1===t.allowsBodies&&!1===t.allowsEdges&&i.isNodeForEdges(e))return!1;if(!1===t.allowsBodies&&!1===t.allowsVertices&&i.isNodeForPoints(e))return!1}}return e.getIsPickable()}postDraw(e){e.setNodeOccurrenceFilterFunction(null);const t=this.pickViewportWidthHeight[0]*this.pickViewportWidthHeight[1],i=4*t;(!this.pickBuffer||this.pickBuffer.length<i)&&(this.pickBuffer=new Uint8Array(i));const s=this.viewer.getGlContext();s.readPixels(0,0,this.pickViewportWidthHeight[0],this.pickViewportWidthHeight[1],s.RGBA,s.UNSIGNED_BYTE,this.pickBuffer),this.hitlist=new Uint32Array(t);for(let e=0;e<t;e++){const t=4*e,i=(0,Xs.EI)(this.pickBuffer[t],this.pickBuffer[t+1],this.pickBuffer[t+2],this.pickBuffer[t+3]);this.hitlist[e]=i}e.popProjectionMatrix(),e.popViewport(),super.postDraw(e)}getPositionForPickHit(e){const t=this.pickRect[0],i=this.pickRect[1],s=this.pickRect[2],n=this.pickRect[3],r=s/this.pickViewportWidthHeight[0],a=n/this.pickViewportWidthHeight[1],o=e%this.pickViewportWidthHeight[0]*r,h=Math.floor(e/this.pickViewportWidthHeight[0])*a;return Q.fromValues(t+o,i+(n-1-h))}getSceneGraph(){return this.pickFromPreview?this.viewer.getSceneGraphs().getPreviewSceneGraph():this.viewer.getSceneGraphs().getMainSceneGraph()}getUsage(){return this.pickFromPreview?ys.L.PREVIEW:ys.L.BASE}onPreviewStateChange(){this.sectionPlaneEndcapDrawPasses&&this.sectionPlaneEndcapDrawPasses.setEndcapMaskPass(this.mainDrawPass.getSectionEndcapMaskPassForPicking(this.pickFromPreview))}}const Oe=X.default.getManager();function Re(e,t,i,s,n,r,a,o){let h=e[t];h||(h={},e[t]=h);let c=h[i.toString()];c?c.incorporateLocation(s):(c=new gI.D(i,t,s,n),h[i.toString()]=c),c.distance=Math.min(c.distance,ge.gv.length(ge.gv.subtract(s,r,Q.create()))*a),c.coverage+=o}class we extends Pe{constructor(e,t){super(e,t),this.primitivePickIds=[],this.occurrencePickIds=[],this.primitiveIdPool=[],this.currentPass=0,this.pickMask=null}setEmptyHitList(){this.hitlist=void 0;const e=this.pickRect[2]*this.pickRect[3],t=Mi.JE.slice(0);for(let i=0;i<e;++i)this.primitivePickIds[i]=t,this.occurrencePickIds[i]=TE.Qy}getPickIteration(){return this.currentPass}justBeforeDraw(e){e.getActiveShader().uniform1f("uPickPassIteration",this.getPickIteration())}draw(e){if(this.primitiveIdPool=this.primitivePickIds,this.primitivePickIds=[],this.occurrencePickIds=[],!this.enabled)return void this.setEmptyHitList();e.setActivePass(this);const t=[];let i,s;for(i=this.viewer.getPickPassCount()-1;i>=0;--i)this.currentPass=i,super.draw(e),t.unshift(this.hitlist);if(t.length<1)return void this.setEmptyHitList();const n=t[0].length;for(i=0;i<n;++i){const e=this.primitiveIdPool.length>0?this.primitiveIdPool.pop():[];let n=0,r=-1;for(s=0;s<t.length;++s){const a=t[s][i],o=a&Mi.U2.ENTITY;o!==Mi.vN&&(e[s]=o,r=s);n|=(a>>>Mi._6.ENTITY&Mi.U2.OCCURRENCE_SLICE)<<s*Mi._6.OCCURRENCE_SLICE}e.length!==r+1&&(e.length=r+1),this.primitivePickIds.push((0,Mi.qR)(e)),this.occurrencePickIds.push(n)}}gatherPicksFromPickPass(){const e=this.getUsage(),t={};let i,s,n;const r=this.getPickRect(),a=r[2],o=r[3],h=[r[0]+.5*a,r[1]+.5*o],c=this.getPickViewportWidthHeight(),l=2/Math.sqrt((a-1)*(a-1)+(o-1)*(o-1)),d=1/(c[0]*c[1]);for(let n=0;n<this.primitivePickIds.length;++n){if(null!==this.pickMask&&0!==this.pickMask[n])continue;const r=this.getPositionForPickHit(n);s=this.primitivePickIds[n],i=this.occurrencePickIds[n],(0,Mi.rp)(s)&&i!==TE.Qy&&Re(t,i,s,r,e,h,l,d)}for(i in t)for(s in n=t[i],n)n[s].determineBestLocation();return t}clearPickMask(){this.pickMask=null}updatePickMask(e,t,i){this.pickMask||(this.pickMask=new Uint8Array(this.primitivePickIds.length));let s,n=!1;for(s=0;s<this.primitivePickIds.length;++s){if(0!==this.pickMask[s])continue;const r=this.primitivePickIds[s],a=this.occurrencePickIds[s];if(!(0,Mi.rp)(r)||a===TE.Qy)this.pickMask[s]=1;else for(let o=0;o<e.length;++o){const h=e[o];if((0,Mi.nD)(r,h.primitiveId)&&a===h.pickedOccurrenceId){h.canPickThrough(t,this.viewer,i)?n=!0:this.pickMask[s]=1;break}}}return!n}}class ve extends we{constructor(e){super(e,null),this.childPasses=[],this.sceneGraph=null;for(let e=0;e<Gi.DO.COUNT;++e)this.childPasses.push(new H(this.viewer,this,{visibility:o.SHOWTHROUGH,usePickAlternates:!0,disableDepthTest:!0,priority:e}))}getMaxHighResPickViewportSamples(){return Oe.getNumber("MAX_INFERENCE_PICKING_RECT_SAMPLES")}setSceneGraph(e){this.sceneGraph=e}getSceneGraph(){return this.sceneGraph}setPerformIsolationTest(e){}}var _e=i(60559);const Ne=_e.O.createLogger("DefaultPasses",k.bVy.GRAPHICS);var be;!function(e){e[e.RENDERING=0]="RENDERING",e[e.HUD=1]="HUD",e[e.ISOLATION=2]="ISOLATION",e[e.PICKING=3]="PICKING"}(be||(be={}));class Le extends f{constructor(e,t,i,n,r){super(e,t),this.defaultPassUsage=n,this.opaqueFaces=null,this.stencilWritingOpaqueFaces=null,this.opaqueFacesZebraStripes=null,this.draftAnalysisFaces=null,this.qualityVisualization=null,this.opaqueEdges=null,this.silhouettes=null,this.opaquePoints=null,this.nonOitTransparentFaces=null,this.transparentPass=null,this.nonOitTransparentEdges=null,this.depthFaces=null,this.depthTransparentFaces=null,this.depthEdges=null,this.showThroughStencilTested=null,this.showThroughNotStencilTested=null,this.showThroughDepthTested=null,this.sectionPlaneEndcapEdge=null,this.sectionPlaneEndcapMask=null,this.sectionPlaneEndcap=null,this.sketchImageFaces=null,this.isolatePass=null,this.contextPass=null,this.compareTransparentFaces=null,this.compareTintedEdges=null,this.compareTintedPoints=null;const l=t.isPickPass(),d=new ie(e,t,{performIsolationTest:!r}),u=new ie(e,t,{performIsolationTest:!r,shaderTagSuffix:"-nosection"}),g=new lA(e,d,u,lD.eQ);g.setSceneGraph(i),this.opaqueFaces=g;const p=X.default.getManager();this.stencilWritingOpaqueFaces=new ie(e,t,{stencilMode:c.WRITE,performIsolationTest:!r});const m=new ie(e,t,{facesShader:h.ZEBRA_STRIPES,sceneGraph:i,performIsolationTest:!r,extraShaderUniforms:[{name:"uStripeCount",value:p.getNumber("ZEBRA_STRIPE_COUNT")},{name:"uStripeRotation",value:p.getNumber("ZEBRA_STRIPE_ROTATION")},{name:"uFilterWidth",value:p.getNumber("ZEBRA_STRIPE_FILTER_WIDTH")},{name:"uRespectOrthographic",value:p.getNumber("ZEBRA_STRIPE_RESPECT_ORTHOGRAPHIC")}]});this.opaqueFacesZebraStripes=m;const I=new Pt(e,t,!r,i);this.draftAnalysisFaces=I,this.qualityVisualization=new ne(e,t,!r,i);const E=new K(e,t,{primitiveType:s.EDGES,performIsolationTest:!r,sceneGraph:i});this.opaqueEdges=E,l||(this.silhouettes=new Bt(e,t,i));const S=new ie(e,t,{primitiveType:s.POINTS,performIsolationTest:!r});S.setSceneGraph(i),this.opaquePoints=S;const T=new ie(e,t,{primitiveType:s.FACES,opacity:a.TRANSPARENT,performIsolationTest:!r}),D=new ie(e,t,{primitiveType:s.FACES,opacity:a.TRANSPARENT,performIsolationTest:!r,shaderTagSuffix:SI}),C=new lA(e,T,D,lD.eQ);if(C.setSceneGraph(i),this.nonOitTransparentFaces=C,e.supportsOrderIndependentTranslucency()){const s=new Ve(e,t,i);s.setPerformIsolationTest(!r),C.performIsolationTest=!r,this.transparentPass=new dA(e,s,C,Xs.Z)}else this.transparentPass=C;const M=new ie(e,t,{primitiveType:s.EDGES,opacity:a.TRANSPARENT,stencilMode:c.OFF,clipToSectionPlanes:!1,performIsolationTest:!r});M.setSceneGraph(i),this.nonOitTransparentEdges=M;const y=new ie(e,t,{primitiveType:s.FACES,disableColorWrites:!0});y.setSceneGraph(i),this.depthFaces=y,this.depthTransparentFaces=new Vt(e,t,i,!r);const A=new ie(e,t,{primitiveType:s.EDGES,disableColorWrites:!0});A.setSceneGraph(i),this.depthEdges=A;const O=new f(e,t);for(let s=0;s<Gi.DO.COUNT;++s){const n=new H(e,t,{visibility:o.SHOWTHROUGH,disableDepthTest:!0,stencilMode:c.TEST,priority:s,sceneGraph:i,usePickAlternates:l,performIsolationTest:!r});O.addChildPass(n)}this.showThroughStencilTested=O;const R=new f(e,t);for(let s=0;s<=Gi.DO.HIGHEST;++s){const n=new H(e,t,{disableDepthTest:!0,visibility:o.SHOWTHROUGH,priority:s,sceneGraph:i,usePickAlternates:l});R.addChildPass(n)}this.showThroughNotStencilTested=R;const w=new f(e,t);for(let s=0;s<=Gi.DO.HIGHEST;++s){const n=new H(e,t,{visibility:o.SHOWTHROUGH,priority:s,sceneGraph:i,usePickAlternates:l});w.addChildPass(n)}this.showThroughDepthTested=w;const v=new Be(e,i),N=new _(e,v);this.sectionPlaneEndcapEdge=N,this.sectionPlaneEndcapMask=v,this.sectionPlaneEndcap=new P(e,t,v,N);const b=new ie(e,t,{primitiveType:s.FACES,opacity:a.TRANSPARENT,disableDepthTest:!0,sceneGraph:i,performIsolationTest:!r});this.sketchImageFaces=b,n===be.RENDERING&&(this.isolatePass=new ot(e,t,!1,i),this.contextPass=new ot(e,t,!0,i))}setBlendFilter(e){this.opaqueFaces.setBlendFilter(e),this.opaqueFacesZebraStripes.setBlendFilter(e),this.draftAnalysisFaces.setBlendFilter(e),this.qualityVisualization.setBlendFilter(e),this.sketchImageFaces.setBlendFilter(e),this.opaqueEdges.setBlendFilter(e),this.silhouettes.setBlendFilter(e),this.depthTransparentFaces.setBlendFilter(e),this.transparentPass.setBlendFilter(e),this.nonOitTransparentEdges.setBlendFilter(e),this.opaquePoints.setBlendFilter(e),this.isolatePass&&this.isolatePass.setBlendFilter(e),this.contextPass&&this.contextPass.setBlendFilter(e),this.showThroughStencilTested.setBlendFilter(e),this.showThroughNotStencilTested.setBlendFilter(e),this.showThroughDepthTested.setBlendFilter(e),this.depthFaces.setBlendFilter(e),this.depthEdges.setBlendFilter(e)}setHideSelectionInterior(e){this.opaqueFaces.setHideSelectionInterior(e),this.transparentPass.setHideSelectionInterior(e),this.draftAnalysisFaces.setHideSelectionInterior(e),this.qualityVisualization.setHideSelectionInterior(e),this.isolatePass&&this.isolatePass.setHideSelectionInterior(e),this.contextPass&&this.contextPass.setHideSelectionInterior(e)}setRenderingMode(e){switch(this.isolatePass&&this.isolatePass.setRenderingMode(e),this.contextPass&&this.contextPass.setRenderingMode(e),e){case k.P1.SHADED_WITH_EDGES:case k.P1.SIMULATION_RESULTS:case k.P1.THICKNESS_ANALYSIS_VISUALIZATION:this.enableOpaqueFaces(!0,!0,h.OPAQUE),this.enableEdges(!0,!1,!0),this.viewer.supportsOrderIndependentTranslucency()&&(this.enableFullOpacity(!1),this.adjustTransparentFacePass(!1,null,a.OPAQUE,!0));break;case k.P1.SHADED_WITHOUT_EDGES:this.enableOpaqueFaces(!0,!0,h.OPAQUE),this.enableEdges(!1,!1,!1),this.viewer.supportsOrderIndependentTranslucency()&&(this.enableFullOpacity(!1),this.adjustTransparentFacePass(!1,null,a.OPAQUE,!0));break;case k.P1.SHADED_WITH_HIDDEN_EDGES:this.enableOpaqueFaces(!0,!0,h.OPAQUE),this.enableEdges(!0,!0,!0),this.viewer.supportsOrderIndependentTranslucency()&&(this.enableFullOpacity(!1),this.adjustTransparentFacePass(!1,null,a.OPAQUE,!0));break;case k.P1.HIDDEN_LINE_REMOVED:this.enableOpaqueFaces(!0,!1,h.OPAQUE),this.enableEdges(!0,!1,!0),this.viewer.supportsOrderIndependentTranslucency()&&(this.enableFullOpacity(!0),this.adjustTransparentFacePass(!1,this.createExcludeForBodyFilter(),a.ALL,!0));break;case k.P1.HIDDEN_LINE_VISIBLE:this.enableOpaqueFaces(!0,!1,h.OPAQUE),this.enableEdges(!0,!0,!0),this.viewer.supportsOrderIndependentTranslucency()&&(this.enableFullOpacity(!0),this.adjustTransparentFacePass(!1,this.createExcludeForBodyFilter(),a.ALL,!0));break;case k.P1.WIREFRAME:this.enableOpaqueFaces(!1,!1,h.OPAQUE),this.enableEdges(!0,!1,!0),this.viewer.supportsOrderIndependentTranslucency()&&(this.enableFullOpacity(!1),this.adjustTransparentFacePass(!1,this.createExcludeForBodyFilter(),a.OPAQUE,!1));break;case k.P1.TRANSLUCENT:this.enableOpaqueFaces(!1,!0,h.OPAQUE),this.enableEdges(!0,!1,!1),this.enableFullOpacity(!1),this.adjustTransparentFacePass(!0,null,a.OPAQUE,!0);break;case k.P1.SHADED_CURVATURE_VISUALIZATION:this.enableOpaqueFaces(!0,!0,h.OPAQUE),this.enableEdges(!0,!1,!0),this.viewer.supportsOrderIndependentTranslucency()&&(this.enableFullOpacity(!1),this.adjustTransparentFacePass(!1,null,a.OPAQUE,!0));break;case k.P1.CURVATURE_VISUALIZATION:this.enableOpaqueFaces(!0,!0,h.ZEBRA_STRIPES),this.enableEdges(this.viewer.getZebraStripeEdgesOn(),!1,!0),this.enableFullOpacity(!0),this.viewer.supportsOrderIndependentTranslucency()&&this.adjustTransparentFacePass(!1,this.createExcludeForBodyFilter(),a.ALL,!0);break;case k.P1.DRAFT_ANALYSIS:this.enableOpaqueFaces(!0,!0,h.DRAFT),this.enableEdges(!0,!1,!0),this.viewer.supportsOrderIndependentTranslucency()&&(this.enableFullOpacity(!0),this.adjustTransparentFacePass(!1,this.createExcludeForBodyFilter(),a.ALL,!0));break;case k.P1.DEBUG_QUALITY_VISUALIZATION:this.enableOpaqueFaces(!0,!0,h.QUALITY_VISUALIZATION),this.enableEdges(!0,!1,!0),this.viewer.supportsOrderIndependentTranslucency()&&(this.enableFullOpacity(!0),this.adjustTransparentFacePass(!1,this.createExcludeForBodyFilter(),a.ALL,!0))}}enableEdges(e,t,i){this.opaqueEdges.setDrawVisibleParts(e),this.silhouettes.setEnabled(e),this.opaqueEdges.setDrawHidden(t),this.silhouettes.setDrawHidden(t),this.silhouettes.setDrawBackFaceSilhouettes(i),this.supportsOrderIndependentTransparency()&&(this.transparentPass.setEdgesEnabled(e),this.transparentPass.setShouldEnableSilhouettes(e))}enableOpaqueFaces(e,t,i){let s;switch(i){case h.OPAQUE:s=this.opaqueFaces;break;case h.DRAFT:s=this.draftAnalysisFaces;break;case h.QUALITY_VISUALIZATION:s=this.qualityVisualization;break;case h.ZEBRA_STRIPES:s=this.opaqueFacesZebraStripes}const n=this.getFacePasses();for(let i=0;i<n.length;++i){const r=n[i];r===s?(r.setEnabled(e),r.setEnableColorWrites(t)):r.setEnabled(!1)}}enableFullOpacity(e){let t,i,s;e?(t=a.ALL,i=this.createExcludeForNonBodyFilter(),s=this.createExcludeForNonBodyFilterNoDecals()):(t=a.OPAQUE,i=null,s=null);const n=this.getFacePasses();for(let e=0;e<n.length;++e)n[e].setOpacity(t),n[e]===this.opaqueFaces?n[e].setExtraMeshNodeFilter(i):n[e].setExtraMeshNodeFilter(s)}supportsOrderIndependentTransparency(){return this.viewer.supportsOrderIndependentTranslucency()}adjustTransparentFacePass(e,t,i,s){this.defaultPassUsage!==be.ISOLATION&&(this.supportsOrderIndependentTransparency()?(this.transparentPass.setExtraFaceMeshNodeFilter(t),this.transparentPass.appliesTranslucentAlphaToAll(e),this.transparentPass.setDepthOpacity(i),this.transparentPass.setDepthPassEnabled(s)):this.transparentPass instanceof ie?this.transparentPass.setExtraMeshNodeFilter(t):Ne.warn("No valid transparentPass to adjust"))}enableTransparentDepth(e){this.depthTransparentFaces.setEnabled(e),e?this.depthTransparentFaces.setNodeFilter(this.createExcludeForNonBodyFilter()):this.depthTransparentFaces.setNodeFilter(null)}getFacePasses(){return[this.opaqueFaces,this.opaqueFacesZebraStripes,this.draftAnalysisFaces,this.qualityVisualization]}setZebraStripeCount(e){this.opaqueFacesZebraStripes.setShaderUniform("uStripeCount",e),this.contextPass?.setZebraStripeCount(e),this.isolatePass?.setZebraStripeCount(e)}setZebraStripeRotation(e){this.opaqueFacesZebraStripes.setShaderUniform("uStripeRotation",e),this.contextPass?.setZebraStripeRotation(e),this.isolatePass?.setZebraStripeRotation(e)}disableNonOitTransparentEdgesForBodies(){this.viewer.supportsOrderIndependentTranslucency()&&this.nonOitTransparentEdges.setExtraMeshNodeFilter(this.createExcludeForBodyFilter())}}function Fe(e,t){return new b(e,t)}function xe(e,t,i,s){const n=D(e,new G(e,t),i,s);return n.clearColor=x,n}class Be extends T{constructor(e,t){super(e),this.checkFrameId=!0,this.shaderTag="endcapMask",this.frameBuffer=null,this.childPasses=[],this.childPasses.push(new ut(this.viewer,this,t));const i=this.viewer.getIsolatedOccurrenceManager();this.fullyTransparentGhostedNodeOccurrenceFilter=e=>{if(e.occurrenceData.getIsolated())return!0;return this.viewer.getModelViewManagers().getManager().isOccurrenceIdForInContext(e.occurrenceData.getOccurrenceId())?!(0===i?.getContextTransparencyMultiplier()):!(i?.isInIsolateOrMakeTransparentMode()&&i?.getIsIsolateFullyTransparent())}}shouldCheckSectionPlaneCount(){return!0}forSectionPlaneEndcapMask(){return!0}preDraw(e){if(!this.frameBuffer){const e=this.viewer.getGlContext();this.frameBuffer=this.viewer.getOrCreateFrameBuffer(this.viewer.getHighPrecisionFloatTextureType(),void 0,{storageType:e.DEPTH_STENCIL,attachmentType:e.DEPTH_STENCIL_ATTACHMENT})}if(this.shouldCheckSectionPlaneCount()&&0===(0,lD.ti)())return!1;if(!super.preDraw(e))return!1;const t=this.viewer.getGlContext();t.disable(t.DEPTH_TEST),t.blendFunc(t.ONE,t.ONE),t.enable(t.BLEND),e.setOverrideFaceCullingMode(bh.NONE);const i=this.viewer.getIsolatedOccurrenceManager();return(i?.isInIsolateOrMakeTransparentMode()&&i?.getIsIsolateFullyTransparent()||(0,Me.Eo)()&&0===i?.getContextTransparencyMultiplier())&&e.setNodeOccurrenceFilterFunction(this.fullyTransparentGhostedNodeOccurrenceFilter),!0}postDraw(e){super.postDraw(e);const t=this.viewer.getGlContext();t.enable(t.DEPTH_TEST),t.disable(t.BLEND),e.clearOverrideFaceCullingMode(),e.setNodeOccurrenceFilterFunction(null)}}class Ve extends f{setDrawNonIsolated(e){this.drawNonIsolated=e,this.updateSilhouetteEnabled()}setShouldEnableSilhouettes(e){this.shouldEnableSilhouettes=e,this.updateSilhouetteEnabled()}updateSilhouetteEnabled(){const e=this.drawNonIsolated&&this.shouldEnableSilhouettes;this.accumulationPass.colorPass.setSilhouettesEnabled(e),this.revealagePass.colorPass.setSilhouettesEnabled(e)}setEdgesEnabled(e){this.accumulationPass.colorPass.setEdgesEnabled(e),this.revealagePass.colorPass.setEdgesEnabled(e)}constructor(e,t,i,a){super(e,t),this.childPasses=[],this.applyTranslucentAlphaToAll=!1,this.blendFilter=n.ALL,this.sceneGraph=i;const o=new ie(this.viewer,t,{primitiveType:s.FACES,disableColorWrites:!0,performIsolationTest:!0}),h=new ie(this.viewer,t,{primitiveType:s.FACES,disableColorWrites:!0,performIsolationTest:!0,shaderTagSuffix:SI}),c=new lA(e,o,h,lD.eQ);c.setCheckFrameId(!0),this.accumulationPass=new qe(this.viewer,r.ACCUMULATION,c),this.revealagePass=new qe(this.viewer,r.REVEALAGE,c),this.compositePass=new Ue(this.viewer,this.accumulationPass,this.revealagePass,i,a),this.setSceneGraph(i),this.childPasses.push(this.compositePass)}appliesTranslucentAlphaToAll(e){this.applyTranslucentAlphaToAll=e,this.accumulationPass.appliesTranslucentAlphaToAll(e),this.revealagePass.appliesTranslucentAlphaToAll(e)}setSceneGraph(e){this.sceneGraph=e,this.accumulationPass.setSceneGraph(e),this.revealagePass.setSceneGraph(e),this.compositePass.setSceneGraph(e)}getSceneGraph(){return this.sceneGraph?this.sceneGraph:super.getSceneGraph()}setBlendFilter(e){this.blendFilter=e,this.accumulationPass.setBlendFilter(e),this.revealagePass.setBlendFilter(e)}setDepthPassEnabled(e){this.accumulationPass.setDepthPassEnabled(e),this.revealagePass.setDepthPassEnabled(e)}setDepthOpacity(e){this.accumulationPass.setDepthOpacity(e),this.revealagePass.setDepthOpacity(e)}setExtraFaceMeshNodeFilter(e){this.accumulationPass.setExtraFaceMeshNodeFilter(e),this.revealagePass.setExtraFaceMeshNodeFilter(e)}setTintColor(e){this.accumulationPass.setTintColor(e)}setTintFactor(e){this.accumulationPass.setTintFactor(e)}setHideSelectionInterior(e){this.accumulationPass.setHideSelectionInterior(e)}setPerformIsolationTest(e){this.accumulationPass.setPerformIsolationTest(e),this.revealagePass.setPerformIsolationTest(e)}}class Ue extends I{constructor(e,t,i,s,n){super(e),this.shaderTag="OITComposite",this.inputs.uAccumulationBuffer=t,this.inputs.uRevealageBuffer=i,this.sceneGraph=s;const r=this.viewer.getGlContext(),a={id:"transparency",storageType:r.DEPTH_COMPONENT16,attachmentType:r.DEPTH_ATTACHMENT};n=n||"";const o=this.viewer.getOrCreateFrameBuffer(this.viewer.getDefaultFloatTextureType(),n+"TranslucentBufferAccumulation",a),h=this.viewer.getOrCreateFrameBuffer(r.UNSIGNED_BYTE,n+"TranslucentBufferRevealage",a);this.inputs.uAccumulationBuffer.setFrameBuffer(o),this.inputs.uRevealageBuffer.setFrameBuffer(h)}setSceneGraph(e){this.sceneGraph=e}getSceneGraph(){return this.sceneGraph?this.sceneGraph:super.getSceneGraph()}}const He=X.default.getManager(),Ge=a,ke=s,We=function(e,t,i,s,n,r){const a=new Ve(e,t,i,r);return a.setTintColor(s),a.setTintFactor(n),a};class ze extends W{constructor(e,t){super(e,t),this.overBlendColorNeedsUpdate=!0;const i=this.viewer.getSceneGraphs().getPreviewSceneGraph(),s=He.getColor("COMPARE_BASE_TINT").slice(0,3),r=He.getColor("COMPARE_TARGET_TINT").slice(0,3),a=He.getColor("COMPARE_SAME_LIT_TINT").slice(0,3),o=He.getColor("COMPARE_SAME_UNLIT_TINT").slice(0,3);this.underDepthPass=xe(this.viewer,null,1),this.existsInBothDepthPass=xe(this.viewer,this.underDepthPass,1),this.underPlaneIdPass=D(this.viewer,new Tt(this.viewer,this,null),1),this.existsInBothPlaneIdPass=D(this.viewer,new Tt(this.viewer,this,this.underPlaneIdPass),1),this.baseDefaultPasses.opaqueFaces=new Ce(this.viewer,this,{},s,a,this.existsInBothDepthPass),this.compareDefaultPasses.opaqueFaces=new Ce(this.viewer,this,{sceneGraph:i},r,a,this.existsInBothDepthPass),this.viewer.supportsOrderIndependentTranslucency()&&(this.baseDefaultPasses.transparentPass=We(this.viewer,this,null,s,1,"CompareBase"),this.compareDefaultPasses.transparentPass=We(this.viewer,this,i,r,1,"CompareTarget")),this.baseDefaultPasses.opaqueEdges.setExtraMeshNodeFilter((function(e){return!e.getIsTintedByCompare()})),this.compareDefaultPasses.opaqueEdges.setExtraMeshNodeFilter((function(e){return!e.getIsTintedByCompare()})),this.baseDefaultPasses.opaquePoints.setExtraMeshNodeFilter((function(e){return!e.getIsTintedByCompare()})),this.compareDefaultPasses.opaquePoints.setExtraMeshNodeFilter((function(e){return!e.getIsTintedByCompare()})),this.baseDefaultPasses.compareTransparentFaces=new Ce(this.viewer,this,{opacity:Ge.TRANSPARENT},s,o,this.existsInBothPlaneIdPass),this.compareDefaultPasses.compareTransparentFaces=new Ce(this.viewer,this,{sceneGraph:i,opacity:Ge.TRANSPARENT},r,o,this.existsInBothPlaneIdPass),this.baseDefaultPasses.compareTintedEdges=new Ce(this.viewer,this,{primitiveType:ke.EDGES},s,o,this.existsInBothDepthPass),this.baseDefaultPasses.compareTintedPoints=new Ce(this.viewer,this,{primitiveType:ke.POINTS},s,o,this.existsInBothDepthPass),this.compareDefaultPasses.compareTintedEdges=new Ce(this.viewer,this,{sceneGraph:i,primitiveType:ke.EDGES},r,o,this.existsInBothDepthPass),this.compareDefaultPasses.compareTintedPoints=new Ce(this.viewer,this,{sceneGraph:i,primitiveType:ke.POINTS},r,o,this.existsInBothDepthPass);const h=function(e,t,i,s){const r=[];let a;for(r.push(i.opaqueFaces),r.push(i.opaqueFacesZebraStripes),r.push(i.draftAnalysisFaces),r.push(i.qualityVisualization),r.push(i.transparentPass),r.push(i.sketchImageFaces),r.push(i.compareTransparentFaces),r.push(i.opaqueEdges),r.push(i.silhouettes),r.push(i.compareTintedEdges),r.push(new re(e,t,!1,s)),r.push(i.opaquePoints),r.push(i.compareTintedPoints),r.push(new oe(e,s,!0)),r.push(new V(e,t)),a=0;a<=Gi.DO.DEFAULT;++a)r.push(i.showThroughNotStencilTested.getChildPass(a)),r.push(i.showThroughDepthTested.getChildPass(a));for(r.push(new oe(e,s,!1)),a=Gi.DO.HIGHER;a<=Gi.DO.HIGHEST;++a)r.push(i.showThroughNotStencilTested.getChildPass(a)),r.push(i.showThroughDepthTested.getChildPass(a));return i.showThroughNotStencilTested.setBlendFilter(n.BLEND_ONLY),i.showThroughDepthTested.setBlendFilter(n.BLEND_ONLY),r};this.underBasePass=new f(this.viewer,this),this.underBasePass.childPasses=h(this.viewer,this.underBasePass,this.baseDefaultPasses,ys.L.BASE),this.underComparePass=new f(this.viewer,this),this.underComparePass.childPasses=h(this.viewer,this.underComparePass,this.compareDefaultPasses,ys.L.PREVIEW),this.overBufferPass=new T(this.viewer),this.overBufferPass.clearColor=[1,1,1,1],this.overBufferPass.childPasses=[];for(let e=0;e<this.underBasePass.childPasses.length;++e)this.overBufferPass.childPasses.push(this.underBasePass.childPasses[e]),this.overBufferPass.childPasses.push(this.underComparePass.childPasses[e]);this.compareBlendPass=new Ye(this.viewer,this.overBufferPass),this.previewBlendChangedSubscription=Ls().stateChangedObservable.pipe((0,ye.h)((e=>e===vs.PREVIEW_BLEND_CHANGE))).subscribe((()=>this.onStateChange())),this.listenTo(this.viewer.getEventDispatcher(),nM.so,this.onSessionEnded),this.setBlendFilters()}onSessionEnded(){this.previewBlendChangedSubscription.unsubscribe(),super.onSessionEnded()}onStateChange(){this.enabled&&(0,Xs.vm)()}drawInputs(e){let t;if(xs()<.5){for(t=0;t<this.underDepthPass.childPasses.length;++t)this.underDepthPass.childPasses[t].setSceneGraph(this.viewer.getSceneGraphs().getMainSceneGraph()),this.existsInBothDepthPass.childPasses[t].setSceneGraph(this.viewer.getSceneGraphs().getPreviewSceneGraph());this.underPlaneIdPass.childPasses[0].setSceneGraph(this.viewer.getSceneGraphs().getMainSceneGraph()),this.existsInBothPlaneIdPass.childPasses[0].setSceneGraph(this.viewer.getSceneGraphs().getPreviewSceneGraph()),this.childPasses=[this.underBasePass,this.compareBlendPass]}else{for(t=0;t<this.underDepthPass.childPasses.length;++t)this.underDepthPass.childPasses[t].setSceneGraph(this.viewer.getSceneGraphs().getPreviewSceneGraph()),this.existsInBothDepthPass.childPasses[t].setSceneGraph(this.viewer.getSceneGraphs().getMainSceneGraph());this.underPlaneIdPass.childPasses[0].setSceneGraph(this.viewer.getSceneGraphs().getPreviewSceneGraph()),this.existsInBothPlaneIdPass.childPasses[0].setSceneGraph(this.viewer.getSceneGraphs().getMainSceneGraph()),this.childPasses=[this.underComparePass,this.compareBlendPass]}f.prototype.drawInputs.call(this,e)}setZebraStripeCount(e){this.baseDefaultPasses.setZebraStripeCount(e),this.compareDefaultPasses.setZebraStripeCount(e)}setZebraStripeRotation(e){this.baseDefaultPasses.setZebraStripeRotation(e),this.compareDefaultPasses.setZebraStripeRotation(e)}preDraw(e){if(this.overBlendColorNeedsUpdate){const e=this.viewer.$el.css("background-color");this.overBufferPass.clearColor=X.default.getManager().parseColor(e),this.overBlendColorNeedsUpdate=!1}return super.preDraw(e)}}class Xe extends ie{constructor(e,t,i){super(e,t,i),this.enabled=!1,this.shaderTag="alternates-"+this.shaderTag}usesShader(){return!0}preDraw(e){return this.initializeShader(),e.setPickPrimitiveAlternates(!0),super.preDraw(e)}postDraw(e){return e.setPickPrimitiveAlternates(!1),super.postDraw(e)}}class Ze extends Pe{constructor(e){super(e,null),this.shaderTag="depth",this.points=[],this.includePlanes=!0,this.childPasses=[],this.previewPasses=[],this.clearColor=Xs.XD;for(let e=0;e<this.childPasses.length;++e)this.childPasses[e].destroy();this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.FACES,performIsolationTest:!0})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.FACES,opacity:a.TRANSPARENT,performIsolationTest:!0}));const t=function(e){return e.getParent().getId()===Vm},i=new ie(this.viewer,this,{primitiveType:s.EDGES,performIsolationTest:!0,extraShaderUniforms:[{name:"uUsePrimitiveSize",value:1}]});i.setExtraMeshNodeFilter(t),this.childPasses.push(i);const n=new ie(this.viewer,this,{primitiveType:s.POINTS,performIsolationTest:!0,extraShaderUniforms:[{name:"uUsePrimitiveSize",value:1}]});n.setExtraMeshNodeFilter(t),this.childPasses.push(n);const r=new ie(this.viewer,this,{performIsolationTest:!0});r.setSceneGraph(this.viewer.getSceneGraphs().getPreviewSceneGraph()),this.childPasses.push(r),this.previewPasses.push(r);const o=new ie(this.viewer,this,{opacity:a.TRANSPARENT,performIsolationTest:!0});o.setSceneGraph(this.viewer.getSceneGraphs().getPreviewSceneGraph()),this.childPasses.push(o),this.previewPasses.push(o)}setRetrieveFromPreview(e){for(let t=0;t<this.previewPasses.length;++t)this.previewPasses[t].setEnabled(e)}nodeFilter(e){if(e.isMeshNode()){if(!e.getIncludedInBlend())return!1;if(ay(e))return this.includePlanes}return!0}draw(e){throw"Use DepthRetrievalPass retrieve method instead"}retrieve(e,t){this.includePlanes=t,super.draw(e)}postDraw(e){const t=this.pickRect[2]*this.pickRect[3]*4,i=new Uint8Array(t),s=this.viewer.getGlContext();s.readPixels(0,0,this.pickRect[2],this.pickRect[3],s.RGBA,s.UNSIGNED_BYTE,i),this.points=[];for(let e=0;e<t/4;e++){const t=4*e,s=(0,Xs.Rg)([i[t],i[t+1],i[t+2],i[t+3]],this.viewer.isHighPrecisionSupportedInFragmentShader());this.points.push([this.pickRect[0]+e%this.pickRect[2],this.pickRect[1]+(this.pickRect[3]-Math.floor(e/this.pickRect[2])),s])}T.prototype.postDraw.call(this,e),super.postDraw(e)}}class qe extends T{constructor(e,t,i){super(e,{makeFrameBuffer:!1}),this.component=t,this.depthPass=i,this.sceneGraph=null,this.clearColor=[0,0,0,0],this.colorPass=new L(this.viewer,t),this.childPasses=[this.depthPass,this.colorPass],this.component!==r.ACCUMULATION&&(this.clearColor=[1,1,1,1])}clearBuffer(e){const t=this.viewer.getGlContext();t.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],this.clearColor[3]),e&&e.getFrameId()===this.depthPass.getLastRenderedFrame()?t.clear(t.COLOR_BUFFER_BIT):t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)}appliesTranslucentAlphaToAll(e){this.colorPass.appliesTranslucentAlphaToAll(e)}setSceneGraph(e){this.colorPass.setSceneGraph(e),this.depthPass.setSceneGraph(e)}setBlendFilter(e){this.colorPass.setBlendFilter(e)}setDepthPassEnabled(e){this.depthPass.setEnabled(e)}setDepthOpacity(e){e===a.ALL?this.depthPass.setExtraMeshNodeFilter(this.createExcludeForNonBodyFilter()):this.depthPass.setExtraMeshNodeFilter(null),this.depthPass.setOpacity(e)}setExtraFaceMeshNodeFilter(e){this.colorPass.setExtraFaceMeshNodeFilter(e)}setTintColor(e){this.colorPass.setTintColor(e)}setTintFactor(e){this.colorPass.setTintFactor(e)}setHideSelectionInterior(e){this.colorPass.setHideSelectionInterior(e)}setPerformIsolationTest(e){this.colorPass.performIsolationTest=e}}class Ye extends I{constructor(e,t){super(e),this.shaderTag="compareBlend",this.inputs.uOverBufferPass=t}justBeforeDraw(e){super.justBeforeDraw(e),this.shader.uniform1f("uBlend",vt())}}class Ke extends W{constructor(e,t){super(e,t);const i=[0,0,0,0];this.baseBufferPass=new T(this.viewer),this.compareBufferPass=new T(this.viewer),this.baseBufferPass.clearColor=i,this.compareBufferPass.clearColor=i;const s=new Set;s.add(Cn.o2.FILTERED_ENTITIES);const n=(e,t,i)=>{const n=[this.nonEditedFaceDepthPass,this.nonEditedEdgeDepthPass,t.opaqueFaces,t.opaqueFacesZebraStripes,t.draftAnalysisFaces,t.qualityVisualization,t.stencilWritingOpaqueFaces,t.transparentPass,t.depthTransparentFaces,t.sketchImageFaces,t.sectionPlaneEndcap,t.opaqueEdges,t.silhouettes,t.nonOitTransparentEdges,t.opaquePoints,t.isolatePass];t.contextPass&&n.push(t.contextPass),n.push(new re(e,null,!1,i,s)),n.push(new oe(e,i,!0,s)),n.push(new V(e,this));for(let e=0;e<Gi.DO.COUNT;++e)n.push(t.showThroughStencilTested.getChildPass(e)),n.push(t.showThroughNotStencilTested.getChildPass(e)),n.push(t.showThroughDepthTested.getChildPass(e));return n.push(new oe(e,i,!1,s)),n};this.baseBufferPass.childPasses=n(this.viewer,this.baseDefaultPasses,ys.L.BASE),this.compareBufferPass.childPasses=n(this.viewer,this.compareDefaultPasses,ys.L.PREVIEW),this.previewBlendPass=new le(this.viewer,this.baseBufferPass,this.compareBufferPass),this.setBlendFilters(),this.viewer.getSupportsPreview()&&(this.previewStateChangeSubscription=Ls().stateChangedObservable.subscribe((()=>this.onStateChange()))),this.listenTo(this.viewer.getEventDispatcher(),nM.so,this.onSessionEnded),this.onStateChange()}onSessionEnded(){this.previewStateChangeSubscription?.unsubscribe(),super.onSessionEnded()}onStateChange(){if(this.childPasses=[],!Us()&&!Hs())if(Ws())this.pushOpaqueDepthPassWithAlpha(),this.childPasses.push(this.previewBlendPass);else for(let e=0;e<this.compareBufferPass.childPasses.length;++e){const t=this.compareBufferPass.childPasses[e];t!==this.nonEditedFaceDepthPass&&t!==this.nonEditedEdgeDepthPass&&this.childPasses.push(t)}this.viewer.requestDraw()}setDraftAnalysisPullDirection(e){this.baseDefaultPasses.draftAnalysisFaces.setPullDirection(e),this.compareDefaultPasses.draftAnalysisFaces.setPullDirection(e)}setDraftAnalysisMinimumAngle(e){this.baseDefaultPasses.draftAnalysisFaces.setMinimumAngle(e),this.compareDefaultPasses.draftAnalysisFaces.setMinimumAngle(e)}setDraftAnalysisParts(e){this.baseDefaultPasses.draftAnalysisFaces.setParts(e),this.compareDefaultPasses.draftAnalysisFaces.setParts(e)}setDraftAnalysisShowUndercut(e){this.baseDefaultPasses.draftAnalysisFaces.setShowUndercut(e),this.compareDefaultPasses.draftAnalysisFaces.setShowUndercut(e)}setZebraStripeCount(e){this.baseDefaultPasses.setZebraStripeCount(e),this.compareDefaultPasses.setZebraStripeCount(e)}setZebraStripeRotation(e){this.baseDefaultPasses.setZebraStripeRotation(e),this.compareDefaultPasses.setZebraStripeRotation(e)}}let je=0;function Qe(e){je=e}function $e(){return je}const Je=X.default.getManager(),et="uIsolateContextOpacity",tt=Je.getNumber("ISOLATE_CONTEXT_FACE_TRANSPARENCY"),it=Je.getNumber("ISOLATE_CONTEXT_EDGE_TRANSPARENCY");class st extends Le{constructor(e,t,i,n,r){super(e,t,i,n,!1),this.isForInContext=r;const o=function(e){(0,ct.Pq)(e.viewer.getGlContext(),d.FACES),ie.prototype.postDraw.apply(this,[e])};this.depthFaces.postDraw=o,this.depthFaces.opacity=a.ALL,this.depthEdges.forDepth=!0,this.depthEdges.postDraw=function(e){(0,ct.Pq)(e.viewer.getGlContext(),d.EDGES),ie.prototype.postDraw.apply(this,[e])},this.depthEdges.opacity=a.ALL,this.sectionPlaneEndcap.childPasses.forEach((e=>{e.forDepthTesting=!0,e.shaderTag="endcap-depth"})),this.opaqueFaces=new ie(this.viewer,this,{primitiveType:s.FACES,opacity:a.ALL,depthTestMode:g.LEQUAL,performIsolationTest:!0,stencilMode:c.WRITE_AND_TEST_ISOLATE_CONTEXT,sceneGraph:i}),this.opaqueFaces.postDraw=o,this.decalPass=new ie(this.viewer,this,{primitiveType:s.FACES,opacity:a.ALL,depthTestMode:g.LEQUAL,performIsolationTest:!0,sceneGraph:i}),this.decalPass.setExtraMeshNodeFilter(this.createOnlyDecalsFilter()),this.opaqueFacesZebraStripes=new ie(this.viewer,this,{facesShader:h.ZEBRA_STRIPES,performIsolationTest:!0,opacity:a.ALL,depthTestMode:g.LEQUAL,extraShaderUniforms:[{name:"uStripeCount",value:Je.getNumber("ZEBRA_STRIPE_COUNT")},{name:"uStripeRotation",value:Je.getNumber("ZEBRA_STRIPE_ROTATION")},{name:"uFilterWidth",value:Je.getNumber("ZEBRA_STRIPE_FILTER_WIDTH")},{name:"uRespectOrthographic",value:Je.getNumber("ZEBRA_STRIPE_RESPECT_ORTHOGRAPHIC")}]});const l=function(e){const t=this.viewer.getGlContext();t.disable(t.BLEND),ie.prototype.justBeforeDraw.apply(this,[e])};this.opaqueFaces.justBeforeDraw=l,this.opaqueFacesZebraStripes.justBeforeDraw=l,this.sketchImageFaces.justAfterDraw=l,this.disableNonOitTransparentEdgesForBodies()}setFilters(){const e=this.getNodeOccurrenceFilter();if(e){this.depthFaces.setNodeOccurrenceFilterFunction(e),this.opaqueFaces.setNodeOccurrenceFilterFunction(e),this.decalPass.setNodeOccurrenceFilterFunction(e),this.opaqueFacesZebraStripes.setNodeOccurrenceFilterFunction(e),this.sketchImageFaces.setNodeOccurrenceFilterFunction(e),this.opaqueEdges.setNodeOccurrenceFilterFunction(e),this.nonOitTransparentEdges.setNodeOccurrenceFilterFunction(e),this.opaquePoints.setNodeOccurrenceFilterFunction(e);for(let t=Gi.DO.LOWER;t<=Gi.DO.HIGHEST;++t)this.showThroughStencilTested.getChildPass(t).setNodeOccurrenceFilterFunction(e)}this.depthEdges.setNodeOccurrenceFilterFunction((e=>e.occurrenceData.getIsolated()));this.depthFaces.setExtraMeshNodeFilter(this.createExcludeForNonBodyFilterNoDecals(!0))}preDraw(e){if(0===this.getTransparencyMultiplier())return!1;const t=this.isForInContext?tt:this.viewer.isolateContextFaceTransparency,i=this.isForInContext?it:this.viewer.isolateContextEdgeTransparency,s=this.getTransparencyMultiplier(),n=s*t*je+(1-je),r=Math.min(1,3*n);let a=s*i*je+(1-je);a=Math.sqrt(a),this.opaqueFaces.setShaderUniform(et,n),this.decalPass.setShaderUniform(et,n),this.opaqueFacesZebraStripes.setShaderUniform(et,n),this.sketchImageFaces.setShaderUniform(et,r),this.opaqueEdges.setShaderUniform(et,a),this.nonOitTransparentEdges.setShaderUniform(et,a),this.opaquePoints.setShaderUniform(et,a);for(let e=Gi.DO.LOWER;e<=Gi.DO.HIGHEST;++e)this.showThroughStencilTested.getChildPass(e).setShaderUniform(et,n);return super.preDraw(e)}setRenderingMode(e){super.setRenderingMode(e),this.opaqueFaces.setOpacity(a.ALL),this.depthFaces.setOpacity(a.ALL),this.depthEdges.setOpacity(a.ALL);this.opaqueFaces.setExtraMeshNodeFilter(this.createExcludeForNonBodyFilterNoDecals(!0));const t=e!==k.P1.HIDDEN_LINE_REMOVED&&e!==k.P1.HIDDEN_LINE_VISIBLE;this.decalPass.setEnabled(t)}setZebraStripeCount(e){this.opaqueFacesZebraStripes.setShaderUniform("uStripeCount",e)}setZebraStripeRotation(e){this.opaqueFacesZebraStripes.setShaderUniform("uStripeRotation",e)}}class nt extends st{constructor(e,t,i,s){super(e,t,i,s,!1),this.setFilters()}getNodeOccurrenceFilter(){const e=this.viewer.getModelViewManagers().getManager();return t=>{const i=t.occurrenceData.getOccurrenceId(),s=e.isOccurrenceIdForInContext(i),n=this.viewer.isolateContextFiltersTranslucentOccurrences;return!(s||n&&this.viewer.getIsolatedOccurrenceManager()?.isOccurrenceTranslucent(t.occurrenceData))}}getTransparencyMultiplier(){return this.viewer.getIsolatedOccurrenceManager()?.getIsIsolateFullyTransparent()?0:1}preDraw(e){const t=this.viewer.getModelViewManagers().getManager().getSimulationManager();return!!(this.viewer.getIsolatedOccurrenceManager()?.isInIsolateOrMakeTransparentMode()||t&&t.isIsolateEffectActive()||null!==this.viewer.getInterferenceCallId()&&""!==this.viewer.getInterferenceCallId())&&super.preDraw(e)}}class rt extends st{constructor(e,t,i,s,n){super(e,t,i,s,!0),this.filterForInContext=n,this.setFilters()}getNodeOccurrenceFilter(){const e=this.viewer.getModelViewManagers().getManager();if(this.filterForInContext){return t=>{if(!e.isDisplayingIncontextAssembly())return!1;const i=t.occurrenceData.getOccurrenceId();return e.isOccurrenceIdForInContext(i)}}return t=>{const i=this.viewer.getIsolatedOccurrenceManager();if(!i?.isInIsolateOrMakeTransparentMode())return!0;const s=t.occurrenceData;return e.isOccurrenceIdForInContext(s.getOccurrenceId())||s.getIsolated()}}getTransparencyMultiplier(){return this.viewer.getIsolatedOccurrenceManager()?.getContextTransparencyMultiplier()}preDraw(e){return!!(0,Me.Eo)()&&super.preDraw(e)}}class at extends f{constructor(e,t,i,s){if(super(e,t),this.ghostedChildrenPasses=[],s=s||this.viewer.getSceneGraphs().getMainSceneGraph(),i){this.ghostedChildrenPasses.push(new rt(this.viewer,this,s,be.ISOLATION,!1));if(s.isForPreview()){const e=this.viewer.getSceneGraphs().getMainSceneGraph();this.ghostedChildrenPasses.push(new rt(this.viewer,this,e,be.ISOLATION,!0))}}else this.ghostedChildrenPasses.push(new nt(this.viewer,this,s,be.ISOLATION));this.childPasses=[],this.ghostedChildrenPasses.forEach((e=>{this.childPasses.push(e.depthFaces)})),this.ghostedChildrenPasses.forEach((e=>{this.childPasses.push(e.sectionPlaneEndcap)})),this.ghostedChildrenPasses.forEach((e=>{this.childPasses.push(e.depthEdges)})),this.ghostedChildrenPasses.forEach((e=>{this.addModelPasses(e)})),this.childPasses.push(new V(this.viewer,this)),this.ghostedChildrenPasses.forEach((e=>{this.addShowThroughPasses(e)})),this.setRenderingMode(k.P1.SHADED_WITH_EDGES)}addModelPasses(e){this.childPasses.push(e.opaqueFaces),this.childPasses.push(e.decalPass),this.childPasses.push(e.opaqueFacesZebraStripes),this.childPasses.push(e.sketchImageFaces),this.childPasses.push(e.opaqueEdges),this.childPasses.push(e.nonOitTransparentEdges),this.childPasses.push(e.opaquePoints)}addShowThroughPasses(e){for(let t=Gi.DO.LOWER;t<=Gi.DO.HIGHEST;++t)this.childPasses.push(e.showThroughStencilTested.getChildPass(t))}forIsolate(){return!1}preDraw(e){return!!this.ghostedChildrenPasses.reduce(((t,i)=>i.preDraw(e)||t),!1)&&super.preDraw(e)}setRenderingMode(e){e!==k.P1.TRANSLUCENT&&e!==k.P1.DRAFT_ANALYSIS||(e=k.P1.SHADED_WITH_EDGES),this.ghostedChildrenPasses.forEach((t=>{t.setRenderingMode(e)}))}setHideSelectionInterior(e){this.ghostedChildrenPasses.forEach((t=>{t.setHideSelectionInterior(e)}))}setZebraStripeCount(e){this.ghostedChildrenPasses.forEach((t=>t.setZebraStripeCount(e)))}setZebraStripeRotation(e){this.ghostedChildrenPasses.forEach((t=>t.setZebraStripeRotation(e)))}}class ot extends f{constructor(e,t,i,s){super(e,t),this.isolateContextPass=new at(e,this,i,s);this.childBuffer=D(this.viewer,this.isolateContextPass,1,"highlightBuffer"),this.childBuffer.clearColor=[1,1,1,0];const n=new E(this.viewer,this.childBuffer,{performDrawInputs:!0});this.childPasses=[n]}preDraw(e){return!!this.isolateContextPass.preDraw(e)&&super.preDraw(e)}setRenderingMode(e){this.isolateContextPass.setRenderingMode(e)}setHideSelectionInterior(e){this.isolateContextPass.setHideSelectionInterior(e)}setZebraStripeCount(e){this.isolateContextPass.setZebraStripeCount(e)}setZebraStripeRotation(e){this.isolateContextPass.setZebraStripeRotation(e)}}class ht extends I{constructor(e){super(e),this.shaderTag="debugPickPass",this.pickPass=null}setPickPass(e){this.pickPass=e,this.inputs.uPickBuffer=e}drawInputs(e){}preDraw(e){if(!this.pickPass)return!1;const t=this.pickPass.getPickViewportWidthHeight();let i=10;return t[0]>50&&(i=3),t[0]>200&&(i=1),e.pushViewport([0,0,t[0]*i,t[1]*i]),super.preDraw(e)}postDraw(e){super.postDraw(e),e.popViewport()}}var ct=i(51227),lt=i(54052);class dt extends Pe{constructor(e){super(e,null),this.shaderTag="draftAngle",this.clearColor=[0,0,0,0],this.nodeOccurrenceFilterFunction=null,this.direction=null,this.points=[],this.childPasses=[],this.previewPasses=[],this.nodeFilterFunction=this.createExcludeForNonBodyFilter();for(let e=0;e<this.childPasses.length;++e)this.childPasses[e].destroy();const t=[{name:"uPullDirection",value:M.fromValues(0,0,0)}];this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.FACES,performIsolationTest:!0,extraShaderUniforms:t})),this.childPasses.push(new ie(this.viewer,this,{primitiveType:s.FACES,opacity:a.TRANSPARENT,performIsolationTest:!0,extraShaderUniforms:t}));const i=new ie(this.viewer,this,{performIsolationTest:!0,extraShaderUniforms:t});i.setSceneGraph(this.viewer.getSceneGraphs().getPreviewSceneGraph()),this.childPasses.push(i),this.previewPasses.push(i);const n=new ie(this.viewer,this,{opacity:a.TRANSPARENT,performIsolationTest:!0,extraShaderUniforms:t});n.setSceneGraph(this.viewer.getSceneGraphs().getPreviewSceneGraph()),this.childPasses.push(n),this.previewPasses.push(n)}nodeFilter(e){return this.nodeFilterFunction(e)}setDirection(e){this.direction=e}setOccurrenceIds(e){const t={},i=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio();if(!i)return;const s=i.getBodyComponent();for(const i in e){const e=s.retrieveBodyMetaData(i);if(!e)continue;if(!e.isSolidBody()&&!e.isSheetBody())continue;const n=s.partStudioBodyIdToOccurrenceId[i];n&&(t[n]=!0)}this.nodeOccurrenceFilterFunction=e=>t[e.occurrenceData.getOccurrenceId()]}preDraw(e){return!!this.direction&&super.preDraw(e)}justBeforeDraw(e){super.justBeforeDraw(e);const t=e=>{e.setShaderUniform("uPullDirection",this.direction)};(0,lt.Z)(this.childPasses,t),this.previewPasses.forEach(t)}draw(e){throw"Use DraftAngleRetrievalPass retrieve method instead"}retrieve(e){e.setNodeOccurrenceFilterFunction(this.nodeOccurrenceFilterFunction),super.draw(e),e.setNodeOccurrenceFilterFunction(null)}postDraw(e){const t=this.pickRect[2]*this.pickRect[3]*4,i=new Uint8Array(t),s=this.viewer.getGlContext();s.readPixels(0,0,this.pickRect[2],this.pickRect[3],s.RGBA,s.UNSIGNED_BYTE,i),this.points=[];for(let e=0;e<t/4;e++){const t=4*e,s=(0,Xs.Pm)([i[t],i[t+1],i[t+2],i[t+3]],this.viewer.isHighPrecisionSupportedInFragmentShader());this.points.push({canvasCoordinate:[this.pickRect[0]+e%this.pickRect[2],this.pickRect[1]+(this.pickRect[3]-Math.floor(e/this.pickRect[2]))],angle:s})}super.postDraw(e)}}class ut extends f{constructor(e,t,i){super(e,t),this.shaderTag="faces",this.sceneGraph=i}usesShader(){return!0}getSceneGraph(){return this.sceneGraph?this.sceneGraph:super.getSceneGraph()}preDraw(e){this.initializeShader(),e.activateShader(this.shader);const t=this;return e.nodeFilter=function(e){return t.nodeFilter(e)},!0}onShaderActivated(e,t){(0,lD.qS)(this.viewer,!0)}postDraw(e){}nodeFilter(e){return!(!(e.isMeshNode()&&e.getIsVisible()&&e.isFaces()&&!ym(e)&&e.getClippedBySectionPlanes())||Fg(e))&&this.parentPass.nodeFilter(e)}needsFaceAppearances(){return!1}}var gt=i(28892),pt=i(67386),mt=i(72052);const ft=_e.O.createLogger("BodyCheckPass",k.bVy.GRAPHICS);class It extends ut{constructor(e,t){super(e,t,null)}preDraw(e){this.initializeShader(),e.activateShader(this.shader),this.shader.uniform1f("uSectionPlaneCount",0);const t=this;return e.nodeFilter=function(e){return t.nodeFilter(e)},!0}}class Et extends Be{constructor(e,t){super(e,null),this.reportedWarning=!1,this.reportedOnCracks=!1,this.childPasses=[],this.visualizedRays=[],this.forFullScreenVisualization=!!t,this.checkFrameId=!this.forFullScreenVisualization,this.camera=new wh,this.camera.setViewport([0,0,Et.TEST_VIEWPORT_WIDTH,Et.TEST_VIEWPORT_HEIGHT]),this.camera.setCanvasDimensions(Et.TEST_VIEWPORT_WIDTH,Et.TEST_VIEWPORT_HEIGHT),this.camera.setFrame(sr.Isometric);const i=!(0,pt.isBrowserSafari)();this.resultBuffer=i?new Float32Array(Et.TEST_VIEWPORT_HEIGHT*Et.TEST_VIEWPORT_HEIGHT*4):new Uint8Array(Et.TEST_VIEWPORT_HEIGHT*Et.TEST_VIEWPORT_HEIGHT*4),this.childPasses.push(new It(this.viewer,this)),this.clearColor=this.forFullScreenVisualization?[0,0,0,0]:[0,0,0,1]}shouldCheckSectionPlaneCount(){return!1}preDraw(e){if(this.reportedWarning)return!1;if(!this.forFullScreenVisualization){const e=this.viewer.getModelViewManagers().getManager().getModelBounds();if(!(e&&e.isInitialized()&&e.isFinite()&&e.isExtensive()))return!1;this.camera.setSceneBounds(e),this.camera.zoomToFit(e.getCorners()),this.camera.updateNearFar(),this.viewer.pushCameraState(this.camera)}const t=Be.prototype.preDraw.apply(this,[e]);return t||this.forFullScreenVisualization||this.viewer.popCameraState(),t}postDraw(e){this.forFullScreenVisualization||(this.viewer.popCameraState(),this.checkBuffer()),Be.prototype.postDraw.apply(this,[e])}checkBuffer(){if(this.viewer.areOptimizedBuffersEnabled)return;const e=this.viewer.getGlContext();this.resultBuffer instanceof Float32Array?e.readPixels(0,0,Et.TEST_VIEWPORT_WIDTH,Et.TEST_VIEWPORT_HEIGHT,e.RGBA,e.FLOAT,this.resultBuffer):e.readPixels(0,0,Et.TEST_VIEWPORT_WIDTH,Et.TEST_VIEWPORT_HEIGHT,e.RGBA,e.UNSIGNED_BYTE,this.resultBuffer);const t=Et.TEST_VIEWPORT_HEIGHT*Et.TEST_VIEWPORT_HEIGHT;let i=0,s=0;for(let e=0;e<t;++e)this.checkPixel(s)||++i,s+=4;if(i>=4){const e=i/t*100,s="bad pixel count: "+i+", total pixel count: "+t+", percentage of bad pixels: "+e.toFixed(1)+"%, last element and microversion interval processed: "+this.viewer.getModelViewManagers().getManager().getDescriptionOfLastProcessedPartStudio();if(e>=3){const e=gt.T.getOpenDocumentModel().get("public");ft.warn("Encountered body/bodies with significant display errors. "+s+"\nisPublic: "+e),this.findBadEntities(),this.reportedWarning=!0}else this.reportedOnCracks||(ft.info("Encountered body/bodies with display errors.  The body may have cracks in it. "+s),this.reportedOnCracks=!0)}this.reportedWarning||window.localStorage.removeItem(this.getEntityCheckKey())}checkPixel(e){for(let t=0;t<3;++t)if(Math.abs(this.resultBuffer[e+t])>=.001)return!1;return!0}getEntityCheckKey(){let e="loggedBadEntities.";const t=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio();return t&&(e+=t.id),e}findBadEntities(){const e=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio();if(!e)return;if(window.localStorage.getItem(this.getEntityCheckKey()))return;const t=e.bodyComponent;let i=0;const s=[],n=M.create(),r=function(e,t){return s.length=0,t&&t.isTriangles()&&(0,wi.Lr)(e,t.getBounds(),n)?(t.iteratePrimitives((function(t,i,n){if(!i||!n)return;const r=(0,wi.AF)(e,t,i,n);void 0!==r&&s.push(r)})),s):s},a=(0,Xs.Wj)(),o=new mt.StringSet;for(let e=0;e<Et.TEST_VIEWPORT_HEIGHT;++e)for(let s=0;s<Et.TEST_VIEWPORT_WIDTH;++s){if(!this.checkPixel(i)){const i=this.camera.getRay(s,Et.TEST_VIEWPORT_HEIGHT-e);for(const e in t.bodyMetaData){const s=t.bodyMetaData[e];if(!s.isSolidBody()||s.meshState===k.W6T.ALL_MESH)continue;const a=t.bodyToEntity.get(e);if(!a)continue;if(!(0,wi.Lr)(i,s.getBounds(),n))continue;const h={};a.each((function(e,s){const n=t.idToMetaData[s];if(!n)return;const a=r(i,n.getMeshIncrement());for(let e=0;e<a.length;++e){const t=(0,Yd.PF)(a[e]);let i=h[t];i||(h[t]=i=new mt.StringSet),i.add(s)}return!1}),this);for(const e in h){const t=h[e];t.size()>1&&o.addAll(t.getKeyArray())}}}i+=4}const h=(0,Xs.Es)(a);if(h>400&&window.localStorage.setItem(this.getEntityCheckKey(),"true"),o.size()>0){let e="Found overlapping entities ("+h.toFixed(0)+" ms):\n";o.each((function(i){const s=(0,Me.cF)(i),n=t.idToMetaData[i];let r=null;s&&(r=(0,Me.fM)(s)),e+="  entityId: "+i+", bodyId: "+n.getBodyId()+", featureIds: ["+n.getFeatureIds()+"]",e+=r?", featureName: "+r.getName()+", featureType: "+r.getFeatureType()+"\n":" (parent feature not found)\n"}),this),ft.warn(e)}}toggleRayVisualization(){if(this.visualizedRays.length>0){for(let e=0;e<this.visualizedRays.length;++e)this.visualizedRays[e].remove();this.visualizedRays=[]}else{let e=0;for(let t=0;t<Et.TEST_VIEWPORT_HEIGHT;++t)for(let i=0;i<Et.TEST_VIEWPORT_WIDTH;++i){if(!this.checkPixel(e)){const e=this.camera.getRay(i,Et.TEST_VIEWPORT_HEIGHT-t);this.visualizedRays.push(new wI(this.viewer,e))}e+=4}}}}Et.TEST_VIEWPORT_WIDTH=100,Et.TEST_VIEWPORT_HEIGHT=100;class St extends I{constructor(e,t,i,s){super(e),this.highlightType=t,this.disableDuringPreview=s,this.shaderTag="highlightDraw",this.interiorHighlightOpacity=.5,this.inputs.uHighlightBuffer=new Rt(this.viewer,t);const n=new wt(this.viewer,t,i),r=n.opaqueFacePass.nodeFilter;n.opaqueFacePass.setNodeFilter((e=>{this.viewer.getIsolatedOccurrenceManager()?.hasIsolatedInstances()&&e.hasNonIsolatedOccurrences()&&this.viewer.getModelViewManagers().getManager().isNodeForModel(e)&&n.opaqueFacePass.setOpacity(a.ALL);const t=r.call(n.opaqueFacePass,e);return n.opaqueFacePass.setOpacity(a.OPAQUE),t})),n.opaqueFacePass.setNodeOccurrenceFilterFunction((e=>!(!this.viewer.getIsolatedOccurrenceManager()?.hasIsolatedInstances()||e.occurrenceData.getIsolated())||!e.parentHasTransparency())),this.inputs.uHighlightMask=n,this.scenegraph=this.viewer.getSceneGraphs().getMainSceneGraph()}setMaskOpaqueFaces(e){this.inputs.uHighlightMask.opaqueFacePass.setEnabled(e)}setSceneGraph(e){this.scenegraph=e,this.inputs.uHighlightBuffer.setSceneGraph(e),this.inputs.uHighlightMask.setSceneGraph(e)}getSceneGraph(){return this.scenegraph}getEnabled(){return this.enabled&&(!this.disableDuringPreview||!ks())}setInteriorHighlightOpacity(e){this.interiorHighlightOpacity=e}justBeforeDraw(e){super.justBeforeDraw(e);const t=this.viewer.getReferenceHighlights().highlights[this.highlightType];this.shader.uniform4fv("uHighlightColor1",t.color1),this.shader.uniform4fv("uHighlightColorBorder",t.colorBorder),this.shader.uniform1f("uInteriorHighlightOpacity",this.interiorHighlightOpacity),this.shader.uniform1i("uHideSelectionInterior",this.hideSelectionInterior?1:0),this.shader.uniform1i("uOutlineOverlappingInteriorRegions",t.outlineOverlappingInteriorRegions?1:0)}postDraw(e){super.postDraw(e)}}class Tt extends ie{constructor(e,t,i){super(e,t,{opacity:a.TRANSPARENT,blendMode:u.ADD}),this.setExtraMeshNodeFilter((function(e){return e.getIsTintedByCompare()})),i&&(this.inputs.uPlaneIdSetBuffer=i)}getShaderId(){return"-planeId-"+this.shaderTag}justBeforeDraw(e){super.justBeforeDraw(e);const t=e.getActiveShader();t.uniform1i("uDoSetTest",this.inputs.uPlaneIdSetBuffer?1:0),this.inputs.uPlaneIdSetBuffer?t.useTexture("uPlaneIdSetBuffer",this.inputs.uPlaneIdSetBuffer.getColorTexture()):t.useBlankTexture("uPlaneIdSetBuffer")}}const Dt=_e.O.createLogger("draftanalysisdrawpass",k.bVy.GRAPHICS),Ct=y.fromValues(0,0,2048,2048),Mt=ue.create();class yt extends ie{constructor(e,t,i,n){super(e,t,{primitiveType:s.FACES,opacity:a.ALL}),this.parentPass=t,this.withDirection=i,this.setSceneGraph(n)}preDraw(e){if(this.setExtraMeshNodeFilter(this.createExcludeForNonBodyFilter()),super.preDraw(e)){e.setOverrideFaceCullingMode(bh.NONE),e.setOverridePolygonOffset(0,0);const t=this.parentPass.draftAnalysisDrawPass;return e.pushModelViewMatrix(this.withDirection?t.viewMatrixWithDirection:t.viewMatrixAgainstDirection),e.pushProjectionMatrix(this.withDirection?t.projectionMatrixWithDirection:t.projectionMatrixAgainstDirection),(0,lD.qS)(this.viewer,!0,!0),this.viewer.getGlContext().colorMask(this.withDirection,!this.withDirection,!1,!1),!0}return!1}postDraw(e){e.popModelViewMatrix(),e.popProjectionMatrix(),(0,lD.qS)(this.viewer,!0,!0),e.clearOverrideFaceCullingMode(),e.clearOverridePolygonOffset(),super.postDraw(e)}}class At extends T{constructor(e,t,i){super(e,{id:"draftAnalysisShadowTest"}),this.shaderTag="draftShadow",this.checkFrameId=!1,this.clearColor=[255,255,255,255],this.draftAnalysisDrawPass=t,this.childPasses=[new yt(e,this,!0,i),new V(e,this),new yt(e,this,!1,i)]}initializeFrameBuffer(e){this.textureType=e.FLOAT,super.initializeFrameBuffer(e)}preDraw(e){return e.pushViewport(Ct),!!super.preDraw(e)||(e.popViewport(),!1)}postDraw(e){e.popViewport(),super.postDraw(e)}}class Pt extends ie{constructor(e,t,i,s){super(e,t,{facesShader:h.DRAFT,performIsolationTest:i}),this.pullDirection=null,this.showUndercut=!0,this.idToParts={},this.doDraftAnalysis=!0,this.setSceneGraph(s),this.angle=k.zG4.DEFAULT_MINIMUM_ANGLE_RADIANS,this.viewMatrixWithDirection=this.projectionMatrixWithDirection=this.viewMatrixAgainstDirection=this.projectionMatrixAgainstDirection=Mt,this.inputs.uDraftShadowMap=new At(e,this,s),this.usage=s===this.viewer.getSceneGraphs().getMainSceneGraph()?ys.L.BASE:ys.L.PREVIEW}setPullDirection(e){this.pullDirection=e}setMinimumAngle(e){this.angle=e}setParts(e){e?(this.idsToParts={},e.forEach((e=>{Object.values(e.getDeterministicIds()).forEach((t=>{this.idsToParts[t]=e}),this)}),this)):Dt.error("Tried to set the draft analysis parts array to null.")}setShowUndercut(e){this.showUndercut=e}getIdsToParts(){return this.idsToParts}justBeforeDraw(e){let t;if(super.justBeforeDraw(e),this.shader.uniform1i("uDoDraftAnalysis",this.doDraftAnalysis&&this.pullDirection?1:0),this.pullDirection){const i=ge.w$.multiplyVec4(e.getActiveCamera().getViewMatrix(),y.fromValues(this.pullDirection[0],this.pullDirection[1],this.pullDirection[2],0));t=ge.S4.normalize(M.clone(i))}else t=M.create();this.shader.uniform3fv("uDraftAnalysisDirection",t),this.shader.uniform1f("uMinimumDraftAngle",this.angle);const i=X.default.getManager();this.shader.uniform4fv("uSteepDraftColor",i.getColor("DRAFT_ANALYSIS_STEEP_COLOR")),this.shader.uniform4fv("uUndercutColor",i.getColor("DRAFT_ANALYSIS_UNDERCUT_COLOR")),this.shader.uniform4fv("uWithDirectionColor",i.getColor("DRAFT_ANALYSIS_WITH_DIRECTION_COLOR")),this.shader.uniform4fv("uAgainstDirectionColor",i.getColor("DRAFT_ANALYSIS_AGAINST_DIRECTION_COLOR")),this.shader.uniform1i("uShowUndercut",this.showUndercut?1:0),this.shader.uniformMatrix4fv("uPMVMatrixWith",!1,ge.w$.multiply(this.projectionMatrixWithDirection,this.viewMatrixWithDirection,ue.create())),this.shader.uniformMatrix4fv("uPMVMatrixAgainst",!1,ge.w$.multiply(this.projectionMatrixAgainstDirection,this.viewMatrixAgainstDirection,ue.create())),this.shader.uniform1f("uDraftShadowMapPixelWidth",1/Ct[2]),this.shader.uniform1f("uDraftShadowMapPixelHeight",1/Ct[3]),this.shader.useTexture("uDraftShadowMap",this.inputs.uDraftShadowMap.getColorTexture())}createCamera(e,t,i){const s=new wh({direction:e,up:t});s.setViewport(y.clone(Ct));const n=i.getBounds();return s.setSceneBounds(n),s.zoomToFit(n.getCorners(),1,y.fromValues(1,1,Ct[2]-2,Ct[3]-2)),s}addToAnalyseIfApplicable(e,t,i,s){s||(s=t.retrieveBodyMetaData(e)),s&&(s.containsOnlySolidBodies()||s.containsOnlySheetBodies())&&i.set(e,s)}draw(e){if(!this.getEnabled())return;const t=this.viewer.getModelViewManagers().getManagerForUsage(this.usage).getDisplayedPartStudio();if(!t)return;let i=0,s=function(e){return e.occurrenceData.getOccurrenceId()===i};e.setNodeOccurrenceFilterFunction(s);const n=t.getBodyComponent(),r={};this.doDraftAnalysis=!0;for(const t in this.idsToParts){const s=n.retrieveBodyMetaData(t),a=new Map;if(s&&s.isOpenCompositeBody)for(const e of s.constituentBodyIds)this.addToAnalyseIfApplicable(e,n,a);else this.addToAnalyseIfApplicable(t,n,a,s);for(const[t,s]of a.entries())if(i=n.partStudioBodyIdToOccurrenceId[t],i){if(r[i]=!0,this.pullDirection){const e=ge.S4.normalize(ge.S4.getAPerpendicularVector(this.pullDirection),M.create());let t=this.createCamera(M.clone(this.pullDirection),e,s);this.viewMatrixWithDirection=t.getViewMatrix(),this.projectionMatrixWithDirection=t.getProjectionMatrix(),t=this.createCamera(ge.S4.scale(this.pullDirection,-1,M.create()),e,s),this.viewMatrixAgainstDirection=t.getViewMatrix(),this.projectionMatrixAgainstDirection=ge.w$.scale(t.getProjectionMatrix(),[-1,1,1])}else this.viewMatrixWithDirection=this.projectionMatrixWithDirection=this.viewMatrixAgainstDirection=this.projectionMatrixAgainstDirection=Mt;super.drawInputs(e),super.draw(e)}}s=function(e){return!r[e.occurrenceData.getOccurrenceId()]},e.setNodeOccurrenceFilterFunction(s),this.doDraftAnalysis=!1,super.draw(e),e.setNodeOccurrenceFilterFunction(null),this.postDraw(e)}postDraw(e){this.viewMatrixWithDirection=this.projectionMatrixWithDirection=this.viewMatrixAgainstDirection=this.projectionMatrixAgainstDirection=Mt}}class Ot extends f{constructor(e){super(e,null),this.shaderTag="draw",this.ssaoBufferPass=null,this.inferenceDisplayPasses=[],this.clearColor=[0,0,0,0],this.forceHideInteriorSelections=!1;const t=X.default.getManager();this.defaultPasses=new Le(this.viewer,this,this.viewer.getSceneGraphs().getMainSceneGraph(),be.RENDERING),this.childPasses=[],this.childPasses.push(this.defaultPasses.opaqueFaces),this.childPasses.push(this.defaultPasses.opaqueFacesZebraStripes),this.childPasses.push(this.defaultPasses.draftAnalysisFaces),this.childPasses.push(this.defaultPasses.qualityVisualization),this.childPasses.push(this.defaultPasses.stencilWritingOpaqueFaces),t.getNumber("AMBIENT_OCCLUSION_EFFECT_FACTOR")>0&&(0,Xs.pc)(e.getGlContext())&&(this.ssaoBufferPass=Se(this.viewer),this.defaultPasses.opaqueFaces.setInput("uOcclusionMap",this.ssaoBufferPass)),this.partPreviewPass=new Ke(this.viewer,this),this.childPasses.push(this.partPreviewPass),this.partComparePass=new ze(this.viewer,this),this.childPasses.push(this.partComparePass),this.childPasses.push(this.defaultPasses.transparentPass);const i=new ie(e,this,{primitiveType:s.FACES,stencilMode:c.WRITE,disableColorWrites:!0,opacity:a.TRANSPARENT});this.childPasses.push(i),this.defaultPasses.disableNonOitTransparentEdgesForBodies(),this.childPasses.push(this.defaultPasses.nonOitTransparentEdges),this.defaultPasses.depthTransparentFaces.setEnabled(!1),this.childPasses.push(this.defaultPasses.depthTransparentFaces),this.childPasses.push(this.defaultPasses.sketchImageFaces),this.childPasses.push(this.defaultPasses.sectionPlaneEndcap),this.childPasses.push(this.defaultPasses.opaqueEdges),this.childPasses.push(this.defaultPasses.silhouettes);const n=new ie(this.viewer,this,{primitiveType:s.EDGES,stencilMode:c.OFF});this.childPasses.push(n);const r=new oe(this.viewer,ys.L.BASE,!0);this.childPasses.push(r),this.childPasses.push(this.defaultPasses.isolatePass),this.defaultPasses.contextPass&&this.childPasses.push(this.defaultPasses.contextPass),this.childPasses.push(this.defaultPasses.opaquePoints);const h=new re(this.viewer,this,!1),l=new re(this.viewer,this,!0);this.faceHighlightDrawPass=new cA(this.viewer,h,l,lD.eQ),this.childPasses.push(this.faceHighlightDrawPass),this.childPasses.push(new V(this.viewer,this));for(let e=Gi.DO.LOWER;e<=Gi.DO.DEFAULT;++e)this.childPasses.push(this.defaultPasses.showThroughStencilTested.getChildPass(e)),this.childPasses.push(this.defaultPasses.showThroughNotStencilTested.getChildPass(e)),this.childPasses.push(this.defaultPasses.showThroughDepthTested.getChildPass(e));this.linePointAllHighlightsDrawPass=new oe(this.viewer,ys.L.BASE,!1),this.childPasses.push(this.linePointAllHighlightsDrawPass);for(let e=Gi.DO.HIGHER;e<=Gi.DO.HIGHEST;++e)this.childPasses.push(this.defaultPasses.showThroughStencilTested.getChildPass(e)),this.childPasses.push(this.defaultPasses.showThroughNotStencilTested.getChildPass(e)),this.childPasses.push(this.defaultPasses.showThroughDepthTested.getChildPass(e));if(this.childPasses.push(new b(this.viewer,this)),this.visualizeBodyCheckPass=new E(this.viewer,this.viewer.bodyCheckPass,{viewport:[0,0,Et.TEST_VIEWPORT_WIDTH,Et.TEST_VIEWPORT_HEIGHT]}),this.visualizeBodyCheckPass.setEnabled(!1),this.childPasses.push(this.visualizeBodyCheckPass),this.visualizeFullScreenBodyCheckPass=new E(this.viewer,new Et(e,!0),{shaderTag:"blitBodyCheck",performDrawInputs:!0}),this.visualizeFullScreenBodyCheckPass.setEnabled(!1),this.childPasses.push(this.visualizeFullScreenBodyCheckPass),this.debugDrawPickPass=new ht(this.viewer),this.debugDrawPickPass.setEnabled(!1),this.childPasses.push(this.debugDrawPickPass),0!==t.getNumber("DISPLAY_INFERENCE_BUFFER")){const e=new ie(this.viewer,this,{primitiveType:s.EDGES,visibility:o.SHOWTHROUGH,priority:Gi.DO.LOWER,disableDepthTest:!0});e.setEnabled(!1);const t=new ie(this.viewer,this,{primitiveType:s.POINTS,visibility:o.SHOWTHROUGH,priority:Gi.DO.DEFAULT,disableDepthTest:!0});t.setEnabled(!1);const i=new ie(this.viewer,this,{primitiveType:s.POINTS,visibility:o.SHOWTHROUGH,priority:Gi.DO.HIGHER,disableDepthTest:!0});i.setEnabled(!1),this.childPasses.push(e),this.childPasses.push(t),this.childPasses.push(i),this.inferenceDisplayPasses.push(e),this.inferenceDisplayPasses.push(t),this.inferenceDisplayPasses.push(i)}this.setRenderingMode(k.P1.SHADED_WITH_EDGES),this.previewStateChangeSubscription=Ls().stateChangedObservable.pipe((0,ye.h)((e=>e===vs.PREVIEW_STATE_CHANGE))).subscribe((()=>this.onPreviewStateChange())),this.previewBlendChangeSubscription=Ls().stateChangedObservable.pipe((0,ye.h)((e=>e===vs.PREVIEW_BLEND_CHANGE))).subscribe((()=>this.updateHideInteriorSelections())),this.onPreviewStateChange(),this.listenTo(this.viewer.getEventDispatcher(),nM.so,this.onSessionEnded)}onSessionEnded(){this.previewStateChangeSubscription.unsubscribe(),this.previewBlendChangeSubscription.unsubscribe(),super.onSessionEnded()}setClearColor(e,t,i,s){this.clearColor=[e,t,i,s]}getClearColor(){return this.clearColor.slice()}onPreviewStateChange(){this.partPreviewPass.setEnabled(ks()),this.partComparePass.setEnabled(Hs()),Hs()?(this.faceHighlightDrawPass.setEnabled(!1),this.linePointAllHighlightsDrawPass.setEnabled(!1)):(this.faceHighlightDrawPass.setEnabled(!0),this.linePointAllHighlightsDrawPass.setEnabled(!0)),!Us()&&this.viewer.getSupportsPreview()?(this.defaultPasses.setBlendFilter(n.NON_BLEND_ONLY),zs()&&this.defaultPasses.transparentPass.setEnabled(!1),this.defaultPasses.sectionPlaneEndcap.setEnabled(!1),this.defaultPasses.isolatePass.setEnabled(!1),this.defaultPasses.contextPass&&this.defaultPasses.contextPass.setEnabled(!1)):(this.defaultPasses.setBlendFilter(n.ALL),this.defaultPasses.transparentPass.setEnabled(!0),this.defaultPasses.sectionPlaneEndcap.setEnabled(!0),this.defaultPasses.isolatePass.setEnabled(!0),this.defaultPasses.contextPass&&this.defaultPasses.contextPass.setEnabled(!0)),this.updateHideInteriorSelections(),this.viewer.requestDraw()}get sectionPlaneEndcapMaskPass(){return this.defaultPasses.sectionPlaneEndcapMask}get draftAnalysisPass(){return this.defaultPasses.draftAnalysisFaces}setForceHideInteriorSelections(e){this.forceHideInteriorSelections=e,this.updateHideInteriorSelections()}updateHideInteriorSelections(){const e=Ws();let t=X.default.getManager().getNumber("DEFAULT_INTERIOR_HIGHLIGHT_OVERLAY_OPACITY");this.forceHideInteriorSelections?this.setHideSelectionInterior(!0):e?(this.defaultPasses.setHideSelectionInterior(!0),this.faceHighlightDrawPass.setHideSelectionInterior(!1),this.partPreviewPass.setHideSelectionInterior(!0),t=X.default.getManager().getNumber("PREVIEW_INTERIOR_HIGHLIGHT_OVERLAY_OPACITY")):this.setHideSelectionInterior(!1),this.faceHighlightDrawPass.pass1.setInteriorHighlightOpacity(t),this.faceHighlightDrawPass.pass2.setInteriorHighlightOpacity(t)}setHideSelectionInterior(e){this.defaultPasses.setHideSelectionInterior(e),this.faceHighlightDrawPass.setHideSelectionInterior(e),this.partPreviewPass.setHideSelectionInterior(e)}visualizeInferenceSceneGraph(e){for(let t=0;t<this.inferenceDisplayPasses.length;++t)this.inferenceDisplayPasses[t].setEnabled(!!e),this.inferenceDisplayPasses[t].setSceneGraph(e)}setRenderingMode(e){this.defaultPasses.setRenderingMode(e),this.partPreviewPass.setRenderingMode(e),this.partComparePass.setRenderingMode(e)}drawInputs(e){this.ssaoBufferPass&&this.ssaoBufferPass.setEnabled(e.getDetailSettings().enableSSAO),super.drawInputs(e)}preDraw(e){if(this.viewer.getXrController().getIsXrRunning())return!0;const t=this.viewer.getGlContext();return t.stencilMask(255),t.clearStencil(0),t.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[1],this.clearColor[2]),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT|t.STENCIL_BUFFER_BIT),!0}nodeFilter(e){return e.isMeshNode()||e.getIsVisible()}setDraftAnalysisPullDirection(e){this.defaultPasses.draftAnalysisFaces.setPullDirection(e),this.partPreviewPass.setDraftAnalysisPullDirection(e)}setDraftAnalysisMinimumAngle(e){this.defaultPasses.draftAnalysisFaces.setMinimumAngle(e),this.partPreviewPass.setDraftAnalysisMinimumAngle(e)}setDraftAnalysisParts(e){this.defaultPasses.draftAnalysisFaces.setParts(e),this.partPreviewPass.setDraftAnalysisParts(e)}setDraftAnalysisShowUndercut(e){this.defaultPasses.draftAnalysisFaces.setShowUndercut(e),this.partPreviewPass.setDraftAnalysisShowUndercut(e)}getDebugDrawPickPass(){return this.debugDrawPickPass}setZebraStripeCount(e){this.defaultPasses.setZebraStripeCount(e),this.partComparePass.setZebraStripeCount(e),this.partPreviewPass.setZebraStripeCount(e)}setZebraStripeRotation(e){this.defaultPasses.setZebraStripeRotation(e),this.partComparePass.setZebraStripeRotation(e),this.partPreviewPass.setZebraStripeRotation(e)}getSectionEndcapMaskPassForPicking(e){return ks()?e?this.partPreviewPass.getPreviewEndcapMaskPass():this.partPreviewPass.getBaseEndcapMaskPass():Hs()?e?this.partComparePass.getPreviewEndcapMaskPass():this.partComparePass.getBaseEndcapMaskPass():this.sectionPlaneEndcapMaskPass}setDrawNonIsolatedByOITPass(e){this.defaultPasses.supportsOrderIndependentTransparency()&&this.defaultPasses.transparentPass.setDrawNonIsolated(e)}}class Rt extends T{constructor(e,t){super(e,{id:"highlightBuffer"}),this.highlightType=t,this.shaderTag="highlightBuffer",this.childPasses=[],this.clearColor=[0,0,0,0],this.childPasses.push(new ie(this.viewer,this,{})),this.childPasses.push(new ie(this.viewer,this,{opacity:a.TRANSPARENT}));for(let e=0;e<Gi.DO.COUNT;++e)this.childPasses.push(new ie(this.viewer,this,{visibility:o.SHOWTHROUGH,priority:e}))}justBeforeDraw(e){super.justBeforeDraw(e);const t=this.viewer.getGlContext();t.enable(t.BLEND),t.blendFuncSeparate(t.ONE,t.ONE,t.ONE,t.ONE),t.disable(t.DEPTH_TEST),e.getState().callGl("depthMask",!1);const i=e.getActiveShader(),s=this.viewer.getReferenceHighlights().highlights[this.highlightType];i.uniform1f("uActiveHighlightIndex",s.index)}isHighlightPass(){return!0}getActiveHighlightType(){return this.highlightType}needsAttribute(e){const t=e===PS.HIGHLIGHT_ID;return this.parentPass?t||this.parentPass.needsAttribute(e):t}setSceneGraph(e){this.scenegraph=e}getSceneGraph(){return this.scenegraph}}class wt extends T{constructor(e,t,i){super(e,{id:"highlightMask"}),this.highlightType=t,this.shaderTag="highlightMask",this.childPasses=[],this.clearColor=[255,255,255,255],this.opaqueFacePass=new ie(this.viewer,this,{shaderTagSuffix:i?SI:""}),this.childPasses.push(this.opaqueFacePass)}justBeforeDraw(e){const t=e.getActiveShader(),i=this.viewer.getReferenceHighlights().highlights[this.highlightType];t.uniform1f("uActiveHighlightIndex",i.index)}setSceneGraph(e){for(let t=0;t<this.childPasses.length;t++)this.childPasses[t].setSceneGraph(e)}needsAttribute(e){const t=e===PS.HIGHLIGHT_ID;return this.parentPass?t||this.parentPass.needsAttribute(e):t}getActiveHighlightType(){return this.highlightType}}function vt(){const e=Ls().previewAlpha;return e<.5?2*e:2*(1-e)}class _t extends Pe{constructor(e,t){super(e,null),this.managerNodeId=t,this.shaderTag="retrieveScalar",this.clearColor=[0,0,0,0],this.results=[];for(let e=0;e<this.childPasses.length;++e)this.childPasses[e].destroy();const i=new ie(this.viewer,this,{primitiveType:s.FACES,performIsolationTest:!0,disableColorWrites:!0});i.setNodeFilter((e=>0===(e.getParent()?.getId()??"").indexOf(om)&&e.getIsVisible()));this.setNodeFilterOverride((e=>{const t=e.getParent();return 0===(t?t.getId():"").indexOf(this.managerNodeId)&&t.getIsVisible()}));const n=new ie(this.viewer,this,{primitiveType:s.FACES,performIsolationTest:!0});this.childPasses=[i,n]}draw(e){throw"Use retrieve method instead"}retrieve(e,t){return this.scalarRange=t,super.draw(e),this.results}postDraw(e){const t=this.pickRect[2]*this.pickRect[3]*4,i=new Uint8Array(t),s=this.viewer.getGlContext();s.readPixels(0,0,this.pickRect[2],this.pickRect[3],s.RGBA,s.UNSIGNED_BYTE,i),this.results=[];const n=this.viewer.isHighPrecisionSupportedInFragmentShader();for(let e=0;e<t/4;e++){const t=4*e,s=[i[t],i[t+1],i[t+2],i[t+3]];if(i[3]===this.clearColor[3])continue;const r=(0,Xs.NP)(s,n),a=this.scalarRange.scalarFromTextureCoordinate(r);this.results.push({canvasCoordinate:[this.pickRect[0]+e%this.pickRect[2],this.pickRect[1]+(this.pickRect[3]-Math.floor(e/this.pickRect[2]))],scalar:a})}super.postDraw(e)}}var Nt=i(35989),bt=i(484);const Lt=X.default.getManager();class Ft extends f{constructor(e,t,i,s){super(e,t),this.noSection=s,this.isBackFacePassEnabled=!0,this.blendFilter=n.ALL,this.sceneGraph=i}usesShader(){return!0}getShaderId(){return"-backfacesil-faces"+(this.noSection?SI:"")}getSceneGraph(){return this.sceneGraph?this.sceneGraph:super.getSceneGraph()}preDraw(e){if(this.viewer.getIsolatedOccurrenceManager()?.hasIsolatedInstances())return!1;this.initializeShader(),super.preDraw(e);const t=this.viewer.getGlContext();e.setOverrideFaceCullingMode(bh.FRONT),e.activateShader(this.shader);const i=this;return e.nodeFilter=function(e){return i.nodeFilter(e)},(0,lD.qS)(this.viewer,!0),this.shader.uniform1f("uLineWidth",Lt.getNumber("DEFAULT_LINE_WIDTH")*Lt.getNumber("BACKFACE_SILHOUETTE_WIDTH_FACTOR")),this.shader.uniform4fv("uLineColor",this.viewer.getResources().PART_SURFACE_LINE_POINT_MATERIAL.color),this.shader.uniform1f("uSceneDiameter",e.getActiveCamera().getSceneBounds().diameter()),(0,ct.LL)(t,l.LOW_PRIORITY_EDGES,d.EDGES),!0}postDraw(e){super.postDraw(e);const t=this.viewer.getGlContext();e.clearOverrideFaceCullingMode(),t.disable(t.STENCIL_TEST)}nodeFilter(e){const t=this.viewer.getModelViewManagers().getManager(),i=e.getParent();if(this.blendFilter===n.BLEND_ONLY){if(!e.getIncludedInBlend())return!1}else if(this.blendFilter===n.NON_BLEND_ONLY&&e.getIncludedInBlend())return!1;return!e.hasTransparency()&&(!!(e.isFaces()&&i&&t.isNodeForBody(i))&&this.parentPass.nodeFilter(e))}setBlendFilter(e){this.blendFilter=e}}class xt extends ie{constructor(e,t,i,n){super(e,t,{primitiveType:s.FACES,sceneGraph:i,disableColorWrites:!0,performIsolationTest:!0}),this.noSection=n}getShaderId(){return"-depth-faces"+(this.noSection?SI:"")}preDraw(e){if(!super.preDraw(e))return!1;const t=this.viewer.getGlContext();return e.setOverrideFaceCullingMode(bh.FRONT),e.getState().callGl("depthMask",!1),(0,ct.U$)(t,l.LOW_PRIORITY_EDGES,d.EDGES),!0}postDraw(e){super.postDraw(e),e.clearOverrideFaceCullingMode()}}class Bt extends f{constructor(e,t,i,n){super(e,t),this.isBackFacePassEnabled=!0,this.edgePass=new K(e,this,{primitiveType:s.SILHOUETTES,performIsolationTest:!0,sceneGraph:i,...n??{}});const r=new xt(e,this,i,!1),a=new xt(e,this,i,!0);this.backFaceStencilPass=new cA(e,r,a,lD.eQ);const o=new Ft(e,this,i,!1),h=new Ft(e,this,i,!0);this.backfacePass=new cA(e,o,h,lD.eQ),this.childPasses=[this.edgePass,this.backFaceStencilPass,this.backfacePass]}setDrawHidden(e){this.edgePass.setDrawHidden(e)}setSceneGraph(e){this.edgePass.setSceneGraph(e)}setExtraMeshNodeFilter(e){this.edgePass.setExtraMeshNodeFilter(e)}setDrawVisibleParts(e){this.edgePass.setDrawVisibleParts(e),this.backFaceStencilPass.setEnabled(e),this.backfacePass.setEnabled(e)}setBlendFilter(e){this.edgePass.setBlendFilter(e),this.backFaceStencilPass.setBlendFilter(e),this.backfacePass.setBlendFilter(e)}setDrawBackFaceSilhouettes(e){this.isBackFacePassEnabled=e}preDraw(e){if(!this.viewer.debugIsShowingSilhouetteEdgesOnNonVisibleTangentEdgeStyle()&&this.viewer.getSmoothEdgesRenderStyle()!==bt.Y.VISIBLE&&this.viewer.getRenderingMode()!==Nt.P.HIDDEN_LINE_VISIBLE&&this.viewer.getRenderingMode()!==Nt.P.HIDDEN_LINE_REMOVED)return!1;super.preDraw(e);const t=e.getDetailSettings();this.edgePass.setEnabled(t.enableEdgeSilhouettes);const i=t.enableBackfaceSilhouettes&&this.isBackFacePassEnabled;return this.backFaceStencilPass.setEnabled(i),this.backfacePass.setEnabled(i),!0}appliesTranslucentAlphaToAll(e){this.edgePass.appliesTranslucentAlphaToAll(e)}}class Vt extends ie{constructor(e,t,i,n){super(e,t,{primitiveType:s.FACES,opacity:a.TRANSPARENT,disableColorWrites:!0,performIsolationTest:n}),this.setSceneGraph(i),this.setNodeFilter(this.createExcludeForNonBodyFilter())}getEnabled(){switch(this.viewer.getRenderingMode()){case k.P1.SHADED_WITH_HIDDEN_EDGES:return!0;case k.P1.SHADED_WITH_EDGES:case k.P1.SHADED_WITHOUT_EDGES:case k.P1.TRANSLUCENT:case k.P1.SIMULATION_RESULTS:return this.viewer.getFilteredEntitiesHighlightController()?.getSelectionList()?.length>0;default:return!1}}}const Ut=_e.O.createLogger("WebGlQueryFunctions",k.bVy.GRAPHICS);var Ht;!function(e){e[e.BYTE=5120]="BYTE",e[e.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",e[e.SHORT=5122]="SHORT",e[e.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",e[e.INT=5124]="INT",e[e.UNSIGNED_INT=5125]="UNSIGNED_INT",e[e.FLOAT=5126]="FLOAT",e[e.HALF_FLOAT=36193]="HALF_FLOAT"}(Ht||(Ht={}));const Gt=["NVIDIA","AMD","Intel","Apple","Adreno","Mali","Quadro","GeForce","llvmpipe","PowerVR","Vivante","VideoCore"];function kt(e){switch(e){case Ht.BYTE:case Ht.UNSIGNED_BYTE:return 1;case Ht.SHORT:case Ht.UNSIGNED_SHORT:case Ht.HALF_FLOAT:return 2;case Ht.INT:case Ht.UNSIGNED_INT:case Ht.FLOAT:return 4;default:return Ut.warn("Unrecognized GL type: 0x"+e.toString(16)),0}}function Wt(e,t){return t===k.xB1.ARRAY_BUFFER?e.ARRAY_BUFFER:t===k.xB1.ELEMENT_ARRAY_BUFFER?e.ELEMENT_ARRAY_BUFFER:null}var zt,Xt;function Zt(e){switch(e){case zt.STENCIL_INDEX:case zt.STENCIL_INDEX8:return 1;case zt.RGBA4:case zt.RGB5_A1:case zt.RGB565:case zt.DEPTH_COMPONENT16:return 2;case zt.DEPTH_STENCIL:return 4;default:return Ut.warn("Unrecognized GL render buffer type: 0x"+e.toString(16)),0}}function qt(e){switch(e){case Xt.DEPTH_COMPONENT:case Xt.ALPHA:case Xt.LUMINANCE:return 1;case Xt.LUMINANCE_ALPHA:return 2;case Xt.RGB:return 3;case Xt.RGBA:return 4;default:return Ut.warn("Unrecognized GL pixel format: 0x"+e.toString(16)),0}}function Yt(e){if(e){const t=["swiftshader"],i=e.toLowerCase();return t.some((e=>i.includes(e)))}return!1}function Kt(){return{glVendor:"unavailable",glRenderer:"unavailable",isCpuRenderer:!1}}!function(e){e[e.RGBA4=32854]="RGBA4",e[e.RGB5_A1=32855]="RGB5_A1",e[e.RGB565=36194]="RGB565",e[e.DEPTH_COMPONENT16=33189]="DEPTH_COMPONENT16",e[e.STENCIL_INDEX=6401]="STENCIL_INDEX",e[e.STENCIL_INDEX8=36168]="STENCIL_INDEX8",e[e.DEPTH_STENCIL=34041]="DEPTH_STENCIL"}(zt||(zt={})),function(e){e[e.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",e[e.ALPHA=6406]="ALPHA",e[e.RGB=6407]="RGB",e[e.RGBA=6408]="RGBA",e[e.LUMINANCE=6409]="LUMINANCE",e[e.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA"}(Xt||(Xt={}));const jt=new Map;function Qt(e){let t=null;if(e)try{if(t=jt.get(e),t)return t;const i=(0,pt.isBrowserFirefox)()?null:e.getExtension("WEBGL_debug_renderer_info");let s,n;i?(s=e.getParameter(i.UNMASKED_RENDERER_WEBGL),n=e.getParameter(i.UNMASKED_VENDOR_WEBGL)):(s=e.getParameter(e.RENDERER),n=e.getParameter(e.VENDOR)),t={glVendor:n,glRenderer:s,isCpuRenderer:Yt(s)},jt.set(e,t)}catch(e){Ut.warn("Web client capability - failed inside getRendererInfo -- "+e)}return t}function $t(e){const t=Qt(e);return(0,pt.isRendererStringForIntel)(t.glRenderer)}function Jt(e){if(!e)return!1;const t=e.toLowerCase();return!Gt.some((e=>t.includes(e)))&&t.includes("unknown")}let ei,ti=null,ii=null,si=null,ni=null;function ri(e){void 0===ei?(ei=e,ei?(ti=Uint32Array,ii=Ht.UNSIGNED_INT):(ti=Uint16Array,ii=Ht.UNSIGNED_SHORT),si=kt(ii),ni=Math.pow(2,8*si)):ei!==e&&Ut.warn("initialize32BitIndexSupport called twice with two different values")}function ai(){if(!ti)throw"Attempt to get indexBufferType before gl initialized";return ti}function oi(){if(!ii)throw"Attempt to get indexElementType before gl initialized";return ii}function hi(){if(!si)throw"Attempt to get indexElementSize before gl initialized";return si}function ci(){if(!ni)throw"Attempt to get maximumVerticesPerVbo before gl initialized "+(new Error).stack;return ni}var li=i(49622);const di=_e.O.createLogger("State",k.bVy.GRAPHICS);class ui{constructor(){this.gl=null,this.state={},this.stack=[]}setGlContext(e){this.gl=e,this.callGl("depthMask",!0),this.callGl("depthFunc",this.getGl().LEQUAL)}getGl(){return this.gl}capture(){this.stack.push(this.state),this.state=Object.create(this.state)}restore(){if(0===this.stack.length)return void di.warn("Graphics state restore attempted without previous capture");const e=this.state,t=this.stack.pop();for(const i in e)if(e.hasOwnProperty(i)){const e=t[i];e&&this.callGl(i,e[0],e[1],e[2],e[3])}this.state=t}callGl(e,t,i,s,n){const r=this.state[e];if(r&&r[0]===t&&r[1]===i&&r[2]===s&&r[3]===n)return;const a=[t,i,s,n];this.gl[e].apply(this.gl,a),this.state[e]=a}getState(e){return this.state[e]}}var gi=i(7037),pi=i(19027),mi=i(36771);class fi{constructor(){this.selected=!1,this.preSelected=!1,this.edgePreSelected=!1,this.edgePointUiElement=null,this.selectedSheetmetalModelId=null}}const Ii=function(e){return e===(0,Me.Wf)()},Ei=function(e,t){if(!(t.isEdge()&&!t.isClosedCurve()))return!1;const i=e.getSketch();if(!t.getSketchEntityId()||!i)return!0;const s=t.getFeatureIds();return 1!==s.length||i.id!==s[0]},Si=function(e){return e.isEdgePoint()},Ti=function(e){if(!e.isVertex())return!1;const t=gt.T.getFeatureOrSubfeatureNode((0,Me.hN)(e));return t?.getFeatureType()===mi.T.CONSTRUCTION_POINT&&t?.getName()===Me.o$.EDGE_POINT},Di=function(e){const t=gi._3.getActiveFeatureController();if(t){const i=t.featureModel;if(i&&(!e||!i.get("isSketch")))return i}return null};class Ci extends m.T{constructor(e){super(),this.viewer=e,this.edgePointUiElements={},this.purgeTimer=null,this.isEnabled=!1,(0,Sh.Yk)(e),this.edgePointCandidate=new lI.G9;const t=X.default.getManager();this.edgePointPixelSize=t.getNumber("POINT_BODY_SIZE")}enable(){this.viewer.getIsForPreviousVersionDisplay()||(this.isEnabled=!0,this.stopListening(),this.listenTo((0,Me.vi)(),"add",this.onSelectionAdded),this.listenTo((0,Me.vi)(),"remove",this.onSelectionRemoved),this.listenTo((0,Me.vi)(),"reset",this.onSelectionReset),this.listenTo((0,Me.Wf)(),"add",this.onSelectionAdded),this.listenTo((0,Me.Wf)(),"remove",this.onSelectionRemoved),this.listenTo((0,Me.Wf)(),"reset",this.onSelectionReset))}disable(){this.isEnabled&&(this.isEnabled=!1,this.stopListening(),this.removeAllEdgePointUiElements((0,Me.vi)()),this.removeAllEdgePointUiElements((0,Me.Wf)()))}addEdgePointUiElement(e,t,i){let s;s=t?e.getDeterministicId():e.getIdString();let n=this.edgePointUiElements[s];if(n||(n=new fi),t?n.edgePreSelected=!0:i?n.preSelected=!0:n.selected=!0,t&&i){const t=lg.getEdgePointLocation(this.viewer,e,.5),i=this.viewer.getCamera();if(!i)return null;const s=i.getPixelSizeAtWorldPoint(t)*this.edgePointPixelSize;if(!t||(0,Me.vi)().models.find((e=>{if(Ti(e)){const i=this.viewer.getModelViewManagers().getManager().extractMeshIncrement(e.getDeterministicId());if(i){const e=i.points;return ge.S4.length(ge.S4.subtract(t,e,M.create()))<s}}return!1}),this))return null}return n.edgePointUiElement||(n.edgePointUiElement=new lg(uh.lL,e,.5,this.viewer)),this.edgePointUiElements[s]=n,n.edgePointUiElement}removeEdgePointUiElementWithDeterministicId(e,t){return!!this.edgePointUiElements.hasOwnProperty(e)&&(t?(this.edgePointUiElements[e].preSelected=!1,this.edgePointUiElements[e].edgePreSelected=!1):this.edgePointUiElements[e].selected=!1,!0)}purgeEdgePointUiElements(e){this.purgeTimer&&(clearTimeout(this.purgeTimer),this.purgeTimer=null);const t=[];Object.entries(this.edgePointUiElements).forEach((function([i,s]){!e&&(s.selected||s.preSelected||s.edgePreSelected)||(s.edgePointUiElement.remove(),t.push(i))})),this.edgePointUiElements=(0,j.omitProperty)(this.edgePointUiElements,t)}delayedPurgeUiElements(){if(this.purgeTimer)return;const e=this;this.purgeTimer=window.setTimeout((function(){e.purgeEdgePointUiElements()}),0)}removeEdgePointUiElement(e,t,i){let s=e.getDeterministicId();t||(s=e.getIdString()),this.removeEdgePointUiElementWithDeterministicId(s,i)}removeAllEdgePointUiElements(e){const t=Ii(e);Object.entries(this.edgePointUiElements).forEach((([e,i])=>{this.removeEdgePointUiElementWithDeterministicId(e,t)}))}addSelection(e,t){if(e.isFromOccurrence()||e.isSectionEntity())return;const i=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio();if(i&&"string"==typeof e.selectionId)if(e.entityMetaData&&e.entityMetaData.isFromSketch()){if(e.isFlattened()!==this.viewer.getIsForFlattenedDisplay())return!1}else{const t=i.getBodyComponent(null).idToMetaData[e.selectionId];if(!t&&this.viewer.getIsForFlattenedDisplay())return!1;if(t&&t instanceof k.Wzw&&t.getBodyMetaData().isForFlattenedView()!==this.viewer.getIsForFlattenedDisplay())return!1;if(t&&t instanceof k.Wzw&&this.selectedSheetmetalModelId&&t.getBodyMetaData().sheetMetalModelId!==this.selectedSheetmetalModelId)return!1}const s=Ii(t),n=Si(e),r=Ei(this.viewer,e);if(n)this.addEdgePointUiElement(e,!1,s);else if(r){if(s){const t=(0,Me.Nd)();if(!t||t.filter(this.edgePointCandidate)){if("string"==typeof e.selectionId&&e.entityMetaData instanceof k.Wzw&&!i?.getBodyComponent().containsEntity(e.selectionId))return!1;if("string"==typeof e.selectionId&&e.entityMetaData instanceof k.S5B&&!i?.getSketchComponent().containsEntity(e.selectionId))return!1;this.addEdgePointUiElement(e,!0,s)}}}else if(Ti(e)&&!s){const t=this.viewer.getModelViewManagers().getManager();e.getFeatureIds().forEach((function(e){t.showPointBodies(e)}))}}onSelectionAdded(e,t){if(!e)return!1;const i=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio(),s=i?i.getEntityIdManager():null;s&&s.getIdForName(e.getIdString())!==Mi.JE&&this.addSelection(e,t)}onSelectionRemoved(e,t){if(!e)return!1;const i=this.viewer.getModelViewManagers().getManager(),s=Ii(t),n=Si(e),r=Ei(this.viewer,e);if(n){this.removeEdgePointUiElement(e,!1,s);const t=e.getSubfeatureId();t&&!s&&i.hidePointBodies(t),this.delayedPurgeUiElements()}else if(r&&s)this.removeEdgePointUiElement(e,!0,s),this.delayedPurgeUiElements();else if(Ti(e)&&!s&&Di(!0)){e.getFeatureIds().forEach((function(e){i.hidePointBodies(e)}))}}addMultipleSelections(e){e.models.forEach((t=>{this.addSelection(t,e)}))}onSelectionReset(e,t){if(this.removeAllEdgePointUiElements(e),!Ii(e)){const t=Di(!0);if(t&&!t.get("isSketch")){const i=function(e){const t=e.get("featureMsg");return t&&t.subFeatures?t.subFeatures.map((function(e){return e.featureId})):[]}(t),s=function(e){return e.filter((function(e){return Ti(e)&&1===e.getFeatureIds().length})).map((function(e){return e.getFeatureIds()[0]}))}(e),n=this.viewer.getModelViewManagers().getManager();(0,pi.difference)(i,s).forEach((function(e){n.hidePointBodies(e)}))}}this.addMultipleSelections(e),t&&t.isForRemapping?this.purgeEdgePointUiElements(!0):this.delayedPurgeUiElements()}getUIElementsForSelection(e){if(Si(e)){const t=this.edgePointUiElements[e.getIdString()];if(t)return[t.edgePointUiElement]}return[]}hideUIElementsForSelection(e){this.getUIElementsForSelection(e).forEach((function(e){e.hide()}))}setSelectedSheetmetalModelId(e){this.selectedSheetmetalModelId=e}}var Mi=i(13480),yi=i(63407),Ai=i(9757);const Pi=_e.O.createLogger("BitShiftId",k.bVy.GRAPHICS);class Oi{constructor(){this.id=0,this.shiftCount=0}getId(){return this.id}getShiftCount(){return this.shiftCount}reset(){this.id=0,this.shiftCount=0}addNumber(e,t){this.id|=e<<this.shiftCount,this.shiftCount+=t,this.shiftCount>31&&Pi.warn("BitShiftId exceeded 31 shifts; loss of uniqueness is possible")}addBoolean(e){this.addNumber(e?1:0,1)}getIdWithIdAppended(e){e>=Math.pow(2,wi.tl-this.shiftCount)&&Pi.warn("Lost uniqueness in creating id with getIdWithIdAppended");const t=e*Math.pow(2,this.shiftCount);return this.id+t}}var Ri=i(99669),wi=i(51236);const vi=Q.create(),_i=Q.create(),Ni=[];for(let e=0;e<4;++e)Ni.push(Q.create());const bi=new wi.tO;class Li{constructor(){this.occupiedBounds=[]}clearOccupiedRegions(){this.occupiedBounds=[]}addOccupiedRegion(e){this.occupiedBounds.push(e)}getUnoccupiedOffsetAlongDirection(e,t){const i=bi;i.copyFrom(e);let s=0;for(;;){let e=-1/0,n=!1;const r=i.center(vi);for(let s=0;s<this.occupiedBounds.length;++s)if(this.occupiedBounds[s].overlapsWith(i)){n=!0;let i=-1/0;const a=this.occupiedBounds[s].getCorners(Ni);for(let e=0;e<a.length;++e){const s=Q.dot(t,ge.gv.subtract(a[e],r,_i));s>i&&(i=s)}i>e&&(e=i)}if(!n)break;{let n=1/0;const a=i.getCorners(Ni);for(let e=0;e<a.length;++e){const i=Q.dot(t,ge.gv.subtract(a[e],r,_i));i<n&&(n=i)}const o=e-n;if(!(o>Ri.W.ZERO_LENGTH))break;i.translate(ge.gv.scale(t,o,_i)),s+=o}}return s}}var Fi=i(57792);const xi=new Mi.s;class Bi{constructor(e){this.ambientTextureFactor=0,this.ambientTexture=null,this.shaderId=null,this.isVisible=!0,this.customFloatUniformSettings=null,this.customIntUniformSettings=null,this.customMatrixUniforms=null,this.customVectorUniforms=null;const t=X.default.getManager();this.color=t.getColor("DEFAULT_MATERIAL_COLOR"),this.specularColor=t.getColor("DEFAULT_SPECULAR"),this.diffuseFactor=t.getNumber("COLOR_DIFFUSE_FACTOR"),this.ambientFactor=t.getNumber("COLOR_AMBIENT_FACTOR"),this.shininess=t.getNumber("DEFAULT_SHININESS"),this.translucentPassAlpha=t.getNumber("TRANSLUCENT_PASS_ALPHA"),this.pointSize=t.getNumber("DEFAULT_POINT_SIZE"),this.pointFont=t.getPointFont("DEFAULT_POINT_FONT"),this.lineWidth=t.getNumber("DEFAULT_LINE_WIDTH"),this.lineStipple=t.getStipple("DEFAULT_LINE_STIPPLE"),e&&((0,j.overwriteMatchingProperties)(this,e),e.hasOwnProperty("ambientTexture")&&!e.hasOwnProperty("ambientTextureFactor")&&(this.ambientTextureFactor=1)),this.id=xi.getId(),this.specularColor=this.specularColor.slice(0,3),this.highlightSpecularContribution=t.getNumber("HIGHLIGHT_SPECULAR_CONTRIBUTION")}destroy(){xi.isIdValid(this.id)&&(xi.freeId(this.id),this.id=Mi.c2)}setTexture(e){this.ambientTexture!==e&&(this.ambientTexture=e,this.ambientTextureFactor=1)}getTexture(){return this.ambientTexture}makeSceneDebugObject(){return(0,Xs.bN)(this,"Material "+this.id)}setCustomFloatUniform(e,t){this.customFloatUniformSettings||(this.customFloatUniformSettings=new Fi.N),this.customFloatUniformSettings.set(e,t)}setCustomIntUniform(e,t){this.customIntUniformSettings||(this.customIntUniformSettings=new Fi.N),this.customIntUniformSettings.set(e,t)}setCustomMatrixUniform(e,t){this.customMatrixUniforms||(this.customMatrixUniforms=new Fi.N),this.customMatrixUniforms.set(e,t)}setCustomVectorUniform(e,t){this.customVectorUniforms||(this.customVectorUniforms=new Fi.N),this.customVectorUniforms.set(e,t)}setAttributes(e,t){if(e){if(t.setLastBufferBound(null),e.vertexAttrib4fv(PS.COLOR,this.color),e.uniform3fv("uSpecular",this.specularColor),e.uniform1f("uShininess",this.shininess),e.uniform1f("uColorDiffuseFactor",this.diffuseFactor),e.uniform1f("uColorAmbientFactor",this.ambientFactor),this.ambientTexture?(this.ambientTexture.viewer=t.viewer,e.useTexture("uAmbientTexture",this.ambientTexture)):e.useBlankTexture("uAmbientTexture"),e.uniform1f("uAmbientTextureFactor",this.ambientTextureFactor),e.uniform1f("uTranslucentPassAlpha",this.translucentPassAlpha),e.uniform1f("uHighlightSpecularContribution",this.highlightSpecularContribution),e.uniform1f("uIsolateTranslucentAlpha",this.isolateTranslucentAlpha),this.customFloatUniformSettings){const t=this.customFloatUniformSettings.getKeyValues();for(let i=0;i<t.length;i+=2)e.setFloatUniform(t[i],t[i+1])}if(this.customIntUniformSettings){const t=this.customIntUniformSettings.getKeyValues();for(let i=0;i<t.length;i+=2)e.setIntUniform(t[i],t[i+1])}if(this.customMatrixUniforms){const t=this.customMatrixUniforms.getKeyValues();for(let i=0;i<t.length;i+=2)e.setMatrixUniform(t[i],t[i+1])}if(this.customVectorUniforms){const t=this.customVectorUniforms.getKeyValues();for(let i=0;i<t.length;i+=2)e.setVectorUniform(t[i],t[i+1])}}}hasTransparency(){return this.color[3]<1||!!this.ambientTexture&&this.ambientTexture.getHasTransparency()}getExtendedShaderId(){return this.shaderId}}const Vi=new Bi({ambientFactor:1,diffuseFactor:0,specularColor:[0,0,0]}),Ui=new Bi;function Hi(e){return new Bi({ambientTexture:e,diffuseFactor:0,ambientFactor:1,specularColor:[0,0,0]})}var Gi=i(89942);const ki=X.default.getManager(),Wi=new Gi.hF({isShowThrough:!0,isPickable:!1,primitiveType:Ai.MX.LINES}),zi=M.fromValues(1,0,0),Xi=M.fromValues(0,1,0),Zi=M.fromValues(0,0,1),qi=new Gi.hF({isPickable:!1,primitiveType:Ai.MX.TRIANGLES,material:null}),Yi=(0,wi.Yr)(ki.getNumber("VIEW_CUBE_AXIS_LABEL_FADE_START_ANGLE")),Ki=(0,wi.Yr)(ki.getNumber("VIEW_CUBE_AXIS_LABEL_FADE_END_ANGLE")),ji="axes3D",Qi="axis_label";class $i extends yi.u1{constructor(e,t,i,s,n){super(n,uh.EG),this.label=e,this.direction=t,this.color=i,this.axisLength=s,this.transformedDirection=null,this.labelTexture=null,this.position=null,this.lastSetOpacity=-1,this.nodeProperties=new Gi.hF(qi),this.nodeProperties.material=Hi(),this.nodeProperties.updateId(),this.ensureTexture(),this.show()}onDevicePixelRatioChanged(e){this.labelTexture=null,this.ensureTexture(),this.updateIncrements()}remove(){this.labelTexture&&(this.labelTexture.destroy(),this.labelTexture=null),this.nodeProperties.material&&(this.nodeProperties.material.destroy(),this.nodeProperties.material=null),super.remove()}updateIncrements(){const e=ki.getNumber("VIEW_CUBE_AXIS_TEXT_HEIGHT_PX"),t=this.labelTexture.filledWidthPx,i=(0,Yd.fQ)([-t/2,-e/2,0],[t/2,-e/2,0],[-t/2,e/2,0],void 0,[this.labelTexture.leftCoordinate,this.labelTexture.bottomCoordinate],[this.labelTexture.rightCoordinate,this.labelTexture.topCoordinate]);this.updateMeshIncrement(Qi,yi.ZJ,i,this.nodeProperties)}ensureTexture(){this.viewer.getGlContext()&&(this.labelTexture||(this.labelTexture=jo(this.viewer,this.label,{color:this.color,font:ki.getString("VIEW_CUBE_TEXT_FONT"),size:ki.getNumber("VIEW_CUBE_AXIS_TEXT_HEIGHT_PX")}),this.nodeProperties.material.ambientTexture=this.labelTexture,this.updateIncrements()))}updateTransform(e){if(!this.position||!this.transformedDirection)return;const t=Math.acos(Math.abs(M.dot(e.getForward(),this.transformedDirection))),i=(0,wi.CW)(Ki,Yi,t);this.setOpacity(i),this.setTransform(ge.w$.translate(ue.create(),this.position))}setOpacity(e){if(e===this.lastSetOpacity)return;const t=new Uint8Array([255,255,255,255*e]);this.updateIncrementAttribute(Qi,RS.COLOR,t),this.lastSetOpacity=e}}class Ji extends yi.u1{constructor(e,t){super(e),this.coordinateSystemTransform=null,this.axisLabels={},this.setId(ji),this.highlightId=yi.ZJ,t=t||{},this.axesName=t.hasOwnProperty("axesName")?t.axesName:null,this.hasXAxis=!t.hasOwnProperty("hasXAxis")||t.hasXAxis,this.hasYAxis=!t.hasOwnProperty("hasYAxis")||t.hasYAxis,this.hasZAxis=!t.hasOwnProperty("hasZAxis")||t.hasZAxis,this.XAxisColor=t.hasOwnProperty("XAxisColor")?t.XAxisColor:ki.getColor("X_AXIS_COLOR"),this.YAxisColor=t.hasOwnProperty("YAxisColor")?t.YAxisColor:ki.getColor("Y_AXIS_COLOR"),this.ZAxisColor=t.hasOwnProperty("ZAxisColor")?t.ZAxisColor:ki.getColor("Z_AXIS_COLOR");const i=ki.getNumber("AXIS_LINE_WIDTH_PX");this.XAxisWidth=t.hasOwnProperty("XAxisWidth")?t.XAxisWidth:i,this.YAxisWidth=t.hasOwnProperty("YAxisWidth")?t.YAxisWidth:i,this.ZAxisWidth=t.hasOwnProperty("ZAxisWidth")?t.ZAxisWidth:i;const s=ki.getNumber("AXIS_LINE_LENGTH_PX");this.XAxisStartEndPixel=t.hasOwnProperty("XAxisStartEndPixel")?t.XAxisStartEndPixel:[0,s],this.YAxisStartEndPixel=t.hasOwnProperty("YAxisStartEndPixel")?t.YAxisStartEndPixel:[0,s],this.ZAxisStartEndPixel=t.hasOwnProperty("ZAxisStartEndPixel")?t.ZAxisStartEndPixel:[0,s],this.hasXAxis&&(this.axisLabels.X=new $i("X",zi,ki.getColor("X_AXIS_COLOR"),this.XAxisStartEndPixel[1],this.viewer)),this.hasYAxis&&(this.axisLabels.Y=new $i("Y",Xi,ki.getColor("Y_AXIS_COLOR"),this.YAxisStartEndPixel[1],this.viewer)),this.hasZAxis&&(this.axisLabels.Z=new $i("Z",Zi,ki.getColor("Z_AXIS_COLOR"),this.ZAxisStartEndPixel[1],this.viewer)),this.ensureTexture(),this.listenTo(this.viewer.getEventDispatcher(),nM.Hv,this.onViewWillDraw)}onViewWillDraw(e,t){if(this.updateGraphics(e),this.coordinateSystemTransform)for(const t in this.axisLabels){const i=this.axisLabels[t],s=i.axisLength+ki.getNumber("AXIS_LABEL_OFFSET_PX"),n=ge.S4.scale(this.axisLabels[t].direction,s,M.create()),r=ge.w$.multiplyVec4(this.transform,y.fromValues(n[0],n[1],n[2],1),y.create()),a=e.projectWorldPointToViewport(r);i.position=a;const o=y.fromValues(i.direction[0],i.direction[1],i.direction[2],0);ge.w$.multiplyVec4(this.transform,o,y.create());i.transformedDirection||(i.transformedDirection=y.create()),M.copy(i.transformedDirection,i.direction),i.transformedDirection[3]=0,ge.w$.multiplyVec4(this.transform,i.transformedDirection),ge.S4.normalize(i.transformedDirection),i.updateTransform(e)}}addAxis(e,t,i,s,n){const r=ge.S4.scale(t,n[0],M.create()),a=ge.S4.scale(t,n[1],M.create()),o=(0,Yd.W5)(r,a);(0,Yd.VQ)(s,o),(0,Yd.Ab)(i,o),this.updateMeshIncrement(e,yi.ZJ,o,Wi)}updateGraphics(e){if(null===this.coordinateSystemTransform)return;!this.hasMeshIncrements()&&this.coordinateSystemTransform&&(this.hasXAxis&&this.addAxis("X_AXIS",zi,this.XAxisColor,this.XAxisWidth,this.XAxisStartEndPixel),this.hasYAxis&&this.addAxis("Y_AXIS",Xi,this.YAxisColor,this.YAxisWidth,this.YAxisStartEndPixel),this.hasZAxis&&this.addAxis("Z_AXIS",Zi,this.ZAxisColor,this.ZAxisWidth,this.ZAxisStartEndPixel));const t=M.fromValues(this.coordinateSystemTransform[12],this.coordinateSystemTransform[13],this.coordinateSystemTransform[14]),i=e.getPixelSizeAtWorldPoint(t),s=M.fromValues(i,i,i),n=ge.w$.scale(this.coordinateSystemTransform,s,ue.create());this.setTransform(n)}updateDefinition(e){this.coordinateSystemTransform=e}hide(){this.hasXAxis&&this.axisLabels.X.hide(),this.hasYAxis&&this.axisLabels.Y.hide(),this.hasZAxis&&this.axisLabels.Z.hide(),super.hide()}show(){this.hasXAxis&&this.axisLabels.X.show(),this.hasYAxis&&this.axisLabels.Y.show(),this.hasZAxis&&this.axisLabels.Z.show(),super.show()}ensureTexture(){for(const e in this.axisLabels)this.axisLabels[e].ensureTexture()}remove(){for(const e in this.axisLabels)this.axisLabels[e].remove();super.remove()}}var es=i(72372);const ts={ASSEMBLY:"Assembly",PART_STUDIO:"Part Studio",SKETCH:"Sketch",UNSUPPORTED:"Default"};class is extends m.T{constructor(e){super(),this.commands={},this.spaceBallConnection=e}startListeningToEvents(){this.listenTo((0,nM.xA)(),nM.Fc,this.setActiveCommandSet),this.listenTo((0,nM.xA)(),nM.RV,this.executeCommand),this.listenTo((0,nM.xA)(),nM.TN,this.commandSetReceived)}stopListeningToEvents(){this.stopListening()}setActiveCommandSet(e){this.spaceBallConnection.update3dcontroller({commands:{activeSet:e}})}commandSetReceived(e){const t=new _3Dconnexion.ActionTree,i=new _3Dconnexion.ImageCache,s=this;for(let s=0;s<e.length;s++){const n=e[s],r=n.tabType,a=t.push(new _3Dconnexion.ActionSet(r,"")).push(new _3Dconnexion.Category("Action_Id_"+r,"Commands"));for(let e=0;e<n.commands.length;e++){const t=n.commands[e];let s=t.command,o=t.icon?"/images/"+t.icon+".svg":"";(this.commands[s]||n.tabId===k.GNh.PARTSTUDIO&&"mateConnector"===t.command)&&(s=r+"-"+t.command),(t.command.indexOf("mate")>-1||t.command.indexOf("Mate")>-1)&&"mateConnector"!==t.command&&(t.icon&&(o="/images/mate/"+t.icon+".svg"),s=t.command+"_"+t.commandDetails),"load"===t.command&&(s=t.command+"_"+t.commandDetails),a.push(new _3Dconnexion.Action(s,i18n(t.name),"")),this.commands[s]=t,o&&i.push(_3Dconnexion.ImageItem.fromURL(o,s))}}t.push(new _3Dconnexion.ActionSet(ts.UNSUPPORTED,"")),i.onload=function(){s.spaceBallConnection.update3dcontroller({images:i.images})};let n=ts.UNSUPPORTED;(0,gt._R)()?n=ts.ASSEMBLY:(0,gt._B)()&&(n=ts.PART_STUDIO),this.spaceBallConnection.update3dcontroller({commands:{activeSet:n,tree:t}})}executeCommand(e){this.commands[e]&&es.Jq.SpaceballService.executeCommand(this.commands[e])}}var ss=i(96546),ns=i(88892),rs=i(57702);class as extends m.T{constructor(e,t){super(),this.viewer=e,this.mouseMoveTextCallback=t,this.APPENDAGE_ID="cursor-appendage-user",this.addListeners()}addListeners(){const e=this.viewer.getEventDispatcher();this.listenTo(e,nM.oG,this.onMouseMove),this.listenTo(e,nM.u5,this.onMouseLeave)}destroy(){this.removeContainer(),this.stopListening()}onMouseMove(e){const t=this.viewer.getCanvasCoordinateFromEvent(e);this.updatePosition([...t])}updatePosition(e){const t=this.mouseMoveTextCallback(e[0],e[1]);if(t){const i=(0,ns.x_)(),s=[e[0]/i,e[1]/i],n=this.getContainer();n.text(t),n.css({left:s[0]+25+"px",top:s[1]+"px"})}else this.removeContainer()}onMouseLeave(e){this.removeContainer()}getContainer(){let e=rs("#"+this.APPENDAGE_ID);return 0===e.length&&(e=rs("<div></div>").appendTo((0,ss.Ug)()),e.attr("class",as.CONTAINER_CLASS),e.attr("id",this.APPENDAGE_ID)),e}removeContainer(){rs("#"+this.APPENDAGE_ID).remove()}}as.CONTAINER_CLASS="cursor-appendage";var os=i(4087);class hs extends as{constructor(){super(...arguments),this.APPENDAGE_ID="cursor-appendage-leader"}addListeners(){const e=this.viewer.getEventDispatcher();this.listenTo(e,os.Awy,this.updatePosition),this.listenTo(e,os.NfU,this.onMouseLeave),this.listenTo(e,os.Gfg,this.removeContainer)}updatePosition(e){const t=(0,ns.x_)(),i=e.map((e=>e*t));super.updatePosition(i)}}var cs=i(51465);const ls=_e.O.createLogger("Sketch",k.bVy.GRAPHICS);class ds{constructor(e,t,i){this.viewer=i,this.dragItems=null,this.dragSequenceId=1,this.showDimensionExpressions_=!1,this.id=e,this.planeMatrix=ue.create(),this.planeMatrixrixInverse=ue.create(),this.appliedTransform=ue.create(),this.computedPlaneMatrix=ue.create(),this.computedInverse=ue.create(),t?(this.planeMatrix[0]=t.m00,this.planeMatrix[1]=t.m10,this.planeMatrix[2]=t.m20,this.planeMatrix[3]=0,this.planeMatrix[4]=t.m01,this.planeMatrix[5]=t.m11,this.planeMatrix[6]=t.m21,this.planeMatrix[7]=0,this.planeMatrix[8]=t.m02,this.planeMatrix[9]=t.m12,this.planeMatrix[10]=t.m22,this.planeMatrix[11]=0,this.planeMatrix[12]=t.m03,this.planeMatrix[13]=t.m13,this.planeMatrix[14]=t.m23,this.planeMatrix[15]=1):ls.info("invalid plane definition"),this.planeMatrixrixInverse=ge.w$.set(this.planeMatrix,this.planeMatrixrixInverse),ge.w$.inverse(this.planeMatrixrixInverse),this.startPt=M.create(),this.endPt=M.create(),this.p0=y.create(),this.p1=y.create(),this.p2=y.create(),this.p3=y.create(),this.updateComputedTransforms()}set showDimensionExpressions(e){this.showDimensionExpressions_=e,this.viewer.getEventDispatcher().trigger(nM.yB,e)}get showDimensionExpressions(){return this.showDimensionExpressions_}updateComputedTransforms(){return ge.w$.multiply(this.appliedTransform,this.planeMatrix,this.computedPlaneMatrix),ge.w$.inverse(ge.w$.multiply(this.appliedTransform,this.planeMatrix,this.computedInverse))}getId(){return this.id}getAppliedTransform(){return this.appliedTransform}getPlaneMatrix(){return this.computedPlaneMatrix}getPlaneDefPlaneMatrix(){return this.planeMatrix}getPlaneMatrixInverse(){return this.computedInverse}setAppliedTransform(e){this.appliedTransform=e,this.updateComputedTransforms()}startPointScreen(e){this.startPt=this.toWorld(e)}endPointScreen(e){this.endPt=this.toWorld(e)}resetState(){this.entityIds=null,this.dragItems=null}toPlane(e){const t=this.toWorld(e);if(!t)return null;let i=y.create();const s=y.create();return s[0]=t[0],s[1]=t[1],s[2]=t[2],s[3]=1,i=ge.w$.multiplyVec4(this.getPlaneMatrixInverse(),s,i),[i[0],i[1],0]}toWorld(e){const t=(0,j.as)(ar,this.viewer.getPrimaryViewController()).camera.getRay(e[0],e[1]);return(0,wi.bZ)(t,this.getPlaneMatrix())}getCanvasCoordinates(e){const t=this.viewer.getCamera(),i=this.planeToWorld(e),s=t.projectWorldPointToCanvas(i);return ge.S4.scale(s,1/(0,ns.x_)())}planeVec4ToWorld(e){let t=y.create();return t=ge.w$.multiplyVec4(this.getPlaneMatrix(),e,t),M.fromValues(t[0],t[1],t[2])}planeToWorld(e){return this.planeVec4ToWorld(y.fromValues(e[0],e[1],0,1))}planeVectorToWorld(e){return this.planeVec4ToWorld(y.fromValues(e[0],e[1],e[2],0))}worldToPlane(e){let t=y.create();const i=y.create();return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=1,t=ge.w$.multiplyVec4(this.getPlaneMatrixInverse(),i,t),[t[0],t[1],t[2]]}getSketchNormal(){const e=[],t=this.getPlaneMatrix();return e[2]=t[10],e[1]=t[9],e[0]=t[8],e}createIncludeNonParallelPlaneFilter(){const e=this.getSketchNormal();return(0,cs.iQ)(e)}}var us=i(57702);i(37265);const gs=(0,pt.isBrowserFirefox)()&&(0,pt.isPlatformMac)();function ps(e,t,i){const s=i;return!!s.originalEvent&&(!(!gs||3!==i.which||e!==s.originalEvent.button||t!==s.originalEvent.buttons||!s.originalEvent.ctrlKey)&&(i.which=1,!0))}function ms(){!function(e){let t=null;e(document).on("mouseup",(function(e){t=null})),e.widget("bti.mouse",{version:"1.9.2",options:{cancel:"input,textarea,button,select,option",distance:1,delay:0},_mouseInit:function(){const t=this;this.element.on("mousedown."+this.widgetName,(function(e){return t._mouseDown(e)})).on("click."+this.widgetName,(function(i){if(!0===e.data(i.target,t.widgetName+".preventClickEvent"))return e.removeData(i.target,t.widgetName+".preventClickEvent"),i.stopImmediatePropagation(),!1})),this.started=!1,this.buttonState={leftButton:!1,middleButton:!1,rightButton:!1}},_mouseDestroy:function(){if(this.element.off("."+this.widgetName),this._mouseMoveDelegate){e(document).off("mousemove."+this.widgetName,this._mouseMoveDelegate);for(let t=1;t<=3;++t)e(document).off("mouseup."+this.widgetName+t,this._mouseUpDelegate)}},_mouseDown:function(i){if(t&&t!==this)return;this._mouseDownEvent=i;const s=this;return!!("string"==typeof this.options.cancel&&i.target.nodeName&&e(i.target).closest(this.options.cancel).length||!this._mouseCapture(i))||(function(e){ps(2,1,e)}(i),1===i.which?this.buttonState.leftButton=!0:2===i.which?this.buttonState.middleButton=!0:3===i.which&&(this.buttonState.rightButton=!0),this.mouseDelayMet=!this.options.delay,this.mouseDelayMet||(this._mouseDelayTimer=setTimeout((function(){s.mouseDelayMet=!0}),this.options.delay)),this._mouseDistanceMet(i)&&this._mouseDelayMet(i)&&(this._mouseStarted=!1!==this._mouseStart(i),!this._mouseStarted)?(i.preventDefault(),!0):(!0===e.data(i.target,this.widgetName+".preventClickEvent")&&e.removeData(i.target,this.widgetName+".preventClickEvent"),this._mouseMoveDelegate||(this._mouseMoveDelegate=function(e){return s._mouseMove(e)},e(document).on("mousemove."+this.widgetName,this._mouseMoveDelegate)),this._mouseUpDelegate=function(e){return s._mouseUp(e)},e(document).on("mouseup."+this.widgetName+i.which,this._mouseUpDelegate),i.preventDefault(),t=this,!0))},_mouseMove:function(t){return e.ui.ie&&document.documentMode<9&&!t.button?this._mouseUp(t):this._mouseStarted?(this._mouseDrag(t),t.preventDefault()):(this._mouseDistanceMet(t)&&this._mouseDelayMet(t)&&(this._mouseStarted=!1!==this._mouseStart(this._mouseDownEvent,t),this._mouseStarted?this._mouseDrag(t):this._mouseUp(t)),!this._mouseStarted)},_mouseUp:function(i){!function(e){ps(2,0,e)}(i),1===i.which?this.buttonState.leftButton=!1:2===i.which?this.buttonState.middleButton=!1:3===i.which&&(this.buttonState.rightButton=!1),e(document).off("mouseup."+this.widgetName+i.which,this._mouseUpDelegate);const s=!this.buttonState.leftButton&&!this.buttonState.middleButton&&!this.buttonState.rightButton;return s&&(t=null,e(document).off("mousemove."+this.widgetName,this._mouseMoveDelegate),this._mouseMoveDelegate=null),this._mouseStarted&&s?(i.target===this._mouseDownEvent.target&&e.data(i.target,this.widgetName+".preventClickEvent",!0),this._mouseStop(i),this._mouseStarted=!1):this._mouseStarted&&this._mouseDrag(i),!1},_mouseDistanceMet:function(e){return Math.max(Math.abs(this._mouseDownEvent.pageX-e.pageX),Math.abs(this._mouseDownEvent.pageY-e.pageY))>=this.options.distance},_mouseDelayMet:function(e){return this.mouseDelayMet},_mouseStart:function(e){},_mouseDrag:function(e){},_mouseStop:function(e){},_mouseCapture:function(e){return!0}}),e.widget("bti.dragHelper",e.bti.mouse,{widgetEventPrefix:"dragHelper",options:{onStart:function(e){},onDrag:function(e){},onStop:function(e){}},_create:function(){this._mouseInit(),this._dragging=!1},destroy:function(){return this.element.off(".dragHelper"),this._mouseDestroy(),this},dragging:function(){return this._dragging},cancelDragging:function(t){return this.buttonState.leftButton=!1,this.buttonState.middleButton=!1,this.buttonState.rightButton=!1,e.bti.mouse.prototype._mouseUp.call(this,t)},_mouseStart:function(e,t){this._dragging=!0,this.lastX=e.pageX,this.lastY=e.pageY,this.options.onStart.call(this,e,t)},_mouseDrag:function(e){this.options.onDrag.call(this,e,e.pageX-this.lastX,e.pageY-this.lastY),this.lastX=e.pageX,this.lastY=e.pageY},_mouseStop:function(e){this._dragging=!1,this.options.onStop.call(this,e)}})}(us)}var fs=i(16428),Is=i(53412),Es=i(55647),Ss=i(57702);const Ts=_e.O.createLogger("InputHandler",k.bVy.GRAPHICS);class Ds{constructor(e){this.cursor=kn.C.DEFAULT,this.viewer=null,this._isActivated=!1,this.viewer=e,this.cursor=(0,pt.isPlatformWindows)()?kn.C.BOXDESELECTION_CURSORS_WINDOWS:kn.C.BOXDESELECTION_CURSORS_GENERIC}setDeselectionCursor(){this.viewer.peekCursor()!==this.cursor&&(this._isActivated&&this.viewer.removeTopOccurrenceOfCursor(this.cursor),this._isActivated=!0,this.viewer.pushCursor(this.cursor))}setDefaultCursor(){this._isActivated&&this.viewer.removeTopOccurrenceOfCursor(this.cursor),this._isActivated=!1}get isActivated(){return this._isActivated}}ms();class Cs{constructor(e,t){this.editFeatureUnderCursor=e,this.viewer=t,this.sketch=null,this.lastMouseMovedEvent=null,this.lastMouseMoveTime=-1,this.showContextMenuOnMouseUp=!1,this.timeOfRightMouseButtonDown=0,this.mouseTravelSinceRightButtonDown=0,this.preHighlightTimeout=0,this.suppressMouseMovePick=!1,this.hoveredUiSelection=null,this.draggedUiSelection=null,this.longPressedUiSelection=null,this.skipNextClickSelection=!1,this.externalDragHandler=null,this.dragHandledExternally=!1,this.initialDragEvent=null,this.leftButtonDownOnDragStart=!1,this.startedLeftButtonDrag=!1,this.forcedManipulationActive=!1,this.dragTravel=0,this.dragStartTime=0,this.mouseInCanvas=!1,this.buttonState={leftButton:!1,middleButton:!1,rightButton:!1},this.middleMouseButtonDoubleClickHandler=null,this.altHeld=!1,this.ctrlHeld=!1,this.boxDeselectionCursorHandler=null,(0,Sh.Yk)(t),this.boxSelector=new mn(this.viewer),this.boxDeselectionCursorHandler=new Ds(this.viewer),this.setupEventHandlers()}setupEventHandlers(){const e=this,t=this.getViewer().$el;t.dragHelper({lastX:0,lastY:0,onStart:function(t,i){e.buttonState=this.buttonState,e.onDragStart(t,i)},onDrag:function(t,i,s){e.buttonState=this.buttonState;const n=(0,ns.x_)();e.onDrag(t,i*n,s*n,this.lastX*n,this.lastY*n)},onStop:function(t){e.buttonState=this.buttonState,e.onDragStop(t)}});const i=function(t){return t.bind(e)};t.on("mouseenter",i(Cs.prototype.onMouseEnter)),t.on("mouseleave",i(Cs.prototype.onMouseLeave)),t.on("mousemove",i(Cs.prototype.onMouseMove)),t.on("mousedown",i(Cs.prototype.onMouseDown)),t.on("mouseup",i(Cs.prototype.onMouseUp)),t.on("click",i(Cs.prototype.onClick)),t.on("dblclick",i(Cs.prototype.onDoubleClick)),t.on("mousewheel DOMMouseScroll",i(Cs.prototype.onMouseWheelScroll)),hh(t,i(Cs.prototype.onLongPress)),this.middleMouseButtonDoubleClickHandler=new zE(t,i(Cs.prototype.onMiddleMouseButtonDoubleClick)),Ss(document).on("keyup",i(Cs.prototype.onKeyUp)),Ss(document).on("keydown",i(Cs.prototype.onKeyDown))}remove(){this.boxDeselectionCursorHandler.setDefaultCursor(),this.boxSelector&&(this.boxSelector.remove(),this.boxSelector=null),this.middleMouseButtonDoubleClickHandler&&(this.middleMouseButtonDoubleClickHandler.off(),this.middleMouseButtonDoubleClickHandler=null)}setSketch(e){this.sketch=e}setExternalDragHandler(e){this.externalDragHandler=e}setSuppressMouseMovePick(e){this.suppressMouseMovePick=e,this.suppressMouseMovePick&&this.clearPreHighlightTimeout()}getLastMouseMovedEvent(){return this.lastMouseMovedEvent}isMouseRightButtonDown(){return this.buttonState.rightButton}isMouseMiddleButtonDown(){return this.buttonState.middleButton}isMouseLeftButtonDown(){return this.buttonState.leftButton}getViewer(){return this.viewer}onMouseEnter(e){this.viewer.getEventDispatcher().trigger(nM.ox,e),this.mouseInCanvas=!0,this.lastMouseMoveTime=-1,window.focus()}trackMouseMovement(e){let t=1/0;const i=(0,Xs.Wj)(),s=i-this.lastMouseMoveTime,n=X.default.getManager(),r=n.getNumber("CONTEXT_MENU_DISTANCE_THRESHOLD"),a=this.viewer.getCanvasCoordinateFromEvent(e),o=this.viewer.getCanvasCoordinateFromEvent(this.lastMouseMovedEvent);if(this.lastMouseMoveTime>0&&this.lastMouseMovedEvent){const e=ge.gv.length([a[0]-o[0],a[1]-o[1]]);t=e/s,n.getNumber("OUTPUT_MOUSE_SPEED")&&Ts.debug("Mouse speed: "+t.toFixed(3)+", distance since last movement: "+e.toFixed(2)+", time since last movement: "+s.toFixed(1)),this.mouseTravelSinceRightButtonDown+=e}return this.lastMouseMoveTime=i,this.lastMouseMovedEvent=e,this.showContextMenuOnMouseUp&&this.mouseTravelSinceRightButtonDown>r&&(this.showContextMenuOnMouseUp=!1),t}isViewManipulationActive(e){const t=this.getViewer().getPrimaryViewController();if(null!==t){if(t.isBeingManipulated())return!0;if(t.getManipulationMode(e,this.buttonState)!==aA.k.NONE)return!0}return(0,fh.aD)()}isNotManipulatingAndNotInZoom(e){return!this.suppressMouseMovePick&&!this.isViewManipulationActive(e)&&!this.draggedUiSelection}onMouseMove(e){if(this.viewer.getEventDispatcher().trigger(nM.oG,e),e.isPropagationStopped())return!1;if(!this.viewer.isReadyForDrawing())return!1;const t=X.default.getManager(),i=this.trackMouseMovement(e);this.clearPreHighlightTimeout();const s=this.getViewer();s.updateLastMouseLocation(e),this.isNotManipulatingAndNotInZoom(e)&&(i<t.getNumber("PREHIGHLIGHT_SPEED_THRESHOLD")?this.triggerPreHighlightPick(e):(0,Me.Wf)().length>0?this.triggerPreHighlightPick(e,!0):this.schedulePreHighlightPick(e));const n=fs.k.getLeaderFollowModel();if(n.active){n.width=s.el.width,n.height=s.el.height;const t=s.isMouseInsideViewManipulator()?[-1,-1]:s.getCanvasCoordinateFromEvent(e);n.setCursorPosition(t)}return!0}onMouseLeave(e){this.viewer.getEventDispatcher().trigger(nM.u5,e),this.mouseInCanvas=!1,this.clearPreHighlightTimeout(),this.suppressMouseMovePick||(0,Me.Zs)(!0,!1)}eventCanBeUsedForContextMenu(e,t={ctrlClickShouldBeTreatedAsClick:!1}){if(e.which===Es.t.LEFT&&"mouseup"===e.type&&e.ctrlKey){const i=this.getViewer(),s=i.getCanvasCoordinateFromEvent(e),n=i.pick(s[0],s[1]);for(const i of n)if(i.getUISelection()?.shouldTreatCtrlClickAsClick(e))return t.ctrlClickShouldBeTreatedAsClick=!0,!1}return e.ctrlKey||e.which===Es.t.RIGHT}onMouseDown(e){(0,fh.aD)()&&(this.hoveredUiSelection=new Lh.i(this.boxSelector,cn,""),this.viewer.getUISelectionManager().setHoveredSelection(this.hoveredUiSelection,e)),this.eventCanBeUsedForContextMenu(e)&&(this.lastMouseMovedEvent=e,this.showContextMenuOnMouseUp=!0,this.mouseTravelSinceRightButtonDown=0,this.timeOfRightMouseButtonDown=(0,Xs.Wj)())}isMouseInCanvas(){return this.mouseInCanvas}onContextMenuWillHide(e,t){this.eventCanBeUsedForContextMenu(t)&&(this.lastMouseMovedEvent=null,this.showContextMenuOnMouseUp=!0,this.mouseTravelSinceRightButtonDown=0,this.timeOfRightMouseButtonDown=(0,Xs.Wj)())}onMouseUp(e){this.trackMouseMovement(e);const t=(0,Xs.Es)(this.timeOfRightMouseButtonDown)>X.default.getManager().getNumber("CONTEXT_MENU_TIME_THRESHOLD_MS"),i={ctrlClickShouldBeTreatedAsClick:!1};if(this.showContextMenuOnMouseUp&&!t&&this.eventCanBeUsedForContextMenu(e,i)){this.cancelDragging(e);const t={pickHandled:!1,contextMenuEnabled:!0,altKey:e.altKey};this.notifyGraphicsHandledClick(t),this.showContextMenu(e),Ss("#context-menu-layer").on("contextmenu:willhide",this.onContextMenuWillHide.bind(this))}i.ctrlClickShouldBeTreatedAsClick&&this.onClick(e,!0),this.longPressedUiSelection&&e.which===Es.t.LEFT&&(this.longPressedUiSelection.uiElement.triggerLongPressEnd(this.longPressedUiSelection,e),this.longPressedUiSelection=null,this.skipNextClickSelection=!0)}updatePicksForKeyEvent(e){if(this.isNotManipulatingAndNotInZoom(e)){const t=this.getViewer();if(!t||!t.getGlContext()||null===this.lastMouseMovedEvent)return;if(t!==(0,Sh.N9)())return;const i=t.getCanvasCoordinateFromEvent(this.lastMouseMovedEvent);t.doPick(i[0],i[1],!0,!0,{onlyRemovePreHighlight:!1,sourceEvent:e,altKey:e.altKey})}}onKeyDown(e){e.altKey&&!this.altHeld&&(this.altHeld=!0,this.updatePicksForKeyEvent(e)),e.ctrlKey&&!this.ctrlHeld&&(this.ctrlHeld=!0)}onKeyUp(e){!e.altKey&&this.altHeld&&(this.altHeld=!1,this.updatePicksForKeyEvent(e)),!e.ctrlKey&&this.ctrlHeld&&this.onReleaseCtrl(),e.which===Is.R8.ALT&&e.preventDefault()}onClick(e,t=!1){if(this.viewer.getEventDispatcher().trigger(nM.pU,e),!t&&(e.isPropagationStopped()||this.showContextMenuOnMouseUp&&this.eventCanBeUsedForContextMenu(e)))return;let i={altKey:e.altKey};const s=e.which===Es.t.LEFT;if(!this.isDragging()&&s&&!this.skipNextClickSelection){const t=this.getViewer(),s=t.getCanvasCoordinateFromEvent(e);i={click:!0,shiftKey:e.shiftKey,altKey:this.altHeld,ctrlKey:e.ctrlKey,sourceEvent:e},i.pickHandled=t.doPick(s[0],s[1],!1,!0,i)}this.skipNextClickSelection=!1,this.notifyGraphicsHandledClick(i)}onDoubleClick(e){if(this.viewer.getIsForPreviousVersionDisplay())return;let t;if(!this.isDragging()){if(e.which===Es.t.LEFT){const i=this.viewer.getCanvasCoordinateFromEvent(e);t=this.viewer.onDoubleClick(i[0],i[1],e),!t&&this.viewer.getCanEdit()&&this.editFeatureUnderCursor(i[0],i[1])}}this.notifyGraphicsHandledClick({pickHandled:t,altKey:e.altKey})}onMiddleMouseButtonDoubleClick(e){this.isDragging()||this.viewer.animateZoomFit()}onMouseWheelScroll(e){if(this.viewer.performingBoxSelection())return!1;if(!this.viewer.isReadyForDrawing())return!1;return!!this.viewer.getPrimaryViewController().zoomOnMouseWheelScroll(e)&&(this.viewer.getEventDispatcher().trigger(nM.h0,e),this.viewer.setUserIsAdjustingCamera(),this.viewer.requestDraw(),!1)}cancelDragging(e){this.getViewer().$el.dragHelper("cancelDragging",e)}isDragging(){return this.getViewer().$el.dragHelper("dragging")}onDragStart(e,t){if(this.leftButtonDownOnDragStart=this.buttonState.leftButton,this.viewer.performingBoxSelection())return;if(!this.viewer.isReadyForDrawing())return;this.initialDragEvent=e,this.dragTravel=0,this.dragStartTime=(0,Xs.Wj)();const i=this.viewer.getPrimaryViewController(),s=i.onDragStart(e,t,this.buttonState);this.leftButtonDownOnDragStart&&i.isBeingForceManipulated()&&(this.forcedManipulationActive=!0,this.leftButtonDownOnDragStart=!1),s&&this.viewer.getEventDispatcher().trigger(nM.h0,e),this.draggedUiSelection=null,this.dragHandledExternally=!1,this.startedLeftButtonDrag=!1,this.preHighlightTimeout&&(this.triggerPreHighlightPick(t),this.clearPreHighlightTimeout()),this.hoveredUiSelection=this.viewer.getUISelectionManager().getHoveredSelection()}onDrag(e,t,i,s,n){this.dragTravel+=ge.gv.length([t,i]);const r=this.getViewer();if(!r.performingBoxSelection()&&r.isReadyForDrawing())if(r.getPrimaryViewController().onDrag(e,this.buttonState,t,i,s,n),r.getPrimaryViewController().isBeingManipulated()?(this.viewer.setUserIsAdjustingCamera(),(0,Me.IQ)()):this.viewer.setUserIsManipulatingWithTimeout(),this.buttonState.leftButton||this.stopLeftMouseButtonHandlers.call(this,e),!this.startedLeftButtonDrag&&this.shouldStartLeftButtonDrag())this.startLeftButtonDrag();else if(this.draggedUiSelection){const t=r.getCanvasCoordinateFromEvent(e);this.draggedUiSelection.uiElement.triggerDrag(this.draggedUiSelection,{mouseX:t[0],mouseY:t[1],camera:r.getCamera(),shiftKey:e.shiftKey}),this.ctrlHeld&&!this.boxDeselectionCursorHandler.isActivated&&this.boxDeselectionCursorHandler.setDeselectionCursor()}else this.dragHandledExternally&&(this.sketch&&this.sketch.endPointScreen(r.getCanvasCoordinateFromEvent(e)),this.externalDragHandler&&this.externalDragHandler.onDrag(e))}onDragStop(e){const t=this.getViewer();e.ctrlKey||this.ctrlHeld&&(this.ctrlHeld=!1),this.boxDeselectionCursorHandler.setDefaultCursor(),this.leftButtonDownOnDragStart&&!this.startedLeftButtonDrag&&this.initialDragEvent&&!this.forcedManipulationActive&&this.onClick(this.initialDragEvent),this.forcedManipulationActive=!1,t.isReadyForDrawing()&&(t.getPrimaryViewController().onDragStop(e),this.stopLeftMouseButtonHandlers.call(this,e),this.suppressMouseMovePick||this.schedulePreHighlightPick(e))}schedulePreHighlightPick(e){const t=this,i=this.viewer.getAveragePickDuration()*X.default.getManager().getNumber("PAUSED_MOUSE_PREHIGHLIGHT_TIMEOUT_MULTIPLIER");this.preHighlightTimeout=window.setTimeout((function(){t.triggerPreHighlightPick(e),t.preHighlightTimeout=0}),i)}clearPreHighlightTimeout(){this.preHighlightTimeout&&(window.clearTimeout(this.preHighlightTimeout),this.preHighlightTimeout=0)}triggerPreHighlightPick(e,t){if(!e)return;const i=this.getViewer();if(!i||!i.getGlContext())return;if(this.viewer.getIsForPreviousVersionDisplay()&&"mousemove"!==e.type)return;const s=i.getCanvasCoordinateFromEvent(e);i.doPick(s[0],s[1],!0,!0,{onlyRemovePreHighlight:!!t,sourceEvent:e,altKey:this.altHeld})}shouldStartLeftButtonDrag(){const e=X.default.getManager(),t=(0,Xs.Wj)()-this.dragStartTime,i=this.getViewer().getPrimaryViewController();return!this.startedLeftButtonDrag&&!i.isBeingForceManipulated()&&this.leftButtonDownOnDragStart&&t>e.getNumber("LEFT_MOUSE_DRAG_TIME_TOLERANCE")&&this.dragTravel>e.getNumber("LEFT_MOUSE_DRAG_DISTANCE_TOLERANCE")}startLeftButtonDrag(){const e=this.getViewer();(0,fh.aD)()?this.hoveredUiSelection=new Lh.i(this.boxSelector,cn,""):this.triggerPreHighlightPick(this.initialDragEvent);const t=e.getCanvasCoordinateFromEvent(this.initialDragEvent);this.hoveredUiSelection&&this.hoveredUiSelection.uiElement.triggerDragStart(this.hoveredUiSelection,{mouseX:t[0],mouseY:t[1],camera:e.getCamera()})&&(this.draggedUiSelection=this.hoveredUiSelection),this.dragHandledExternally=!1,this.draggedUiSelection||(this.sketch&&this.sketch.startPointScreen(t),!this.externalDragHandler||this.ctrlHeld&&!this.sketch||(this.dragHandledExternally=this.externalDragHandler.onDragStart(this.initialDragEvent))),this.draggedUiSelection||this.dragHandledExternally||(this.ctrlHeld&&this.boxDeselectionCursorHandler.setDeselectionCursor(),this.draggedUiSelection=new Lh.i(this.boxSelector,cn,""),this.draggedUiSelection.uiElement.triggerDragStart(this.draggedUiSelection,{mouseX:t[0],mouseY:t[1],camera:e.getCamera()})||(this.draggedUiSelection=null)),this.startedLeftButtonDrag=!0}stopLeftMouseButtonHandlers(e){const t=this.getViewer();if(this.draggedUiSelection){const i=this.viewer.getCanvasCoordinateFromEvent(e);this.draggedUiSelection.uiElement.triggerDragStop(this.draggedUiSelection,{mouseX:i[0],mouseY:i[1],camera:t.getCamera()}),this.draggedUiSelection=null}this.dragHandledExternally&&(this.sketch&&this.sketch.endPointScreen([e.pageX,e.pageY]),this.externalDragHandler&&this.externalDragHandler.onDragStop(e),this.dragHandledExternally=!1)}showContextMenu(e){this.getViewer().$el.osContextMenu({x:e.pageX,y:e.pageY})}notifyGraphicsHandledClick(e){(0,nM.xA)().trigger(nM.sd,e),es.Jq.FlyoutService.collapseAllFlyouts(),e&&e.skipCommentClearHighlight||es.Jq.CommentEditService.clearCommentHighlights()}onLongPress(e,t){const i=this.viewer.getCanvasCoordinateFromEvent(t),s=this.viewer.pickIteratively(i[0],i[1],this.viewer.getDefaultPickTerminationEvaluator(),{altKey:e.altKey});let n=null;for(let e=0;e<s.length&&!n;++e)n=s[e].uiSelection;n&&(this.longPressedUiSelection=n,this.longPressedUiSelection.uiElement.triggerLongPressStart(this.longPressedUiSelection,e))}getAltHeld(){return this.altHeld}getCtrlHeld(){return this.ctrlHeld}onReleaseCtrl(){this.ctrlHeld=!1,this.boxDeselectionCursorHandler.setDefaultCursor()}}var Ms=i(71543),ys=i(23172),As=i(4889),Ps=i(56098),Os=i(52644),Rs=i(86405);const ws=_e.O.createLogger("editstate",k.bVy.GRAPHICS);var vs;!function(e){e.PREVIEW_STATE_CHANGE="previewStateChange",e.PREVIEW_BLEND_CHANGE="previewBlendChange"}(vs||(vs={}));const _s=.7;class Ns{constructor(){this.eventsSubject=new As.x,this.stateProperties=new Ps.X({previewAlpha:_s,latestDisplayDataUsage:k.rvN.BASE,inCompareMode:!1}),es.Jq.StateService?this.inCompareMode=es.Jq.StateService.isOnDocumentCompare():this.inCompareMode=!1,this.inCompareModeChangedObservable.subscribe((()=>{this.eventsSubject.next(vs.PREVIEW_STATE_CHANGE)})),this.latestDisplayDataUsageChangedObservable.subscribe((()=>{const e=this.inCompareMode;e||this.eventsSubject.next(vs.PREVIEW_STATE_CHANGE);const t=this.latestDisplayDataUsage===k.rvN.BASE,i=this.latestDisplayDataUsage===k.rvN.COMPARE_TARGET;!e||t||i?!e&&i&&ws.warn("Received COMPARE_TARGET message while not in compare mode."):ws.warn("Received a non-BASE and non-COMPARE_TARGET message while in compare mode.")})),this.previewAlphaChangedObservable.subscribe((()=>{this.eventsSubject.next(vs.PREVIEW_BLEND_CHANGE)}))}get inCompareModeChangedObservable(){return this.stateProperties.asObservable().pipe((0,Os.G)(),(0,ye.h)((([e,t])=>e.inCompareMode!==t.inCompareMode)),(0,Rs.U)((([e,t])=>t)))}get stateChangedObservable(){return this.eventsSubject.asObservable()}get latestDisplayDataUsageChangedObservable(){return this.stateProperties.asObservable().pipe((0,Os.G)(),(0,ye.h)((([e,t])=>e.latestDisplayDataUsage!==t.latestDisplayDataUsage)),(0,Rs.U)((([e,t])=>t)))}get previewAlphaChangedObservable(){return this.stateProperties.asObservable().pipe((0,Os.G)(),(0,ye.h)((([e,t])=>e.previewAlpha!==t.previewAlpha)),(0,Rs.U)((([e,t])=>t)))}get latestDisplayDataUsage(){return this.stateProperties.getValue().latestDisplayDataUsage}set latestDisplayDataUsage(e){const t={...this.stateProperties.getValue(),latestDisplayDataUsage:e};this.stateProperties.next(t)}get inCompareMode(){return this.stateProperties.getValue().inCompareMode}set inCompareMode(e){const t={...this.stateProperties.getValue(),inCompareMode:e};this.stateProperties.next(t)}get previewAlpha(){return this.stateProperties.getValue().previewAlpha}set previewAlpha(e){const t={...this.stateProperties.getValue(),previewAlpha:e};this.stateProperties.next(t)}}let bs=null;function Ls(){return bs||(bs=new Ns),bs}function Fs(){Ls().inCompareMode=!1,Ls().latestDisplayDataUsage=k.rvN.BASE}function xs(){return Ls().previewAlpha}function Bs(){return!!Hs()&&Ls().previewAlpha>.5}function Vs(){return Bs()?ys.L.PREVIEW:ys.L.BASE}function Us(){return Ls().latestDisplayDataUsage===k.rvN.BASE&&!Ls().inCompareMode}function Hs(){return Ls().inCompareMode}function Gs(){return Ls().latestDisplayDataUsage}function ks(){const e=Gs();return e===k.rvN.PREVIEW_BEFORE||e===k.rvN.PREVIEW_AFTER||e===k.rvN.PREVIEW_FINAL}function Ws(){return Gs()===k.rvN.PREVIEW_AFTER}function zs(){return Gs()===k.rvN.PREVIEW_FINAL}var Xs=i(11678);const Zs=new Bi({diffuseFactor:.5,ambientFactor:.5}),qs=new Gi.hF({isPickable:!1,isTwoSided:!0,primitiveType:Ai.MX.TRIANGLE_STRIP,isShowThrough:!0,isDepthTested:!1,priority:Gi.DO.LOWER,material:Zs}),Ys=new Gi.hF({isPickable:!1,primitiveType:Ai.MX.LINES});class Ks extends yi.u1{constructor(e,t){super(e),this.manipulatorId=t,this.sourcePrimitives=[],this.sourceIds=[]}initialize(e){return!(e.length<1)&&(!!this.createPreviewMeshes(e)&&!!this.updateMeshes())}duplicatePrimitive(e){const t=e.clone();return t.id="",e.points&&(t.points=new Float32Array(e.points)),t}createPreviewMeshes(e){this.sourcePrimitives=[];const t=X.default.getManager().getColor("FEATURE_FAST_PREVIEW_COLOR"),i=this.viewer.getModelViewManagers().getManager();return i&&e.forEach((e=>{const s=i.extractMeshIncrement(e);if(s){const i=this.duplicatePrimitive(s);i.colors=null,(0,Yd.Ab)(t,i),this.sourcePrimitives.push(i),this.sourceIds.push(e)}})),this.sourceIds.length>=1}updateMeshes(){return!1}}var js=i(67185),Qs=i(28858);class $s extends Ks{constructor(e,t){super(e,t),this.axisDirection=null,this.axisRoot=null,this.angle=0}setAngle(e){this.update(null,e)}update(e,t,i,s){return!(e&&!(0,Qs.Z)(e,this.sourceIds))&&(t&&(this.angle=t),i&&(this.axisRoot=i),s&&(this.axisDirection=s),this.updateMeshes())}updateMeshes(){let e,t,i,s,n;const r=ge.Jb.fromAngleAxis(this.angle,this.axisDirection,js.create());for(let a=0;a<this.sourceIds.length;++a){for(e=this.sourcePrimitives[a],t=this.duplicatePrimitive(e),i=this.sourceIds[a],s=0;s<e.points.length;s+=3){const i=M.fromValues(e.points[s],e.points[s+1],e.points[s+2]);for(ge.S4.subtract(i,this.axisRoot),ge.Jb.multiplyVec3(r,i),ge.S4.add(i,this.axisRoot),n=0;n<3;++n)t.points[s+n]=i[n]}t.isTriangles()?this.updateMeshIncrement(i,yi.ZJ,t,qs):this.updateMeshIncrement(i,yi.ZJ,t,Ys)}return!0}}function Js(e,t,i,s,n,r){const a=new $s(r,e);return a.axisRoot=s,a.axisDirection=n,a.angle=i,a.initialize(t)?a:null}class en extends Ks{constructor(e,t){super(e,t),this.direction=null,this.distance=0,this.offset=0}setDistance(e){this.update(null,null,e)}update(e,t,i,s){return!(e&&!(0,Qs.Z)(e,this.sourceIds))&&(t&&(this.direction=t),i&&(this.distance=i),void 0!==s&&(this.offset=s),this.updateMeshes())}updateMeshes(){let e,t,i,s,n;const r=M.create();ge.S4.scale(this.direction,this.distance+this.offset,r);for(let a=0;a<this.sourceIds.length;++a){for(e=this.sourcePrimitives[a],t=this.duplicatePrimitive(e),i=this.sourceIds[a],s=0;s<e.points.length;s+=3)for(n=0;n<3;++n)t.points[s+n]=e.points[s+n]+r[n];t.isTriangles()?this.updateMeshIncrement(i,yi.ZJ,t,qs):this.updateMeshIncrement(i,yi.ZJ,t,Ys)}return!0}}function tn(e,t,i,s,n,r){const a=new en(n,e);return a.direction=i,a.distance=s,void 0!==r&&(a.offset=r),a.initialize(t)?a:null}const sn=new Gi.hF({isPickable:!1,primitiveType:Ai.MX.LINES}),nn=new Gi.hF({isPickable:!1,primitiveType:Ai.MX.LINES,isShowThrough:!0,isDepthTested:!1}),rn="LINE";class an extends yi.u1{constructor(e,t,i,s){super(e),this.endpoint0=t,this.endpoint1=i,this.colorConstant=s,this.activeHighlights=new Map,this.updateGraphics()}onAppearanceConstantsUpdated(){this.updateGraphics()}getFitBounds(){return this.getMeshIncrement(rn)?.getBounds()}addHighlightWithType(e){this.activeHighlights.has(e)||this.activeHighlights.set(e,this.addNewHighlightToIncrement(rn,e))}removeHighlightWithType(e){if(!this.activeHighlights.has(e))return;const t=this.activeHighlights.get(e);this.removeHighlightFromIncrement(rn,t),this.activeHighlights.delete(e)}updateGraphics(){const e=(0,Yd.W5)(this.endpoint0,this.endpoint1,rn,X.default.getManager().getColor(this.colorConstant));this.updateMeshIncrement(rn,yi.ZJ,e,sn);const t=e.clone();(0,Yd.KZ)(X.default.getManager().getStipple("LINE_SHOW_THROUGH_STIPLE"),t),this.updateMeshIncrement(rn+".st",yi.ZJ,t,nn)}}var on=i(65443),hn=i(57702);const cn="box",ln=X.default.getManager();let dn=!0;function un(e){dn=e}const gn=new Gi.hF({isPickable:!1,primitiveType:Ai.MX.LINES}),pn=new Gi.hF({isPickable:!1,primitiveType:Ai.MX.TRIANGLES,primitivesHaveTransparency:!0,material:Vi});class mn extends yi.u1{constructor(e){super(e,uh.EG),this.mouseDown=[0,0],this.lastMouse=[0,0],this.canceled=!1,this.zoomCursorOnStack=!1,this.zoomTriggeredByMenu=!1,this.zoomModifier=!1,this.dragging=!1,this.listeningToKeyDispatcher=!1,this.listeningToOutsideClick=!1,this.mouseOnCanvas=!0,this.messageBubble=es.Jq.MessageBubbleService.createMessageBubble(),this.listenTo(this,yi.zw.DRAG_START+cn,this.onDragStart),this.listenTo(this,yi.zw.DRAG+cn,this.onDrag),this.listenTo(this,yi.zw.DRAG_STOP+cn,this.onDragStop),this.zoomModeEnabledSubscription=(0,fh.Dx)().zoomModeEnabledObservable.subscribe((()=>this.onZoomModeChange()))}remove(){this.zoomModeEnabledSubscription.unsubscribe(),super.remove()}getPositionFromEvent(e){return[e.mouseX,e.camera.getViewportHeight()-e.mouseY]}performContainmentSelection(){return this.lastMouse[0]>this.mouseDown[0]}left(){return Math.min(this.lastMouse[0],this.mouseDown[0])}right(){return Math.max(this.lastMouse[0],this.mouseDown[0])}bottom(){return Math.min(this.lastMouse[1],this.mouseDown[1])}top(){return Math.max(this.lastMouse[1],this.mouseDown[1])}onDragStart(e,t,i){this.viewer.getSuppressModelSelection()?this.canceled=!0:(this.lastMouse=this.mouseDown=this.getPositionFromEvent(t),this.updateGraphics(),i.requestDrag=!0,this.canceled=!1,this.dragging=!0,this.listenToKeyDispatcher(),(0,Xs.vm)())}onDrag(e,t){this.canceled||(this.lastMouse=this.getPositionFromEvent(t),this.updateGraphics(),(0,Xs.vm)())}onDragStop(e,t){if(this.canceled)return;this.dragging=!1;const i=this.right()-this.left(),s=this.top()-this.bottom(),n=t.camera.getViewportHeight()-this.top();if(this.zoomIsEnabled())(0,fh.CR)(!1),this.viewer.animateZoomToRectangle(this.left(),n,i,s),this.removeMeshIncrements(),this.stopListeningToKeyDispatcher(),this.tearDownOutsideClickListeners();else{const e=this.viewer.performBoxSelection(this.left(),n,i,s,this.performContainmentSelection(),this.viewer.getInputHandler().getCtrlHeld()),t=this;e?e.then((function(){t.removeMeshIncrements(),t.stopListeningToKeyDispatcher()})):(t.removeMeshIncrements(),this.stopListeningToKeyDispatcher())}}onKeyDown(e){e.which===Is.R8.CANCEL&&this.cancelSelection()}outsideClickHandler(e){!this.mouseOnCanvas&&e&&e.target&&(0,fh.CR)(!1)}setupOutsideClickListeners(){this.listeningToOutsideClick||(this.mouseOnCanvas=!0,hn(document).on("click.boxSelector",this.outsideClickHandler.bind(this)),this.listenTo(this.viewer.getEventDispatcher(),nM.ox,this.onMouseEnter),this.listenTo(this.viewer.getEventDispatcher(),nM.u5,this.onMouseLeave),this.listeningToOutsideClick=!0)}onMouseEnter(e){this.mouseOnCanvas=!0}onMouseLeave(e){this.mouseOnCanvas=!1}tearDownOutsideClickListeners(){this.listeningToOutsideClick&&(hn(document).off("click.boxSelector"),this.listeningToOutsideClick=!1)}listenToKeyDispatcher(){this.listeningToKeyDispatcher||(this.listenTo((0,on.getDispatcher)(),on.Events.KEYDOWN,this.onKeyDown),this.listeningToKeyDispatcher=!0)}stopListeningToKeyDispatcher(){this.listeningToKeyDispatcher&&(this.stopListening((0,on.getDispatcher)()),this.listeningToKeyDispatcher=!1)}pushZoomCursor(){this.zoomCursorOnStack||(this.viewer.pushCursor(kn.C.ZOOM_IN),this.zoomCursorOnStack=!0)}popZoomCursor(){this.zoomCursorOnStack&&(this.viewer.removeTopOccurrenceOfCursor(kn.C.ZOOM_IN),this.zoomCursorOnStack=!1)}cancelSelection(){this.viewer.performingBoxSelection()?this.viewer.stopBoxSelection():(this.resetZoomState(),this.canceled=!0,this.removeMeshIncrements(),this.stopListeningToKeyDispatcher(),this.tearDownOutsideClickListeners()),this.dragging=!1}getVertex(e,t){return[e,t,0]}getBoxLineColor(){if(this.zoomIsEnabled())return ln.getColor("BOX_ZOOM_COLOR");return this.performContainmentSelection()?ln.getColor("BOX_SELECT_COLOR"):ln.getColor("CROSS_SELECT_COLOR")}getBoxStipple(){if(this.zoomIsEnabled())return ln.getStipple("BOX_ZOOM_LINE_STIPPLE");return this.performContainmentSelection()?ln.getStipple("BOX_SELECT_LINE_STIPPLE"):ln.getStipple("CROSS_SELECT_LINE_STIPPLE")}updateGraphics(){const e=(0,Yd.pf)([this.getVertex(this.mouseDown[0],this.mouseDown[1]),this.getVertex(this.lastMouse[0],this.mouseDown[1]),this.getVertex(this.lastMouse[0],this.mouseDown[1]),this.getVertex(this.lastMouse[0],this.lastMouse[1]),this.getVertex(this.lastMouse[0],this.lastMouse[1]),this.getVertex(this.mouseDown[0],this.lastMouse[1]),this.getVertex(this.mouseDown[0],this.lastMouse[1]),this.getVertex(this.mouseDown[0],this.mouseDown[1])]);let t;this.left()!==this.right()&&this.bottom()!==this.top()&&(t=(0,Yd.fQ)(this.getVertex(this.left(),this.bottom()),this.getVertex(this.right(),this.bottom()),this.getVertex(this.left(),this.top())));const i=this.getBoxLineColor(),s=this.getBoxStipple();if((0,Yd.Ab)(i,e),(0,Yd.KZ)(s,e),(0,Yd.VQ)(ln.getNumber("BOX_SELECT_LINE_WIDTH"),e),this.updateMeshIncrement("lines",yi.ZJ,e,gn),t){const e=i.slice(0);e[3]=ln.getNumber("BOX_SELECT_INFILL_OPACITY"),(0,Yd.Ab)(e,t),this.updateMeshIncrement("interior",yi.ZJ,t,pn)}else this.removeMeshIncrement("interior")}triggerDragStart(e,t){const i=!!(0,Me.VT)()&&(0,Me.VT)().getIsAQueryList()&&1===(0,Me.HP)();return!!(this.zoomIsEnabled()||dn&&!i)&&super.triggerDragStart(e,t)}zoomIsEnabled(){return(0,fh.Fo)()}startZoom(){this.pushZoomCursor()}stopZoom(){this.popZoomCursor()}resetZoomState(){(0,fh.CR)(!1)}showZoomMessage(){this.messageBubble.showMessage(i18n("Drag to create zoom bounding box."))}dismissZoomMessage(){this.messageBubble.dismissMessage()}onZoomModeChange(){this.zoomIsEnabled()?(this.startZoom(),this.listenToKeyDispatcher(),this.setupOutsideClickListeners(),this.dragging?this.updateGraphics():this.showZoomMessage()):(this.dragging&&this.updateGraphics(),this.stopListeningToKeyDispatcher(),this.stopZoom(),this.tearDownOutsideClickListeners(),this.dismissZoomMessage())}}const fn=X.default.getManager(),In=new Gi.hF({isPickable:!1,primitiveType:Ai.MX.LINES});class En extends yi.u1{constructor(e){super((0,j.as)(ND,e),uh.EG),this.mousePositions=[],this.color=fn.getColor("SKETCH_DRAG_TRIM_PATH_COLOR"),this.number=fn.getNumber("SKETCH_DRAG_TRIM_PATH_WIDTH"),this.newLineSegment=!0}onAppearanceConstantsUpdated(){this.color=fn.getColor("SKETCH_DRAG_TRIM_PATH_COLOR"),this.updateGraphics()}reset(){this.mousePositions=[],this.newLineSegment=!0,this.updateGraphics(),this.viewer.forceRequestDraw()}addPositionToDragTrimLine(e){const t=this.viewer.getCanvasCoordinateFromEvent(e);this.updateMousePositionsWithDragEvent(t),this.updateGraphics(),(0,Xs.vm)()}makeNewLineSegment(){this.newLineSegment=!0}updateMousePositionsWithDragEvent(e){const t=new k.YFv;t.updateFromArray(this.viewer.getCamera().viewportToCanvas(e)),this.newLineSegment||this.mousePositions.length%2!=0?(this.mousePositions.push(t),this.newLineSegment=!1):this.mousePositions[this.mousePositions.length-1].equals(t)||(this.mousePositions.push(this.mousePositions[this.mousePositions.length-1]),this.mousePositions.push(t))}updateGraphics(){if(this.mousePositions.length%2!=0)return;const e=(0,Yd.pf)(this.mousePositions.map((e=>[e.x,e.y,0])),"dragTrimLine",this.color,this.number);this.updateMeshIncrement("lines",yi.ZJ,e,In)}}var Sn=i(54784),Tn=i(39875),Dn=i(21512),Cn=i(93615);var Mn,yn;!function(e){e[e.OPERATION_PERSISTENT=0]="OPERATION_PERSISTENT",e[e.UI=1]="UI",e[e.FILTERED_ENTITIES=2]="FILTERED_ENTITIES",e[e.ACCUMULATED_SMART_SELECTION=3]="ACCUMULATED_SMART_SELECTION",e[e.SMART_SELECTION=4]="SMART_SELECTION",e[e.INCONTEXT_REFERENCE_PRE=5]="INCONTEXT_REFERENCE_PRE",e[e.ASSOCIATED_OCCURRENCE_PRE=6]="ASSOCIATED_OCCURRENCE_PRE",e[e.OCCURRENCE_SECONDARY_PRE=7]="OCCURRENCE_SECONDARY_PRE",e[e.PROFILE_INSPECTOR=8]="PROFILE_INSPECTOR",e[e.PROFILE_INSPECTOR_FOCUS=9]="PROFILE_INSPECTOR_FOCUS",e[e.PRE=10]="PRE",e[e.OCCURRENCE_PRE=11]="OCCURRENCE_PRE",e[e.COMMENT=12]="COMMENT",e[e.INCONTEXT_REFERENCE=13]="INCONTEXT_REFERENCE",e[e.OCCURRENCE_COMMENT=14]="OCCURRENCE_COMMENT",e[e.UI_RELATED_ENTITY=15]="UI_RELATED_ENTITY",e[e.ASSOCIATED_OCCURRENCE=16]="ASSOCIATED_OCCURRENCE",e[e.RELATED_OCCURRENCE=17]="RELATED_OCCURRENCE",e[e.OCCURRENCE=18]="OCCURRENCE",e[e.PART=19]="PART",e[e.FEATURE=20]="FEATURE",e[e.ENTITY=21]="ENTITY",e[e.ERROR=22]="ERROR",e[e.SECONDARY_PRE=23]="SECONDARY_PRE",e[e.SECONDARY=24]="SECONDARY",e[e.RETRIEVAL=25]="RETRIEVAL",e[e.REPAIR=26]="REPAIR",e[e.REPAIR_HOVER=27]="REPAIR_HOVER",e[e.ANNOTATION_REFERENCES=28]="ANNOTATION_REFERENCES"}(Mn||(Mn={})),function(e){e[e.NO_HIGHLIGHT=0]="NO_HIGHLIGHT",e[e.HIGHLIGHT=1]="HIGHLIGHT",e[e.SUPPRESS_INTERIOR=2]="SUPPRESS_INTERIOR"}(yn||(yn={}));class An{constructor(e,t,i,s,n,r){this.type=e,this.priority=t,this.color1=[0,0,0,0],this.colorBorder=[0,0,0,0],this.indexInstanceIdColor=[0,0,0,yn.HIGHLIGHT/255],this.style=null,this.index=0,this.idString="",this.debugStack=null,this.usage=ys.L.BASE,this.associatedPrimaryHighlightType=r||null,this.outlineOverlappingInteriorRegions=this.type===Cn.o2.ENTITY||this.type===Cn.o2.SMART_SELECTION||this.type===Cn.o2.ACCUMULATED_SMART_SELECTION,this.forOccurrences=this.type===Cn.o2.OCCURRENCE||this.type===Cn.o2.OCCURRENCE_PRE||this.type===Cn.o2.OCCURRENCE_COMMENT||this.type===Cn.o2.OCCURRENCE_SECONDARY_PRE||this.type===Cn.o2.RELATED_OCCURRENCE||this.type===Cn.o2.RELATED_OCCURRENCE_MATE||this.type===Cn.o2.ASSOCIATED_OCCURRENCE||this.type===Cn.o2.ASSOCIATED_OCCURRENCE_PRE||this.type===Cn.o2.RETRIEVAL||this.type===Cn.o2.OPERATION_PERSISTENT,this.updateColors(),void 0!==i&&this.setIndex(i),this.instanceId=Mi.JE,void 0!==s&&this.setInstanceId(s),this.occurrence=n}updateColors(e){const t=X.default.getManager();if(this.color1=t.getColor(this.type+"_HIGHLIGHT_COLOR1"),this.colorBorder=t.getColor(this.type+"_HIGHLIGHT_COLOR_BORDER"),e)for(let t=0;t<3;t++)this.color1[t]=e[t],this.colorBorder[t]=e[t]}getIdString(){return this.idString}cloneForOccurrence(e){return new An(this.type,this.priority,this.index,this.instanceId,e,this.associatedPrimaryHighlightType)}cloneForInstance(e){return new An(this.type,this.priority,this.index,e,this.occurrence,this.associatedPrimaryHighlightType)}setIndex(e){this.index=e,this.updateIndexInstanceColor()}setInstanceId(e){this.instanceId=e,this.idString=this.type+"."+this.instanceId,this.updateIndexInstanceColor()}getInstanceNumber(){return(0,Mi.rp)(this.instanceId)?Math.max(255&this.instanceId[0],1):0}updateIndexInstanceColor(){this.indexInstanceIdColor[0]=(255&this.index)/255;const e=this.getInstanceNumber();this.indexInstanceIdColor[1]=(e>>>4&15)/255,this.indexInstanceIdColor[2]=(15&e)/255}getStyle(){return this.style||(this.style=new mS.bg,this.style.setAttribute(RS.HIGHLIGHT_ID,this.indexInstanceIdColor)),this.style}getIndexInstanceEncodedInFloat(){return this.index+256*this.getInstanceNumber()}}function Pn(e,t){return e.type===t.type&&e.instanceId===t.instanceId&&e.associatedPrimaryHighlightType===t.associatedPrimaryHighlightType&&(0,Tn.wB)(e.occurrence,t.occurrence)}function On(e){e[Cn.o2.UI]=new An(Cn.o2.UI,Mn.UI),e[Cn.o2.RELATED_OCCURRENCE]=new An(Cn.o2.RELATED_OCCURRENCE,Mn.RELATED_OCCURRENCE),e[Cn.o2.RELATED_OCCURRENCE_MATE]=new An(Cn.o2.RELATED_OCCURRENCE_MATE,Mn.RELATED_OCCURRENCE),e[Cn.o2.ACCUMULATED_SMART_SELECTION]=new An(Cn.o2.ACCUMULATED_SMART_SELECTION,Mn.ACCUMULATED_SMART_SELECTION),e[Cn.o2.SMART_SELECTION]=new An(Cn.o2.SMART_SELECTION,Mn.SMART_SELECTION),e[Cn.o2.UI_RELATED_ENTITY]=new An(Cn.o2.UI_RELATED_ENTITY,Mn.ENTITY),e[Cn.o2.ENTITY]=new An(Cn.o2.ENTITY,Mn.ENTITY),e[Cn.o2.FEATURE]=new An(Cn.o2.FEATURE,Mn.FEATURE),e[Cn.o2.PART]=new An(Cn.o2.PART,Mn.PART),e[Cn.o2.OCCURRENCE]=new An(Cn.o2.OCCURRENCE,Mn.OCCURRENCE),e[Cn.o2.OCCURRENCE_PRE]=new An(Cn.o2.OCCURRENCE_PRE,Mn.OCCURRENCE_PRE),e[Cn.o2.PRE]=new An(Cn.o2.PRE,Mn.PRE),e[Cn.o2.SECONDARY]=new An(Cn.o2.SECONDARY,Mn.SECONDARY),e[Cn.o2.SECONDARY_PRE]=new An(Cn.o2.SECONDARY_PRE,Mn.SECONDARY_PRE),e[Cn.o2.OCCURRENCE_SECONDARY_PRE]=new An(Cn.o2.OCCURRENCE_SECONDARY_PRE,Mn.OCCURRENCE_SECONDARY_PRE),e[Cn.o2.COMMENT]=new An(Cn.o2.COMMENT,Mn.COMMENT),e[Cn.o2.FILTERED_ENTITIES]=new An(Cn.o2.FILTERED_ENTITIES,Mn.FILTERED_ENTITIES),e[Cn.o2.OCCURRENCE_COMMENT]=new An(Cn.o2.OCCURRENCE_COMMENT,Mn.OCCURRENCE_COMMENT),e[Cn.o2.ASSOCIATED_OCCURRENCE]=new An(Cn.o2.ASSOCIATED_OCCURRENCE,Mn.ASSOCIATED_OCCURRENCE),e[Cn.o2.ASSOCIATED_OCCURRENCE_PRE]=new An(Cn.o2.ASSOCIATED_OCCURRENCE_PRE,Mn.ASSOCIATED_OCCURRENCE_PRE),e[Cn.o2.ERROR]=new An(Cn.o2.ERROR,Mn.ERROR),e[Cn.o2.INCONTEXT_REFERENCE]=new An(Cn.o2.INCONTEXT_REFERENCE,Mn.INCONTEXT_REFERENCE),e[Cn.o2.INCONTEXT_REFERENCE_PRE]=new An(Cn.o2.INCONTEXT_REFERENCE_PRE,Mn.INCONTEXT_REFERENCE_PRE),e[Cn.o2.RETRIEVAL]=new An(Cn.o2.RETRIEVAL,Mn.RETRIEVAL),e[Cn.o2.OPERATION_PERSISTENT]=new An(Cn.o2.OPERATION_PERSISTENT,Mn.OPERATION_PERSISTENT),e[Cn.o2.REPAIR]=new An(Cn.o2.REPAIR,Mn.REPAIR),e[Cn.o2.REPAIR_HOVER]=new An(Cn.o2.REPAIR_HOVER,Mn.REPAIR_HOVER),e[Cn.o2.PROFILE_INSPECTOR]=new An(Cn.o2.PROFILE_INSPECTOR,Mn.PROFILE_INSPECTOR),e[Cn.o2.PROFILE_INSPECTOR_FOCUS]=new An(Cn.o2.PROFILE_INSPECTOR_FOCUS,Mn.PROFILE_INSPECTOR_FOCUS),e[Cn.o2.ANNOTATION_REFERENCES]=new An(Cn.o2.ANNOTATION_REFERENCES,Mn.ANNOTATION_REFERENCES)}function Rn(e,t){for(const i in e)t.push(e[i]);t.sort((function(e,t){return e.priority>t.priority?1:e.priority<t.priority?-1:0}));for(let e=0;e<t.length;++e)t[e].setIndex(e)}class wn{constructor(e){this.viewer=e,this.highlights={},this.sortedHighlights=[],(0,Sh.Yk)(e),On(this.highlights),Rn(this.highlights,this.sortedHighlights)}getSortedHighlights(){return this.sortedHighlights}getHighlightTextureWidth(){return this.sortedHighlights.length}updateHighlightColor(e,t){this.highlights[e].updateColors(t),this.viewer.getResources().invalidateHighlightTexture()}destroy(){this.highlights={},this.sortedHighlights=[]}}class vn{constructor(e){this.referenceHighlights=e,this.highlightInstanceIdManagers={},this.highlightToSelectionToInstanceId={},this.usage=ys.L.BASE;for(const e in Cn.o2)this.highlightInstanceIdManagers[e]=new Mi.si(Mi._6.HIGHLIGHT),this.highlightToSelectionToInstanceId[e]={}}getInstanceIdForHighlightAndSelection(e,t){const i=this.highlightToSelectionToInstanceId[e][t];return i||Mi.JE}constructHighlightForTypeAndInstance(e,t,i=!1){const s=this.referenceHighlights.highlights[e].cloneForInstance(t);if(s.usage=this.usage,i){(255*s.indexInstanceIdColor[3]&yn.SUPPRESS_INTERIOR)>0||(s.indexInstanceIdColor[3]+=yn.SUPPRESS_INTERIOR/255)}return s}createHighlightForSelection(e,t,i=!1){if(!this.referenceHighlights)return new An(Cn.o2.ERROR,Mn.ERROR);let s=this.getInstanceIdForHighlightAndSelection(e,t);return(0,Mi.rp)(s)||(s=this.highlightInstanceIdManagers[e].getId(),this.highlightToSelectionToInstanceId[e][t]=s),this.constructHighlightForTypeAndInstance(e,s,i)}freeHighlightForSelection(e,t){const i=this.getInstanceIdForHighlightAndSelection(e,t);return(0,Mi.rp)(i)&&(this.highlightInstanceIdManagers[e].freeId(i),delete this.highlightToSelectionToInstanceId[e][t]),i}createSecondaryHighlight(e,t,i){const s=this.createHighlightForSelection(e,i+Dn.ID_SEPARATOR+t);return s.associatedPrimaryHighlightType=t,s}freeSecondaryHighlight(e,t,i){this.freeHighlightForSelection(e,i+Dn.ID_SEPARATOR+t)}resetHighlightInstanceIds(e){this.highlightInstanceIdManagers[e].reset(),this.highlightToSelectionToInstanceId[e]={}}highlightHasSelections(e){return!(0,Xs.hW)(this.highlightToSelectionToInstanceId[e])}}function _n(e,t){let i=0;for(let s=0;s<t.length;++s){if(Pn(t[s],e))return-1;if(e.priority<t[s].priority)break;++i}return t.splice(i,0,e),i}function Nn(e,t,i){let s=-1;for(let n=0;n<t.length;++n)if(i&&e.type===t[n].type||Pn(t[n],e)){s=n;break}return s<0||t.splice(s,1),s}var bn,Ln=i(93565),Fn=i(10392);!function(e){e[e.OVERDEFINED=1]="OVERDEFINED",e[e.EXTERNAL_AND_OK=2]="EXTERNAL_AND_OK",e[e.OK=3]="OK",e[e.DRIVEN=4]="DRIVEN"}(bn||(bn={}));const xn=function(e){const t=this.viewer.getReferenceHighlights(),i=new Uint8Array(4*t.sortedHighlights.length);for(let e=0;e<t.sortedHighlights.length;e++){const s=(0,Xs.Db)(t.sortedHighlights[e].color1);for(let t=0;t<4;t++)i[4*e+t]=s[t]}const s=new mo(e);return s.bytes=i,s.width=i.length/4,s.height=1,s},Bn={isVisible:!0,isTwoSided:!0,priority:Gi.DO.HIGHER,primitiveType:Ai.MX.TRIANGLES,isShowThrough:!0,isDepthTested:!1},Vn={isVisible:!0,isTwoSided:!0,priority:Gi.DO.HIGHER,primitiveType:Ai.MX.TRIANGLES,isShowThrough:!0,isDepthTested:!1},Un=X.default.getManager();class Hn extends m.T{constructor(e){super(),this.viewer=e,this.blitQuad=null,this.highlightColorTexture=null,this.blankTexture=null,this.primitiveRestartBuffer=null,this.constraintAtlas=null,this.typeToNodeProperties={},this.constraintAtlasCreationInitiated=!1,this.constraintAtlasCreationId=0,this.commentIndicatorAtlas=null,this.commentIndicatorAtlasCreationInitiated=!1,this.dimensionAtlas=null,this.dimensionAtlasCreationInitiated=!1,this.dimensionAtlasCreationId=-1,this.mbdAtlas=null,this.mbdAtlasCreationInitiated=!1,this.mbdAtlasCreationId=-1,this.centerOfMassIndicatorNodeProperties=null,this.scalarVisualizationTextures=new Map,this.imageTextureCache=new Map,this.translucentModeEdgeColorBodyColorFactor=Un.getNumber("TRANSPARENT_EDGE_COLOR_FACTOR"),this.PART_SURFACE_LINE_POINT_MATERIAL=new Bi({color:Un.getColor("LINE_POINT_COLOR")}),this.WIRE_LINE_POINT_MATERIAL=new Bi({color:Un.getColor("LINE_POINT_COLOR")}),this.PART_EDGE_NODE_PROPERTIES=new Gi.hF({debugId:"PartEdges",material:this.PART_SURFACE_LINE_POINT_MATERIAL,zOffset:Un.getNumber("PART_EDGES_Z_OFFSET"),primitiveType:Ai.MX.LINES,addsToBounds:!1,includedInBlend:!0,clippedBySectionPlanes:!0}),this.TRANSLUCENT_PART_EDGE_NODE_PROPERTIES=this.PART_EDGE_NODE_PROPERTIES.cloneAndModify({debugId:"TranslucentPartEdges",primitivesHaveTransparency:!0,includedInBlend:!0,isStencilWritten:!1}),this.SURFACE_EDGE_NODE_PROPERTIES=this.PART_EDGE_NODE_PROPERTIES.cloneAndModify({debugId:"SurfaceEdges",zOffset:Un.getNumber("SURFACE_EDGES_Z_OFFSET")}),this.TRANSLUCENT_SURFACE_EDGE_NODE_PROPERTIES=this.SURFACE_EDGE_NODE_PROPERTIES.cloneAndModify({debugId:"TranslucentSurfaceEdges",primitivesHaveTransparency:!0,includedInBlend:!0,isStencilWritten:!1}),this.WIRE_EDGE_NODE_PROPERTIES=this.PART_EDGE_NODE_PROPERTIES.cloneAndModify({debugId:"Wire",material:this.WIRE_LINE_POINT_MATERIAL,zOffset:Un.getNumber("WIRE_EDGES_Z_OFFSET"),addsToBounds:!0}),this.TRANSLUCENT_WIRE_EDGE_NODE_PROPERTIES=this.WIRE_EDGE_NODE_PROPERTIES.cloneAndModify({debugId:"TranslucentWire",primitivesHaveTransparency:!0,includedInBlend:!0,isStencilWritten:!1}),this.PART_EDGE_NODE_PROPERTIES_NON_MODIFIABLE=this.PART_EDGE_NODE_PROPERTIES.cloneAndModify({zOffset:Un.getNumber("NON_MODIFIABLE_Z_OFFSET_EDGE")}),this.SURFACE_EDGE_NODE_PROPERTIES_NON_MODIFIABLE=this.SURFACE_EDGE_NODE_PROPERTIES.cloneAndModify({zOffset:Un.getNumber("NON_MODIFIABLE_Z_OFFSET_EDGE")}),this.SMOOTH_EDGE_MATERIAL=new Bi({}),this.TRANSLUCENT_PART_SMOOTH_EDGE_NODE_PROPERTIES=this.TRANSLUCENT_PART_EDGE_NODE_PROPERTIES.cloneAndModify({debugId:"TranslucentPartSmoothEdges",includedInBlend:!0,material:this.SMOOTH_EDGE_MATERIAL}),this.TRANSLUCENT_SURFACE_SMOOTH_EDGE_NODE_PROPERTIES=this.TRANSLUCENT_SURFACE_EDGE_NODE_PROPERTIES.cloneAndModify({debugId:"TranslucentSurfaceSmoothEdges",includedInBlend:!0,material:this.SMOOTH_EDGE_MATERIAL}),this.PART_SMOOTH_EDGE_NODE_PROPERTIES=this.PART_EDGE_NODE_PROPERTIES.cloneAndModify({debugId:"PartSmoothEdges",material:this.SMOOTH_EDGE_MATERIAL}),this.SURFACE_SMOOTH_EDGE_NODE_PROPERTIES=this.SURFACE_EDGE_NODE_PROPERTIES.cloneAndModify({debugId:"SurfaceSmoothEdges",material:this.SMOOTH_EDGE_MATERIAL}),this.PART_SMOOTH_EDGE_NODE_PROPERTIES_NON_MODIFIABLE=this.PART_EDGE_NODE_PROPERTIES_NON_MODIFIABLE.cloneAndModify({debugId:"PartSmoothEdgesNonModifiable",material:this.SMOOTH_EDGE_MATERIAL}),this.SURFACE_SMOOTH_EDGE_NODE_PROPERTIES_NON_MODIFIABLE=this.SURFACE_EDGE_NODE_PROPERTIES_NON_MODIFIABLE.cloneAndModify({debugId:"SurfaceSmoothEdgesNonModifiable",material:this.SMOOTH_EDGE_MATERIAL}),this.WIRE_EDGE_NODE_PROPERTIES_NON_MODIFIABLE=this.WIRE_EDGE_NODE_PROPERTIES.cloneAndModify({zOffset:Un.getNumber("NON_MODIFIABLE_Z_OFFSET_EDGE")}),this.CENTER_LINE_MATERIAL=new Bi({color:Un.getColor("LINE_POINT_COLOR"),lineStipple:Un.getStipple("CENTER_LINE_STIPPLE")}),this.CENTER_LINE_NODE_PRPOPERTIES=this.WIRE_EDGE_NODE_PROPERTIES.cloneAndModify({material:this.CENTER_LINE_MATERIAL}),this.SILHOUETTE_NODE_PROPERTIES=new Gi.hF({material:this.PART_SURFACE_LINE_POINT_MATERIAL,zOffset:Un.getNumber("PART_EDGES_Z_OFFSET"),primitiveType:Ai.MX.SILHOUETTES,addsToBounds:!1,includedInBlend:!0,clippedBySectionPlanes:!0,debugId:"Silhouette"}),this.TRANSLUCENT_SILHOUETTE_NODE_PROPERTIES=this.SILHOUETTE_NODE_PROPERTIES.cloneAndModify({primitivesHaveTransparency:!0,includedInBlend:!0,debugId:"TranslucentSilhouette"}),(0,Sh.Yk)(e),this.constraintMaterial=Hi(),(0,lt.Z)(bn,(e=>{this.typeToNodeProperties[e]=new Gi.hF({isPickable:!0,primitiveType:Ai.MX.TRIANGLES,material:this.constraintMaterial,isVisible:!0,zOffset:e})})),this.inferenceNodeProperties=new Gi.hF({isPickable:!1,primitiveType:Ai.MX.TRIANGLES,material:this.constraintMaterial,isVisible:!0,zOffset:0}),this.listenTo(this.viewer.getEventDispatcher(),nM.pO,this.onGlContextRestored),this.commentIndicatorMaterial=Hi(),this.commentIndicatorNodeProperties=new Gi.hF({primitiveType:Ai.MX.TRIANGLES,material:this.commentIndicatorMaterial}),this.dimensionMaterial=Hi(),this.dimensionNodeProperties=[new Gi.hF(Object.assign({isPickable:!0,material:this.dimensionMaterial},Bn)),new Gi.hF(Object.assign({isPickable:!1,material:this.dimensionMaterial},Bn))],this.mbdAtlasMaterial=Hi(),this.mbdAtlasNodeProperties=[new Gi.hF(Object.assign({isPickable:!0,material:this.mbdAtlasMaterial},Vn)),new Gi.hF(Object.assign({isPickable:!0,material:this.mbdAtlasMaterial},Vn))],this.initializeBodyEdgeResources()}initializeBodyEdgeResources(){}onGlContextRestored(){this.constraintAtlas&&(this.constraintMaterial.ambientTexture=this.constraintAtlas.texture)}reset(){this.blitQuad&&(this.blitQuad.remove(),this.blitQuad=null),this.blankTexture&&(this.blankTexture.destroy(),this.blankTexture=null),this.invalidateHighlightTexture(),this.constraintMaterial.destroy(),this.mateIndicatorGlyphResources&&this.mateIndicatorGlyphResources.destroy(),this.loadGlyphResources&&this.loadGlyphResources.destroy(),this.commentIndicatorMaterial.destroy(),this.dimensionMaterial.destroy(),this.stopListening(),this.primitiveRestartBuffer&&(this.primitiveRestartBuffer.destroy(),this.primitiveRestartBuffer=null)}getBlitNode(){if(!this.blitQuad){const e=new Gi.hF({primitiveType:Ai.MX.TRIANGLES,isPickable:!0,isTwoSided:!0,material:null});this.blitQuad=new AC([-1,-1,0],[1,-1,0],[-1,1,0],e,this.viewer,"blit"),this.blitQuad.getOccurrenceData().setShouldSetOccurrenceUniform(!1)}return this.blitQuad.getNode()}getHighlightTexture(){return this.highlightColorTexture||(this.highlightColorTexture=new Io(this.viewer,xn)),this.highlightColorTexture}invalidateHighlightTexture(){this.highlightColorTexture&&(this.highlightColorTexture.destroy(),this.highlightColorTexture=null)}getBlankTexture(){if(!this.blankTexture){const e=this.viewer.getGlContext(),t=new mo(e);t.width=2,t.height=2,t.bytes=new Uint8Array(t.width*t.height*4),this.blankTexture=new Io(this.viewer,t)}return this.blankTexture}getImageTexture(e){let t=this.imageTextureCache.get(e);if(!t){const i=this.viewer.getGlContext(),s=new mo(i);s.imageSource=e,s.wrapS=i.CLAMP_TO_EDGE,s.wrapT=i.CLAMP_TO_EDGE,t=new Io(this.viewer,s),t.hasTransparency=!1,this.imageTextureCache.set(e,t)}return t}onDevicePixelRatioChanged(e){e||(this.resetConstraintAtlas(),this.resetDimensionAtlas(),this.loadGlyphResources?.onDevicePixelRatioChanged(),this.resetMbdAtlas())}onAppearanceConstantsUpdated(){this.resetConstraintAtlas(),this.resetDimensionAtlas(),this.loadGlyphResources?.reinitialize(),this.updateBodyEdgeColors(),this.updateSmoothEdgeMaterial(),this.resetMbdAtlas()}resetConstraintAtlas(){this.constraintAtlasCreationInitiated=!1,this.constraintAtlas&&(this.constraintAtlas.destroy(),this.constraintAtlas=null),this.viewer.getTextureAtlasFactory().clearAtlas(QM.GH)}resetDimensionAtlas(){this.dimensionAtlasCreationInitiated=!1,this.dimensionAtlas&&(this.dimensionAtlas.destroy(),this.dimensionAtlas=null),this.viewer.getTextureAtlasFactory().clearAtlas(QM.Xh)}resetMbdAtlas(){this.mbdAtlasCreationInitiated=!1,this.mbdAtlas&&(this.mbdAtlas.destroy(),this.mbdAtlas=null),this.viewer.getTextureAtlasFactory().clearAtlas(QM.di)}onRenderingModeChanged(){this.updateBodyEdgeColors(),this.updateSmoothEdgeMaterial()}updateBodyEdgeColors(){switch(this.viewer.getRenderingMode()){case k.P1.HIDDEN_LINE_REMOVED:case k.P1.HIDDEN_LINE_VISIBLE:case k.P1.WIREFRAME:this.PART_SURFACE_LINE_POINT_MATERIAL.color=Un.getColor("UNSHADED_BODY_LINE_COLOR"),this.CENTER_LINE_MATERIAL.color=Un.getColor("UNSHADED_BODY_LINE_COLOR");break;default:this.PART_SURFACE_LINE_POINT_MATERIAL.color=Un.getColor("LINE_POINT_COLOR"),this.CENTER_LINE_MATERIAL.color=Un.getColor("LINE_POINT_COLOR")}this.translucentModeEdgeColorBodyColorFactor=Un.getNumber("TRANSPARENT_EDGE_COLOR_FACTOR")}updateSmoothEdgeMaterial(){const e=this.viewer.getSmoothEdgesRenderStyle(),t=X.default.getManager();switch(e){case k.YUG.HIDDEN:return void(this.SMOOTH_EDGE_MATERIAL.isVisible=!1);case k.YUG.PHANTOM:this.SMOOTH_EDGE_MATERIAL.lineStipple=t.getStipple("SMOOTH_EDGE_STIPPLE"),this.SMOOTH_EDGE_MATERIAL.lineWidth=t.getNumber("SMOOTH_EDGE_LINE_WIDTH");break;case k.YUG.VISIBLE:this.SMOOTH_EDGE_MATERIAL.lineStipple=t.getStipple("DEFAULT_LINE_STIPPLE"),this.SMOOTH_EDGE_MATERIAL.lineWidth=t.getNumber("DEFAULT_LINE_WIDTH")}this.SMOOTH_EDGE_MATERIAL.isVisible=!0;const i=this.viewer.getRenderingMode(),s=e===k.YUG.PHANTOM;switch(i){case k.P1.HIDDEN_LINE_REMOVED:case k.P1.HIDDEN_LINE_VISIBLE:case k.P1.WIREFRAME:this.SMOOTH_EDGE_MATERIAL.color=t.getColor("UNSHADED_BODY_LINE_COLOR");break;default:this.SMOOTH_EDGE_MATERIAL.color=s?t.getColor("SMOOTH_EDGE_PHANTOM_COLOR"):t.getColor("LINE_POINT_COLOR")}}}const Gn={nodePropertiesTypes:bn};Gn.nodePropertiesTypes=bn;var kn=i(46252);const Wn=X.default.getManager().getColor("DEFAULT_MATERIAL_COLOR"),zn=function(e){return e===(0,Me.Wf)()};class Xn{constructor(e,t,i){this.pointElement=e,this.highlight=t,this.isPreSelection=i}}class Zn extends m.T{constructor(e){super(),this.viewer=e,this.meshPoints={},(0,Sh.Yk)(e),this.addMultipleSelections((0,Me.Wf)()),this.addMultipleSelections((0,Me.vi)()),this.resetSelectionListHandlers()}resetSelectionListHandlers(){this.listenTo((0,Me.Wf)(),"add",this.onSelectionAdded),this.listenTo((0,Me.Wf)(),"remove",this.onSelectionRemoved),this.listenTo((0,Me.Wf)(),"reset",this.onSelectionReset),this.listenTo((0,Me.vi)(),"add",this.onSelectionAdded),this.listenTo((0,Me.vi)(),"remove",this.onSelectionRemoved),this.listenTo((0,Me.vi)(),"reset",this.onSelectionReset)}onSelectionAdded(e,t){this.addSelection(e,t)}onSelectionReset(e){this.deleteAllMeshPoints(zn(e)),this.addMultipleSelections(e)}onSelectionRemoved(e,t){this.removeSelection(e,t)}addMultipleSelections(e){e.each((t=>{this.addSelection(t,e)}))}deleteAllMeshPoints(e){Object.entries(this.meshPoints).forEach((([t,i])=>{i.isPreSelection===e&&this.deleteMeshPoint(t)}))}removeSelection(e,t){if(!e||!e.isMeshPoint()||!(e.id in this.meshPoints))return;zn(t)===this.meshPoints[e.id].isPreSelection&&this.deleteMeshPoint(e.id)}deleteMeshPoint(e){if(e in this.meshPoints){const t=this.meshPoints[e].pointElement,i=this.meshPoints[e].highlight;this.viewer.getHighlightManager(ys.L.BASE).freeHighlightForSelection(i.type,e),t.removeHighlight(i),t.remove(),delete this.meshPoints[e]}}addSelection(e,t){if(!e||!e.isMeshPoint())return;const i=zn(t);if(e.id in this.meshPoints){if(i)return;this.deleteMeshPoint(e.id)}const s=this.viewer.getHighlightManager(ys.L.BASE).createHighlightForSelection(function(e){return zn(e)?Cn.o2.PRE:Cn.o2.ENTITY}(t),e.id),n=e.sourcePick?this.viewer.getOccurrenceDataManager().getOccurrenceTransform(e.sourcePick.getOccurrenceId()):null,r=function(e,t,i,s){if(!e)return null;let n=M.clone(e);s&&(n=ge.w$.multiplyVec3(s,n));const r=new Cd(n,uh.lL,Wn,0,i);return r.addHighlight(t),r}(e.getMeshPointData().point,s,this.viewer,n);r&&(this.meshPoints[e.id]=new Xn(r,s,i))}destroy(){this.deleteAllMeshPoints(!0),this.deleteAllMeshPoints(!1),this.stopListening()}}var qn=i(97322);const Yn=X.default.getManager(),Kn="image";class jn extends yi.u1{constructor(e,t,i,s,n,r,a,o,h,c,l){super(o,a===ys.L.PREVIEW?uh.Vv:void 0),this.sketchEntityId=e,this.bottomLeftCorner=i,this.bottomRightCorner=s,this.topLeftCorner=n,this.texture=r,this.usage=a,this.isOnFlat=h,this.flattenedBodyId=c,this.transform=l,this.ownsTexture=!1,this.material=null,this.isActive=!1,this.id="image",this.url=(0,qn.e)(t),this.listenTo(this,yi.zw.CLICK+Kn,this.onClick),this.updateImage(t,i,s,n),this.occurrenceData.setCanIsolateChange(!0)}getSource(){return{documentId:(0,qn.a)(this.url,"/d/"),elementId:(0,qn.a)(this.url,"/e/"),documentVersionId:(0,qn.a)(this.url,"/v/")}}updateImage(e,t,i,s){const n=this.viewer.getGlContext();let r=(0,qn.e)(e);if(r||(r=this.url),this.url=r,this.bottomLeftCorner=t,this.bottomRightCorner=i,this.topLeftCorner=s,!r)return void this.removeMeshIncrement("image");if(!n)return;if(this.texture&&this.url!==r&&(this.texture.destroy(),this.texture=null,this.material&&(this.material.destroy(),this.material=null)),!this.texture){const e=new mo(n);e.imageSource=r,e.minificationFilter=n.LINEAR,e.magnificationFilter=n.LINEAR,e.defersRendering=!0,this.texture=new Io(this.viewer,e),this.ownsTexture=!0}this.material||(this.material=Hi(this.texture));const a=new Gi.hF({primitiveType:Ai.MX.TRIANGLES,isPickable:this.isActive,isDepthTested:!1,isTwoSided:!0,includedInBlend:!0,material:this.material}),o=(0,Yd.fQ)(this.bottomLeftCorner,this.bottomRightCorner,this.topLeftCorner,void 0,[0,1],[1,0]).createTransformed(this.transform),h=this.isActive?Yn.getNumber("SKETCH_IMAGE_ACTIVE_OPACITY"):Yn.getNumber("SKETCH_IMAGE_INACTIVE_OPACITY");(0,Yd.Ab)([1,1,1,h],o),this.updateMeshIncrement(Kn,Kn,o,a),this.isHidden&&this.hideIncrements()}remove(){this.texture&&this.ownsTexture&&(this.texture.destroy(),this.texture=null,this.ownsTexture=!1),this.material&&(this.material.destroy(),this.material=null),super.remove()}getUsage(){return this.usage}onClick(e,t){(0,Me.MO)({resetOptions:{isFromEmptyPick:!0,pickOptions:t}})}getPickPriority(e){return gI.z.SKETCH_FACE}cloneForPreview(){const e=new jn(this.sketchEntityId,this.url,this.bottomLeftCorner,this.bottomRightCorner,this.topLeftCorner,this.texture,ys.L.PREVIEW,this.viewer,this.isOnFlat,this.flattenedBodyId,this.transform);return this.isHidden&&e.hide(),this.isActive&&e.activate(),e}activate(){this.isActive=!0,this.updateImage(this.url,this.bottomLeftCorner,this.bottomRightCorner,this.topLeftCorner)}deactivate(){this.isActive=!1,this.updateImage(this.url,this.bottomLeftCorner,this.bottomRightCorner,this.topLeftCorner)}preventsSketching(){return!1}}var Qn=i(18919),$n=i(4023),Jn=i(14456);const er=_e.O.createLogger("ViewController",k.bVy.GRAPHICS);var tr;!function(e){e[e.RIGHT_FRONT=0]="RIGHT_FRONT",e[e.RIGHT_BACK=1]="RIGHT_BACK",e[e.LEFT_BACK=2]="LEFT_BACK",e[e.LEFT_FRONT=3]="LEFT_FRONT"}(tr||(tr={}));const ir=function(e,t){const i=ue.create();return ge.w$.rotate(i,e*Math.PI/2+Math.PI/6,[0,0,1]),ge.w$.rotate(i,t?Math.PI/3:2*Math.PI/3,[1,0,0]),i},sr={XY:ue.create(),XYback:[1,0,0,0,0,-1,0,0,0,0,-1,0,0,0,0,1],YZ:[0,1,0,0,0,0,1,0,1,0,0,0,0,0,0,1],YZback:[0,-1,0,0,0,0,1,0,-1,0,0,0,0,0,0,1],XZ:[1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1],XZback:[-1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1],Isometric:function(){const e=Math.sqrt(.5),t=Math.sqrt(1/3),i=Math.sqrt(1/6);return[e,e,0,0,-i,i,2*i,0,t,-t,t,0,0,0,0,1]}(),Dimetric:function(){const e=ue.create();return ge.w$.rotate(e,Math.PI/4,[0,0,1]),ge.w$.rotate(e,Math.PI/3,[1,0,0]),e}(),Trimetric:ir(tr.RIGHT_FRONT,!0),TrimetricTopRightBack:ir(tr.RIGHT_BACK,!0),TrimetricTopLeftBack:ir(tr.LEFT_BACK,!0),TrimetricTopLeftFront:ir(tr.LEFT_FRONT,!0),TrimetricBottomRightFront:ir(tr.RIGHT_FRONT,!1),TrimetricBottomRightBack:ir(tr.RIGHT_BACK,!1),TrimetricBottomLeftBack:ir(tr.LEFT_BACK,!1),TrimetricBottomLeftFront:ir(tr.LEFT_FRONT,!1)},nr=X.default.getManager();function rr(e,t){return y.copy(y.create(),t.getViewport())}class ar{constructor(e){this.viewer=e,this.camera=null,this.axisRotateUpAxis=[0,0,1],this.axisRotateCanvasTag="axisRotateView",this.rotateOrPanCenter=[0,0,0],this.haltPostRotationAnimation=!1,this.lastRotationTime=0,this.rotationSpeedX=0,this.rotationSpeedY=0,this.lastButtonState={leftButton:!1,middleButton:!1,rightButton:!1},this.lastCtrlState=!1,this.lastShiftState=!1,this.lastAltState=!1,this.isSpaceballMoving=!1,this.dragZoomCanvasCoordinates=[0,0],(0,Sh.Yk)(e),this.animationController=e.getAnimationController(),this.manipulationMode=aA.k.NONE,this.forcedManipulationMode=aA.k.NONE}getViewer(){return this.viewer}isPerspective(){return!1}isOrthographic(){return!1}getCamera(){return this.camera}getRotateOrPanCenter(){return this.rotateOrPanCenter}getAxisRotateUpAxis(){return this.axisRotateUpAxis}resetInputState(){this.lastButtonState={leftButton:!1,middleButton:!1,rightButton:!1},this.lastCtrlState=!1,this.lastShiftState=!1,this.lastAltState=!1}updateInputState(e,t){let i=!1;return Object.entries(t).forEach((function([e,t]){this.lastButtonState[e]!==t&&(this.lastButtonState[e]=t,i=!0)}),this),lS().usesControlKey()&&e.ctrlKey!==this.lastCtrlState&&(this.lastCtrlState=e.ctrlKey,i=!0),lS().usesShiftKey()&&e.shiftKey!==this.lastShiftState&&(this.lastShiftState=e.shiftKey,i=!0),lS().usesAltKey()&&e.altKey!==this.lastAltState&&(this.lastAltState=e.altKey,i=!0),i}getMouseKeyValues(e,t){const i=[];t.rightButton&&i.push(Qn.tc.RIGHT),t.middleButton&&i.push(Qn.tc.MIDDLE),t.leftButton&&i.push(Qn.tc.LEFT);const s=[];return lS().usesControlKey()&&e.ctrlKey&&s.push(Is.R8.CONTROL),lS().usesShiftKey()&&e.shiftKey&&s.push(Is.R8.SHIFT),lS().usesAltKey()&&e.altKey&&s.push(Is.R8.ALT),{mouseButtonSettings:i,modifierKeys:s}}getManipulationMode(e,t){if(this.forcedManipulationMode!==aA.k.NONE&&t.leftButton)return this.forcedManipulationMode;const i=this.getMouseKeyValues(e,t),s=i.mouseButtonSettings,n=i.modifierKeys,r=lS().getManipulationMode(s,n);return r!==aA.k.ZOOM&&r!==aA.k.AXIS_ROTATE&&r!==aA.k.PAN&&r!==aA.k.ROTATE?aA.k.NONE:r}forceManipulationMode(e){this.forcedManipulationMode=e}getClosestMode(e,t,i){const s=this.getMouseKeyValues(e,t),n=s.mouseButtonSettings,r=s.modifierKeys;return lS().getClosestMode(n,r,i)}updateManipulationMode(e,t){if(!this.updateInputState(e,t))return;const i=this.manipulationMode,s=this.forcedManipulationMode!==aA.k.NONE?this.forcedManipulationMode:this.getManipulationMode(e,t);if(s!==aA.k.NONE)this.manipulationMode=s;else{const i=this.getClosestMode(e,t,this.manipulationMode);i!==aA.k.NONE?this.manipulationMode=i:this.manipulationMode=this.getClosestMode(e,t)}i!==this.manipulationMode&&(!(this.isRotating()||this.isPanning()||this.isAxisRotating())||this.isRotating()&&i===aA.k.AXIS_ROTATE||this.isAxisRotating()&&i===aA.k.ROTATE||this.updateRotationPanCenter(e),this.isRotating()&&(this.lastRotationTime=(0,Xs.Wj)(),this.rotationSpeedX=0,this.rotationSpeedY=0))}setRotationPivotPosition(e){this.rotateOrPanCenter=e}setIsSpaceballMoving(e){this.isSpaceballMoving=e}isPanning(){return this.manipulationMode===aA.k.PAN}isRotating(){return this.manipulationMode===aA.k.ROTATE}isAxisRotating(){return this.manipulationMode===aA.k.AXIS_ROTATE}isZooming(){return this.manipulationMode===aA.k.ZOOM}isBeingManipulated(){return this.manipulationMode!==aA.k.NONE}isBeingForceManipulated(){return this.isBeingManipulated()&&this.manipulationMode===this.forcedManipulationMode}getRotateCenterUnderPoint(e,t){const i=nr.getNumber("ROTATION_CENTER_SEARCH_RADIUS"),s=2*i+1,n=2*i+1,r=e-i,a=t-i,o=this.viewer.findDepthsInRect(r,a,s,n,!1);let h=null,c=1/0;const l=Q.create(),d=[e,t];for(let e=0;e<o.length;++e)if(o[e][2]!==Xs.BG){const t=o[e],i=Q.squaredLength(ge.gv.subtract(t,d,l));i<c&&(h=t,c=i)}return h?this.camera.canvasToWorld(h):null}getRotateCenterBasedOnWindowDepths(e){const t=this.viewer.retrieveDepthSampling(e),i=[0,0,0],s=t.length;for(let e=0;e<s;++e)for(let s=0;s<3;++s)i[s]+=t[e][s];return s>0&&s>=nr.getNumber("MIN_SAMPLES_TO_USE_FOR_DEPTH_AVERAGED_ROTATION_CENTER")?this.camera.canvasToWorld([i[0]/s,i[1]/s,i[2]/s]):null}getRotateCenterBasedOnBounds(){const e=this.viewer.getModelViewManagers().getManager().getModelBounds();return e&&e.isInitialized()&&!e.isInfinite()?this.camera.doBoundsFitInViewport(e,this.camera.getViewport(),nr.getNumber("MODEL_SIZE_TO_VIEWPORT_ROTATE_BOUNDS_FACTOR"))?e.center():null:M.create()}getRotateCenterBasedOnCanvasLocationAndBoundsDepth(e,t){const i=this.viewer.getModelViewManagers().getManager().getModelBounds();if(!i||!i.isInitialized()||i.isInfinite())return M.create();const s=this.camera.getRay(e,t),n=.01*i.diameter();return ge.S4.add(s.point,ge.S4.scale(s.direction,Math.max(M.dot(s.direction,ge.S4.subtract(i.center(),s.point,M.create())),n),M.create()))}getRotateCenterForCanvasLocation(e,t){let i=this.getRotateCenterUnderPoint(e,t);return i||(i=this.getRotateCenterBasedOnWindowDepths({includePlanes:!1}),i||(i=this.getRotateCenterBasedOnWindowDepths({includePlanes:!0}),i||(i=this.getRotateCenterBasedOnBounds(),i||this.getRotateCenterBasedOnCanvasLocationAndBoundsDepth(e,t))))}getRotateCenterForSpaceball(){let e=this.getRotateCenterBasedOnBounds();if(e)return e;const t=[this.camera.getViewportWidth()/2,this.camera.getViewportHeight()/2];return e=this.getRotateCenterUnderPoint(t[0],t[1]),e||(e=this.getRotateCenterBasedOnWindowDepths({includePlanes:!1}),e||(e=this.getRotateCenterBasedOnWindowDepths({includePlanes:!0}),e||this.getRotateCenterBasedOnCanvasLocationAndBoundsDepth(t[0],t[1])))}updateRotationPanCenterForSpaceball(){this.setRotationPivotPosition(this.getRotateCenterForSpaceball())}updateRotationPanCenter(e){this.rotateOrPanCenter=[0,0,0];const t=this.viewer.getCanvasCoordinateFromEvent(e),i=t[0],s=t[1];(this.isRotating()||this.isAxisRotating()||this.isPanning()&&this.isPerspective())&&this.setRotationPivotPosition(this.getRotateCenterForCanvasLocation(i,s))}onDragStart(e,t,i){const s=this.isZooming();this.updateManipulationMode(t,i);if(!s&&this.isZooming()){const t=this.viewer.getCanvasCoordinateFromEvent(e);this.dragZoomCanvasCoordinates[0]=t[0],this.dragZoomCanvasCoordinates[1]=t[1]}return this.haltPostRotationAnimation=this.isBeingManipulated(),this.isBeingManipulated()}zoomOnCanvasPoint(e,t,i){const s=this.camera.viewNormalPlaneAtPoint(this.camera.focalPoint()),n=(0,wi.fE)(this.camera.getRay(e,0),s);let r,a=(0,wi.fE)(this.camera.getRay(e,t),s);n&&a?(r=ge.S4.subtract(a,this.camera.getEye(),M.create()),ge.S4.normalize(r)):(i=0,r=this.camera.getEye());const o=this.viewer.getSceneBounds().getCorners();i<0&&X.default.getManager().getNumber("USE_CENTRAL_ZOOM_OUT")&&(a=(0,wi.fE)(this.camera.getRay(this.camera.getViewportWidth()/2,this.camera.getViewportHeight()/2),s)),a?this.zoomPoint(a,{direction:r},i,o):er.debug("No point intersection found for zoomOnCanvasPoint")}zoomOnMouseWheelScroll(e){e.preventDefault();const t=e.originalEvent;let i=0,s=.5;if("mousewheel"===e.type){if(0===t.wheelDelta||t.wheelDeltaX&&Math.abs(t.wheelDeltaX)>Math.abs(t.wheelDeltaY))return!1;s/=120,(0,pt.isPlatformWindows)()&&(s*=3),i=s*t.wheelDelta}else{if(0===t.detail||1===t.axis)return!1;i=-s*t.detail}const n=this.viewer.getCanvasCoordinateFromEvent(t),r=n[0],a=n[1];return oM().isScrollZoomDefault()||(i=-i),this.zoomOnCanvasPoint(r,a,i),!0}zoomOnDrag(e){if(Math.abs(e)<Ri.W.ZERO_LENGTH)return;const t=this.dragZoomCanvasCoordinates[0],i=this.dragZoomCanvasCoordinates[1];e=-1*e/X.default.getManager().getNumber("DRAG_ZOOM_FACTOR"),this.zoomOnCanvasPoint(t,i,e)}onDrag(e,t,i,s,n,r){this.forcedManipulationMode===aA.k.NONE&&this.updateManipulationMode(e,t);const a=this.viewer.$el,o=this.camera.viewNormalPlaneAtPoint(this.rotateOrPanCenter),h=()=>{const e=(0,wi.fE)(this.camera.getRay(n,r),o),t=(0,wi.fE)(this.camera.getRay(n+i,r+s),o);return e&&t?(ge.S4.subtract(t,e),t):null};if(this.isPanning()){const e=h.call(this);e&&this.pan(e)}else if(this.isRotating()){const e=[+a.attr("width"),+a.attr("height")],t=2*Math.PI*nr.getNumber("ROTATION_CYCLES_PER_SCREEN")/ge.gv.length(e);this.rotateAbout(-i*t,this.camera.getUp(),this.rotateOrPanCenter),this.rotateAbout(-s*t,this.camera.getRight(),this.rotateOrPanCenter),this.lastRotationTime=(0,Xs.Wj)(),this.rotationSpeedX=.5*(this.rotationSpeedX+i),this.rotationSpeedY=.5*(this.rotationSpeedY+s),this.tagCanvasWithView("unknown")}else if(this.isAxisRotating()){const e=a.attr("data-view-shown")===this.axisRotateCanvasTag;if(!this.animationController.isCameraAnimating())if(e){const e=[+a.attr("width"),+a.attr("height")],t=2*Math.PI*nr.getNumber("ROTATION_CYCLES_PER_SCREEN")/ge.gv.length(e),n=(0,Er.sign)(this.camera.getUp()[2])||1;this.rotateAbout(-i*n*t,this.axisRotateUpAxis,this.rotateOrPanCenter),this.rotateAbout(-s*t,this.camera.getRight(),this.rotateOrPanCenter)}else{const e=Math.asin(M.dot(this.camera.getRight(),this.axisRotateUpAxis)),t=ge.S4.cross(this.camera.getRight(),this.axisRotateUpAxis,M.create()),i=Math.abs(e);if(i<nr.getNumber("AXIS_ROTATION_SNAP_TOLERANCE"))this.rotateAbout(-e,t,this.rotateOrPanCenter),this.tagCanvasWithView(this.axisRotateCanvasTag);else{const s=this.camera.clone();s.rotateAbout(-e,t,this.rotateOrPanCenter);const n=nr.getNumber(i>Math.PI/4?"CAMERA_SHORT_ANIMATION_TIME_MS":"CAMERA_SNAP_ANIMATION_TIME_MS");this.animateToCustomView(s,n,this.axisRotateCanvasTag)}}}else this.isZooming()&&this.zoomOnDrag(s);this.updateCameraNearFar(),this.afterViewChange()}onDragStop(e){this.isRotating()&&this.performStopRotationAnimation(),this.resetInputState(),this.manipulationMode=aA.k.NONE}getPointerPosition(){return this.viewer.getCanvasCoordinateFromEvent(this.viewer.getLastMouseMovedEvent())}performStopRotationAnimation(){if(this.viewer.isInteractiveFramerateBelowThreshold())return;this.haltPostRotationAnimation=!1;const e=ge.gv.length([this.camera.getViewportWidth(),this.camera.getViewportHeight()]),t=2*Math.PI*nr.getNumber("ROTATION_CYCLES_PER_SCREEN")/e,i=nr.getNumber("ROTATION_INERTIA");let s=1;let n=(0,Xs.Wj)();(0,Xs.Wj)()-this.lastRotationTime<50&&this.animationController.startCameraAnimation((e=>{const r=(0,Xs.Wj)();s*=Math.pow(i,(r-n)/16.666666666666668),n=r;const a=this.rotationSpeedX*s,o=this.rotationSpeedY*s;return!this.haltPostRotationAnimation&&(Math.abs(a)>1||Math.abs(o)>1)?(this.rotateAbout(-a*t,this.camera.getUp(),this.rotateOrPanCenter),this.rotateAbout(-o*t,this.camera.getRight(),this.rotateOrPanCenter),Jn.Z.ONGOING):Jn.Z.COMPLETE}))}rotateAbout(e,t,i){this.camera.rotateAbout(e,t,i)}pan(e){this.camera.pan(e)}canZoom(e,t){if(t){const i=new wi.kB;for(let e=0;e<t.length;e++)i.addPoint(t[e]);if(i.diameter()>0){const t=this.camera.getPixelSizeAtWorldPoint(i.center()),s=X.default.getManager().getNumber("MIN_MODEL_PIXEL_SIZE");return!(e>=1&&i.diameter()/t<=e*s||e<=1&&1/t>=e*Math.pow(2,24))}}return!1}adjustCameraToValidZoom(e){if(!e)return!1;const t=this.viewer.getFitBounds();if(!this.canBoundsBeFit(t))return!1;const i=X.default.getManager().getNumber("MIN_MODEL_PIXEL_SIZE"),s=e.getPixelSizeAtWorldPoint(t.center());let n=1;return t.diameter()/s<=i?n=t.diameter()/s/i:1/s>=Math.pow(2,24)&&(n=1/(Math.pow(2,24)*s)),1!==n&&(er.debug("Given camera would result in invalid scene zoom. Applying zoom: "+n),e.zoom(n)),!0}zoom(e){}setStandardView(e){const t=sr[e];t&&(this.camera.setFrame(t),this.tagCanvasWithView(e))}animateToCustomView(e,t,i){this.animateTo(e,t,i)}animateViewNormalToPlaneMatrix(e,t,i){if(!e)return;let s;const n=rr(this.viewer,this.camera);if(this.camera.canBoundsFitInViewport(t,n)){const i=this.camera.viewportToCanvas([n[0]+n[2]/2-this.camera.getViewportLeft(),n[1]+n[3]/2-this.camera.getViewportBottom(),0]);s=this.camera.getCameraRotatedToViewAndTranslated(e,t.center(),i)}else{const t=i?i[0]:this.camera.getViewportWidth()/2,n=i?i[1]:this.camera.getViewportHeight()/2,r=this.getRotateCenterForCanvasLocation(t,n);s=this.camera.getCameraRotatedToView(e,r)}this.animateToCustomView(s,nr.getNumber("CAMERA_LONG_ANIMATION_TIME_MS"))}animateTo(e,t,i){if(this.animationController.isCameraAnimating())return;if(this.tagCanvasWithView(),this.viewer.isInteractiveFramerateBelowThreshold())return this.camera.copyFrom(e),this.updateCameraNearFar(),this.afterViewChange(),this.viewer.getAnimationController().incrementAnimationSequence(),this.tagCanvasWithView(i),void this.viewer.getBodyManager().onUserIsAdjustingCamera();const s=(0,Xs.Wj)(),n=new $n.f(this.camera,e);this.animationController.startCameraAnimation((e=>{const r=(0,Xs.Wj)();let a;const o=r-s;a=o>=t?1:o/t,a=a*a*a*(a*(6*a-15)+10);const h=n.interpolate(a);return(0,wi.nP)(this.camera.getViewport(),h.viewport)?(this.camera.copyFrom(h),this.updateCameraNearFar(),r-s<t?Jn.Z.ONGOING:(this.tagCanvasWithView(i),this.viewer.getBodyManager().onUserIsAdjustingCamera(),this.viewer.getEventDispatcher().trigger(nM.h0,null),Jn.Z.COMPLETE)):(er.trace("Camera viewport changed mid-animation, terminating animation early"),Jn.Z.COMPLETE)}))}tagCanvasWithView(e){e?this.viewer.$el.attr("data-view-shown",e):this.viewer.$el.attr("data-view-shown","unknown")}getViewportCenter(){const e=rr(this.viewer,this.camera);return Q.fromValues(e[0]+e[2]/2,e[1]+e[3]/2)}canBoundsBeFit(e){const t=e.isInitialized()&&!e.isInfinite();return t||er.warn("An attempt was made to fit a camera with invalid bounds"),t}animateToFrameWithZoomFit(e,t,i,s,n,r){if(!this.canBoundsBeFit(t))return;const a=this.getZoomFitTargetCamera(e,t,n,r);this.adjustCameraToValidZoom(a)&&this.animateTo(a,i,s)}getZoomFitTargetCamera(e,t,i,s){const n=t.getCorners();let r=null;i||(r=rr(this.viewer,this.camera));const a=this.camera.clone();a.setFrame(e);let o=s;return o||(o=nr.getNumber("CAMERA_ZOOM_TO_FIT_PADDING")),a.zoomToFit(n,o,r),a.updateNearFar(),a}animateToStandardView(e,t){if(!this.canBoundsBeFit(t))return;const i=sr[e];i&&this.animateToFrameWithZoomFit(i,t,nr.getNumber("CAMERA_LONG_ANIMATION_TIME_MS"),e)}animateToStandardViewIgnoringUIPanels(e,t,i){if(!this.canBoundsBeFit(t))return;const s=sr[e];s&&this.animateToFrameWithZoomFit(s,t,nr.getNumber("CAMERA_LONG_ANIMATION_TIME_MS"),e,!0,i)}animateZoomToFit(e){if(!this.canBoundsBeFit(e))return;const t=e.getCorners(),i=rr(this.viewer,this.camera),s=this.camera.clone();s.zoomToFit(t,nr.getNumber("CAMERA_ZOOM_TO_FIT_PADDING"),i),this.adjustCameraToValidZoom(s)&&this.animateTo(s,nr.getNumber("CAMERA_LONG_ANIMATION_TIME_MS"))}zoomFitCamera(e,t,i){if(!this.canBoundsBeFit(e))return;const s=e.getCorners(),n=this.camera.clone();n.zoomToFit(s,nr.getNumber("CAMERA_ZOOM_TO_FIT_PADDING"),t),n.updateNearFar(s),this.adjustCameraToValidZoom(n)&&(this.camera=n,this.afterViewChange(i))}zoomFit(e,t){this.animationController.haltCameraAnimation(),this.zoomFitCamera(e,rr(this.viewer,this.camera),t)}zoomFitWithoutPanels(e){this.zoomFitCamera(e)}animateRotation(e,t,i,s){let n=0;const r=(0,Xs.Wj)();if(s||(s=this.camera.focalPoint()),this.tagCanvasWithView(),this.viewer.isInteractiveFramerateBelowThreshold())return this.rotateAbout(t,e,s),this.updateCameraNearFar(),void this.afterViewChange();this.animationController.startAnimation((a=>{if(Math.abs(n)<Math.abs(t)){if(!this.viewer.isReadyForDrawing())return;const a=(0,Xs.Wj)(),o=Math.min(a-r,i)/i*t,h=o-n;return this.rotateAbout(h,e,s),this.updateCameraNearFar(),n=o,a-r<=i?Jn.Z.ONGOING:(this.viewer.getEventDispatcher().trigger(nM.h0,null),Jn.Z.COMPLETE)}}))}rotateInDirection(e,t){const i=this.camera.up,s=this.camera.direction,n=ge.S4.cross(s,i,M.create());switch(e){case"left":this.animateRotation(i,t,nr.getNumber("CAMERA_SHORT_ANIMATION_TIME_MS"));break;case"right":this.animateRotation(i,-t,nr.getNumber("CAMERA_SHORT_ANIMATION_TIME_MS"));break;case"up":this.animateRotation(n,t,nr.getNumber("CAMERA_SHORT_ANIMATION_TIME_MS"));break;case"down":this.animateRotation(n,-t,nr.getNumber("CAMERA_SHORT_ANIMATION_TIME_MS"));break;case"clockwise":this.animateRotation(s,-t,nr.getNumber("CAMERA_SHORT_ANIMATION_TIME_MS"));break;case"counterclockwise":this.animateRotation(s,t,nr.getNumber("CAMERA_SHORT_ANIMATION_TIME_MS"));break;case"180":this.animateRotation(i,Math.PI,nr.getNumber("CAMERA_LONG_ANIMATION_TIME_MS"))}}animatePan(e,t){const i=this.camera.clone(),s=i.getPixelSizeAtWorldPoint(i.getSceneBounds().center()),n=ge.S4.add(ge.S4.scale(i.getRight(),s*-e,M.create()),ge.S4.scale(i.getUp(),s*-t,M.create()));i.pan(n),this.animateTo(i,nr.getNumber("CAMERA_SHORT_ANIMATION_TIME_MS"))}panRight(){this.animatePan(nr.getNumber("DEFAULT_PAN_AMOUNT_PX"),0)}panLeft(){this.animatePan(-nr.getNumber("DEFAULT_PAN_AMOUNT_PX"),0)}panUp(){this.animatePan(0,nr.getNumber("DEFAULT_PAN_AMOUNT_PX"))}panDown(){this.animatePan(0,-nr.getNumber("DEFAULT_PAN_AMOUNT_PX"))}animateZoom(e){const t=this.camera.clone();t.zoom(e),this.adjustCameraToValidZoom(t)&&this.animateTo(t,nr.getNumber("CAMERA_SHORT_ANIMATION_TIME_MS"))}zoomIn(){this.animateZoom(1/nr.getNumber("DEFAULT_ZOOM_FACTOR"))}zoomOut(){this.animateZoom(nr.getNumber("DEFAULT_ZOOM_FACTOR"))}zoomPoint(e,t,i,s){}updateCameraNearFar(){const e=this.viewer.getSceneGraphs().getMainSceneGraph().getBounds();e.isFinite()&&this.camera.updateNearFar(e.getCorners())}getMatchingOrthographicController(){return null}getMatchingPerspectiveController(){return null}afterViewChange(e){e||this.viewer.getEventDispatcher().trigger(nM.h0,null),this.viewer.requestDraw()}}class or extends ar{constructor(e,t){super(e),this.camera=new Rh(t)}isPerspective(){return!0}clone(){const e=new or(this.viewer);return e.camera=this.camera.clone(),e.forcedManipulationMode=this.forcedManipulationMode,e}zoom(e){const t=this.camera,i=Math.max(t.distanceToCenter(),t.getMinDistance())*e/6;t.dolly(i),t.updateNearFar()}zoomPoint(e,t,i,s){const n=Math.pow(2,-i/6);if(this.canZoom(n,s)){const e=this.camera,n=Math.max(e.distanceToCenter(),e.getMinDistance())*i/6;e.dollyAlong(n,t.direction),e.updateNearFar(s)}}getMatchingOrthographicController(){const e=new hr(this.viewer);return e.camera=this.camera.getOrthographicCamera(),e.forcedManipulationMode=this.forcedManipulationMode,e}}class hr extends ar{constructor(e,t){super(e),this.camera=new wh(t)}isOrthographic(){return!0}zoom(e){const t=Math.pow(2,-e/6);this.camera.zoom(t)}zoomPoint(e,t,i,s){const n=Math.pow(2,-i/6);this.canZoom(n,s)&&this.camera.zoomPoint(e,t,n,s)}clone(){const e=new hr(this.viewer);return e.camera=this.camera.clone(),e.forcedManipulationMode=this.forcedManipulationMode,e}getMatchingPerspectiveController(){const e=new or(this.viewer);return e.camera=this.camera.getPerspectiveCamera(),e.forcedManipulationMode=this.forcedManipulationMode,e}}var cr,lr=i(72229);!function(e){e.RIGHT="Right",e.LEFT="Left",e.TOP="Top",e.BOTTOM="Bottom",e.NEAR="Near",e.FAR="Far"}(cr||(cr={}));class dr{constructor(e,t,i,s){const n=Math.sqrt(e*e+t*t+i*i);this.normal=[e/n,t/n,i/n],this.d=s/n}}class ur{constructor(e,t){this.clippingPlanes={},this.clippingMatrix=ue.create(),e&&t&&this.updateClippingPlanes(e,t)}updateClippingPlanes(e,t){e&&t&&(this.clippingMatrix[0]=e[0]*t[0]+e[1]*t[4]+e[2]*t[8]+e[3]*t[12],this.clippingMatrix[1]=e[0]*t[1]+e[1]*t[5]+e[2]*t[9]+e[3]*t[13],this.clippingMatrix[2]=e[0]*t[2]+e[1]*t[6]+e[2]*t[10]+e[3]*t[14],this.clippingMatrix[3]=e[0]*t[3]+e[1]*t[7]+e[2]*t[11]+e[3]*t[15],this.clippingMatrix[4]=e[4]*t[0]+e[5]*t[4]+e[6]*t[8]+e[7]*t[12],this.clippingMatrix[5]=e[4]*t[1]+e[5]*t[5]+e[6]*t[9]+e[7]*t[13],this.clippingMatrix[6]=e[4]*t[2]+e[5]*t[6]+e[6]*t[10]+e[7]*t[14],this.clippingMatrix[7]=e[4]*t[3]+e[5]*t[7]+e[6]*t[11]+e[7]*t[15],this.clippingMatrix[8]=e[8]*t[0]+e[9]*t[4]+e[10]*t[8]+e[11]*t[12],this.clippingMatrix[9]=e[8]*t[1]+e[9]*t[5]+e[10]*t[9]+e[11]*t[13],this.clippingMatrix[10]=e[8]*t[2]+e[9]*t[6]+e[10]*t[10]+e[11]*t[14],this.clippingMatrix[11]=e[8]*t[3]+e[9]*t[7]+e[10]*t[11]+e[11]*t[15],this.clippingMatrix[12]=e[12]*t[0]+e[13]*t[4]+e[14]*t[8]+e[15]*t[12],this.clippingMatrix[13]=e[12]*t[1]+e[13]*t[5]+e[14]*t[9]+e[15]*t[13],this.clippingMatrix[14]=e[12]*t[2]+e[13]*t[6]+e[14]*t[10]+e[15]*t[14],this.clippingMatrix[15]=e[12]*t[3]+e[13]*t[7]+e[14]*t[11]+e[15]*t[15],this.updateClippingPlane(cr.BOTTOM,this.clippingMatrix[3]+this.clippingMatrix[1],this.clippingMatrix[7]+this.clippingMatrix[5],this.clippingMatrix[11]+this.clippingMatrix[9],this.clippingMatrix[15]+this.clippingMatrix[13]),this.updateClippingPlane(cr.TOP,this.clippingMatrix[3]-this.clippingMatrix[1],this.clippingMatrix[7]-this.clippingMatrix[5],this.clippingMatrix[11]-this.clippingMatrix[9],this.clippingMatrix[15]-this.clippingMatrix[13]),this.updateClippingPlane(cr.LEFT,this.clippingMatrix[3]+this.clippingMatrix[0],this.clippingMatrix[7]+this.clippingMatrix[4],this.clippingMatrix[11]+this.clippingMatrix[8],this.clippingMatrix[15]+this.clippingMatrix[12]),this.updateClippingPlane(cr.RIGHT,this.clippingMatrix[3]-this.clippingMatrix[0],this.clippingMatrix[7]-this.clippingMatrix[4],this.clippingMatrix[11]-this.clippingMatrix[8],this.clippingMatrix[15]-this.clippingMatrix[12]))}updateClippingPlane(e,t,i,s,n){if(this.clippingPlanes[e]){const r=Math.sqrt(t*t+i*i+s*s),a=[t/r,i/r,s/r],o=n/r;this.clippingPlanes[e].normal=a,this.clippingPlanes[e].d=o}else this.clippingPlanes[e]=new dr(t,i,s,n)}getSphereFrustumIntersection(e,t){let i=this.clippingPlanes[cr.BOTTOM];const s=i.normal[0]*e[0]+i.normal[1]*e[1]+i.normal[2]*e[2]+i.d;if(s<-t)return lr.I.OUTSIDE;i=this.clippingPlanes[cr.TOP];const n=i.normal[0]*e[0]+i.normal[1]*e[1]+i.normal[2]*e[2]+i.d;if(n<-t)return lr.I.OUTSIDE;i=this.clippingPlanes[cr.RIGHT];const r=i.normal[0]*e[0]+i.normal[1]*e[1]+i.normal[2]*e[2]+i.d;if(r<-t)return lr.I.OUTSIDE;i=this.clippingPlanes[cr.LEFT];const a=i.normal[0]*e[0]+i.normal[1]*e[1]+i.normal[2]*e[2]+i.d;return a<-t?lr.I.OUTSIDE:s>t&&n>t&&r>t&&a>t?lr.I.INSIDE:lr.I.INTERSECTING}}function gr(e,t,i,s){const n=i[0]-e[0],r=i[1]-e[1],a=i[2]-e[2],o=n*t[0]+r*t[1]+a*t[2];return o>s?lr.I.OUTSIDE:o<-s?lr.I.INSIDE:lr.I.INTERSECTING}var pr=i(13265),mr=i(97511),fr=i(13476),Ir=i(18600),Er=i(29327),Sr=i(1190),Tr=i(57702);const Dr=_e.O.createLogger("manipulators",k.bVy.GRAPHICS),Cr=X.default.getManager(),Mr="selection",yr="lines.",Ar="outlines.",Pr="lines",Or="manipulator-displacement-graphics",Rr=new Gi.hF({isVisible:!0,isPickable:!1,isTwoSided:!0,isShowThrough:!0,isDepthTested:!1,priority:Gi.DO.DEFAULT,primitiveType:Ai.MX.LINES}),wr=new Gi.hF(Object.assign({},Rr,{priority:Gi.DO.HIGHEST})),vr=new Gi.hF({isVisible:!0,isPickable:!1,isTwoSided:!0,isShowThrough:!0,isDepthTested:!1,priority:Gi.DO.LOWER,primitiveType:Ai.MX.LINES}),_r=new Gi.hF(Object.assign({},vr,{priority:Gi.DO.HIGHER})),Nr=new Gi.hF({isVisible:!1,isPickable:!0,isTwoSided:!0,isShowThrough:!0,isDepthTested:!1,primitiveType:Ai.MX.TRIANGLES});class br extends yi.u1{constructor(e,t){super(e),this.isDragging=!1,this.isHovering=!1,this.isEnabled=!0,this.meshIncrement=null,this.pickIncrement=null,this.updateIncrement=!1,this.doSnappingBehavior=!0,this.offsetRoundDecimals=8,this.hasEditView=!1,this.isLocked=!1,t||(t={displayEditView:!1}),this.style=k.xKD.DEFAULT,this.lineColor=new Uint8Array([0,0,0,0]),this.outlineColor=new Uint8Array([0,0,0,0]),this.triadOwnerType=Sr.Ak.UNKNOWN,this.displayEditView=t.displayEditView,this.listenTo(this,yi.zw.MOUSE_ENTER+Mr,this.onMouseEnter),this.listenTo(this,yi.zw.MOUSE_LEAVE+Mr,this.onMouseLeave),this.listenTo(this,yi.zw.DRAG_START+Mr,this.onDragStart),this.listenTo(this,yi.zw.DRAG+Mr,this.onDrag),this.listenTo(this,yi.zw.DRAG_STOP+Mr,this.onDragStop),this.listenTo(this,yi.zw.CLICK+Mr,this.onClick),this.listenTo(this,yi.zw.DOUBLE_CLICK+Mr,this.onDoubleClick),this.listenTo(this,yi.zw.XR_DRAG_START+Mr,this.onXrDragStart),this.listenTo(this,yi.zw.XR_DRAG+Mr,this.onXrDrag),this.listenTo(this,yi.zw.XR_DRAG_STOP+Mr,this.onXrDragStop)}onAppearanceConstantsUpdated(){this.updateIncrement=!0}isManipulator(){return!0}setIsLocked(e){this.isLocked=e}getIsLocked(){return this.isLocked}onDevicePixelRatioChanged(e){this.meshIncrement=null,this.updateGraphics(e)}setStyle(e){this.style=e||k.xKD.DEFAULT}setFadeParameters(e,t){this.fadeAngleStart=(0,wi.Yr)((0,wi.uZ)(e,0,90)),this.fadeAngleEnd=(0,wi.Yr)((0,wi.uZ)(t,0,90))}setIsEnabled(e){this.isEnabled=e,(0,Xs.vm)()}getIsEnabled(){return this.isEnabled}setTriadOwnerType(e){this.triadOwnerType=e}getTriadOwnerType(){return this.triadOwnerType}onViewWillDraw(e,t){this.isHidden||this.updateGraphics(e)}onMouseEnter(e,t){this.isEnabled&&(this.isHovering=!0,this.updateIncrement=!0,this.trigger(Sr.Wb.MANIPULATOR_ENTER,this),(0,Xs.vm)())}onMouseLeave(e,t){this.isEnabled&&(this.isHovering=!1,this.updateIncrement=!0,this.trigger(Sr.Wb.MANIPULATOR_LEAVE,this),(0,Xs.vm)())}onDragStart(e,t,i){this.isEnabled&&(this.isDragging=!0,this.updateIncrement=!0,i.requestDrag=!0,this.trigger(Sr.Wb.MANIPULATION_STARTED,this),(0,Xs.vm)())}onDragStop(e,t){this.isDragging=!1,this.updateIncrement=!0,this.trigger(Sr.Wb.MANIPULATION_ENDED),(0,Xs.vm)()}onDrag(e,t){}onXrDragStart(e,t,i){this.isEnabled&&(this.isDragging=!0,this.updateIncrement=!0,i.requestDrag=!0,this.trigger(Sr.Wb.MANIPULATION_STARTED,this),this.viewer.requestDraw())}onXrDragStop(e,t){this.isDragging=!1,this.updateIncrement=!0,this.trigger(Sr.Wb.MANIPULATION_ENDED),(0,Xs.vm)()}onXrDrag(e,t){}onClick(e,t){this.isEnabled&&("sourceEvent"in t&&t.sourceEvent instanceof Tr.Event&&t.sourceEvent.stopPropagation(),this.trigger(Sr.Wb.CLICKED,this))}onDoubleClick(e,t){this.isEnabled&&this.trigger(Sr.Wb.DOUBLE_CLICKED,this,e)}getOutlineColor(){return this.isEnabled?this.isDragging?Cr.getColor("MANIPULATOR_OUTLINE_DRAG_COLOR"):this.isHovering?Cr.getColor("MANIPULATOR_OUTLINE_HOVER_COLOR"):Cr.getColor("MANIPULATOR_OUTLINE_COLOR"):Cr.getColor("MANIPULATOR_OUTLINE_DISABLED_COLOR")}getLineColor(){return this.isEnabled?this.isDragging?Cr.getColor("MANIPULATOR_LINE_DRAG_COLOR"):this.isHovering?Cr.getColor("MANIPULATOR_LINE_HOVER_COLOR"):Cr.getColor("MANIPULATOR_LINE_COLOR"):Cr.getColor("MANIPULATOR_LINE_DISABLED_COLOR")}isHighlighted(){return this.isDragging||this.isHovering}updateLines(e,t,i){const s=t.clone();i=void 0!==i?i:1,this.isEnabled||(i*=Cr.getNumber("MANIPULATOR_DISABLED_OPACITY"));const n=this.getLineColor();n[3]=(0,wi.uZ)(n[3]*i,1/255,1),(0,Yd.Ab)(n,t),(0,Yd.VQ)(Cr.getNumber("MANIPULATOR_LINE_WIDTH"),t),this.updateMeshIncrement(yr+e,yi.ZJ,t,this.isHighlighted()?wr:Rr);const r=this.getOutlineColor();r[3]=(0,wi.uZ)(r[3]*i,1/255,1),(0,Yd.Ab)(r,s),(0,Yd.VQ)(Cr.getNumber("MANIPULATOR_LINE_WIDTH")+2*Cr.getNumber("MANIPULATOR_OUTLINE_WIDTH"),s),this.updateMeshIncrement(Ar+e,yi.ZJ,s,this.isHighlighted()?_r:vr)}removeDisplacementMeshIncrements(){this.removeMeshIncrement(Or)}updatePickArea(e){this.viewer.performingBoxSelection()||((0,Yd.Ab)([0,0,0,1],e),this.updateMeshIncrement("pickarea",Mr,e,Nr))}updateGeometry(){}updateColor(e){if(e=void 0!==e?e:1,this.isEnabled||(e*=Cr.getNumber("MANIPULATOR_DISABLED_OPACITY")),e<=0?this.isTransparent||this.makeTransparent():this.isTransparent&&this.makeOpaque(),this.isHidden||this.isTransparent)return;let t=this.getLineColor();t[3]=(0,wi.uZ)(t[3]*e,1/255,1),t=[255*t[0],255*t[1],255*t[2],255*t[3]],this.lineColor[0]===t[0]&&this.lineColor[1]===t[1]&&this.lineColor[2]===t[2]&&this.lineColor[3]===t[3]||(this.lineColor.set(t),this.updateIncrementAttribute(yr+Pr,RS.COLOR,this.lineColor));let i=this.getOutlineColor();i[3]=(0,wi.uZ)(i[3]*e,1/255,1),i=[255*i[0],255*i[1],255*i[2],255*i[3]],this.outlineColor[0]===i[0]&&this.outlineColor[1]===i[1]&&this.outlineColor[2]===i[2]&&this.outlineColor[3]===i[3]||(this.outlineColor.set(i),this.updateIncrementAttribute(Ar+Pr,RS.COLOR,this.outlineColor))}updateGraphics(e){let t=this.updateIncrement;this.meshIncrement||(this.updateGeometry(),t=!0),this.meshIncrement&&t&&(this.updateLines(Pr,this.meshIncrement),this.updatePickArea(this.pickIncrement))}isBeingManipulated(){return this.isDragging}getLinearSnapValue(e,t,i){const s=e.camera.getPixelSizeAtWorldPoint(i),n=Cr.getNumber("MANIPULATOR_LINEAR_SNAP_RESOLUTION_PX")*s,r=(0,fr.vx)().getLengthUnits(),a=(0,Ir.KZ)(n,r);if(a<=0)return t;const o=Math.round(Math.log(a)/Math.log(10));let h=Math.pow(10,o-1);h/=Cr.getNumber("MANIPULATOR_LINEAR_INCREMENT_DIVISOR");const c=(0,Ir.KZ)(t,r)/h,l=Math.round(c),d=l-c,u=Cr.getNumber("MANIPULATOR_LINEAR_SNAP_DEVIATION");if(Math.abs(d)<=u){const e=h*l;t=(0,Ir.Fv)(e,r)}return t}onEditChange(e){}onEditCreate(){this.hasEditView=!0}onEditClose(){this.hasEditView=!1}triggerEditValueChange(e){(0,mr.m)().trigger(pr.C.SET_EDIT_VALUE,e)}triggerEditValueChangeNoUnit(e){(0,mr.m)().trigger(pr.C.SET_EDIT_VALUE_NO_UNIT,e)}triggerEditOriginChange(e,t){(0,mr.m)().trigger(pr.C.SET_EDIT_VIEW_ORIGIN,e,t)}remove(){this.hasEditView&&((0,mr.m)().trigger(pr.C.CLOSE_MANIPULATOR_EDIT_VIEW),(0,dh.a)().setActiveManipulator(null)),super.remove()}removeEditViewAndHighlights(){this.isHovering=!1,(0,mr.m)().trigger(pr.C.CLOSE_MANIPULATOR_EDIT_VIEW),(0,dh.a)().setActiveManipulator(null)}dragByIncrementValue(e){}}class Lr extends br{constructor(e,t){super(e,t),this.offset=0,this.initialRay=null,this.editOffset=0,this.visualGapPx=0,this.flipDirectionWhenNegative=!1,this.dragOffset=0,this.minOffset=-1/0,this.maxOffset=1/0,this.displacementGraphics=null,this.ray=new wi.zH([0,0,0],[0,0,1]),this.shaftLengthPx=Cr.getNumber("MANIPULATOR_LINEAR_SHAFT_LENGTH_PX"),this.isDraggable=!t||!t.hasOwnProperty("isDraggable")||t.isDraggable,this.setFadeParameters(Cr.getNumber("MANIPULATOR_LINEAR_FADE_ANGLE_START"),Cr.getNumber("MANIPULATOR_LINEAR_FADE_ANGLE_END"))}remove(){super.remove(),this.displacementGraphics&&(this.displacementGraphics.remove(),this.displacementGraphics=null)}updateGeometry(){let e=this.shaftLengthPx,t=Cr.getNumber("MANIPULATOR_LINEAR_HEAD_LENGTH_PX"),i=Cr.getNumber("MANIPULATOR_LINEAR_HEAD_RADIUS_PX");const s=Cr.getNumber("MANIPULATOR_CIRCLE_SEGMENTS");if(this.style===k.xKD.TANGENTIAL){const e=Cr.getNumber("MANIPULATOR_TANGENTIAL_SHAFT_LENGTH_PX"),t=Cr.getNumber("MANIPULATOR_TANGENTIAL_HEAD_LENGTH_PX"),i=Cr.getNumber("MANIPULATOR_TANGENTIAL_HEAD_RADIUS_PX"),n=Cr.getNumber("MANIPULATOR_TANGENTIAL_BASE_RADIUS_PX"),r=2*Math.max(i,n),a=2*(t+e)+n,o=(0,Yd.AD)(M.fromValues(0,0,n),M.fromValues(0,0,1),M.fromValues(1,0,0),e,t,i),h=(0,Yd.AD)(M.fromValues(0,0,-n),M.fromValues(0,0,-1),M.fromValues(1,0,0),e,t,i),c=(0,Yd.y)(M.fromValues(0,0,0),n,M.fromValues(0,1,0),s);this.meshIncrement=c.concatenate(o).concatenate(h),this.pickIncrement=(0,Yd.fQ)(M.fromValues(-r/2,0,-a/2),M.fromValues(r/2,0,-a/2),M.fromValues(-r/2,0,a/2))}else this.style===k.xKD.SECONDARY?(e-=t*Cr.getNumber("SECOND_DIRECTION_MANIPULATOR_OFFSET_PERCENT"),this.meshIncrement=(0,Yd.KE)(M.fromValues(0,0,0),M.fromValues(0,0,1),M.fromValues(1,0,0),e,t,i),this.pickIncrement=(0,Yd.fQ)(M.fromValues(-i,0,0),M.fromValues(i,0,0),M.fromValues(-i,0,e+t))):(this.style!==k.xKD.DEFAULT&&this.style!==k.xKD.SIMPLE&&Dr.debug("Manipulator style "+k.sAS[this.style]+" not implemented.  Using default style"),this.style===k.xKD.SIMPLE&&(e=0,t=Cr.getNumber("MANIPULATOR_LINEAR_SIMPLE_HEAD_LENGTH_PX"),i=Cr.getNumber("MANIPULATOR_LINEAR_SIMPLE_HEAD_RADIUS_PX")),this.meshIncrement=(0,Yd.AD)(M.fromValues(0,0,0),M.fromValues(0,0,1),M.fromValues(1,0,0),e,t,i),this.pickIncrement=(0,Yd.fQ)(M.fromValues(-i,0,0),M.fromValues(i,0,0),M.fromValues(-i,0,e+t)))}setVisualGap(e){this.visualGapPx=e}setShaftLength(e){this.shaftLengthPx=e}setFlipDirectionWhenNegative(e){this.flipDirectionWhenNegative=e}setIsDraggable(e){this.isDraggable=e}getOffsetFromEvent(e){const t=e.camera.getRay(e.mouseX,e.mouseY),i=this.ray.findClosestPositionToOtherRay(t);return i||0}getOffsetFromXrInputEvent(e){const t=this.ray.findClosestPositionToOtherRay(e.modelSpaceRay);return t||0}onDefaultUnitsChanged(){this.hasEditView&&this.createEditView()}createEditView(){this.editViewUnits=(0,fr.vx)().getLengthUnits();const e=new k.wtM;e.parameterId="length",e.units=this.editViewUnits,e.value=this.offset;const t={paramQuantity:e,quantityType:k.Uqp.LENGTH,range:null};(0,mr.m)().trigger(pr.C.CREATE_MANIPULATOR_EDIT_VIEW,this,t,this.viewer)}onDragStart(e,t,i){this.dragOffset=this.getOffsetFromEvent(t)-this.offset,super.onDragStart(e,t,i),this.initializeEditView()}onXrDragStart(e,t,i){this.dragOffset=this.getOffsetFromXrInputEvent(t)-this.offset,super.onXrDragStart(e,t,i),this.initializeEditView()}initializeEditView(){this.displayEditView&&!this.hasEditView&&(this.createEditView(),this.initialRay=new wi.zH(this.ray.point,this.ray.direction),(0,dh.a)().setActiveManipulator(this))}onEditChange(e){const t=e.units;this.editOffset=(0,Ir.Fv)(e.value,t),this.trigger(Sr.Wb.VALUE_EDITED)}onDrag(e,t){if(this.isLocked||!this.isDraggable)return;const i=this.getOffsetFromEvent(t)-this.dragOffset,s=!t.shiftKey;this.handleDrag(i,t.camera.getRay(t.mouseX,t.mouseY),s,t)}onXrDrag(e,t){if(this.isLocked||!this.isDraggable)return;const i=this.getOffsetFromXrInputEvent(t)-this.dragOffset;this.handleDrag(i,t.modelSpaceRay,!1)}handleDrag(e,t,i,s){if(e=(0,wi.uZ)(e,this.minOffset,this.maxOffset),i&&(e=this.getLinearSnapValue(s,e,this.ray.point),e=(0,wi.uZ)(e,this.minOffset,this.maxOffset)),this.offset=parseFloat(e.toFixed(this.offsetRoundDecimals)),this.hasEditView){let e=this.initialRay?.findClosestPositionToOtherRay(t);e=e?e-this.dragOffset:0,i&&(e=this.getLinearSnapValue(s,e,this.initialRay.point),e=(0,wi.uZ)(e,this.minOffset,this.maxOffset)),this.editOffset=e}this.trigger(Sr.Wb.VALUE_CHANGED,this.offset,s),this.viewer.requestDraw()}updateDefinition(e,t,i){if(this.isBeingManipulated()){const i=this.ray.evaluate(this.offset);this.ray=new wi.zH(e,t);const s=this.ray.findPositionOfPoint(i);this.offset=s}else this.ray=new wi.zH(e,t),i||(i=0),this.offset=i;(0,Xs.vm)()}updateDefinitionForLocalManipulatorAtRest(e,t,i){const s=2*Ri.W.ZERO_LENGTH,n=i?-s:s;this.updateDefinition(e,t,n)}updateLimits(e,t){this.minOffset=e,this.maxOffset=t}getOffset(){return this.offset}getEditOffset(){return this.editOffset}getOffsetPosition(){return this.ray.evaluate(this.offset)}getEditOffsetPosition(){return this.initialRay.evaluate(this.editOffset)}getInitialOffsetPosition(){return this.initialRay.point}getEditTranslation(){return ge.S4.subtract(this.getOffsetPosition(),this.getInitialOffsetPosition(),M.create())}dragByIncrementValue(e){const t=this.ray.point,i=this.viewer.getCamera();if(!i)return;const s=i.projectWorldPointToCanvas(t),n={mouseX:s[0],mouseY:s[1],camera:i};this.onDragStart(null,n,{requestDrag:!1});const r=(0,fr.vx)().getLengthUnits(),a=(0,Ir.Fv)(e,r),o=this.ray.evaluate(a),h=i.projectWorldPointToCanvas(o);n.mouseX=h[0],n.mouseY=h[1],this.onDrag(null,n),this.onDragStop(null,n)}updateGraphics(e){super.updateGraphics(e);const t=Math.acos(Math.min(Math.abs(M.dot(e.getForward(),this.ray.direction)),1)),i=this.isBeingManipulated()?1:(0,wi.CW)(this.fadeAngleEnd,this.fadeAngleStart,t);if(this.updateColor(i),!this.isHidden){const t=e.getPixelSizeAtWorldPoint(this.ray.evaluate(this.offset)),i=this.offset<0&&this.flipDirectionWhenNegative?-1:1,s=this.visualGapPx*t+this.offset,n=this.ray.evaluate(s),r=ge.S4.scale(ge.S4.normalize(this.ray.direction,M.create()),i*t),a=ge.S4.scale(ge.S4.normalize(ge.S4.cross(e.getForward(),r,M.create())),t),o=ge.S4.scale(ge.S4.normalize(ge.S4.cross(r,a,M.create())),t),h=ue.fromValues(a[0],a[1],a[2],0,o[0],o[1],o[2],0,r[0],r[1],r[2],0,n[0],n[1],n[2],1);if(this.hasEditView){const i=(0,fr.vx)().getLengthUnits(),s=this.getEditTranslation(),r=M.dot(this.initialRay.direction,s)<0?-1:1,o=ge.S4.length(s)*r,h=(0,Ir.KZ)(o,i);this.triggerEditValueChange({value:h,isLength:!0});const c=(0,ns.x_)(),l=this.shaftLengthPx*t*c,d=this.ray.evaluate(this.offset+l),u=e.projectWorldPointToCanvas(d),g=xr(e.projectWorldPointToCanvas(n),u);u[0]=g.x+u[0]/(0,ns.x_)(),u[1]=g.y+u[1]/(0,ns.x_)(),this.triggerEditOriginChange(u[0],u[1]),this.displacementGraphics||(this.displacementGraphics=new Br(this.viewer,this)),this.displacementGraphics.updateGraphics(e,a,o)}this.setTransform(h)}}removeDisplacementMeshIncrements(){this.displacementGraphics&&this.displacementGraphics.removeMeshIncrement(Or)}}function Fr(e,t,i,s,n,r){r=r||k.xKD.DEFAULT;const a=e.point,o=e.evaluate(t),h=ge.S4.cross(e.direction,n.getForward(),M.create());ge.S4.normalize(h);const c=ge.S4.add(ge.S4.scale(h,i,M.create()),o),l=ge.S4.add(ge.S4.scale(h,-i,M.create()),o),d=e.evaluate(t+s),u={};if(r!==k.xKD.SECONDARY)u.lines=(0,Yd.pf)([a,o,c,l,c,d,l,d]);else{const n=e.evaluate(t+.5*s),r=ge.S4.add(ge.S4.scale(h,i,M.create()),n),g=ge.S4.add(ge.S4.scale(h,-i,M.create()),n);u.lines=(0,Yd.pf)([a,o,c,l,c,n,l,n,r,g,r,d,g,d])}const g=ge.S4.add(ge.S4.scale(h,-i,M.create()),a),p=ge.S4.add(ge.S4.scale(h,-i,M.create()),d),m=ge.S4.add(ge.S4.scale(h,i,M.create()),a);return u.pickArea=(0,Yd.fQ)(g,p,m),u}function xr(e,t){let i=ge.S4.subtract(t,e,M.create());i=ge.S4.normalize(i,M.create());const s=Math.atan2(-i[1],i[0]),n={x:Cr.getNumber("MANIPULATOR_EDIT_VIEW_ORIGIN_X_OFFSET"),y:Cr.getNumber("MANIPULATOR_EDIT_VIEW_ORIGIN_Y_OFFSET")};return Math.abs(s)>=Math.PI/2&&(n.x=-(n.x+75)),s>=0&&(n.y=-(30+n.y)),n}class Br extends yi.u1{constructor(e,t){super(e),this.parent=t}updateGraphics(e,t,i){const s=Cr.getNumber("MANIPULATOR_LINEAR_START_LINE_LENGTH_PX"),n=e.getPixelSizeAtWorldPoint(this.parent.initialRay.point);let r=ge.S4.normalize(t,M.create());r=ge.S4.scale(r,n*s,M.create());const a=ge.S4.add(this.parent.initialRay.point,r,M.create());r=ge.S4.scale(r,-1);const o=ge.S4.add(this.parent.initialRay.point,r,M.create()),h=(0,Yd.pf)([this.parent.initialRay.point,this.parent.initialRay.evaluate(i),a,o]);(0,Yd.Ab)(Cr.getColor("MANIPULATOR_DISPLACEMENT_COLOR"),h),(0,Yd.VQ)(Cr.getNumber("MANIPULATOR_DISPLACEMENT_LINE_WIDTH"),h),this.updateMeshIncrement(Or,yi.ZJ,h,Rr)}}class Vr extends br{constructor(e,t){super(e,t),this.direction0=M.fromValues(1,0,0),this.direction1=M.fromValues(0,1,0),this.normal=M.fromValues(0,0,1),this.visualGapPx=0,this.sideLengthPx=0,this.dragOffset=Q.create(),this.origin=M.create(),this.offset=Q.create(),this.dragDelta=Q.create(),this.setFadeParameters(Cr.getNumber("MANIPULATOR_PLANAR_FADE_ANGLE_START"),Cr.getNumber("MANIPULATOR_PLANAR_FADE_ANGLE_END"))}updateGeometry(){this.meshIncrement=(0,Yd.pf)([M.fromValues(0,0,0),M.fromValues(1,0,0),M.fromValues(1,0,0),M.fromValues(1,1,0),M.fromValues(1,1,0),M.fromValues(0,1,0),M.fromValues(0,1,0),M.fromValues(0,0,0)]),this.pickIncrement=(0,Yd.fQ)(M.fromValues(0,0,0),M.fromValues(1,0,0),M.fromValues(0,1,0))}setVisualGap(e){this.visualGapPx=e}setSideLength(e){this.sideLengthPx=e}getOffsetFromEvent(e){const t=e.camera.getRay(e.mouseX,e.mouseY);return this.getOffsetFromRay(t)}getOffsetFromXrInputEvent(e){return this.getOffsetFromRay(e.modelSpaceRay)}getOffsetFromRay(e){const t=M.create(),i=y.fromValues(this.normal[0],this.normal[1],this.normal[2],-M.dot(this.normal,this.origin)),s=(0,wi.fE)(e,i);if(null===s)return null;const n=M.dot(ge.S4.subtract(s,this.origin,t),this.direction0),r=M.dot(ge.S4.subtract(s,this.origin,t),this.direction1);return Q.fromValues(n,r)}onDragStart(e,t,i){const s=this.getOffsetFromEvent(t);this.displayEditView&&((0,mr.m)().trigger(pr.C.CLOSE_MANIPULATOR_EDIT_VIEW),(0,dh.a)().setActiveManipulator(null)),s&&(this.dragOffset=ge.gv.subtract(s,this.offset,Q.create()),super.onDragStart(e,t,i))}onXrDragStart(e,t,i){const s=this.getOffsetFromXrInputEvent(t);this.displayEditView&&((0,mr.m)().trigger(pr.C.CLOSE_MANIPULATOR_EDIT_VIEW),(0,dh.a)().setActiveManipulator(null)),s&&(this.dragOffset=ge.gv.subtract(s,this.offset,Q.create()),super.onXrDragStart(e,t,i))}onDrag(e,t){if(this.isLocked)return;const i=this.getOffsetFromEvent(t),s=!t.shiftKey;this.handleDrag(i,s,t)}onXrDrag(e,t){if(this.isLocked)return;const i=this.getOffsetFromXrInputEvent(t);this.handleDrag(i,!1)}handleDrag(e,t,i){if(e){this.offset=ge.gv.subtract(e,this.dragOffset,Q.create());for(let e=0;e<this.offset.length;e++)t&&(this.offset[e]=this.getLinearSnapValue(i,this.offset[e],this.origin)),this.offset[e]=parseFloat(this.offset[e].toFixed(this.offsetRoundDecimals));this.trigger(Sr.Wb.VALUE_CHANGED,this.offset,i),this.viewer.requestDraw()}}updateDefinition(e,t,i,s){this.origin=e,this.direction0=t,this.direction1=i,(0,Er.areUnitVectorsParallel)(this.direction0,this.direction1)?Dr.warn("Trying to create a planar manipulator with two parallel directions"):this.normal=ge.S4.normalize(ge.S4.cross(this.direction0,this.direction1,M.create())),this.offset=s,(0,Xs.vm)()}getOffset(){return this.offset}evaluatePosition(e,t){return ge.S4.add(ge.S4.scale(this.direction0,e,M.create()),ge.S4.add(ge.S4.scale(this.direction1,t,M.create()),this.origin))}getOffsetPosition(){return this.evaluatePosition(this.offset[0],this.offset[1])}updateGraphics(e){super.updateGraphics(e);const t=Math.acos(Math.min(Math.abs(M.dot(e.getForward(),this.normal)),1)),i=this.isBeingManipulated()?1:1-(0,wi.CW)(this.fadeAngleStart,this.fadeAngleEnd,t);if(this.updateColor(i),!this.isHidden){const t=e.getPixelSizeAtWorldPoint(this.getOffsetPosition()),i=this.visualGapPx*t,s=this.sideLengthPx*t,n=this.evaluatePosition(this.offset[0]+i,this.offset[1]+i),r=ge.S4.scale(this.direction0,s,M.create()),a=ge.S4.scale(this.direction1,s,M.create()),o=this.normal,h=ue.fromValues(r[0],r[1],r[2],0,a[0],a[1],a[2],0,o[0],o[1],o[2],0,n[0],n[1],n[2],1);this.setTransform(h)}}}class Ur extends br{constructor(e,t){super(e,t),this.zeroAngleDirection=M.fromValues(1,0,0),this.upDirection=M.fromValues(0,1,0),this.angle=0,this.angleRelativeToInitialZeroDirection=0,this.angleRelativeToInitialZeroDirectionForEdit=0,this.isClockWiseRotation=!0,this.radius=0,this.radialOffsetPx=0,this.dragOffset=0,this.disableMinimumOffset=!1,this.axis=new wi.zH([0,0,0],[0,0,1]),this.initialZeroAngleDirection=this.zeroAngleDirection,this.initialUpDirection=this.upDirection,this.minAngle=-Math.PI,this.maxAngle=Math.PI,this.minDisplayAngle=-Math.PI,this.maxDisplayAngle=Math.PI,this.setFadeParameters(Cr.getNumber("MANIPULATOR_ANGULAR_FADE_ANGLE_START"),Cr.getNumber("MANIPULATOR_ANGULAR_FADE_ANGLE_END"))}updateGeometry(){this.meshIncrement=(0,Yd.y)(M.fromValues(0,0,0),1,M.fromValues(0,0,1),Cr.getNumber("MANIPULATOR_CIRCLE_SEGMENTS"));const e=Cr.getNumber("MANIPULATOR_ANGULAR_HANDLE_RADIUS_SCALE"),t=Math.abs(Math.atan(1/e)),i=Cr.getNumber("MANIPULATOR_ANGULAR_HANDLE_SUBTENSION_FACTOR"),s=Cr.getNumber("MANIPULATOR_ANGULAR_HANDLE_ARC_SEGMENTS"),n=(0,Yd.QV)(M.fromValues(-e,0,0),e,M.fromValues(0,0,1),M.fromValues(1,0,0),t,i*t,s);this.meshIncrement=this.meshIncrement.concatenate(n);const r=(0,Yd.QV)(M.fromValues(-e,0,0),e,M.fromValues(0,0,1),M.fromValues(1,0,0),-t,-i*t,s);this.meshIncrement=this.meshIncrement.concatenate(r);const a=6*e*t;this.pickIncrement=(0,Yd.fQ)(M.fromValues(-1,a/2,0),M.fromValues(-1,-a/2,0),M.fromValues(1,a/2,0))}setAngle(e){this.angle=e}setRadialOffset(e){this.radialOffsetPx=e}getPlaneDefinition(){return y.fromValues(this.axis.direction[0],this.axis.direction[1],this.axis.direction[2],-M.dot(this.axis.point,this.axis.direction))}getMousePlanePosition(e){const t=e.camera.getRay(e.mouseX,e.mouseY);return(0,wi.fE)(t,this.getPlaneDefinition())}getXrInputPlanePosition(e){return(0,wi.fE)(e.modelSpaceRay,this.getPlaneDefinition())}getAngleFromEvent(e,t,i,s,n,r,a){const o=this.getMousePlanePosition(e);return this.getAngleFromPlanePosition(o,t,i,s,n,r,a)}getAngleFromXrInputEvent(e,t,i,s,n,r,a){const o=this.getXrInputPlanePosition(e);return this.getAngleFromPlanePosition(o,t,i,s,n,r,a)}getAngleFromPlanePosition(e,t,i,s,n,r,a){if(!e)return null;const o=ge.S4.subtract(e,this.axis.point),h=M.dot(o,i),c=M.dot(o,s);if(h*h+c*c<Ri.W.ZERO_LENGTH*Ri.W.ZERO_LENGTH)return null;const l=Math.atan2(c,h)+t;return(0,wi.Kf)(l,n,r,a)}onDefaultUnitsChanged(){this.hasEditView&&this.createEditView()}createEditView(){const e=new k.wtM;e.parameterId="angle",e.units=(0,fr.vx)().getAngleUnits(),e.value=this.angle;const t=new k.ySX;t.minValue=Math.max(0,Gr(this.minDisplayAngle)),t.maxValue=Math.max(0,Gr(this.maxDisplayAngle)),t.units=e.units;const i={paramQuantity:e,quantityType:k.Uqp.ANGLE,range:t};(0,mr.m)().trigger(pr.C.CREATE_MANIPULATOR_EDIT_VIEW,this,i,this.viewer)}onDragStart(e,t,i){this.dragOffset=this.angle-this.getAngleFromEvent(t,0,this.zeroAngleDirection,this.upDirection,this.angle,this.minAngle,this.maxAngle),super.onDragStart(e,t,i),this.initializeEditView()}onXrDragStart(e,t,i){this.dragOffset=this.angle-this.getAngleFromXrInputEvent(t,0,this.zeroAngleDirection,this.upDirection,this.angle,this.minAngle,this.maxAngle),super.onXrDragStart(e,t,i),this.initializeEditView()}initializeEditView(){this.displayEditView&&!this.hasEditView&&(this.createEditView(),this.initialZeroAngleDirection=M.clone(this.zeroAngleDirection),this.initialUpDirection=M.clone(this.upDirection),this.trigger(Sr.Wb.CACHE_TRANSFORM),this.isClockWiseRotation=this.dragOffset>0,this.angleRelativeToInitialZeroDirectionForEdit=0,(0,dh.a)().setActiveManipulator(this))}onEditChange(e){const t=Math.abs(Hr(e.value));this.isClockWiseRotation?this.angleRelativeToInitialZeroDirectionForEdit=t:this.angleRelativeToInitialZeroDirectionForEdit=-t,this.trigger(Sr.Wb.VALUE_EDITED)}getSnapAngle(e,t){const i=e.camera,s=Cr.getNumberArray("MANIPULATOR_ANGULAR_SNAP_DIVISOR"),n=Cr.getNumber("MANIPULATOR_ANGULAR_SNAP_RESOLUTION_PX"),r=this.getMousePlanePosition(e);let a=0;if(r){const e=i.getUnitSizeAtWorldPoint(r)/(0,ns.x_)(),t=ge.S4.subtract(r,this.axis.point),o=ge.S4.length(t);for(;a<s.length;++a){if(o*(Math.PI/s[a])*e<=n)break}}const o=s[a]*t/Math.PI,h=Math.round(o),c=h-o;let l=Cr.getNumber("MANIPULATOR_ANGULAR_SNAP_ANGLE_DEVIATION");return l*=1+a/s.length,Math.abs(c)<=l&&(t=h*Math.PI/s[a]),t}onDrag(e,t){if(this.isLocked)return;const i=this.getAngleFromEvent(t,this.dragOffset,this.zeroAngleDirection,this.upDirection,this.angle,this.minAngle,this.maxAngle),s=this.hasEditView?this.getAngleFromEvent(t,this.dragOffset,this.initialZeroAngleDirection,this.initialUpDirection,this.angleRelativeToInitialZeroDirectionForEdit,this.minDisplayAngle,this.maxDisplayAngle):null,n=!t.shiftKey;this.handleDrag(i,s,n,t)}onXrDrag(e,t){if(this.isLocked)return;const i=this.getAngleFromXrInputEvent(t,this.dragOffset,this.zeroAngleDirection,this.upDirection,this.angle,this.minAngle,this.maxAngle),s=this.hasEditView?this.getAngleFromXrInputEvent(t,this.dragOffset,this.initialZeroAngleDirection,this.initialUpDirection,this.angleRelativeToInitialZeroDirectionForEdit,this.minDisplayAngle,this.maxDisplayAngle):null;this.handleDrag(i,s,!1)}handleDrag(e,t,i,s){if(null!==e){if(this.angle=parseFloat(e.toFixed(this.offsetRoundDecimals)),i&&(this.angle=this.getSnapAngle(s,this.angle)),this.angle=(0,wi.uZ)(this.angle,this.minAngle,this.maxAngle),this.hasEditView&&null!==t){this.isClockWiseRotation=t>0;let e=(0,wi.FE)(this.initialZeroAngleDirection,this.zeroAngleDirection,this.getAxis().direction)+this.angle;e<this.minDisplayAngle?e=(0,wi.Tu)(e,this.minDisplayAngle):e>this.maxDisplayAngle&&(e=(0,wi.Kb)(e,this.maxDisplayAngle)),this.angleRelativeToInitialZeroDirection=t,this.angleRelativeToInitialZeroDirectionForEdit=e}this.trigger(Sr.Wb.VALUE_CHANGED,this.angle,s),this.viewer.requestDraw()}}updateDefinition(e,t,i,s,n){let r;if(this.isBeingManipulated()&&(r=ge.S4.add(ge.S4.scale(this.zeroAngleDirection,Math.cos(this.angle),M.create()),ge.S4.scale(this.upDirection,Math.sin(this.angle),M.create()))),this.axis=new wi.zH(e,t),this.zeroAngleDirection=ge.S4.normalize(i,M.create()),this.radius=s,this.upDirection=ge.S4.cross(this.axis.direction,this.zeroAngleDirection,M.create()),ge.S4.normalize(this.upDirection),n||(n=0),this.isBeingManipulated()&&r){const e=M.dot(r,this.zeroAngleDirection),t=M.dot(r,this.upDirection);if(e*e+t*t<Ri.W.ZERO_LENGTH*Ri.W.ZERO_LENGTH)this.angle=n;else{const i=Math.atan2(t,e);this.angle=(0,wi.Kf)(i,this.angle,this.minAngle,this.maxAngle)}}else this.angle=n;(0,Xs.vm)()}updateLimits(e,t){this.minAngle=e,this.maxAngle=t}updateEditLimits(e,t){this.minDisplayAngle=e,this.maxDisplayAngle=t}setDisableMinimumOffset(e){this.disableMinimumOffset=e}getAngle(){return this.angle}getEditAngle(){return this.angleRelativeToInitialZeroDirectionForEdit}getEditAngleDisplacement(){let e=(0,wi.FE)(this.initialZeroAngleDirection,this.zeroAngleDirection,this.getAxis().direction);if(this.maxDisplayAngle-this.minDisplayAngle>2*Math.PI&&(0,Er.sign)(e)!==(0,Er.sign)(this.angleRelativeToInitialZeroDirection)){const t=2*Math.PI-Math.abs(e);e=(0,Er.sign)(this.angleRelativeToInitialZeroDirection)*t}let t=Math.abs(e)-Math.abs(this.angleRelativeToInitialZeroDirectionForEdit);return this.angleRelativeToInitialZeroDirection<0&&(t=-t),t}getAxis(){return this.axis}getZeroAngleDirection(){return this.zeroAngleDirection}getPosition(e,t){const i=Math.cos(e)*t,s=Math.sin(e)*t,n=M.create(),r=M.create();return ge.S4.add(ge.S4.scale(this.zeroAngleDirection,i,n),ge.S4.add(ge.S4.scale(this.upDirection,s,r),this.axis.point))}updateEditBoxPosition(e){const t=e.getPixelSizeAtWorldPoint(this.axis.point),i=(0,ns.x_)(),s=(Cr.getNumber("MANIPULATOR_ANGULAR_ARROW_SHAFT_LENGTH_PX")+Cr.getNumber("MANIPULATOR_ANGULAR_ARROW_RADIUS_PX")+Cr.getNumber("MANIPULATOR_ANGULAR_ARROW_LENGTH_PX")+2*Cr.getNumber("MANIPULATOR_ANGULAR_HANDLE_RADIUS")*i+2*Cr.getNumber("MANIPULATOR_ANGULAR_HANDLE_RADIUS")*i)*t,n=this.getPosition(0,s),r=e.projectWorldPointToCanvas(this.axis.point),a=e.projectWorldPointToCanvas(n),o=xr(r,a);a[0]=o.x+a[0]/(0,ns.x_)(),a[1]=o.y+a[1]/(0,ns.x_)(),this.triggerEditOriginChange(a[0],a[1])}updateGraphics(e){super.updateGraphics(e);const t=Math.acos(Math.abs(M.dot(e.getForward(),this.axis.direction))),i=this.isBeingManipulated()?1:1-(0,wi.CW)(this.fadeAngleStart,this.fadeAngleEnd,t);if(this.updateColor(i),!this.isHidden){const t=e.getPixelSizeAtWorldPoint(this.axis.point),i=this.axis.point,s=this.radius+t*this.radialOffsetPx,n=this.getPosition(this.angle,s),r=Cr.getNumber("MANIPULATOR_ANGULAR_HANDLE_RADIUS")*t,a=n,o=ge.S4.scale(ge.S4.normalize(ge.S4.subtract(n,i,M.create())),r),h=ge.S4.normalize(this.axis.direction,M.create()),c=ge.S4.cross(h,o,M.create()),l=ue.fromValues(o[0],o[1],o[2],0,c[0],c[1],c[2],0,h[0],h[1],h[2],0,a[0],a[1],a[2],1),d=(0,ns.x_)();if(ge.w$.scale(l,M.fromValues(d,d,d)),this.hasEditView){this.updateEditBoxPosition(e);let t=0;if(this.isDragging)t=this.angleRelativeToInitialZeroDirectionForEdit;else{let e=(0,wi.FE)(this.initialZeroAngleDirection,this.zeroAngleDirection,this.getAxis().direction);this.maxDisplayAngle-this.minDisplayAngle>2*Math.PI&&(e=Math.abs(this.angleRelativeToInitialZeroDirectionForEdit)>Ri.W.ZERO_ANGLE?function(e,t,i,s){let n=(0,wi.FE)(e,t,i);s?n<0&&(n=2*Math.PI+n):n>0&&(n=-1*(2*Math.PI-n));return n}(this.initialZeroAngleDirection,this.zeroAngleDirection,this.getAxis().direction,this.isClockWiseRotation):this.angleRelativeToInitialZeroDirectionForEdit),t=e}const i=Math.abs(Gr(t));this.triggerEditValueChange({value:i,isLength:!1});const s=1.5,n=Cr.getNumber("MANIPULATOR_ANGULAR_HANDLE_RADIUS_SCALE")-s,r=Cr.getNumber("MANIPULATOR_ANGULAR_HANDLE_SUBTENSION_FACTOR")*Math.abs(Math.atan(1/n)),a=2*Cr.getNumber("MANIPULATOR_CIRCLE_SEGMENTS"),o=t<0?r:-r,h=M.fromValues(-n,0,0);let c=(0,Yd.QV)(h,n,M.fromValues(0,0,1),M.fromValues(1,0,0),o,-t,a);const l=M.create(),d=M.fromValues(0,1,0),u=M.fromValues(1,0,0),g=n*Math.cos(-t),p=n*Math.sin(-t);ge.S4.add(h,ge.S4.add(ge.S4.scale(d,p,M.create()),ge.S4.scale(u,g,M.create()),l),l);const m=new wi.zH(h,ge.S4.subtract(h,l,M.create())),f=Cr.getNumber("MANIPULATOR_ANGULAR_START_LINE_LENGTH_FACTOR"),I=(0,Yd.pf)([m.evaluate(-n+f),m.evaluate(-n-f)]);c=c.concatenate(I),(0,Yd.Ab)(Cr.getColor("MANIPULATOR_DISPLACEMENT_COLOR"),c),(0,Yd.VQ)(Cr.getNumber("MANIPULATOR_DISPLACEMENT_LINE_WIDTH"),c),this.updateMeshIncrement(Or,yi.ZJ,c,Rr)}this.setTransform(l)}}dragByIncrementValue(e){const t=this.viewer.getCamera();if(!t)return;const i=t.getPixelSizeAtWorldPoint(this.axis.point),s=this.getClampedRadius(i,!0);let n=t.projectWorldPointToCanvas(this.getPosition(this.angle,s));const r={mouseX:n[0],mouseY:n[1],camera:t};this.onDragStart(null,r,{requestDrag:!1}),e=Hr(e),n=t.projectWorldPointToCanvas(this.getPosition(this.angle+e,s)),r.mouseX=n[0],r.mouseY=n[1],this.onDrag(null,r),this.onDragStop(null,r)}getClampedRadius(e,t){if(this.disableMinimumOffset)return this.radius;let i=this.radius;const s=Cr.getNumber("MANIPULATOR_ANGULAR_MINIMUM_RADIUS_PX")*e;return i<s&&(i=s),t&&(i+=e*this.radialOffsetPx),i}}function Hr(e){return e="degree"===(0,fr.vx)().getAngleUnits()?e*Math.PI/180:e}function Gr(e){return e="degree"===(0,fr.vx)().getAngleUnits()?180*e/Math.PI:e}class kr extends Ur{constructor(e){super(e)}updateGraphics(e){let t=Math.abs(M.dot(e.getForward(),this.axis.direction));t>1?t=1:t<-1&&(t=-1);const i=Math.acos(t),s=this.isBeingManipulated()?1:1-(0,wi.CW)(this.fadeAngleStart,this.fadeAngleEnd,i);if(s<=0)return void this.removeMeshIncrements();const n=e.getPixelSizeAtWorldPoint(this.axis.point),r=this.getClampedRadius(n,!0),a=this.getPosition(this.angle,r),o=Math.cos(this.angle),h=Math.sin(this.angle),c=ge.S4.add(ge.S4.scale(this.zeroAngleDirection,-h,M.create()),ge.S4.scale(this.upDirection,o,M.create()));this.angle<0&&ge.S4.negate(c);const l=Fr(new wi.zH(a,c),Cr.getNumber("MANIPULATOR_ANGULAR_ARROW_SHAFT_LENGTH_PX")*n,Cr.getNumber("MANIPULATOR_ANGULAR_ARROW_RADIUS_PX")*n,Cr.getNumber("MANIPULATOR_ANGULAR_ARROW_LENGTH_PX")*n,e,this.style);this.updateLines("linear",l.lines,s),this.updatePickArea(l.pickArea);const d=this.getClampedRadius(n,!1),u=d+Cr.getNumber("MANIPULATOR_ANGULAR_ARROW_LEADER_EXTENSION_PX")*n,g=this.getPosition(0,u),p=this.getPosition(this.angle,u),m=(0,Yd.pf)([this.axis.point,g,this.axis.point,p]);this.updateLines("leaders",m,.5*s);const f=Math.abs(this.angle)*d/n,I=(0,Yd.QV)(this.axis.point,d,this.axis.direction,this.zeroAngleDirection,0,this.angle,Math.floor(f/10));this.updateLines("arc",I,.5*s),!this.isHidden&&this.hasEditView&&this.updateEditBoxPosition(e)}}class Wr extends br{constructor(e,t){super(e,t),this.position=M.fromValues(0,0,0),this.dragPlane=y.fromValues(0,0,1,0),this.xrDragDistance=-1,this.lastMouseRay=new wi.zH([0,0,0],[1,0,0])}updateGeometry(){const e=Cr.getNumber("MANIPULATOR_CIRCLE_SEGMENTS");this.meshIncrement=(0,Yd.y)(M.fromValues(0,0,0),1,M.fromValues(0,0,1),e),this.pickIncrement=(0,Yd.$)(M.fromValues(0,0,0),1,M.fromValues(0,0,1),e)}onDragStart(e,t,i){if(!this.isEnabled)return;this.displayEditView&&((0,mr.m)().trigger(pr.C.CLOSE_MANIPULATOR_EDIT_VIEW),(0,dh.a)().setActiveManipulator(null));const s=t.camera.getForward();this.dragPlane=[s[0],s[1],s[2],M.dot(s,this.position)],super.onDragStart(e,t,i)}onXrDragStart(e,t,i){this.isEnabled&&(this.displayEditView&&((0,mr.m)().trigger(pr.C.CLOSE_MANIPULATOR_EDIT_VIEW),(0,dh.a)().setActiveManipulator(null)),this.xrDragDistance=t.modelSpaceRay.findPositionOfPoint(this.position),super.onXrDragStart(e,t,i))}onDrag(e,t){if(this.isLocked)return;this.lastMouseRay=t.camera.getRay(t.mouseX,t.mouseY);const i=(0,wi.fE)(this.lastMouseRay,this.dragPlane);this.handleDrag(i,t)}onXrDrag(e,t){if(this.isLocked)return;const i=t.modelSpaceRay.evaluate(this.xrDragDistance);this.handleDrag(i)}handleDrag(e,t){e&&(this.position=e,this.trigger(Sr.Wb.VALUE_CHANGED,this.position,t?.mouseX,t?.mouseY,t),this.viewer.requestDraw())}getLastMouseRay(){return this.lastMouseRay}updateDefinition(e){this.position=e,(0,Xs.vm)()}updateGraphics(e){if(super.updateGraphics(e),this.updateColor(),!this.isHidden){const t=e.getPixelSizeAtWorldPoint(this.position),i=Cr.getNumber("MANIPULATOR_FREE_DRAG_RADIUS_PX")*t,s=this.position,n=ge.S4.scale(e.getForward(),-1,M.create()),r=ge.S4.scale(e.getRight(),i,M.create()),a=ge.S4.scale(e.getUp(),i,M.create()),o=ue.fromValues(r[0],r[1],r[2],0,a[0],a[1],a[2],0,n[0],n[1],n[2],0,s[0],s[1],s[2],1);this.setTransform(o)}}}const zr=new Gi.hF({isVisible:!0,isPickable:!0,isShowThrough:!0,isDepthTested:!1,priority:Gi.DO.DEFAULT,primitiveType:Ai.MX.POINTS}),Xr=new Gi.hF(Object.assign({},zr,{priority:Gi.DO.HIGHEST})),Zr=new Gi.hF(Object.assign({},zr,{isPickable:!1}));class qr extends br{constructor(e,t,i){super(e),this.points=[],this.pointBoundsCenter=M.create(),this.minimimumPointDistance=-1,this.lastPixelSize=-1,this.pointSize=-1,this.hoveredPointIndex=qr.NO_SELECTED_INDEX,this.isMultiSelect=!1,this.isPointSelected=[],this.suppressedIndices=new Set,this.selectedIndicesServerState=new Set,this.boxSelectedIndices=new Set,this.isMultiSelect=t,this.isMultiSelect&&(this.listenTo(e.getEventDispatcher(),os.f4Y,this.onPicksBoxSelected),this.listenTo(e.getEventDispatcher(),os.KB0,this.onBoxSelectionFinished)),this.manipulatorChangesInFlightSubscription=i?.subscribe((e=>{this.manipulatorChangesInFlight=e})),this.viewer.enterEmptyBoxDeselectMode()}updateDefinition(e,t,i){this.selectedIndicesServerState=t,0===(this.manipulatorChangesInFlight??0)&&(this.isPointSelected=e.map(((e,t)=>this.selectedIndicesServerState.has(t)))),this.suppressedIndices=i??new Set,this.processPoints(e)}processPoints(e){this.points=e;const t=new wi.kB;t.addPointArray(e),t.isFinite()&&(this.pointBoundsCenter=t.center());let i=-1;this.minimimumPointDistance=-1;for(let t=0;t<e.length;++t)for(let s=t+1;s<e.length;++s){const n=M.squaredDistance(e[t],e[s]);n>Ri.W.ZERO_LENGTH_SQUARED&&(i<0||n<i)&&(i=n)}i>=0&&(this.minimimumPointDistance=Math.sqrt(i)),this.lastPixelSize=-1,this.pointSize=-1}updatePointGraphics(){if(this.isMultiSelect&&this.viewer.performingBoxSelection())return;if(this.removeMeshIncrements(),this.stopListening(this),this.stopListening(this.viewer.getEventDispatcher()),this.pointSize<=0)return;const e=Cr.getPointFont("MANIPULATOR_POINT_FONT");for(let t=0;t<this.points.length;++t){const i="point"+t,s=this.getSelectionIdForIndex(t),n=this.isMultiSelect?this.getPointColorMultiSelect(t):this.getPointColor(t),r=this.isMultiSelect&&this.suppressedIndices.has(t)?this.pointSize/1.5:this.pointSize,a=(0,Yd.Pu)(this.points[t],i,n,r,e);this.updateMeshIncrement(i,s,a,this.getPointNodeProperties(t)),this.listenTo(this,yi.zw.MOUSE_ENTER+s,this.onMouseEnter),this.listenTo(this,yi.zw.MOUSE_LEAVE+s,this.onMouseLeave),this.listenTo(this,yi.zw.CLICK+s,this.onClick)}this.isMultiSelect&&(this.listenTo(this.viewer.getEventDispatcher(),os.f4Y,this.onPicksBoxSelected),this.listenTo(this.viewer.getEventDispatcher(),os.KB0,this.onBoxSelectionFinished))}onViewWillDraw(e,t){if(this.isHidden)return;const i=e.getPixelSizeAtWorldPoint(this.pointBoundsCenter);if(i!==this.lastPixelSize){let e;this.lastPixelSize=i;const t=this.minimimumPointDistance/i,s=Cr.getNumber("MANIPULATOR_SMALL_POINT_DISTANCE_PX"),n=Cr.getNumber("MANIPULATOR_LARGE_POINT_DISTANCE_PX");if(t<=s)e=qr.SMALL_SIZE_CONSTANT;else if(t>=n)e=qr.LARGE_SIZE_CONSTANT;else{const i=(t-s)/(n-s);e=(0,wi.CD)(qr.SMALL_SIZE_CONSTANT,qr.LARGE_SIZE_CONSTANT,i)}this.pointSize!==e&&(this.pointSize=e,this.updatePointGraphics())}}onMouseEnter(e){this.isEnabled&&this.setHoveredPoint(this.getIndexForSelection(e))}onMouseLeave(e){if(!this.isEnabled)return;this.getIndexForSelection(e)===this.hoveredPointIndex&&this.setHoveredPoint(qr.NO_SELECTED_INDEX)}onClick(e){if(!this.isEnabled)return;const t=this.getIndexForSelection(e);!this.isMultiSelect&&this.isPointSelected[t]||this.setSelectedPoint(t)}onPicksBoxSelected(e){this.isEnabled&&this.queueManipulatorSelectionsFromPicks(e)}onBoxSelectionFinished(){this.setBoxSelectedPoints()}queueManipulatorSelectionsFromPicks(e){for(const t of e){const e=(0,j.as)(gI.D,t)?.uiSelection;e?.uiElement instanceof qr&&this.boxSelectedIndices.add(this.getIndexForSelection(e))}}getSelectionIdForIndex(e){return""+e}getIndexForSelection(e){return+e.selectionId}getPointColor(e){return this.isPointSelected[e]?Cr.getColor("MANIPULATOR_OUTLINE_DRAG_COLOR"):e===this.hoveredPointIndex?Cr.getColor("MANIPULATOR_OUTLINE_HOVER_COLOR"):Cr.getColor("MANIPULATOR_OUTLINE_COLOR")}getPointColorMultiSelect(e){return this.suppressedIndices.has(e)?Cr.getColor("MANIPULATOR_OUTLINE_DISABLED_COLOR"):e===this.hoveredPointIndex?Cr.getColor("MANIPULATOR_OUTLINE_HOVER_COLOR"):this.isPointSelected[e]?Cr.getColor("MANIPULATOR_OUTLINE_DRAG_COLOR"):Cr.getColor("MANIPULATOR_OUTLINE_COLOR")}getPointNodeProperties(e){return this.suppressedIndices.has(e)?Zr:this.isPointSelected[e]||e===this.hoveredPointIndex?Xr:zr}setHoveredPoint(e){this.hoveredPointIndex!==e&&(this.hoveredPointIndex=e,this.updatePointGraphics())}setSelectedPoint(e){this.isMultiSelect?this.isPointSelected[e]=!this.isPointSelected[e]:(this.isPointSelected[this.isPointSelected.findIndex((e=>e))]=!1,this.isPointSelected[e]=!0),this.trigger(Sr.Wb.VALUE_CHANGED,this.isPointSelected),this.updatePointGraphics()}setBoxSelectedPoints(){if(0===this.boxSelectedIndices.size)return;const e=!this.viewer.getInputHandler().getCtrlHeld();for(const t of this.boxSelectedIndices)this.isPointSelected[t]=e;this.boxSelectedIndices.clear(),this.trigger(Sr.Wb.VALUE_CHANGED,this.isPointSelected),this.updatePointGraphics()}remove(){super.remove(),this.manipulatorChangesInFlightSubscription?.unsubscribe(),this.viewer.leaveEmptyBoxDeselectMode()}}qr.NO_SELECTED_INDEX=-1,qr.SMALL_SIZE_CONSTANT=Cr.getNumber("MANIPULATOR_POINT_SMALL_SIZE"),qr.LARGE_SIZE_CONSTANT=Cr.getNumber("MANIPULATOR_POINT_LARGE_SIZE");class Yr extends br{constructor(e,t){super(e,t),this.scale=1,this.dragScale=1,this.minScale=1e-5,this.maxScale=1e3,this.ray=new wi.zH([0,0,0],[0,0,1]),this.gapLengthPx=Cr.getNumber("MANIPULATOR_LINEAR_SHAFT_LENGTH_PX")*Math.sqrt(2),Cr.getNumber("MANIPULATOR_LINEAR_HEAD_LENGTH_PX"),this.headLengthPx=Cr.getNumber("MANIPULATOR_LINEAR_HEAD_LENGTH_PX"),this.isDraggable=!t||!t.hasOwnProperty("isDraggable")||!!t.isDraggable,this.setFadeParameters(Cr.getNumber("MANIPULATOR_PLANAR_FADE_ANGLE_START"),Cr.getNumber("MANIPULATOR_PLANAR_FADE_ANGLE_END"))}updateGeometry(){this.meshIncrement=(0,Yd.AD)(M.fromValues(0,0,this.gapLengthPx),M.fromValues(0,0,1),M.fromValues(1,0,0),0,this.headLengthPx,this.headLengthPx/Math.sqrt(3)),this.pickIncrement=(0,Yd.fQ)(M.fromValues(-this.headLengthPx/2,0,this.gapLengthPx),M.fromValues(this.headLengthPx/2,0,this.gapLengthPx),M.fromValues(-this.headLengthPx/2,0,this.gapLengthPx+this.headLengthPx))}setGapLength(e){this.gapLengthPx=e}setHeadLength(e){this.headLengthPx=e}setIsDraggable(e){this.isDraggable=e}getPlaneDefinition(){return y.fromValues(this.normal[0],this.normal[1],this.normal[2],-M.dot(this.ray.point,this.normal))}getMousePlanePosition(e){const t=e.camera.getRay(e.mouseX,e.mouseY);return(0,wi.fE)(t,this.getPlaneDefinition())}getXrInputPlanePosition(e){return(0,wi.fE)(e.modelSpaceRay,this.getPlaneDefinition())}createEditView(){const e=new k.wtM;e.parameterId="scale",e.units="",e.value=this.scale;const t=new k.ySX;t.minValue=this.minScale,t.maxValue=this.maxScale,t.units="";const i={paramQuantity:e,quantityType:k.Uqp.REAL,range:t};(0,mr.m)().trigger(pr.C.CREATE_MANIPULATOR_EDIT_VIEW,this,i,this.viewer)}onDragStart(e,t,i){const s=this.getMousePlanePosition(t);s&&(this.initializeDrag(s),super.onDragStart(e,t,i))}onXrDragStart(e,t,i){const s=this.getXrInputPlanePosition(t);s&&(this.initializeDrag(s),super.onXrDragStart(e,t,i))}initializeDrag(e){if(!e)return;const t=ge.S4.subtract(e,this.ray.point,M.create());this.originToInitialLength=ge.S4.length(t),this.dragScale=this.scale,this.displayEditView&&!this.hasEditView&&(this.createEditView(),(0,dh.a)().setActiveManipulator(this))}onEditChange(e){this.scale=Math.max(0,e.value),this.trigger(Sr.Wb.VALUE_EDITED)}getScaleFromEvent(e){return this.getScaleFromPosition(this.getMousePlanePosition(e))}getScaleFromXrInputEvent(e){return this.getScaleFromPosition(this.getXrInputPlanePosition(e))}getScaleFromPosition(e){const t=ge.S4.subtract(e,this.ray.point,M.create());return ge.S4.length(t)/this.originToInitialLength}onDrag(e,t){!this.isLocked&&this.isDraggable&&this.handleDrag(this.getScaleFromEvent(t),t)}onXrDrag(e,t){!this.isLocked&&this.isDraggable&&this.handleDrag(this.getScaleFromXrInputEvent(t))}handleDrag(e,t){this.scale=this.dragScale*e,this.scale=parseFloat(this.scale.toFixed(this.offsetRoundDecimals)),this.trigger(Sr.Wb.VALUE_CHANGED,this.scale,t),this.viewer.requestDraw()}resetScale(){this.scale=1}updateDefinition(e,t,i){this.ray=new wi.zH(e,i),this.normal=t,(0,Xs.vm)()}getScale(){return this.scale}updateGraphics(e){super.updateGraphics(e);const t=Math.acos(Math.min(Math.abs(M.dot(e.getForward(),this.normal)),1)),i=this.isBeingManipulated()?1:1-(0,wi.CW)(this.fadeAngleStart,this.fadeAngleEnd,t);if(this.updateColor(i),!this.isHidden){const t=e.getPixelSizeAtWorldPoint(this.ray.point),i=this.isBeingDragged?this.scale/this.dragScale:1,s=this.ray.point,n=ge.S4.scale(ge.S4.normalize(this.ray.direction,M.create()),i*t),r=ge.S4.scale(ge.S4.normalize(ge.S4.cross(e.getForward(),n,M.create())),i*t),a=ge.S4.scale(ge.S4.normalize(ge.S4.cross(n,r,M.create())),i*t),o=ue.fromValues(r[0],r[1],r[2],0,a[0],a[1],a[2],0,n[0],n[1],n[2],0,s[0],s[1],s[2],1);if(this.hasEditView){this.triggerEditValueChangeNoUnit({value:this.scale});const i=(0,ns.x_)(),n=this.gapLengthPx*t*i,r=this.ray.evaluate(n),a=e.projectWorldPointToCanvas(r),o=xr(e.projectWorldPointToCanvas(s),a);a[0]=o.x+a[0]/(0,ns.x_)(),a[1]=a[1]/(0,ns.x_)(),this.triggerEditOriginChange(a[0],a[1])}this.setTransform(o)}}}var Kr=i(91299);class jr{constructor(){this.operandA=null,this.operandB=null}resetWithOperands(e,t){return this.operandA=e,this.operandB=t,this.operandB.setOperand(this.operandA),this}getRangeIteratorForBufferSet(e){return this.operandA&&this.operandB?this.operandB.getRangeIteratorForBufferSet(e):null}setOperand(e){this.operandA.setOperand(e)}makeSceneDebugObject(){const e={text:"ChainedOperator",children:[]};return(0,Xs.n9)(e,this.operandA),e}}const Qr=new jr;class $r{constructor(e,t){this.occurrenceId=e,this.isUIElement=!1,this.shouldSetOccurrenceUniform=!0,this.isolated=!1,this.canIsolateChange=!0,this.isHiddenFromPick=!1,this.cullingState=null,this.hiddenBaseMeshRanges=null,this.hiddenPreviewMeshRanges=null,this.hiddenFromPickBaseMeshRanges=null,this.hiddenFromPickPreviewMeshRanges=null,this.baseHighlights=null,this.previewHighlights=null,this.transform=ue.create(),this.lod=wS.DEFAULT,this.visibility=Xs.EE.VISIBLE,this.boundables=new Set,this.isClippedBySectionPlane=t}destroy(){this.hiddenBaseMeshRanges&&(this.hiddenBaseMeshRanges.destroy(),this.hiddenBaseMeshRanges=null),this.hiddenPreviewMeshRanges&&(this.hiddenPreviewMeshRanges.destroy(),this.hiddenPreviewMeshRanges=null),this.isHiddenFromPick=!1,this.hiddenFromPickBaseMeshRanges&&(this.hiddenFromPickBaseMeshRanges.destroy(),this.hiddenFromPickBaseMeshRanges=null),this.hiddenFromPickPreviewMeshRanges&&(this.hiddenFromPickPreviewMeshRanges.destroy(),this.hiddenFromPickPreviewMeshRanges=null),this.baseHighlights&&(this.baseHighlights.destroy(),this.baseHighlights=null),this.previewHighlights&&(this.previewHighlights.destroy(),this.previewHighlights=null),this.boundables.clear()}onPreviewDestroyed(){this.hiddenPreviewMeshRanges&&(this.hiddenPreviewMeshRanges.destroy(),this.hiddenPreviewMeshRanges=null),this.hiddenFromPickPreviewMeshRanges&&(this.hiddenFromPickPreviewMeshRanges.destroy(),this.hiddenFromPickPreviewMeshRanges=null),this.previewHighlights&&(this.previewHighlights.destroy(),this.previewHighlights=null)}getOccurrenceId(){return this.occurrenceId}setShouldSetOccurrenceUniform(e){this.shouldSetOccurrenceUniform=e}getShouldSetOccurrenceUniform(){return this.shouldSetOccurrenceUniform}setTransform(e){(0,wi.cl)(this.transform,e)||(this.transform=ue.clone(e),this.damageBoundables())}getTransform(){return this.transform}setIsolated(e){this.canIsolateChange&&(this.isolated=e)}getIsolated(){return this.isolated}setCanIsolateChange(e){this.canIsolateChange=e}setLod(e){this.lod=e}getLod(){return this.lod}setVisibility(e){e!==this.visibility&&(this.visibility=e,this.damageBoundables())}getVisibility(){return this.visibility}getCullingState(){return this.cullingState}get culledMeshGroupIdSet(){const e=this.cullingState;return e&&e.size?e:null}setCullingState(e,t){if(!t)return void(this.cullingState=e);let i=this.culledMeshGroupIdSet;e===Xs.uc.CULLED?(i||(i=new Set,this.cullingState=i),i.add(t)):i&&(i.delete(t),0===i.size&&(this.cullingState=Xs.uc.VISIBLE))}getMeshGroupCullingState(e){if(this.cullingState===Xs.uc.VISIBLE||this.cullingState===Xs.uc.CULLED)return this.cullingState;const t=this.culledMeshGroupIdSet;return t&&t.has(e)?Xs.uc.CULLED:Xs.uc.VISIBLE}isStyledRangeCulled(e,t){const i=e.getMeshRangesGroupId();return this.isMeshGroupCulled(i,t)}isMeshGroupCulled(e,t){return this.cullingState!==Xs.uc.VISIBLE&&t.getUsage()===ys.L.BASE&&(this.cullingState===Xs.uc.CULLED||!!e&&this.getMeshGroupCullingState(e)===Xs.uc.CULLED)}isVisible(e){return!(this.cullingState===Xs.uc.CULLED&&e.getUsage()===ys.L.BASE)&&((!e.isPicking()||!this.isHiddenFromPick)&&(e.isHighlighting()?this.hasHighlight():this.visibility===Xs.EE.VISIBLE))}isBoundable(){return this.visibility===Xs.EE.VISIBLE||this.hasHighlight()}isIncrementBoundable(e,t){const i=this.getHiddenRangesForUsage(t),s=this.getHighlightsForUsage(t),n=!!i&&i.containsIncrement(e),r=!!s&&s.entityHasHighlight(e);return!n||r}hasHighlight(){let e=!1;return this.baseHighlights&&(e=this.baseHighlights.hasHighlight()),this.previewHighlights&&(e=e||this.previewHighlights.hasHighlight()),e}getOrCreateHiddenRangesForUsage(e){return e===ys.L.BASE?(this.hiddenBaseMeshRanges||(this.hiddenBaseMeshRanges=new KT(this.occurrenceId+".hiddenBaseMeshRanges")),this.hiddenBaseMeshRanges):(this.hiddenPreviewMeshRanges||(this.hiddenPreviewMeshRanges=new KT(this.occurrenceId+".hiddenPreviewMeshRanges")),this.hiddenPreviewMeshRanges)}getHiddenRangesForUsage(e){return e===ys.L.BASE?this.hiddenBaseMeshRanges:this.hiddenPreviewMeshRanges}getOrCreateHiddenFromPickRangesForUsage(e){return e===ys.L.BASE?(this.hiddenFromPickBaseMeshRanges||(this.hiddenFromPickBaseMeshRanges=new KT(this.occurrenceId+".hiddenFromPickBaseMeshRanges")),this.hiddenFromPickBaseMeshRanges):(this.hiddenFromPickPreviewMeshRanges||(this.hiddenFromPickPreviewMeshRanges=new KT(this.occurrenceId+".hiddenFromPickPreviewMeshRanges")),this.hiddenFromPickPreviewMeshRanges)}getHiddenFromPickRangesForUsage(e){return e===ys.L.BASE?this.hiddenFromPickBaseMeshRanges:this.hiddenFromPickPreviewMeshRanges}hideIncrement(e,t){return!!this.getOrCreateHiddenRangesForUsage(t).onIncrementAdded(e)&&(this.damageBoundables(),!0)}showIncrement(e,t){const i=this.getHiddenRangesForUsage(t);return!(!i||!i.onIncrementRemoved(e))&&(this.damageBoundables(),!0)}isIncrementHidden(e,t){const i=this.getHiddenRangesForUsage(t);return!!i&&i.containsIncrement(e)}hideIncrementFromPick(e,t){this.getOrCreateHiddenFromPickRangesForUsage(t).onIncrementAdded(e)}isIncrementHiddenFromPick(e,t){const i=this.getHiddenFromPickRangesForUsage(t);return!!i&&i.containsIncrement(e)}resetHiddenFromPick(){this.isHiddenFromPick=!1,this.hiddenFromPickBaseMeshRanges&&(this.hiddenFromPickBaseMeshRanges.destroy(),this.hiddenFromPickBaseMeshRanges=null),this.hiddenFromPickPreviewMeshRanges&&(this.hiddenFromPickPreviewMeshRanges.destroy(),this.hiddenFromPickPreviewMeshRanges=null)}getOrCreateHighlightsForUsage(e){return e===ys.L.BASE?(this.baseHighlights||(this.baseHighlights=new fT),this.baseHighlights):(this.previewHighlights||(this.previewHighlights=new fT),this.previewHighlights)}getBaseOccurrenceHighlight(){return this.baseHighlights?this.baseHighlights.getHighestPriorityOccurrenceHighlight():null}getHighlightsForUsage(e){return e===ys.L.BASE?this.baseHighlights:this.previewHighlights}updateEntityHighlight(e,t,i,s){const n=this.hasHighlight();this.getOrCreateHighlightsForUsage(s).updateEntityHighlight(e,t,i),n!==this.hasHighlight()&&this.damageBoundables()}updateOccurrenceHighlight(e,t,i){const s=this.hasHighlight();this.getOrCreateHighlightsForUsage(i).updateOccurrenceHighlight(e,t),s!==this.hasHighlight()&&this.damageBoundables()}clearHighlight(e,t){const i=this.hasHighlight(),s=this.getHighlightsForUsage(t);s&&s.clearHighlight(e),i!==this.hasHighlight()&&this.damageBoundables()}clearAllOccurrenceLevelHighlights(){this.hasHighlight()&&(this.baseHighlights&&this.baseHighlights.clearAllOccurrenceLevelHighlights(),this.previewHighlights&&this.previewHighlights.clearAllOccurrenceLevelHighlights(),this.damageBoundables())}getEntityHighlights(e,t){const i=this.getHighlightsForUsage(t);return i?i.getEntityHighlights(e):null}removeEntityHighlights(e,t){const i=this.getHighlightsForUsage(t);i&&i.removeEntityHighlights(e)}getMeshRangeOperator(e){if(e.isHighlighting()){const t=this.getHighlightsForUsage(e.getUsage());return t?t.getHighlightOperator(e):CS}if(e.isPicking()){const t=this.getHiddenRangesForUsage(e.getUsage()),i=this.getHiddenFromPickRangesForUsage(e.getUsage());return i&&t?(Qr.resetWithOperands(t,i),Qr):t||i}{e.applyStyle(mT);const t=this.getHighlightsForUsage(e.getUsage()),i=this.getHiddenRangesForUsage(e.getUsage());return t?t.getHighlightStyleOperator(e,i):i}}addBoundable(e){this.boundables.add(e)}removeBoundable(e){this.boundables.delete(e)}damageBoundables(){for(const e of this.boundables.values())e.damageBounds()}makeSceneDebugObject(){const e="Occurrence "+this.occurrenceId,t=[];return t.push((0,Xs.z4)("transform",this.transform)),t.push((0,Xs.z4)("isolated",this.isolated)),t.push((0,Xs.z4)("isUIElement",this.isUIElement)),t.push((0,Xs.z4)("clippedBySectionPlane",this.isClippedBySectionPlane)),t.push((0,Xs.z4)("lod",this.lod)),t.push((0,Xs.z4)("visibility",(0,Xs._I)(this.visibility))),t.push((0,Xs.z4)("cullingState",this.cullingState instanceof Set?Array.from(this.cullingState).toString():(0,j.getKeyForValue)(Xs.uc,this.cullingState))),t.push((0,Xs.z4)("shouldSetOccurrenceUniform",this.shouldSetOccurrenceUniform)),this.hiddenBaseMeshRanges&&t.push(this.hiddenBaseMeshRanges.makeSceneDebugObject()),this.hiddenPreviewMeshRanges&&t.push(this.hiddenPreviewMeshRanges.makeSceneDebugObject()),this.hiddenFromPickBaseMeshRanges&&t.push(this.hiddenFromPickBaseMeshRanges.makeSceneDebugObject()),this.hiddenFromPickPreviewMeshRanges&&t.push(this.hiddenFromPickPreviewMeshRanges.makeSceneDebugObject()),this.baseHighlights&&t.push(this.baseHighlights.makeSceneDebugObject("baseHighlights")),this.previewHighlights&&t.push(this.previewHighlights.makeSceneDebugObject("previewHighlights")),{text:e,children:t}}getIsClippedBySectionPlanes(){return this.isClippedBySectionPlane}setIsClippedBySectionPlanes(e){this.isClippedBySectionPlane=e}}var Jr=i(66366),ea=i(87839),ta=i(97314),ia=i(91549),sa=i(22764);const na=_e.O.createLogger("detail",k.bVy.GRAPHICS),ra=!1;function aa(e){ra?na.info&&na.info(e):na.trace&&na.trace(e)}var oa;function ha(e,t,i,s){return e+"."+t+"."+i+"."+s}!function(e){e.NORMAL="NORMAL",e.FLATTENED="FLATTENED"}(oa||(oa={}));let ca=null;function la(){(0,pt.supportsIndexedDb)(window).then((e=>{e&&function(){try{let e=new ta.ZP("GraphicsDetailSettings");e.version(1).stores({settings:"[viewerUsage+workspaceOrVersionId+elementId+modelUsage], enableSSAOFilter, enableEdgeSilhouettes, enableSSAO, enableBackfaceSilhouettes, enableLowestLodSwitching, enableSectionPlaneEdgeDetection"}),e.version(2).stores({settings:"[viewerUsage+workspaceOrVersionId+elementId+modelUsage], enableSSAOFilter, enableEdgeSilhouettes, enableSSAO, enableBackfaceSilhouettes, enableLowestLodSwitching, enableSectionPlaneEdgeDetection, lowLevelBodyProportion"}).upgrade((function(e){e.settings.toCollection().modify((function(e){e.lowLevelBodyProportion=0}))})),e.version(3).stores({settings:"[viewerUsage+workspaceOrVersionId+elementId+modelUsage], enableSSAOFilter, enableEdgeSilhouettes, enableSSAO, enableBackfaceSilhouettes, enableSectionPlaneEdgeDetection, lowLevelBodyProportion"}).upgrade((function(e){e.settings.toCollection().modify((function(e){delete e.enableLowestLodSwitching}))})),e.open().then((function(){aa("Opened graphics detail database")})).catch((function(t){e=null,na.warn("Failed to open graphics detail database: "+t)})),ca=e}catch(e){ca=null,na.warn("Exception while creating settings database: "+e)}}()}))}la();const da=X.default.getManager().getNumber("MAX_LOW_LEVEL_BODY_PROPORTION"),ua=X.default.getManager().getNumber("LOW_LEVEL_BODY_PROPORTION_STEP");class ga{constructor(e,t,i,s){this.CLONING_PROPERTIES_TO_SKIP={viewerUsage:!0,workspaceOrVersionId:!0,elementId:!0,modelUsage:!0,enableSSAOFilter:!0},this.enableSSAOFilter=!1,this.enableEdgeSilhouettes=!0,this.enableSSAO=!0,this.enableBackfaceSilhouettes=!0,this.lowLevelBodyProportion=0,this.enableSectionPlaneEdgeDetection=!0,this.extentCullingThresholdPx=X.default.getManager().getNumber("DEFAULT_EXTENT_CULLING_THRESHOLD_IN_PIXELS"),this.viewerUsage=e||oa.NORMAL,this.workspaceOrVersionId=t||"",this.elementId=i||"",this.modelUsage=s||k.rvN.BASE}getKeyPath(){return[this.viewerUsage,this.workspaceOrVersionId,this.elementId,this.modelUsage]}getKeyString(){return ha(this.viewerUsage,this.workspaceOrVersionId,this.elementId,this.modelUsage)}persistSettings(){ca?(aa("Saving detail settings for "+this.getKeyString()),ca.settings.put(this).catch((function(e){aa("Save failed: "+e)}))):aa("Database not available for persisting settings "+this.getKeyString())}updateFromDatabase(e){const t=Jr.defer();return ca?ca.settings.get(this.getKeyPath()).then((t=>{t?(aa("Got saved details settings for "+this.getKeyString()+": "+JSON.stringify(t)),(0,j.overwriteMatchingProperties)(this,t)):(e?(aa("No saved details settings for "+this.getKeyString()+" - initializing from "+e.getKeyString()),(0,j.overwriteMatchingProperties)(this,e,this.CLONING_PROPERTIES_TO_SKIP)):aa("No saved details settings for "+this.getKeyString()+" - creating new settings"),this.persistSettings())})).catch((function(e){na.info("Failed to retrieve graphics detail settings: "+e)})).finally((function(){t.resolve()})):(aa("Settings database not available for updating settings"),t.resolve()),t.promise}decreaseDetail(){let e=!1;return this.enableEdgeSilhouettes||this.enableSectionPlaneEdgeDetection?(this.enableEdgeSilhouettes=!1,this.enableSectionPlaneEdgeDetection=!1,e=!0,aa("Decreasing graphics detail: dropped edge-based silhouettes and section plane edges")):this.enableSSAO?(this.enableSSAO=!1,e=!0,aa("Decreasing graphics detail: dropped ambient occlusion")):this.enableBackfaceSilhouettes?(this.enableBackfaceSilhouettes=!1,e=!0,aa("Decreasing graphics detail: dropped image-based silhouettes")):this.lowLevelBodyProportion<da&&(this.lowLevelBodyProportion=Math.min(this.lowLevelBodyProportion+ua,da),aa("Decreasing graphics detail: Increased lowest LOD proportion to: "+this.lowLevelBodyProportion),e=!0),e&&this.persistSettings(),e}increaseDetail(e,t){let i=!1;this.lowLevelBodyProportion>0?(this.lowLevelBodyProportion=Math.max(0,this.lowLevelBodyProportion-ua),aa("Increasing graphics detail: decreased lowest LOD proportion to: "+this.lowLevelBodyProportion),i=!0):!this.enableBackfaceSilhouettes&&t?(this.enableBackfaceSilhouettes=!0,i=!0,aa("Increasing graphics detail: adding image-based silhouettes")):!this.enableSSAO&&e?(this.enableSSAO=!0,i=!0,aa("Increasing graphics detail: enabled ambient occlusion")):!this.enableEdgeSilhouettes&&t?(this.enableEdgeSilhouettes=!0,i=!0,aa("Increasing graphics detail: enabled edge based silhouette edges")):this.enableSectionPlaneEdgeDetection||(this.enableSectionPlaneEdgeDetection=!0,i=!0,aa("Increasing graphics detail: enabled section plane edges")),i&&this.persistSettings()}}class pa{constructor(e,t,i){this.AnalyticsService=e,this.viewer=t,this.frameTimer=i,this.REDUCTION_THRESHOLD_MS=1e3/X.default.getManager().getNumber("DETAIL_REDUCTION_THRESHOLD_FPS"),this.ENHANCEMENT_THRESHOLD_MS=1e3/X.default.getManager().getNumber("DETAIL_ENHANCEMENT_THRESHOLD_FPS"),this.FULL_DETAIL_OCCURRENCE_REDUCTION_THRESHOLD=X.default.getManager().getNumber("FULL_DETAIL_OCCURRENCE_REDUCTION_THRESHOLD"),this.RENDER_PERFORMANCE_WARNING_TIMEOUT_SECONDS=X.default.getManager().getNumber("RENDER_PERFORMANCE_WARNING_TIMEOUT_SECONDS"),this.RENDER_PERFORMANCE_CLEAR_WARNING_TIMEOUT_SECONDS=X.default.getManager().getNumber("RENDER_PERFORMANCE_CLEAR_WARNING_TIMEOUT_SECONDS"),this.detailSettings={},this.activeInteractiveKey="",this.lastInteractiveTimingActedOn=-1,this.overrideSettings=null,this.disableInterativeUpdates=!1,this.renderingPerformanceMessageEnabled=!0,this.renderingPerformanceMessageTimeout=null,this.clearRenderingPerformanceMessageTimeout=null,this.clientVersion=null,this.viewerUsage=t.getIsForFlattenedDisplay()?oa.FLATTENED:oa.NORMAL,this.detailSettings[sa.Q.FULL]=new ga(this.viewerUsage),this.detailSettings[sa.Q.FULL].enableSSAOFilter=!0}onSettingStateChange(){const e=es.Jq.StateParameterService.workspaceId()||es.Jq.StateParameterService.versionId()||"",t=es.Jq.StateParameterService.elementId()||"",i=Gs(),s=ha(this.viewerUsage,e,t,i);s!==this.activeInteractiveKey&&(aa("Switching to detail settings for "+s),this.activeInteractiveKey=s,this.lastInteractiveTimingActedOn=-1)}ensureInteractiveSettingsExist(){if(this.detailSettings[this.activeInteractiveKey]){const e=Jr.defer();return e.resolve(),e.promise}{const e=es.Jq.StateParameterService.workspaceId()||es.Jq.StateParameterService.versionId()||"",t=es.Jq.StateParameterService.elementId()||"",i=Gs();aa("Initializing detail settings for "+this.activeInteractiveKey);const s=ha(this.viewerUsage,e,t,k.rvN.BASE),n=this.detailSettings[s]||this.detailSettings[sa.Q.FULL],r=new ga(this.viewerUsage,e,t,i);return r.extentCullingThresholdPx=X.default.getManager().getNumber("AGGRESSIVE_EXTENT_CULLING_THRESHOLD_IN_PIXELS"),this.detailSettings[this.activeInteractiveKey]=r,r.updateFromDatabase(n).then((()=>{r.enableSSAO&&!this.isInteractiveSsaoEnabled()&&(aa("Ambient occlusion disabled for interactive frames due to performance issues"),r.enableSSAO=!1),!r.enableBackfaceSilhouettes&&!r.enableEdgeSilhouettes||this.areInteractiveSilhouettesEnabled()||(aa("Silhouette Edges disabled for interactive frames due to performance issues"),r.enableBackfaceSilhouettes=!1,r.enableEdgeSilhouettes=!1)}))}}forceLowestDetailSettings(e){this.ensureInteractiveSettingsExist();const t=this.detailSettings[this.activeInteractiveKey];t.enableSSAOFilter=!1,t.enableEdgeSilhouettes=!1,t.enableSSAO=!1,t.enableBackfaceSilhouettes=!1,t.enableSectionPlaneEdgeDetection=!1,t.lowLevelBodyProportion=da,e&&t.persistSettings()}increaseDetail(){this.disableInterativeUpdates=!0,this.detailSettings[this.activeInteractiveKey].increaseDetail(this.isInteractiveSsaoEnabled(),this.areInteractiveSilhouettesEnabled())}decreaseDetail(){this.disableInterativeUpdates=!0,this.detailSettings[this.activeInteractiveKey].decreaseDetail()}getDetailSettings(){if(this.overrideSettings)return this.overrideSettings;let e=sa.Q.FULL;return this.frameTimer.userIsInteracting()?(this.updateInteractiveSettings(),e=this.activeInteractiveKey):this.frameTimer.userIsManipulating()&&(e=this.activeInteractiveKey),this.detailSettings[e]?this.detailSettings[e]:(na.warn("Could not find detail settings for key: "+e),this.detailSettings[sa.Q.FULL])}getInteractiveSettings(){return this.ensureInteractiveSettingsExist(),this.detailSettings[this.activeInteractiveKey]}updateInteractiveSettings(){if(this.disableInterativeUpdates)return;this.ensureInteractiveSettingsExist();const e=this.frameTimer.getDrawLoopDetails(sa.Q.INTERACTIVE),t=this.frameTimer.getTimingDetails(sa.Q.INTERACTIVE);if(this.lastInteractiveTimingActedOn<0)return void(this.lastInteractiveTimingActedOn=t.timingCount);const i=t.timingCount-this.lastInteractiveTimingActedOn;if(e.averageTime>this.REDUCTION_THRESHOLD_MS)this.detailSettings[this.activeInteractiveKey].decreaseDetail(),e.reset();else if(i>=2)if(t.averageTime>this.REDUCTION_THRESHOLD_MS){const e=this.detailSettings[this.activeInteractiveKey].decreaseDetail();this.lastInteractiveTimingActedOn=t.timingCount,e&&!$t(this.viewer.getGlContext())||this.startRenderingPerformanceMessageTimeout()}else t.averageTime<this.ENHANCEMENT_THRESHOLD_MS?(this.detailSettings[this.activeInteractiveKey].increaseDetail(this.isInteractiveSsaoEnabled(),this.areInteractiveSilhouettesEnabled()),this.lastInteractiveTimingActedOn=t.timingCount,this.startClearRenderingPerformanceMessageTimeout()):this.startClearRenderingPerformanceMessageTimeout()}isInteractiveFramerateBelowThreshold(){const e=this.frameTimer.getDrawLoopDetails(sa.Q.INTERACTIVE),t=this.frameTimer.getTimingDetails(sa.Q.INTERACTIVE);return e.timingCount>0&&e.averageTime>this.REDUCTION_THRESHOLD_MS||t.timingCount>0&&t.averageTime>this.REDUCTION_THRESHOLD_MS}isInteractiveSsaoEnabled(){if((0,pt.isPlatformMetaQuest)())return!1;const e=this.viewer.getRendererInfo();if(!e)return!0;const t=/Apple GPU/gi.test(e.glRenderer);return!((0,pt.isPlatformMac)()&&((0,pt.isAMDGpu)(e.glRenderer)||t&&(0,pt.isBrowserSafari)()))}areInteractiveSilhouettesEnabled(){return!(0,pt.isBrowserSafari)()||15!==(0,pt.getSafariVersion)()}setOverrideSettings(e){this.overrideSettings=e}updateFromLoadedScene(){const e=this.viewer.getModelViewManagers().getManager().getModelStatistics(!1),t=e.partOccurrences+e.surfaceOccurrences+e.curveOccurrences,i=this.detailSettings[sa.Q.FULL],s=!i.enableEdgeSilhouettes;t>=this.FULL_DETAIL_OCCURRENCE_REDUCTION_THRESHOLD?(s||aa("Reducing full detail rendering settings due to large occurrence count: "+t),i.enableEdgeSilhouettes=!1,i.enableSSAO=!1,i.enableBackfaceSilhouettes=!1,i.enableSectionPlaneEdgeDetection=!1,i.extentCullingThresholdPx=X.default.getManager().getNumber("AGGRESSIVE_EXTENT_CULLING_THRESHOLD_IN_PIXELS"),this.viewer.getSilhouetteTask().clearPendingRequests()):(s&&aa("Increasing full detail rendering settings due to smaller occurrence count: "+t),i.enableEdgeSilhouettes=!0,i.enableSSAO=!0,i.enableBackfaceSilhouettes=!0,i.enableSectionPlaneEdgeDetection=!0,i.extentCullingThresholdPx=X.default.getManager().getNumber("DEFAULT_EXTENT_CULLING_THRESHOLD_IN_PIXELS"))}areFullDetailEdgeSilhouettesEnabled(){return this.detailSettings[sa.Q.FULL].enableEdgeSilhouettes}getClientVersion(){if(!this.clientVersion){const e=es.Jq.ClientVersionService.getRunningVersion(),t=e.match(new RegExp("(\\d+\\.\\d+)","i"));t&&t.length>0?this.clientVersion=t[0]:this.clientVersion=e}return this.clientVersion}setRenderingPerformanceMessageEnabled(e){this.renderingPerformanceMessageEnabled=e}startRenderingPerformanceMessageTimeout(){if((0,ea.Z)(this.clearRenderingPerformanceMessageTimeout)&&(window.clearTimeout(this.clearRenderingPerformanceMessageTimeout),this.clearRenderingPerformanceMessageTimeout=null),!this.renderingPerformanceMessageEnabled||(0,ea.Z)(this.renderingPerformanceMessageTimeout)||this.viewer.hasPendingBodiesToLoad()||this.viewer.getIsForFlattenedDisplay())return;const e=""+(0,pt.getBrowserMajorVersion)(),t=this.getClientVersion();window.localStorage.getItem("osRenderPerformanceMessageBrowserVersion")===e&&window.localStorage.getItem("osRenderPerformanceMessageClientVersion")===t||(aa("Starting render performance message timeout"),this.renderingPerformanceMessageTimeout=window.setTimeout((()=>{window.localStorage.setItem("osRenderPerformanceMessageBrowserVersion",e),window.localStorage.setItem("osRenderPerformanceMessageClientVersion",t);const i=es.Jq.MessageBubbleService.createMessageBubble();i.showMessage(i18n("Reduced rendering performance detected."),void 0,i18n("Check system compatibility in a new tab")).then((()=>{this.AnalyticsService.trackEventForDocumentId("PERFORMANCE_MESSAGE","render_performance_action_click",(0,ia.n)());const e=location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")+"/check";window.open(e),i.dismissMessage()})),this.AnalyticsService.trackEventForDocumentId("PERFORMANCE_MESSAGE","render_performance_warning",(0,ia.n)()),this.renderingPerformanceMessageTimeout=null}),1e3*this.RENDER_PERFORMANCE_WARNING_TIMEOUT_SECONDS))}startClearRenderingPerformanceMessageTimeout(e){!e&&$t(this.viewer.getGlContext())||(0,ea.Z)(this.clearRenderingPerformanceMessageTimeout)||!(0,ea.Z)(this.renderingPerformanceMessageTimeout)||(aa("Starting clear render performance message timeout"),this.clearRenderingPerformanceMessageTimeout=window.setTimeout((()=>{(0,ea.Z)(this.renderingPerformanceMessageTimeout)&&(window.clearTimeout(this.renderingPerformanceMessageTimeout),this.renderingPerformanceMessageTimeout=null,aa("Cleared performance message timeout")),this.clearRenderingPerformanceMessageTimeout=null}),1e3*this.RENDER_PERFORMANCE_CLEAR_WARNING_TIMEOUT_SECONDS))}}var ma=i(36224),fa=i(88606);const Ia=_e.O.createLogger("thumbnailgenerator",k.bVy.GRAPHICS),Ea=window.document.createElement("canvas"),Sa=window.document.createElement("canvas"),Ta={},Da={};let Ca={};function Ma(e){Da[e]=!0}function ya(e){const t=(0,Xs.Wj)(),i=Ta[e];return i&&t-i[0]<X.default.getManager().getNumber("THUMBNAIL_LOCAL_EXPIRATION_INTERVAL")?i[1]:null}function Aa(e,t){const i=(0,Xs.Wj)();Ta[e]=[i,t]}function Pa(e){delete Ta[e]}function Oa(e){Ca[e]=!0}const Ra=new ga;function wa(e,t,i,s){return e+"-"+t+"-"+i+"x"+s}function va(e,t,i,s){return e+"-"+t+"-"+i+"x"+s}function _a(e,t,i,s){return e+"-"+t+"-"+i+"x"+s}function Na(e,t,i,s){Ea.width=e,Ea.height=t,Sa.width=e/s,Sa.height=t/s;const n=Ea.getContext("2d"),r=n.createImageData(e,t);r.data.set(i),n.putImageData(r,0,0);const a=Sa.getContext("2d");return a.translate(0,t/s),a.scale(1/s,-1/s),a.drawImage(Ea,0,0),Sa.toDataURL()}function ba(e){const t=e.getPrimaryViewController().getZoomFitTargetCamera(e.getCamera().getFrame(),e.getFitBounds());e.pushCameraState(t),e.getBodyManager().updateForFrame(e.getRenderContext()),e.renderContext.prepareForNextFrame(),e.depthSamplingPass.retrieve(e.getRenderContext(),{includePlanes:!0,performIsolationTest:!0}),e.popCameraState();const i=[];for(let s=0;s<e.depthSamplingPass.points.length;++s)i.push(t.canvasToWorld(e.depthSamplingPass.points[s]));return i}function La(e,t,i){if(!e.getCamera())return;const s=e.getModelViewManagers().getManager(),n=s.partStudios[s.getDisplayedFullElementId()];if(!n)return;fa.t.getController().pauseListeningForRedraw();const r=n.bodyComponent,a=n.sketchComponent,o=s.getDisplayedElementId(),h=ma.W.getSingleton().getComputedData(o),c=(0,Xs.Wj)(),l=X.default.getManager().getNumber("THUMBNAIL_PART_RENDER_LIMIT"),d=X.default.getManager().getNumber("THUMBNAIL_PART_RENDER_TIME_LIMIT");n.removeInContextAssemblies();const u=e.getGlContext();if(!u)return;const g=e.getOrCreateFrameBuffer(u.UNSIGNED_BYTE,"",{storageType:u.DEPTH_STENCIL,attachmentType:u.DEPTH_STENCIL_ATTACHMENT});e.setUserIsManipulatingWithTimeout(),e.detailManager.setOverrideSettings(Ra),e.getEventDispatcher().trigger(nM.gV);const p=e.getRenderingMode();e.setRenderingMode(k.P1.SHADED_WITH_EDGES),e.getIsolatedOccurrenceManager()?.clearAllIsolateNoAnimation();const m=e.getFilteredEntitiesHighlightController();let f=!1;m&&(f=m.getIsEnabled(),e.disableCurrentLaminarHighlightController());const I=e.getPrimaryViewController();I.isPerspective()&&e.setPrimaryViewController(I.getMatchingOrthographicController()),e.viewManipulator&&e.viewManipulator.hide();const E=e.getCamera().clone();let S=null;const T=(0,Xs.Z)();(0,Xs.uP)(!1);const D=n.getHideableFeatureIds(),C=[];for(const e in r.bodyMetaData){const t=r.retrieveBodyMetaData(e);t&&t.shouldProduceLocalThumbnail()&&C.push(e)}const A=[];for(const e in n.sketchComponent.sketchToSketchEntityMapping)Ca[e]&&A.push(e);const P=h?A.length:0,O=function(e,t,i,s){t&&t.forEach((t=>{const n=e.extractMeshIncrement(t);if(n){const e=M.create();for(let t=0;t<n.points.length;t+=3*i)e[0]=n.points[t],e[1]=n.points[t+1],e[2]=n.points[t+2],s(e)}return!1}))},R=wa(o,s.displayedElementMicroversionIdAndConfiguration.getKey(),t,i),w=!(R in Ta);let v=0;const _=!1;for(let e=0;e<C.length&&v<l;e++){va(o,C[e],t,i)in Da&&v++}if(w||v>0||P>0){r.getDecalComponent().removeFromScene();for(const e in n.sketchComponent.sketchToSketchEntityMapping)n.imageComponent.onSketchHidden(e);n.planeComponent.getHideableFeatureIds().forEach((function(e){n.planeComponent.hideShowFeature(e,Xs.EE.HIDDEN)}));const t=n.pointBodyComponent.featureToIds.firstKey();t&&n.pointBodyComponent.hideShowFeature(t,Xs.EE.HIDDEN),n.mateConnectorComponent.getHideableFeatureIds().forEach((function(e){n.mateConnectorComponent.hideShowFeature(e,Xs.EE.HIDDEN)})),e.getEdgePointController()&&(e.getEdgePointController().removeAllEdgePointUiElements((0,Me.vi)()),e.getEdgePointController().purgeEdgePointUiElements()),S=(0,lD.o_)(o),e.viewController.setStandardView("Trimetric")}const N=ba(e),b=y.fromValues(0,0,2*t,2*i),L=[1,1,2*t-2,2*i-2];e.setBaseFrameBuffer(g),e.renderContext.pushViewport(b),e.getCamera().setViewport(b),g.update(e.renderContext,b[2],b[3]);const F=g.width*g.height*4,x=new Uint8Array(F);if(g.bindBuffer(),w&&(e.getCamera().zoomToFit(N,1.05,L),e.draw(),u.readPixels(0,0,g.width,g.height,u.RGBA,u.UNSIGNED_BYTE,x),Aa(R,Na(g.width,g.height,x,2))),v>0||P>0){for(let e=0;e<D.length;e++)for(let t=0;t<n.components.length;++t)n.components[t].hasFeature(D[e])&&(D[e]in n.sketchComponent.sketchToSketchEntityMapping?n.hideSketch(D[e]):n.components[t].hideShowFeature(D[e],Xs.EE.HIDDEN));for(const e in r.partStudioBodyIdToOccurrenceId)r.setBodyCullingState(r.partStudioBodyIdToOccurrenceId[e],Xs.uc.CULLED,e,_);e.getBodyManager().setVisible(!1)}if(v>0){e.viewController.setStandardView("Trimetric");let s=0;for(let n=0;n<C.length&&s<l&&(0,Xs.Es)(c)<d;n++){const a=va(o,C[n],t,i);if(a in Da){const t=r.retrieveBodyMetaData(C[n]);let i=[];t.isOpenCompositeBody?i=r.getInstantiableConstituentIds(t):i.push(C[n]);let o=null;if(t.isComposite){o=[];for(let e=0;e<t.constituentBodyIds.length;++e){r.bodyToEntity.get(t.constituentBodyIds[e])&&(o=o.concat(r.bodyToEntity.get(t.constituentBodyIds[e]).getKeys()))}}else o=r.bodyToEntity.get(C[n]).getKeys();for(let e=0;e<i.length;++e)r.setBodyCullingState(r.partStudioBodyIdToOccurrenceId[i[e]],Xs.uc.VISIBLE,i[e],_),r.hideShowBody(i[e],Xs.EE.VISIBLE,r.partStudioBodyIdToOccurrenceId[i[e]]);const h=2,c=1;e.getCamera().zoomToFit(O.bind(void 0,r,o,h),c,L),e.draw(0,{skipUpdateBodyCulling:!0}),u.readPixels(0,0,g.width,g.height,u.RGBA,u.UNSIGNED_BYTE,x),Aa(a,Na(g.width,g.height,x,2));for(let e=0;e<i.length;++e)r.setBodyCullingState(r.partStudioBodyIdToOccurrenceId[i[e]],Xs.uc.CULLED,i[e],_);delete Da[a],s++}}}if(P>0)for(let s=0;s<A.length&&!((0,Xs.Es)(c)>=d);++s){const r=A[s],c=h.computedData[r];if(c&&c.planeMatrix){let s;const h=a.featureToIds.get(r);if(h&&(s=h.getKeys()),!s)continue;const l=_a(o,r,t,i);n.sketchComponent.hideShowFeature(r,Xs.EE.VISIBLE);const d=c.planeMatrix,p=[d.m00,d.m10,d.m20,0,d.m01,d.m11,d.m21,0,d.m02,d.m12,d.m22,0,0,0,0,1],m=e.getCamera().clone();m.setFrame(p),e.getCamera().copyFrom(m),e.getCamera().zoomToFit(O.bind(void 0,a,s,1),1.05,L),e.draw(0,{skipUpdateBodyCulling:!0}),u.readPixels(0,0,g.width,g.height,u.RGBA,u.UNSIGNED_BYTE,x),Aa(l,Na(g.width,g.height,x,2)),n.sketchComponent.hideShowFeature(r,Xs.EE.HIDDEN)}}e.setBaseFrameBufferToDefault(),g.unbindBuffer(),g.destroy(),e.renderContext.popViewport(),e.getCamera().copyFrom(E),e.viewManipulator&&e.viewManipulator.show(),e.detailManager.setOverrideSettings(null),e.setRenderingMode(p),e.setPrimaryViewController(I),e.getBodyManager().setVisible(!0),S&&(0,lD.Wh)(S,o),f&&(e.setFilteredEntitiesHighlightController(m),m.enable()),(0,Xs.uP)(T),fa.t.resumeListeningForRedraw();const B=(0,Xs.Wj)();Ca={},e.getEventDispatcher().trigger(nM.Xc),Ia.trace("thumbnailgenerator.generateThumbnail time "+(B-c))}Ra.enableSSAO=!1,Ra.enableEdgeSilhouettes=!1,Ra.enableBackfaceSilhouettes=!1;var Fa=i(1122);class xa extends yi.u1{constructor(e,t){super((0,j.as)(ND,t),e.sceneGraphId),this.texture=null,this.text="",this.offsetAdjustmentFunction=null,this.drawBox=!1,this.boxOffsetPixels=0,this.backgroundColor=[1,1,1,1],this.backgroundOpacity=0,this.updateOnEachFrame=!0,this.origin=e.origin,this.right=e.right,this.up=e.up,this.heightPx=e.heightPx,this.orientToScreen=!!e.orientToScreen,this.offsetUp=void 0!==e.offsetUp?e.offsetUp:wi.iK.MID,this.offsetRight=void 0!==e.offsetRight?e.offsetRight:wi.iK.MID,this.orientToScreen&&(this.right=[1,0,0],this.up=[0,0,1]);const i=X.default.getManager();this.color=e.color||i.getColor("DEFAULT_TEXT_COLOR"),this.font=e.font||i.getString("DEFAULT_TEXT_FONT"),this.material=Hi(),this.nodeProperties=new Gi.hF(Object.assign({},{isPickable:!1,isTwoSided:!0,primitiveType:Ai.MX.TRIANGLES,isShowThrough:!0,isDepthTested:!1,material:this.material},e.textNodePropertyOptions||{})),this.boxNodeProperties=new Gi.hF(Object.assign({},{isPickable:!1,primitiveType:Ai.MX.LINES},e.boxNodePropertyOptions||{}))}remove(){this.destroyText(),this.material&&(this.material.destroy(),this.material=null),super.remove()}destroyText(){this.texture&&(this.texture.destroy(),this.texture=null)}setOffsetAdjustmentFunction(e){const t=this.offsetAdjustmentFunction;return this.offsetAdjustmentFunction=e,t}setDrawBox(e,t,i,s){this.drawBox=e,t&&(this.boxOffsetPixels=t),i&&(this.backgroundColor=i),s&&(this.backgroundOpacity=s),e||this.removeMeshIncrement("box")}setHeightPx(e){this.setHeightAndColor(e)}setText(e){this.text!==e&&(this.destroyText(),this.text=e,this.texture=jo(this.viewer,e,{color:this.color,font:this.font,size:this.heightPx}),this.material.ambientTexture=this.texture,(0,Xs.vm)())}setHeightAndColor(e,t){let i=!1;t&&this.color!==t&&(this.color=t,i=!0),e&&this.heightPx!==e&&(this.heightPx=e,i=!0),i&&this.text&&(this.destroyText(),this.drawBox?this.texture=jo(this.viewer,this.text,{color:this.color,font:this.font,size:this.heightPx,paddingWithinBorder:this.boxOffsetPixels,backgroundColor:this.backgroundColor,backgroundOpacity:this.backgroundOpacity}):this.texture=jo(this.viewer,this.text,{color:this.color,font:this.font,size:this.heightPx}),this.material.ambientTexture=this.texture,(0,Xs.vm)())}onViewWillDraw(e){if(!this.texture)return;if(!this.updateOnEachFrame&&this.hasMeshIncrements())return;const t=this.getTextCorners(e);if(this.updateMeshIncrement("text",yi.ZJ,this.createScreenSpaceQuad(e,t.lowerLeft,t.lowerRight,t.upperLeft),this.nodeProperties),this.orientToScreen){const t=M.clone(e.getUp()),i=M.create();M.normalize(i,M.cross(i,e.getForward(),t));const s=M.create();M.normalize(s,M.cross(s,t,i));const n=ue.fromValues(i[0],i[1],i[2],0,s[0],s[1],s[2],0,t[0],t[1],t[2],0,this.origin[0],this.origin[1],this.origin[2],1);this.setTransform(n)}if(this.drawBox){const e=ge.S4.scale(ge.S4.subtract(t.lowerRight,t.lowerLeft,M.create()),.5),i=ge.S4.scale(ge.S4.subtract(t.upperLeft,t.lowerLeft,M.create()),.5),s=ge.S4.scale(ge.S4.add(t.lowerRight,t.upperLeft,M.create()),.5);this.updateMeshIncrement("box",yi.ZJ,(0,Yd.PU)(s,e,i,this.color,1),this.boxNodeProperties)}}getTextCorners(e){const t=this.origin;this.transform&&ge.w$.multiplyVec3(this.transform,this.origin,M.create());const i=e.getPixelSizeAtWorldPoint(t);let s=this.origin;this.orientToScreen&&(s=this.getOffsetOrigin(i));let n=new os.vjd;return n.pixelSize=i,n.lowerLeft=M.clone(s),n.lowerRight=ge.S4.add(ge.S4.scale(this.right,i*this.texture.filledWidthPx,M.create()),s),n.upperLeft=ge.S4.add(ge.S4.scale(this.up,i*this.texture.filledHeightPx,M.create()),s),this.offsetAdjustmentFunction&&(n=this.offsetAdjustmentFunction(n)),n}getOffsetOrigin(e){return[-this.offsetRight*e*this.texture.filledWidthPx,0,-this.offsetUp*e*this.texture.filledHeightPx]}createScreenSpaceQuad(e,t,i,s){const n=this.orientToScreen?[!1,!1]:zo(e,this.right,this.up,this.transform);return(0,Yd.fQ)(t,i,s,void 0,[n[0]?this.texture.rightCoordinate:this.texture.leftCoordinate,n[1]?this.texture.topCoordinate:this.texture.bottomCoordinate],[n[0]?this.texture.leftCoordinate:this.texture.rightCoordinate,n[1]?this.texture.bottomCoordinate:this.texture.topCoordinate])}}class Ba extends yi.u1{constructor(e,t,i){super(e,uh.EG),this.text=t,this.options=i,this.texture=null,this.material=Hi(),this.nodeProperties=new Gi.hF({isPickable:!0,primitiveType:Ai.MX.TRIANGLES,material:this.material}),this.updateWithOptions(i)}hasEqualTextAndOptions(e,t){return this.text===e&&(0,Qs.Z)(this.options,t)}remove(){super.remove(),this.texture?.destroy(),this.material.destroy()}updateWithOptions(e){this.texture=jo(this.viewer,this.text,e),this.material.ambientTexture=this.texture;const t=this.texture.createTexturedQuad();this.bounds=t.getBounds(),this.options=e,this.updateMeshIncrement("text",Ba.SELECTION_ID,t,this.nodeProperties),this.updatePosition()}getDiagonalVector(e){return this.bounds.diagonalVector(e)}positionRelativeTo(e,t,i){this.anchorPoint=M.clone(e),this.textAttachmentSpotX=t,this.textAttachmentSpotY=i,this.updatePosition()}updatePosition(){if(this.anchorPoint){const e=wi.iK.LOW,t=this.bounds.getLocationInBox(this.textAttachmentSpotX,this.textAttachmentSpotY,e);this.setTransform(ge.w$.translate(ue.create(),ge.S4.subtract(this.anchorPoint,t,t)))}}getTextCenterInCanvas(){const e=this.bounds.createTransformedCopy(this.transform).center(),t=this.viewer.getCamera(),i=(0,ns.x_)();return[e[0]/i,(t.getCanvasHeight()-e[1])/i]}getTransformedBounds(){return this.bounds.createTransformedCopy(this.transform)}}Ba.SELECTION_ID="text";var Va=i(70272),Ua=i(57702);const Ha=_e.O.createLogger("spaceball",k.bVy.GRAPHICS);let Ga=!1;class ka{constructor(){this.rayAperture=0,this.hitSelectionOnly=!1,this.mouseCreated=!1,this.mouseIsInMotion=!1,this.hitTestRay=new wi.zH([0,0,0],[0,0,0]),this.connexion=new _3Dconnexion(this),this.connexion.connect()||Ha.trace("Failed to initialize connection to 3Dconnexion NL-Proxy")}logMatrix(e,t){const i=function(t){return e[t].toFixed(2)};console.group(t),console.log(i(0)+" "+i(1)+" "+i(2)+" "+i(3)),console.log(i(4)+" "+i(5)+" "+i(6)+" "+i(7)),console.log(i(8)+" "+i(9)+" "+i(10)+" "+i(11)),console.log(i(12)+" "+i(13)+" "+i(14)+" "+i(15)),console.groupEnd()}logVector(e,t){console.group(t),console.log(e[0].toFixed(2)+" "+e[1].toFixed(2)+" "+e[2].toFixed(2)),console.groupEnd()}logNumber(e,t){console.group(t),console.log(e),console.groupEnd()}onConnect(){this.connexion.create3dmouse(window,"Onshape"),Ga=!0}onDisconnect(e){Ha.trace("3Dconnexion NL-Proxy disconnected: "+e)}getViewer(){return(0,Sh.N9)()}getViewController(){const e=this.getViewer();return e?e.getPrimaryViewController():null}getCamera(){const e=this.getViewer();return e?e.getCamera():null}checkState(e){return!!(this.getViewer()&&this.getViewController()&&this.getCamera())||(Ha.trace("Attempted to call spaceball."+e+" with no active document."),!1)}onViewerDraw(e,t){this.checkState("onViewerDraw")&&this.mouseCreated&&this.mouseIsInMotion&&e===this.getViewer()&&this.connexion.update3dcontroller({frame:{time:t}})}getViewMatrix(){return this.checkState("getViewMatrix")?this.getCamera().getFrame():null}getConstructionPlane(){if(!this.checkState("getConstructionPlane"))return null;const e=this.getViewer().getSketch();let t=null;return e&&(t=(0,wi.sc)(e.getPlaneMatrix()),t=Array.prototype.slice.call(t)),t}getViewExtents(){return this.checkState("getViewExtents")?this.getCamera().isOrthographic()?this.getCamera().getExtents():(Ha.info("Tried to get view extents for a non-orthographic camera."),null):null}getFov(){return this.checkState("getFov")?this.getCamera().isOrthographic()?(Ha.info("Tried to get fov for an orthographic camera"),0):(0,wi.Yr)(this.getCamera().getFieldOfView()):0}getViewFrustum(){return this.checkState("getViewFrustum")?this.getCamera().isOrthographic()?(Ha.info("Tried to get frustum for an orthographic camera"),null):this.getCamera().getFrustum():null}getPerspective(){return!!this.checkState("getPerspective")&&this.getCamera().isPerspective()}getViewTarget(){if(!this.checkState("getViewTarget"))return null;const e=this.getCamera().getViewport();return this.getCamera().getRay(e[2]/2,e[3]/2).point}getModelExtents(){if(!this.checkState("getModelExtents"))return null;const e=this.getCamera().getSceneBounds();return e?[e.min[0],e.min[1],e.min[2],e.max[0],e.max[1],e.max[2]]:[-1,-1,-1,1,1,1]}getPivotPosition(){if(!this.checkState("getPivotPosition"))return null;const e=this.getViewController();return e.updateRotationPanCenterForSpaceball(),e.getRotateOrPanCenter()}getLookAt(){if(!this.checkState("getLookAt"))return null;const e=this.getViewer(),t=this.getCamera(),i=this.hitTestRay.evaluate(1),s=t.projectWorldPointToCanvas(i);s[2]=0;const n=t.canvasToWorld(s),r=this.rayAperture/2*t.getUnitSizeAtWorldPoint(n),a=t.getViewport(),o=a[2]*a[3]/X.default.getManager().getNumber("DEPTH_SAMPLES_PER_VIEWPORT"),h=Math.sqrt(o/2),c=(r+h)*(r+h);let l;l=this.hitSelectionOnly?e.retrieveHighlightsOnlyDepthSampling():e.retrieveDepthSampling();let d=null;const u=Q.create();for(let e=0;e<l.length;e++){Q.copy(u,[s[0]-l[e][0],s[1]-l[e][1]]);Q.squaredLength(u)<c&&(!d||l[e][2]<d[2])&&(d=l[e])}return d?t.canvasToWorld(d):null}getSelectionEmpty(){return!this.checkState("getSelectionEmpty")||0===(0,Va.vi)().size()}getSelectionExtents(){if(!this.checkState("getSelectionExtents"))return null;const e=new wi.kB;(0,Va.vi)().each((t=>{e.addBox(this.getViewer().getSelectionFitBounds(t))}));const t=e.getMin(),i=e.getMax();return[t[0],t[1],t[2],i[0],i[1],i[2]]}getPointerPosition(){if(!this.checkState)return null;const e=this.getViewController().getPointerPosition();return this.getCamera().getRay(e[0],e[1]).point}getCoordinateSystem(){return[1,0,0,0,0,0,-1,0,0,1,0,0,0,0,0,1]}getFrontView(){return[1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1]}setViewMatrix(e){if(!this.checkState("setViewMatrix"))return;const t=this.getViewer();this.getCamera().setFrame(e),t.setUserIsAdjustingCamera(),t.getEventDispatcher().trigger(nM.h0)}setViewExtents(e){this.checkState("setViewExtents")&&(this.getCamera().isOrthographic()?this.getCamera().setExtents(e):Ha.info("Tried to get view extents for a non-orthographic camera."))}setFov(e){this.checkState("setFov")&&this.getCamera().setFieldOfView((0,wi.Ux)(e))}setPivotPosition(e){this.checkState("setPivotPosition")&&this.getViewController().setRotationPivotPosition(e)}setPivotVisible(e){this.checkState("setPivotVisible")}setLookFrom(e){this.hitTestRay.setPoint(e)}setLookDirection(e){this.hitTestRay.setDirection(e)}setLookAperture(e){this.rayAperture=e}setSelectionOnly(e){this.hitSelectionOnly=e}setTransaction(e){this.checkState("setTransaction")&&0===e&&this.getViewer().requestDraw()}onStartMotion(){this.checkState("onStartMotion")&&(this.mouseIsInMotion=!0,this.getViewer().setSuppressMouseMovePick(!0),(0,Va.IQ)(),this.getViewController().setIsSpaceballMoving(!0),this.getViewer().requestDraw())}onStopMotion(){this.checkState("onStopMotion")&&(this.mouseIsInMotion=!1,this.getViewController().setIsSpaceballMoving(!1),this.getViewer().setSuppressMouseMovePick(!1),this.getViewer().doPreHighlightPick())}setActiveCommand(e){e&&(0,nM.xA)().trigger(nM.RV,e)}on3dmouseCreated(){Ga&&(es.Jq.SpaceballService.initializeSpacemouseCommands(),this.connexion.update3dcontroller({frame:{timingSource:1}}),this.mouseCreated=!0)}update3dcontroller(e){Ga&&this.mouseCreated&&this.connexion.update3dcontroller(e)}}let Wa=null,za=null;function Xa(){Ua("iframe").attr("tabindex","-1"),Wa||za||(Wa=new ka,za=new is(Wa),za.startListeningToEvents())}function Za(){za&&za.stopListeningToEvents()}function qa(){return Ga}function Ya(e,t){Wa&&Wa.onViewerDraw(e,t)}var Ka=i(36222),ja=i(36650),Qa=i(53545);class $a{constructor(e,t){this.entityId=e,this.isSubEntity=!1,this.start=null,this.end=null,this.type="unknown",this.subEntities=[],this.mid=null,this.radius=void 0,this.minorRadius=void 0,this.center=null,this.xAxis=null,this.point=null,this.useCenterPointForArcRadius=void 0,this.splineCPData=null,this.splineKnotData=null,this.lowParameter=void 0,this.highParameter=void 0,this.closedSpline=void 0,this.rationalSpline=void 0,this.splineDegree=0,this.offset=0,this.sourceId=void 0,this.bottomLeftCorner=null,this.bottomRightCorner=null,this.topLeftCorner=null,this.rho=0,this.controlPoint=null,this.hasSplineHandlesInSketch=!1,t&&this.update(t)}update(e){const t=this;if(e instanceof k.tCU)this.point=e.getPoint(0),this.type="point";else if(e instanceof k.r9S)this.start=e.getPoint(0),this.end=e.getPoint(1),this.type="line";else if(e instanceof k.Eg0)this.start=e.getPoint(0),this.mid=e.getPoint(1),this.end=e.getPoint(2),this.center=e.getPoint(3),this.type="arc";else if(e instanceof k.YEZ){const t=e;this.center=t.getPoint(0),this.radius=t.radius,this.type="circle"}else if(e instanceof k.piN){const t=e;this.type="spline",this.closedSpline=t.closed,this.rationalSpline=t.rational,this.splineDegree=t.degree,this.hasSplineHandlesInSketch=e.hasHandlesInSketch;const i=t.controlPointCount,s=i+t.degree+1,n=3*i;if(this.splineCPData=t.points.slice(0,n),this.splineKnotData=t.points.slice(n,n+s),this.offset=t.points[n+s],t.segment){const e=n+s+1;this.start=[t.points[e],t.points[e+1]],this.lowParameter=t.points[e+2],this.end=[t.points[e+3],t.points[e+4]],this.highParameter=t.points[e+5]}else this.lowParameter=this.splineKnotData[this.splineDegree],this.highParameter=this.splineKnotData[this.splineKnotData.length-this.splineDegree-1]}else if(e instanceof k.Mbd||e instanceof k.HmT){const i=e instanceof k.Mbd;if(i)this.type="text";else{this.type="image";const t=e;this.sourceId=t.sourceId,this.bottomLeftCorner=t.bottomLeftCorner.getVec3(),this.bottomRightCorner=t.bottomRightCorner.getVec3(),this.topLeftCorner=t.topLeftCorner.getVec3()}let s=0;if(t.subEntities.length===e.entities.length)for(s=0;s<t.subEntities.length;s++)t.subEntities[s].update(e.entities[s]);else{t.subEntities=[];const n=i?k.whn.ID_PREFIX:k.a_n.ID_PREFIX;e.entities.forEach((function(e){const i=new $a(t.entityId+n+"."+s);i.isSubEntity=!0,i.update(e),t.subEntities.push(i),s++}))}}else if(e instanceof k.Nz9){const t=e;this.type="ellipse",this.center=t.getPoint(0),this.xAxis=t.getPoint(1),this.radius=t.radius,this.minorRadius=t.minorRadius,this.offset=t.offset}else if(e instanceof k.HlM){const t=e;this.type="ellipticalArc",this.center=t.getPoint(0),this.xAxis=t.getPoint(1),this.radius=t.radius,this.minorRadius=t.minorRadius,this.lowParameter=t.startParam,this.highParameter=t.endParam,this.offset=t.offset}else if(e instanceof k.Ddh){const t=e;this.type="conic",this.start=t.getPoint(0),this.controlPoint=t.getPoint(1),this.end=t.getPoint(2),this.lowParameter=t.points[6],this.highParameter=t.points[7],this.offset=t.offset,this.rho=t.rho}}}function Ja(e){let t=null;const i=[e.center];if(e.radius>Ri.W.ZERO_LENGTH){t=new Array(Ri.W.NUMBER_OF_POINTS_IN_FULL_CIRCLE);const i=2*Math.PI/(Ri.W.NUMBER_OF_POINTS_IN_FULL_CIRCLE-1);let s=0;const n=e.radius;for(let r=0;r<Ri.W.NUMBER_OF_POINTS_IN_FULL_CIRCLE;++r){s=i*r;const a=Math.cos(s),o=Math.sin(s);t[r]=[e.center[0]+a*n,e.center[1]+o*n]}}return{linePoints:t,points:i}}function eo(e,t,i){i<t&&(i+=2*Math.PI);let s=null;const n=[e.center],r=e.xAxis,a=[-e.xAxis[1],e.xAxis[0]],o=e.offset;if(e.radius>Ri.W.ZERO_LENGTH&&e.minorRadius>Ri.W.ZERO_LENGTH){s=[];let n=Math.max((i-t)/(2*Math.PI)*Ri.W.NUMBER_OF_POINTS_IN_FULL_CIRCLE,2);n=Math.floor(n);const h=(i-t)/(n-1);let c=0;const l=e.radius,d=e.minorRadius;for(let i=0;i<n;++i){c=h*i+t;const n=Math.cos(c),u=Math.sin(c);let g=r[0]*l*n+a[0]*d*u,p=r[1]*l*n+a[1]*d*u;if(0!==o){const e=r[0]*d*n+a[0]*l*u,t=r[1]*d*n+a[1]*l*u,i=Math.sqrt(e*e+t*t);g+=o*e/i,p+=o*t/i}s[i]=[e.center[0]+g,e.center[1]+p]}}return{linePoints:s,points:n}}const to=function(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])},io=function(e,t,i){const s=Math.cos(i),n=Math.sin(i);return[e[0]+s*t,e[1]+n*t]};function so(e,t,i,s){const n=.01*Math.PI,r=2+Math.floor(Math.abs(s-i)/n),a=(s-i)/(r-1),o=new Array(r);for(let s=0;s<r;++s)o[s]=io(e,t,i),i+=a;return o}function no(e,t,i,s,n){if((0,Ka.are2dPointsEqual)(e,i))return null;let r=s;if(n){const s=[0,0],n=[0,0],a=[0,0],o=[0,0];if(!(0,wi.eB)(e,t,s,n)||!(0,wi.eB)(t,i,a,o))return null;const h=[0,0];if(!(0,wi.TE)(s,n,a,o,h))return null;r=h}let a=to(r,e),o=to(r,i);const h=to(r,t);let c=0;a>o&&(c=a,a=o,o=c),(h<a||h>o)&&(c=a,a=o,o=c+2*Math.PI);const l=e[0]-r[0],d=e[1]-r[1];return{linePoints:so(r,Math.sqrt(l*l+d*d),a,o),points:[e,i,r]}}function ro(e){const t=new $a(e.entityId);let i=1;return Math.abs(1-e.rho)>Ri.W.ZERO_LENGTH?(i=e.rho/(1-e.rho),t.splineKnotData=[0,0,0,1,1,1],t.splineCPData=[e.start[0],e.start[1],1,e.controlPoint[0],e.controlPoint[1],i,e.end[0],e.end[1],1]):(t.splineKnotData=[0,0,0,.5,1,1,1],t.splineCPData=[e.start[0],e.start[1],1,e.controlPoint[0],e.controlPoint[1],i,e.controlPoint[0],e.controlPoint[1],i,e.end[0],e.end[1],1]),t.rationalSpline=!0,t.closedSpline=!1,t.offset=e.offset,t.splineDegree=2,t.lowParameter=e.lowParameter,t.highParameter=e.highParameter,ao(t)}function ao(e){let t=[];const i=[];if(e.splineCPData&&e.splineCPData.length>0&&e.splineDegree&&e.splineKnotData){const s=[];let n;for(n=0;n<e.splineCPData.length;n+=3)s.push([e.splineCPData[n]*e.splineCPData[n+2],e.splineCPData[n+1]*e.splineCPData[n+2],e.splineCPData[n+2]]);const r=new ja.Bspline(e.splineDegree,e.splineKnotData,s,M,!!e.closedSpline),a=e.splineCPData.length*Ri.W.NUMBER_OF_POINTS_PER_BSPLINE_CPOINT,o=Math.min(e.lowParameter,e.highParameter),h=Math.abs(e.highParameter-e.lowParameter)/a;let c,l;for(n=0;n<=a;n++)c=o+n*h,l=r.evaluate(c),t.push([l[0]/l[2],l[1]/l[2]]);if(e.offset&&Math.abs(e.offset)>Ri.W.ZERO_LENGTH){const i=[];let s=Q.create(),o=Q.create(),h=!1;if(e.closedSpline){const t=r.domain();h=Math.abs(Math.abs(e.highParameter-e.lowParameter)-t[1]+t[0])<Ri.W.ZERO_LENGTH}for(n=0;n<=a;++n)s=0===n?ge.gv.subtract(t[1],t[0],s):n===a?h?ge.gv.subtract(t[1],t[0],s):ge.gv.subtract(t[a],t[a-1],s):ge.gv.subtract(t[n+1],t[n-1],s),ge.gv.normalize(s),o=ge.gv.scale([s[1],-s[0]],e.offset,o),i.push(ge.gv.add(t[n],o,Q.create()));t=i}e.start&&i.push(e.start),e.end&&i.push(e.end)}return{linePoints:t,points:i}}function oo(e){switch(e.type){case"line":const t=[e.start,e.end];return{linePoints:t,points:t};case"point":return{linePoints:null,points:[e.point]};case"circle":return Ja(e);case"arc":return no(e.start,e.mid,e.end,e.center,!e.useCenterPointForArcRadius);case"spline":return ao(e);case"ellipse":return eo(e,0,2*Math.PI);case"ellipticalArc":if(void 0!==e.lowParameter&&void 0!==e.highParameter)return eo(e,e.lowParameter,e.highParameter);break;case"conic":return ro(e)}return console.warn("Failed to create polyline for unsupported entity type: "+e.type),{linePoints:null,points:null}}function ho(e,t,i,s){let n=!1,r=!1,a=!1,o=!1;t&&((i||"point"===e.type)&&(n=t.isConstruction),r=t.forPreview,t.isFromSplineHandle&&(a=t.isFromSplineHandle),t.isFromSplineControlPolygon&&(o=t.isFromSplineControlPolygon));const h=t?t.status:k.ea7.UNKNOWN;return(0,Qa.$V)(i,n,a,o,h,s,r)}function co(e,t){const i=e.getSketch(),s=[],n=[];let r,a=0;if(t.linePoints){const e=t.linePoints.length;let o=0;t.linePoints.forEach((function(t){r=i.planeToWorld(t),s.push(r[0],r[1],r[2]),n.push(a),o>0&&o<e-1&&n.push(a),o++,a++}))}return s.length>0?new eT(Ai.MX.LINES,s,n):null}function lo(e,t,i,s,n,r){const a=e.getSketch();if(!a)return;if(!t)return void i.removeEntity(n);let o=null;const h=[],c=[];let l=0;t.points&&t.points.forEach((function(e){o=a.planeToWorld(e),h.push(o[0],o[1],o[2]),c.push(l),l++}));const d=co(e,t);d?i.updateTemporaryEntity(n,d,ho(s,r,!0,n)):h.length>0&&i.updateTemporaryEntity(n,new eT(Ai.MX.POINTS,h,c),ho(s,r,!1,n))}const uo=_e.O.createLogger("Texture",k.bVy.GRAPHICS),go=new mt.StringSet;function po(){return!go.isEmpty()}class mo{constructor(e){this.bytes=null,this.floats=null,this.width=-1,this.height=-1,this.useMipmaps=!1,this.maxAnisotropy=-1,this.canvas=null,this.imageSource="",this.defersRendering=!1,this.internalFormat=e.RGBA,this.format=this.internalFormat,this.minificationFilter=e.NEAREST,this.magnificationFilter=e.NEAREST,this.wrapS=e.CLAMP_TO_EDGE,this.wrapT=e.CLAMP_TO_EDGE}isImage(){return!!this.imageSource}}let fo=0;class Io extends m.T{constructor(e,t,i){super(),this.viewer=e,this.GAUGE_MEMORY_TYPE="Texture",this.creationFunction=null,this.textureDefinition=null,this.waitingForTextureData=!1,this.texture=null,this.textureSize=0,this.textureNeedsUpdate=!1,this.hasTransparency=!0,this.performedImageLoadRetry=!1,(0,Sh.Yk)(e),"function"==typeof t?this.creationFunction=t:this.textureDefinition=t,this.updateFunction=i,this.id=fo.toString(),++fo,this.textureDefinition&&this.textureDefinition.isImage()&&this.createTexture(),this.listenTo(this.viewer.getEventDispatcher(),nM.so,this.onGlContextLostOrDestroyed),this.listenTo(this.viewer.getEventDispatcher(),nM.cW,this.onGlContextLostOrDestroyed)}destroy(){this.stopListening(),this.texture&&(this.viewer.getGlContext()?.deleteTexture(this.texture),this.viewer.getMemoryGauge().decrementMemoryUsage(this.GAUGE_MEMORY_TYPE,this.textureSize)),this.texture=null}setTextureNeedsUpdate(e){this.textureNeedsUpdate=e}createTexture(){if(this.texture)return;const e=this.textureDefinition?this.textureDefinition:this.creationFunction(this.viewer.getGlContext());if(!e)return;const t=this.viewer.getGlContext();if(this.texture=t.createTexture(),this.textureNeedsUpdate=!1,e.isImage())this.loadTextureFromImage(e);else{const i="createTexture temporary";Eo(this.viewer,this.texture,i)>=0&&(e.bytes?(t.texImage2D(t.TEXTURE_2D,0,e.internalFormat,e.width,e.height,0,e.format,t.UNSIGNED_BYTE,e.bytes),this.setTextureSize(e.width,e.height,e.internalFormat,t.UNSIGNED_BYTE)):e.floats?this.viewer.areFloatTexturesSupported()?(t.texImage2D(t.TEXTURE_2D,0,e.internalFormat,e.width,e.height,0,e.format,t.FLOAT,e.floats),this.setTextureSize(e.width,e.height,e.internalFormat,t.FLOAT)):uo.warn(cM+"An attempt was made to make a float texture without float texture support"):e.canvas?(t.texImage2D(t.TEXTURE_2D,0,e.internalFormat,e.format,t.UNSIGNED_BYTE,e.canvas),this.setTextureSize(e.canvas.width,e.canvas.height,e.internalFormat,t.UNSIGNED_BYTE)):uo.warn(cM+"An attempt was made to create a texture without valid input"),this.finishTextureSpecification(e),this.viewer.releaseTextureUnit(i))}}get imageSourceUri(){return this.textureDefinition?this.textureDefinition.imageSource:null}setTextureSize(e,t,i,s){this.textureSize=To(e,t,i,s),this.viewer.getMemoryGauge().incrementMemoryUsage(this.GAUGE_MEMORY_TYPE,this.textureSize)}loadTextureFromImage(e){const t=new Image;this.waitingForTextureData=!0,e.defersRendering&&go.add(this.id),t.onload=()=>{const i=this.viewer.getGlContext();if(!i||!this.texture)return;this.waitingForTextureData=!1;Eo(this.viewer,this.texture,"loadTextureFromImage")>=0&&(i.texImage2D(i.TEXTURE_2D,0,e.internalFormat,e.format,i.UNSIGNED_BYTE,t),this.setTextureSize(t.width,t.height,e.internalFormat,i.UNSIGNED_BYTE),this.finishTextureSpecification(e),this.viewer.releaseTextureUnit("loadTextureFromImage")),go.remove(this.id),(0,Xs.vm)()},t.onerror=()=>{if(go.remove(this.id),this.performedImageLoadRetry)uo.warn("Could not load texture image: "+e.imageSource);else{uo.info("Initial attempt to load texture image failed: "+e.imageSource),this.performedImageLoadRetry=!0;setTimeout((()=>{this.loadTextureFromImage(e)}),1e4)}(0,Xs.vm)()};setTimeout((()=>{go.contains(this.id)&&(go.remove(this.id),(0,Xs.vm)())}),2e3),t.src=e.imageSource}finishTextureSpecification(e){const t=this.viewer.getGlContext(),i=this.viewer.getAnisotropicExtension();i&&e.maxAnisotropy>0&&t.texParameterf(t.TEXTURE_2D,i.TEXTURE_MAX_ANISOTROPY_EXT,e.maxAnisotropy),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,e.magnificationFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,e.minificationFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,e.wrapS),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,e.wrapT),e.useMipmaps&&t.generateMipmap(t.TEXTURE_2D)}updateAndBindTexture(e){if((0,Sh.Yk)(this.viewer),this.texture||this.createTexture(),this.waitingForTextureData)return-1;const t=this.viewer.getGlContext(),i=Eo(this.viewer,this.texture,e);return i>=0&&this.textureNeedsUpdate&&this.updateFunction&&(t.activeTexture(t.TEXTURE0+i),this.updateFunction(),this.textureNeedsUpdate=!1),i}setHasTransparency(e){this.hasTransparency=e}getHasTransparency(){return this.hasTransparency}onGlContextLostOrDestroyed(){this.texture=null}}function Eo(e,t,i){(0,Sh.Yk)(e);const s=e.getOrAllocateTextureUnit(i);return s>=0&&e.bindTextureToUnit(t,s),s}function So(e,t){(0,Sh.Yk)(e);const i=e.getTextureUnit(t);i>=0&&(e.bindTextureToUnit(null,i),e.releaseTextureUnit(t))}function To(e,t,i,s){return e*t*qt(i)*kt(s)}function Do(e,t,i,s){(0,Sh.Yk)(e);const n=e.getGlContext(),r=n.createTexture(),a="createRGBATexture temporary",o=e.getOrAllocateTextureUnit(a);if(o<0)return null;try{e.bindTextureToUnit(r,o),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,t,i,0,n.RGBA,s,null),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),e.bindTextureToUnit(null,o),e.releaseTextureUnit(a)}catch(e){throw uo.warn("BEL-56217 - exception while creating texture with width "+t+", height: "+i+", precision: "+s+", exception: "+e),e}return r}var Co=i(57702);const Mo=_e.O.createLogger("textutilities",k.bVy.GRAPHICS);class yo{constructor(e,t,i,s,n){this.canvas=e,this.filledWidthPx=t,this.filledHeightPx=i,this.leftPixel=s,this.topPixel=n}}class Ao extends Io{constructor(e,t){super(e,(e=>this.textureCreationFunction(e))),this.canvasCreationFunction=t,this.width=-1,this.height=-1,this.filledWidthPx=-1,this.filledHeightPx=-1,this.leftCoordinate=-1,this.rightCoordinate=-1,this.bottomCoordinate=-1,this.topCoordinate=-1;this.createTexture()}createTexturedQuad(){return(0,Yd.fQ)([0,0,0],[this.filledWidthPx,0,0],[0,this.filledHeightPx,0],"textQuad",[this.leftCoordinate,this.bottomCoordinate],[this.rightCoordinate,this.topCoordinate])}textureCreationFunction(e){const t=this.canvasCreationFunction(e);this.width=t.canvas.width,this.height=t.canvas.height,this.filledWidthPx=t.filledWidthPx,this.filledHeightPx=t.filledHeightPx,this.leftCoordinate=t.leftPixel/t.canvas.width,this.rightCoordinate=this.leftCoordinate+t.filledWidthPx/t.canvas.width,this.topCoordinate=t.topPixel/t.canvas.height,this.bottomCoordinate=this.topCoordinate+t.filledHeightPx/t.canvas.height;const i=new mo(e);return i.canvas=t.canvas,i.magnificationFilter=e.LINEAR,i.minificationFilter=e.LINEAR_MIPMAP_LINEAR,i.maxAnisotropy=4,i.wrapS=e.CLAMP_TO_EDGE,i.wrapT=e.CLAMP_TO_EDGE,i.useMipmaps=!0,i}}const Po={font:"Arial",heightPx:10,weight:"",color:"#000000"};function Oo(e,t){const i=document.createElement("canvas");return i.width=(0,wi.cP)(e),i.height=(0,wi.cP)(t),i}let Ro=null;function wo(){if(!Ro){const e=Oo(128,128);Ro=e.getContext("2d",{willReadFrequently:!0})}return Ro}function vo({weight:e,heightPx:t,font:i}){return(e?e+" ":"")+t+"px "+i}async function _o(...e){const t=e.map((e=>vo(function({font:e,size:t,fontWeight:i}){return{font:e,heightPx:t,weight:i}}(e)))).map((async e=>{document.fonts.check(e)||await document.fonts.load(e)}));return Promise.all(t).then((()=>{}))}function No(e,t){t=Object.assign({},Po,t),e.font=vo(t),e.textAlign="left",e.fillStyle=t.color,e.globalAlpha=1,e.textBaseline="alphabetic"}const bo=1;function Lo(e,t){const i=e.getContext("2d",{willReadFrequently:!0}),s=i.getImageData(0,0,e.width,e.height),n=[t[0],t[1],t[2],bo],r=s.data.length/4;for(let e=0;e<r;++e)for(let t=0;t<4;++t)s.data[4*e+t]=n[t];return i.putImageData(s,0,0),n}function Fo(e,t){const i=wo();No(i,t);let s=0;for(let t=0;t<e.length;++t)s=Math.max(s,i.measureText(e[t]).width);return s}const xo="A";function Bo(e){const t=wo();No(t,e);const i=t.measureText(xo);return Math.ceil(i.actualBoundingBoxAscent)}function Vo(e,t){return Oo(e,t)}function Uo(e,t,i,s,n,r,a,o){const h=e.getContext("2d",{willReadFrequently:!0});Lo(e,n),o=(o||0)+1,h.fillStyle="rgba("+n[0]+","+n[1]+","+n[2]+","+r+")",Go(h,t,i,s,a,o),h.fill()}function Ho(e,t,i,s,n,r,a,o,h,c){const l=e.getContext("2d",{willReadFrequently:!0});c||Lo(e,n),l.strokeStyle="rgba("+n[0]+","+n[1]+","+n[2]+", 1.0)",l.setLineDash([o,h]),l.lineWidth=a;Go(l,t,i,s,r+a/2,a/2+1),l.stroke()}function Go(e,t,i,s,n,r){const a=r,o=r;t-=2*r,i-=2*r,e.beginPath(),e.moveTo(a+n,o+s),e.arcTo(a+t,o+s,a+t,o+s+i,n),e.arcTo(a+t,o+s+i,a,o+s+i,n),e.arcTo(a,o+s+i,a,o+s,n),e.arcTo(a,o+s,a+t,o+s,n),e.closePath()}function ko(e){return e.split("\n")}function Wo(e,t,i,s,n){const r=i.getContext("2d",{willReadFrequently:!0});No(r,t);const a=ko(e),o=Bo(t);for(let e=0;e<a.length;++e)r.fillText(a[e],s,n+t.heightPx*e+o);i.filledWithText=e}function zo(e,t,i,s){s&&(s=ge.w$.toMat3(s),t=ge.xB.multiply(s,t,M.create()),i=ge.xB.multiply(s,i,M.create()));const n=e.getRight(),r=e.getForward(),a=e.up,o=M.dot(t,n);let h=!1;o<=-Ri.W.ZERO_LENGTH?h=!0:o<=Ri.W.ZERO_LENGTH&&(h=M.dot(t,a)<=Ri.W.ZERO_LENGTH);const c=h?ge.S4.scale(t,-1,M.create()):t,l=ge.S4.cross(c,r,M.create());return[h,M.dot(i,l)<=-Ri.W.ZERO_LENGTH]}let Xo=null;function Zo(e){Xo||(Xo=Co('<div style="z-index:999999;margin:5px;position:fixed;left:0;bottom:0"></div>').appendTo("body")),Co(e).css({background:"yellow",margin:"0 5px"}),Co(e).appendTo(Xo)}function qo(e,t,i,s,n,r){const a=Lo(e,i);return Wo(t,s,e,n,n+r),(0,pt.isBrowserFirefox)()?function(e,t){const i=new wi.tO,s=e.getContext("2d",{willReadFrequently:!0}),n=e.width,r=e.height,a=s.getImageData(0,0,n,r).data;for(let e=0;e<r;++e)for(let s=0;s<n;++s)if(Ko(a,t,n,r,s,e)){const o=Ko(a,t,n,r,s-1,e)||Ko(a,t,n,r,s+1,e),h=Ko(a,t,n,r,s,e-1)||Ko(a,t,n,r,s,e+1);o&&h&&i.addPointXY(s,e)}return i}(e,a):function(e,t){const i=new wi.tO,s=e.getContext("2d",{willReadFrequently:!0}),n=e.width,r=e.height,a=s.getImageData(0,0,n,r).data;for(let e=0;e<r;++e)for(let s=0;s<n;++s)Ko(a,t,n,r,s,e)&&i.addPointXY(s,e);return i}(e,a)}const Yo=256;function Ko(e,t,i,s,n,r){if(n<0||n>=i||r<0||r>=s)return!1;const a=4*(r*i+n),o=e.subarray(a,a+4);if(o[3]>bo){if(ge.jA.distanceSquared(t,o)>Yo)return!0}return!1}function jo(e,t,{color:i,font:s,size:n,fontWeight:r,paddingWithinBorder:a,backgroundColor:o,backgroundOpacity:h,backgroundRadius:c,borderColor:l,borderThickness:d,dashLength:u,dashGapLength:g,underlineWidth:p}){return new Ao(e,(function(e){const m=[Math.floor(255*i[0]),Math.floor(255*i[1]),Math.floor(255*i[2])],f={color:"rgb("+m[0]+","+m[1]+","+m[2]+")",font:s,heightPx:n,weight:r},I=(a=a||0)+(d=d||0),E=Math.max(2,Math.ceil(.25*n)),S=ko(t);let T=Math.ceil(Fo(S,f))+2*I;T=Math.min(T,e.getParameter(e.MAX_TEXTURE_SIZE));let D=n*S.length+2*I;p&&(D+=p+2);const C=Vo(T,D+2*E),M=C.getContext("2d",{willReadFrequently:!0}),y=qo(C,t,m,f,I,E);y.isInitialized()||(Mo.warn("Did not find canvas bounds for text: "+t),y.addPointXY(0,E),y.addPointXY(T,E+D));const A=y.min[1];if(o){Uo(C,T,D,A-I,[Math.floor(255*o[0]),Math.floor(255*o[1]),Math.floor(255*o[2]),Math.floor(255*h)],h=h||1,c=c||0,d)}else Lo(C,m);if(l){Ho(C,T,D,A-I,[Math.floor(255*l[0]),Math.floor(255*l[1]),Math.floor(255*l[2])],c||0,d,u||1,g||0,!!o)}const P=y.getDimensions(),O=A+Math.floor((S.length*n-P[1])/(2*S.length));if(p){M.strokeStyle=f.color,M.lineWidth=p,M.beginPath();const e=O+n-.5*p;M.moveTo(I,e),M.lineTo(T-I,e),M.stroke()}return Wo(t,f,C,I,O),new yo(C,T,D,0,A-I)}))}function Qo(e){return e<0?"--":(1e3/e).toFixed(1)}class $o{constructor(){this.timings=[],this.averageTime=-1,this.framesSinceTiming=0,this.timingFrequency=10,this.timingCount=0,this.activeTimerQuery=null,this.pendingQueries=[],this.availableQueries=[],this.queryTimings=[],this.averageQueryTime=-1}reset(){this.timings=[],this.averageTime=-1,this.timingCount=0,this.framesSinceTiming=0,this.queryTimings=[],this.averageQueryTime=-1}onContextLost(){this.activeTimerQuery=null,this.pendingQueries=[],this.availableQueries=[]}hasTimings(){return this.timings.length>0}getAverageFramerate(){return 1e3/this.averageTime}onDrawStart(e,t){if(!e||!t)return;const i=t.getParameter(e.GPU_DISJOINT_EXT);let s;for(;s=this.pendingQueries.shift();)e.getQueryObjectEXT(s,e.QUERY_RESULT_AVAILABLE_EXT)&&(i||this.addQueryTiming(e.getQueryObjectEXT(s,e.QUERY_RESULT_EXT)/1e6),this.availableQueries.push(s));this.availableQueries.length>0?this.activeTimerQuery=this.availableQueries.shift():this.activeTimerQuery=e.createQueryEXT(),e.beginQueryEXT(e.TIME_ELAPSED_EXT,this.activeTimerQuery)}addQueryTiming(e){this.queryTimings.push(e),this.queryTimings.length>30&&this.queryTimings.shift();let t=0;for(let e=0;e<this.queryTimings.length;++e)t+=this.queryTimings[e];this.averageQueryTime=t/this.queryTimings.length}onDrawEnd(e){e&&this.activeTimerQuery&&(e.endQueryEXT(e.TIME_ELAPSED_EXT,this.activeTimerQuery),this.pendingQueries.push(this.activeTimerQuery),this.activeTimerQuery=null)}addTiming(e){this.timings.push(e),this.timings.length>5&&this.timings.shift();let t=0;for(let e=0;e<this.timings.length;++e)t+=this.timings[e];this.averageTime=t/this.timings.length,this.framesSinceTiming=0,++this.timingCount}}var Jo;!function(e){e[e.ADJUSTING_CAMERA=0]="ADJUSTING_CAMERA",e[e.MANIPULATING=1]="MANIPULATING",e[e.SYSTEM_ANIMATION=2]="SYSTEM_ANIMATION"}(Jo||(Jo={}));class eh{constructor(e){this.viewer=e,this.timingFrameType=null,this.frameTimeStart=0,this.drawLoopStart=0,this.frameTimings=[],this.frameDetails={},this.drawLoopDetails={},this.interactionTimeouts={},(0,Sh.Yk)(e),this.frameDetails[sa.Q.INTERACTIVE]=new $o,this.drawLoopDetails[sa.Q.INTERACTIVE]=new $o}resetTimings(){this.frameDetails[sa.Q.INTERACTIVE].reset(),this.drawLoopDetails[sa.Q.INTERACTIVE].reset()}onContextCreated(){this.disjointTimer=this.viewer.getExtension("EXT_disjoint_timer_query")}onContextLost(){Object.values(this.frameDetails).forEach((e=>{e.onContextLost()})),this.disjointTimer=null}onContextRestored(){this.disjointTimer=this.viewer.getExtension("EXT_disjoint_timer_query")}getAverageFrameRate(e){return Qo(this.frameDetails[e].averageTime)}getAverageQueryFrameRate(e){return this.disjointTimer?Qo(this.frameDetails[e].averageQueryTime):null}getTimingDetails(e){return this.frameDetails[e]}getDrawLoopDetails(e){return this.drawLoopDetails[e]}onDrawStart(){const e=this.getCurrentFrameType(),t=this.frameDetails[e];if(!t)return;t.onDrawStart(this.disjointTimer,this.viewer.getGlContext());const i=(0,Xs.Wj)();this.drawLoopStart=i,this.timingFrameType===e?(this.frameTimings.push(i-this.frameTimeStart),this.frameTimings.length<2?(this.frameTimeStart=i,this.viewer.forceRequestDraw()):(t.addTiming(Math.max(this.frameTimings[0],this.frameTimings[1])),this.timingFrameType=null)):(t.framesSinceTiming++,t.framesSinceTiming>=t.timingFrequency&&(this.frameTimeStart=i,this.timingFrameType=e,this.frameTimings=[],this.viewer.forceRequestDraw()))}onDrawEnd(){const e=this.getCurrentFrameType(),t=this.frameDetails[e];t&&t.onDrawEnd(this.disjointTimer);const i=this.drawLoopDetails[e];if(!i)return;const s=(0,Xs.Wj)();i.addTiming(s-this.drawLoopStart)}setUserIsInteractingWithTimeout(e){this.interactionTimeouts[e]&&window.clearTimeout(this.interactionTimeouts[e]);this.interactionTimeouts[e]=window.setTimeout((()=>{delete this.interactionTimeouts[e],this.viewer.requestDraw()}),500)}resetInteractionStatus(){Object.values(this.interactionTimeouts).forEach((function(e){window.clearTimeout(e)}),this),this.interactionTimeouts={}}setUserIsAdjustingCamera(){this.setUserIsInteractingWithTimeout(Jo.ADJUSTING_CAMERA)}setUserIsManipulatingWithTimeout(){this.setUserIsInteractingWithTimeout(Jo.MANIPULATING)}setSystemIsAnimating(){this.setUserIsInteractingWithTimeout(Jo.SYSTEM_ANIMATION)}userIsInteracting(){for(const e in this.interactionTimeouts)if(this.interactionTimeouts[e])return!0;return!1}userIsManipulating(){return!!this.interactionTimeouts[Jo.MANIPULATING]}getCurrentFrameType(){return this.userIsManipulating()?sa.Q.MANIPULATING:this.userIsInteracting()?sa.Q.INTERACTIVE:sa.Q.FULL}}const th=_e.O.createLogger("FrameBuffer",k.bVy.GRAPHICS);class ih extends m.T{constructor(e,t,i,s){super(),this.viewer=e,this.textureType=t,this.GAUGE_MEMORY_TYPE="Frame buffer",this.colorTexture=null,this.renderBuffer=null,this.frameBuffer=null,this.width=0,this.height=0,this.isWebXrEnabled=!1,(0,Sh.Yk)(e),this.renderBufferArguments=s,this.id=i||"",this.listenTo(this.viewer.getEventDispatcher(),nM.cW,this.onGlContextLost),this.listenTo(this.viewer.getEventDispatcher(),nM.so,this.onSessionEnded),es.Jq.CapabilitiesService.isWebxrEnabled().then((e=>{this.isWebXrEnabled=e}))}destroy(){this.stopListening(),this.freeResources()}setExternalFrameBuffer(e,t,i){this.width=e,this.height=t,this.frameBuffer=i}onSessionEnded(){this.destroy()}onGlContextLost(){this.frameBuffer=null,this.colorTexture=null,this.renderBuffer=null}update(e,t,i){if(this.isWebXrEnabled){if(!t&&!i)if(e.isCustomViewportActive){const s=e.getViewport();t=s[2],i=s[3]}else t=this.viewer.getBaseFrameBufferWidth(),i=this.viewer.getBaseFrameBufferHeight()}else{const s=e.getViewport();t=s[2],i=s[3]}if(!this.colorTexture||t!==this.width||i!==this.height){const e=this.viewer.getGlContext();this.freeResources(),this.width=t,this.height=i;const s=e.getParameter(e.FRAMEBUFFER_BINDING);this.createBuffer(t,i),this.checkFrameBuffer()||this.textureType!==this.viewer.getHalfFloatType()||(this.textureType=e.FLOAT,th.info("The creation of a frame buffer with HALF_FLOAT failed.  Attempting to create buffer with full FLOAT"),this.freeResources(),this.createBuffer(t,i),this.checkFrameBuffer()),e.bindFramebuffer(e.FRAMEBUFFER,s||null)}}getColorTextureMemoryUsage(){return To(this.width,this.height,Xt.RGBA,this.textureType)}getRenderBufferMemoryUsage(){return this.renderBufferArguments?this.width*this.height*Zt(this.renderBufferArguments.storageType):0}incrementMemoryGauge(){const e=this.viewer.getMemoryGauge();this.colorTexture&&e.incrementMemoryUsage(this.GAUGE_MEMORY_TYPE,this.getColorTextureMemoryUsage()),this.renderBuffer&&e.incrementMemoryUsage(this.GAUGE_MEMORY_TYPE,this.getRenderBufferMemoryUsage())}freeResources(){const e=this.viewer.getGlContext();if(!e)return;const t=this.viewer.getMemoryGauge();this.frameBuffer&&(e.deleteFramebuffer(this.frameBuffer),this.frameBuffer=null),this.colorTexture&&(t.decrementMemoryUsage(this.GAUGE_MEMORY_TYPE,this.getColorTextureMemoryUsage()),e.deleteTexture(this.colorTexture),this.colorTexture=null),this.renderBuffer&&(t.decrementMemoryUsage(this.GAUGE_MEMORY_TYPE,this.getRenderBufferMemoryUsage()),e.deleteRenderbuffer(this.renderBuffer),this.renderBuffer=null)}createBuffer(e,t){const i=this.viewer.getGlContext();this.colorTexture=Do(this.viewer,e,t,this.textureType),this.renderBufferArguments&&(this.renderBuffer=this.viewer.getOrCreateRenderBuffer(e,t,this.renderBufferArguments)),this.frameBuffer=i.createFramebuffer(),i.bindFramebuffer(i.FRAMEBUFFER,this.frameBuffer),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this.colorTexture,0),this.renderBufferArguments&&i.framebufferRenderbuffer(i.FRAMEBUFFER,this.renderBufferArguments.attachmentType,i.RENDERBUFFER,this.renderBuffer),this.incrementMemoryGauge()}checkFrameBuffer(){const e=this.viewer.getGlContext();switch(e.checkFramebufferStatus(e.FRAMEBUFFER)){case e.FRAMEBUFFER_UNSUPPORTED:return th.warn(cM+"Framebuffer is unsupported"),!1;case e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:return this.textureType===this.viewer.getHalfFloatType()?th.info("Framebuffer incomplete attachment for half float type"):th.warn(cM+"Framebuffer incomplete attachment"),!1;case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:return th.warn(cM+"Framebuffer incomplete dimensions"),!1;case e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:return th.warn(cM+"Framebuffer incomplete missing attachment"),!1}return!0}bindBuffer(){const e=this.viewer.getGlContext();e.bindFramebuffer(e.FRAMEBUFFER,this.frameBuffer)}unbindBuffer(){const e=this.viewer.getGlContext();e.bindFramebuffer(e.FRAMEBUFFER,null)}getTexture(){return this.colorTexture}resetBuffer(){this.freeResources()}getWidth(){return this.width}getHeight(){return this.height}}var sh=i(57702),nh=i(57702);const rh={duration:500,tolerance:10},ah={mousedown:"mousedown",mouseup:"mouseup",mousemove:"mousemove",longpress:"longpress"},oh={LEFT:1,MIDDLE:2,RIGHT:3};function hh(e,t){e.on(ah.mousedown,lh),e.on(ah.longpress,t)}function ch(e){e.off(ah.mousedown,void 0,lh),e.off(ah.longpress)}function lh(e){if(e.which!==oh.LEFT)return;const t=sh(e.target),i=(new Date).getTime(),s=nh.Event(ah.longpress);for(const t in e)s[t]=e[t];s.type=ah.longpress,t.on(ah.mouseup,r),t.on(ah.mousemove,a);const n=setTimeout((function(){t.trigger(ah.longpress,s),o()}),rh.duration);function r(e){(new Date).getTime()-i<rh.duration?clearTimeout(n):t.trigger(ah.longpress,s),o()}function a(e){(Math.abs(e.pageX-s.pageX)>rh.tolerance||Math.abs(e.pageY-s.pageY)>rh.tolerance)&&(clearTimeout(n),o())}function o(){t.off(ah.mouseup,void 0,r),t.off(ah.mousemove,void 0,a)}}var dh=i(27339),uh=i(90548);class gh{constructor(e){this.id=e;const t=e===uh.Vv?ys.L.PREVIEW:ys.L.BASE;this.rootNode=new Gi.NB(e+" root",{},t)}getRootNode(){return this.rootNode}isForPreview(){return this.rootNode.getUsage()===ys.L.PREVIEW}getBounds(){return this.rootNode.getBoundingBox()}updateBounds(){this.rootNode.updateBounds()}removeEverything(){this.rootNode&&this.rootNode.removeAllChildren()}draw(e){this.rootNode.draw(e)}passesNodeFilter(e){return this.rootNode.passesNodeFilter(e)}getAllNodesWithId(e){const t=[],i=function(s){s.getId()===e&&t.push(s);for(let e=0;e<s.getChildCount();++e)i(s.getChildByIndex(e))};return i(this.rootNode),t}getNodeAtEndOfPath(e){const t=e.slice(0);let i=this.rootNode;for(t.shift();t.length>0;){const e=t.shift();if(i=i.getChildById(e),null===i)return null}return i}ownsNode(e){for(;e;){if(e===this.rootNode)return!0;e=e.getParent()}return!1}makeSceneDebugObject(){return{text:this.id,children:[this.rootNode.makeSceneDebugObject(0)]}}}class ph{constructor(){this.theSceneGraphs={}}destroySceneGraphs(){Object.values(this.theSceneGraphs).forEach((function(e){e.getRootNode().onPermanentlyRemoved()})),this.theSceneGraphs={}}getSceneGraph(e){let t=this.theSceneGraphs[e];return t||(this.theSceneGraphs[e]=t=new gh(e)),t}getMainSceneGraph(){return this.getSceneGraph(uh.lL)}getPreviewSceneGraph(){return this.getSceneGraph(uh.Vv)}getHudSceneGraph(){return this.getSceneGraph(uh.EG)}getHudModelSceneGraph(){return this.getSceneGraph(uh.$K)}}function mh(e){return e===ys.L.BASE?uh.lL:uh.Vv}var fh=i(32155),Ih=i(45345),Eh=i(44037),Sh=i(88155);const Th=X.default.getManager(),Dh=_e.O.createLogger("ModelViewManager",k.bVy.GRAPHICS);class Ch extends m.T{constructor(e,t,i){super(),this.usage=e,this.occurrenceDataManager=t,this.viewer=i,this.partStudios={},this.sharedBaseMeshManager=null,this.i18next=i18n,this.assemblies={},this.displayedElementMicroversionIdAndConfiguration=null,this.displayedElementType=null,this.displayedPartStudio=null,this.partStudioPreservedForPreview=null,this.pendingPartStudioComputedData=null,this.selectionsToClearOnReset={},this.secondaryOccurrenceHighlights={},this.secondaryEntityHighlights={},this.secondaryEntityHighlightSelectionRepeats={},this.addDerivedEntityHighlights=!0,this.selectionListNameToListAndHighlightType=new Map,this.bodyLoadTasks=null,this.meshPointController=null,this.queuedAssemblyDisplayData=[],this.queuedAssemblyTimeout=null,this.notCollapsedAssemblyMessageCount=0,this.selectedSheetmetalModelId=null,this.lastFitSheetMetalModelId=null,this.resyncFunction=null,this.resyncNeeded=!1,this.resyncReason=null,this.resyncPromise=null,this.lastPartStudioProcessed="",this.lastPartStudioMicroversionIdAndConfigurationIntervalProcessed={},this.temporarySketchComponents={},this.partStudioVisibilityUpdated=!1,this.subFeaturesShownByParameters={},(0,Sh.Yk)(i),this.meshManager=new eD(this.viewer,FE),this.displayedElementId="",this.partsAtTheBeginningOfEdit=new mt.StringSet,this.sheetModelIdsAtTheBeginningOfEdit=new mt.StringSet,this.handleAllSelectionListHighlights(),this.collapsibleDisplayDataTimer=new $o,this.bodyNode=new Gi.NB(om,new Gi.hF,e),this.sketchNode=new Gi.NB(Vm,new Gi.hF,e),this.elementPreviewBodyNode=new Gi.NB(om,new Gi.hF,e),this.isBase()&&(this.listenTo(this.viewer.getEventDispatcher(),nM.LA,this.refreshHighlight),i.getIsPrimaryViewer()&&(this.simulationManager=new zf(this),this.generativeDesignManager=new cI(this),this.thicknessAnalysisManager=new eI(this))),this.alternateEntityMapping=new Eh.L,this.latestDisplayDataUsageSubscription=Ls().latestDisplayDataUsageChangedObservable.subscribe((()=>this.clearAndRefreshHighlights())),this.meshPointController=new Zn(this.viewer)}clearAndRefreshHighlights(){this.clearHighlights(),this.refreshHighlight()}getViewer(){return this.viewer}onViewerShown(){this.viewer.getIsForFlattenedDisplay()&&this.fitToSelectedSheetMetalModel()}setAlternateEntityMapping(e){this.alternateEntityMapping=e}setResyncFunction(e){this.resyncFunction=e}getResyncPromise(){return this.resyncPromise?this.resyncPromise:null}getSimulationManager(){return this.simulationManager}getGenerativeDesignManager(){return this.generativeDesignManager}getThicknessAnalysisManager(){return this.thicknessAnalysisManager}purgeUnusedPartStudios(e,t){const i=[];for(const t of Object.keys(this.partStudios))e.contains(t)||i.push(this.partStudios[t]);i.sort((function(e,t){return e.getEstimatedMemoryUsageOfBodies()>t.getEstimatedMemoryUsageOfBodies()?-1:e.getEstimatedMemoryUsageOfBodies()<t.getEstimatedMemoryUsageOfBodies()?1:0}));const s=[];for(;(t||this.isEstimatedBodyMemoryUsageAboveThreshold())&&i.length>0;){const e=i.shift();if(t||!e.getIsCachedPartStudioPendingUse()){const t=e.getFullElementId();e.onDeletion(),delete this.partStudios[t],s.push(t),this.displayedElementId&&this.setResyncNeeded(k.ggp.CLIENT_UNLOADED_DISPLAY_DATA)}}t&&Object.keys(this.partStudios).length>0&&Dh.error("Failed to purge all part studios. Remaining part studios: "+Object.keys(this.partStudios)+", deleted part studios: "+s),s.length>0&&(this.meshManager.removeEmptyMeshes(),Dh.info("Purged unused, in-memory part studios: "+s))}getInUsePartStudioIds(){const e=new mt.StringSet;if(this.displayingPartStudio()){this.getDisplayedPartStudio()&&e.add(this.getDisplayedPartStudio().getFullElementId());const t=this.getDisplayedInContextAssembly();t&&t.getUsedPartStudioIds(e)}else if(this.displayingAssembly()){const t=this.assemblies[this.displayedElementId];t&&t.getUsedPartStudioIds(e)}return e}getEstimatedMemoryUsageOfBodies(){const e=new Ih.B7("ModelViewManager.prototype.getEstimatedMemoryUsageOfBodies");let t=0;return Object.values(this.partStudios).forEach((function(e){t+=e.getEstimatedMemoryUsageOfBodies()}),this),e.report(),t}getBodyDisplayMemoryLimit(){return 1024*(es.Jq.CapabilitiesService.checkDecreasedBodyDisplayLimitCurrentlyEnabled()?Th.getNumber("DECREASED_BODY_DISPLAY_MEMORY_LIMIT_MB"):(0,pt.isBrowser64BitFirefox)()?Th.getNumber("BODY_DISPLAY_MEMORY_LIMIT_FIREFOX64_MB"):Th.getNumber("BODY_DISPLAY_MEMORY_LIMIT_MB"))*1024}clearAllGenerativeDesignPartInstances(){for(const e of Object.values(this.partStudios))e.getBodyComponent().clearAllGenerativeDesignOccurrences()}getBodyRefinementMemoryLimit(){return this.getBodyDisplayMemoryLimit()}isEstimatedBodyMemoryUsageAboveThreshold(){return this.getEstimatedMemoryUsageOfBodies()>this.getBodyDisplayMemoryLimit()}checkBodyMemoryUsage(e){if(!this.isBase()||this.viewer.getIsForFlattenedDisplay()||this.bodyLoadTasks.hasPendingUnloads()||e.fromDisplayCache)return;const t=this.getEstimatedMemoryUsageOfBodies(),i=this.getBodyDisplayMemoryLimit();if(t<=i)return;this.purgeUnusedPartStudios(this.getInUsePartStudioIds());const s=this.getEstimatedMemoryUsageOfBodies();if(s<=i)return;const n=new Ih.B7("ModelViewManager.prototype.checkBodyMemoryUsage",{logResult:rl()});rl()&&Dh.info("bodyMemoryUse before unload: "+al(s));const r=this.viewer.getBodyManager().unloadBodies(s-i,this);if(r){const e=new Ih.B7("Unloading body display data",{logResult:rl()});r.then((t=>{if(this.setResyncNeeded(k.ggp.CLIENT_UNLOADED_DISPLAY_DATA),this.resyncAsNeeded(),e.report(),rl()){const e=this.getEstimatedMemoryUsageOfBodies();Dh.info("Unloaded "+t.bodiesProcessedSinceStart+" bodies after "+t.iterationsSinceStart+" frames. bodyMemoryUse after unload: "+al(e))}}))}n.report()}setResyncNeeded(e){this.resyncNeeded=!0,this.resyncReason=void 0!==e?e:null}resyncAsNeeded(){if(this.resyncFunction&&this.resyncNeeded){const e=this.resyncFunction(this.resyncReason);return this.resyncNeeded=!1,this.resyncReason=null,e}return Jr()}integrityCheck(){if(this.displayedElementId in this.assemblies&&this.displayedElementType!==k.GNh.ASSEMBLY)Dh.warn("Found an assembly with the displayed element id, but the element type is incorrect");else{const e=this.displayedElementId;let t=!1;if(e)for(const i in this.partStudios)if(0===i.indexOf(e)){t=!0;break}t&&this.displayedElementType!==k.GNh.PARTSTUDIO&&Dh.warn("Found a part studio with the displayed element id, but the element type is incorrect")}}getSharedBodyNode(){return this.bodyNode}getSharedSketchNode(){return this.sketchNode}getElementPreviewBodyNode(){return this.elementPreviewBodyNode}clearSilhouetteRequests(){this.viewer.getSilhouetteTask().clearPendingRequestsForUsage(this.usage)}instantiateSharedNodes(e){e.addChild(this.bodyNode),e.addChild(this.sketchNode)}isBase(){return this.usage===ys.L.BASE}getDisplayedFullElementId(){return this.displayedElementMicroversionIdAndConfiguration?k.lK7.getFullElementIdString(this.displayedElementId,this.displayedElementMicroversionIdAndConfiguration.getKey()):this.displayedElementId}getLastDisplayedFullElementId(){const e=this.lastPartStudioMicroversionIdAndConfigurationIntervalProcessed[this.displayedElementId];return k.lK7.getFullElementIdString(this.displayedElementId,e?.to.microversion.theId)}setBodyLoadTasks(e){this.bodyLoadTasks=e}getHideableFeatureIdsForDisplayedPartStudio(e){if(e===this.getDisplayedElementId()){const e=this.partStudios[this.getDisplayedFullElementId()];if(e)return e.getHideableFeatureIds()}return[]}onDeletion(){Object.values(this.assemblies).forEach((function(e){e.onDeletion()})),Object.values(this.partStudios).forEach((function(e){e.onDeletion(!0)}),this),this.meshManager.destroy(),this.sharedBaseMeshManager&&(this.sharedBaseMeshManager.destroy(),this.sharedBaseMeshManager=null),this.stopListening(),this.latestDisplayDataUsageSubscription.unsubscribe(),this.meshPointController&&this.meshPointController.destroy(),this.clearSilhouetteRequests(),(0,ea.Z)(this.queuedAssemblyTimeout)&&(window.clearTimeout(this.queuedAssemblyTimeout),this.queuedAssemblyTimeout=null)}getSceneGraph(){return this.usage===ys.L.PREVIEW?this.viewer.getSceneGraphs().getPreviewSceneGraph():this.viewer.getSceneGraphs().getMainSceneGraph()}getMeshManager(){return this.meshManager}getSharedBaseMeshManager(){return this.sharedBaseMeshManager}displayedMicroversionAndConfigMatchesDisplayData(e){return!!this.displayedElementMicroversionIdAndConfiguration&&e.microversionIdAndConfigurationInterval.to.equals(this.displayedElementMicroversionIdAndConfiguration)}processRootAssemblyDisplayData(e,t){if(!t&&(e.isCollapsible||this.viewer.getFrameTimer().userIsInteracting()&&this.displayedMicroversionAndConfigMatchesDisplayData(e))){const t=this.queuedAssemblyDisplayData.length>0?this.queuedAssemblyDisplayData[this.queuedAssemblyDisplayData.length-1]:null;t&&t.isCollapsible&&e.isCollapsible?(++t.collapseCount,t.mergeCollapsibleData(e)):this.queuedAssemblyDisplayData.push(e),this.startAssemblyDisplayDataQueueTimeout()}else this.emptyAssemblyDisplayDataQueue(),this.processRootAssemblyDisplayDataInternal(e,t),this.collapsibleDisplayDataTimer.reset()}startAssemblyDisplayDataQueueTimeout(){if((0,ea.Z)(this.queuedAssemblyTimeout))return;const e=this.viewer.getFrameTimer().getTimingDetails(sa.Q.INTERACTIVE).averageTime,t=this.collapsibleDisplayDataTimer.averageTime,i=Math.max((e+t)*Th.getNumber("ASSEMBLY_DRAG_COLLAPSE_WAIT_RATIO"),0);this.queuedAssemblyTimeout=window.setTimeout((()=>this.processAssemblyDisplayDataQueue()),i)}emptyAssemblyDisplayDataQueue(){(0,ea.Z)(this.queuedAssemblyTimeout)&&(window.clearTimeout(this.queuedAssemblyTimeout),this.queuedAssemblyTimeout=null);for(let e=0;e<this.queuedAssemblyDisplayData.length;++e){const t=this.queuedAssemblyDisplayData[e];t.elementId!==this.displayedElementId||t.isCollapsible||this.processRootAssemblyDisplayDataInternal(t)}this.queuedAssemblyDisplayData=[]}processAssemblyDisplayDataQueue(){this.queuedAssemblyTimeout=null;let e=!1;for(let t=0;t<this.queuedAssemblyDisplayData.length&&!e;++t)e=e||this.queuedAssemblyDisplayData[t].elementId===this.displayedElementId&&this.queuedAssemblyDisplayData[t].isCollapsible;if(!e&&this.viewer.getFrameTimer().userIsInteracting())return void this.startAssemblyDisplayDataQueueTimeout();const t=this.queuedAssemblyDisplayData.shift();if(t&&t.elementId===this.displayedElementId){t.isCollapsible&&Th.getNumber("LOG_ASSEMBLY_DRAG_COLLAPSE_INFO")&&(t.collapseCount>1?(Dh.debug("Did not collapse "+this.notCollapsedAssemblyMessageCount+" messages"),Dh.debug("Collapsed "+t.collapseCount+" display data messages for "+t.elementId),this.notCollapsedAssemblyMessageCount=0):++this.notCollapsedAssemblyMessageCount);const e=(0,Xs.Wj)();this.processRootAssemblyDisplayDataInternal(t),t.isCollapsible&&this.collapsibleDisplayDataTimer.addTiming((0,Xs.Es)(e))}this.queuedAssemblyDisplayData.length>0&&this.startAssemblyDisplayDataQueueTimeout()}resetAllIncontextGraphicsForPartstudio(e){if(!this.assemblies)return;let t="";const i=Object.keys(this.assemblies);for(let s=0;s<i.length;s++){const n=i[s];if((0,Xs.dV)(n)===e){t=n;const e=this.assemblies[t];if(!e)continue;e.reset()}}}processPartStudioDisplayDataList(e,t,i){let s=i;for(const i of e){const e=i;if(!e)return;const n=!0,r=this.getAndUpdatePartStudioForMessage(e,t,n),a=e.microversionIdAndConfigurationInterval.to.equals(e.microversionIdAndConfigurationInterval.from);r&&r.processDisplayData(e,!1,t,a),s=s&&a}return s}processRootAssemblyDisplayDataInternal(e,t){const i=new Ih.B7("processRootAssemblyDisplayDataInternal",{setTraceId:!0}),s=e.elementId,n=!!t,r=this.displayedMicroversionAndConfigMatchesDisplayData(e);s!==this.displayedElementId||e.incremental||e.fromDisplayCache||this.clearSilhouetteRequests();let a=this.assemblies[s];a||(a=new Ig(s,this,this.viewer),this.assemblies[s]=a,this.integrityCheck()),e.isForInContext&&this.showAssembly(s,e.isForInContext),this.clearHighlights(),a.processOccurrenceDeletions(e,t);const o=this.processPartStudioDisplayDataList(e.partStudioDisplayData,n,r);this.resyncNeeded&&this.resyncFunction?o?(this.resyncNeeded=!1,Dh.warn("Skipped resync when processing tessellation update for assembly "+this.displayedElementId+" "+this.displayedElementMicroversionIdAndConfiguration)):this.resyncPromise=this.resyncAsNeeded().then((()=>{this.processRootAssemblyDisplayDataHelper(s,a,e,o,i),this.resyncPromise=null})):this.processRootAssemblyDisplayDataHelper(s,a,e,o,i)}processRootAssemblyDisplayDataHelper(e,t,i,s,n){if(i.isForInContext&&this.showAssembly(e,i.isForInContext),s&&(this.viewer.getBodyManager().cleanupPendingRefinementRequests(),rl())){const e=[];for(let t=0;t<i.partStudioDisplayData.length;++t){const s=i.partStudioDisplayData[t],n=k.lK7.getFullElementIdString(s.elementId,s.microversionIdAndConfigurationInterval.to.getKey());if(this.getPartStudio(n)){for(const t in s.deterministicPartIdToData)if(s.deterministicPartIdToData.hasOwnProperty(t)){const i=s.deterministicPartIdToData[t];e.push(t+"-"+i.tessellationSettings)}}else Dh.warn(`Cannot find part studio: ${n} to apply display data refinement update.`)}Dh.info("Processing update for bodies:\n"+e);const t=this.getEstimatedMemoryUsageOfBodies();Dh.info("bodyMemoryUse prior to update: "+al(t))}if(t.processDisplayData(i),e===this.displayedElementId){const e=!this.displayedElementMicroversionIdAndConfiguration;this.displayedElementMicroversionIdAndConfiguration=i.microversionIdAndConfigurationInterval.to,this.displayAssembly(this.displayedElementId,e)}this.updateOrVerifySelections(null,e),this.refreshHighlight(),this.viewer.getEventDispatcher().trigger(nM.hj,i,s),this.viewer.requestDraw(),t.microversionIdAndConfiguration=i.microversionIdAndConfigurationInterval.to,!s&&this.simulationManager&&this.simulationManager.onAssemblyChanged();const r=this.viewer.getPendingBodiesToLoadPromise();r?r.then((()=>{this.viewer.getBodyManager().initiateAutomaticRetrieval(!s)})):this.viewer.getBodyManager().initiateAutomaticRetrieval(!s),this.checkBodyMemoryUsage(i),this.resyncAsNeeded(),n.report()}getOrCreatePartStudio(e,t){const i=t?k.lK7.getFullElementIdString(e,t.getKey()):e;let s=this.partStudios[i];if(!s){if(!this.bodyLoadTasks)throw"Loaders should be constructed prior to handling display data";s=new kg(e,t||null,this,this.bodyLoadTasks,this.usage,this.viewer),this.partStudios[i]=s,this.integrityCheck()}return s}getMicroversionIdsString(e){const t=[];for(const i in this.partStudios){const s=this.partStudios[i];s.getElementId()===e&&t.push(s.getMicroversionIdAndConfiguration())}return"["+t.join(", ")+"]"}getAndUpdatePartStudioForMessage(e,t,i,s){let n;if(!this.isBase())return n=this.partStudios[e.elementId]||this.getOrCreatePartStudio(e.elementId),n.microversionIdAndConfiguration=e.microversionIdAndConfigurationInterval.to,n;const r=!(t||i||e.elementId!==this.displayedElementId||e.fromDisplayCache||s);let a=!1;this.displayedElementMicroversionIdAndConfiguration&&!this.displayedElementIsPublicationItem||!r||(this.displayedElementMicroversionIdAndConfiguration=e.microversionIdAndConfigurationInterval.to,a=!0);const o=e.buildFullElementId(!0).toString(),h=e.buildFullElementId(!1).toString();if(this.isBase()&&this.viewer.getModelViewManagers().getPreviewManager()&&!e.incremental&&!e.keepFromMicroversion&&o in this.partStudios&&(Dh.info("Received non-incremental base display data during preview/compare. Cloning base reference"),n=this.partStudios[o],this.partStudioPreservedForPreview=n,this.partStudios[o]=n.clone(e.incremental)),o!==h&&o in this.partStudios)h in this.partStudios&&(Dh.info("Deleting existing local copy of : "+h),this.partStudios[h].onDeletion(),delete this.partStudios[h]),n=this.partStudios[o],e.keepFromMicroversion?n=n.clone(e.incremental):delete this.partStudios[o],this.partStudios[h]=n,n.microversionIdAndConfiguration=e.microversionIdAndConfigurationInterval.to,this.getDisplayedFullElementId()===o&&r&&(this.displayedElementMicroversionIdAndConfiguration=e.microversionIdAndConfigurationInterval.to);else{if(o!==h&&e.microversionIdAndConfigurationInterval.from&&e.microversionIdAndConfigurationInterval.from.microversion.theId)return this.partStudios[h]?(Dh.trace("Skipped application of increment for part studio "+e.elementId+" because it was incrementing to a microversion that was already present "+e.microversionIdAndConfigurationInterval.to),r&&(this.displayedElementMicroversionIdAndConfiguration=e.microversionIdAndConfigurationInterval.to),this.partStudios[h].updateExternalState(t,i)):(Dh.warn("Skipped application of increment for part studio "+e.elementId+" due to missing from data.  Interval with missing data: "+e.microversionIdAndConfigurationInterval+". Existing microversions for element: "+this.getMicroversionIdsString(e.elementId)),this.setResyncNeeded(),a&&(this.displayedElementMicroversionIdAndConfiguration=null)),null;if(e.incremental&&!(h in this.partStudios))return Dh.warn("Skipped creation of part studio "+e.elementId+" because the destination microversion is missing.  MV interval: "+e.microversionIdAndConfigurationInterval+". From display cache: "+e.fromDisplayCache+". Existing microversions for element: "+this.getMicroversionIdsString(e.elementId)),this.setResyncNeeded(),a&&(this.displayedElementMicroversionIdAndConfiguration=null),null;n=this.getOrCreatePartStudio(e.elementId,e.microversionIdAndConfigurationInterval.to)}return n.updateExternalState(t,i),n}processManagedData(e){e?.computedData?.computedData&&(this.displayedPartStudio&&this.displayedPartStudio.microversionIdAndConfiguration?.equals(e.microversionIdAndConfigurationInterval.to)?(this.displayedPartStudio.addManagedIdMappings(e.computedData.computedData),this.pendingPartStudioComputedData=null):this.pendingPartStudioComputedData=e)}processReceivedInsertableDisplayData(e){const t=this.partStudios[this.getDisplayedFullElementId()];t&&t.processReceivedInsertableData(e)}processPartStudioDisplayData(e,t){const i=!!this.displayedElementMicroversionIdAndConfiguration;this.lastPartStudioProcessed=e.elementId,this.lastPartStudioMicroversionIdAndConfigurationIntervalProcessed[e.elementId]=e.microversionIdAndConfigurationInterval;const s=this.displayedMicroversionAndConfigMatchesDisplayData(e);s?this.viewer.getBodyManager().cleanupPendingRefinementRequests():this.viewer.getBodyManager().clearPreviewOccurrences(),this.isBase()&&this.hideInactiveContextAssemblies(e);const n=this.getAndUpdatePartStudioForMessage(e,e.isExternal);if(e.incremental)for(const t in e.deterministicPartIdToData)if(!e.deterministicPartIdToData[t].isACopyForTessellationSettings){const i=va(e.elementId,t,70,40);Pa(i),Ma(i)}const r=this.isBase()?e.buildFullElementId().toString()===this.getDisplayedFullElementId():this.displayedElementId===e.elementId&&!e.fromDisplayCache;if(r&&(this.displayPartStudio(this.getDisplayedFullElementId()),e.incremental||(this.partStudioVisibilityUpdated=!1)),n&&!e.isNoop){const i=!1,a=this.viewer.getModelViewManagers().getManager();let o;if(e.usage===k.rvN.PREVIEW_AFTER){o=new mt.StringSet;const t=a.partsAtTheBeginningOfEdit,i=a.sheetModelIdsAtTheBeginningOfEdit;e.partDisplayData.forEach((s=>{const n=e.deterministicPartIdToData[s.id];let r=null;if(n)r=n.sheetMetalModelId;else{const e=this.viewer.getModelViewManagers().getPreviewManager().retrieveBodyMetaData(null,s.id);r=e?e.sheetMetalModelId:null}t.contains(s.id)||i.contains(r)||o.add(s.id)}))}if(n.processDisplayData(e,r,i,s,o),this.viewer.getCurvatureAnalysisManager()?.onPartStudioDisplayDataChanged(e,e.buildFullElementId().toString()),this.thicknessAnalysisManager?.onPartStudioDisplayDataChanged(e),e.usage===k.rvN.PREVIEW_BEFORE){this.partsAtTheBeginningOfEdit=new mt.StringSet,this.sheetModelIdsAtTheBeginningOfEdit=new mt.StringSet,this.newParts=new mt.StringSet;const t=this.displayedPartStudio,i=this;e.partDisplayData.forEach((function(e){i.partsAtTheBeginningOfEdit.add(e.id);const s=t.retrieveBodyMetaData(e.id);s&&s.sheetMetalModelId&&i.sheetModelIdsAtTheBeginningOfEdit.add(s.sheetMetalModelId)}))}else e.usage===k.rvN.PREVIEW_AFTER&&(a.newParts=o);this.updateOrVerifySelections(t,e.elementId),this.viewer.getEventDispatcher().trigger(nM.cy,e.elementId),this.refreshHighlight()}else n&&n.processInContextData(e,r);return this.resyncNeeded&&(s?(this.resyncNeeded=!1,Dh.warn("Skipped resync when processing tessellation update for part studio "+this.displayedElementId+" "+this.displayedElementMicroversionIdAndConfiguration)):this.resyncAsNeeded()),r&&(this.processInContextDisplayData(e,s),this.selectedSheetmetalModelId&&this.showPartsWithSheetmetalModelIdOnly(this.selectedSheetmetalModelId),this.pendingPartStudioComputedData&&this.processManagedData(this.pendingPartStudioComputedData),i||this.viewer.getIsForFlattenedDisplay()||this.viewer.getEventDispatcher().trigger(nM.ad,e.elementId,!i)),this.checkBodyMemoryUsage(e),s}populateClientCacheStateDisplayInformation(e){this.emptyAssemblyDisplayDataQueue();this.viewer.processQueuedDisplayData(!0);this.getPartStudioSortedForCache().forEach((function(t){t.populateClientCacheStateDisplayInformation(e)}),this),Object.values(this.assemblies).forEach((function(t){t.populateClientCacheStateDisplayInformation(e)}),this)}displayPartStudio(e){const t=this.partStudios[e];t!==this.displayedPartStudio&&this.removePartStudioDisplay(),t&&(t.instantiateForEditingInNode(this.getElementRootNode()),this.displayedPartStudio=t,this.viewer.getCurvatureAnalysisManager()?.onPartStudioDisplayed());gt.T.isElementAtVersionOrLater(k.vgi.V343_SUBFEATURES)&&!es.Jq.StateService.isOnDocumentCompare()?(this.viewer.getEdgePointController()||this.viewer.createEdgePointController(),this.viewer.getEdgePointController().enable()):this.viewer.getEdgePointController()&&this.viewer.getEdgePointController().disable()}removePartStudioDisplay(){this.displayedPartStudio&&(this.displayedPartStudio.removeInstantiationForEditing(this.getElementRootNode()),this.displayedPartStudio=null)}displayAssembly(e,t){const i=this.assemblies[e];i&&(this.getElementRootNode(),i.show(),this.simulationManager&&this.simulationManager.onAssemblyDisplayed(),this.viewer.getEventDispatcher().trigger(nM.t0,e,t))}getModelBounds(e){const t=new wi.kB,i=this.getSceneGraph().getRootNode(),s=i.getChildById(RE);if(s&&s.getBoundingBox().isInitialized()&&t.addBox(s.getBoundingBox()),!e||!e.doNotBoundTemporarySketchEntities){const e=i.getChildrenWithPrefix(vE);if(e)for(let i=0;i<e.length;++i)t.addBox(e[i].getBoundingBox())}const n=this.getDisplayedElement();return n&&t.addBox(n.getBoundsOutsideElementNode()),t.addBox(this.viewer.getBodyManager().getUnloadedBodyBounds()),t.isInitialized()?t:null}setModelTransform(e){const t=this.getSceneGraph().getRootNode(),i=t.getChildById(RE),s=t.getChildById(wE);i&&i.setPose(e),s&&s.setPose(e),this.applyToPreview(this.setModelTransform,arguments)}getModelTransform(){const e=this.getSceneGraph().getRootNode().getChildById(RE);return e?e.getPose():null}getEntityBounds(e,t){const i=this.getPartStudioDataFromOccurrence(t);if(!i)return null;const s=i.getEntityBounds(e,t);return s&&t?s.createTransformedCopy(this.getOccurrenceTransform(t)):s}getFeatureBounds(e){if(!this.displayingPartStudio())return null;const t=this.getDisplayedPartStudio();return t?t.getFeatureBounds(e):null}getMateConnectorBounds(e){if(e.getType()!==k.lQt.MATE_CONNECTOR)return null;const t=this.viewer.getModelViewManagers().getManager().getMateConnectorGraphics(e.getOccurrence(),e.getIdString());if(!t)return null;const i=t.worldSpacePosition;return new wi.kB(i,i)}getBodyBounds(e,t){const i=this.getDisplayedElement();return i?i.getBodyBounds(e,t):null}getSelectionFitBounds(e){if(!e)return null;const t=e.getIdString(),i=e.getOccurrence();switch(e.getType()){case k.lQt.MATE_CONNECTOR:return this.getMateConnectorBounds(e);case k.lQt.ENTITY:let s=this.getEntityBounds(t,i);return s||(s=this.getEntityBounds(this.alternateEntityMapping.get(t),i)),s;case k.lQt.FEATURE:if(Hs()){const e=new wi.kB;return e.addBox((0,Sh.IO)().getManager().getFeatureBounds(t)),e.addBox((0,Sh.IO)().getPreviewManager().getFeatureBounds(t)),e}return this.getFeatureBounds(t);case k.lQt.BODY:let n=this.getBodyBounds(t,i);return n||(n=this.getBodyBounds(this.alternateEntityMapping.get(t),i)),n;case k.lQt.TABLE_ITEM:case k.lQt.OCCURRENCE:return i?this.getOccurrenceBounds(i):null;default:return null}}getElementRootNode(){const e=this.getSceneGraph().getRootNode();if(!e.getChildById(RE)){const t=new Gi.NB(RE);e.addChild(t,0),this.instantiateSharedNodes(t)}return e.getChildById(RE)}getElementPreviewRootNode(){const e=this.getSceneGraph().getRootNode();if(!e.getChildById(wE)){const t=new Gi.NB(wE);e.addChild(t),t.addChild(this.elementPreviewBodyNode)}return e.getChildById(wE)}cloneForPreview(e){const t=new Ih.B7("ModelViewManager.cloneForPreview"),i=new Ch(ys.L.PREVIEW,this.occurrenceDataManager,this.viewer),s=this.getDisplayedPartStudio();if(!s)throw"There is no base part studio to clone.";if(s.getElementId()!==e.elementId)throw"Displayed part studio does not match the part studio being previewed";i.sharedBaseMeshManager=this.meshManager.cloneForPreview(s.getMeshOwnerId());const n=s.cloneForPreview(i,!1);return i.partStudios[e.elementId]=n,i.displayedElementId=e.elementId,i.displayedElementType=k.GNh.PARTSTUDIO,i.setBodyLoadTasks(this.bodyLoadTasks),i.displayPartStudio(e.elementId),i.occurrenceDataManager=this.occurrenceDataManager,i.alternateEntityMapping=this.alternateEntityMapping,i.selectedSheetmetalModelId=this.selectedSheetmetalModelId,i.processManagedData(this.pendingPartStudioComputedData),t.report(),i}onPreviewDestroyed(){Object.values(this.partStudios).forEach((function(e){e.onPreviewDestroyed()}),this),this.partStudioPreservedForPreview&&(this.partStudioPreservedForPreview.onDeletion(),this.partStudioPreservedForPreview=null)}getPartStudioSortedForCache(){return Object.values(this.partStudios).sort((function(e,t){return e.getIsInternal()===t.getIsInternal()?e.microversionIdAndConfiguration.microversion.theId===t.microversionIdAndConfiguration.microversion.theId?e.microversionIdAndConfiguration.getKey()<t.microversionIdAndConfiguration.getKey()?-1:1:e.microversionIdAndConfiguration.microversion.theId<t.microversionIdAndConfiguration.microversion.theId?-1:1:e.getIsInternal()?-1:1}))}resetDisplayedElement(){this.displayedElementMicroversionIdAndConfiguration=null}onChangeActiveElement(e,t,i){if(this.clearSilhouetteRequests(),this.simulationManager&&this.simulationManager.clearSimulationAndConnectionGraphics(),this.viewer.getCurvatureAnalysisManager()?.onChangeActiveElement(),this.generativeDesignManager?.onChangeActiveElement(),this.displayingAssembly()){const e=this.assemblies[this.displayedElementId];e&&e.hide()}else this.displayingPartStudio()&&this.removePartStudioDisplay();this.displayedElementId="",this.displayedElementMicroversionIdAndConfiguration=null,this.displayedElementIsPublicationItem=void 0,this.partStudioVisibilityUpdated=!1,e?(this.displayedElementType=t,this.displayedElementType===k.GNh.PARTSTUDIO?(this.displayedElementId=e,this.displayedElementIsPublicationItem=i,this.displayedElementMicroversionIdAndConfiguration=null,this.viewer.requestDraw()):this.displayedElementType===k.GNh.ASSEMBLY?(this.displayedElementId=e,this.displayedElementIsPublicationItem=i,this.viewer.requestDraw()):this.displayedElementId=""):this.displayedElementId="",this.integrityCheck();!this.displayingPartStudio()&&this.viewer.getEdgePointController()&&this.viewer.getEdgePointController().disable()}displayingPartStudio(){return this.displayedElementType===k.GNh.PARTSTUDIO}displayingAssembly(){return this.displayedElementType===k.GNh.ASSEMBLY}getDisplayedElementId(){return this.displayedElementId}getDisplayedElement(){return this.displayingPartStudio()?this.partStudios[this.isBase()?this.getDisplayedFullElementId():this.displayedElementId]:this.displayingAssembly?this.assemblies[this.displayedElementId]:null}getDisplayedElementMicroversionId(e){if(e===ys.L.PREVIEW&&this.usage!==ys.L.PREVIEW)return this.applyToPreview(this.getDisplayedElementMicroversionId,arguments);const t=this.getDisplayedElement();return t&&t.microversionIdAndConfiguration&&t.microversionIdAndConfiguration.microversion?t.microversionIdAndConfiguration.microversion.theId:""}getDisplayedPartStudio(){return this.partStudios[this.getDisplayedFullElementId()]||null}getLastDisplayedPartStudio(){return this.partStudios[this.getLastDisplayedFullElementId()]||null}getDisplayedInContextAssembly(){const e=this.getDisplayedPartStudio();return e&&e.isDisplayingIncontextAssembly()?this.assemblies[e.getVisibleInContextAssemblyId()]:null}getDisplayedAssembly(){return this.assemblies[this.displayedElementId]||null}getPartStudioVisibilityUpdated(){return this.partStudioVisibilityUpdated}setPartStudioVisibilityUpdated(){this.getDisplayedPartStudio()&&(this.partStudioVisibilityUpdated=!0)}getInContextOccurrenceDisplayData(e){const t=this.getDisplayedPartStudio();if(t){const i=this.assemblies[t.getVisibleInContextAssemblyId()];if(i){const t=i.getDisplayDataForOccurrence(e);if(t)return t}}return null}getOccurrenceDisplayData(e){const t=this.assemblies[this.displayedElementId];return t?t.getOccurrenceDisplayData(e):this.getInContextOccurrenceDisplayData(e)}getMateConnectorGraphics(e,t){if(this.displayingAssembly()){const i=this.assemblies[this.displayedElementId];if(i)return i.getMateConnectorGraphics(e,t)}else if(this.displayingPartStudio()){if(e){const i=this.getDisplayedInContextAssembly();if(i)return i.getMateConnectorGraphics(e,t)}const i=this.partStudios[this.getDisplayedFullElementId()];if(i)return i.getMateConnectorGraphics(e,t)}return null}hasMateIndicatorForOccurrence(e){if(this.displayingAssembly()){const t=this.assemblies[this.displayedElementId];if(t)return t.hasMateIndicatorForOccurrence(e)}return!1}hasGraphicsOccurrenceData(e){return!!e.isAssemblyRoot()||!!this.getOccurrenceDisplayData(e)}getOccurrenceElementId(e){const t=this.getOccurrenceDisplayData(e);return t?t.fullElementId:null}getOccurrenceTransform(e){const t=this.getOccurrenceDisplayData(e);return t?t.occurrenceData.transform.getGlMatrix():ue.create()}updateOccurrenceTransform(e,t){const i=this.assemblies[this.displayedElementId];i&&i.updateOccurrenceTransform(e,t)}batchUpdateOccurrenceTransforms(e){if(0===e.length)return!0;const t=this.assemblies[this.displayedElementId];return!!t&&t.batchUpdateOccurrenceTransforms(e)}getPartStudios(){return Object.values(this.partStudios)}getPartStudioDataFromOccurrence(e){if(this.displayingAssembly()){if(!e)return Dh.warn("An attempt was made to retrieve an part studio data from an assembly without a specified occurrence"),null;const t=this.assemblies[this.displayedElementId];if(t){const i=t.getDisplayDataForOccurrence(e);if(i)return this.partStudios[i.fullElementId.toString()]||null}}else if(this.displayingPartStudio()){if(e){const t=this.getInContextOccurrenceDisplayData(e);if(t&&this.partStudios[t.fullElementId.toString()])return this.partStudios[t.fullElementId.toString()]}return this.partStudios[this.getDisplayedFullElementId()]||null}return null}getPartStudio(e){return(e=e.toString()).length>0&&e.length<=25&&"-"!==e&&this.isBase()&&Dh.info("An attempt was made to get part studio with id that is not in elementId-microversionId format"),this.partStudios[e]||null}getDeterministicIdForFeature(e,t,i){let s;const n=this,r=n.getEntitiesForFeature(e,t);return r&&(s=r.find((function(t){const s=n.retrieveEntityMetaData(e,t);if(s){const n=(0,Me.fl)(t,s,{},e);if(n&&(!i||i.filter(n)))return!0}return!1}))),s||""}getDeterministicIdForPickId(e,t){const i=e?this.getPartStudioDataFromOccurrence(e):this.getDisplayedPartStudio();return i?i.getEntityIdManager().getNameForId(t):null}retrieveEntityMetaData(e,t){if(!t)return null;if(t.startsWith(k.FBt.SECTION_IDENTIFIER)){const e=(0,lD.Ky)();return e?.getEntityMetaData(t)}let i=this.getDisplayedPartStudio();if(e&&(i=this.getPartStudioDataFromOccurrence(e)),!i)return null;let s=i.retrieveEntityMetaData(t);if(!s){const e=this.alternateEntityMapping.get(t);e&&(s=i.retrieveEntityMetaData(e))}return s}retrieveBodyMetaData(e,t){let i=this.getDisplayedPartStudio();if(e&&(i=this.getPartStudioDataFromOccurrence(e)),!i)return null;let s=i.retrieveBodyMetaData(t);return!s&&(s=this.applyToPreview(this.retrieveBodyMetaData,arguments)||null,s)?(s.foundInPreview=!0,s):s}retrieveAssociatedFeatureIds(e,t){let i=this.getDisplayedPartStudio();return e&&(i=this.getPartStudioDataFromOccurrence(e)),i?i.retrieveAssociatedFeatureIds(t):null}getFlattenedEntityOwnerBodyDetails(e,t){if(!this.viewer.getIsForFlattenedDisplay())return null;const i=this.retrieveEntityMetaData(t,e);if(!i)return null;const s=this.getPartStudioDataFromOccurrence(t);if(!s)return null;let n=null;if(n=i.isFromSketch()?s.getSketchComponent().getOwnerFlattenedBodyId(e):i.getBodyId(),!n)return null;const r=s.retrieveBodyMetaData(n);if(r){return{bodyMetaData:r,transform:s.getBodyComponent().getTransformFromSheetMetalBodyMetaData(r)}}return null}updatePSOI(e){const t=this.getDisplayedPartStudio();t&&t.updatePSOI(e)}getPartStudioBodyMetaDataAssociatedWithSelections(e){if(!this.displayingPartStudio())return[];const t=new Set;e&&t.add(e),(0,Me.vi)().each((function(e){if(!e.getOccurrence()){const i=e.getBodyId();i&&t.add(i)}}),this);const i=[];return t.forEach((e=>{const t=this.retrieveBodyMetaData(null,e);t&&i.push(t)})),i.filter((e=>!e.getIsFromSketch()))}getAssemblyOccurrencesAssociatedWithSelections(){if(!this.displayingAssembly())return[];const e=[];return(0,Me.vi)().forEach((t=>{e.push(t.getOccurrence().getPathAsString())})),e}hasEntity(e,t){return!!this.retrieveEntityMetaData(e,t)}hasFeature(e,t){const i=this.getCurrentPartStudioData(e);return!!i&&i.hasFeature(t)}getFirstMateConnectorId(e){const t=this.getCurrentPartStudioData(e);return t?t.mateConnectorComponent.featureToIds.firstKey():null}assemblyHasHiddenOccurrences(){const e=this.getDisplayedAssembly();if(e)for(const t in e.occurrences)if(e.occurrences[t].isHidden)return!0;return!1}getAllMateConnectorIds(e,t){let i=[];const s=this.getCurrentPartStudioData(e);if(s)i=s.mateConnectorComponent.getInstantiatedMateConnectorsForOccurrence(e);else if(this.displayingAssembly()&&e){const s=this.assemblies[this.displayedElementId];s&&(i=s.getMateConnectorIdsForOccurrence(e,t))}return i}hasBody(e,t){const i=this.getCurrentPartStudioData(e);return!!i&&i.hasBody(t)}getCurrentPartStudioData(e){return e?this.getPartStudioDataFromOccurrence(e):this.getDisplayedPartStudio()}hideSketch(e){const t=this.getDisplayedPartStudio();t&&t.hideSketch(e),this.applyToPreview(this.hideSketch,arguments)}retrieveSketchEntityDeterministicId(e,t){const i=this.getDisplayedPartStudio();return i?i.retrieveSketchEntityDeterministicId(e,t):null}showSketch(e){const t=this.getDisplayedPartStudio();t&&t.showSketch(e),this.applyToPreview(this.showSketch,arguments)}displaySketchAsActive(e){const t=this.getDisplayedPartStudio()||this.getLastDisplayedPartStudio();t&&t.displaySketchAsActive(e)}displaySketchAsInactive(e){const t=this.getDisplayedPartStudio();t&&t.displaySketchAsInactive(e)}hasActiveSketch(){const e=this.getDisplayedPartStudio();return!!e&&e.hasActiveSketch()}hideInactiveContextAssemblies(e){if(zs())return;const t=e.assemblyReferenceDisplayData,i=new mt.StringSet;let s;for(s=0;s<t.assemblyReferences.length;s++){const e=t.assemblyReferences[s],n=e.assemblyDisplayData,r=(0,Xs.HL)(n.elementId,t.elementId,e.referenceNodeId);i.add(r),e.visibility!==k.HRI.VISIBLE&&this.hideAssembly(r)}const n=this.getDisplayedPartStudio();if(n){const e=n.getReferencedInContextAssemblyIds();for(s=0;s<e.length;s++)i.contains(e[s])||this.hideAssembly(e[s])}}processInContextDisplayData(e,t){e.isBase()&&(this.viewer.getIsForFlattenedDisplay()?this.processInContextDisplayDataForFlat(e,t):this.viewer.getIsPrimaryViewer()&&this.processInContextDisplayDataFor3d(e,t))}processInContextDisplayDataFor3d(e,t){let i=!1;const s=e.assemblyReferenceDisplayData;for(let t=0;t<s.assemblyReferences.length;t++){const n=s.assemblyReferences[t],r=n.assemblyDisplayData;if(n.visibility!==k.HRI.VISIBLE)continue;r.elementId=(0,Xs.HL)(r.elementId,s.elementId,n.referenceNodeId);const a=[];n.occurrencesToExclude.forEach((function(e){a.push(e.getPathAsString())}));const o=[];r.occurrences.push(k.yLM.createRootOccurrenceDisplayData(r.elementId)),r.occurrences.forEach((function(e){const t=e.occurrenceData.occurrence.getPathAsString(),i=e.occurrenceData.transform.getGlMatrix(),s=n.transform.getGlMatrix(),r=ge.w$.multiply(s,i,ue.create());e.occurrenceData.transform.updateFromGlMatrix(r),o.push(e),a.indexOf(t)>=0&&(e.partIds=[],e.fullElementId=new k.lK7)})),r.occurrences=o,zs()||this.viewer.onRootAssemblyDisplayData(r,e),i=!0}i?(0,nM.xA)().trigger(nM.bh,i):e.isNoop||(0,nM.xA)().trigger(nM.bh,i)}processInContextDisplayDataForFlat(e,t){if(zs())return;const i=e.assemblyReferenceDisplayData;for(let e=0;e<i.assemblyReferences.length;e++){const s=i.assemblyReferences[e].assemblyDisplayData,n=!0;this.processPartStudioDisplayDataList(s.partStudioDisplayData,n,t)}}applyToPreview(e,t){if(this.isBase()){const i=this.viewer.getModelViewManagers().getPreviewManager();if(i)return e.apply(i,[...t])}return null}showConstructionPlane(e){const t=this.getDisplayedPartStudio();t&&t.showConstructionPlane(e),this.applyToPreview(this.showConstructionPlane,arguments),this.viewer.requestDraw()}hideMateConnector(e,t){const i=this.getDisplayedPartStudio();i&&i.hideMateConnector(e,t),this.applyToPreview(this.hideMateConnector,arguments),this.viewer.requestDraw()}showMateConnector(e,t){const i=this.getDisplayedPartStudio();i&&i.showMateConnector(e,t),this.applyToPreview(this.showMateConnector,arguments),this.viewer.requestDraw()}hideFeatureBodies(e,t){const i=this.getDisplayedPartStudio();i&&i.hideFeatureBodies(e,t),this.applyToPreview(this.hideFeatureBodies,arguments),this.viewer.requestDraw()}showFeatureBodies(e,t){const i=this.getDisplayedPartStudio();i&&i.showFeatureBodies(e,t),this.applyToPreview(this.showFeatureBodies,arguments),this.viewer.requestDraw()}hideConstructionPlane(e){const t=this.getDisplayedPartStudio();t&&t.hideConstructionPlane(e),this.applyToPreview(this.hideConstructionPlane,arguments),this.viewer.requestDraw()}hidePart(e){let t=!1;const i=this.getDisplayedPartStudio();return i&&(t=i.hidePart(e)),this.applyToPreview(this.hidePart,arguments),this.viewer.requestDraw(),t}showPart(e){let t=!1;const i=this.getDisplayedPartStudio();return i&&(t=i.showPart(e)),this.applyToPreview(this.showPart,arguments),this.viewer.requestDraw(),t}setPlaneAppearance(e,t){const i=this.getDisplayedPartStudio();i&&(i.setPlaneAppearance(e,t),this.viewer.requestDraw()),this.applyToPreview(this.setPlaneAppearance,arguments)}hidePointBodies(e){const t=this.getDisplayedPartStudio();t&&(t.hidePointBodies(e),this.applyToPreview(this.hidePointBodies,arguments),this.viewer.requestDraw())}showPointBodies(e){const t=this.getDisplayedPartStudio();t&&(t.showPointBodies(e),this.applyToPreview(this.showPointBodies,arguments),this.viewer.requestDraw())}changePartColor(e,t,i){const s=this.getDisplayedPartStudio();s&&(s.changePartColor(e,t,i),this.viewer.requestDraw())}changePartOpacity(e,t,i){const s=this.getDisplayedPartStudio();s&&(s.changePartOpacity(e,t,i),this.viewer.requestDraw())}getPartColor(e){const t=this.getDisplayedPartStudio();return t?t.getPartColor(e):null}getPartOpacity(e){const t=this.getDisplayedPartStudio();return t?t.getPartOpacity(e):-1}getOccurrenceColor(e){const t=this.getPartStudioDataFromOccurrence(e);return t?t.getBodyComponent(e).getOccurrenceColor(e):null}setOccurrenceAlphaModifier(e,t){const i=this.getPartStudioDataFromOccurrence(e);i&&i.getBodyComponent(e).setOccurrenceAlphaModifier(e,t)}clearOccurrenceAlphaModifier(e){const t=this.getPartStudioDataFromOccurrence(e);t&&t.getBodyComponent(e).clearOccurrenceAlphaModifier(e)}addTemporarySketchComponent(e){this.temporarySketchComponents[e.getUniqueId()]=e}removeTemporarySketchComponent(e){delete this.temporarySketchComponents[e.getUniqueId()]}processEntitiesHighlight(e,t,i,s){let n=TE.KF;const r=this.getPartStudioDataFromOccurrence(t);if(t&&(n=this.viewer.getOccurrenceIdManager().getIdForName(t.getPathAsString())),n!==TE.Qy)for(let t=0;t<i.length;++t){const a=i[t];r.updateEntityHighlight(e,s,a,n),this.updateTemprorarySketchHighlights(e,s,a,n);const o=this.alternateEntityMapping.get(a);if(o){const t=o.split(Dn.ID_SEPARATOR);for(let i=0;i<t.length;i++)r.updateEntityHighlight(e,s,t[i],n)}}}updateTemprorarySketchHighlights(e,t,i,s){for(const n in this.temporarySketchComponents)this.temporarySketchComponents[n].updateEntityHighlight(e,t,i,s)}getDimensionGraphic(e,t){let i=null;return this.displayedElementType===k.GNh.PARTSTUDIO&&(i=this.getDisplayedPartStudio()),i?i.getDimensionGraphic(e,t):null}processOccurrenceHighlight(e,t,i){const s=i.cloneForOccurrence(t);let n;if(t&&t.path[0]===_m.PART_STUDIO_BODY_OCCURRENCE_PREFIX)n=[t];else{const i=this.assemblies[this.displayedElementId];if(!i)return;n=i.getLeafOccurrencesContainedWithinOccurrence(t);for(let t=0;t<n.length;++t){const r=i.getOccurrenceEntityIdsForHighlight(n[t]);r.length>0&&this.processEntitiesHighlight(e,n[t],r,s)}}this.viewer.getBodyManager().onOccurrencesHighlighted(e,n),this.occurrenceDataManager.processHighlightForOccurrences(e,n,s,this.usage)}getOccurrenceIdForSelection(e){if(e.getOccurrence())return this.viewer.getOccurrenceIdManager().getIdForName(e.getOccurrence().getPathAsString());{const t=this.getPartStudioDataFromOccurrence(e.getOccurrence());if(t)return t.getPartStudioOccurrenceIdForSelection(e)}return TE.Qy}getEntityIdsForSelection(e){let t=null;const i=this.getPartStudioDataFromOccurrence(e.getOccurrence());return i&&(t=i.getEntityIdsForSelection(e)),t||[]}getEntitiesForFeature(e,t,i){let s=this.displayedPartStudio;return e&&(s=this.getPartStudioDataFromOccurrence(e)),s?s.getEntitiesForFeature(t,i):null}getFeatureIdsRelatedToBody(e,t){const i=e?this.getPartStudioDataFromOccurrence(e):this.getDisplayedPartStudio();if(!i)return[];const s=new Set,n=i.getEntitiesForBody(t);for(let t=0;t<n.length;++t){const r=i.retrieveEntityMetaData(n[t]);if(r){const e=r.getFeatureIds();for(let t=0;t<e.length;++t)s.add(e[t])}for(const i of this.retrieveAssociatedFeatureIds(e,n[t]))s.add(i)}for(const i of this.retrieveAssociatedFeatureIds(e,t))s.add(i);return[...s]}getBodyIdsRelatedToFeature(e,t){const i=e?this.getPartStudioDataFromOccurrence(e):this.getDisplayedPartStudio();if(!i)return[];const s=i.getEntitiesForFeature(t),n=new Set;for(let e=0;e<s.length;++e){const t=i.retrieveEntityMetaData(s[e]);t&&n.add(t.getBodyId())}return[...n]}getEntitiesForBody(e,t){const i=this.getPartStudioDataFromOccurrence(e);return i?i.getEntitiesForBody(t):null}getIncrementsForFeature(e,t){const i=this,s=[],n=i.getEntitiesForFeature(e,t);return n&&n.forEach((function(t){const n=i.extractMeshIncrement(t,e);n&&s.push(n)})),s}extractMeshIncrement(e,t){if(e?.startsWith(k.FBt.SECTION_IDENTIFIER)){const t=(0,lD.Ky)();return t?.extractMeshIncrement(e)??null}let i=this.getDisplayedPartStudio();return t&&(i=this.getPartStudioDataFromOccurrence(t)),i?i.extractMeshIncrement(e):null}isEntityOnOccurrence(e,t){const i=this.getOccurrenceDisplayData(t);if(!i)return!1;const s=this.retrieveEntityMetaData(t,e);return!!s&&(this.occurrenceContainsBody(i,s.getBodyId())||i.containsPart(e))}occurrenceContainsBody(e,t){if(e.containsPart(t))return!0;const i=this.partStudios[e.fullElementId.toString()];if(!i)return!1;if(i.getSketchComponent().hasBody(t)){if(e.sketchFeatureId)return i.getSketchComponent().doesSketchContainBody(e.sketchFeatureId,t);{const s=i.getEntitiesForBody(t);for(let t=0;t<s.length;++t)if(e.containsPart(s[t]))return!0}}const s=i.retrieveBodyMetaData(t);if(!s)return!1;if(s.isClosedCompositeConstituent&&e.containsPart(s.consumingClosedCompositeData.id))return!0;if(s.referencingOpenCompositeData)for(const[t,i]of s.referencingOpenCompositeData)if(e.containsPart(t))return!0;return!1}isNodeForModel(e){return e.getId()===RE||!!e.getParent()&&this.isNodeForModel(e.getParent())}isNodeForSketch(e){return e.getId()===Vm}isNodeForBody(e,t){return e===this.bodyNode||0===e.getId().indexOf(om)||!!t&&(this.simulationManager?.isNodeForBodyVisualization(e)||this.thicknessAnalysisManager?.isNodeForBodyVisualization(e)||this.viewer.getCurvatureAnalysisManager()?.isNodeForBodyVisualization(e))}isNodeForFaces(e){return e.isFaces()}isNodeForEdges(e){return e.isEdges()}isNodeForPoints(e){return e.isPoints()}handleAllSelectionListHighlights(){const e=this.viewer.getFilteredEntitiesHighlightController()?.getSelectionList();!this.selectionListNameToListAndHighlightType.get(Iy.SELECTION_LIST_NAME)&&e&&this.handleSelectionListHighlights(Iy.SELECTION_LIST_NAME,e,Cn.o2.FILTERED_ENTITIES),this.viewer.getIsForPreviousVersionDisplay()||(this.handleSelectionListHighlights("selectionList",(0,Me.vi)()),this.handleSelectionListHighlights("preselectionList",(0,Me.Wf)(),Cn.o2.PRE),this.handleSelectionListHighlights("secondarySelectionList",(0,Me.wT)(),Cn.o2.SECONDARY),this.handleSelectionListHighlights("secondaryPreSelectionList",(0,Me.Dk)(),Cn.o2.SECONDARY_PRE),this.handleSelectionListHighlights("smartSelectionList",(0,Me.PV)(),Cn.o2.SMART_SELECTION),this.handleSelectionListHighlights("accumulatedSmartSelections",(0,Me.Tb)(),Cn.o2.ACCUMULATED_SMART_SELECTION),this.handleSelectionListHighlights("commentSelectionList",(0,Me.d7)(),Cn.o2.COMMENT),this.handleSelectionListHighlights("errorSelectionList",(0,Me.yb)(),Cn.o2.ERROR),this.handleSelectionListHighlights("profileInspectorSelectionList",(0,Me.CY)(),Cn.o2.PROFILE_INSPECTOR),this.handleSelectionListHighlights("profileInspectorFocusSelectionList",(0,Me.QQ)(),Cn.o2.PROFILE_INSPECTOR_FOCUS),this.handleSelectionListHighlights("retrievalSelectionList",(0,Me.iH)(),Cn.o2.RETRIEVAL),this.handleSelectionListHighlights("annotationReferencesSelectionList",(0,Me.oK)(),Cn.o2.ANNOTATION_REFERENCES))}resetSelectionListHandlers(){for(const e of this.selectionListNameToListAndHighlightType.values())this.stopListening(e.selectionList);this.selectionListNameToListAndHighlightType.clear(),this.handleAllSelectionListHighlights(),this.meshPointController&&this.meshPointController.resetSelectionListHandlers()}handleSelectionListHighlights(e,t,i){this.selectionListNameToListAndHighlightType.get(e)&&(Dh.warn(`Attempt to add selectionList with duplicate name ${Me.o$} to handle selections for. Removing the old one before adding the new one.`),this.removeSelectionListHandler(e)),this.selectionListNameToListAndHighlightType.set(e,{selectionList:t,highlightType:i});const s=this;this.selectionsToClearOnReset[e]={},this.listenTo(t,"add",(function(t){s.processSelectionHighlight(Cn.aU.ADD,t,e,i)})),this.listenTo(t,"remove",(function(t){s.processSelectionHighlight(Cn.aU.REMOVE,t,e,i)})),this.listenTo(t,"reset",(function(t){s.resetSelectionListHighlights(t,e,i)})),t.each((function(t){s.processSelectionHighlight(Cn.aU.ADD,t,e,i)}))}removeSelectionListHandler(e){const t=this.selectionListNameToListAndHighlightType.get(e);t&&(this.clearSelectionHighlight(e,t.highlightType),this.stopListening(t.selectionList),this.selectionListNameToListAndHighlightType.delete(e)),delete this.selectionsToClearOnReset[e]}resetSelectionListHighlights(e,t,i){this.clearSelectionHighlight(t,i),e.each((e=>{this.processSelectionHighlight(Cn.aU.ADD,e,t,i)}))}updateOrVerifySelections(e,t){if(!this.viewer.getIsPrimaryViewer())return;const i=this;(0,Me._g)().forEach((function(s){i.updateOrVerifySelectionsInList(e,t,s)}))}updateOrVerifySelectionsInList(e,t,i){const s=[];let n=!1,r=!0;const a=this,o={},h=(0,Me.VT)(),c=!h||!h.getReceivesComputedData();return i.each((function(i){let h=i;if(h.getUsage()!==a.usage)return;e&&(h=e.updateSelection(h,t),h=h||i);let l=!c&&!!h;if(h&&c)switch(h.getType()){case k.lQt.ENTITY:l=a.hasEntity(h.getOccurrence(),h.getIdString())||h.isSectionEntity();break;case k.lQt.FEATURE:case k.lQt.FOLDER:case k.lQt.ROLLBACKBAR:l=!0;break;case k.lQt.BODY:l=a.hasBody(h.getOccurrence(),h.getIdString());break;case k.lQt.MATE_CONNECTOR:case k.lQt.OCCURRENCE:case k.lQt.MATE:case k.lQt.NON_GEOMETRIC_ITEM:case k.lQt.SIMULATION_LOAD:case k.lQt.EDGE_POINT:case k.lQt.MESH_POINT:case k.lQt.TABLE_ITEM:l=!0}l?(n=n||h.getIdString()!==i.getIdString(),o.hasOwnProperty(h.id)?(s[o[h.id]]=h,n=!0):(o[h.id]=s.length,s.push(h))):(n=!0,r=r&&i.isInContextSubFeature())})),n&&i.reset(s,{suppressServerCalls:r,isForRemapping:!0}),n}clearHighlights(){for(const[e,t]of this.selectionListNameToListAndHighlightType.entries())this.clearSelectionHighlight(e,t.highlightType)}refreshHighlight(){const e=this,t=function(t,i,s){i.each((function(n){n.isMeshPoint()&&n.getMeshPointData()?e.meshPointController.addSelection(n,i):e.processSelectionHighlight(Cn.aU.ADD,n,t,s)}))};for(const[e,i]of this.selectionListNameToListAndHighlightType.entries())t(e,i.selectionList,i.highlightType)}handlesHighlightForSelection(e,t){if(e.getUsage()!==this.usage)return!1;if(t===Cn.o2.PRE&&e.source===Me.Hw.PICK&&Th.getNumber("INHIBIT_PREHIGHLIGHT"))return!1;switch(e.getType()){case k.lQt.ENTITY:case k.lQt.FEATURE:case k.lQt.BODY:case k.lQt.OCCURRENCE:case k.lQt.MATE:case k.lQt.MATE_CONNECTOR:case k.lQt.EDGE_POINT:case k.lQt.TABLE_ITEM:case k.lQt.SKETCH_GROUP:case k.lQt.NON_GEOMETRIC_ITEM:case k.lQt.PROPERTY:case k.lQt.SIMULATION_LOAD:case k.lQt.FOLDER:case k.lQt.ANNOTATION:case k.lQt.DIMENSION:return!0}return!1}getHighlightTypeForSelection(e,t){if(t===Cn.o2.PRE&&(e.isOccurrence()||e.isFolder()))return Cn.o2.OCCURRENCE_PRE;if(t===Cn.o2.SECONDARY_PRE&&e.isOccurrence())return Cn.o2.OCCURRENCE_SECONDARY_PRE;if(t===Cn.o2.COMMENT&&e.isOccurrence())return Cn.o2.OCCURRENCE_COMMENT;if(t)return t;switch(e.getType()){case k.lQt.ENTITY:return Cn.o2.ENTITY;case k.lQt.FEATURE:case k.lQt.SKETCH_GROUP:return Cn.o2.FEATURE;case k.lQt.BODY:return Cn.o2.PART;case k.lQt.FOLDER:case k.lQt.OCCURRENCE:case k.lQt.NON_GEOMETRIC_ITEM:return Cn.o2.OCCURRENCE;case k.lQt.TABLE_ITEM:if(e.getOccurrence())return Cn.o2.OCCURRENCE}return Cn.o2.UI}processSelectionHighlight(e,t,i,s,n,r){if(!t||!this.handlesHighlightForSelection(t,s))return;const a=this.getDisplayedElement();if(!a)return;const o=!s||s===Cn.o2.PRE;s=this.getHighlightTypeForSelection(t,s);let h=!1;if(t.isFromBody()&&(t.isBody()||t.isFace())){let e;e=t.isBody()?t.getBodyMetaData():t.getEntityMetaData().getBodyMetaData(),e&&(!e.isModifiableBody()||ks()&&t.isBody())&&(h=!0)}const c=this.viewer.getHighlightManager(this.usage),l=c.createHighlightForSelection(s,t.getIdForCollection(),h),d=this.getEntityIdsForSelection(t),u=a.getInContextImportEntityIdsForSelection(t),g=s===Cn.o2.PRE?Cn.o2.INCONTEXT_REFERENCE_PRE:Cn.o2.INCONTEXT_REFERENCE,p=n?[]:a.getOccurrencesForSelection(t);let m=!t.isEntity()||t.isFromConstructionGeometry()||this.addDerivedEntityHighlights;s!==Cn.o2.COMMENT||t.isPlane()||(m=!1);let f=[];if(r||!m&&e===Cn.aU.ADD||(f=this.viewer.getEdgePointController()&&t.isEdgePoint()?this.viewer.getEdgePointController().getUIElementsForSelection(t):t.getOccurrence()&&this.getDisplayedInContextAssembly()?this.getDisplayedInContextAssembly().getUIElementsForSelection(t):a.getUIElementsForSelection(t)),this.processUiHighlights(e,f,t,i,l),t.isMateConnector()||t.isMate()||t.isMateRelation()||t.isExplodeStep()||t.isNonGeometricItem()||t.isSimulationLoad())this.processSecondaryAssemblyFeatureHighlights(e,p,t,i,s);else if(d&&d.length>0&&this.processEntitiesHighlight(e,t.getOccurrence(),d,l),u&&u.length>0&&o&&this.processEntitiesHighlight(e,t.getOccurrence(),u,c.createHighlightForSelection(this.getHighlightTypeForSelection(t,g),t.getIdForCollection())),p&&p.length>0&&m){const n=t.isBody()&&!!t.getOccurrence();let r=l;(t.isEntity()||n||t.isFeature())&&(e===Cn.aU.ADD&&(this.selectionsToClearOnReset[i][t.getIdForCollection()]=t),r=s===Cn.o2.FEATURE?c.createSecondaryHighlight(Cn.o2.OCCURRENCE,Cn.o2.OCCURRENCE,t.getIdForCollection()):c.createSecondaryHighlight(s===Cn.o2.PRE?Cn.o2.ASSOCIATED_OCCURRENCE_PRE:Cn.o2.ASSOCIATED_OCCURRENCE,s,t.getIdForCollection()));for(let t=0;t<p.length;++t)this.processOccurrenceHighlight(e,p[t],r);r.associatedPrimaryHighlightType&&e===Cn.aU.REMOVE&&c.freeSecondaryHighlight(r.type,r.associatedPrimaryHighlightType,t.getIdForCollection())}e===Cn.aU.REMOVE&&(c.freeHighlightForSelection(s,t.getIdForCollection()),o&&c.freeHighlightForSelection(g,t.getIdForCollection())),this.viewer.requestDraw()}processUiHighlights(e,t,i,s,n){if(!t||t.length<=0)return;let r=!0;for(let i=0;i<t.length;++i)e===Cn.aU.ADD?t[i].addHighlight(n):r=r&&t[i].removeHighlight(n);e===Cn.aU.ADD?this.selectionsToClearOnReset[s][i.getIdForCollection()]=i:r&&delete this.selectionsToClearOnReset[s][i.getIdForCollection()]}processSecondaryAssemblyFeatureHighlights(e,t,i,s,n){const r=this.getDisplayedElement();if(!r)return;const a=i.getIdForCollection()+Dn.ID_SEPARATOR+n,o=this.viewer.getHighlightManager(this.usage);let h,c;c=i.isMateConnector()||i.isMate()&&i.featureType!==mi.T.MATE_GROUP?o.createSecondaryHighlight(Cn.o2.RELATED_OCCURRENCE_MATE,n,i.getIdForCollection()):o.createSecondaryHighlight(Cn.o2.RELATED_OCCURRENCE,n,i.getIdForCollection());const l=n===Cn.o2.UI?Cn.o2.UI_RELATED_ENTITY:n;if(e===Cn.aU.ADD){const e=this.secondaryOccurrenceHighlights[a];if(e&&e.length>0){for(h=0;h<e.length;++h)this.processOccurrenceHighlight(Cn.aU.REMOVE,e[h],c);delete this.secondaryOccurrenceHighlights[a]}this.secondaryOccurrenceHighlights[a]=t}else t=this.secondaryOccurrenceHighlights[a],delete this.secondaryOccurrenceHighlights[a];for(h=0;t&&h<t.length;++h)this.processOccurrenceHighlight(e,t[h],c);if(this.displayingAssembly()){let t;if(this.secondaryEntityHighlights.hasOwnProperty(a))for(t=this.secondaryEntityHighlights[a],delete this.secondaryEntityHighlights[a],h=0;t&&h<t.length;++h)if(!this.updateSecondaryEntityHighlightRepeatCount(t[h],s,n,!1)){const e=!t[h].isAssemblyOrigin(),i=!t[h].isAssemblyOrigin();this.processSelectionHighlight(Cn.aU.REMOVE,t[h],s,l,e,i)}if(e===Cn.aU.ADD)for(t=r.getEntitiesForNonInstanceSelection(i),this.secondaryEntityHighlights[a]=t,h=0;t&&h<t.length;++h){this.updateSecondaryEntityHighlightRepeatCount(t[h],s,n,!0)||Dh.warn("Adding highlight should always result in an existing entity highlight");const i=!t[h].isAssemblyOrigin(),r=!t[h].isAssemblyOrigin();this.processSelectionHighlight(e,t[h],s,l,i,r)}}e===Cn.aU.ADD?this.selectionsToClearOnReset[s][i.getIdForCollection()]=i:o.freeSecondaryHighlight(Cn.o2.RELATED_OCCURRENCE,n,i.getIdForCollection())}updateSecondaryEntityHighlightRepeatCount(e,t,i,s){const n=e.id+t+i.toString();let r=this.secondaryEntityHighlightSelectionRepeats[n];return r||(r=0),s?r++:r--,r>0?(this.secondaryEntityHighlightSelectionRepeats[n]=r,!0):(delete this.secondaryEntityHighlightSelectionRepeats[n],!1)}clearHighlight(e,t,i){const s=this.viewer.getReferenceHighlights().highlights[e];this.occurrenceDataManager.clearHighlight(s,this.usage),this.clearIndividualHighlights(s,t,i),this.viewer.getHighlightManager(this.usage).resetHighlightInstanceIds(e),e===Cn.o2.PRE?(this.clearHighlight(Cn.o2.OCCURRENCE_PRE,t,i),this.clearHighlight(Cn.o2.ASSOCIATED_OCCURRENCE_PRE,t,i),this.clearHighlight(Cn.o2.INCONTEXT_REFERENCE_PRE,t,!0)):e===Cn.o2.SECONDARY_PRE?this.clearHighlight(Cn.o2.OCCURRENCE_SECONDARY_PRE,t,i):e===Cn.o2.COMMENT&&this.clearHighlight(Cn.o2.OCCURRENCE_COMMENT,t,i),this.viewer.requestDraw()}clearSelectionHighlight(e,t){t?this.clearHighlight(t,e,!0):(this.clearHighlight(Cn.o2.ENTITY,e,!1),this.clearHighlight(Cn.o2.FEATURE,e,!1),this.clearHighlight(Cn.o2.PART,e,!1),this.clearHighlight(Cn.o2.OCCURRENCE,e,!1),this.clearHighlight(Cn.o2.UI,e,!0),this.clearHighlight(Cn.o2.INCONTEXT_REFERENCE,e,!0))}clearIndividualHighlights(e,t,i){const s=this.selectionsToClearOnReset[t];if(!s)return;const n=Object.keys(s);for(let i=0;i<n.length;++i)this.processSelectionHighlight(Cn.aU.REMOVE,s[n[i]],t,e.type);i&&(this.selectionsToClearOnReset[t]={})}getOccurrencesStartingWithPath(e){const t=this.assemblies[this.displayedElementId];return t?t.getLeafOccurrencesContainedWithinOccurrence(e):[]}getOccurrenceBounds(e){const t=this.assemblies[this.displayedElementId];return t?(this.getSceneGraph().updateBounds(),t.getOccurrenceBounds(e)):null}setPlaneName(e,t,i){const s=this.getDisplayedPartStudio();s&&s.getElementId()===e&&(s.setPlaneName(t,i),Hs()||this.applyToPreview(this.setPlaneName,arguments))}setAddDerivedEntityHighlights(e){this.addDerivedEntityHighlights!==e&&(this.clearHighlights(),this.addDerivedEntityHighlights=e,this.refreshHighlight())}getAddDerivedEntityHighlights(){return this.addDerivedEntityHighlights}isActiveElementEditingInContext(){const e=this.partStudios[this.getDisplayedFullElementId()];return!!e&&e.isDisplayingIncontextAssembly()}isDisplayingIncontextAssembly(){const e=this.getDisplayedPartStudio();return!!e&&e.isDisplayingIncontextAssembly()}isolateAllPartStudioBodies(){const e=this.getDisplayedPartStudio();if(!e)return;const t=e.getPartStudioOccurrenceIds(),i=this.viewer.getIsolatedOccurrenceManager();this.isBase()?i?.setIsolatedOccurrenceIds(t):i?.addIdsToIsolate(t);const s=e.getAllMateConnectorGraphics(null).map((e=>e.getOccurrenceData().getOccurrenceId()));i?.addIdsToIsolate(s),Qe(1),this.viewer.requestDraw()}clearIsolatedBodies(){this.viewer.getIsolatedOccurrenceManager()?.clearAllIsolateNoAnimation()}switchIsolateActiveElement(e){this.viewer.getIsolatedOccurrenceManager()?.switchActiveElement(e)}getModelStatistics(e,t=!1,i=!0){const s=new sm;let n;for(n in this.partStudios)this.partStudios[n].addStatistics(s,e,t,i);if(e){for(n in this.assemblies)this.assemblies[n].addStatistics(s);this.isPerformanceMememoryAvailable()&&(s.totalJSHeapSize=window.performance.memory.totalJSHeapSize,s.usedJSHeapSize=window.performance.memory.usedJSHeapSize,s.jsHeapSizeLimit=window.performance.memory.jsHeapSizeLimit)}return s}isPerformanceMememoryAvailable(){return!!window.performance.memory}removeSelectionHighlights(){const e=this;(0,Me.vi)().each((function(t){e.processSelectionHighlight(Cn.aU.REMOVE,t,"selectionList")}))}reAddSelectionHighlights(){const e=this;(0,Me.vi)().each((function(t){e.processSelectionHighlight(Cn.aU.ADD,t,"selectionList")}))}hideAssembly(e){const t=this.assemblies[e];t&&t.hide()}showAssembly(e,t){const i=this.assemblies[e];i&&i.show(t)}getInstantiatedTriangleCount(){let e=0;for(const t in this.partStudios)e+=this.partStudios[t].getInstantiatedTriangleCount();return e}showPartsWithSheetmetalModelIdOnly(e){const t=this.getDisplayedPartStudio();if(t&&(e||this.selectedSheetmetalModelId)&&(t.getBodyComponent(null).showPartsWithSheetmetalModelIdOnly(e),t.getSketchComponent().showPartsWithSheetmetalModelIdOnly(e),t.getImageComponent().showPartsWithSheetmetalModelIdOnly(e),t.getDimensionComponent().showDimensionsWithSheetmetalModelIdOnly(e,t)),this.selectedSheetmetalModelId!==e){this.selectedSheetmetalModelId=e;for(const[e,t]of this.selectionListNameToListAndHighlightType.entries())this.resetSelectionListHighlights(t.selectionList,e,t.highlightType);this.fitToSelectedSheetMetalModel(),this.viewer.getEventDispatcher().trigger(nM.Hq,e),this.viewer.requestDraw()}}fitToSelectedSheetMetalModel(){this.lastFitSheetMetalModelId===this.selectedSheetmetalModelId||this.viewer.isHidden()||!this.viewer.getPrimaryViewController()||(this.viewer.getPrimaryViewController().setStandardView(this.viewer.getDefaultStandardView()),this.viewer.setViewInitialized(!1),this.viewer.requestDraw(),this.lastFitSheetMetalModelId=this.selectedSheetmetalModelId)}hasSelectedSheetmetalModelId(){return!!this.selectedSheetmetalModelId}getSelectedSheetmetalModelId(){return this.selectedSheetmetalModelId}isBodyEntityMeasurable(e,t){const i=this.getDisplayedPartStudio();return!!i&&i.getBodyComponent(null).isEntityMeasurable(e,t)}needsDisplayData(e){let t=!1;for(const i in this.partStudios)e.elementId===this.partStudios[i].id&&(t=t||this.partStudios[i].getBodyComponent(null).needsDisplayData(e));return t}getOccurrenceSketchFeatureId(e){const t=this.getPartStudioDataFromOccurrence(e),i=this.viewer.getOccurrenceIdManager().getIdForName(e.getPathAsString());return t&&i!==TE.Qy?t.getSketchComponent().getFeatureIdForOccurrence(i):null}getDescriptionOfLastProcessedPartStudio(){return this.lastPartStudioProcessed+" : "+this.lastPartStudioMicroversionIdAndConfigurationIntervalProcessed[this.lastPartStudioProcessed]}isOccurrenceIdForInContext(e){const t=this.getDisplayedPartStudio();if(t){const i=this.assemblies[t.getVisibleInContextAssemblyId()];if(i){const t=this.viewer.getOccurrenceIdManager().getNameForId(e);return!!i.getDisplayDataForOccurrencePath(t)}}return!1}hideEntityFromPick(e,t,i){const s=this.getPartStudioDataFromOccurrence(i);if(s){const i=this.viewer.getOccurrenceDataManager().getOccurrenceData(t);if(i){const t=s.getMeshManager().getIncrementDetails(e,s.getMeshOwnerId());t&&i.hideIncrementFromPick(t,this.usage)}}}hideBodyFromPick(e,t,i){const s=this.getPartStudioDataFromOccurrence(i);if(s){const n=this.viewer.getOccurrenceDataManager().getOccurrenceData(t),r=this.retrieveBodyMetaData(i,e);if(r?.isCompositeConstituent){const t=s.getEntitiesForBody(e);for(let e=0;t&&e<t.length;++e){const i=s.getMeshManager().getIncrementDetails(t[e],s.getMeshOwnerId());i&&n.hideIncrementFromPick(i,this.usage)}}else n&&(n.isHiddenFromPick=!0)}}setDebugFaceTriangles(e){Object.values(this.partStudios).forEach((function(t){t.getBodyComponent().setDebugFaceTriangles(e)})),this.simulationManager&&this.simulationManager.setDebugMeshEdges(e)}clearSubFeaturesShownByParameters(){this.subFeaturesShownByParameters={}}getSubFeaturesShownByParameters(){return this.subFeaturesShownByParameters}collectComponentsForHeapDump(e){for(const t in this.partStudios)this.partStudios[t].collectComponentsForHeapDump(e);mE()}setExplodeViewActive(e){const t=this.getDisplayedAssembly();t&&t.setExplodeViewActive(e)}onStartEditingAssemblyFeature(e){const t=this.getDisplayedAssembly();t&&t.setEditState(e,!0)}onStopEditingAssemblyFeature(e){const t=this.getDisplayedAssembly();t&&t.setEditState(e,!1)}refreshSmoothEdgesForAllPartStudios(e){for(const t in this.partStudios){const i=this.partStudios[t],s=i.getBodyComponent();if(s){const t=this.viewer.getSmoothEdgesRenderStyle();if(!e){t===k.YUG.VISIBLE&&i.setIsMissingTangencyInformationMessageShown(!1);const e=this.getDisplayedPartStudio()===i;if(this.viewer.getSmoothEdgesRenderStyle()!==k.YUG.VISIBLE&&s.hasDisplayedEdgesWithOutdatedSmoothnessInfo()){if(!e)return this.viewer.showTangencyInformationMissingMessage(),i.setIsMissingTangencyInformationMessageShown(!0),!1;this.updateSmoothEdgesForDisplayedPartStudio()}}}}return!0}updateSmoothEdgesForDisplayedPartStudio(){this.viewer.getIsForFlattenedDisplay()||(this.isBase()?Dh.debug("Triggered smooth edge update from base viewer"):Dh.debug("Triggered smooth edge update from preview"),this.viewer.getEventDispatcher().trigger(nM.Uj))}processSmoothEdgeUpdate(e){for(let t=0;t<e.tangencyReponses.length;++t){const i=e.tangencyReponses[t],s=this.getPartStudio(i.source);s?s.getBodyComponent().updateEdgeSmoothness(i.edgeDeterministicIDToIsSmoothMap):Dh.warn("Part Studio not found when applying smooth edge response")}this.refreshSmoothEdgesForAllPartStudios(!0),this.viewer.requestDraw()}onAppearanceConstantsUpdated(){for(const e of Object.values(this.partStudios))e.onAppearanceConstantsUpdated();for(const e of Object.values(this.temporarySketchComponents))e.onAppearanceConstantsUpdated()}onRenderingModeChanged(){for(const e of Object.values(this.partStudios))e.onRenderingModeChanged()}getDisplayedElementMicroversionIdAndConfiguration(){return this.displayedElementMicroversionIdAndConfiguration}setTranslucentModeFaceOpacity(e){for(const t of Object.values(this.partStudios))t.getBodyComponent().setTranslucentModeFaceOpacity(e);this.applyToPreview(this.setTranslucentModeFaceOpacity,arguments)}}class Mh{constructor(e,t){this.occurrenceDataManager=e,this.viewer=t,this.modelViewManagers={},this.lastPreviewedPartStudioId=null,(0,Sh.Yk)(t),this.viewer.getEventDispatcher().on(nM.so,(()=>{this.clearTheManagers()}))}getManager(){const e=ys.L.BASE;let t=this.modelViewManagers[e];return t||(t=new Ch(e,this.occurrenceDataManager,this.viewer),this.modelViewManagers[e]=t),t}clearTheManagers(){Object.values(this.modelViewManagers).forEach((function(e){e&&e.onDeletion()})),this.modelViewManagers={}}getManagerForUsage(e){return e===ys.L.BASE?this.getManager():e===ys.L.PREVIEW?this.getPreviewManager():null}getPreviewManager(e){const t=this.getManager().bodyLoadTasks,i=e?e.buildFullElementId(!0):null;if(!i||this.modelViewManagers[ys.L.PREVIEW]&&i.elementId===this.lastPreviewedPartStudioId){const e=this.modelViewManagers[ys.L.PREVIEW];return e&&t&&t.completeTasks(),e}{t&&t.completeTasks(),this.resetPreviewManager();const e=this.getManager().cloneForPreview(i);return this.modelViewManagers[ys.L.PREVIEW]=e,this.lastPreviewedPartStudioId=i.elementId,e}}previewManagerExists(){return null!==this.lastPreviewedPartStudioId&&!!this.modelViewManagers[ys.L.PREVIEW]}resetPreviewManager(){this.viewer.getUiResourceManager().destroyPreviewGraphics(),this.viewer.getSceneGraphs().getPreviewSceneGraph().removeEverything(),this.modelViewManagers[ys.L.PREVIEW]&&this.modelViewManagers[ys.L.PREVIEW].onDeletion(),this.modelViewManagers[ys.L.PREVIEW]=null,this.lastPreviewedPartStudioId=null,this.getManager().onPreviewDestroyed(),this.viewer.getOccurrenceDataManager().onPreviewDestroyed(),this.viewer.getCurvatureAnalysisManager()?.onPreviewDestroyed()}onAppearanceConstantsUpdated(){for(const e of Object.values(this.modelViewManagers))e?.onAppearanceConstantsUpdated()}onRenderingModeChanged(){for(const e of Object.values(this.modelViewManagers))e?.onRenderingModeChanged()}}var yh=i(34015);const Ah=_e.O.createLogger("Camera",k.bVy.GRAPHICS);class Ph{constructor(){this.viewport=y.fromValues(0,0,4,4),this.tileViewport=null,this.viewportDiagonal=0,this.canvasHeight=0,this.canvasWidth=0,this.sceneBounds=null,this.PROJECT_VEC_4=y.create(),this.TEMP_VEC4_0=y.create(),this.TEMP_VEC4_1=y.create(),this.TEMP_VEC4_2=y.create(),this.TEMP_VEC3_0=M.create(),this.TEMP_VEC3_1=M.create(),this.updateViewportDiagonal(),this.viewMatrix=ue.create(),this.viewMatrixInverse=ue.create(),this.projectionMatrix=ue.create(),this.projectionMatrixInverse=ue.create(),this.viewFrustum=new ur(this.viewMatrix,this.projectionMatrix)}integrityCheck(e){this.checkProperty("viewport",e),this.checkProperty("viewportDiagonal",e),this.checkProperty("canvasHeight",e),this.checkProperty("canvasWidth",e),this.checkProperty("viewMatrix",e),this.checkProperty("viewMatrixInverse",e),this.checkProperty("projectionMatrix",e),this.checkProperty("projectionMatrixInverse",e),this.checkProperty("eye",e),this.checkProperty("up",e),this.checkProperty("direction",e),this.checkProperty("near",e),this.checkProperty("far",e)}checkProperty(e,t){const i=this[e];(0,wi.xV)(i)||Ah.warn(e+" was found to be non-finite in "+t+": "+i)}getViewFrustum(){return this.viewFrustum}toString(){return JSON.stringify(this,null,2)}isPerspective(){return!1}isOrthographic(){return!1}setViewportFromCanvasElement(e){const t=parseInt(e.attr("width")||""),i=parseInt(e.attr("height")||"");this.setViewport([0,0,t,i]),this.setCanvasDimensions(t,i)}setCanvasDimensions(e,t){this.canvasWidth=e,this.canvasHeight=t}updateViewportDiagonal(){this.viewportDiagonal=ge.gv.length([this.viewport[2],this.viewport[3]])}setViewport(e){this.viewport=e,this.updateViewportDiagonal(),this.updateMatrices()}getViewport(e){return this.tileViewport&&!e?y.fromValues(0,0,this.tileViewport[2],this.tileViewport[3]):this.viewport}getTileViewport(){return this.tileViewport}getViewportDiagonal(){return this.viewportDiagonal}getEye(){return this.eye}getFrame(){const e=ue.create(),t=this.getRight();for(let i=0;i<3;i++)e[i]=t[i],e[i+4]=this.up[i],e[i+8]=-this.direction[i],e[i+12]=this.eye[i],e[4*i+3]=0;return e}setFrame(e){if(!e||16!==e.length)return void Ah.error("An attempt was made to update the camera with an invalid frame");const t=M.fromValues(e[12],e[13],e[14]),i=M.fromValues(-e[8],-e[9],-e[10]),s=M.fromValues(e[4],e[5],e[6]);this.setViewPositionAndOrientation(t,i,s)}setViewPositionAndOrientation(e,t,i){this.eye=e,this.direction=t,this.up=i,this.updateMatrices(),this.integrityCheck("setViewPositionAndOrientation")}getDirection(){return this.direction}getFieldOfView(){return 0}setFieldOfView(e){}focalPoint(){return this.sceneBounds?this.sceneBounds.center():M.create()}distanceToCenter(){const e=this.focalPoint();return Math.abs(M.dot(this.direction,ge.S4.subtract(e,this.eye,M.create())))}setSceneBounds(e){e.isInitialized()&&!e.isInfinite()&&(this.sceneBounds=e,this.ensureCameraIsOutsideSceneBounds(),this.updateNearFar())}getSceneBounds(){return this.sceneBounds}getViewMatrix(){return ue.clone(this.viewMatrix)}getViewMatrixInverse(){return ue.clone(this.viewMatrixInverse)}setTileViewport(e){this.tileViewport=e}getProjectionMatrix(){return this.tileViewport?ge.w$.multiply((0,wi.vG)(this.tileViewport,this.viewport),this.projectionMatrix,ue.create()):ue.clone(this.projectionMatrix)}getMatrices(e,t){for(let i=0;i<16;++i)e[i]=this.viewMatrix[i],t[i]=this.projectionMatrix[i]}getProjectionMatrixInverse(){return ue.clone(this.projectionMatrixInverse)}updateMatrixInverses(){let e=ge.w$.inverse(this.viewMatrix,this.viewMatrixInverse);e=ge.w$.inverse(this.projectionMatrix,this.projectionMatrixInverse)&&e,e||Ah.warn("Error updating camera matrix inverses")}updateNearFar(e){if(!e&&this.sceneBounds&&(e=this.sceneBounds.getCorners()),!e||!e.length)return;let t,i=-1/0,s=1/0;const n=M.create();for(t=0;t<e.length;t++){const r=M.dot(ge.S4.subtract(e[t],this.eye,n),this.direction);i=Math.max(i,r),s=Math.min(s,r)}if(i>=s){let e=1;this.sceneBounds&&(e=this.sceneBounds.diameter());const t=.01,n=.1;this.near=Math.max(e*t,s-n*e),this.far=Math.max(e,i+n*e)}else Ah.warn("Trying to initialize the camera with a bounds that has no extension in the view direction"),this.near=.001,this.far=2;this.updateMatrices()}setNearFar(e,t){e>=t&&Ah.debug("Near set to a distance greater or equal to far"),this.near=e,this.far=t,this.updateMatrices()}zoom(e){}getNearDepth(){return this.near}getFarDepth(){return this.far}rotateAbout(e,t,i){i||(i=this.eye);const s=ue.create();ge.w$.rotate(s,e,t),ge.w$.multiplyVec3(s,this.direction),ge.w$.multiplyVec3(s,this.up);const n=ge.S4.subtract(this.eye,i,M.create());ge.w$.multiplyVec3(s,n),ge.S4.add(i,n,this.eye),this.updateMatrices(),this.integrityCheck("rotateAbout")}pan(e){ge.S4.subtract(this.eye,e),this.updateMatrices(),this.integrityCheck("pan")}ensureCameraIsOutsideSceneBounds(){}getRight(){return ge.S4.normalize(ge.S4.cross(this.direction,this.up,M.create()))}getUp(){return this.up}getForward(){return this.direction}projectWorldPointToViewport(e){return e=y.fromValues(e[0],e[1],e[2],1),this.projectViewPoint(ge.w$.multiplyVec4(this.viewMatrix,e,y.create()))}projectWorldPointToCanvas(e){return this.viewportToCanvas(this.projectWorldPointToViewport(e))}viewportToCanvas(e){const t=M.create();t[0]=e[0]+this.getViewportLeft();const i=this.canvasHeight-(this.getViewportBottom()+this.getViewportHeight());return t[1]=i+(this.getViewportHeight()-e[1]),t[2]=e[2],t}viewNormalPlaneAtPoint(e){const t=this.getForward(),i=M.dot(t,e);return y.fromValues(t[0],t[1],t[2],-i)}projectViewPoint(e,t){t=t||M.create();const i=this.tileViewport?this.getProjectionMatrix():this.projectionMatrix,s=ge.w$.multiplyVec4(i,e,this.PROJECT_VEC_4);s[3]=1/s[3],s[0]*=s[3],s[1]*=s[3],s[2]*=s[3];const n=this.tileViewport?this.tileViewport:this.viewport,r=n[2],a=n[3];return t[0]=0+r*(s[0]+1)/2,t[1]=0+a*(s[1]+1)/2,t[2]=(s[2]+1)/2,t}viewPointToWorld(e){return e=y.fromValues(e[0],e[1],e[2],1),ge.w$.multiplyVec4(this.viewMatrixInverse,e,y.create())}getUnitSizeAtWorldPoint(e){const t=this.TEMP_VEC4_0;t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=1;const i=this.projectViewPoint(ge.w$.multiplyVec4(this.viewMatrix,t,this.TEMP_VEC4_1),this.TEMP_VEC3_0);t[0]+=this.up[0],t[1]+=this.up[1],t[2]+=this.up[2];const s=this.projectViewPoint(ge.w$.multiplyVec4(this.viewMatrix,t,this.TEMP_VEC4_2),this.TEMP_VEC3_1);return Math.abs(s[1]-i[1])}projectWorldDirectionToCanvas(e,t){const i=this.projectWorldPointToCanvas(e),s=ge.S4.add(e,t,this.TEMP_VEC3_0),n=this.projectWorldPointToCanvas(s);return ge.gv.subtract(n,i,Q.create())}getPixelSizeAtWorldPoint(e){return 1/this.getUnitSizeAtWorldPoint(e)}isCanvasPointInView(e){return e[0]>=0&&e[0]<this.getViewportWidth()&&e[1]>=0&&e[1]<this.getViewportHeight()}getRay(e,t){t=this.canvasHeight-t;const i=ge.S4.unproject([e+.5,t+.5,0],this.viewMatrix,this.projectionMatrix,this.viewport),s=ge.S4.unproject([e+.5,t+.5,1],this.viewMatrix,this.projectionMatrix,this.viewport);return new wi.zH(i,ge.S4.subtract(s,i,M.create()))}canvasToWorld(e){const t=M.fromValues(e[0],this.canvasHeight-e[1],e[2]);return ge.S4.unproject(t,this.viewMatrix,this.projectionMatrix,this.viewport,M.create())}getCanvasWidth(){return this.canvasWidth}getCanvasHeight(){return this.canvasHeight}getViewportWidth(){return this.viewport[2]}getViewportHeight(){return this.viewport[3]}getViewportLeft(){return this.viewport[0]}getViewportBottom(){return this.viewport[1]}getClosestNormalView(e,t){if(!e)return null;const i=M.fromValues(e[0],e[1],e[2]),s=M.fromValues(e[4],e[5],e[6]),n=this.getFrame(),r=M.fromValues(n[0],n[1],n[2]),a=M.fromValues(n[4],n[5],n[6]),o=M.fromValues(n[12],n[13],n[14]);let h,c;const l=M.dot(r,i),d=M.dot(r,s);if(Math.abs(l)>Math.abs(d)-Ri.W.ZERO_LENGTH){h=ge.S4.scale(i,l<0?-1:1,M.create());const e=M.dot(a,s);c=ge.S4.scale(s,e<0?-1:1,M.create())}else{h=ge.S4.scale(s,d<0?-1:1,M.create());const e=M.dot(a,i);c=ge.S4.scale(i,e<0?-1:1,M.create())}const u=ge.S4.cross(h,c,M.create()),g=o,p=ue.create();for(let e=0;e<3;++e)p[0+e]=h[e],p[4+e]=c[e],p[8+e]=u[e],p[12+e]=g[e];if(t&&t.flipNormalIfIdentical&&(0,wi.cl)(n,p))for(let e=0;e<3;++e)p[0+e]=-h[e],p[8+e]=-u[e],p[12+e]=-g[e];return p}getCameraRotatedToView(e,t){const i=this.clone();i.setFrame(this.getClosestNormalView(e,{flipNormalIfIdentical:!0}));const s=this.projectWorldPointToCanvas(t),n=i.canvasToWorld(s);return i.pan(ge.S4.subtract(n,t)),i}getCameraRotatedToViewAndTranslated(e,t,i){const s=this.clone();s.setFrame(this.getClosestNormalView(e,{flipNormalIfIdentical:!0}));const n=this.projectWorldPointToCanvas(t),r=[i[0],i[1],n[2]],a=s.canvasToWorld(r);return s.pan(ge.S4.subtract(a,t)),s}canBoundsFitInViewport(e,t){if(!e||!e.isFinite())return!1;const i=new wi.tO,s=e.getCorners();for(let e=0;e<s.length;++e)i.addPoint(this.projectWorldPointToViewport(s[e]));const n=i.getDimensions();return n[0]<t[2]&&n[1]<t[3]}doBoundsFitInViewport(e,t,i){if(!e||!e.isFinite()||0===i)return!1;t=t||this.viewport;const s=i||1,n=new wi.tO,r=e.getCorners();for(let e=0;e<r.length;++e)n.addPoint(this.projectWorldPointToViewport(r[e]));const a=[t[2]*(s-1)/2,t[3]*(s-1)/2];return n.min[0]>-a[0]&&n.min[1]>-a[1]&&n.max[0]<t[2]+a[0]&&n.max[1]<t[3]+a[1]}canvasToModelPoint(e){const t=this.projectWorldPointToCanvas(M.fromValues(0,0,0));return this.canvasToWorld(M.fromValues(e[0],e[1],t[2]))}getUnitSizeAtWorldPointFast(e){return this.getUnitSizeAtWorldPoint(e)}}const Oh=45;class Rh extends Ph{constructor(e){super(),this.MIN_SCALE=.05,this.MAX_SCALE=50,this.angle=Oh,this.eye=M.fromValues(0,0,0),this.near=1,this.far=2,this.direction=M.fromValues(0,0,1),this.up=M.fromValues(0,1,0),Object.assign(this,Rh.defaults(),e||{}),this.updateMatrices()}static defaults(){return{eye:[0,0,0],direction:[0,0,1],up:[0,1,0],angle:45,near:1,far:2}}integrityCheck(e){super.integrityCheck(e),this.checkProperty("angle",e)}equals(e){return e instanceof Rh&&(this.angle===e.angle&&(0,wi.cl)(this.eye,e.eye)&&(0,wi.cl)(this.direction,e.direction)&&(0,wi.cl)(this.up,e.up))}isPerspective(){return!0}getFieldOfView(){return this.angle}setFieldOfView(e){this.angle=e,this.updateMatrices()}updateMatrices(){const e=ge.S4.add(this.direction,this.eye,M.create());ge.w$.lookAt(this.eye,e,this.up,this.viewMatrix),ge.w$.perspective(this.angle,this.viewport[2]/this.viewport[3],this.near,this.far,this.projectionMatrix),this.updateMatrixInverses(),this.viewFrustum.updateClippingPlanes(this.viewMatrix,this.projectionMatrix)}getDirectionToWorldPoint(e){return ge.S4.normalize(ge.S4.subtract(e,this.eye,M.create()))}getFrustum(){const e=Math.tan((0,wi.Yr)(.5*this.angle))*this.near,t=e*this.canvasWidth/this.canvasHeight;return[-t,t,-e,e,this.near,this.far]}copyTo(e){let t;for(t=0;t<3;++t)e.eye[t]=this.eye[t],e.direction[t]=this.direction[t],e.up[t]=this.up[t];for(e.angle=this.angle,e.near=this.near,e.far=this.far,e.sceneBounds=this.sceneBounds,e.setViewport(this.viewport),e.canvasWidth=this.canvasWidth,e.canvasHeight=this.canvasHeight,t=0;t<16;++t)e.viewMatrix[t]=this.viewMatrix[t],e.viewMatrixInverse[t]=this.viewMatrixInverse[t],e.projectionMatrix[t]=this.projectionMatrix[t]}copyFrom(e){e.isPerspective()?e.copyTo(this):e.getPerspectiveCamera().copyTo(this)}clone(){const e=new Rh;return this.copyTo(e),e}getPerspectiveCamera(){return this.clone()}getOrthographicCamera(){const e=new wh;let t;for(t=0;t<3;++t)e.eye[t]=this.eye[t],e.direction[t]=this.direction[t],e.up[t]=this.up[t];e.setViewport(this.viewport),e.sceneBounds=this.sceneBounds,e.canvasWidth=this.canvasWidth,e.canvasHeight=this.canvasHeight,e.updateNearFar(),e.correctAspectRatio(),e.updateMatrices();const i=this.getSceneBounds()?.center(),s=this.getUnitSizeAtWorldPoint(i),n=e.getUnitSizeAtWorldPoint(i);return e.zoom(n/s),e}getFrame(){const e=ue.create(),t=ge.S4.cross(this.direction,this.up,M.create()),i=this.up,s=this.direction;let n;for(n=0;n<3;n++)e[n]=t[n],e[n+4]=i[n],e[n+8]=-s[n],e[n+12]=this.eye[n],e[4*n+3]=0;return e}getMinDistance(){return this.sceneBounds?this.sceneBounds.diameter()*this.MIN_SCALE:this.MIN_SCALE}getMaxDistance(){return this.sceneBounds?this.sceneBounds.diameter()*this.MAX_SCALE:this.MAX_SCALE}dollyAlong(e,t){if(!this.sceneBounds)return;const i=this.getMinDistance(),s=this.getMaxDistance(),n=this.distanceToCenter(),r=M.dot(this.direction,t);let a=r*e;n<i?a=Math.min(a,0):n-a<i?a=Math.max(i-n,0):n-a>s&&(a=Math.min(n-s,0)),ge.S4.add(this.eye,ge.S4.scale(t,a/r,M.create())),this.updateMatrices(),this.integrityCheck("dollyAlong")}dolly(e){this.dollyAlong(e,this.direction)}zoom(e){const t=this.distanceToCenter();this.dolly(t-t*e)}getZoomToFitEyeAndPlanes(e,t,i){const s=ge.S4.cross(this.direction,this.up,M.create()),n=yh.fromValues(s[0],s[1],s[2],this.up[0],this.up[1],this.up[2],-this.direction[0],-this.direction[1],-this.direction[2]),r=ge.xB.transpose(n,yh.create()),a=[0,0,0];let o,h=0;if(e((function(e){ge.S4.add(a,e),h++})),h<=0)return null;ge.S4.scale(a,1/h);const c=[1/0,1/0,1/0],l=[-1/0,-1/0,-1/0],d=M.create(),u=M.create();e((function(e){for(ge.S4.subtract(e,a,d),ge.xB.multiplyVec3(r,d,u),o=0;o<3;o++)c[o]=Math.min(c[o],u[o]),l[o]=Math.max(l[o],u[o])}));const g=ge.S4.scale(ge.S4.add(l,c,M.create()),.5);ge.S4.subtract(l,g);const p=2*l[0]/(2*l[1]),m=t[2]/t[3];if(m<p&&(l[1]*=p/m),i)for(o=0;o<3;o++)l[o]*=i;const f=l[1]/Math.tan((0,wi.Yr)(.5*this.angle)),I=ge.xB.multiplyVec3(n,g,M.create()),E=ge.S4.add(a,I,M.create());return ge.S4.add(E,ge.S4.scale(this.direction,-(f+l[2]),M.create())),{eye:E,near:f,far:f+2*l[2]}}zoomToFit(e,t,i){let s;if(e instanceof Array)s=function(t){for(let i=0;i<e.length;i++)t(e[i])};else{if(!(e instanceof Function))return;s=e}const n=this.getZoomToFitEyeAndPlanes(s,this.viewport,t);if(n){if(this.eye=n.eye,this.near=n.near,this.far=n.far,i){const e=Math.tan((0,wi.Yr)(.5*this.angle))*this.near*2/i[3],t=(.5*this.viewport[2]-(i[0]+.5*i[2]))*e,s=(.5*this.viewport[3]-(i[1]+.5*i[3]))*e,n=ge.S4.cross(this.direction,this.up,M.create());ge.S4.add(this.eye,ge.S4.scale(n,t,M.create())),ge.S4.add(this.eye,ge.S4.scale(this.up,s,M.create()));const r=this.near*(this.viewport[2]/i[2]-1),a=this.near*(this.viewport[3]/i[3]-1),o=Math.max(r,a);ge.S4.subtract(this.eye,ge.S4.scale(this.direction,o,M.create())),this.near+=o,this.far+=o}this.updateMatrices(),this.integrityCheck("zoomToFit")}}}class wh extends Ph{constructor(e){super(),this.DEFAULT_EXTENT_RATIO=.1,this.cachedWorldToPixelSize=-1,this.left=-1,this.right=1,this.top=1,this.bottom=-1,this.near=-1,this.far=1,this.eye=M.create(),this.direction=M.fromValues(0,0,-1),this.up=M.fromValues(0,1,0),Object.assign(this,wh.defaults(),e||{}),this.updateMatrices()}static defaults(){return{eye:[0,0,0],direction:[0,0,-1],up:[0,1,0],left:-1,right:1,top:1,bottom:-1,near:-1,far:1}}integrityCheck(e){super.integrityCheck(e),this.checkProperty("left",e),this.checkProperty("right",e),this.checkProperty("top",e),this.checkProperty("bottom",e)}equals(e){return e instanceof wh&&(Math.abs(this.left-e.left)<Ri.W.ZERO_LENGTH&&Math.abs(this.right-e.right)<Ri.W.ZERO_LENGTH&&Math.abs(this.top-e.top)<Ri.W.ZERO_LENGTH&&Math.abs(this.bottom-e.bottom)<Ri.W.ZERO_LENGTH&&(0,wi.cl)(this.eye,e.eye)&&(0,wi.cl)(this.direction,e.direction)&&(0,wi.cl)(this.up,e.up))}isOrthographic(){return!0}getUnitSizeAtWorldPointFast(e){return this.cachedWorldToPixelSize<0&&(this.cachedWorldToPixelSize=super.getUnitSizeAtWorldPoint(e)),this.cachedWorldToPixelSize}updateMatrices(){const e=ge.S4.add(this.direction,this.eye,M.create());ge.w$.lookAt(this.eye,e,this.up,this.viewMatrix),ge.w$.ortho(this.left,this.right,this.bottom,this.top,this.near,this.far,this.projectionMatrix),this.updateMatrixInverses(),this.viewFrustum.updateClippingPlanes(this.viewMatrix,this.projectionMatrix),this.cachedWorldToPixelSize=-1}copyTo(e){let t;for(t=0;t<3;++t)e.eye[t]=this.eye[t],e.direction[t]=this.direction[t],e.up[t]=this.up[t];for(e.left=this.left,e.right=this.right,e.top=this.top,e.bottom=this.bottom,e.near=this.near,e.far=this.far,e.sceneBounds=this.sceneBounds,e.setViewport(this.viewport),e.canvasWidth=this.canvasWidth,e.canvasHeight=this.canvasHeight,t=0;t<16;++t)e.viewMatrix[t]=this.viewMatrix[t],e.viewMatrixInverse[t]=this.viewMatrixInverse[t],e.projectionMatrix[t]=this.projectionMatrix[t]}copyFrom(e){e.isOrthographic()?e.copyTo(this):e.getOrthographicCamera().copyTo(this)}clone(){const e=new wh;return this.copyTo(e),e}getOrthographicCamera(){return this.clone()}getPerspectiveCamera(){const e=new Rh;let t;for(t=0;t<3;++t)e.eye[t]=this.eye[t],e.direction[t]=this.direction[t],e.up[t]=this.up[t];e.setViewport(this.viewport),e.sceneBounds=this.sceneBounds,e.canvasWidth=this.canvasWidth,e.canvasHeight=this.canvasHeight,e.updateNearFar();const i=this.getSceneBounds()?.center();if(i){const t=this.getUnitSizeAtWorldPoint(i),s=e.getUnitSizeAtWorldPoint(i),n=e.distanceToCenter(),r=s/t*n;e.dolly(n-r),e.updateNearFar()}return e}getDirectionToWorldPoint(e){return this.direction}setViewport(e){this.viewport=e.slice(0),this.updateViewportDiagonal(),this.correctAspectRatio(),this.updateMatrices()}correctAspectRatio(){const e=this.right-this.left,t=this.top-this.bottom,i=this.getViewportWidth(),s=this.getViewportHeight();if(0===i||0===s)return;let n,r;i<s?(n=e<t?1:t/e,r=n*e*s/(t*i)):(r=e<t?e/t:1,n=r*t*i/(e*s)),this.left*=n,this.right*=n,this.top*=r,this.bottom*=r}zoom(e){const t=this.right-this.left,i=this.top-this.bottom;this.left=-t*e*.5,this.right=t*e*.5,this.top=i*e*.5,this.bottom=-i*e*.5,this.updateMatrices()}getExtents(){return[this.left,this.bottom,-this.far,this.right,this.top,-this.near]}setExtents(e){this.left=e[0],this.right=e[3],this.bottom=e[1],this.top=e[4],this.updateMatrices()}setExtentsByComponent(e,t,i,s){this.left=e,this.right=t,this.bottom=i,this.top=s,this.updateMatrices()}zoomPoint(e,t,i,s){const n=ge.S4.subtract(e,this.eye,M.create()),r=this.getRight(),a=M.dot(n,r),o=M.dot(n,this.up);ge.S4.add(this.eye,ge.S4.scale(r,-a*(i-1),M.create()),this.eye),ge.S4.add(this.eye,ge.S4.scale(this.up,-o*(i-1),M.create()),this.eye);const h=this.right-this.left,c=this.top-this.bottom;this.left=-h*i*.5,this.right=h*i*.5,this.top=c*i*.5,this.bottom=-c*i*.5,this.updateMatrices(),this.integrityCheck("zoomPoint")}ensureCameraIsOutsideSceneBounds(){if(!this.sceneBounds)return;const e=M.dot(this.direction,this.sceneBounds.center())-M.dot(this.direction,this.eye);ge.S4.add(this.eye,ge.S4.scale(this.direction,-(.6*this.sceneBounds.diameter()-e),M.create()),this.eye),this.integrityCheck("ensureCameraIsOutsideSceneBounds")}zoomToFit(e,t,i){let s;if(e instanceof Array)s=function(t){for(let i=0;i<e.length;i++)t(e[i])};else{if(!(e instanceof Function))return;s=e}t=t||1;const n=this.getRight(),r=this.getUp(),a=[1/0,1/0],o=[-1/0,-1/0],h=[0,0];if(s((function(e){h[0]=M.dot(n,e),h[1]=M.dot(r,e);for(let e=0;e<2;++e)h[e]<a[e]&&(a[e]=h[e]),h[e]>o[e]&&(o[e]=h[e])})),o[0]<a[0]||o[1]<a[1])return;let c=o[0]-a[0],l=o[1]-a[1];if(0===c&&0===l)return;0===c?c=l*this.DEFAULT_EXTENT_RATIO:0===l&&(l=c*this.DEFAULT_EXTENT_RATIO),this.eye=ge.S4.add(ge.S4.scale(n,.5*(a[0]+o[0]),M.create()),ge.S4.scale(r,.5*(a[1]+o[1]),M.create())),this.ensureCameraIsOutsideSceneBounds(),this.right=.5*c*t,this.top=.5*l*t;let d=this.viewport[2]/this.viewport[3];i&&(d=i[2]/i[3]);const u=this.right/this.top/d;if(u>1?this.top*=u:this.right/=u,i){const e=2*this.right/i[2],t=(.5*this.viewport[2]-(i[0]+.5*i[2]))*e,s=(.5*this.viewport[3]-(i[1]+.5*i[3]))*e;ge.S4.add(this.eye,ge.S4.scale(n,t,M.create())),ge.S4.add(this.eye,ge.S4.scale(r,s,M.create())),this.right*=this.viewport[2]/i[2],this.top*=this.viewport[3]/i[3]}this.left=-this.right,this.bottom=-this.top,this.updateMatrices(),this.integrityCheck("zoomToFit")}}function vh(e){const t=Math.min(e[2],e[3]);return[-.5*t,.5*t]}class _h extends Rh{constructor(){super(),this.viewMatrix=ue.create()}setTransforms(e,t,i){ue.multiply(this.viewMatrix,t,e),this.projectionMatrix=i,this.updateMatrixInverses(),M.set(this.TEMP_VEC3_0,0,0,0),ge.w$.multiplyVec3(this.viewMatrixInverse,this.TEMP_VEC3_0,this.eye),y.set(this.TEMP_VEC4_0,0,0,-1,0),ge.w$.multiplyVec4(this.viewMatrixInverse,this.TEMP_VEC4_0,this.TEMP_VEC4_1),M.copy(this.direction,this.TEMP_VEC4_1),y.set(this.TEMP_VEC4_0,0,1,0,0),ge.w$.multiplyVec4(this.viewMatrixInverse,this.TEMP_VEC4_0,this.TEMP_VEC4_1),M.copy(this.up,this.TEMP_VEC4_1)}updateMatrices(){}}class Nh{constructor(e){this.viewer=e,this.occurrenceData={},(0,Sh.Yk)(e),this.getOrCreateOccurrenceData(TE.KF)}getOccurrencesData(){return Object.values(this.occurrenceData)}destroy(){Object.values(this.occurrenceData).forEach((function(e){e.destroy()})),this.occurrenceData={},IT()}onPreviewDestroyed(){Object.values(this.occurrenceData).forEach((function(e){e.onPreviewDestroyed()}))}forEach(e){for(const t in this.occurrenceData)e(t,this.occurrenceData[t])}getOrCreateOccurrenceData(e){let t=this.occurrenceData[+e];return t||(this.occurrenceData[+e]=t=new $r(+e,this.viewer.getIsExcludingItemsForSection()),t.setIsolated(!!this.viewer.getIsolatedOccurrenceManager()?.getIsNewOccurrenceDataIsolated(t))),t}getOccurrenceData(e){const t=this.occurrenceData[e];return t||null}destroyOccurrenceData(e){const t=this.occurrenceData[e];t&&(t.destroy(),delete this.occurrenceData[e])}setOccurrenceTransform(e,t){const i=this.getOrCreateOccurrenceData(e);return i.setTransform(t),this.viewer.requestDraw(),i}getOccurrenceTransform(e){const t=this.getOrCreateOccurrenceData(e);if(t)return t.getTransform();return ue.create()}processHighlightForOccurrences(e,t,i,s){const n=this.viewer.getOccurrenceIdManager();for(let r=0;r<t.length;++r){const a=n.getIdForName(t[r].getPathAsString());a!==TE.Qy&&this.getOrCreateOccurrenceData(a).updateOccurrenceHighlight(e,i,s)}this.viewer.requestDraw()}clearHighlight(e,t){for(const i in this.occurrenceData){this.occurrenceData[i].clearHighlight(e,t)}this.viewer.requestDraw()}clearIsolation(e){this.setAllIsolated(!1,e)}isolateAll(){this.setAllIsolated(!0)}setAllIsolated(e,t){for(const i in this.occurrenceData){if(t?.has(+i))continue;this.occurrenceData[i].setIsolated(e)}this.viewer.requestDraw()}setOccurrenceIsolated(e,t){this.getOrCreateOccurrenceData(+e).setIsolated(t),this.viewer.requestDraw()}resetHiddenFromPick(){for(const e in this.occurrenceData)this.occurrenceData[e].resetHiddenFromPick()}makeSceneDebugObject(){const e=[];return Object.values(this.occurrenceData).forEach((function(t){e.push(t.makeSceneDebugObject())})),{text:"Occurrence data",children:e}}doesHighlightOfTypeExists(e){for(const t of Object.values(this.occurrenceData)){const i=t.getHighlightsForUsage(ys.L.BASE),s=i?.hasHighlightOfType(e);if(s)return!0}return!1}}var bh,Lh=i(16522),Fh=i(40828);!function(e){e[e.BACK=0]="BACK",e[e.FRONT=1]="FRONT",e[e.NONE=-1]="NONE",e[e.UNSPECIFIED=-2]="UNSPECIFIED"}(bh||(bh={}));var xh=i(15130);const Bh=_e.O.createLogger("ConnectionVisualizationManager",k.bVy.GRAPHICS),Vh="SIMULATION_BONDED";let Uh=!1;const Hh=255;class Gh{constructor(e,t,i){this.AnalyticsService=e,this.modelViewManager=t,this.simulationManager=i,this.meshOwnerId=JT(),this.elementIdToResponseData=new Map,this.contactTractionThreshold=.1,this.visualizedOccurrencePaths=[],this.connectionTypes=[],this.useIsolateEffect=!0,this.occurrencesMarkedAsSimulated=[],this.contactBehavior=k.Ixp.FUSE_IN_CONTACT_AND_USE_MATES,this.prepareScenegraph()}setVisible(e){this.isVisible!==e&&(this.isVisible=e,!this.isVisible&&this.useIsolateEffect?(this.useIsolateEffect&&this.viewer.getIsolatedOccurrenceManager()?.clearAllIsolateNoAnimation(),this.clearGraphics()):this.updateGraphics())}setContactBehavior(e){this.contactBehavior!==e&&(this.contactBehavior=e,this.updateGraphics())}getContactBehavior(){return this.contactBehavior}getVisible(){return this.isVisible}getUseIsolateEffect(){return this.useIsolateEffect}updateContactAnalysis(e){const t=new Ih.B7("ConnectionVisualizationManager.updateContactAnalysis",{setTraceId:!0});this.contactBehavior=e.contactBehavior;let i=!1;if(e.runStatus===k.zgQ.JUST_STARTED||e.runStatus===k.zgQ.INVALID_ASSEMBLY)return this.clearGraphics(),void(e.runStatus===k.zgQ.JUST_STARTED&&this.elementIdToResponseData.delete(e.sourceElementId));if(e.hasResponse)this.elementIdToResponseData.set(e.sourceElementId,e.response),i=!0;else{const t=this.modelViewManager.getDisplayedAssembly();t&&e.runStatus===k.zgQ.TRANSMITTED&&this.elementIdToResponseData.has(t.elementId)&&(i=!0)}i&&this.updateGraphics(),t.report()}onAssemblyChanged(){this.updateIfVisible()}onSectionSetChanged(){this.updateIfVisible()}updateIfVisible(){this.isVisible&&this.updateGraphics()}updateGraphics(){const e=new Ih.B7("ConnectionVisualizationManager.updateGraphics",{setTraceId:!0});if(this.clearGraphics(),!this.isVisible)return;const t=this.modelViewManager.getDisplayedAssembly();if(!t||t.isHidden)return;if(this.viewer.getRenderingMode()!==k.P1.SIMULATION_RESULTS)return;const i=this.elementIdToResponseData.get(t.elementId);if(!i||!i.resultData)return void Bh.debug("No data set to display");this.useIsolateEffect=!!X.default.getManager().getNumber("USE_ISOLATE_EFFECT_FOR_CONNECTION_VISUALIZATION");const s=this.viewer.getOccurrenceIdManager(),n=this.viewer.getOccurrenceDataManager(),r=i.resultData,a=new Set;this.updateConnectionTexture(i,t,a);let o=!1;const h=[];for(const e in r.occurrenceIdToOccurrenceResult){const c=r.occurrenceIdToOccurrenceResult[e],l=k._oC.getOccurrenceFromPathString(e),d=s.getIdForName(e);if(d===TE.Qy){Bh.warn("No occurrence id for "+e);continue}const u=n.getOccurrenceData(d);u||Bh.warn("No occurrence data for "+e);const g=t.getOccurrenceDisplayData(l);if(!g){Bh.warn("No occurrence display data for "+e);continue}const p=this.modelViewManager.getPartStudioDataFromOccurrence(l);if(!p){Bh.debug("No part studio for occurrence "+e);continue}if(!this.simulationManager.getTessellationForOccurrenceResult(c)){Bh.debug("No simulation tessellation for "+e),o=!0;break}const m=this.getMeshIncrementForOccurrence(i,c,g,a);if(!m)continue;const f=e+".CP";let I,E;this.useIsolateEffect||(p.getBodyComponent().setScalarVisualizationOccurrence(d),this.occurrencesMarkedAsSimulated.push(e)),this.useIsolateEffect?(I=s.getOrCreateIdForName(f),E=n.getOrCreateOccurrenceData(I),E.setTransform(u.getTransform()),E.setIsolated(!0),E.setVisibility(u.getVisibility()),E.setIsClippedBySectionPlanes(u.getIsClippedBySectionPlanes())):(I=d,E=u),h.push(I),m.id=e;const S=this.meshManager.addMeshIncrement(m,this.meshOwnerId),T=new qT("Contact "+f);T.onIncrementAdded(S);const D=p.retrieveBodyMetaData(g.partIds[0]),C=new mS.bg;D&&C.setAttribute(RS.COLOR,D.getColor()),this.rootNode.addOccurrenceGeometryToNode(this.meshNodeProperties,E,C,T),this.rootNode.addOccurrenceGeometryToNode(this.fadeMeshNodeProperties,E,C,T),this.visualizedOccurrencePaths.push(f)}o?this.clearGraphics():(this.viewer.getEventDispatcher().trigger(nM.GO,a),this.viewer.requestDraw(),this.useIsolateEffect&&(this.viewer.getIsolatedOccurrenceManager()?.clearAllIsolateNoAnimation(),Qe(1),this.viewer.getIsolatedOccurrenceManager()?.addIdsToIsolate(h,!0)),e.report())}setContactTractionThreshold(e){this.contactTractionThreshold=e,this.updateMaterialUniforms(),this.viewer.requestDraw()}isNodeForBodyVisualization(e){return this.rootNode===e}updateMaterialUniforms(){this.material.setCustomFloatUniform("uMultipleConnectionsCoordinate",this.multipleConnectionCoordinate),this.fadeMaterial.setCustomFloatUniform("uMultipleConnectionsCoordinate",this.multipleConnectionCoordinate),this.material.setCustomFloatUniform("uTractionContactThreshold",Math.floor(this.contactTractionThreshold*Hh-1)),this.fadeMaterial.setCustomFloatUniform("uTractionContactThreshold",Math.floor(this.contactTractionThreshold*Hh-1))}get viewer(){return this.modelViewManager.getViewer()}prepareScenegraph(){const e="ContactAnalysis",t=this.modelViewManager.getSharedBodyNode();this.rootNode=t.getChildById(e),this.rootNode||(this.rootNode=new Gi.NB(e),t.addChild(this.rootNode)),this.material=Hi(),this.material.shaderId="contact",this.fadeMaterial=Hi(),this.fadeMaterial.shaderId="contact",this.material.setCustomFloatUniform("uOcclusionFactor",0),this.material.setCustomFloatUniform("uBlendTransparent",0),this.fadeMaterial.setCustomFloatUniform("uOcclusionFactor",0),this.fadeMaterial.setCustomFloatUniform("uBlendTransparent",1),this.meshNodeProperties=new Gi.hF({material:this.material,zOffset:X.default.getManager().getNumber("PART_FACES_Z_OFFSET"),primitiveType:Ai.MX.TRIANGLES,includedInBlend:!0,addsToSectionMask:!1,clippedBySectionPlanes:!0,isPickable:!1,isTwoSided:!0}),this.fadeMeshNodeProperties=new Gi.hF({material:this.fadeMaterial,zOffset:X.default.getManager().getNumber("PART_FACES_Z_OFFSET"),primitiveType:Ai.MX.TRIANGLES,includedInBlend:!0,addsToSectionMask:!1,clippedBySectionPlanes:!0,isPickable:!1,isTwoSided:!0,primitivesHaveTransparency:!0})}clearGraphics(){const e=this.viewer.getOccurrenceIdManager(),t=this.viewer.getOccurrenceDataManager();for(let i=0;i<this.visualizedOccurrencePaths.length;++i){const s=this.visualizedOccurrencePaths[i],n=e.getIdForName(s);if(n===TE.Qy)continue;t.getOccurrenceData(n)&&(this.rootNode.removeOccurrence(n),t.destroyOccurrenceData(n),e.removeName(s))}this.meshManager&&this.meshManager.destroy(),this.meshManager=new eD(this.viewer,{bufferAllocationPolicy:AE.MAXIMUM}),this.simulationManager.clearScalarVisualizationStatusForOccurrences(this.occurrencesMarkedAsSimulated),this.occurrencesMarkedAsSimulated=[]}updateConnectionTexture(e,t,i){const s=e.contactPairList.length+2,n=new Uint8Array(4*s*1),r={},a=k.hto.slice(0,k.hto.length-1);for(let e=0;e<a.length;++e)r[a[e]]=(0,Xs.Db)(X.default.getManager().getColor("CONTACT_COLOR_"+a[e]));const o=this.getNonMatedContactType(),h=k.v79[o],c=this.contactBehavior===k.Ixp.FUSE_IN_CONTACT,l={};let d=0;function u(e){const t=e.firstOccurrence.getPathAsString(),i=e.secondOccurrence.getPathAsString();let s;if(s=t<i?t+"-"+i:i+"-"+t,l.hasOwnProperty(s))return l[s];{const e=d++;return l[s]=e,e}}const g=[];this.connectionTypes=[];for(let i=0;i<e.contactPairList.length;++i){const s=e.contactPairList[i];let a;s.occurrencePairId=u(s);let l=h;if(s.mateId&&!c){const e=t.getMateIndicatorData(s.mateId);let i=o;e?i=e.getSimulationConnectionType():Bh.debug("Failed to find mate for connection visualization: "+s.mateId),l=k.v79[i]||h,a=r[i]?r[i]:r[o]}else a=r[o];this.connectionTypes.push(l),g.push({contactPairIndex:i,contactPair:s,connectionType:l});const d=4*i*1;n.set(a,d)}this.sortContactFields(g);let p=-1;for(let e=0;e<g.length;++e){const t=g[e];let s=!0;(c&&t.contactPair.hasSimulationConnections||p===t.contactPair.occurrencePairId&&t.connectionType===h)&&(s=!1),t.connectionType!==h&&(p=t.contactPair.occurrencePairId),s&&i.add(t.connectionType)}const m=4*(s-1)*1;n.set(r.MULTIPLE,m);const f=4*(s-2)*1;n.set(r[Vh],f);const I=new mo(this.viewer.getGlContext());I.bytes=n,I.width=1,I.height=s,this.material.ambientTexture&&this.material.ambientTexture.destroy(),this.material.ambientTexture=new Io(this.viewer,I),this.material.ambientTexture.setHasTransparency(!1),this.fadeMaterial.ambientTexture=this.material.ambientTexture,this.textureInfo={textureEntryCount:s,texelHeight:1/s,texelWidth:1},this.updateMaterialUniforms()}getNonMatedContactType(){return this.contactBehavior===k.Ixp.MATES_ONLY?"UNCONSTRAINED":Vh}getMeshIncrementForOccurrence(e,t,i,s){const n=this.simulationManager.getTessellationForOccurrenceResult(t);if(!n)return null;const r=this.simulationManager.getSampleMesh(n,t),a=new eT(Ai.MX.TRIANGLES,r.points,r.getAnyIndices()),o=this.getContactAttributesForResult(e,t,s);if(!o)return null;a.contactTraction=o.contactTraction,a.contactPairCoordinate=o.contactPairCoordinate;const h=this.modelViewManager.getPartStudio(t.sourcePartReference);if(h){const e=h.getBodyBounds(n.deterministicId,i.occurrenceData.occurrence);e&&(a.boundingBox=e)}return a}sortContactFields(e){const t=k.v79[this.getNonMatedContactType()];e.sort(((e,i)=>e.contactPair.occurrencePairId===i.contactPair.occurrencePairId?e.connectionType===i.connectionType?e.contactPairIndex-i.contactPairIndex:e.connectionType===t?1:i.connectionType===t?-1:e.connectionType-i.connectionType:e.contactPair.occurrencePairId<i.contactPair.occurrencePairId?-1:1))}getContactAttributesForResult(e,t,i){if(0===t.fields.length)return Bh.debug("Found occurrence result with no fields"),null;const s=[];let n=0;for(let i=0;i<t.fields.length;++i){const n=t.fields[i];for(let t=0;t<n.contactPairIndices.length;++t){const i=n.contactPairIndices[t],r=this.connectionTypes[i],a=e.contactPairList[i];s.push({contactPairIndex:i,connectionType:r,contactPair:a,field:n,visible:!1})}}const r=k.v79[this.getNonMatedContactType()];this.sortContactFields(s);const a=this.contactBehavior===k.Ixp.FUSE_IN_CONTACT,o=[];let h=-1;for(let t=0;t<s.length;++t){const i=s[t];let c=!this.simulationManager.getVisualizationState().connectionTypeToHidden[i.connectionType];const l=e.contactPairList[i.contactPairIndex];(a&&l.hasSimulationConnections||h===i.contactPair.occurrencePairId&&i.connectionType===r)&&(c=!1),i.connectionType!==r&&(h=i.contactPair.occurrencePairId),i.visible=c,c&&(++n,o.push(i))}if(0===n)return null;const c=s[0].field.values.length,l=new Uint8Array(16*c),d=new Float32Array(16*c);let u=!1,g=0,p=0;const m=[];for(let e=0;e<o.length;++e)m.push(this.getTextureCoordinate(o[e].contactPairIndex));if(n>16){Uh||(this.AnalyticsService.trackEvent("SIMULATION","high-connection-count"),Uh=!0);const e=this.multipleConnectionCoordinate;a||(u=!0);for(let t=0;t<c;++t){let i=o[0].field.values[t];for(let e=1;e<o.length;++e){const s=o[e].field.values[t];s>i&&(i=s)}l[g++]=Math.min(255,Hh*i),d[p++]=e;for(let e=1;e<16;++e)g++,p++}}else for(let e=0;e<c;++e){let t=0;for(let i=0;i<16;++i)if(i<o.length){const s=o[i].field.values[e];s>=this.contactTractionThreshold&&++t,l[g++]=Math.min(255,Hh*s),d[p++]=m[i]}else g++,p++;u=t>1&&!a||u}return u&&i.add(k.v79.MULTIPLE),{contactTraction:l,contactPairCoordinate:d}}getTextureCoordinate(e){return.5*this.textureInfo.texelHeight+e*this.textureInfo.texelHeight}get multipleConnectionCoordinate(){return this.contactBehavior===k.Ixp.FUSE_IN_CONTACT?this.getTextureCoordinate(this.textureInfo.textureEntryCount-2):this.getTextureCoordinate(this.textureInfo.textureEntryCount-1)}}Gh.$inject=["AnalyticsService"];var kh=i(49823),Wh=i(40778),zh=i(22203),Xh=i(48833);const Zh=_e.O.createLogger("ScalarVisualizationLegend",k.bVy.GRAPHICS),qh=new Gi.hF({primitiveType:Ai.MX.LINES,isPickable:!1}),Yh=new Gi.hF({primitiveType:Ai.MX.LINES,isVisible:!1}),Kh=new Gi.hF({primitiveType:Ai.MX.TRIANGLES,isPickable:!1,material:Vi,primitivesHaveTransparency:!1}),jh=new Gi.hF({primitiveType:Ai.MX.TRIANGLES,isVisible:!1}),Qh="legend",$h="legendMinTick",Jh="legendMaxTick",ec="legendColorMap",tc="legendAboveMax",ic="legendBelowMin",sc="legendBackground",nc="legendDragRegion",rc="minHighlight",ac="maxHighlight",oc="dimHighlight",hc=.1,cc=.3,lc=.4,dc=.5,uc=kn.C.GRAB,gc=kn.C.CROSSHAIR,pc=kn.C.GRABBING,mc=kn.C.POINTER,fc=kn.C.EW_RESIZE,Ic=kn.C.NS_RESIZE;class Ec extends yi.u1{get SNAPPING_MARGIN_TOP(){return 0}constructor(e){super(e.getViewer(),uh.EG),this.manager=e,this.valueTextElements=[],this.textCache=[],this.isVertical=!0,this.isDamaged=!1,this.colorMapDimensions={width:0,height:0},this.colorMapPadding={left:0,right:0,top:0,bottom:0},this.userHasMovedLegend=!1,this.legendMovedSubject=new As.x,this.legendDragPoint=new k.YFv,this.isBeingDragged=!1,this.tickBeingDragged=null,this.removeSubject=new As.x,this.isPendingShow=!1,this.colorMapMaterial=Hi(),this.colorMapNodeProperties=new Gi.hF({primitiveType:Ai.MX.TRIANGLES,material:this.colorMapMaterial}),this.setActiveColorMapping(Wh.T),this.listenTo(this,yi.zw.MOUSE_ENTER+Qh,this.onMouseEnterLegend),this.listenTo(this,yi.zw.MOUSE_ENTER+ec,this.onMouseEnterColorMap),this.listenTo(this,yi.zw.DRAG_START+Qh,this.onDragStartLegend),this.listenTo(this,yi.zw.DRAG+Qh,this.onDragLegend),this.listenTo(this,yi.zw.DRAG_STOP+Qh,this.onDragStopLegend),this.listenTo(this,yi.zw.DRAG_START+ec,this.onDragStartLegend),this.listenTo(this,yi.zw.DRAG+ec,this.onDragLegend),this.listenTo(this,yi.zw.DRAG_STOP+ec,this.onDragStopLegend),this.listenTo(this,yi.zw.MOUSE_LEAVE+ec,(()=>this.onMouseLeavePopCursor(gc))),this.listenTo(this,yi.zw.MOUSE_LEAVE+Qh,(()=>this.onMouseLeavePopCursor(uc))),this.listenTo(this,yi.zw.MOUSE_ENTER+Jh,this.onMouseEnterTick),this.listenTo(this,yi.zw.DRAG_START+Jh,this.onDragStartTickMax),this.listenTo(this,yi.zw.DRAG+Jh,this.onDragTickMax),this.listenTo(this,yi.zw.DRAG_STOP+Jh,this.onDragStopTick),this.listenTo(this,yi.zw.MOUSE_LEAVE+Jh,this.onMouseLeaveTick),this.listenTo(this,yi.zw.MOUSE_ENTER+$h,this.onMouseEnterTick),this.listenTo(this,yi.zw.DRAG_START+$h,this.onDragStartTickMin),this.listenTo(this,yi.zw.DRAG+$h,this.onDragTickMin),this.listenTo(this,yi.zw.DRAG_STOP+$h,this.onDragStopTick),this.listenTo(this,yi.zw.MOUSE_LEAVE+$h,this.onMouseLeaveTick),e.getSupportsInContextMode()&&(0,ss.Xt)().getPanelOpenCloseObservable().pipe((0,Xh.R)(this.getRemoveObservable())).subscribe((e=>this.panelWasAdded(e))),this.changeLegendOrientation(),this.updateConstants()}updateConstants(){const e=X.default.getManager(),t=e.getNumber("LEGEND_TICK_TEXT_UNDERLINE_WIDTH_PX");this.backgroundColor=e.getColor("LEGEND_BACKGROUND_COLOR"),this.defaultFontOptions={color:e.getColor("LEGEND_TICK_TEXT_COLOR"),size:e.getNumber("LEGEND_TICK_TEXT_HEIGHT_PX"),font:e.getString("LEGEND_TICK_TEXT_FONT")},this.clickableFontOptions={color:e.getColor("LEGEND_TICK_CLICKABLE_TEXT_COLOR"),size:e.getNumber("LEGEND_TICK_TEXT_HEIGHT_PX"),font:e.getString("LEGEND_TICK_TEXT_FONT"),underlineWidth:t},this.hoverFontOptions={color:e.getColor("LEGEND_TICK_TEXT_COLOR"),size:e.getNumber("LEGEND_TICK_TEXT_HEIGHT_PX"),font:e.getString("LEGEND_TICK_TEXT_FONT"),fontWeight:e.getString("LEGEND_TICK_TEXT_HOVER_WEIGHT"),underlineWidth:t}}repositionPanel(){const e=this.colorMapCorners,t=this.calculateInitialLegendPosition();t&&(this.colorMapCorners=t,e?.bottomLeft.equals(this.colorMapCorners?.bottomLeft)&&e?.topRight.equals(this.colorMapCorners?.topRight)||this.updateGraphics())}getRelevantPanelIdsForRepositioning(){return[this.CANVAS_CONTROLS_PANEL_ID]}panelWasAdded(e){const t=this.getRelevantPanelIdsForRepositioning();!this.userHasMovedLegend&&t.includes(e?.panelId)&&this.repositionPanel()}setIsVertical(e){this.isVertical!==e&&this.changeLegendOrientation()}getIsVertical(){return this.isVertical}areCoordinatesOverLegend(e){return!!this.colorMapCorners&&(this.colorMapCorners.bottomLeft.x<e.x&&e.x<this.colorMapCorners.topRight.x&&this.colorMapCorners.bottomLeft.y<e.y&&e.y<this.colorMapCorners.topRight.y)}onMouseLeavePopCursor(e){this.viewer.removeTopOccurrenceOfCursor(e)}onMouseLeaveTick(){const e=this.isVertical?Ic:fc;this.onMouseLeavePopCursor(e)}onMouseEnterLegend(){this.viewer.pushCursor(uc)}onMouseEnterColorMap(){this.viewer.pushCursor(gc)}onDragStartLegend(e,t,i){this.viewer.pushCursor(pc),i.requestDrag=!0,this.legendDragPoint.updateFromArray([t.mouseX,t.mouseY]),this.userHasMovedLegend=!0}onMouseEnterTick(){this.isVertical?this.viewer.pushCursor(Ic):this.viewer.pushCursor(fc)}get isTickBeingDragged(){return null!==this.tickBeingDragged}onDragStartTick(e,t,i){this.isBeingDragged=!0,i.requestDrag=!0,this.currentScaleRange=this.visualizedScalarRange?.clone()}onDragStartTickMax(e,t,i){return this.tickBeingDragged=zh.s.MAX,this.onDragStartTick(e,t,i)}onDragStartTickMin(e,t,i){return this.tickBeingDragged=zh.s.MIN,this.onDragStartTick(e,t,i)}onDragStopTick(){this.isBeingDragged=!1,this.tickBeingDragged=null,this.currentScaleRange=this.visualizedScalarRange?.clone(),this.isDamaged=!0}onDragLegend(e,t){const i=k.YFv.fromArray([this.legendDragPoint.x-t.mouseX,t.mouseY-this.legendDragPoint.y]);this.moveLegend(i)}onDragStopLegend(){this.viewer.removeTopOccurrenceOfCursor(pc),this.isBeingDragged=!1,this.legendDragPoint=new k.YFv}onDragTickMin(e,t){if(!this.visualizedScalarRange?.hasRange)return;const{topRight:i}=this.getViewportCoordinates();let s=this.getClampedValueFromCoordinatesInRange(k.YFv.fromArray([t.mouseX,i.y-t.mouseY]));this.isInverted?s<this.visualizedScalarRange.max+Ri.W.MIN_LEGEND_MIN_MAX_DIFFERENCE&&(s=Math.min(this.visualizedScalarRange.max+Ri.W.MIN_LEGEND_MIN_MAX_DIFFERENCE,this.visualizedScalarRange.min)):s>this.visualizedScalarRange.max-Ri.W.MIN_LEGEND_MIN_MAX_DIFFERENCE&&(s=Math.max(this.visualizedScalarRange.max-Ri.W.MIN_LEGEND_MIN_MAX_DIFFERENCE,this.visualizedScalarRange.min)),s!==this.visualizedScalarRange.min&&this.viewer.getEventDispatcher().trigger(this.LEGEND_RANGE_CHANGED,s,zh.s.MIN)}onDragTickMax(e,t){if(!this.visualizedScalarRange?.hasRange)return;const{topRight:i}=this.getViewportCoordinates();let s=this.getClampedValueFromCoordinatesInRange(k.YFv.fromArray([t.mouseX,i.y-t.mouseY]));this.isInverted?s>this.visualizedScalarRange.min-Ri.W.MIN_LEGEND_MIN_MAX_DIFFERENCE&&(s=Math.max(this.visualizedScalarRange.min-Ri.W.MIN_LEGEND_MIN_MAX_DIFFERENCE,this.visualizedScalarRange.max)):s<this.visualizedScalarRange.min+Ri.W.MIN_LEGEND_MIN_MAX_DIFFERENCE&&(s=Math.min(this.visualizedScalarRange.min+Ri.W.MIN_LEGEND_MIN_MAX_DIFFERENCE,this.visualizedScalarRange.max)),s!==this.visualizedScalarRange.max&&this.viewer.getEventDispatcher().trigger(this.LEGEND_RANGE_CHANGED,s,zh.s.MAX)}getValueFromCoordinates(e){if(!this.currentScaleRange?.hasRange)return Zh.warn("Tried to getValueFromCoordinates but currentScaleRange was not valid"),0;const t=this.isVertical?e.y:e.x,i=this.calculateLongSideCoordinate(this.currentScaleRange.max),s=this.calculateLongSideCoordinate(this.currentScaleRange.min),n=(t-s)/(i-s)*this.currentScaleRange.magnitude+this.currentScaleRange.min;return isNaN(n)&&Zh.warn(`Tried to getValueFromCoordinates but value was ${n}`),n}getValueFromCoordinatesInVisualizedRange(e){if(!this.visualizedScalarRange?.hasRange)return Zh.warn("Tried to getValueFromCoordinatesInVisualizedRange but visualizedScalarRange was not valid"),0;const t=this.isVertical?e.y:e.x,i=this.calculateLongSideCoordinate(this.visualizedScalarRange.max),s=this.calculateLongSideCoordinate(this.visualizedScalarRange.min),n=(t-s)/(i-s)*this.visualizedScalarRange.magnitude+this.visualizedScalarRange.min;return isNaN(n)&&Zh.warn(`Tried to getValueFromCoordinatesInVisualizedRange but value was ${n}`),n}getClampedValueFromCoordinatesInRange(e){if(!this.currentScaleRange?.hasRange)return Zh.warn("Tried to getClampedValueFromCoordinatesInRange but currentScaleRange was not valid"),0;const t=this.getValueFromCoordinates(e);return t>this.currentScaleRange.highValue?this.currentScaleRange.highValue:t<this.currentScaleRange.lowValue?this.currentScaleRange.lowValue:t}getViewportCoordinates(){const e=this.viewer.getCamera()?.getViewport(!0)?.slice();return e?(this.lastRenderedViewport||(this.lastRenderedViewport=e.slice()),this.getCornerCoordinatesFromViewportVector(e)):(Zh.debug("Tried to get viewport coordinates but the viewport was falsey"),null)}getCornerCoordinatesFromViewportVector(e){return{bottomLeft:k.YFv.fromXY(e[0],e[1]),topRight:k.YFv.fromXY(e[0]+e[2],e[1]+e[3])}}changeLegendOrientation(e){this.isVertical=!this.isVertical;const t=X.default.getManager();this.isVertical?(this.colorMapDimensions.width=t.getNumber("LEGEND_COLOR_MAP_VERTICAL_WIDTH_PX"),this.colorMapDimensions.height=t.getNumber("LEGEND_COLOR_MAP_VERTICAL_HEIGHT_PX"),this.colorMapPadding.left=t.getNumber("LEGEND_VERTICAL_LEFT_MARGIN_PX"),this.colorMapPadding.bottom=t.getNumber("LEGEND_VERTICAL_BOTTOM_MARGIN_PX"),this.colorMapPadding.right=t.getNumber("LEGEND_VERTICAL_RIGHT_MARGIN_PX"),this.colorMapPadding.top=t.getNumber("LEGEND_VERTICAL_TOP_MARGIN_PX")):(this.colorMapDimensions.width=t.getNumber("LEGEND_COLOR_MAP_HORIZONTAL_WIDTH_PX"),this.colorMapDimensions.height=t.getNumber("LEGEND_COLOR_MAP_HORIZONTAL_HEIGHT_PX"),this.colorMapPadding.left=t.getNumber("LEGEND_HORIZONTAL_LEFT_MARGIN_PX"),this.colorMapPadding.bottom=t.getNumber("LEGEND_HORIZONTAL_BOTTOM_MARGIN_PX"),this.colorMapPadding.right=t.getNumber("LEGEND_HORIZONTAL_RIGHT_MARGIN_PX"),this.colorMapPadding.top=t.getNumber("LEGEND_HORIZONTAL_TOP_MARGIN_PX")),this.colorMapCorners&&(this.colorMapCorners.bottomLeft.x=this.colorMapCorners.bottomLeft.x+this.colorMapDimensions.height/2-this.colorMapDimensions.width/2,this.colorMapCorners.bottomLeft.y=this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.width/2-this.colorMapDimensions.height/2,this.colorMapCorners.topRight.x=this.colorMapCorners.bottomLeft.x+this.colorMapDimensions.width,this.colorMapCorners.topRight.y=this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.height),e&&(this.colorMapCorners.bottomLeft.x-this.colorMapPadding.left<e.left?(this.colorMapCorners.bottomLeft.x=e.left+this.colorMapPadding.left,this.colorMapCorners.topRight.x=this.colorMapCorners.bottomLeft.x+this.colorMapDimensions.width):this.colorMapCorners.topRight.x+this.colorMapPadding.right>e.right&&(this.colorMapCorners.topRight.x=e.right-this.colorMapPadding.right,this.colorMapCorners.bottomLeft.x=this.colorMapCorners.topRight.x-this.colorMapDimensions.width),this.colorMapCorners.bottomLeft.y-this.colorMapPadding.bottom<e.bottom?(this.colorMapCorners.bottomLeft.y=e.bottom+this.colorMapPadding.bottom,this.colorMapCorners.topRight.y=this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.height):this.colorMapCorners.topRight.y+this.colorMapPadding.top>e.top&&(this.colorMapCorners.topRight.y=e.top-this.colorMapPadding.top,this.colorMapCorners.bottomLeft.y=this.colorMapCorners.topRight.y-this.colorMapDimensions.height))}onDevicePixelRatioChanged(e){if(this.isHidden)return void this.changeLegendOrientation();const t=(0,ns.x_)();if(!this.lastUsedDevicePixelRatio||t===this.lastUsedDevicePixelRatio)return;const i=this.lastRenderedViewport,s=e.getViewport(!0).slice(),n=t/this.lastUsedDevicePixelRatio;if(this.colorMapPadding.left*=n,this.colorMapPadding.top*=n,this.colorMapPadding.right*=n,this.colorMapPadding.bottom*=n,this.colorMapDimensions.width*=n,this.colorMapDimensions.height*=n,this.isVertical){const e=(.5*i[3]-this.colorMapCorners.bottomLeft.y)*n;this.colorMapCorners.bottomLeft.y=.5*s[3]-e;if(this.colorMapCorners.bottomLeft.x+this.colorMapDimensions.width/2>=i[2]/2){const e=(i[2]-this.colorMapCorners.bottomLeft.x)*n;this.colorMapCorners.bottomLeft.x=s[2]-e}else this.colorMapCorners.bottomLeft.x*=n}else{const e=(.5*i[2]-this.colorMapCorners.bottomLeft.x)*n;this.colorMapCorners.bottomLeft.x=.5*s[2]-e;if(this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.height/2>=i[3]/2){const e=(i[3]-this.colorMapCorners.bottomLeft.y)*n;this.colorMapCorners.bottomLeft.y=s[3]-e}else this.colorMapCorners.bottomLeft.y*=n}this.colorMapCorners.topRight.x=this.colorMapCorners.bottomLeft.x+this.colorMapDimensions.width,this.colorMapCorners.topRight.y=this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.height,this.lastRenderedViewport=s,this.lastUsedDevicePixelRatio=t,this.updateGraphics()}onAppearanceConstantsUpdated(){this.updateConstants(),this.updateGraphics()}onResize(e,t){const i=t[2]-e[2],s=t[3]-e[3];if(0===i&&0===s)return;const n=this.getCornerCoordinatesFromViewportVector(e),{shouldSnapTo:r}=this.getShouldSnapTo(n),a=this.getCornerCoordinatesFromViewportVector(t);let o=0,h=0;if(this.isVertical)if(h=s/2,r.left())this.snapToLeft(a);else{this.colorMapCorners.bottomLeft.x+this.colorMapDimensions.width/2>=e[2]/2&&(o=i)}else if(o=i/2,r.top())this.snapToTop(a);else{this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.height/2>=e[3]/2&&(h=s)}this.moveLegend(k.YFv.fromXY(-o,-h),a,!0)}moveLegend(e,t=this.getViewportCoordinates(),i=!1){const{shouldSnapTo:s,snappableBounds:n}=this.getShouldSnapTo(t,e);let r=!1;s.top()?(!this.isVertical||i||r||this.changeLegendOrientation(n),this.snapToTop(t),r=!0):s.bottom()?(!this.isVertical||i||r||this.changeLegendOrientation(n),this.snapToBottom(t),r=!0):(this.colorMapCorners.bottomLeft.y-=e.y,this.colorMapCorners.topRight.y-=e.y,this.isBeingDragged&&(this.legendDragPoint.y=this.legendDragPoint.y+e.y)),s.left()?(this.isVertical||i||r||this.changeLegendOrientation(n),this.snapToLeft(t),r=!0):s.right()?(this.isVertical||i||r||this.changeLegendOrientation(n),this.snapToRight(t),r=!0):(this.colorMapCorners.topRight.x-=e.x,this.colorMapCorners.bottomLeft.x-=e.x,this.isBeingDragged&&(this.legendDragPoint.x=this.legendDragPoint.x-e.x)),(0,Xs.sW)()&&(this.userHasMovedLegend=!0),this.legendMovedSubject.next(),this.isDamaged=!0}getLegendMovedObservable(){return this.legendMovedSubject.asObservable()}getShouldSnapTo(e,t=new k.YFv){const i=X.default.getManager(),s=i.getNumber("LEGEND_SIDE_SNAP_DEADZONE_PX"),n=i.getNumber("LEGEND_SIDE_SNAP_THRESHOLD_PX"),r=i.getNumber("LEGEND_VERTICAL_SNAP_THRESHOLD_PX"),a={right:e.topRight.x-s-n,left:e.bottomLeft.x+s+n,top:e.topRight.y-this.SNAPPING_MARGIN_TOP-r,bottom:e.bottomLeft.y+r};return{shouldSnapTo:{right:()=>this.colorMapCorners.topRight.x-t.x+this.colorMapPadding.right>a.right,left:()=>this.colorMapCorners.bottomLeft.x-t.x-this.colorMapPadding.left<a.left,top:()=>this.colorMapCorners.topRight.y-t.y+this.colorMapPadding.top>a.top,bottom:()=>this.colorMapCorners.bottomLeft.y-t.y-this.colorMapPadding.bottom<a.bottom},snappableBounds:a}}snapToTop(e){this.colorMapCorners.topRight.y=e.topRight.y-this.colorMapPadding.top-this.SNAPPING_MARGIN_TOP,this.colorMapCorners.bottomLeft.y=this.colorMapCorners.topRight.y-this.colorMapDimensions.height}snapToBottom(e){this.colorMapCorners.bottomLeft.y=e.bottomLeft.y+this.colorMapPadding.bottom,this.colorMapCorners.topRight.y=this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.height}snapToRight(e){const t=X.default.getManager().getNumber("LEGEND_SIDE_SNAP_DEADZONE_PX");this.colorMapCorners.topRight.x=e.topRight.x-this.colorMapPadding.right-t,this.colorMapCorners.bottomLeft.x=this.colorMapCorners.topRight.x-this.colorMapDimensions.width}snapToLeft(e){const t=X.default.getManager().getNumber("LEGEND_SIDE_SNAP_DEADZONE_PX");this.colorMapCorners.bottomLeft.x=e.bottomLeft.x+this.colorMapPadding.left+t,this.colorMapCorners.topRight.x=this.colorMapCorners.bottomLeft.x+this.colorMapDimensions.width}remove(){super.remove(),this.colorMapMaterial.destroy(),this.clearText(),this.removeSubject.next()}getRemoveObservable(){return this.removeSubject.asObservable()}setActiveColorMapping(e){this.colorMapMaterial.ambientTexture=this.viewer.getResources().scalarVisualizationTextures.get(e)}setInputRange(e){this.rangeInData=e.rangeInData,e.defaultDisplayRange?this.defaultDisplayRange=e.defaultDisplayRange:this.defaultDisplayRange=e.rangeInData,this.visualizedScalarRange||this.setVisualizedScalarRange(this.defaultDisplayRange)}setVisualizedScalarRange(e){this.visualizedScalarRange=e,!this.isTickBeingDragged&&e&&(this.currentScaleRange=e.clone()),this.isDamaged=!0}clearRanges(){this.rangeInData=null,this.visualizedScalarRange=null,this.isDamaged=!0}hide(){this.clearText(),this.isDamaged=!0,this.isPendingShow=!1,super.hide()}onViewWillDraw(e){if(this.isHidden)return;const t=e.getViewport(!0);this.lastRenderedViewport?(0,pi.arraysEqual)(this.lastRenderedViewport,t)||(this.onResize(this.lastRenderedViewport,t),this.lastRenderedViewport=t.slice()):(this.lastRenderedViewport=t.slice(),this.isDamaged=!0),this.isDamaged&&this.updateGraphics()}getInputRangeInDisplayUnits(){if(this.rangeInData){const e=(0,kh.r)(this.rangeInData,this.visualizedFieldType);return this.isInverted&&!e.isInverted?e.cloneInverted():e}return null}getDefaultDisplayRangeInDisplayUnits(){return this.defaultDisplayRange?(0,kh.r)(this.defaultDisplayRange,this.visualizedFieldType):null}setupCorners(){this.colorMapCorners=this.getViewportCoordinates()}calculateInitialLegendPosition(){if(this.lastUsedDevicePixelRatio!==(0,ns.x_)())return null;const e=this.getViewportCoordinates();if(!e)return null;const t=k.YFv.fromArray([(e.topRight.x-this.colorMapPadding.right-this.colorMapDimensions.width+this.colorMapPadding.left)/2,e.topRight.y-this.SNAPPING_MARGIN_TOP-this.colorMapDimensions.height-this.colorMapPadding.top]);return{bottomLeft:t,topRight:k.YFv.fromArray([t.x+this.colorMapDimensions.width,t.y+this.colorMapDimensions.height])}}createRectangleUsingLegendBounds(e,t){const i=X.default.getManager().getNumber("LEGEND_BACKGROUND_CORNER_RADIUS_PX");return(0,Yd.Dw)([this.colorMapCorners.bottomLeft.x-this.colorMapPadding.left,this.colorMapCorners.bottomLeft.y-this.colorMapPadding.bottom,t],[this.colorMapCorners.topRight.x+this.colorMapPadding.right,this.colorMapCorners.bottomLeft.y-this.colorMapPadding.bottom,t],[this.colorMapCorners.bottomLeft.x-this.colorMapPadding.left,this.colorMapCorners.topRight.y+this.colorMapPadding.top,t],i,5,e)}createHighlightRegion(e,t,i,s,n){const r=Math.max(this.colorMapDimensions.width,this.colorMapDimensions.height),a=Math.min(this.colorMapDimensions.width,this.colorMapDimensions.height),o=this.colorMapCorners.bottomLeft.x,h=this.colorMapCorners.bottomLeft.y;let c=i*r,l=c+(s-i)*r;const d=a/2,u=X.default.getManager().getNumber("LEGEND_OVERFLOW_DISPLAY_OFFSET_PX");let g,p;n===zh.s.MIN&&this.isInputMinimumChanged()?c-=u:n===zh.s.MAX&&this.isInputMaximumChanged()&&(l+=u),this.isVertical?(g=[d+o,c+h,lc],p=[d+o,l+h,lc]):(g=[c+o,d+h,lc],p=[l+o,d+h,lc]);return(0,Yd.W5)(g,p,e,t,a/this.lastUsedDevicePixelRatio)}requiresHighlightGraphics(){return!1}createHighlightGraphics(){if(!this.requiresHighlightGraphics())return;if(!this.visualizedScalarRange?.hasRange)return void Zh.warn("Tried to createHighlightGraphics but visualizedScalarRange was not valid");if(!this.currentScaleRange?.hasRange)return void Zh.warn("Tried to createHighlightGraphics but currentScaleRange was not valid");const e=this.currentScaleRange.getNormalizedValue(this.visualizedScalarRange.min),t=this.currentScaleRange.getNormalizedValue(this.visualizedScalarRange.max);if(this.manager.getUseMinValueHighlight()){const t=this.manager.getMinHighlightColor(),i=this.createHighlightRegion(rc,t,0,e,zh.s.MIN);this.updateMeshIncrement(rc,yi.ZJ,i,qh)}if(this.manager.getUseMaxValueHighlight()){const e=this.manager.getMaxHighlightColor(),i=this.createHighlightRegion(ac,e,t,1,zh.s.MAX);this.updateMeshIncrement(ac,yi.ZJ,i,qh)}if(this.manager.getUseDimColorScale()){const i=this.manager.getDimHighlightColor(),s=this.createHighlightRegion(oc,i,e,t);this.updateMeshIncrement(oc,yi.ZJ,s,qh)}}updateGraphics(){if(this.isHidden)return;this.removeMeshIncrements();if(this.clearText(!0),this.lastUsedDevicePixelRatio||(this.lastUsedDevicePixelRatio=(0,ns.x_)()),!this.colorMapCorners){const e=this.calculateInitialLegendPosition();if(!e)return;this.colorMapCorners=e}const e=this.createRectangleUsingLegendBounds(sc,0);(0,Yd.Ab)(this.backgroundColor,e),(0,Yd.Ae)(e,this.backgroundColor[3]),this.updateMeshIncrement(sc,yi.ZJ,e,Kh);const t=this.createRectangleUsingLegendBounds(nc,.2);this.updateMeshIncrement(nc,Qh,t,jh);if(this.createColorMapQuads().forEach((e=>this.updateMeshIncrement(e.id,ec,e,this.colorMapNodeProperties))),this.isDamaged=!1,this.createHighlightGraphics(),!this.visualizedScalarRange?.hasRange)return void this.clearTextCache();if(!this.currentScaleRange?.hasRange)return void Zh.warn("Tried to updateGraphics but currentScaleRange was not valid");const i=X.default.getManager(),s=this.isVertical?this.colorMapCorners.bottomLeft.x:this.colorMapCorners.bottomLeft.y,n=i.getNumber("LEGEND_TICK_LENGTH_PX"),r=s-n,a=i.getColor("LEGEND_TICK_SCALE_COLOR"),o=i.getNumber("LEGEND_TICK_TEXT_GAP_PX"),h=i.getNumber("LEGEND_TICK_WIDTH");for(let e=0;e<6;e++){const t=this.currentScaleRange.magnitude/5*e+this.currentScaleRange.min,i=this.calculateLongSideCoordinate(t),n="legendScaleTick"+e,c=this.createTick(i,s,r,hc,n,a,h);this.updateMeshIncrement(n,yi.ZJ,c,qh);let l=null,d=this.manager.getValueString(t),u=hc;if(0===e?(u=.5,l=this.LEGEND_MINIMUM_CLICKED,this.isDisplayMinimumChanged()&&(d+="*")):5===e&&(u=.5,l=this.LEGEND_MAXIMUM_CLICKED,this.isDisplayMaximumChanged()&&(d+="*")),this.isVertical){const e=k.d0F.fromArray([r-o,i,u]);this.placeText(d,e,wi.iK.HIGH,wi.iK.MID,n,l)}else{const e=k.d0F.fromArray([i,r-o,u]);this.placeText(d,e,wi.iK.MID,wi.iK.HIGH,n,l)}}this.createMinMaxTick(zh.s.MIN),this.createMinMaxTick(zh.s.MAX),this.createMinMaxInputRangeText(n),this.clearTextCache()}createMinMaxInputRangeText(e){if(this.isInputMaximumChanged()){const t=this.getInputRangeValueString(zh.s.MAX),i=new k.d0F;i.z=hc,this.isVertical?(i.x=this.colorMapCorners.topRight.x-this.colorMapDimensions.width/2,i.y=this.colorMapCorners.topRight.y+e):(i.x=this.colorMapCorners.topRight.x+e,i.y=this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.height/2);const s=this.isVertical?wi.iK.MID:wi.iK.LOW,n=this.isVertical?wi.iK.LOW:wi.iK.MID;this.placeText(t,i,s,n)}if(this.isInputMinimumChanged()){const t=this.getInputRangeValueString(zh.s.MIN),i=new k.d0F;i.z=hc,this.isVertical?(i.x=this.colorMapCorners.topRight.x-this.colorMapDimensions.width/2,i.y=this.colorMapCorners.bottomLeft.y-e):(i.x=this.colorMapCorners.bottomLeft.x-e,i.y=this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.height/2);const s=this.isVertical?wi.iK.MID:wi.iK.HIGH,n=this.isVertical?wi.iK.HIGH:wi.iK.MID;this.placeText(t,i,s,n)}}getInputRangeValueString(e){const t=this.getInputRangeInDisplayUnits(),i=e===zh.s.MAX?t?.max:t?.min;return this.manager.getValueString(i)}createColorMapQuad(e,t,i,s){const n=s?s[0]:void 0,r=s?s[1]:void 0,a=this.isVertical?[t.x,t.y,cc]:[t.x,i.y,cc],o=this.isVertical?[i.x,t.y,cc]:[t.x,t.y,cc],h=this.isVertical?[t.x,i.y,cc]:[i.x,i.y,cc];return(0,Yd.fQ)(a,o,h,e,n,r)}createColorMapQuads(){const e=[],t=[[1,1],[1,1]],i=[[0,1],[1,0]],s=X.default.getManager().getNumber("LEGEND_OVERFLOW_DISPLAY_OFFSET_PX");if(this.isVertical){let n=this.colorMapCorners.topRight.y,r=this.colorMapCorners.bottomLeft.y;if(this.visualizedScalarRange?.hasRange&&this.isInputMaximumChanged()){n=this.calculateLongSideCoordinate(this.visualizedScalarRange.max);const t=k.YFv.fromArray([this.colorMapCorners.bottomLeft.x,n]),i=k.YFv.fromArray([this.colorMapCorners.topRight.x,this.colorMapCorners.topRight.y+s]),r=this.createColorMapQuad(tc,t,i);e.push(r)}if(this.visualizedScalarRange?.hasRange&&this.isInputMinimumChanged()){r=this.calculateLongSideCoordinate(this.visualizedScalarRange.min);const i=k.YFv.fromArray([this.colorMapCorners.topRight.x,r]),n=k.YFv.fromArray([this.colorMapCorners.bottomLeft.x,this.colorMapCorners.bottomLeft.y-s]),a=this.createColorMapQuad(ic,n,i,t);e.push(a)}const a=k.YFv.fromArray([this.colorMapCorners.bottomLeft.x,r]),o=k.YFv.fromArray([this.colorMapCorners.topRight.x,n]),h=this.createColorMapQuad(ec,a,o,i);e.push(h)}else{let n=this.colorMapCorners.topRight.x,r=this.colorMapCorners.bottomLeft.x;if(this.visualizedScalarRange?.hasRange&&this.isInputMaximumChanged()){n=this.calculateLongSideCoordinate(this.visualizedScalarRange.max);const t=k.YFv.fromArray([n,this.colorMapCorners.bottomLeft.y]),i=k.YFv.fromArray([this.colorMapCorners.topRight.x+s,this.colorMapCorners.topRight.y]),r=this.createColorMapQuad(tc,t,i);e.push(r)}if(this.visualizedScalarRange?.hasRange&&this.isInputMinimumChanged()){r=this.calculateLongSideCoordinate(this.visualizedScalarRange.min);const i=k.YFv.fromArray([this.colorMapCorners.bottomLeft.x-s,this.colorMapCorners.bottomLeft.y]),n=k.YFv.fromArray([r,this.colorMapCorners.topRight.y]),a=this.createColorMapQuad(ic,i,n,t);e.push(a)}const a=k.YFv.fromArray([r,this.colorMapCorners.bottomLeft.y]),o=k.YFv.fromArray([n,this.colorMapCorners.topRight.y]),h=this.createColorMapQuad(ec,a,o,i);e.push(h)}return e}clearText(e=!1){this.clearTextCache();for(let t=0;t<this.valueTextElements.length;++t){const i=this.valueTextElements[t].text;e?(i.viewer.uiSelectionManager.removeSelectionForUiElement(i),this.textCache.push(i)):i.remove(),this.stopListening(i)}this.valueTextElements=[]}getOrCreateText(e,t){for(let i=0;i<this.textCache.length;++i){const s=this.textCache[i];if(s.hasEqualTextAndOptions(e,t))return this.textCache.splice(i,1),s.show(),s}return new Ba(this.viewer,e,t)}clearTextCache(){for(let e=0;e<this.textCache.length;++e)this.textCache[e].remove();this.textCache=[]}get isInverted(){return this.visualizedScalarRange?.isInverted}isInputMinimumChanged(){return k.dGY.isMinChanged(this.getInputRangeInDisplayUnits(),this.visualizedScalarRange,Ri.W.ZERO_LENGTH)}isInputMaximumChanged(){return k.dGY.isMaxChanged(this.getInputRangeInDisplayUnits(),this.visualizedScalarRange,Ri.W.ZERO_LENGTH)}isDisplayMinimumChanged(){return k.dGY.isMinChanged(this.getDefaultDisplayRangeInDisplayUnits(),this.currentScaleRange,Ri.W.ZERO_LENGTH)}isDisplayMaximumChanged(){return k.dGY.isMaxChanged(this.getDefaultDisplayRangeInDisplayUnits(),this.currentScaleRange,Ri.W.ZERO_LENGTH)}calculateLongSideCoordinate(e){if(!this.currentScaleRange?.hasRange)return Zh.warn("Tried to calculateLongSideCoordinate but currentScaleRange was not valid"),0;let t;if(t=this.isVertical?this.colorMapCorners.bottomLeft.y+this.colorMapDimensions.height*(e-this.currentScaleRange.min)/this.currentScaleRange.magnitude:this.colorMapCorners.bottomLeft.x+this.colorMapDimensions.width*(e-this.currentScaleRange.min)/this.currentScaleRange.magnitude,isNaN(t))return Zh.warn(`Tried to calculateLongSideCoordinate but coordinate was ${t}`),0;const i=(0,ns.x_)()/2;return Math.round(t+i)-i}createMinMaxTick(e){if(!this.visualizedScalarRange?.hasRange)return void Zh.warn("Tried to createMinMaxTick but visualizedScalarRange was not valid");const t=e===zh.s.MAX,i=t?Jh:$h,s=t?this.visualizedScalarRange.max:this.visualizedScalarRange.min,n=this.calculateLongSideCoordinate(s),r=X.default.getManager(),a=r.getNumber("LEGEND_TICK_LENGTH_PX"),o=r.getColor("LEGEND_TICK_MIN_MAX_COLOR"),h=r.getNumber("LEGEND_TICK_WIDTH"),c=h+2*r.getNumber("LEGEND_TICK_MIN_MAX_OUTLINE_WIDTH"),l=r.getColor("LEGEND_TICK_MIN_MAX_OUTLINE_COLOR"),d=r.getNumber("LEGEND_TICK_CLICK_TARGET_WIDTH_PX"),u=r.getNumber("LEGEND_TICK_TEXT_GAP_PX"),g=this.isVertical?this.colorMapCorners.topRight.x:this.colorMapCorners.topRight.y,p=this.isVertical?this.colorMapCorners.bottomLeft.x-a:this.colorMapCorners.bottomLeft.y-a,m=this.createTick(n,g,p,.45,i,l,c);this.updateMeshIncrement(i+"outline",i,m,qh);const f=this.createTick(n,g,p,dc,i,o,h);this.updateMeshIncrement(i,i,f,qh);const I=this.createTick(n,g,p,dc,i,o,d);if(this.updateMeshIncrement(i+"target",i,I,Yh),t&&this.tickBeingDragged===zh.s.MAX||!t&&this.tickBeingDragged===zh.s.MIN){const e=this.manager.getValueString(s),t="",r=!0;if(this.isVertical){const s=k.d0F.fromArray([p-u,n,dc]);this.placeText(e,s,wi.iK.HIGH,wi.iK.MID,t,i,r)}else{const s=k.d0F.fromArray([n,p-u,dc]);this.placeText(e,s,wi.iK.MID,wi.iK.HIGH,t,i,r)}}}createTick(e,t,i,s,n,r,a){let o;return o=this.isVertical?(0,Yd.W5)([i,e,s],[t,e,s],n,r):(0,Yd.W5)([e,i,s],[e,t,s],n,r),(0,Yd.VQ)(a,o),o}placeText(e,t,i,s,n,r,a){const o={...r?this.clickableFontOptions:this.defaultFontOptions};o.size=Math.floor(X.default.getManager().getNumber("LEGEND_TICK_TEXT_HEIGHT_PX"));const h=this.getOrCreateText(e,o);if(h.positionRelativeTo([t.x,t.y,t.z],i,s),r){this.listenTo(h,yi.zw.MOUSE_ENTER+Ba.SELECTION_ID,(()=>{this.viewer.pushCursor(mc),h.updateWithOptions(this.hoverFontOptions)})),this.listenTo(h,yi.zw.MOUSE_LEAVE+Ba.SELECTION_ID,(()=>{this.onMouseLeavePopCursor(mc),h.updateWithOptions(this.clickableFontOptions)}));const e=this.getInputRangeInDisplayUnits();this.listenTo(h,yi.zw.CLICK+Ba.SELECTION_ID,((t,i)=>{this.viewer.getEventDispatcher().trigger(r,i.sourceEvent,e,h.getTextCenterInCanvas())}))}if(a){const e=h.getTransformedBounds().getXyBounds();for(let t=0;t<this.valueTextElements.length;++t){const i=this.valueTextElements[t];e.overlapsWith(i.text.getTransformedBounds().getXyBounds())&&(i.text.hide(),i.associatedTickId&&this.hideIncrement(i.associatedTickId))}}this.valueTextElements.push({text:h,associatedTickId:n})}getColorMapCorners(){return this.colorMapCorners}show(){this.isPendingShow=!0,_o(this.defaultFontOptions,this.clickableFontOptions,this.hoverFontOptions).catch((e=>{Zh.warn(`failed to load font for scalar visualization legend: ${e}`)})).finally((()=>{this.isPendingShow&&(this.isPendingShow=!1,super.show())}))}}var Sc=i(8255);const Tc=_e.O.createLogger("ScalarVisualizationManager",k.bVy.GRAPHICS);class Dc{constructor(e){this.modelViewManager=e,this.supportsInContextMode=!1,this.nodes=[],this.visualizationStateSubject=new As.x,this.DEFAULT_COLOR_MAPPING=k.ZIP.VIRIDIS,this.scalarVisualizationMaterials=[],this.keepLegendHiddenAndAllowControls=!1,this.webAssemblyUtils=uI.module}cloneVisualizationState(e){return e.clone()}static getMapIndex(e){return Dc.imageMaps.findIndex((t=>t.type===e))}viewerIsInScalarVisualizationRenderMode(){return this.getViewer().getRenderingMode()===this.graphicsRenderMode}usesGraphicsRenderMode(e){return e===this.graphicsRenderMode}getRangeInData(){return this.displayedScalarRangeSpecification?this.displayedScalarRangeSpecification.rangeInData:null}setRangeInData(e){this.displayedScalarRangeSpecification?(this.displayedScalarRangeSpecification.rangeInData=e,this.getDefaultDisplayRange()||this.setVisualizedRange(e)):Tc.debug("Tried to set rangeInData but displayedScalarRangeSpecification was null")}getDefaultDisplayRange(){return this.displayedScalarRangeSpecification?this.displayedScalarRangeSpecification.defaultDisplayRange:null}updateDefaultDisplayRange(e){this.displayedScalarRangeSpecification?this.displayedScalarRangeSpecification.defaultDisplayRange=e:Tc.debug("Tried to set defaultDisplayRange but displayedScalarRangeSpecification was null")}setDefaultDisplayRange(e){this.updateDefaultDisplayRange(e),this.setVisualizedRange(e)}getSupportsInContextMode(){return this.supportsInContextMode}getColorMappingName(){const{colorMapping:e}=this.visualizationState;return k.hDy[e]}getMinHighlightColor(){const e=X.default.getManager(),t=this.getColorMappingName();return e.getColor(Dc.MIN_COLOR_CONSTANT+t)}getMaxHighlightColor(){const e=X.default.getManager(),t=this.getColorMappingName();return e.getColor(Dc.MAX_COLOR_CONSTANT+t)}getDimHighlightColor(){const e=X.default.getManager(),t=this.getColorMappingName();return e.getColor(Dc.DIM_COLOR_CONSTANT+t)}updateScalarRangeUniforms(){const e=this.getRangeInData();if(!e||!this.visualizedScalarRange)return;const t=e.max,i=e.magnitude;let s=1/i;i<=Ri.W.ZERO_LENGTH?(s=0,i<0&&Tc.debug("Invalid scalar input range")):i>16777216&&Tc.info(`Scalar range had a magnitude greater than 1.67e+7: ${i} for ${this.VISUALIZATION_MANAGER_NODE_ID}`);const n=this.getRangeInBaseUnits(this.visualizedScalarRange),r=n.max,a=n.magnitude,o=1/a,h=X.default.getManager(),c=this.getMinHighlightColor(),l=this.getMaxHighlightColor(),d=this.getDimHighlightColor(),u=h.getNumber(Dc.BLEND_WIDTH_CONSTANT),g=1/u,p=this.getUseMinValueHighlight()?1:0,m=this.getUseMaxValueHighlight()?1:0,f=this.getUseDimColorScale()?1:0;for(const e of this.scalarVisualizationMaterials)e.setCustomFloatUniform(Dc.SCALAR_INPUT_MAXIMUM_UNIFORM,t),e.setCustomFloatUniform(Dc.SCALAR_INPUT_MAGNITUDE_INVERSE_UNIFORM,s),e.setCustomFloatUniform(Dc.SCALAR_OUTPUT_MAXIMUM_UNIFORM,r),e.setCustomFloatUniform(Dc.SCALAR_OUTPUT_MAGNITUDE_UNIFORM,a),e.setCustomFloatUniform(Dc.SCALAR_OUTPUT_MAGNITUDE_INVERSE_UNIFORM,o),e.setCustomIntUniform(Dc.USE_MIN_VALUE_UNIFORM,p),e.setCustomIntUniform(Dc.USE_MAX_VALUE_UNIFORM,m),e.setCustomIntUniform(Dc.USE_DIM_COLOR_UNIFORM,f),e.setCustomVectorUniform(Dc.MIN_COLOR_UNIFORM,c),e.setCustomVectorUniform(Dc.MAX_COLOR_UNIFORM,l),e.setCustomVectorUniform(Dc.DIM_COLOR_UNIFORM,d),e.setCustomFloatUniform(Dc.HIGHLIGHT_REGION_BLEND_DISTANCE,u),e.setCustomFloatUniform(Dc.HIGHLIGHT_REGION_BLEND_INVERSE_DISTANCE,g)}getUseMinValueHighlight(){return!1}getUseMaxValueHighlight(){return!1}getUseDimColorScale(){return!1}getVisualizationState(){return this.visualizationState}getVisualizationStateObservable(){return this.visualizationStateSubject.asObservable()}getRangeInDisplayUnits(e){return e}getValueInDisplayUnits(e){return e}getRangeInBaseUnits(e){return e}convertValueBetweenDisplayAndBaseUnits(e,t){return e}setVisualizationState(e){const t=this.visualizationState?this.displayedColorMap:null,i=null===t||t!==e.colorMapping,s=!this.visualizationState||!this.visualizationState.visualizedRange||!this.visualizationState.visualizedRange.equals(e.visualizedRange);this.visualizationState=e,this.visualizationStateSubject.next(e),this.updateGraphics(),i&&this.updateColorMapping(t,this.visualizationState.colorMapping),s&&this.updateVisualizedScalarRange(),this.readyToShowLegend()||this.hideLegend()}setVisualizedRange(e){const t=this.cloneVisualizationState(this.getVisualizationState());t.visualizedRange=e,this.setVisualizationState(t)}setVisualizedScaleComponent(e,t,i){const s=this.convertValueBetweenDisplayAndBaseUnits(e,!0),n=this.visualizedScalarRange?.clone();switch(t){case zh.s.MAX:n.max=s,this.visualizationState.userSetRangeMax=i;break;case zh.s.MIN:n.min=s,this.visualizationState.userSetRangeMin=i}this.setVisualizedRange(n)}resetVisualizedScaleRangeComponent(e){const t=this.getVisualizedScaleResetValue(e),i=this.convertValueBetweenDisplayAndBaseUnits(t,!1);this.setVisualizedScaleComponent(i,e,!1)}getVisualizedScaleResetValue(e){return this.getDefaultDisplayRange().getValueFromRangeComponent(e)}setColorMapping(e){if(e===this.displayedColorMap)return;localStorage.setItem(this.COLOR_MAP_STORAGE_KEY,""+e);const t=this.getVisualizationState().clone();t.colorMapping=e,this.setVisualizationState(t)}onRenderingModeChanged(){this.prepareResources(),this.viewerIsInScalarVisualizationRenderMode()?this.showLegend():(this.clearGraphics(),this.hideLegend())}clearGraphics(){this.resetScenegraphNodes(),this.cursorAppendage&&(this.cursorAppendage.destroy(),this.cursorAppendage=null),this.hideLegend(),this.getViewer().requestDraw()}updateVisualizedScalarRange(){if(this.updateScalarRangeUniforms(),this.legend&&this.visualizedScalarRange){const e=this.getRangeInDisplayUnits(this.visualizedScalarRange);this.legend.setVisualizedScalarRange(e)}this.getViewer().requestDraw()}updateColorMapping(e,t){this.hideMapping(e),this.showMapping(t),this.updateVisualizedScalarRange()}get displayedColorMap(){return this.visualizationState?this.visualizationState.colorMapping:(Tc.warn("No visualization state set"),k.ZIP.UNKNOWN)}hideMapping(e){const t=Dc.getMapIndex(e),i=this.nodes[t];i&&i.setVisible(!1)}showMapping(e){const t=Dc.getMapIndex(e),i=this.nodes[t];i&&i.setVisible(!0),this.legend&&this.legend.setActiveColorMapping(e),this.showLegend()}showLegend(){this.legend&&this.readyToShowLegend()&&this.legend.isHidden&&(this.keepLegendHiddenAndAllowControls||this.legend.show(),this.getViewer().getEventDispatcher().trigger(this.LEGEND_OPENED,this.displayedColorMap))}hideLegend(){this.legend&&(this.legend.hide(),this.getViewer().getEventDispatcher().trigger(this.LEGEND_CLOSED))}setKeepLegendHiddenAndAllowControls(e){this.keepLegendHiddenAndAllowControls=e,this.keepLegendHiddenAndAllowControls&&this.legend&&this.legend.hide()}get visualizedScalarRange(){return this.visualizationState?this.visualizationState.visualizedRange:(Tc.debug("Visualization state undefined when trying to get visualized range"),null)}resetScenegraphNodes(){if(this.rootNode){for(let e=0;e<this.nodes.length;++e)this.nodes[e].remove();this.nodes=[];for(let e=0;e<Dc.imageMaps.length;++e){const t=new Gi.NB(this.VISUALIZATION_MANAGER_NODE_ID+"."+e,{isPickable:!1,clippedBySectionPlanes:!0});t.setVisible(!1),this.nodes.push(t),this.rootNode.addChild(t)}}}getViewer(){return this.modelViewManager.getViewer()}readyToShowLegend(){return!1}createMaterialForTexture(e){const t=new Bi({ambientTexture:e});return t.shaderId="scalarVisualization",t}prepareResources(){if(0===this.scalarVisualizationMaterials.length&&this.getViewer().getGlContext())for(let e=0;e<Dc.imageMaps.length;++e){const t=new mo(this.getViewer().getGlContext());t.imageSource=Dc.imageMaps[e].source;const i=new Io(this.getViewer(),t);i.setHasTransparency(!1),this.getViewer().getResources().scalarVisualizationTextures.set(Dc.imageMaps[e].type,i);const s=this.createMaterialForTexture(i);s.setCustomFloatUniform("uOffsetFactor",0),s.setCustomIntUniform("uMakeUnsigned",0),this.scalarVisualizationMaterials.push(s)}if(!this.rootNode){const e=this.modelViewManager.getSharedBodyNode();this.rootNode=e.getChildById(this.VISUALIZATION_MANAGER_NODE_ID),this.rootNode||(this.rootNode=new Gi.NB(this.VISUALIZATION_MANAGER_NODE_ID),e.addChild(this.rootNode))}}getCursorValue(e,t){const i=k.YFv.fromArray([e,this.getViewer()?.getCamera()?.getViewportHeight()-t]);return this.legend?.isBeingDragged||!this.getRangeInData()?null:this.legend&&this.legend.areCoordinatesOverLegend(i)&&this.visualizedScalarRange?this.legend.getValueFromCoordinatesInVisualizedRange(i):this.findScalarVisualizationScalar(e,t)}getCursorText(e,t){if(this.legend?.isBeingDragged||!this.getRangeInData())return null;{const i=this.getCursorValue(e,t);if(null===i)return;return this.getValueString(i)}}findScalarVisualizationScalar(e,t){const i=this.getViewer().findScalarVisualizationScalar(this.VISUALIZATION_MANAGER_NODE_ID,this.getRangeInDisplayUnits(this.getRangeInData()),e,t);return 0===i.length?null:i[0].scalar}getValueString(e){const t=(0,fr.vx)().getLengthUnitsDisplayPrecision(),i=Sc.l.ScalarVisualization,s=1/Math.pow(10,Ri.W.SCALAR_VISUALIZATION_MAX_DECIMAL_PRECISION);return Sc.c.getNumberString(e,t,i,s)}isNodeForBodyVisualization(e){return 0===e.getId().indexOf(this.VISUALIZATION_MANAGER_NODE_ID)}getStoredColorMapping(){const e=localStorage.getItem(this.COLOR_MAP_STORAGE_KEY);return e&&Object.values(k.ZIP).includes(+e)?+e:this.DEFAULT_COLOR_MAPPING}getSampleMesh(e,t){return t.refinementHistory.history.length>0?this.webAssemblyUtils&&this.webAssemblyUtils.isReady?this.webAssemblyUtils.replaySampleMeshRefinementRoutine(e.sampleMesh,t.refinementHistory):(Tc.debug("Received refinement history for simulation data, but sampling utils module was not available"),e.sampleMesh):e.sampleMesh}}Dc.SCALAR_INPUT_MAXIMUM_UNIFORM="uScalarInputMax",Dc.SCALAR_INPUT_MAGNITUDE_INVERSE_UNIFORM="uScalarInputMagnitudeInverse",Dc.SCALAR_OUTPUT_MAXIMUM_UNIFORM="uScalarOutputMax",Dc.SCALAR_OUTPUT_MAGNITUDE_UNIFORM="uScalarOutputMagnitude",Dc.SCALAR_OUTPUT_MAGNITUDE_INVERSE_UNIFORM="uScalarOutputMagnitudeInverse",Dc.USE_MIN_VALUE_UNIFORM="uUseMinColor",Dc.USE_MAX_VALUE_UNIFORM="uUseMaxColor",Dc.USE_DIM_COLOR_UNIFORM="uUseDimColor",Dc.MIN_COLOR_UNIFORM="uMinColor",Dc.MAX_COLOR_UNIFORM="uMaxColor",Dc.DIM_COLOR_UNIFORM="uDimColor",Dc.HIGHLIGHT_REGION_BLEND_DISTANCE="uHighlightRegionBlendDistance",Dc.HIGHLIGHT_REGION_BLEND_INVERSE_DISTANCE="uHighlightRegionBlendDistanceInverse",Dc.MIN_COLOR_CONSTANT="SCALAR_MIN_COLOR_",Dc.MAX_COLOR_CONSTANT="SCALAR_MAX_COLOR_",Dc.DIM_COLOR_CONSTANT="SCALAR_DIM_COLOR_",Dc.BLEND_WIDTH_CONSTANT="SCALAR_HIGHLIGHT_BLEND_WIDTH",Dc.imageMaps=[{type:k.ZIP.VIRIDIS,source:"/images/scalar-visualization-gradient-viridis.png"},{type:k.ZIP.RAINBOW,source:"/images/scalar-visualization-gradient-rainbow.png"},{type:k.ZIP.BLUE_RED,source:"/images/scalar-visualization-gradient.png"},{type:k.ZIP.PLASMA,source:"/images/scalar-visualization-gradient-plasma.png"}];var Cc=i(7575);class Mc extends Ec{constructor(e){super(e)}getRelevantPanelIdsForRepositioning(){return[...super.getRelevantPanelIdsForRepositioning(),Cc.i]}get SNAPPING_MARGIN_TOP(){return X.default.getManager().getNumber(this.TOP_TOOPBAR_HEIGHT_CONSTANT)+(0,ss.NO)(this.CANVAS_CONTROLS_PANEL_ID)*(0,ns.x_)()}}class yc extends Dc{constructor(){super(...arguments),this.supportsInContextMode=!0}}class Ac extends Mc{constructor(e){super(e),this.manager=e,this.LEGEND_MAXIMUM_CLICKED=os.fdd,this.LEGEND_MINIMUM_CLICKED=os.ibh,this.LEGEND_RANGE_CHANGED=os.JHq,this.CANVAS_CONTROLS_PANEL_ID=os.Wzm,this.TOP_TOOPBAR_HEIGHT_CONSTANT="CURVATURE_ANALYSIS_TOP_TOOLBAR_HEIGHT_PX"}getInputRangeValueString(e){return this.manager.getInputRangeBoundaryString(e)}isInputMaximumChanged(){const e=this.manager.getRangeInData();return!!(e&&e.max>_c)||super.isInputMaximumChanged()}getInputRangeInDisplayUnits(){return this.manager.getRangeInDisplayUnits(this.manager.getRangeInData())}getDefaultDisplayRangeInDisplayUnits(){return this.manager.getRangeInDisplayUnits(this.manager.getDefaultDisplayRange())}}var Pc=i(58648),Oc=i(94377),Rc=i(43171),wc=i(97196);const vc="meter",_c=1e4,Nc="CurvatureAnalysisManager",bc=k.ls1.getTessellationSettingIndexFromEnum(k.XiJ.CURVATURE_VISUALIZATION);class Lc extends yc{constructor(e){super(e.getModelViewManagers().getManager()),this.viewer=e,this.COLOR_MAP_STORAGE_KEY=Pc.xV,this.LEGEND_OPENED=os.A1q,this.LEGEND_CLOSED=os.Nwl,this.VISUALIZATION_MANAGER_NODE_ID=Nc,this.graphicsRenderMode=k.P1.SHADED_CURVATURE_VISUALIZATION,this.DEFAULT_COLOR_MAPPING=Rc.z,this.messageBubble=es.Jq.MessageBubbleService.createMessageBubbleWithAutoDismiss("warning"),this.visualizedRangeCache=new Map,this.curvatureTypeCache=new Map,this.displayedScalarRangeSpecification={rangeInData:null,defaultDisplayRange:null},this.visualizationState=new k.AON,this.mainScenegraphManager=new Bc(this.modelViewManager,"CurvatureAnalysis",this.scalarVisualizationMaterials),this.resetMeshes(),this.setColorMapping(this.getStoredColorMapping()),(0,nM.eR)(nM.Cr).subscribe((()=>{this.updateVisualizedScalarRange()}))}getViewer(){return this.viewer}isVisualizing(){return this.mainScenegraphManager.isVisualizing()||!!this.previewScenegraphManager?.isVisualizing()}resetScenegraphNodes(){this.mainScenegraphManager.resetScenegraphNodes(),this.previewScenegraphManager?.resetScenegraphNodes()}hideMapping(e){this.mainScenegraphManager.hideMapping(e),this.previewScenegraphManager?.hideMapping(e),super.hideMapping(e)}showMapping(e){this.mainScenegraphManager.showMapping(e),this.previewScenegraphManager?.showMapping(e),super.showMapping(e)}updateGraphics(){if(this.viewerIsInScalarVisualizationRenderMode()){if(this.cursorAppendage||(this.cursorAppendage=new as(this.getViewer(),((e,t)=>this.getCursorText(e,t)))),this.followModeCursorAppendage||(this.followModeCursorAppendage=new hs(this.getViewer(),((e,t)=>this.getCursorText(e,t)))),this.readyToShowLegend()){const e=this.getRangeInData(),t=this.getDefaultDisplayRange();this.legend.setInputRange({rangeInData:e,defaultDisplayRange:t})}this.showMapping(this.displayedColorMap),this.updateVisualizedScalarRange()}}convertValueBetweenDisplayAndBaseUnits(e,t){const i=(0,fr.vx)().getLengthUnits();if(!i)return null;const s=this.getCurvatureTypeUnitPower(),n={[i]:s},r={[vc]:s};return t?(0,Ir.NI)(e,n,r):(0,Ir.NI)(e,r,n)}getRangeInDisplayUnits(e){const t=(0,fr.vx)().getLengthUnits();return e&&t?(0,Ir.u0)(e,t,this.getCurvatureTypeUnitPower()):null}getRangeInBaseUnits(e){return(0,Ir.u0)(e,vc,this.getCurvatureTypeUnitPower())}getRangeInData(){let e;return e=ks()?this.previewScenegraphManager?.getRangeInData()??this.mainScenegraphManager.getRangeInData():this.mainScenegraphManager.getRangeInData()??this.previewScenegraphManager?.getRangeInData(),e?.addUnits(vc,this.getCurvatureTypeUnitPower())}getClampedRangeInData(){let e;return e=ks()?this.previewScenegraphManager?.getClampedRangeInData()??this.mainScenegraphManager.getClampedRangeInData():this.mainScenegraphManager.getClampedRangeInData()??this.previewScenegraphManager?.getClampedRangeInData(),e?.addUnits(vc,this.getCurvatureTypeUnitPower())}setRangeInData(e){this.mainScenegraphManager.setRangeInData(e),this.previewScenegraphManager?.setRangeInData(e)}setClampedRangeInData(e){this.mainScenegraphManager.setClampedRangeInData(e),this.previewScenegraphManager?.setClampedRangeInData(e)}readyToShowLegend(){return this.viewerIsInScalarVisualizationRenderMode()&&!!this.legend}prepareResources(){super.prepareResources(),this.legend||(this.legend=new Ac(this)),this.mainScenegraphManager.prepareResources(),this.previewScenegraphManager?.prepareResources()}clearAndUpdateCurvatures(){this.clearGraphics(),this.requestMissingCurvatureTessellations(),this.mainScenegraphManager.updateNodesWithCurvatureData(),this.getOrCreatePreviewScenegraphManager()?.updateNodesWithCurvatureData(),this.updateScalarRangeFromCurvatureData(),null===this.getRangeInData()&&this.legend?.clearRanges(),this.showLegend(),this.updateGraphics()}onRenderingModeChanged(){super.onRenderingModeChanged(),this.viewerIsInScalarVisualizationRenderMode()&&this.modelViewManager.displayingPartStudio()?(this.getViewer().getUserEnabledAggressiveRefinement()&&this.getViewer().setUserEnabledAggressiveRefinement(!1),this.clearAndUpdateCurvatures()):((this.isVisualizing()||this.mainScenegraphManager.getDisplayedPartStudioHasPendingTessellationRequests()||this.previewScenegraphManager?.getDisplayedPartStudioHasPendingTessellationRequests())&&this.getViewer().getEventDispatcher().trigger(nM.Jp),this.clearScalarVisualizationForVisualizedBodies())}onDocumentDestroyed(){this.mainScenegraphManager.clearPendingTessellationRequests(),this.destroyPreviewScenegraphManager(),this.curvatureTypeCache=new Map}onDocumentReconnect(){this.mainScenegraphManager.clearPendingTessellationRequests(),this.previewScenegraphManager?.clearPendingTessellationRequests()}onPreviewDestroyed(){this.destroyPreviewScenegraphManager(),this.readyToShowLegend()||this.hideLegend()}onEstimatedMemoryLimitExceeded(e=!1){e&&this.viewer.resetToDefaultRenderingMode(),this.messageBubble.showMessage(i18n("Color map may exceed browser memory limits. Try hiding unnecessary parts or surfaces.")),es.Jq.AngularEventService.ensureDigest()}destroyPreviewScenegraphManager(){this.previewScenegraphManager?.resetMeshes(),this.previewScenegraphManager=null}preventChangeToRenderMode(e){if(this.graphicsRenderMode!==e)return!1;if(Hs())return this.messageBubble.showMessage(i18n("Curvature color map is not currently supported while comparing.")),es.Jq.AngularEventService.ensureDigest(),!0;if(gi._3.getOpenDocumentController().isInterferenceDetectionActive())return this.messageBubble.showMessage(i18n("Curvature color map is not currently supported during interference detection.")),es.Jq.AngularEventService.ensureDigest(),!0;const t=this.mainScenegraphManager.getBodiesToVisualize()??new Set,i=this.previewScenegraphManager?.getBodiesToVisualize()??new Set;return!this.getViewer().getBodyManager().checkBodiesUnderMemoryLimit(bc,new Set([...t,...i]))&&(this.onEstimatedMemoryLimitExceeded(),!0)}onCheckInterferences(){this.graphicsRenderMode===this.getViewer().getRenderingMode()&&(es.Jq.MessageBubbleService.showMessageWithAutoDismiss(i18n("Curvature color map is not currently supported during interference detection."),"warning"),es.Jq.AngularEventService.ensureDigest(),this.getViewer().resetToDefaultRenderingMode())}userCanEnableColorMap(){const e=gi._3.getOpenDocumentController().isInterferenceDetectionActive(),t=Hs();return!e&&!t}onPartStudioDisplayed(){this.viewerIsInScalarVisualizationRenderMode()&&this.setCurvatureType(this.getCachedCurvatureTypeForElement())}onPartStudioDisplayDataChanged(e,t){if(!e.isNoop&&this.viewerIsInScalarVisualizationRenderMode()){if(e.hasCurvatureTessellation())this.clearAndUpdateCurvatures();else{this.requestMissingCurvatureTessellations()||this.clearAndUpdateCurvatures()}this.updateFollowModeCache()}}getCachedCurvatureTypeForElement(){const e=this.getViewer().getActiveElementId(),t=this.curvatureTypeCache.get(e);return t&&t!==k.Lck.UNKNOWN?t:k.Lck.GAUSSIAN}onChangeActiveElement(){this.clearGraphics()}clearGraphics(){this.clearScalarVisualizationForVisualizedBodies(),this.messageBubble.dismissMessage(),this.legend?.clearRanges(),this.setRangeInData(null),this.setClampedRangeInData(null),this.setDefaultDisplayRange(null),this.resetMeshes(),this.followModeCursorAppendage?.destroy(),this.followModeCursorAppendage=null,super.clearGraphics()}resetMeshes(){this.mainScenegraphManager?.resetMeshes(),this.previewScenegraphManager?.resetMeshes()}requestMissingCurvatureTessellations(){const e=this.mainScenegraphManager.getBodiesThatNeedCurvatureTessellations()??[],t=this.getOrCreatePreviewScenegraphManager()?.getBodiesThatNeedCurvatureTessellations()??[],i=new Set(e.concat(t));if(0===i.size)return!1;return this.requestCurvatureData(i)?(this.onEstimatedMemoryLimitExceeded(!0),!1):(this.mainScenegraphManager.didRequestCurvatureDataForBodies(e),this.getOrCreatePreviewScenegraphManager()?.didRequestCurvatureDataForBodies(t),!0)}getOrCreatePreviewScenegraphManager(){if(!this.previewScenegraphManager){const e=this.getViewer().getModelViewManagers().getPreviewManager(),t=e?.getDisplayedPartStudio();if(!t)return null;this.previewScenegraphManager=new Bc(e,"CurvatureAnalysisPreview",this.scalarVisualizationMaterials),this.previewScenegraphManager.prepareResources(),this.previewScenegraphManager.setCurvatureType(this.getCurvatureType())}return this.previewScenegraphManager}clearScalarVisualizationForVisualizedBodies(){this.mainScenegraphManager.isVisualizing()&&this.mainScenegraphManager.getBodyComponent()?.clearAllScalarVisualizationOccurrences(),this.previewScenegraphManager?.isVisualizing()&&this.previewScenegraphManager?.getBodyComponent()?.clearAllScalarVisualizationOccurrences()}requestCurvatureData(e){if(!e||0===e.size)return!1;const t=[];if(!this.viewer.getBodyManager().checkBodiesUnderMemoryLimit(bc,e))return!0;for(const i of e){const e=new k.A$B;e.bodyDeterministicId=i,e.tessellationSetting=bc,e.occurrence=null,e.elementId=this.modelViewManager.getDisplayedElementId(),e.microversionIdAndConfiguration=this.modelViewManager.getDisplayedElementMicroversionIdAndConfiguration(),t.push(e)}return this.getViewer().getEventDispatcher().trigger(nM.am,t),!1}setVisualizedScaleComponent(e,t,i){super.setVisualizedScaleComponent(e,t,i),this.updateVisualizedRangeCache()}getCurvatureTypeUnitPower(){switch(this.getCurvatureType()){case k.Lck.GAUSSIAN:return-2;case k.Lck.MEAN:return-1;case k.Lck.MAX_RADIUS:case k.Lck.MIN_RADIUS:default:return 1}}getBaseUnitsRange(e,t){return k.dGY.fromMinMax(e,t,vc,this.getCurvatureTypeUnitPower())}updateScalarRangeFromCurvatureData(){const e=this.getCachedRange(),t=this.getClampedRangeInData();this.updateDefaultDisplayRange(t);const i=this.getRangeInData(),s=this.convertValueBetweenDisplayAndBaseUnits(1,!0);if(i&&0===i.magnitude){let e;e=this.isInCurvatureRadiusMode()&&i.mean>_c?this.getBaseUnitsRange(0,s):this.isInCurvatureRadiusMode()&&i.mean<s?this.getBaseUnitsRange(0,2*i.mean):this.getBaseUnitsRange(i.mean-s,i.mean+s),this.updateDefaultDisplayRange(e)}e?this.setVisualizedRange(e):this.setVisualizedRange(this.getDefaultDisplayRange())}resetVisualizedScaleRangeComponent(e){super.resetVisualizedScaleRangeComponent(e),this.updateVisualizedRangeCache()}getVisualizedScaleResetValue(e){const t=this.getDefaultDisplayRange();switch(e){case zh.s.MIN:return t.min;case zh.s.MAX:return this.isInCurvatureRadiusMode()?Math.min(t.max,_c):t.max}}setCurvatureType(e){if(this.getCurvatureType()===e)return;const t=this.getVisualizationState().clone();t.curvatureType=e,this.setVisualizationState(t)}updateCurvatureType(e){this.mainScenegraphManager.setCurvatureType(e),this.previewScenegraphManager?.setCurvatureType(e),this.clearAndUpdateCurvatures();const t=this.getViewer().getActiveElementId();this.curvatureTypeCache.set(t,e)}getCurvatureType(){return this.visualizationState.curvatureType}moveLegendTo(e,t){if(!e||e.some((e=>!isFinite(e)))||!this.legend)return;this.legend.colorMapCorners?.bottomLeft||this.legend.setupCorners();const i=(0,ns.x_)(),s=e.map((e=>e*i));this.legend.setIsVertical(t);const n=this.legend.colorMapCorners.topRight.y-this.getViewer().getCamera().getCanvasHeight()+s[1],r=this.legend.colorMapCorners.bottomLeft.x-s[0],a=k.YFv.fromXY(r,n);a.isZeroVector()||this.legend.moveLegend(a,void 0,!0)}getLegend(){return this.legend}getLegendMovedObservable(){return this.prepareResources(),this.legend.getLegendMovedObservable()}isInCurvatureRadiusMode(){return this.getCurvatureType()===k.Lck.MAX_RADIUS||this.getCurvatureType()===k.Lck.MIN_RADIUS}onReceiveFollowModeMessage(e){if(!e||!e.visualizationState||!this.followViewDataMessageCache)return;this.setCurvatureType(e.visualizationState.curvatureType);const t=e.legendTopLeftCoordinates.slice(),i=wc.D.convertCanvasCoordinateLeaderToFollower(t,this.followViewDataMessageCache);this.moveLegendTo(i,e.legendIsVertical),this.shouldUpdateVisualizationStateFromMessage(e)?this.updateVisualizationStateFromMessage(e):this.followModeMessageCache=e}onReceiveFollowViewDataMessage(e){this.followViewDataMessageCache=e}shouldUpdateVisualizationStateFromMessage(e){return e&&this.getRangeInData()?.equals(e.rangeInData,Ri.W.ZERO_LENGTH)}updateVisualizationStateFromMessage(e){const t=e.visualizationState;t.visualizedRange?.noRange||(this.setVisualizationState(t),this.updateVisualizedRangeCache())}updateFollowModeCache(){this.followModeMessageCache&&((0,Xs.sW)()?this.shouldUpdateVisualizationStateFromMessage(this.followModeMessageCache)&&(this.updateVisualizationStateFromMessage(this.followModeMessageCache),this.followModeMessageCache=null):this.followModeMessageCache=null)}setVisualizationState(e){const t=this.getCurvatureType()!==e.curvatureType;super.setVisualizationState(e),t&&this.updateCurvatureType(e.curvatureType)}getCursorText(e,t){if(this.legend?.isBeingDragged||!this.getRangeInData())return null;{const i=this.getCursorValue(e,t);if(!(0,Oc.isNumber)(i))return;const s=!0;if(this.isInCurvatureRadiusMode()&&this.convertValueBetweenDisplayAndBaseUnits(i,s)>_c)return"♾️";const n=(0,fr.vx)().getLengthUnitsDisplayPrecision(),r=Sc.l.UserWorkspace,a=1/Math.pow(10,n);return Sc.c.getNumberString(i,n,r,a)}}getInputRangeBoundaryString(e){const t=this.getRangeInData(),i=t.getValueFromRangeComponent(e);if(this.isInCurvatureRadiusMode()&&i>_c)return"♾️";const s=this.getRangeInDisplayUnits(t).getValueFromRangeComponent(e);return this.getValueString(s)}updateVisualizedRangeCache(){const e=this.getViewer().getActiveElementId();if(!this.visualizedScalarRange||0===e.length)return;let t,i=this.visualizedRangeCache.get(e);i||(i=new Map),t=this.visualizedScalarRange.equals(this.getDefaultDisplayRange())?null:this.visualizedScalarRange,i.set(this.getCurvatureType(),t),this.visualizedRangeCache.set(e,i)}getCachedRange(){const e=this.getViewer().getActiveElementId(),t=this.visualizedRangeCache.get(e);return t?t.get(this.getCurvatureType())??null:null}}const Fc=_e.O.createLogger("CurvatureAnalysisScenegraphManager",k.bVy.GRAPHICS),xc=new Float32Array(2);class Bc{constructor(e,t,i){this.modelViewManager=e,this.parentNodeId=t,this.scalarVisualizationMaterials=i,this.nodes=[],this.VISUALIZATION_MANAGER_NODE_ID=Nc,this.meshOwnerId=JT(),this.bodyIdsWithPendingTessellationRequest=new Map,this.resetMeshes()}isVisualizing(){return!!this.getBodyComponent()?.isVisualizingOccurrences()}getViewer(){return this.modelViewManager.getViewer()}getBodyComponent(){return this.getDisplayedPartStudio()?.getBodyComponent()}getDisplayedPartStudio(){return this.modelViewManager.getDisplayedPartStudio()}setCurvatureType(e){this.curvatureType=e}getCurvatureType(){return this.curvatureType}setBodyHasPendingTessellationRequest(e,t){if(!t)return;const i=this.bodyIdsWithPendingTessellationRequest.get(t)??new Set;i.add(e),this.bodyIdsWithPendingTessellationRequest.set(t,i)}unsetBodyHasPendingTessellationRequest(e,t){const i=this.bodyIdsWithPendingTessellationRequest.get(t);i&&(i.delete(e),this.bodyIdsWithPendingTessellationRequest.set(t,i))}getBodyHasPendingTessellationRequest(e,t){const i=this.bodyIdsWithPendingTessellationRequest.get(t);return i&&i.has(e)}getDisplayedPartStudioHasPendingTessellationRequests(){const e=this.getDisplayedPartStudio()?.getElementId();if(!e)return!1;const t=this.bodyIdsWithPendingTessellationRequest.get(e);return t&&t.size>0}clearPendingTessellationRequests(){this.bodyIdsWithPendingTessellationRequest=new Map}prepareResources(){if(!this.rootNode){const e=this.modelViewManager.getSharedBodyNode();this.rootNode=e.getChildById(this.VISUALIZATION_MANAGER_NODE_ID),this.rootNode||(this.rootNode=new Gi.NB(this.VISUALIZATION_MANAGER_NODE_ID),e.addChild(this.rootNode))}if(this.resetScenegraphNodes(),!this.nodePropertiesSolids||0===this.nodePropertiesSolids.length||!this.nodePropertiesSurfaces||0===this.nodePropertiesSurfaces.length){this.nodePropertiesSolids=[],this.nodePropertiesSurfaces=[];for(let e=0;e<Lc.imageMaps.length;++e){const t=this.scalarVisualizationMaterials[e];t.ambientTextureFactor=0;const i=new Gi.hF({material:t,zOffset:X.default.getManager().getNumber("PART_FACES_Z_OFFSET"),primitiveType:Ai.MX.TRIANGLES,includedInBlend:!0,clippedBySectionPlanes:!0,isPickable:!1,isTwoSided:!1});this.nodePropertiesSolids.push(i);const s={zOffset:X.default.getManager().getNumber("SURFACE_Z_OFFSET"),isTwoSided:!0},n=i.cloneAndModify(s);this.nodePropertiesSurfaces.push(n)}}}resetScenegraphNodes(){if(this.rootNode){for(let e=0;e<this.nodes.length;++e)this.nodes[e].remove();this.nodes=[];for(let e=0;e<Dc.imageMaps.length;++e){const t=new Gi.NB(this.VISUALIZATION_MANAGER_NODE_ID+"."+e,{isPickable:!1,clippedBySectionPlanes:!0});t.setVisible(!1),this.nodes.push(t),this.rootNode.addChild(t)}}}hideMapping(e){const t=Dc.getMapIndex(e),i=this.nodes[t];i&&i.setVisible(!1)}showMapping(e){const t=Dc.getMapIndex(e),i=this.nodes[t];i&&i.setVisible(!0)}resetMeshes(){this.meshManager&&this.meshManager.destroy(),this.meshManager=new eD(this.getViewer(),{bufferAllocationPolicy:AE.MAXIMUM})}updateNodesWithCurvatureData(){const e=this.getBodyComponent();if(!e)return;const t=new Ih.B7(`CurvatureAnalysisManager.updateNodesWithCurvatureData - Usage: ${this.modelViewManager.usage}`);this.resetMeshes();const i=this.getDisplayedPartStudio().getElementId();for(const t of this.getBodiesWithCurvatureTessellations()){const s=e.bodyMetaData[t],n=e.getBodyOccurrenceData(t);if(!this.shouldVisualizeBody(s,n))continue;const r=s.isClosedCompositeConstituent?s.closedCompositeParentId:t;this.unsetBodyHasPendingTessellationRequest(r,i);const a=new qT(this.parentNodeId+" "+n.getOccurrenceId()),o=this.getPartStudioFaceEntityIdsForBody(s);for(const e of o){const t=this.getMeshIncrementWithScalars(e),i=this.meshManager.addMeshIncrement(t,this.meshOwnerId);a.onIncrementAdded(i)}const h=new mS.bg;h.setAttribute(RS.COLOR,s.getColor());const c=s.containsOnlySheetBodies()?this.nodePropertiesSurfaces:this.nodePropertiesSolids;for(let e=0;e<c.length&&e<this.nodes.length;++e)this.nodes[e].addOccurrenceGeometryToNode(c[e],n,h,a);e.setScalarVisualizationOccurrence(n.getOccurrenceId(),s.getId())}t.report()}getBodiesThatNeedCurvatureTessellations(){const e=this.getBodyComponent();if(!e)return;const t=new Set;for(const i of this.getBodiesToVisualize()){const s=e.retrieveBodyMetaData(i),n=e=>e===bc;if(!s||s.tessellationSettings.findIndex(n)>-1)continue;const r=s.isClosedCompositeConstituent?s.closedCompositeParentId:i,a=this.getDisplayedPartStudio().getElementId();this.getBodyHasPendingTessellationRequest(r,a)||t.add(r)}return[...t]}shouldVisualizeBody(e,t){return(e?.isSolidBody()||e?.isSheetBody()||e?.isClosedComposite&&!e?.containsOnlyWireBodies())&&t?.getVisibility()===Xs.EE.VISIBLE}getBodiesToVisualize(){const e=this.getBodyComponent();if(!e)return;const t=new Set;for(const i of e.getBodyIds()){const s=e.retrieveBodyMetaData(i),n=e.getBodyOccurrenceData(i);this.shouldVisualizeBody(s,n)&&t.add(i)}return t}getBodiesWithCurvatureTessellations(){const e=e=>e===bc;return this.getBodyComponent()?.getBodyIds((t=>t.tessellationSettings.findIndex(e)>-1))??[]}getPartStudioFaceEntityIdsForBody(e){const t=this.getDisplayedPartStudio();if(!t)return[];const i=e.isClosedComposite?e.constituentBodyIds:[e.getId()],s=[];for(const e of i){const i=t.getEntitiesForBody(e,(e=>e.isFace()));s.push(...i)}return s}getFaceEntityMetadata(e){const t=this.getDisplayedPartStudio()?.retrieveEntityMetaData(e);return t&&t.isFace()?t:null}getMeshIncrementWithScalars(e){const t=this.getFaceEntityMetadata(e),i=t.getGeometry();if(!i)return Fc.debug(`Tried to get mesh increment with curvature data for entityId="${e}" but entity was not a BTEntityFace`),null;const s=t.getMeshIncrement().clone();if(i.hasValidCurvatureData()&&!i.isPlanarFace()){const e=this.getIncrementCurvatures(i.maxPrincipleCurvatureMagnitudes,i.minPrincipleCurvatureMagnitudes);s.packScalarsIntoTextureCoordinates(e),this.updateRanges(e)}else i.isPlanarFace()&&s.replicateTextureCoordinate(xc);return s}updateRanges(e){const t=k.dGY.fromMinMax(1/0,-1/0),i=k.dGY.fromMinMax(1/0,-1/0);for(const s of e){s<t.min&&(t.min=s),s>t.max&&(t.max=s);const e=Math.min(s,_c);e<i.min&&(i.min=e),e>i.max&&(i.max=e)}const s=k.dGY.combine(this.getRangeInData(),t);this.setRangeInData(s);const n=k.dGY.combine(this.getClampedRangeInData(),i);this.setClampedRangeInData(n)}setRangeInData(e){this.rangeInData=e}setClampedRangeInData(e){this.clampedRangeInData=e}getRangeInData(){return this.rangeInData}getClampedRangeInData(){return this.clampedRangeInData}getIncrementCurvatures(e,t){if(!e||!t)return void Fc.warn("The passed arrays of principle curvatures were not defined");const i=e=>(0,Oc.clamp)(1/e,-1/0,_c+1);switch(this.getCurvatureType()){case k.Lck.MIN_RADIUS:{const s=(e,t)=>Math.max(Math.abs(e),Math.abs(t)),n=(e,t)=>i(s(e,t));return(0,Oc.zipWith)(e,t,n)}case k.Lck.MAX_RADIUS:{const s=(e,t)=>Math.min(Math.abs(e),Math.abs(t)),n=(e,t)=>i(s(e,t));return(0,Oc.zipWith)(e,t,n)}case k.Lck.MEAN:{const i=(e,t)=>(e+t)/2;return(0,Oc.zipWith)(e,t,i)}case k.Lck.GAUSSIAN:default:const s=(e,t)=>e*t;return(0,Oc.zipWith)(e,t,s)}}didRequestCurvatureDataForBodies(e){for(const t of e)this.setBodyHasPendingTessellationRequest(t,this.getDisplayedPartStudio()?.getElementId())}}const Vc=new Gi.hF({isShowThrough:!0,isDepthTested:!1,isStencilTested:!0,isPickable:!1,priority:Gi.DO.LOWER,primitiveType:Ai.MX.LINES}),Uc=new Gi.hF({isPickable:!1,primitiveType:Ai.MX.LINES}),Hc=X.default.getManager();class Gc extends yi.u1{constructor(e,t,i){if(super((0,j.as)(ND,e)),this.handleRoot=null,this.handleHead=null,t){const e=t.geometry,s=e.interpolationPoints.length;i?(this.handleRoot=[e.interpolationPoints[0],e.interpolationPoints[1]],this.handleHead=[e.startHandleX,e.startHandleY]):(this.handleRoot=[e.interpolationPoints[s-2],e.interpolationPoints[s-1]],this.handleHead=[e.endHandleX,e.endHandleY])}this.updateLines()}updateEndpoints(e,t){this.handleRoot=t,this.handleHead=e,this.updateLines()}updateLines(){if(!this.handleRoot||!this.handleHead)return;const e=this.viewer.getSketch();if(!e)return;const t=[e.planeToWorld(this.handleRoot),e.planeToWorld(this.handleHead)],i=(0,Yd.pf)(t);(0,Yd.VQ)(Hc.getNumber("SPLINE_HANDLE_LINE_WIDTH"),i),(0,Yd.Ab)(Hc.getColor("SPLINE_HANDLE_COLOR"),i),this.updateMeshIncrement("lines",yi.ZJ,i,Vc),this.updateMeshIncrement("dp.lines",yi.ZJ,i.clone(),Uc)}}const kc=X.default.getManager(),Wc=new Gi.hF({zOffset:kc.getNumber("ORIGIN_Z_OFFSET"),primitiveType:Ai.MX.POINTS,isShowThrough:!0,isDepthTested:!1});var zc;!function(e){e.POINT="point"}(zc||(zc={}));class Xc extends yi.u1{constructor(e,t){super(t),this.definition=e,this.lastScale=-1,this.worldSpacePosition=[0,0,0],this.id="AssemblyOriginElement",this.occurrenceTransform=ue.create(),this.updateHideState()}onAppearanceConstantsUpdated(){this.updateGraphics()}setOccurrenceTransform(e){this.occurrenceTransform=e,this.damageTransform()}updateDefinition(e){this.definition=e,this.updateHideState(),this.damageTransform()}damageTransform(){if(this.lastScale=-1,this.definition){const e=[0,0,0];ge.w$.multiplyVec3(this.occurrenceTransform,e,this.worldSpacePosition)}(0,Xs.vm)()}getUserVisibilitySetting(){return this.definition.hidden?Xs.EE.HIDDEN:Xs.EE.VISIBLE}updateHideState(){this.isHighlighted()||this.getUserVisibilitySetting()!==Xs.EE.HIDDEN?(this.hasMeshIncrements()||this.updateGraphics(!0),this.show()):this.hide()}getBounds(){if(this.isVisibleToUser()){const e=new wi.kB;return e.addPoint(this.worldSpacePosition),e}return null}onViewWillDraw(e){this.adjustTransform(e)}adjustTransform(e){if(!this.definition||this.isHidden)return;const t=e.getPixelSizeAtWorldPoint(this.worldSpacePosition);if(Math.abs(this.lastScale-t)<Ri.W.ZERO_LENGTH)return;this.lastScale=t;const i=ue.create();i[0]=t,i[5]=t,i[10]=t,this.setTransform(ge.w$.multiply(this.occurrenceTransform,i,ue.create())),this.hasMeshIncrements()||this.updateGraphics()}updateGraphics(e){if(!this.definition||this.isHidden&&!e)return void this.removeMeshIncrements();const t=(0,Yd.Pu)([0,0,0],"point",kc.getColor("ORIGIN_COLOR"),kc.getNumber("ORIGIN_SIZE"));(0,Yd.KZ)(kc.getPointFont("ORIGIN_FONT"),t),this.updateMeshIncrement(zc.POINT,yi.ZJ,t,Wc)}getOccurrence(){return null}getModelSelection(e){if(!this.definition)return null;const t=new k._oC,i=new Me.Y1(k.lQt.FEATURE,k.AuL.ORIGIN_ID,t,{sourcePick:e.sourcePick});return i.setFeatureType(mi.T.ASSEMBLY_ORIGIN),i}addHighlight(e){super.addHighlight(e),this.updateHideState(),this.addHighlightToIncrement(zc.POINT,e)}removeHighlight(e){return this.removeHighlightFromIncrement(zc.POINT,e),!!super.removeHighlight(e)&&(this.updateHideState(),!0)}}var Zc=i(75015),qc=i(27054);const Yc=_e.O.createLogger("BodyManager",k.bVy.GRAPHICS),Kc="pbm",jc="tbm",Qc="nbm";class $c{constructor(e,t,i,s,n,r,a,o,h){this.bodyOccurrence=e,this.requestSource=t,this.occurrence=i,this.tessellationSettingDesired=s,this.tessellationSettingRequested=n,this.finestTessellationSettingInMemory=r,this.viewportError=a,this.isOutsideFrustum=o,this.benefitToProcess=h}requiresDowngrade(){return this.tessellationSettingRequested!==k.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING&&this.finestTessellationSettingInMemory>this.tessellationSettingRequested}}var Jc;!function(e){e[e.DISABLED=0]="DISABLED",e[e.CONDITIONAL=1]="CONDITIONAL",e[e.ALWAYS=2]="ALWAYS"}(Jc||(Jc={}));let el=Jc.CONDITIONAL;function tl(e){el=e}const il=-1;var sl;!function(e){e[e.SELECTION=0]="SELECTION",e[e.HOVER=1]="HOVER",e[e.VIEWING=2]="VIEWING"}(sl||(sl={}));const nl=X.default.getManager().getNumber("UNLOADED_BODY_OPACITY_FACTOR");function rl(){return!!localStorage.getItem("osBodyRetrievalDebuggingEnabled")}function al(e){return(e/1024/1024).toFixed(0)+" MB"}const ol=[0];class hl{constructor(e,t){this.partStudio=e,this.bodyMetaData=t,this.radius=this.getBodyMetaDataForRetrieval().getBounds().diameter()/2}getBodyMetaDataForRetrieval(){return this.bodyMetaData.isClosedCompositeConstituent?this.bodyMetaData.consumingClosedCompositeData:this.bodyMetaData}getBenefitToUnload(){return this.getBodyMetaDataForRetrieval().getEstimatedMemoryUsage()/(this.radius*this.radius)}isBodyDataPresent(){return this.getBodyMetaDataForRetrieval().hasTessellationSettings()}isInstantiated(){return!1}getLastViewTime(){return 0}getLastViewportOccupancy(){return 0}getUnloadedChordalTolerance(){return this.getBodyMetaDataForRetrieval().getBounds().diameter()}getCenter(){return null}}const cl=M.create(),ll=y.create(),dl=ue.create();class ul{constructor(e,t,i){this.occurrenceData=e,this.bodyMetaData=t,this.pickId=i,this.center=[0,0,0],this.radius=0,this.benefitToCull=0,this.lod=null,this.displayDamaged=!0,this.incrementDetails=null,this.highlightApplied=null,this.numberOfBodiesInOccurrence=1,this.retrievalRequestState=il,this.update(e,t)}update(e,t){this.occurrenceData=e,this.bodyMetaData=t;const i=ll;t.getBounds().center(i),i[3]=1,ge.w$.multiplyVec4(e.getTransform(),i),this.center[0]=i[0],this.center[1]=i[1],this.center[2]=i[2],this.radius=t.getBounds().diameter()/2,this.benefitToCull=this.getBenefitToCull()||0,this.displayDamaged=!0}getBodyMetaData(){return this.bodyMetaData}getBodyMetaDataForRetrieval(){return this.bodyMetaData.isClosedCompositeConstituent?this.bodyMetaData.consumingClosedCompositeData:this.bodyMetaData}getOccurrenceData(){return this.occurrenceData}getOccurrenceId(){return this.occurrenceData.getOccurrenceId()}getCenter(){return this.center}getRadius(){return this.radius}getUnloadedChordalTolerance(){return 2*this.radius}getBenefitToCull(){return this.bodyMetaData.coarseTriangleCount/(this.radius*this.radius)}getBenefitToUnload(){return this.getBodyMetaDataForRetrieval().getEstimatedMemoryUsage()/(this.radius*this.radius)}getBenefitToLoad(){return this.isBodyDataPresent()?0:this.radius*this.radius/this.getBodyMetaDataForRetrieval().getEstimatedMemoryUsage(ol)}getBenefitToRefine(e,t){return t/this.getBodyMetaDataForRetrieval().getEstimatedMemoryUsage([e])}isInstantiated(){return!0}setCullingState(e){if(this.numberOfBodiesInOccurrence>1){const t=_m.getPotentialMeshGroupIdsForBody(this.bodyMetaData.meshGroupId);for(let i=0;i<t.length;++i)this.occurrenceData.setCullingState(e,t[i])}else this.occurrenceData.setCullingState(e)}isEntityTessellationLoaded(){return this.getBodyMetaDataForRetrieval().getIsTessellationLoaded()}canBeRefinedFurther(e){const t=this.getBodyMetaDataForRetrieval().getFinestTessellationSettingInMemory();return null===t||t<this.getBodyMetaDataForRetrieval().getBestAvailableTessellationSettingIndex(e)}setLod(e){this.isEntityTessellationLoaded()||(e=wS.LOWEST),this.occurrenceData.setLod(e)}outsideFrustum(e){return e.viewFrustum.getSphereFrustumIntersection(this.center,this.radius)===lr.I.OUTSIDE}intersectsFrustum(e){return!!e&&e.getSphereFrustumIntersection(this.center,this.radius)!==lr.I.OUTSIDE}isVisible(){return this.occurrenceData.getVisibility()===Xs.EE.VISIBLE}mustShowLowestLod(e){return!this.isEntityTessellationLoaded()&&(this.isVisible()||this.occurrenceData.hasHighlight()||!!e&&e.getIsPickingHiddenOccurrences())}lodIsUpToDate(e){return this.mustShowLowestLod()||e?!this.displayDamaged&&this.lod===wS.LOWEST:this.lod!==wS.LOWEST}isBodyDataPresent(){return this.getBodyMetaDataForRetrieval().hasTessellationSettings()}resetRetrievalRequestState(){this.retrievalRequestState=il}setBodyRetrievalStarted(e){this.retrievalRequestState=e}isRetrievalRequestDataPresent(){if(!this.getBodyRetrievalStarted())return!1;const e=this.getBodyMetaDataForRetrieval();return e.hasTessellationSettings()&&e.getFinestTessellationSettingInMemory()===this.retrievalRequestState}getBodyRetrievalStarted(){return this.retrievalRequestState>=0}canCullBody(e){return this.occurrenceData.getVisibility()===Xs.EE.VISIBLE&&!this.occurrenceData.getIsolated()&&!this.intersectsFrustum(e)}getSphereFrustumIntersection(e){return this.occurrenceData.getVisibility()===Xs.EE.VISIBLE&&!this.occurrenceData.getIsolated()&&e?.getSphereFrustumIntersection(this.center,this.radius)}getDisplayId(){return this.occurrenceData.getOccurrenceId()+"."+this.bodyMetaData.id}addBounds(e){e.addBox(this.bodyMetaData.getBounds(),this.occurrenceData.getTransform())}updateViewHistory(e,t){const i=this.getBodyMetaDataForRetrieval();i.getLastViewTime()!==e?(i.setLastViewTime(e),i.setLastViewportOccupancy(t)):i.setLastViewportOccupancy(t+i.getLastViewportOccupancy())}getLastViewTime(){return this.getBodyMetaDataForRetrieval().getLastViewTime()}getLastViewportOccupancy(){return this.getBodyMetaDataForRetrieval().getLastViewportOccupancy()}getDisplayIncrement(){const e=this.bodyMetaData.getBounds(),t=e.diagonalVector(cl),i=ge.w$.scale(ue.identity(dl),t),s=e.center(cl);i[12]+=s[0],i[13]+=s[1],i[14]+=s[2],ge.w$.multiply(this.occurrenceData.getTransform(),i,i);const n=pl().createTransformed(i);n.id=this.getDisplayId(),n.pickId=this.pickId,n.lod=wS.LOWEST;let r=this.bodyMetaData.getColor();return!this.occurrenceData.getIsolated()&&(0,Sh.uQ)().getIsolatedOccurrenceManager().isInIsolateOrMakeTransparentMode()?(r=[r[0],r[1],r[2],1],n.groupId=Qc):(this.isBodyDataPresent()||(r=[r[0],r[1],r[2],r[3]*nl]),n.groupId=r[3]<1?jc:Kc),(0,Yd.Ab)(r,n),n}}let gl=null;function pl(){return gl||(gl=(0,Yd.dO)([-.5,-.5,-.5],[.5,.5,.5])),gl}class ml extends m.T{constructor(e,t){super(),this.viewer=e,this.bodyUnloadTask=t,this.DISPLAY_OCCURRENCE_NAME="BodyManager",this.DISPLAY_NON_ISOLATED_OCCURRENCE_NAME="BodyManagerNonIsolated",this.DISPLAY_BOXES_WHEN_CULLING=X.default.getManager().getNumber("DISPLAY_BOXES_WHEN_CULLING"),this.previewOccurrences=new Map,this.sortedOccurrences=new qc.RBTree(fl),this.unloadedBodyBounds=null,this.MAXIMUM_BODY_CULL_DIAMETER_PROPORTION=X.default.getManager().getNumber("MAXIMUM_BODY_CULL_DIAMETER_PROPORTION"),this.BODY_REFINEMENT_BATCH_SIZE=1024*X.default.getManager().getNumber("BODY_REFINEMENT_BATCH_SIZE_MB")*1024,this.PENDING_BODY_REFINEMENT_SIZE_LIMIT=1024*X.default.getManager().getNumber("PENDING_BODY_REFINEMENT_SIZE_LIMIT_MB")*1024,this.MODEL_STATISTICS_ENTITY_COUNT_FREQUENCY=X.default.getManager().getNumber("MODEL_STATISTICS_ENTITY_COUNT_FREQUENCY"),this.occurrenceRetrievalTimeout=null,this.occurrencesRequestedSet=new Set,this.logLimiter=10,this.encounteredUnloadedOccurrenceInLastFrame=!1,this.bodyRetrievalCheckTimeout=null,this.shouldUpdateBodyOccurrenceLodForIsolate=!1,this.paused=!1,this.userEnabledAggressiveRefinement=!1,this.idManager=new DE.E,this.graphicsRefinementModeSubject=new Zc.t(1),this.isExtentCullingEnabled=!1,this.occurrences=new Map,this.node=new Gi.NB("bodyManager"),this.displayOccurrenceId=this.viewer.getOccurrenceIdManager().getOrCreateIdForName(this.DISPLAY_OCCURRENCE_NAME),this.displayOccurrenceData=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(this.displayOccurrenceId),this.displayOccurrenceData.setLod(wS.LOWEST),this.displayOccurrenceData.setIsolated(!0),this.displayOccurrenceData.setCanIsolateChange(!1),this.displayOccurrenceIdNonIsolated=this.viewer.getOccurrenceIdManager().getOrCreateIdForName(this.DISPLAY_NON_ISOLATED_OCCURRENCE_NAME),this.displayOccurrenceDataNonIsolated=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(this.displayOccurrenceIdNonIsolated),this.displayOccurrenceDataNonIsolated.setLod(wS.LOWEST),this.displayOccurrenceDataNonIsolated.setIsolated(!1),this.displayOccurrenceDataNonIsolated.setCanIsolateChange(!1),this.meshManager=new eD(this.viewer,{bufferAllocationPolicy:AE.MAXIMUM}),this.meshOwnerId=JT(),this.bodyOccurrenceToRetrievalRequest=new Map,this.occurrenceRetrievalRequests=[],this.pendingRetrievalInformation=new Map;this.viewer.getModelViewManagers().getManager().getSharedBodyNode().addChild(this.node);const i=new mS.bg,s=this.meshManager.getOrCreateGroupRangesForGroupTypeAndLod(Kc,this.meshOwnerId,Ai.MX.TRIANGLE_STRIP,wS.LOWEST);this.node.addOccurrenceGeometryToNode(fm,this.displayOccurrenceData,i,s);const n=this.meshManager.getOrCreateGroupRangesForGroupTypeAndLod(jc,this.meshOwnerId,Ai.MX.TRIANGLE_STRIP,wS.LOWEST);this.node.addOccurrenceGeometryToNode(Im,this.displayOccurrenceData,i,n);const r=this.meshManager.getOrCreateGroupRangesForGroupTypeAndLod(Qc,this.meshOwnerId,Ai.MX.TRIANGLE_STRIP,wS.LOWEST);this.node.addOccurrenceGeometryToNode(fm,this.displayOccurrenceDataNonIsolated,i,r),es.Jq.CapabilitiesService&&es.Jq.CapabilitiesService.isMoreAggressiveCullingEnabled&&es.Jq.CapabilitiesService.isMoreAggressiveCullingEnabled().then((e=>{this.MAXIMUM_BODY_CULL_DIAMETER_PROPORTION=!0===e?X.default.getManager().getNumber("MORE_AGGRESSIVE_MAXIMUM_BODY_CULL_DIAMETER_PROPORTION"):X.default.getManager().getNumber("MAXIMUM_BODY_CULL_DIAMETER_PROPORTION")})),es.Jq.CapabilitiesService&&es.Jq.CapabilitiesService.isMoreAggressiveRefinementEnabled&&es.Jq.CapabilitiesService.isMoreAggressiveRefinementEnabled().then((e=>{this.BODY_REFINEMENT_BATCH_SIZE=1024*(!0===e?X.default.getManager().getNumber("BODY_REFINEMENT_BATCH_SIZE_MB"):X.default.getManager().getNumber("MORE_AGGRESIVE_BODY_REFINEMENT_BATCH_SIZE_MB"))*1024,this.PENDING_BODY_REFINEMENT_SIZE_LIMIT=1024*(!0===e?X.default.getManager().getNumber("PENDING_BODY_REFINEMENT_SIZE_LIMIT_MB"):X.default.getManager().getNumber("MORE_AGGRESIVE_PENDING_BODY_REFINEMENT_SIZE_LIMIT_MB"))*1024})),this.refinementNodeFilter=e=>{const t=this.viewer.getModelViewManagers().getManager();if(t.isNodeForModel(e)){const i=e.getParent();return!e.isMeshNode()||e.isFaces()&&(t.isNodeForBody(i)||i===this.node)}return!1},es.Jq.CapabilitiesService.isExtentCullingEnabled().then((e=>{this.isExtentCullingEnabled=e})),this.subscribeToSelectionList()}getMeshManager(){return this.meshManager}destroy(){this.node.remove(),this.viewer.getOccurrenceDataManager().destroyOccurrenceData(this.displayOccurrenceId),this.viewer.getOccurrenceIdManager().removeName(this.DISPLAY_OCCURRENCE_NAME),this.viewer.getOccurrenceDataManager().destroyOccurrenceData(this.displayOccurrenceIdNonIsolated),this.viewer.getOccurrenceIdManager().removeName(this.DISPLAY_NON_ISOLATED_OCCURRENCE_NAME),this.meshManager.destroy(),this.resetOccurrenceRetrieval(),this.clearBodyRetrievalCheckTimeout(),this.stopListening()}resetSelectionListHandlers(){this.stopListening(),this.subscribeToSelectionList()}subscribeToSelectionList(){const e=(0,Me.vi)();this.listenTo(e,"add",this.onSelectionChanged),this.listenTo(e,"reset",this.onSelectionChanged),this.listenTo(e,"remove",this.onSelectionChanged)}setVisible(e){this.node.setVisible(e)}resetOccurrenceRetrieval(){rl()&&Yc.info("Reset occurence retriaval"),this.clearBodyRetrievalCheckTimeout(),this.clearRetrievalTimeout(),this.bodyOccurrenceToRetrievalRequest.clear(),this.occurrenceRetrievalRequests=[],this.pendingRetrievalInformation=new Map}clearPreviewOccurrences(){this.previewOccurrences.clear()}getGraphicsRefinementModeObservable(){return this.graphicsRefinementModeSubject.asObservable()}updateGraphicsRefinementMode(){this.userEnabledAggressiveRefinement?this.graphicsRefinementModeSubject.next(os.Rng.AGGRESSIVE_USER_CAUSED):this.graphicsRefinementModeSubject.next(os.Rng.NORMAL)}get aggressiveRefinementEnabled(){return this.userEnabledAggressiveRefinement}getUserEnabledAggressiveRefinement(){return this.userEnabledAggressiveRefinement}setUserEnabledAggressiveRefinement(e){this.userEnabledAggressiveRefinement!==e&&(this.userEnabledAggressiveRefinement=e,this.onAggressiveRefinementChanged())}onAggressiveRefinementChanged(){this.aggressiveRefinementEnabled?this.performUnloadedBodyAndRefinementCheck():this.viewer.getEventDispatcher().trigger(nM.Jp),this.updateGraphicsRefinementMode()}isBodyManagerOccurrence(e){return!!e&&e.path[0]===this.DISPLAY_OCCURRENCE_NAME}pickedOccurrenceId(e){this.viewer.isHidden()||this.initiateAutomaticRetrieval(!1)}onSelectionChanged(){this.viewer.isHidden()||this.initiateAutomaticRetrieval(!1)}getBtOccurrence(e){const t=this.viewer.getOccurrenceIdManager().getNameForId(e.getOccurrenceId());return!t||t.startsWith(_m.PART_STUDIO_BODY_OCCURRENCE_PREFIX)?null:k._oC.getOccurrenceFromPathString(t)}getFinestTessellationSettingInMemory(e){let t=e.getBodyMetaDataForRetrieval().getFinestTessellationSettingInMemory();return null===t&&(t=-1),t}checkBodiesUnderMemoryLimit(e,t){const i=this.viewer.getModelViewManagers().getManager().getBodyRefinementMemoryLimit();let s=0;for(const n of this.occurrences.values()){const r=n.getBodyMetaData();if(!t||t.has(r.id)?s+=r.getEstimatedMemoryUsage([e]):s+=r.getEstimatedMemoryUsage(),s>=i)return!1}return!0}clearRetrievalTimeout(){(0,ea.Z)(this.occurrenceRetrievalTimeout)&&(window.clearTimeout(this.occurrenceRetrievalTimeout),this.occurrenceRetrievalTimeout=null)}startRetrievalTimeout(){this.clearRetrievalTimeout();const e=this.aggressiveRefinementEnabled?X.default.getManager().getNumber("AGGRESSIVE_OCCURRENCE_RETRIEVAL_INTERVAL_MS"):X.default.getManager().getNumber("OCCURRENCE_RETRIEVAL_INTERVAL_MS");this.occurrenceRetrievalTimeout=window.setTimeout((()=>this.onRetrievalTimeout()),e)}onRetrievalTimeout(){if(this.clearRetrievalTimeout(),this.paused)return void Yc.info("Skipped body retrieval timeout due to pause");const e=this.viewer.getModelViewManagers().getManager();if(!this.aggressiveRefinementEnabled&&this.viewer.getFrameTimer().userIsInteracting())return void this.startRetrievalTimeout();const t=[];let i=!1,s=0;const n=rl(),r=[],a=this.getEstimatedMemoryUsageOfPendingRetrievals();if(n){const t=e.getEstimatedMemoryUsageOfBodies();Yc.info("Estimated memory use of all bodies: "+al(t)+" pending:"+al(a))}if(ml.isFirstMemoryReport&&Math.random()<=this.MODEL_STATISTICS_ENTITY_COUNT_FREQUENCY&&e.isPerformanceMememoryAvailable()){const t=performance.now(),i=!0,s=!1,n=!1,r=e.getModelStatistics(i,s,n),a=performance.now();r.version=2,r.browserAge=t,r.time=a-t,this.viewer.getEventDispatcher().trigger(nM.kt,r)}ml.isFirstMemoryReport=!1;for(const o of this.occurrenceRetrievalRequests){const h=o.bodyOccurrence.getBodyMetaDataForRetrieval();if(this.pendingRetrievalInformation.has(h)){i=!0;continue}let c=h.getFinestTessellationSettingInMemory();if(null===c&&(c=k.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING),c===o.tessellationSettingRequested||o.tessellationSettingRequested===k.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING)continue;i=!0;let l=0,d=k.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING;const u=this.viewer.getRenderingMode()===k.P1.SHADED_CURVATURE_VISUALIZATION;if(this.aggressiveRefinementEnabled||u||c>o.tessellationSettingRequested?(d=o.tessellationSettingRequested,l=h.getEstimatedMemoryUsage([d])):(i=!0,d=c+1,l=h.getEstimatedMemoryUsage([d])),(0===s||s+l<this.BODY_REFINEMENT_BATCH_SIZE)&&(0===this.pendingRetrievalInformation.size||a+s+l<this.PENDING_BODY_REFINEMENT_SIZE_LIMIT)){s+=l,this.pendingRetrievalInformation.set(h,{estimatedAdditionalMemoryUsage:l,tessellationSetting:d});const i=new k.A$B;if(i.bodyDeterministicId=h.getId(),o.occurrence){i.occurrence=o.occurrence;const t=e.getOccurrenceDisplayData(o.occurrence);t&&(i.elementId=t.elementId,i.microversionIdAndConfiguration=t.fullElementId.microversionIdAndConfiguration)}else i.occurrence=null,i.elementId=e.getDisplayedElementId(),i.microversionIdAndConfiguration=e.getDisplayedElementMicroversionIdAndConfiguration();i.tessellationSetting=d,o.bodyOccurrence.setBodyRetrievalStarted(i.tessellationSetting),rl()&&(o.occurrence?(0,Me.iH)().add(new Me.Y1(k.lQt.OCCURRENCE,o.occurrence,o.occurrence)):(0,Me.iH)().add(new Me.Y1(k.lQt.BODY,o.bodyOccurrence.getBodyMetaData().getId()))),t.push(i),n&&r.push(h.getId()+"-"+i.tessellationSetting)}}if(n&&r.length>0){r.sort(),Yc.info("Retrieving bodies from cache or service: "+r);const e=this.viewer.getModelViewManagers().getManager().getEstimatedMemoryUsageOfBodies(),t=this.getEstimatedMemoryUsageOfPendingRetrievals();Yc.info("Estimated use of body memory at time of retrieval "+al(e+t)+", pending use: "+al(t))}t.length>0&&(this.logLimiter>0&&(t.forEach((e=>{this.occurrencesRequestedSet.has(e.toString())&&(this.logLimiter-=1,Yc.warn(`Duplicate refinement request issued: ${e.occurrence}, tessellationSetting: ${e.tessellationSetting},  elementId: ${e.elementId}, bodyDeterministicId: ${e.bodyDeterministicId}, microversionIdAndConfiguration: ${e.microversionIdAndConfiguration}, isAvailableAtClient ${e.isAvailableAtClient}`))})),this.occurrencesRequestedSet=new Set,t.forEach((e=>{this.occurrencesRequestedSet.add(e.toString())}))),this.aggressiveRefinementEnabled?this.viewer.getEventDispatcher().trigger(nM.am,t):this.viewer.getEventDispatcher().trigger(nM.Qe,t)),i&&this.startRetrievalTimeout()}resetRetrievalStateForOccurrence(e){e.resetRetrievalRequestState();const t=e.getBodyMetaDataForRetrieval();if(this.pendingRetrievalInformation.delete(t),rl()){const i=this.getBtOccurrence(e);i?(0,Me.iH)().remove(new Me.Y1(k.lQt.OCCURRENCE,i,i)):(0,Me.iH)().remove(new Me.Y1(k.lQt.BODY,t.getId()))}}updateForFrame(e,t,i=!1,s){return this.performAggressiveCulling(e,!!t,i,s)}sectionViewFilter(e){const t=(0,lD.Ky)().getSectionPlanes();if(!this.viewer.areSectionPlanesEnabled()||0===t.length)return!1;for(let i=0;i<t.length;++i){const s=t[i],n=gr(s.center,s.normal,e.center,e.radius);if(lr.I.INTERSECTING===n||lr.I.INSIDE===n)return!0}return!1}performAggressiveCulling(e,t,i=!1,s){if(this.viewer.getXrController().getIsXrRunning())return;const n=e.getActiveCamera(),r=e.getDetailSettings();let a=Us()?Math.floor(r.lowLevelBodyProportion*this.occurrences.size):0;const o=!t||this.DISPLAY_BOXES_WHEN_CULLING;let h=this.shouldUpdateBodyOccurrenceLodForIsolate||0!==a&&o||e.getIsPickingHiddenOccurrences();const c=e.getViewer().getFrustumToPreventCulling(),l=e.getViewer().getPickFrustum();t&&(this.encounteredUnloadedOccurrenceInLastFrame=!1);const d=this.MAXIMUM_BODY_CULL_DIAMETER_PROPORTION*n.getViewportDiagonal(),u=this.isExtentCullingEnabled?r.extentCullingThresholdPx:0;let g=!1,p=!1;do{p=!1;let r,o=0;const m=this.sortedOccurrences.iterator(),f=i||s;for(;null!==(r=m.next());)if(t&&!f){if(r.outsideFrustum(n))r.setCullingState(Xs.uc.CULLED),--a;else{const i=n.getUnitSizeAtWorldPointFast(r.center)*r.radius*2,s=i<u;r.lodIsUpToDate(s)||h||(h=!0,p=!0),t&&!r.isBodyDataPresent()&&(this.encounteredUnloadedOccurrenceInLastFrame=!0),r.mustShowLowestLod(e)||(o<a||s)&&r.canCullBody(c)&&i<d?(g=!0,r.setCullingState(Xs.uc.CULLED),h&&this.setBodyOccurrenceLod(r,wS.LOWEST,e)):(r.setCullingState(Xs.uc.VISIBLE),h&&this.setBodyOccurrenceLod(r,wS.DEFAULT,e))}if(this.shouldUpdateBodyOccurrenceLodForIsolate=!1,r.isRetrievalRequestDataPresent()&&this.resetRetrievalStateForOccurrence(r),p)break;o++}else if(1===r.numberOfBodiesInOccurrence&&!r.occurrenceData.isHiddenFromPick){if(!this.viewer.isolateEffectPickFilter(r.occurrenceData))continue;if(this.sectionViewFilter(r))continue;const e=r.getSphereFrustumIntersection(l);s&&lr.I.INSIDE===e?(s.push(r),r.occurrenceData.isHiddenFromPick=!0):i&&lr.I.OUTSIDE===e&&(r.occurrenceData.isHiddenFromPick=!0)}}while(p);g?(this.displayOccurrenceData.setCullingState(Xs.uc.VISIBLE),this.displayOccurrenceDataNonIsolated.setCullingState(Xs.uc.VISIBLE)):(this.displayOccurrenceData.setCullingState(Xs.uc.CULLED),this.displayOccurrenceDataNonIsolated.setCullingState(Xs.uc.CULLED))}setBodyOccurrenceLod(e,t,i){if(e.lod===t&&!e.displayDamaged)return void this.updateBodyHighlight(e);const s=e.occurrenceData.getIsolated()||!this.viewer.getIsolatedOccurrenceManager()?.isInIsolateOrMakeTransparentMode();if(t===wS.DEFAULT)e.incrementDetails&&(this.displayOccurrenceData.hideIncrement(e.incrementDetails,ys.L.BASE),this.displayOccurrenceDataNonIsolated.hideIncrement(e.incrementDetails,ys.L.BASE));else{const t=!e.isVisible()&&!i.getIsPickingHiddenOccurrences();if(e.displayDamaged||!e.incrementDetails){e.incrementDetails&&(this.meshManager.removeMeshIncrement(e.getDisplayId(),this.meshOwnerId),e.incrementDetails=null,e.highlightApplied=null);const t=e.getDisplayIncrement();e.incrementDetails=this.meshManager.addMeshIncrement(t,this.meshOwnerId),e.displayDamaged=!1}s&&!t?this.displayOccurrenceData.showIncrement(e.incrementDetails,ys.L.BASE):this.displayOccurrenceData.hideIncrement(e.incrementDetails,ys.L.BASE),s||t?this.displayOccurrenceDataNonIsolated.hideIncrement(e.incrementDetails,ys.L.BASE):this.displayOccurrenceDataNonIsolated.showIncrement(e.incrementDetails,ys.L.BASE)}e.lod=t,this.updateBodyHighlight(e)}updateBodyHighlight(e){if(e.incrementDetails)if(e.lod===wS.DEFAULT)this.clearBodyHighlight(e);else{const t=e.occurrenceData.getBaseOccurrenceHighlight();t!==e.highlightApplied&&(this.clearBodyHighlight(e),t&&(this.displayOccurrenceData.updateEntityHighlight(Cn.aU.ADD,t,e.incrementDetails,ys.L.BASE),this.displayOccurrenceDataNonIsolated.updateEntityHighlight(Cn.aU.ADD,t,e.incrementDetails,ys.L.BASE),e.highlightApplied=t))}}clearBodyHighlight(e){e.highlightApplied&&e.incrementDetails&&(this.displayOccurrenceData.updateEntityHighlight(Cn.aU.REMOVE,e.highlightApplied,e.incrementDetails,ys.L.BASE),this.displayOccurrenceDataNonIsolated.updateEntityHighlight(Cn.aU.REMOVE,e.highlightApplied,e.incrementDetails,ys.L.BASE),e.highlightApplied=null)}getBodyOccurrenceId(e,t){return e+"."+t}addOrUpdateOccurrence(e,t,i,s){const n=this.getBodyOccurrenceId(e,i.id);let r=this.occurrences.get(n);r?(this.sortedOccurrences.remove(r)||Yc.warn("The item was not deleted. The properties used in the sorting method were mutated outside the collection, which corrupted the collection and may cause the client or browser to crash."),r.update(t,i)):(r=new ul(t,i,this.idManager.getOrCreateIdForName(n)),this.occurrences.set(n,r)),this.sortedOccurrences.insert(r),r.numberOfBodiesInOccurrence=s,this.damageUnloadedBodyBounds()}damageUnloadedBodyBounds(){this.unloadedBodyBounds=null}getUnloadedBodyBounds(){return this.unloadedBodyBounds||(this.unloadedBodyBounds=new wi.kB,this.occurrences.forEach((e=>{!e.isVisible()||e.isBodyDataPresent()&&e.isEntityTessellationLoaded()||e.addBounds(this.unloadedBodyBounds)}))),this.unloadedBodyBounds}getBodyOccurrence(e,t){return this.occurrences.get(this.getBodyOccurrenceId(e,t))}removeOccurrence(e,t){const i=this.getBodyOccurrenceId(e,t),s=this.occurrences.get(i);s&&(s.incrementDetails&&this.meshManager.removeMeshIncrement(s.getDisplayId(),this.meshOwnerId),this.occurrences.delete(i),this.sortedOccurrences.remove(s),this.damageUnloadedBodyBounds(),this.idManager.removeName(i))}getOccurrenceBounds(e,t){const i=new wi.kB,s=this.occurrences.get(this.getBodyOccurrenceId(e,t));return s&&s.addBounds(i),i}onUserIsAdjustingCamera(){(this.viewer.getModelViewManagers().getManager().displayingAssembly()||this.viewer.getModelViewManagers().getManager().displayingPartStudio())&&this.initiateAutomaticRetrieval(!0)}getEstimatedMemoryUsageOfPendingRetrievals(){let e=0;return this.pendingRetrievalInformation.forEach((function(t){e+=t.estimatedAdditionalMemoryUsage})),e}hasRefinementCeased(){return 0===this.pendingRetrievalInformation.size&&this.hasRetrievalCompleted()}getDisplayDataRefinementState(){const e=[];return this.occurrences.forEach((t=>{const i=t.getBodyMetaDataForRetrieval(),s=i.getFinestTessellationSettingInMemory(),n=t.isVisible(),r=i.getBestAvailableTessellationSettingIndex(this.aggressiveRefinementEnabled);e.push(`${i.name}, ${i.getId()}, on client = ${s}, maximum = ${r}, isVisible = ${n}`)})),e.join("\n")}hasRetrievalCompleted(){let e=!0;for(const t of this.occurrenceRetrievalRequests){const i=t.bodyOccurrence.getBodyMetaDataForRetrieval().getFinestTessellationSettingInMemory();if(null===i){e=!1;break}if(t.tessellationSettingRequested!==k.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING&&t.tessellationSettingRequested!==i){e=!1;break}}return e}getPendingRetrievalSummary(){let e="Body manager retrieval summary:\n";return this.pendingRetrievalInformation.size>0&&(e+="pendingRetrievalInformation size: "+this.pendingRetrievalInformation.size+"\n",this.pendingRetrievalInformation.forEach(((t,i)=>{e+="  Body: "+i.getId()+", retrievalInfo: "+JSON.stringify(t)+"\n"}))),this.bodyOccurrenceToRetrievalRequest.size>0&&(e+="occurrenceRetrievalRequests size: "+this.bodyOccurrenceToRetrievalRequest.size+"\n",this.bodyOccurrenceToRetrievalRequest.forEach(((t,i)=>{e+="retrievalRequest: "+JSON.stringify(t,null,"  ")+"\n"}))),e}clearBodyRetrievalCheckTimeout(){(0,ea.Z)(this.bodyRetrievalCheckTimeout)&&(window.clearTimeout(this.bodyRetrievalCheckTimeout),this.bodyRetrievalCheckTimeout=null)}initiateAutomaticRetrieval(e){this.clearBodyRetrievalCheckTimeout(),this.clearRetrievalTimeout(),e&&(this.occurrenceRetrievalRequests=[],this.bodyOccurrenceToRetrievalRequest=new Map);const t=this.aggressiveRefinementEnabled?X.default.getManager().getNumber("AGGRESSIVE_AUTOMATIC_BODY_RETRIEVAL_TIMEOUT_MS"):X.default.getManager().getNumber("AUTOMATIC_BODY_RETRIEVAL_TIMEOUT_MS");this.bodyRetrievalCheckTimeout=window.setTimeout((()=>this.performUnloadedBodyAndRefinementCheck()),t)}allowRefinementCheck(){if(el===Jc.ALWAYS||this.aggressiveRefinementEnabled)return!0;const e=this.viewer.getInteractiveFrameDetails(),t=rl();let i=!1;return e&&e.hasTimings()&&(i=e.getAverageFramerate()<X.default.getManager().getNumber("BODY_REFINEMENT_FRAMERATE_THRESHOLD"),t&&i&&Yc.info("Skipped body refinement check because framerate is slow right now: "+e.getAverageFramerate()+" fps")),!i}getSelectionsForRetrieval(){const e=[];return(0,Me.vi)().forEach((t=>{e.push({selection:t,requestSource:sl.SELECTION})})),(0,Me.Wf)().forEach((t=>{e.push({selection:t,requestSource:sl.HOVER})})),e}getSelectionOccurrencesForRetieval(){const e=[],t=this.viewer.getModelViewManagers().getManager(),i=this.viewer.getOccurrenceIdManager(),s=this.viewer.getCamera(),n=this.aggressiveRefinementEnabled?X.default.getManager().getNumber("SELECTED_AGGRESSIVE_ERROR_REFINEMENT_THRESHOLD"):X.default.getManager().getNumber("FINER_BODY_SCREENSPACE_ERROR_REFINEMENT_THRESHOLD");for(const{selection:r,requestSource:a}of this.getSelectionsForRetrieval()){const o=r.getOccurrence();if(!o)continue;const h=i.getIdForName(o.getPathAsString());if(h===TE.Qy)continue;const c=t.getOccurrenceDisplayData(o);if(c&&c.displayedPartIds)for(const t of c.displayedPartIds){const i=this.getBodyOccurrenceId(h,t),r=this.occurrences.get(i);if(!r)continue;const o=s?.getUnitSizeAtWorldPoint(r.getCenter()),c=this.getTessellationIndexToGoUnderThreshold(r,n,o,this.aggressiveRefinementEnabled),l=this.getFinestTessellationSettingInMemory(r),d=this.getBtOccurrence(r);e.push(new $c(r,a,d,c,k.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING,l,Number.MAX_VALUE,!0,0))}}return e}getVisibleOccurrencesForRetrieval(){const e=[],t=this.viewer.getCamera(),i=this.viewer.getModelViewManagers().getManager();let s;s=this.aggressiveRefinementEnabled?i.displayingAssembly()?X.default.getManager().getNumber("VIEWING_ASSEMBLY_AGGRESSIVE_ERROR_REFINEMENT_THRESHOLD"):X.default.getManager().getNumber("VIEWING_PART_STUDIO_AGGRESSIVE_ERROR_REFINEMENT_THRESHOLD"):X.default.getManager().getNumber("BODY_SCREENSPACE_ERROR_REFINEMENT_THRESHOLD");const n=(0,Xs.Wj)();return this.collectBodyOccurrencesInViewport().forEach(((i,r)=>{r.updateViewHistory(n,i.viewportOccupancyRatio);const a=r.getBodyMetaData(),o=r.getUnloadedChordalTolerance(),h=t?.getUnitSizeAtWorldPoint(r.getCenter()),c=h*o;if(c>=s){let t=null;if(t=this.shouldRetrieveHighestQualityTessellationForOccurrence(r)?a.getBestAvailableTessellationSettingIndex(this.aggressiveRefinementEnabled):this.getTessellationIndexToGoUnderThreshold(r,s,h,this.aggressiveRefinementEnabled),null===t)return;const n=this.getFinestTessellationSettingInMemory(r),o=this.getBtOccurrence(r);e.push(new $c(r,sl.VIEWING,o,t,k.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING,n,i.viewportOccupancyRatio*c,!0,0))}})),e}findMaximumRefinementForOccurrences(){for(const e of[...this.getSelectionOccurrencesForRetieval(),...this.getVisibleOccurrencesForRetrieval()]){const t=this.viewer.getCamera();e.isOutsideFrustum=e.bodyOccurrence.outsideFrustum(t),e.benefitToProcess=e.bodyOccurrence.getBenefitToRefine(e.tessellationSettingDesired,e.viewportError);const i=this.bodyOccurrenceToRetrievalRequest.get(e.bodyOccurrence);i?(i.viewportError=Math.max(e.viewportError,i.viewportError),i.requestSource=Math.min(e.requestSource,i.requestSource),i.isOutsideFrustum=e.isOutsideFrustum&&i.isOutsideFrustum,i.benefitToProcess=Math.max(e.benefitToProcess,i.benefitToProcess),i.tessellationSettingDesired=Math.max(e.tessellationSettingDesired,i.tessellationSettingDesired),i.finestTessellationSettingInMemory=e.finestTessellationSettingInMemory):(this.occurrenceRetrievalRequests.push(e),this.bodyOccurrenceToRetrievalRequest.set(e.bodyOccurrence,e))}this.occurrenceRetrievalRequests.sort(((e,t)=>{if(e.isOutsideFrustum!==t.isOutsideFrustum)return e.isOutsideFrustum?1:-1;if(e.requestSource<t.requestSource)return-1;if(e.requestSource>t.requestSource)return 1;const i=!!this.getBtOccurrence(e.bodyOccurrence);return i!==!!this.getBtOccurrence(t.bodyOccurrence)?i?-1:1:e.benefitToProcess>t.benefitToProcess?-1:e.benefitToProcess<t.benefitToProcess?1:0})),this.upgradeTessellations(this.occurrenceRetrievalRequests,this.bodyOccurrenceToRetrievalRequest),this.occurrenceRetrievalRequests.sort(ml.sortForRetrievalFunction)}upgradeTessellations(e,t){let i=0;const s=this.viewer.getModelViewManagers().getManager().getBodyRefinementMemoryLimit();for(const t of e)t.tessellationSettingRequested=k.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING;if(i=this.upgradeTessellationSettingsConditionally(e,(e=>e.tessellationSettingRequested<e.tessellationSettingDesired),i,s),i=this.upgradeTessellationSettingsConditionally(e,(e=>e.tessellationSettingRequested<e.finestTessellationSettingInMemory),i,s),rl()){const n=this.getLoadedDisplayDataVolume(),r=this.getDesiredDisplayDataVolume(e),a=[];a.push(`Total display data in memory: ${al(n)}`),a.push(`Total desired memory usage: ${al(r)}`),a.push(`Maximum allowed memory usage: ${al(s)}`),a.push(`Total requested display memory after optimization: ${al(i)}`),e.forEach((({bodyOccurrence:e})=>{const i=e.getBodyMetaDataForRetrieval(),s=i.getFinestTessellationSettingInMemory(),n=t.get(e),r=i.getBestAvailableTessellationSettingIndex(this.aggressiveRefinementEnabled);a.push(`${i.name}, ${i.getId()}, in memory = ${s}, maximum = ${r}, desired = ${n?.tessellationSettingDesired}, requested = ${n?.tessellationSettingRequested}`)})),a.push(`Number of visible occurrences in frustum=${e.length}`),Yc.info(a.join("\n"))}}upgradeTessellationSettingsConditionally(e,t,i,s){let n=!0;for(;n;){n=!1;const r=new Map;for(const a of e){const e=a.bodyOccurrence.getBodyMetaDataForRetrieval(),o=r.get(e);if(o)a.tessellationSettingRequested=o.tessellationSettingRequested;else{if(t(a)){const t=e.getEstimatedMemoryUsage([a.tessellationSettingRequested+1])-e.getEstimatedMemoryUsage([a.tessellationSettingRequested]);i+t<=s&&(a.tessellationSettingRequested+=1,i+=t,n=!0)}r.set(e,a)}}}return i}getDesiredDisplayDataVolume(e){let t=0;const i=new Set;for(const s of e){const e=s.bodyOccurrence.getBodyMetaDataForRetrieval();i.has(e)||(i.add(e),s.tessellationSettingDesired>=0&&(t+=e.getEstimatedMemoryUsage([s.tessellationSettingDesired])))}return t}getLoadedDisplayDataVolume(){let e=0;const t=new Set;return this.occurrences.forEach((function(i){const s=i.getBodyMetaDataForRetrieval();t.has(s)||(t.add(s),e+=s.getEstimatedMemoryUsage())}),this),e}performUnloadedBodyAndRefinementCheck(){if(this.paused)return void Yc.info("Skipped body refinement check due to pause");if(el===Jc.DISABLED)return;if(!this.encounteredUnloadedOccurrenceInLastFrame&&!this.allowRefinementCheck())return;const e=rl(),t=new Ih.B7("BodyManager.performUnloadedBodyAndRefinementCheck",{logResult:e});this.findMaximumRefinementForOccurrences(),this.startRetrievalTimeout(),t.report()}collectBodyOccurrencesInViewport(){const e=new Ih.B7("BodyManager.collectBodyOccurrencesInViewport"),t=[];let i=[];const s=this.viewer.getCamera();if(s){const e=s.viewportToCanvas([0,s.getViewportHeight(),0]),n=this.aggressiveRefinementEnabled&&ks();i=this.viewer.pickInRect(e[0],e[1],s.getViewportWidth(),s.getViewportHeight(),!1,{bodyPicks:t,nodeFilterOverride:this.refinementNodeFilter,sampleLimit:X.default.getManager().getNumber("OFFSCREEN_BODY_ERROR_SAMPLE_SIZE"),doNotAffectFrustumCulling:!0,forcePreviewPick:n})}const n=new Map;for(let e=0;e<t.length;++e){const i=t[e],s=i.primitiveId;if(s.length<1)continue;s.length>1&&Yc.warn("Picked body manager occurrence id with multiple entries");const r=this.idManager.getNameForId(s),a=this.occurrences.get(r);a&&this.collectBodyOccurrenceForOccurrencePick(n,a,i)}for(let e=0;e<i.length;++e)this.collectBodyOccurrenceForEntityPick(n,i[e]);return e.report(),n}updatePickData(e){let t=!1;const i=e.primitiveId;if(i.length<1)return t;i.length>1&&Yc.warn("Picked body manager occurrence id with multiple entries");const s=this.idManager.getNameForId(i),n=this.occurrences.get(s);if(n)if(e.bodyMetaData=n.getBodyMetaDataForRetrieval(),e.occurrence=this.getBtOccurrence(n),e.occurrence)e.occurrenceId=this.viewer.getOccurrenceIdManager().getIdForName(e.occurrence.toString()),t=!0;else{const i=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio();i&&(e.occurrenceId=i.getBodyComponent().getCorrectedBodyOccurrenceId(e.bodyMetaData.id),t=!0)}return t}hideBodyFromPick(e){const t=this.occurrences.get(this.getBodyOccurrenceId(e.occurrenceId,e.bodyMetaData.id));t.occurrenceData.isHiddenFromPick=!0,t?.incrementDetails&&(this.displayOccurrenceData.hideIncrementFromPick(t.incrementDetails,ys.L.BASE),this.displayOccurrenceDataNonIsolated.hideIncrement(t.incrementDetails,ys.L.BASE))}shouldRetrieveHighestQualityTessellationForOccurrence(e){if(e.getBodyMetaData().getTessellationSettingOverride()!==k.XiJ.AUTO)return!0;let t=this.getBtOccurrence(e);for(;t;){const e=this.viewer.getModelViewManagers().getManager().getOccurrenceDisplayData(t);if(e&&e.occurrenceData.forceHighestQualityTessellation)return!0;t.path.length>0?t.path.splice(t.path.length-1,1):t=null}return!1}collectBodyOccurrenceForEntityPick(e,t){if(t.isUIPick())return;const i=t.getOccurrence();let s,n,r=t.getBodyId();if(!r)return;const a=this.viewer.getModelViewManagers().getManagerForUsage(t.usage);if(i)s=this.viewer.getOccurrenceIdManager().getIdForName(i.toString()),n=a.retrieveBodyMetaData(i,r),n&&n.canBeGroupedWithOtherConstituents&&(r=n.consumingClosedCompositeData.getId());else{const e=a.getDisplayedPartStudio();if(!e)return;n=e.retrieveBodyMetaData(r),n&&n.canBeGroupedWithOtherConstituents&&(r=n.consumingClosedCompositeData.getId()),s=e.getBodyComponent().getCorrectedBodyOccurrenceId(r)}let o=this.occurrences.get(this.getBodyOccurrenceId(s,r));if(!o&&t.usage===ys.L.PREVIEW&&(o=this.previewOccurrences.get(r),!o)){const e=this.viewer.getOccurrenceDataManager().getOccurrenceData(s);e&&n&&(o=new ul(e,n),this.previewOccurrences.set(r,o))}o&&this.collectBodyOccurrenceForOccurrencePick(e,o,t)}collectBodyOccurrenceForOccurrencePick(e,t,i){const s=e.get(t);s?s.viewportOccupancyRatio+=i.coverage:e.set(t,{viewportOccupancyRatio:i.coverage})}getBodiesInFrustum(){const e=new Set,t=this.viewer.getCamera();return this.occurrences.forEach((function(i){i.outsideFrustum(t)||e.add(i.getBodyMetaData())}),this),e}getBodiesInvolvedInSelection(){const e=new Set,t=(0,Me._g)();for(let i=0;i<t.length;++i){t[i].forEach((t=>{let i=t.getBodyMetaData();!i&&t.getEntityMetaData()&&(i=t.getEntityMetaData().getBodyMetaData()),i&&e.add(i)}))}return e}refreshReducedDetailBoxes(){this.sortedOccurrences.each((e=>{e.displayDamaged=!0})),this.shouldUpdateBodyOccurrenceLodForIsolate=!0}onOccurrencesHighlighted(e,t){if(e===Cn.aU.ADD){const e=this.viewer.getModelViewManagers().getManager(),i=this.viewer.getOccurrenceIdManager();for(let s=0;s<t.length;++s){const n=e.getOccurrenceDisplayData(t[s]);if(!n?.displayedPartIds)continue;const r=i.getIdForName(t[s].toString());for(const e of n.displayedPartIds){const t=this.occurrences.get(this.getBodyOccurrenceId(r,e));t?.mustShowLowestLod()&&(t.displayDamaged=!0)}}}}getPartStudio(e){const t=this.viewer.getModelViewManagers().getManager(),i=this.getBtOccurrence(e);return i?t.getPartStudioDataFromOccurrence(i):t.getDisplayedPartStudio()}getTessellationIndexToGoUnderThreshold(e,t,i,s){let n=0;const r=e.getBodyMetaData();if(r.isWireBody()&&!r.hasTessellationSettings())return null;if(r.isClosedComposite&&r.containsOnlyWireBodies()){const t=this.getPartStudio(e);if(t)for(let e=0;e<r.constituentBodyIds.length;++e){const i=t.retrieveBodyMetaData(r.constituentBodyIds[e]);if(i&&!i.hasTessellationSettings())return null}}if(this.viewer.getRenderingMode()===k.P1.SHADED_CURVATURE_VISUALIZATION)return k.ls1.getTessellationSettingIndexFromEnum(k.XiJ.CURVATURE_VISUALIZATION);const a=r.getBestAvailableTessellationSettingIndex(!!s);if(null===a)return null;for(;n<a;){if(!(i*r.getChordalToleranceForSetting(n)>=t))break;n++}return n}cleanupPendingRefinementRequests(){if(0===this.pendingRetrievalInformation.size)return;const e=new Set;for(const[t,i]of this.pendingRetrievalInformation){t.getFinestTessellationSettingInMemory()===i.tessellationSetting&&(e.add(t),this.pendingRetrievalInformation.delete(t))}const t=new Set;this.occurrences.forEach((i=>{const s=i.getBodyMetaDataForRetrieval();t.add(s),e.has(s)&&this.resetRetrievalStateForOccurrence(i)}));for(const[e,i]of this.pendingRetrievalInformation)t.has(e)||this.pendingRetrievalInformation.delete(e);rl()&&Yc.info(`Number of refined pending requests: ${e.size} remaining: ${this.pendingRetrievalInformation.size}`)}unloadBodies(e,t){if(rl()&&Yc.info(`Unload bodies ${al(e)}`),this.paused)return Yc.info("Skipped body unloading due to pause"),null;const i=Array.from(this.occurrences.values()),s=this.getBodiesInFrustum(),n=this.getBodiesInvolvedInSelection(),r=new Map;for(const e of this.occurrenceRetrievalRequests){const t=e.bodyOccurrence.getBodyMetaDataForRetrieval();r.has(t)||r.set(t,e)}const a=t.getDisplayedPartStudio(),o=t.getPartStudios();for(let e=0;e<o.length;++e){const t=o[e];if(t===a)continue;const s=t.getBodyComponent().getNonInstantiatedBodies();for(let e=0;e<s.length;++e){const n=s[e];n.hasTessellationSettings()&&i.push(new hl(t,n))}}i.sort((function(e,t){if(e.isInstantiated()!==t.isInstantiated())return e.isInstantiated()?1:-1;const i=e.isBodyDataPresent(),r=t.isBodyDataPresent();if(!i&&!r)return 0;if(!i)return 1;if(!r)return-1;const a=e.getBodyMetaDataForRetrieval(),o=t.getBodyMetaDataForRetrieval(),h=n.has(a);if(h!==n.has(o))return h?1:-1;const c=s.has(a);if(c!==s.has(o))return c?1:-1;const l=e.getLastViewTime(),d=t.getLastViewTime();if(l!==d)return l>d?1:-1;const u=e.getLastViewportOccupancy(),g=t.getLastViewportOccupancy();if(u!==g)return u>g?1:-1;const p=e.getBenefitToUnload(),m=t.getBenefitToUnload();return p>m?-1:m>p?1:0}));const h=new Set;let c=0;for(let t=0;t<i.length&&c<e;++t){const e=i[t],s=e.getBodyMetaDataForRetrieval();if(s.isWireBody())continue;if(!e.isBodyDataPresent()||h.has(s)||n.has(s))continue;if(r.has(s)){const e=r.get(s);if(e?.tessellationSettingRequested!==k.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING)continue}let a;a=e instanceof ul?this.getPartStudio(e):e.partStudio,a&&(c+=s.getEstimatedMemoryUsage(),this.bodyUnloadTask.addBodyToProcess(a.getBodyComponent(),s.getId()),h.add(s))}if(rl()){const t=[];h.forEach((function(e){t.push(e.getId()+"-"+e.getFinestTessellationSettingInMemory())})),t.sort(),Yc.info("Unloading "+al(c)+" of bodies to satisfy request of "+al(e)+". Body ids:\n"+t)}return this.occurrences.forEach((e=>{h.has(e.getBodyMetaDataForRetrieval())&&this.resetRetrievalStateForOccurrence(e)})),this.bodyUnloadTask.getTaskFinishedPromise()}unloadSelectionBody(e){const t=e.getBodyMetaData()||e.getEntityMetaData()?.getBodyMetaData();if(!t)return;const i=this.viewer.getModelViewManagers().getManager().getPartStudioDataFromOccurrence(e.getOccurrence());i&&this.bodyUnloadTask.addBodyToProcess(i.getBodyComponent(),t.id),this.viewer.requestDraw()}}function fl(e,t){return e.benefitToCull===t.benefitToCull?e.getOccurrenceId()===t.getOccurrenceId()?0:e.getOccurrenceId()<t.getOccurrenceId()?-1:1:e.benefitToCull>t.benefitToCull?-1:1}ml.isFirstMemoryReport=!0,ml.sortForRetrievalFunction=(e,t)=>{const i=e.requiresDowngrade(),s=t.requiresDowngrade();return i!==s?i?-1:1:i&&s?t.finestTessellationSettingInMemory-e.finestTessellationSettingInMemory:e.finestTessellationSettingInMemory-t.finestTessellationSettingInMemory};const Il=X.default.getManager();var El;function Sl(e,t){return e+Dn.ID_SEPARATOR+t.getCollectionId()}!function(e){e[e.UNLOAD=0]="UNLOAD",e[e.LOAD=1]="LOAD"}(El||(El={}));class Tl{constructor(e,t){this.bodyComponent=e,this.bodyId=t}getCollectionId(){return Sl(this.bodyId,this.bodyComponent)}}class Dl{constructor(e,t){this.viewer=e,this.action=t,this.bodiesToProcess=[],this.bodiesNeedSort=!1,this.taskFinishedDeferred=null,this.iterationsSinceStart=0,this.bodiesProcessedSinceStart=0,(0,Sh.Yk)(e),this.bodiesToProcessMap=new Map,this.initialLoadBudget=new RC(Il.getNumber("GRAPHICS_TASK_INITIAL_TIME_BUDGET"),Il.getNumber("GRAPHICS_TASK_INITIAL_VERTEX_BUDGET"))}addBodyToProcess(e,t){const i=new Tl(e,t),s=i.getCollectionId();this.bodiesToProcessMap.get(s)||(this.bodiesToProcess.push(i),this.bodiesToProcessMap.set(s,i),this.setBodiesNeedSort())}performInitialLoad(){const e=new Ih.B7("BodyLoader.prototype.performInitialLoad");this.initialLoadBudget.reset(),this.process(this.initialLoadBudget),e.report()}indexOfBody(e,t){for(let i=0;i<this.bodiesToProcess.length;++i){const s=this.bodiesToProcess[i];if(s.bodyComponent===e&&s.bodyId===t)return i}return-1}stopBodyFromProcessing(e,t){if(this.bodiesToProcessMap.has(Sl(t,e))){const i=this.indexOfBody(e,t);i>=0&&(this.bodiesToProcessMap.delete(this.bodiesToProcess[i].getCollectionId()),this.bodiesToProcess.splice(i,1))}}clearBodiesForComponent(e,t){const i=[];for(let s=0;s<this.bodiesToProcess.length;++s){const n=this.bodiesToProcess[s];n.bodyComponent===e&&t.contains(n.bodyId)&&(YE([s,s+1],i),this.bodiesToProcessMap.delete(n.getCollectionId()))}$E(this.bodiesToProcess,i)}clearAllBodiesForComponent(e){const t=[];for(let i=0;i<this.bodiesToProcess.length;++i)this.bodiesToProcess[i].bodyComponent===e&&(YE([i,i+1],t),this.bodiesToProcessMap.delete(this.bodiesToProcess[i].getCollectionId()));$E(this.bodiesToProcess,t)}setBodiesNeedSort(){this.bodiesNeedSort=!0}clearAllBodies(){this.bodiesToProcess=[],this.bodiesToProcessMap.clear(),this.bodiesNeedSort=!1}hasPendingWork(){return this.bodiesToProcess.length>0}sortBodies(){this.bodiesNeedSort&&(this.bodiesToProcess.sort((function(e,t){const i=e.bodyComponent.isBodyInstantiated(e.bodyId);if(i!==t.bodyComponent.isBodyInstantiated(t.bodyId))return i?-1:1;const s=e.bodyComponent.getBodyDiameter(e.bodyId),n=t.bodyComponent.getBodyDiameter(t.bodyId);return s>n?-1:s<n?1:0})),this.bodiesNeedSort=!1)}process(e){this.sortBodies();const t=[];let i=0;for(let s=0;s<this.bodiesToProcess.length;++s){const n=this.bodiesToProcess[s];let r=!1;if(this.action===El.UNLOAD?(n.bodyComponent.unloadBody(n.bodyId),++i,r=!0):n.bodyComponent.processBodyAddition(n.bodyId,e)&&(++i,r=!0),r&&(YE([s,s+1],t),this.bodiesToProcessMap.delete(n.getCollectionId())),e&&e.budgetExceeded())break}$E(this.bodiesToProcess,t),i>0&&this.action===El.LOAD&&this.viewer.getEventDispatcher().trigger(nM.LA),i>0&&(this.bodiesProcessedSinceStart+=i,++this.iterationsSinceStart),this.hasPendingWork()||(this.taskFinishedDeferred&&(this.taskFinishedDeferred.resolve({bodiesProcessedSinceStart:this.bodiesProcessedSinceStart,iterationsSinceStart:this.iterationsSinceStart}),this.taskFinishedDeferred=null),this.iterationsSinceStart=0,this.bodiesProcessedSinceStart=0)}getTaskFinishedPromise(){return this.taskFinishedDeferred?this.taskFinishedDeferred.promise:this.hasPendingWork()?(this.taskFinishedDeferred=Jr.defer(),this.taskFinishedDeferred.promise):null}}class Cl{constructor(e){this.loadTask=new Dl(e,El.LOAD),this.unloadTask=new Dl(e,El.UNLOAD)}getLoadTask(){return this.loadTask}getUnloadTask(){return this.unloadTask}postBodyToLoad(e,t){this.loadTask.addBodyToProcess(e,t),this.unloadTask.stopBodyFromProcessing(e,t)}postBodyToUnload(e,t){this.unloadTask.addBodyToProcess(e,t),this.loadTask.stopBodyFromProcessing(e,t)}completeTasks(){this.loadTask.process(null),this.unloadTask.process(null)}stopBodyFromProcessing(e,t){this.loadTask.stopBodyFromProcessing(e,t),this.unloadTask.stopBodyFromProcessing(e,t)}clearBodiesForComponent(e,t){this.loadTask.clearBodiesForComponent(e,t),this.unloadTask.clearBodiesForComponent(e,t)}clearAllBodiesForComponent(e){this.loadTask.clearAllBodiesForComponent(e),this.unloadTask.clearAllBodiesForComponent(e)}clearAllBodies(){this.loadTask.clearAllBodies(),this.unloadTask.clearAllBodies()}hasPendingUnloads(){return this.unloadTask.hasPendingWork()}}const Ml=X.default.getManager(),yl=new Gi.hF({primitiveType:Ai.MX.LINES,isShowThrough:!0,isDepthTested:!1,isPickable:!1}),Al=yl.cloneAndModify({includedInBlend:!0}),Pl=yl.cloneAndModify({priority:Gi.DO.HIGHER}),Ol=yl.cloneAndModify({priority:Gi.DO.HIGHEST}),Rl=new Gi.hF({primitiveType:Ai.MX.TRIANGLE_STRIP,isTwoSided:!0,isShowThrough:!0,isDepthTested:!1,isPickable:!1,zOffset:Ml.getNumber("MATE_CONNECTOR_TRIANGLE_Z_OFFSET"),primitivesHaveTransparency:!0,material:Vi}),wl=Rl.cloneAndModify({priority:Gi.DO.HIGHER}),vl=Rl.cloneAndModify({includedInBlend:!0}),_l=Rl.cloneAndModify({priority:Gi.DO.HIGHEST}),Nl=new Gi.hF({primitiveType:Ai.MX.TRIANGLES,isTwoSided:!0,isShowThrough:!0,isDepthTested:!1,isVisible:!1});var bl;!function(e){e.LINES="lines",e.LINES_FADED="lines_faded",e.TRIANGLES="triangles",e.COMPARE_BASE_TRIANGLES="compare_base_triangles",e.COMPARE_TARGET_TRIANGLES="compare_target_triangles",e.TRIANGLES_PRESELECTED="triangles_preselected",e.TRIANGLES_SELECTED="triangles_selected",e.TRIANGLES_SECONDARY="triangles_secondary",e.TRIANGLES_FADED="triangles_faded",e.PICK_DISC="pick_disc",e.INFERENCE_POINT_TRIANGLES="inference_point_triangles",e.INFERENCE_POINT_LINES="inference_point_lines",e.INFERENCE_CENTER_TRIANGLES="inference_center_triangles",e.INFERENCE_CENTER_LINES="inference_center_lines",e.INFERENCE_CENTROID_TRIANGLES="inference_centroid_triangles",e.INFERENCE_CENTROID_LINES="inference_centroid_lines",e.INFERENCE_MID_POINT_TRIANGLES="inference_mid_point_triangles",e.INFERENCE_MID_POINT_LINES="inference_mid_point_lines",e.INFERENCE_ORIGIN_AXIS_LINES="inference_origin_axis_lines",e.INFERENCE_ORIGIN_AXIS_LINES_PRESELECTED="inference_origin_axis_lines_preselected"}(bl||(bl={}));let Ll=null,Fl=!0;class xl extends yi.u1{constructor(e,t,i,s){super(i,t),this.definition=e,this.isBeingEdited=!1,this.lastScale=-1,this.worldSpacePosition=[0,0,0],this.activeMateConnectorScaled=!1,this.isForInContextAssembly=!1,this.isFromChildFeature=!1,this.isParentOccurrenceDataMissing=!1,this.partStudioFeatureId=s||"",this.isPartStudioMateConnector=!!this.partStudioFeatureId,this.occurrenceTransform=ue.create(),this.parentOccurrenceVisibility=Xs.EE.VISIBLE,this.usage=t===uh.Vv?ys.L.PREVIEW:ys.L.BASE,this.damageTransform(),this.updateHideState(),this.occurrenceData.setCanIsolateChange(!0),this.occurrenceData.setIsolated(!1),this.isForInContextAssembly=e&&e.occurrence&&this.viewer.getModelViewManagers().getManager().isDisplayingIncontextAssembly(),this.definition.implicit&&(this.id="ImplicitMateConnector")}cloneForPreview(){return new xl(this.definition,uh.Vv,this.viewer,this.partStudioFeatureId)}getUsage(){return this.usage}getWorldSpacePosition(){return this.worldSpacePosition}onDevicePixelRatioChanged(e){Ll=null,this.updateGraphics()}getIsPartStudioMateConnector(){return this.isPartStudioMateConnector}getId(){return(0,Tn.vm)(this.definition.ownerOccurrence,this.definition.nodeId)}setOccurrenceTransform(e){this.occurrenceTransform=e,this.damageTransform()}setEditState(e){this.isBeingEdited=e,this.updateHideState(),this.updateGraphics()}getDefinition(){return this.definition?this.definition:null}getLineProperties(){return this.isForInContextAssembly?yl:Al}getTriangleProperties(){return this.isForInContextAssembly?yl:vl}updateDefinition(e){this.definition=e,this.updateHideState(),this.damageTransform()}damageTransform(){this.lastScale=-1,this.definition&&ge.w$.multiplyVec3(this.occurrenceTransform,this.definition.location.origin.getVec3(),this.worldSpacePosition),this.viewer.requestDraw()}getWorldSpaceDefinition(){if(!this.definition)return null;const e=new k.em5,t=this.definition.location.xAxis.getVec3(),i=this.definition.location.yAxis.getVec3(),s=this.definition.location.zAxis.getVec3(),n=this.definition.location.origin.getVec3(),r=ge.w$.toRotationMat(this.occurrenceTransform,ue.create());return ge.w$.multiplyVec3(this.occurrenceTransform,n),ge.w$.multiplyVec3(r,t),ge.w$.multiplyVec3(r,i),ge.w$.multiplyVec3(r,s),e.xAxis.updateFromArray(t),e.yAxis.updateFromArray(i),e.zAxis.updateFromArray(s),e.origin.updateFromArray(n),e}canPickThrough(){return!0}getPickPriority(){return gI.z.MATE_CONNECTOR}getModelSelection(e){return this.definition?new Me.Y1(k.lQt.MATE_CONNECTOR,this.definition.nodeId,this.definition.ownerOccurrence,{sourcePick:e.sourcePick,isPartStudioMateConnector:this.isPartStudioMateConnector,isDerivedFeature:this.definition.isDerivedFeature,isChildFeature:this.isFromChildFeature,featureId:this.partStudioFeatureId}):null}addHighlight(e){super.addHighlight(e),this.updateHideState(),this.updateGraphics()}removeHighlight(e){return!!super.removeHighlight(e)&&(this.updateHideState(),this.updateGraphics(),!0)}getUserVisibilitySetting(){return this.definition.hidden?Xs.EE.HIDDEN:Xs.EE.VISIBLE}updateOccurrenceVisibility(e){e!==this.parentOccurrenceVisibility&&(this.parentOccurrenceVisibility=e,this.updateHideState(),this.updateGraphics())}updateHideState(){!this.isParentOccurrenceDataMissing&&(this.isBeingEdited||this.isHighlighted()||this.getUserVisibilitySetting()!==Xs.EE.HIDDEN&&this.parentOccurrenceVisibility!==Xs.EE.HIDDEN)?(this.hasMeshIncrements()||this.updateGraphics(!0),this.show()):this.hide()}setOpacity(e){const t=Bl(),i=Ml.getColor("MATE_CONNECTOR_COLOR");i[3]=e,(0,Yd.Ab)(i,t[bl.TRIANGLES_FADED]),this.updateMeshIncrement(bl.TRIANGLES,yi.ZJ,t[bl.TRIANGLES_FADED].clone(),this.getTriangleProperties()),this.setLineOpacity(e)}onIsolateChanged(){this.updateGraphics()}updateIsolation(){if(this.viewer.getIsolatedOccurrenceManager()?.hasIsolatedInstances()&&!this.occurrenceData.getIsolated()){let e=0;e=this.isForInContextAssembly?Ml.getNumber("ISOLATE_CONTEXT_UI_MATE_CONNECTOR_TRANSPARENCY"):Ml.getNumber("ISOLATE_CONTEXT_UI_TRANSPARENCY")*$e()+(1-$e()),this.setOpacity(e)}else{const e=Bl();this.updateBaseIncrements(e)}}updateBaseIncrements(e){let t=bl.TRIANGLES;const i=Hs(),s=!!i&&(es.Jq.PartStudioCompareService.isPartStudioComparisonReady()&&es.Jq.PartStudioCompareService.doesFeatureHaveADifference(this.partStudioFeatureId));i&&s&&(t=this.sceneGraphId===uh.lL?bl.COMPARE_BASE_TRIANGLES:bl.COMPARE_TARGET_TRIANGLES),this.updateMeshIncrement(bl.TRIANGLES,yi.ZJ,e[t].clone(),this.getTriangleProperties()),this.setLineOpacity(1),this.updateMeshIncrement(bl.LINES,yi.ZJ,e[bl.LINES].clone(),this.getLineProperties())}setLineOpacity(e){const t=Bl(),i=(0,Yd.Ae)(t[bl.LINES_FADED],e);this.updateMeshIncrement(bl.LINES,yi.ZJ,i.clone(),this.getLineProperties())}adjustTransform(e){if(!this.definition||this.isHidden)return;let t=e.getPixelSizeAtWorldPoint(this.worldSpacePosition);const i=this.getIsActiveMateConnector();if(this.activeMateConnectorScaled&&!i&&(this.activeMateConnectorScaled=!1,this.lastScale=-1),Math.abs(this.lastScale-t)<Ri.W.ZERO_LENGTH)return;this.lastScale=t,i&&(t*=Ml.getNumber("ACTIVE_MATE_CONNECTOR_SIZE_SCALE_PERCENT"),this.activeMateConnectorScaled=!0);const s=ue.create();s[0]=t,s[5]=t,s[10]=t,this.setTransform(ge.w$.multiply(ge.w$.multiply(this.occurrenceTransform,this.definition.location.getGlMatrix(),ue.create()),s)),this.hasMeshIncrements()||this.updateGraphics()}getIsActiveMateConnector(){const e=this.viewer.getMateConnectorManager();return!!e&&e.isMateConnectorActive(this.getId(),this)}onViewWillDraw(e){this.isHidden||this.hasBeenRemoved||(this.viewer.getIsolatedOccurrenceManager()?.hasIsolatedInstances()&&this.updateGraphics(),this.adjustTransform(e))}onHighlightColorUpdated(){this.isHighlighted()&&this.updateGraphics()}updateGraphics(e){if(!this.definition||this.isHidden&&!e)return void this.removeMeshIncrements();const t=Bl();this.updateMeshIncrement(bl.PICK_DISC,"mateconnector",t[bl.PICK_DISC].clone(),Nl);const i=this.getHighlight();i&&i.type===Cn.o2.PRE?(this.updateMeshIncrement(bl.TRIANGLES,yi.ZJ,t[bl.TRIANGLES_PRESELECTED].clone(),_l),this.updateMeshIncrement(bl.LINES,yi.ZJ,t[bl.LINES].clone(),Ol)):i&&[Cn.o2.SECONDARY,Cn.o2.REPAIR_HOVER].includes(i.type)?(this.updateMeshIncrement(bl.TRIANGLES,yi.ZJ,t[bl.TRIANGLES_SECONDARY].clone(),_l),this.updateMeshIncrement(bl.LINES,yi.ZJ,t[bl.LINES].clone(),Ol)):i?(this.updateMeshIncrement(bl.TRIANGLES,yi.ZJ,t[bl.TRIANGLES_SELECTED].clone(),_l),this.updateMeshIncrement(bl.LINES,yi.ZJ,t[bl.LINES].clone(),Ol),this.muteIfActive()):(this.updateBaseIncrements(t),this.updateIsolation(),this.muteIfActive())}muteIfActive(){if(this.hasBeenRemoved)return;const e=this.getIsActiveMateConnector();if(e&&this.setOpacity(Ml.getNumber("ACTIVE_MATE_CONNECTOR_OPACITY")),this.activeMateConnectorScaled!==e){if(!e){const e=1;this.setOpacity(e)}this.damageTransform()}}static setInteractionEnabled(e){Fl=e}isInteractionEnabled(){return Fl&&!(this.viewer.getIsolatedOccurrenceManager()?.hasIsolatedInstances()&&!this.occurrenceData.getIsolated())}getOccurrence(){return this.definition?this.definition.occurrence:null}setIsParentOccurrenceDataMissing(e){this.isParentOccurrenceDataMissing=e,this.updateHideState()}}function Bl(){if(Ll)return Ll;Ll={};const e=M.create(),t=M.fromValues(0,0,1),i=M.fromValues(1,0,0),s=Math.PI/2,n=.75*Ml.getNumber("MATE_CONNECTOR_RADIAL_SEGMENTS"),r=.25*Ml.getNumber("MATE_CONNECTOR_RADIAL_SEGMENTS");let a=Ml.getNumber("MATE_CONNECTOR_DIAMETER_PX")/2;const o=a-Ml.getNumber("MATE_CONNECTOR_RING_WIDTH_PX"),h=Ml.getColor("MATE_CONNECTOR_STROKE_COLOR");let c=Ml.getNumber("MATE_CONNECTOR_STROKE_WIDTH"),l=(0,Yd.y)(e,a,t,Ml.getNumber("MATE_CONNECTOR_RADIAL_SEGMENTS"));(0,Yd.Ab)(h,l),(0,Yd.VQ)(c,l);const d=(0,Yd.QV)(e,o,t,i,s,2*Math.PI,n);(0,Yd.Ab)(h,d),(0,Yd.VQ)(c,d);let u=(0,Yd.W5)(e,[o,0,0],void 0,h,c),g=(0,Yd.W5)(e,[0,o,0],void 0,h,c);const p=Ml.getNumber("MATE_CONNECTOR_AXIS_LINE_GAP_PX"),m=Ml.getNumber("MATE_CONNECTOR_AXIS_LINE_LENGTH_PX"),f=Ml.getNumber("MATE_CONNECTOR_AXIS_LINE_WIDTH"),I=Ml.getNumber("MATE_CONNECTOR_Z_AXIS_LINE_LENGTH_PX"),E=Ml.getNumber("MATE_CONNECTOR_Z_AXIS_LINE_WIDTH"),S=(0,Yd.W5)([a+p,0,0],[a+p+m,0,0],void 0,Ml.getColor("X_AXIS_COLOR"),f),T=(0,Yd.W5)([0,a+p,0],[0,a+p+m,0],void 0,Ml.getColor("Y_AXIS_COLOR"),f),D=(0,Yd.W5)([0,0,p],[0,0,p+I],void 0,Ml.getColor("Z_AXIS_COLOR"),E);let C=l.concatenate(d).concatenate(u).concatenate(g).concatenate(S).concatenate(T).concatenate(D);C&&(Ll[bl.LINES]=C,Ll[bl.LINES_FADED]=C.clone());const y=(0,Yd.I$)(e,o,a,t,i,s,2*Math.PI,n),A=(0,Yd.I$)(e,0,a,t,i,0,s,r),P=y.concatenate(A);P&&(Ll[bl.TRIANGLES]=P,(0,Yd.Ab)(Ml.getColor("MATE_CONNECTOR_COLOR"),Ll[bl.TRIANGLES]),Ll[bl.COMPARE_BASE_TRIANGLES]=P.clone(),(0,Yd.Ab)(Ml.getColor("MATE_CONNECTOR_COMPARE_BASE_COLOR"),Ll[bl.COMPARE_BASE_TRIANGLES]),Ll[bl.COMPARE_TARGET_TRIANGLES]=P.clone(),(0,Yd.Ab)(Ml.getColor("MATE_CONNECTOR_COMPARE_TARGET_COLOR"),Ll[bl.COMPARE_TARGET_TRIANGLES]),Ll[bl.TRIANGLES_PRESELECTED]=P.clone(),(0,Yd.Ab)(Ml.getColor("MATE_CONNECTOR_PRE_SELECTED_COLOR"),Ll[bl.TRIANGLES_PRESELECTED]),Ll[bl.TRIANGLES_SELECTED]=P.clone(),(0,Yd.Ab)(Ml.getColor("MATE_CONNECTOR_SELECTED_COLOR"),Ll[bl.TRIANGLES_SELECTED]),Ll[bl.TRIANGLES_FADED]=P.clone(),Ll[bl.TRIANGLES_SECONDARY]=P.clone(),(0,Yd.Ab)(Ml.getColor("MATE_CONNECTOR_SECONDARY_COLOR"),Ll[bl.TRIANGLES_SECONDARY])),Ll[bl.PICK_DISC]=(0,Yd.$)(e,a,t,Ml.getNumber("MATE_CONNECTOR_RADIAL_SEGMENTS")),a=Ml.getNumber("MATE_CONNECTOR_MINI_DIAMETER_PX")/2,c=Ml.getNumber("MATE_CONNECTOR_MINI_STROKE_WIDTH"),l=(0,Yd.y)(e,a,t,Ml.getNumber("MATE_CONNECTOR_RADIAL_SEGMENTS")),(0,Yd.Ab)(Ml.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),l),Ll[bl.INFERENCE_POINT_LINES]=l,Ll[bl.INFERENCE_POINT_TRIANGLES]=(0,Yd.I$)(e,0,a,t,i,0,2*Math.PI,4*r),(0,Yd.Ab)(Ml.getColor("MATE_CONNECTOR_INFERENCE_FILL_COLOR"),Ll[bl.INFERENCE_POINT_TRIANGLES]),l=(0,Yd.y)(e,a,t,Ml.getNumber("MATE_CONNECTOR_RADIAL_SEGMENTS")),(0,Yd.Ab)(Ml.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),l),(0,Yd.VQ)(c,l),u=(0,Yd.W5)([-a,0,0],[a,0,0],void 0,Ml.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),c),g=(0,Yd.W5)([0,-a,0],[0,a,0],void 0,Ml.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),c),C=l.concatenate(u),C=C.concatenate(g),C&&(Ll[bl.INFERENCE_CENTER_LINES]=C),Ll[bl.INFERENCE_CENTER_TRIANGLES]=(0,Yd.I$)(e,0,a,t,i,0,2*Math.PI,4*r),(0,Yd.Ab)(Ml.getColor("MATE_CONNECTOR_INFERENCE_FILL_COLOR"),Ll[bl.INFERENCE_CENTER_TRIANGLES]),l=(0,Yd.y)(e,a,t,Ml.getNumber("MATE_CONNECTOR_RADIAL_SEGMENTS")),(0,Yd.Ab)(Ml.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),l),(0,Yd.VQ)(c,l),u=(0,Yd.W5)([-a,0,0],[a,0,0],void 0,Ml.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),c),g=(0,Yd.W5)([0,-a,0],[0,a,0],void 0,Ml.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),c),C=l.concatenate(u).concatenate(g),C&&(Ll[bl.INFERENCE_CENTROID_LINES]=C);const O=(0,Yd.I$)(e,0,a,t,i,0,.5*Math.PI,r);(0,Yd.Ab)(Ml.getColor("MATE_CONNECTOR_INFERENCE_FILL_COLOR"),O);const R=(0,Yd.I$)(e,0,a,t,i,.5*Math.PI,Math.PI,r);(0,Yd.Ab)(Ml.getColor("MATE_CONNECTOR_INFERENCE_DARK_FILL_COLOR"),R);const w=(0,Yd.I$)(e,0,a,t,i,Math.PI,1.5*Math.PI,r);(0,Yd.Ab)(Ml.getColor("MATE_CONNECTOR_INFERENCE_FILL_COLOR"),w);const v=(0,Yd.I$)(e,0,a,t,i,1.5*Math.PI,2*Math.PI,r);(0,Yd.Ab)(Ml.getColor("MATE_CONNECTOR_INFERENCE_DARK_FILL_COLOR"),v);const _=O.concatenate(R).concatenate(w).concatenate(v);Ll[bl.INFERENCE_CENTROID_TRIANGLES]=_;const N=.7071*a,b=(0,Yd.W5)([-N,-N,0],[N,-N,0],void 0,Ml.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),c),L=(0,Yd.W5)([-N,N,0],[N,N,0],void 0,Ml.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),c),F=(0,Yd.W5)([-N,-N,0],[-N,N,0],void 0,Ml.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),c),x=(0,Yd.W5)([N,-N,0],[N,N,0],void 0,Ml.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),c);C=b.concatenate(L).concatenate(F).concatenate(x),C&&(Ll[bl.INFERENCE_MID_POINT_LINES]=C),Ll[bl.INFERENCE_MID_POINT_TRIANGLES]=(0,Yd.VO)([-N,-N,0,N,-N,0,N,N,0,-N,N,0],[1,2,0,3],void 0,Ml.getColor("MATE_CONNECTOR_INFERENCE_FILL_COLOR"));const B=5*Ml.getNumber("MATE_CONNECTOR_AXIS_LINE_LENGTH_PX"),V=2*Ml.getNumber("MATE_CONNECTOR_Z_AXIS_LINE_WIDTH"),U=(0,Yd.W5)([0,0,0],[0,0,B],void 0,Ml.getColor("MATE_CONNECTOR_INFERENCE_FRAME_COLOR"),V),H=(0,Yd.W5)([0,0,p],[0,0,B],void 0,Ml.getColor("MATE_CONNECTOR_SELECTED_COLOR"),V);return Ll[bl.INFERENCE_ORIGIN_AXIS_LINES]=U,Ll[bl.INFERENCE_ORIGIN_AXIS_LINES_PRESELECTED]=H,Object.values(Ll).forEach((function(e){(0,yi._J)(e)})),Ll}function Vl(e){const t=Ml.getColor("MATE_CONNECTOR_SELECTED_COLOR");if(e)for(let i=0;i<3;i++)t[i]=e[i];const i=Bl();i&&(0,Yd.Ab)(t,i[bl.TRIANGLES_SELECTED])}const Ul="elementPreviewManager";class Hl{constructor(e){this.viewer=e,this.DISPLAY_OCCURRENCE_NAME="ElementPreviewManager",this.GROUP_RANGE_GROUP_ID="elementPreviewGroup",this.nodeOccurrenceNames=[],this.nodeOccurenceIds=[],this.node=new Gi.NB(Ul),this.meshManager=new eD(this.viewer,{bufferAllocationPolicy:AE.MAXIMUM}),this.displayOccurrenceId=this.viewer.getOccurrenceIdManager().getOrCreateIdForName(this.DISPLAY_OCCURRENCE_NAME),this.displayOccurrenceData=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(this.displayOccurrenceId),this.displayOccurrenceData.setLod(wS.DEFAULT),this.meshOwnerId=JT(),this.finalSceneBounds=new wi.kB,this.viewer.getModelViewManagers().getManager().getElementPreviewRootNode();this.viewer.getModelViewManagers().getManager().getElementPreviewBodyNode().addChild(this.node)}destroy(){this.node.remove();const e=this.viewer.getOccurrenceDataManager();e.destroyOccurrenceData(this.displayOccurrenceId);for(let t=0;t<this.nodeOccurenceIds.length;++t)e.destroyOccurrenceData(this.nodeOccurenceIds[t]);const t=this.viewer.getOccurrenceIdManager();t.removeName(this.DISPLAY_OCCURRENCE_NAME);for(let e=0;e<this.nodeOccurrenceNames.length;++e)t.removeName(this.nodeOccurrenceNames[e]);this.meshManager.destroy(),this.finalSceneBounds.reset()}readFloat32Array(e){return e?new Float32Array(e.buffer):new Float32Array(0)}readUint32Array(e){return e?new Uint32Array(e.buffer):new Uint32Array(0)}readUint16Array(e){return e?new Uint16Array(e.buffer):new Uint16Array(0)}processGLDisplayData(e){if(!e)return;let t=1,i=1;const s=e.buffers,n=e.nodes;for(let r=0;r<n.length;++r){const a=new mS.bg,o=fm.cloneAndModify({isPickable:!1,isHighlightable:!1}),h=n[r],c=h.drawables;if(!c||0===c.length)continue;const l=c[0],d=l.attributes,u=d.point>-1?s[e.bufferAccessors[d.point].bufferIndex].data:null;let g=new Array(0);d.point>-1&&(g=e.bufferAccessors[d.point].glDataType===k.hs8.UNSIGNED_SHORT?Array.from(this.readUint16Array(u)):this.readFloat32Array(u));const p=d.normal>-1?s[e.bufferAccessors[d.normal].bufferIndex].data:null,m=new Int8Array(p),f=new Float32Array(m.length);for(let e=0;e<f.length;++e)f[e]=m[e]/127;const I=l.indices>-1?s[e.bufferAccessors[l.indices].bufferIndex].data:null,E=this.readUint32Array(I),S=l.appearance.color,T=[S[0]/255,S[1]/255,S[2]/255,l.appearance.opacity/255],D=(0,Yd.VO)(g,E,f,T),C=this.GROUP_RANGE_GROUP_ID+t,M=this.meshManager.getOrCreateGroupRangesForGroupTypeAndLod(C,this.meshOwnerId,Ai.MX.TRIANGLE_STRIP,wS.DEFAULT);D.id="elementPreviewGraphics_"+t,D.groupId=C,D.lod=wS.DEFAULT,this.meshManager.addMeshIncrement(D,this.meshOwnerId),t+=1;for(let e=0;e<h.transform.length;++e){const t=this.DISPLAY_OCCURRENCE_NAME+i;this.nodeOccurrenceNames.push(t);const s=this.viewer.getOccurrenceIdManager().getOrCreateIdForName(this.DISPLAY_OCCURRENCE_NAME+i);this.nodeOccurenceIds.push(s);const n=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(s);n.setLod(wS.DEFAULT),n.setTransform(h.transform[e].getGlMatrix()),this.node.addOccurrenceGeometryToNode(o,n,a,M),i+=1}}this.viewer.getModelViewManagers().getManager().getElementPreviewBodyNode().damageBounds()}processGLDisplayDataResponse(e){if(e&&e.hasGLDisplayData){const t=new k.gFF(e.glDisplayDataBytes).readMessage();t.finalSceneBounds&&(this.finalSceneBounds.addPoint(t.finalSceneBounds.minCorner.getVec3()),this.finalSceneBounds.addPoint(t.finalSceneBounds.maxCorner.getVec3())),this.processGLDisplayData(t)}}getModelBounds(){if(this.finalSceneBounds&&this.finalSceneBounds.isInitialized()&&this.finalSceneBounds.isExtensive())return this.finalSceneBounds;{const e=new wi.kB,t=this.viewer.getModelViewManagers().getManager().getElementPreviewBodyNode();return t&&e.addBox(t.getBoundingBox()),e}}}var Gl=i(31258);class kl{constructor(e,t){this.viewer=t,(0,Sh.Yk)(t),this.imageData=new Gl.TemplatedNestedMap,this.imageDisplays=new Gl.TemplatedNestedMap,this.imageDisplaysByOccurrence=new Gl.TemplatedCountedMap,this.activeSketchIds=new mt.StringSet,this.hiddenSketchIds=new mt.StringSet,this.usage=e||ys.L.BASE}processDisplayData(e){this.imageDisplays.eachNested(((t,i,s)=>{const n=this.imageDisplays.getNested(i,s);if(n){if(e.sketchImages.hasOwnProperty(i)&&e.sketchImages[i].hasOwnProperty(s)){const t=e.sketchImages[i][s];if((0,qn.e)(t.sourceId)===n.url&&t.isOnFlat===n.isOnFlat)return}return n.remove(),this.imageDisplays.removeNested(i,s),!1}})),this.imageData.clear(),Object.entries(e.sketchImages).forEach((([e,t])=>{Object.entries(t).forEach((([t,i])=>{this.viewer.getIsForFlattenedDisplay()===i.isOnFlat&&this.imageData.insertNested(e,t,i)}))}))}reset(){this.remove(),this.imageData.clear()}remove(){this.imageDisplays.eachNested((function(e){return e.remove(),!1}),this),this.imageDisplays.clear(),this.imageDisplaysByOccurrence.each((e=>{e.eachNested((e=>{e.remove()}))})),this.imageDisplaysByOccurrence.clear()}removeOccurrence(e){const t=this.imageDisplaysByOccurrence.get(e);t&&(t.eachNested((e=>(e.remove(),!1))),t.clear()),this.imageDisplaysByOccurrence.remove(e)}showPartsWithSheetmetalModelIdOnly(e){const t=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio();this.imageData.eachNested(((i,s,n)=>{const r=this.imageDisplays.getNested(s,n);if(r){if(t&&i.isOnFlat){const s=t.getSketchComponent().getSMModelIdForSketch(i.featureId);e!==s||this.hiddenSketchIds.contains(i.featureId)?r.hide():(r.updateImage(i.sourceId,i.bottomLeftCorner.getVec3(),i.bottomRightCorner.getVec3(),i.topLeftCorner.getVec3()),r.show())}return!1}}))}getDisplaysForOccurrence(e){const t=[],i=this.imageDisplaysByOccurrence.get(e);return i?(i.eachNested((e=>{t.push(e)})),t):t}updateDisplaysByOccurrence(e,t,i){if(0===i.size)return;let s=this.imageDisplaysByOccurrence.get(e);s||(s=new Gl.TemplatedNestedMap,this.imageDisplaysByOccurrence.insert(e,s));const n=new Gl.TemplatedNestedMap;i.forEach((e=>{const t=this.imageData.get(e);t&&n.insert(e,t)}));const r=this.viewer?.getOccurrenceDataManager()?.getOccurrenceData(e)?.getTransform();n.eachNested(((e,i,n)=>{const a=s.getNested(i,n);let o="";if(e.isOnFlat&&(o=this.viewer?.getModelViewManagers()?.getManager()?.getDisplayedPartStudio()?.getSketchComponent()?.getOwnerFlattenedBodyIdForSketch(e.featureId)),a)t.isHidden?a.hide():(a.show(),a.isOnFlat=e.isOnFlat,a.flattenedBodyId=o,a.transform=r,a.updateImage(e.sourceId,e.bottomLeftCorner.getVec3(),e.bottomRightCorner.getVec3(),e.topLeftCorner.getVec3()));else{const a=new jn(n,e.sourceId,e.bottomLeftCorner.getVec3(),e.bottomRightCorner.getVec3(),e.topLeftCorner.getVec3(),null,this.usage,this.viewer,e.isOnFlat,o,r);a.setIsolated(!1),t.isHidden?a.hide():a.show(),s.insertNested(i,n,a)}return!1}))}updateDisplays(){const e=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio();this.imageData.eachNested(((t,i,s)=>{const n=this.imageDisplays.getNested(i,s);let r=ue.create(),a="";if(e&&t.isOnFlat&&(a=e.getSketchComponent().getOwnerFlattenedBodyIdForSketch(t.featureId),a)){const t=e.retrieveBodyMetaData(a);t&&(r=e.getBodyComponent().getTransformFromSheetMetalBodyMetaData(t))}if(n)n.isHidden||(n.isOnFlat=t.isOnFlat,n.flattenedBodyId=a,n.transform=r,n.updateImage(t.sourceId,t.bottomLeftCorner.getVec3(),t.bottomRightCorner.getVec3(),t.topLeftCorner.getVec3()));else{const e=new jn(s,t.sourceId,t.bottomLeftCorner.getVec3(),t.bottomRightCorner.getVec3(),t.topLeftCorner.getVec3(),null,this.usage,this.viewer,t.isOnFlat,a,r);this.activeSketchIds.contains(i)?e.activate():this.hiddenSketchIds.contains(i)&&e.hide(),this.imageDisplays.insertNested(i,s,e)}return!1}),this)}onSketchHidden(e){this.hiddenSketchIds.add(e),this.imageDisplays.eachNested(((t,i)=>{const s=i?.split(".");return e===s[0]&&t.hide(),!1}))}onSketchShown(e){this.hiddenSketchIds.remove(e),this.imageDisplays.eachNested(((t,i,s)=>{const n=i.split(".");if(e===n[0]){let e=!0;if(t.isOnFlat){e=!1;const i=this.viewer.getModelViewManagers().getManager(),s=i.getSelectedSheetmetalModelId();if(s){const n=i.getDisplayedPartStudio();if(n){const i=n.retrieveBodyMetaData(t.flattenedBodyId);i&&(e=s===i.sheetMetalModelId)}}}if(e){const e=this.imageData.getNested(i,s);e&&(t.updateImage(e.sourceId,e.bottomLeftCorner.getVec3(),e.bottomRightCorner.getVec3(),e.topLeftCorner.getVec3()),t.show())}}return!1}))}onSketchActivated(e){this.activeSketchIds.contains(e)||(this.imageDisplays.has(e)&&this.imageDisplays.get(e).each(((e,t)=>(e.activate(),!1))),this.activeSketchIds.add(e))}onSketchDeactivated(e){this.activeSketchIds.contains(e)&&(this.imageDisplays.has(e)&&this.imageDisplays.get(e).each(((e,t)=>(e.deactivate(),!1))),this.activeSketchIds.remove(e))}cloneForUsage(e){const t=new kl(e,this.viewer);return this.imageData.eachNested(((e,i,s)=>(t.imageData.insertNested(i,s,e),!1))),e===ys.L.PREVIEW&&this.imageDisplays.eachNested(((e,i,s)=>(t.imageDisplays.insertNested(i,s,e.cloneForPreview()),!1))),t}hideImage(e,t){if(this.imageDisplays.hasNested(e,t)){this.imageDisplays.getNested(e,t).hide()}}cloneImageDisplay(e,t){if(this.imageDisplays.hasNested(e,t)){const i=this.imageDisplays.getNested(e,t),s=new jn(t,i.url,i.bottomLeftCorner,i.bottomRightCorner,i.topLeftCorner,i.texture,i.usage,this.viewer,i.isOnFlat,i.flattenedBodyId,i.transform);return i.isHidden&&s.hide(),i.isActive&&s.activate(),s}return null}}var Wl=i(59701),zl=i(87780);const Xl=_e.O.createLogger("TextureAtlas",k.bVy.GRAPHICS);class Zl{constructor(){this.id="",this.imageName="",this.svgToStyle="",this.backgroundColor="rgba(0,0,0,0)",this.index=-1}}class ql{constructor(e,t){this.viewer=e,this.options=t,this.sources=null,this.imageSize=0,this.gridSize=0,this.textureSize=0,this.texture=null,this.canvas=null,(0,Sh.Yk)(e)}destroy(){this.texture&&(this.texture.destroy(),this.texture=null)}getCanvasPosition(e){const t=e%this.gridSize,i=(e-t)/this.gridSize;return[t*this.imageSize,i*this.imageSize]}onReceivedImages(e){this.canvas=document.createElement("canvas"),this.canvas.width=this.textureSize,this.canvas.height=this.textureSize,this.options.debugCanvas&&(this.canvas.style.position="absolute",this.canvas.style.left="0",this.canvas.style.bottom="0",this.canvas.style.zIndex="1000",document.body.append(this.canvas));const t=this.canvas.getContext("2d");t.fillStyle="rgba(0, 0, 0, 0)",t.fillRect(0,0,this.textureSize,this.textureSize),e.forEach(((e,i)=>{const s=this.sources[i],n=this.getCanvasPosition(i);t.fillStyle=s.backgroundColor,t.fillRect(n[0],n[1],this.imageSize,this.imageSize),e&&t.drawImage(e,n[0],n[1],this.imageSize,this.imageSize)})),this.texture=new Io(this.viewer,(e=>{const i=new mo(e);if(i.width=this.canvas.width,i.height=this.canvas.height,this.options.clearColorOverride){const e=t.getImageData(0,0,this.canvas.width,this.canvas.height).data;for(let t=0;t<e.length;t+=4)0===e[t+3]&&(e[t]=this.options.clearColorOverride[0],e[t+1]=this.options.clearColorOverride[1],e[t+2]=this.options.clearColorOverride[2],e[t+3]=this.options.clearColorOverride[3]);i.bytes=e}else i.canvas=this.canvas;return i.magnificationFilter=e.LINEAR,i.minificationFilter=e.LINEAR_MIPMAP_LINEAR,i.maxAnisotropy=4,i.useMipmaps=!0,i})),this.texture.setHasTransparency(this.options.sourcesHaveTransparency)}onImageGetFailed(e){}getTextureCoords(e){const t=this.sources.find((t=>t.id===e));if(!t)return null;const i=this.getCanvasPosition(t.index);return{lowS:i[0]/this.textureSize,highS:(i[0]+this.imageSize)/this.textureSize,lowT:i[1]/this.textureSize,highT:(i[1]+this.imageSize)/this.textureSize}}getTextureCoordsOffset(e,t){const i=this.sources.find((t=>t.id===e));if(!i)return null;const s=this.getCanvasPosition(i.index);return{lowS:(s[0]+t)/this.textureSize,highS:(s[0]+this.imageSize-t)/this.textureSize,lowT:(s[1]+t)/this.textureSize,highT:(s[1]+this.imageSize-t)/this.textureSize}}}const Yl="--static",Kl=["--os-icon-accent-cancel","--os-icon-accent-error","--os-icon-fill-tertiary","--os-icon-outline-primary","--os-icon-outline-primary--static"];function jl(e){return fetch(e).then((t=>t.ok?t.text():Promise.reject(`Failed to load ${e}. ${t?.statusText}`))).then((e=>function(e){for(let t of Kl){const i=new RegExp(`var\\(${t},[^)]*\\)`);t.endsWith(Yl)&&(t=t.substring(0,t.length-Yl.length));const s=zl.GW.getTokenValue(t);e=e.replace(i,s)}return"data:image/svg+xml,"+encodeURIComponent(e)}(e)))}function Ql(e,t,i,s){const n=Math.ceil(Math.sqrt(i.length)),r=(0,wi.cP)(n*t);if(r>e.getMaximumTextureSize()||0===n)return Xl.warn("Attempting to create atlas with bad size. textureSize: "+r+"  gridSize: "+n+" Maximum size: "+e.getMaximumTextureSize()),Jr.fcall((()=>null));const a=new ql(e,s);a.sources=[...i],a.gridSize=n,a.imageSize=t,a.textureSize=r;const o=[];return a.sources.forEach(((e,t)=>{e.index=t;const i=Jr.defer(),s=new Image;s.onload=function(){i.resolve(s)},s.onerror=function(t){Xl.warn("Error loading texture atlas image data: "+(e.imageName||e.svgToStyle)),i.reject(t)},e.svgToStyle?jl("/images/"+e.svgToStyle).then((e=>{s.src=e})).catch((t=>{Xl.warn("Error loading texture atlas svg: "+e.svgToStyle+"\nError: "+t),i.reject(t)})):s.src="/images/"+e.imageName,o.push(i.promise)})),Jr.all(o).then((e=>(a.onReceivedImages(e),a))).catch((e=>(a.onImageGetFailed(e),Jr.resolve(null))))}const $l=_e.O.createLogger("GlyphResources",k.bVy.GRAPHICS);var Jl;!function(e){e.NORMAL="NORMAL",e.ERROR="ERROR",e.SUPPRESSED="SUPPRESSED"}(Jl||(Jl={}));const ed={NORMAL:"",ERROR:"_Error",SUPPRESSED:"_Suppressed"};var td;!function(e){e.NO_HIGHLIGHT="NO_HIGHLIGHT",e.PRE_HIGHLIGHT="PRE_HIGHLIGHT",e.HIGHLIGHT="HIGHLIGHT"}(td||(td={}));const id={NO_HIGHLIGHT_NORMAL:8,NO_HIGHLIGHT_SUPPRESSED:7,NO_HIGHLIGHT_ERROR:6,HIGHLIGHT_NORMAL:5,HIGHLIGHT_SUPPRESSED:4,HIGHLIGHT_ERROR:3,PRE_HIGHLIGHT_NORMAL:2,PRE_HIGHLIGHT_SUPPRESSED:1,PRE_HIGHLIGHT_ERROR:0};class sd{constructor(e,t,i,s,n,r,a){this.atlasId=e,this.viewer=t,this.textures=i,this.pixelSize_=s,this.textureResolutionScales=n,this.textureAtlasOptions=r,this.isDarkModeThemed=a,this.material=Hi(),this.nodeProperties={},this.initializeTextureAtlas(),this.initializeNodeProperties()}onDevicePixelRatioChanged(){this.textureResolutionScales&&this.getTextureResolutionScale(this.lastUsedDevicePixelRatio)!==this.getTextureResolutionScale((0,ns.x_)())&&this.reinitialize()}reinitialize(){this.viewer.getTextureAtlasFactory().clearAtlas(this.atlasId),this.textureAtlas&&(this.textureAtlas.destroy(),this.textureAtlas=null),this.material.ambientTexture=null,this.initializeTextureAtlas(),this.initializeNodeProperties()}destroy(){this.material&&(this.material.destroy(),this.material=null)}get pixelSize(){return this.pixelSize_}get atlasReady(){return!!this.textureAtlas}getNodeProperties(e,t,i){return this.nodeProperties[this.getNodePropertyKey(e,t,i)]}getTextureCoordsOffset(e,t,i,s){return this.textureAtlas.getTextureCoordsOffset(this.getAtlasKey(e,t,i),s)}initializeNodeProperties(){for(const e in td)for(const t in Jl)for(let i=Gi.DO.LOWER;i<=Gi.DO.DEFAULT;++i){const s=this.getNodePropertyKey(e,t,i),n=this.getZOffsetKey(e,t);this.nodeProperties[s]=new Gi.hF({primitiveType:Ai.MX.TRIANGLES,isShowThrough:!0,isDepthTested:!0,isTwoSided:!0,priority:i,primitivesHaveTransparency:!0,material:this.material,zOffset:id[n]})}}initializeTextureAtlas(){this.viewer.getTextureAtlasFactory().getAtlas(this.atlasId,(()=>{const e=[];for(const t in this.textures)for(const i in Jl)for(const s in td)e.push(this.createAtlasItem(t,i,s));const t=this.textureAtlasOptions?this.textureAtlasOptions:{};t.sourcesHaveTransparency=!0;let i=this.pixelSize;const s=this.getTextureResolutionScale((0,ns.x_)());return s&&(i*=s),Ql(this.viewer,i,e,t)})).then((e=>{e?(this.textureAtlas=e,this.material.ambientTexture=e.texture,this.viewer.requestDraw()):$l.warn("Could not load texture atlas")})).catch((e=>{$l.error(e)}))}getNodePropertyKey(e,t,i){return e+"_"+t+"_"+i}getZOffsetKey(e,t){return e+"_"+t}getAtlasKey(e,t,i){return e+Dn.ID_SEPARATOR+t+Dn.ID_SEPARATOR+i}getAtlasBackgroundColor(e,t){return X.default.getManager().getColorString("GLYPH_"+e+"_"+t+"_BACKGROUND")}getAtlasTextureName(e,t,i){return this.textures[e]+ed[t]+this.getSystemStateSuffix()+".png"}getTextureResolutionScale(e){let t=null;if(!this.textureResolutionScales)return t;for(let i=0;i<this.textureResolutionScales.length&&(t=this.textureResolutionScales[i],!(t>=e));++i);return t}getSystemStateSuffix(){let e="";if(this.isDarkModeThemed&&(e+="_"+zl.GW.getCurrentTheme()),this.textureResolutionScales){const t=(0,ns.x_)(),i=this.getTextureResolutionScale(t);this.lastUsedDevicePixelRatio=t,e+="_"+i+"x"}return e}createAtlasItem(e,t,i){const s=new Zl;return s.id=this.getAtlasKey(e,t,i),s.imageName=this.getAtlasTextureName(e,t,i),s.backgroundColor=this.getAtlasBackgroundColor(t,i),s}}const nd="GLYPH";class rd extends yi.u1{constructor(e,t,i,s,n,r,a,o){super(e),this.glyphResources=t,this.textureId=i,this.glyphStateId=s,this.pixelSize=n,this.renderPriority=r,this.worldOrigin=a,this.parent=o}getModelSelection(e){return this.parent?this.parent.getModelSelection(e):null}addHighlight(e){super.addHighlight(e),this.resetGraphics()}removeHighlight(e){return!!super.removeHighlight(e)&&(this.resetGraphics(),!0)}onViewWillDraw(e){this.isHidden||this.hasBeenRemoved||(this.updateGraphics(),this.adjustTransform(e))}setWorldOrigin(e){ge.S4.distanceSquared(this.worldOrigin,e)>Ri.W.ZERO_LENGTH_SQUARED&&(this.worldOrigin=e,this.resetGraphics())}onDevicePixelRatioChanged(e){this.isHidden||this.resetGraphics()}get highlightStateId(){const e=this.getHighlight();return e&&e.type===Cn.o2.PRE?td.PRE_HIGHLIGHT:e?td.HIGHLIGHT:td.NO_HIGHLIGHT}resetGraphics(){this.removeMeshIncrements(),this.updateGraphics()}updateGraphics(){!this.hasMeshIncrements()&&this.glyphResources.atlasReady&&this.instantiateMeshIncrements()}}class ad extends rd{constructor(e,t,i,s,n,r,a,o,h,c){super(e,t,i,s,n,r,a,c),this.worldXAxis=o,this.worldYAxis=h}instantiateMeshIncrements(){const e=this.glyphResources.getTextureCoordsOffset(this.textureId,this.glyphStateId,this.highlightStateId,0);if(!e)return;const t="glyphQuad",i=[e.lowS,e.highT],s=[e?.highS,e?.lowT],n=(0,Yd.fQ)([-.5,0,-.5],[.5,0,-.5],[-.5,0,.5],t,i,s),r=this.glyphResources.getNodeProperties(this.highlightStateId,this.glyphStateId,this.renderPriority);this.updateMeshIncrement(t,nd,n,r)}adjustTransform(e){const t=e.getPixelSizeAtWorldPoint(this.worldOrigin)*this.pixelSize*(0,ns.x_)(),i=ge.S4.scale(this.worldYAxis,t,M.create()),s=ge.S4.scale(this.worldXAxis,t,M.create()),n=ge.S4.scale(ge.S4.normalize(ge.S4.cross(i,s,M.create())),t),r=ue.fromValues(s[0],s[1],s[2],0,n[0],n[1],n[2],0,i[0],i[1],i[2],0,this.worldOrigin[0],this.worldOrigin[1],this.worldOrigin[2],1);this.setTransform(r)}}class od extends rd{constructor(e,t,i,s,n,r,a,o,h){super(e,t,i,s,n,r,a,h),this.originInGlyph=o}instantiateMeshIncrements(){const e=this.glyphResources.getTextureCoordsOffset(this.textureId,this.glyphStateId,this.highlightStateId,0);if(!e)return;const t=[-this.originInGlyph[0],0,-this.originInGlyph[1]],i=[1-this.originInGlyph[0],0,-this.originInGlyph[1]],s=[-this.originInGlyph[0],0,1-this.originInGlyph[1]],n="quad",r=[e.lowS,e.highT],a=[e.highS,e.lowT],o=(0,Yd.fQ)(t,i,s,n,r,a);this.updateMeshIncrement(n,nd,o,this.glyphResources.getNodeProperties(this.highlightStateId,this.glyphStateId,this.renderPriority))}adjustTransformToAlignUp(e,t){const i=e.getPixelSizeAtWorldPoint(this.worldOrigin)*this.pixelSize*(0,ns.x_)(),s=ge.S4.scale(t,i,M.create()),n=ge.S4.scale(ge.S4.normalize(ge.S4.cross(e.getForward(),s,M.create())),i),r=ge.S4.scale(ge.S4.normalize(ge.S4.cross(s,n,M.create())),i),a=ue.fromValues(n[0],n[1],n[2],0,r[0],r[1],r[2],0,s[0],s[1],s[2],0,this.worldOrigin[0],this.worldOrigin[1],this.worldOrigin[2],1);this.setTransform(a)}adjustTransform(e){this.adjustTransformToAlignUp(e,e.getUp())}}class hd extends od{constructor(e,t,i,s,n,r,a,o,h,c){super(e,t,i,s,n,r,a,h,c),this.worldDirection=o}adjustTransform(e){this.adjustTransformToAlignUp(e,this.worldDirection)}}const cd={FASTENED:"mateindicators/MateIndicatorAssets_Fastened",REVOLUTE:"mateindicators/MateIndicatorAssets_Revolute",SLIDER_BASE:"mateindicators/MateIndicatorAssets_Ball",PLANAR_BASE:"mateindicators/MateIndicatorAssets_PlanarCenter",CYLINDRICAL_BASE:"mateindicators/MateIndicatorAssets_Revolute",PIN_SLOT_BASE:"mateindicators/MateIndicatorAssets_PinSlot",PARALLEL_BASE:"mateindicators/MateIndicatorAssets_Parallel",BALL:"mateindicators/MateIndicatorAssets_Ball",ARROW:"mateindicators/MateIndicatorAssets_DirectionArrow",GROUP:"mateindicators/MateIndicatorAssets_Group",TANGENT:"mateindicators/MateIndicatorAssets_Tangent",FIXED:"mateindicators/MateIndicatorAssets_Fixed",WIDTH:"mateindicators/MateIndicatorAssets_Width_Mate"},ld=X.default.getManager(),dd=ld.getNumber("UNSCALED_MATE_SCREEN_SIZE"),ud="MateIndicatorComponent";function gd(e){e.getResources().mateIndicatorGlyphResources||(e.getResources().mateIndicatorGlyphResources=new sd(QM.Bm,e,cd,dd*(0,ns.x_)()))}class pd extends yi.u1{constructor(e,t,i,s,n){super(s),this.mateConnectorDisplayData=e,this.type=t,this.definition=i,this.occurrenceTransforms=[],this.connectorCoordinateSystems=[],this.worldSpacePositions=[],this.worldSpacePosition=[0,0,0],this.lastScale=-1,this.positionComputed=!1,this.inHiddenMode=!1,gd(this.viewer),this.id=t,this.featureType=mi.T.MATE,this.mateType=n,this.listenTo(this,yi.zw.LONG_PRESS_START+ud,this.onLongPressStart),this.listenTo(this,yi.zw.LONG_PRESS_END+ud,this.onLongPressEnd),this.damageTransform(),this.occurrenceData.setCanIsolateChange(!0),this.occurrenceData.setIsolated(!1)}updateHiddenMode(e){return this.inHiddenMode!==e&&(this.inHiddenMode=e,!0)}updateHideState(){this.isHighlighted()||!this.definition.hidden&&!this.inHiddenMode?(this.hasMeshIncrements()||this.updateGraphics(!0),this.positionComputed||this.computePosition(),this.show()):this.hide()}onLongPressStart(){this.trigger(yi.zw.LONG_PRESS_START)}onLongPressEnd(){this.trigger(yi.zw.LONG_PRESS_END)}addHighlight(e){super.addHighlight(e),this.updateHideState(),this.updateGraphics()}removeHighlight(e){return!!super.removeHighlight(e)&&(this.updateHideState(),this.updateGraphics(),!0)}onViewWillDraw(e){this.isHidden||this.hasBeenRemoved||(this.viewer.getIsolatedOccurrenceManager()?.hasIsolatedInstances()&&this.updateGraphics(),this.adjustTransform(e))}updateIsolation(){let e=1;this.viewer.getIsolatedOccurrenceManager()?.hasIsolatedInstances()&&!this.occurrenceData.getIsolated()&&(e=ld.getNumber("ISOLATE_CONTEXT_UI_TRANSPARENCY")*$e()+(1-$e()));let t=this.getIncrement();t&&(t=(0,Yd.Ae)(t,e),this.updateMeshIncrement(this.type,ud,t,this.getNodeProperties()))}updateGraphics(e){if(!this.isValid())return;if(!this.definition||this.isHidden&&!e)return void this.removeMeshIncrements();if(!this.glyphResources.atlasReady)return;const t=this.getIncrement();t&&(this.updateMeshIncrement(this.type,ud,t,this.getNodeProperties()),this.updateIsolation())}getIncrement(){return null}get glyphResources(){return this.viewer.getResources().mateIndicatorGlyphResources}getNodeProperties(){return this.glyphResources.getNodeProperties(this.getHighlightStateId(),this.getMateStateId(),this.getRenderOrderPriority())}getRenderOrderPriority(){return Gi.DO.LOWER}getMateStateId(){return this.definition.status===k.EFx.ERROR?"ERROR":this.definition.status===k.EFx.SUPPRESSED?"SUPPRESSED":"NORMAL"}getHighlightStateId(){const e=this.getHighlight();return e&&e.type===Cn.o2.PRE?"PRE_HIGHLIGHT":e?"HIGHLIGHT":"NO_HIGHLIGHT"}getTextureId(){return this.type}isValid(){return!!this.worldSpacePosition}computePosition(){for(let e=0;e<this.mateConnectorDisplayData.length;e++)this.occurrenceTransforms[e]=this.viewer.getModelViewManagers().getManager().getOccurrenceTransform(this.mateConnectorDisplayData[e].occurrence),this.connectorCoordinateSystems[e]=this.mateConnectorDisplayData[e].location,this.worldSpacePositions[e]=ge.w$.multiplyVec3(this.occurrenceTransforms[e],this.connectorCoordinateSystems[e].origin.getVec3(),M.create());this.worldSpacePositions.length>0?this.worldSpacePosition=this.worldSpacePositions[0]:(this.worldSpacePosition=null,this.removeMeshIncrements()),this.positionComputed=!0}causePositionRecompute(){this.lastScale=-1,this.positionComputed=!1,this.isHidden||this.computePosition()}updateMateConnectorDisplayData(e){this.mateConnectorDisplayData=e,this.causePositionRecompute()}getDefinitionOccurrenceIds(){const e=[];for(let t=0;t<this.mateConnectorDisplayData.length;t++)e.push(this.mateConnectorDisplayData[t].occurrence.getPathAsString());return e}getRelatedOccurrences(){const e=[];for(let t=0;t<this.mateConnectorDisplayData.length;t++)e.push(this.mateConnectorDisplayData[t].occurrence);return e}getModelSelection(){if(this.viewer.getIsolatedOccurrenceManager()?.hasIsolatedInstances()&&!this.occurrenceData.getIsolated())return null;const e=this.getRelatedOccurrences(),t=[];for(let i=0;i<e.length;i++){const s=e[i],n=new Me.Y1(k.lQt.OCCURRENCE,s,s);t.push(n)}for(let e=0;e<this.mateConnectorDisplayData.length;e++){const i=this.mateConnectorDisplayData[e],s=new Me.Y1(k.lQt.MATE_CONNECTOR,i.nodeId,i.ownerOccurrence,{isDerivedFeature:i.isDerivedFeature});t.push(s)}return new Me.Y1(k.lQt.MATE,this.definition.nodeId,this.definition.ownerOccurrence,{featureType:this.featureType,mateType:this.mateType,childSelections:t,isDerivedFeature:this.definition.isDerivedFeature})}adjustTransform(e){if(this.positionComputed||this.computePosition(),!this.isValid())return;const t=e.getPixelSizeAtWorldPoint(this.worldSpacePosition)*(0,ns.x_)();if(Math.abs(this.lastScale-t)<Ri.W.ZERO_LENGTH&&this.hasMeshIncrements())return;this.lastScale=t;const i=ue.create();i[0]=t,i[5]=t,i[10]=t,this.setTransform(ge.w$.rotateX(ge.w$.multiply(ge.w$.multiply(this.occurrenceTransforms[0],this.connectorCoordinateSystems[0].getGlMatrix(),ue.create()),i),-Math.PI/2)),this.hasMeshIncrements()||this.updateGraphics()}damageTransform(){this.lastScale=-1,this.connectorCoordinateSystems[0]&&ge.w$.multiplyVec3(this.occurrenceTransforms[0],this.connectorCoordinateSystems[0].origin.getVec3(),this.worldSpacePosition),(0,Xs.vm)()}}class md extends pd{constructor(e,t,i,s,n){super(e,t,i,s,n)}getIncrement(){const e=this.glyphResources.getTextureCoordsOffset(this.getTextureId(),this.getMateStateId(),this.getHighlightStateId(),.5);return(0,Yd.fQ)([-dd/2,0,-dd/2],[dd/2,0,-dd/2],[-dd/2,0,dd/2],void 0,[e.lowS,e.highT],[e.highS,e.lowT])}}class fd extends pd{constructor(e,t,i,s,n,r){super(e,"ARROW",t,n,r),this.rotationAngle=i,this.rotationAxis=s}getIncrement(){const e=this.glyphResources.getTextureCoordsOffset(this.getTextureId(),this.getMateStateId(),this.getHighlightStateId(),1);return(0,Yd.fQ)([0,0,-dd/4],[dd,0,-dd/4],[0,0,dd/4],void 0,[e.lowS,e.highT],[e.highS,e.lowT])}adjustTransform(e){if(this.positionComputed||this.computePosition(),!this.isValid())return;const t=e.getPixelSizeAtWorldPoint(this.worldSpacePosition)*(0,ns.x_)();if(Math.abs(this.lastScale-t)<Ri.W.ZERO_LENGTH&&this.hasMeshIncrements())return;this.lastScale=t;const i=ue.create();i[0]=t,i[5]=t,i[10]=t;const s=ge.w$.multiply(ge.w$.multiply(this.occurrenceTransforms[0],this.connectorCoordinateSystems[0].getGlMatrix(),ue.create()),i),n=ge.w$.rotate(s,this.rotationAngle,this.rotationAxis);this.setTransform(n),this.hasMeshIncrements()||this.updateGraphics()}getHighlightStateId(){return"NO_HIGHLIGHT"}getRenderOrderPriority(){return Gi.DO.DEFAULT}}class Id extends md{constructor(e,t,i){super([],"GROUP",t,i),this.occurrenceDisplayData=e,this.featureType=mi.T.MATE_GROUP}getDefinitionOccurrenceIds(){return this.definition.getOccurrenceIds()}getRelatedOccurrences(){const e=[];for(let t=0;t<this.occurrenceDisplayData.length;t++)e.push(this.occurrenceDisplayData[t].occurrenceData.occurrence);return e}computePosition(){if(!this.occurrenceDisplayData)return;let e=null;const t=this.viewer.getModelViewManagers().getManager();for(let i=0;i<this.occurrenceDisplayData.length;i++){const s=this.occurrenceDisplayData[i].occurrenceData.occurrence;this.occurrenceTransforms[i]=t.getOccurrenceTransform(s),this.connectorCoordinateSystems[i]=k.em5.createValidDefault(),this.worldSpacePositions[i]=ge.w$.multiplyVec3(this.occurrenceTransforms[i],this.connectorCoordinateSystems[i].origin.getVec3(),M.create());const n=t.getOccurrenceBounds(s);n&&n.isFinite()&&(e||(e=new wi.kB),e.addBox(n))}if(this.worldSpacePositions.length>0&&e){const t=e.center();this.connectorCoordinateSystems[0].origin.updateFromArray(ge.S4.subtract(t,this.worldSpacePositions[0])),this.worldSpacePosition=t}else this.worldSpacePosition=null,this.removeMeshIncrements();this.positionComputed=!0}updateOccurenceDisplayData(e){this.occurrenceDisplayData=e,this.causePositionRecompute()}}class Ed extends md{constructor(e,t,i){super([],t,e,i),this.featureType=mi.T.GEOMETRY_MATE}computePosition(){const e=this.definition;e&&e.location?this.worldSpacePosition=e.location.origin.getVec3():(this.worldSpacePosition=null,this.removeMeshIncrements()),this.positionComputed=!0}updateDefinition(e){this.definition=e,this.causePositionRecompute()}getDefinitionOccurrenceIds(){const e=this.getRelatedOccurrences(),t=[];return e.forEach((function(e){t.push(e.getPathAsString())})),t}getRelatedOccurrences(){const e=[],t=this.definition;return t&&(t.firstOccurrence&&e.push(t.firstOccurrence),t.secondOccurrence&&e.push(t.secondOccurrence)),e}adjustTransform(e){if(this.positionComputed||this.computePosition(),!this.isValid())return;const t=e.getPixelSizeAtWorldPoint(this.worldSpacePosition)*(0,ns.x_)();if(Math.abs(this.lastScale-t)<Ri.W.ZERO_LENGTH&&this.hasMeshIncrements())return;this.lastScale=t;const i=ue.create();i[0]=t,i[5]=t,i[10]=t;const s=this.definition;this.setTransform(ge.w$.rotateX(ge.w$.multiply(s.location.getGlMatrix(),i),-Math.PI/2)),this.hasMeshIncrements()||this.updateGraphics()}}class Sd extends md{constructor(e,t,i){super([],"FIXED",new k.iYR(!0),i),this.occurrenceDisplayData=[],this.connectorCoordinateSystems[0]=k.em5.createValidDefault();const s=this.viewer.retrieveCanvasLocationWorldPosition(t);if(s)this.worldSpacePosition=s,this.connectorCoordinateSystems[0].origin.updateFromArray(s);else{const t=this.viewer.getModelViewManagers().getManager().getOccurrenceBounds(e);if(t&&t.isFinite()){const e=new wi.kB;e.addBox(t);const i=e.center();this.worldSpacePosition=i,this.connectorCoordinateSystems[0].origin.updateFromArray(i)}}this.occurrenceTransforms[0]=ue.create()}computePosition(){this.positionComputed=!0}}class Td extends md{constructor(e,t,i,s){super(e,i,t,s),this.featureType=mi.T.WIDTH_MATE}computePosition(){const e=this.definition;e&&e.location&&this.mateConnectorDisplayData?.length>0?this.worldSpacePosition=e.location.origin.getVec3():(this.worldSpacePosition=null,this.removeMeshIncrements()),this.positionComputed=!0}updateDefinition(e){this.definition=e,this.causePositionRecompute()}adjustTransform(e){if(this.positionComputed||this.computePosition(),!this.isValid())return;const t=e.getPixelSizeAtWorldPoint(this.worldSpacePosition)*(0,ns.x_)();if(Math.abs(this.lastScale-t)<Ri.W.ZERO_LENGTH&&this.hasMeshIncrements())return;this.lastScale=t;const i=ue.create();i[0]=t,i[5]=t,i[10]=t;const s=this.definition;this.setTransform(ge.w$.rotateX(ge.w$.multiply(s.location.getGlMatrix(),i),-Math.PI/2)),this.hasMeshIncrements()||this.updateGraphics()}}const Dd=new Gi.hF({primitiveType:Ai.MX.POINTS,isPickable:!1,isShowThrough:!0,isDepthTested:!1});class Cd extends yi.u1{constructor(e,t,i,s,n,r){super(n,t),this.position=e,this.increment=(0,Yd.Pu)([0,0,0],"point",i,s),this.updatePosition(e),this.nodeProperties=Dd,r&&(this.nodeProperties=r),this.updateGraphics()}updatePosition(e){if(e){this.position=e;const t=ue.create();t[12]=this.position[0],t[13]=this.position[1],t[14]=this.position[2],this.setTransform(t)}}setStyle(e){(0,Yd.KZ)(e,this.increment),this.updateGraphics()}updateGraphics(){this.updateMeshIncrement(Cd.INCREMENT_ID,"pointElementSelection",this.increment,this.nodeProperties)}addHighlight(e){super.addHighlight(e),this.addHighlightToIncrement("pointElement",e),this.highlight=e}removeHighlight(e){return!!e&&(this.removeHighlightFromIncrement("pointElement",e),!!super.removeHighlight(e))}}Cd.INCREMENT_ID="pointElement";const Md=_e.O.createLogger("AnnotationComponent",k.bVy.MODEL_BASED_DESIGN),yd=X.default.getManager(),Ad=[];let Pd=0;var Od;!function(e){e[e.NONE=0]="NONE",e[e.SELECTED=1]="SELECTED",e[e.HOVERED=2]="HOVERED"}(Od||(Od={}));class Rd{constructor(e,t,i,s){this.usage=e,this.elementId=t,this.viewer=i,this.cloneSource=s,this.annotationIdToUIElementMap={},this.activeAnnotationId="",this.isAnnotationPaneOpen=!1,this.persistentAnnotationIds=[],this.partIdForPersistentAnnotations=null,s&&(this.activeAnnotationId=s?.getActiveAnnotationId()),this.updateTextureAtlas(this.viewer,this.onTextureAtlasChanged.bind(this))}reset(){for(const e in this.annotationIdToUIElementMap)if(e&&e.length>0){this.annotationIdToUIElementMap[e].remove()}this.annotationIdToUIElementMap={}}processDisplayData(e){if(this.usage===ys.L.PREVIEW)return;e.incremental||this.reset();const t=e.annotationsForElement;if(!t)return;const i=t.annotationIdToDisplayObject;if(i){for(const e in i)if(e&&e.length>0){let t;const s=i[e],n=this.annotationIdToUIElementMap[e];if(n&&(n.remove(),delete this.annotationIdToUIElementMap[e]),s.getIsDeletion())continue;const r=es.Jq.CapabilitiesService.checkMbdHoleCalloutsCurrentlyEnabled();switch(s.getAnnotationType()){case k.pLb.DATUM:t=new Vd(e,s,this.viewer,this),this.annotationIdToUIElementMap[e]=t;break;case k.pLb.GTOL:t=new Ud(e,s,this.viewer,this),this.annotationIdToUIElementMap[e]=t;break;case k.pLb.WELD:t=new Gd(e,s,this.viewer,this),this.annotationIdToUIElementMap[e]=t;break;case k.pLb.HOLE_CALLOUT:r&&s instanceof k.$hG&&(t=new Hd(e,s,this.viewer,this),this.annotationIdToUIElementMap[e]=t,this.partIdForPersistentAnnotations&&t.isAssociatedWithPart(this.partIdForPersistentAnnotations)&&this.persistentAnnotationIds.push(t.annotationId))}t&&t.processDisplayData()}this.updateAnnotationsVisibility(),this.viewer.requestDraw()}}hide(){this.annotationIdToUIElementMap&&Object.entries(this.annotationIdToUIElementMap).forEach((([e,t])=>{t.hide()}))}getIsAnnotationPaneOpen(){return this.isAnnotationPaneOpen}onAnnotationPaneOpenClosed(e){this.isAnnotationPaneOpen=e,this.updateAnnotationsVisibility()}getActiveAnnotationId(){return this.activeAnnotationId}clearActiveAnnotation(){this.activeAnnotationId=""}onActiveAnnotationChanged(e){this.activeAnnotationId=e,this.updateAnnotationsVisibility()}setPersistentAnnotations(e,t){this.persistentAnnotationIds=e,this.partIdForPersistentAnnotations=t,Object.entries(this.annotationIdToUIElementMap).forEach((([i,s])=>{s?.isAssociatedWithPart(t)&&e.push(i)})),this.updateAnnotationsVisibility()}getUiElementForSelection(e){if(this.annotationIdToUIElementMap){const t=e.selectionId;return this.annotationIdToUIElementMap[t]}return null}updateAnnotationsVisibility(){this.annotationIdToUIElementMap&&Object.entries(this.annotationIdToUIElementMap).forEach((([e,t])=>{this.isAnnotationPaneOpen&&this.persistentAnnotationIds.includes(e)||e===this.activeAnnotationId?t.show():t.hide()}))}isPersistent(e){return this.isAnnotationPaneOpen&&this.persistentAnnotationIds.includes(e)}isAnnotationActive(e){return this.activeAnnotationId===e}onTextureAtlasChanged(){this.viewer.requestDraw()}updateTextureAtlas(e,t){if(!es.Jq.CapabilitiesService.checkMBDCurrentlyEnabled())return;if(null==e.getResources().mbdAtlas&&Ad.push(t),e.getResources().mbdAtlasCreationInitiated)return;e.getResources().mbdAtlasCreationInitiated=!0;const i=Pd++;e.getResources().mbdAtlasCreationId=i;e.getTextureAtlasFactory().getAtlas(QM.di,this.createTextureAtlas.bind(this,e)).then((t=>{i===e.getResources().mbdAtlasCreationId&&(t?(e.getResources().mbdAtlas=t,e.getResources().mbdAtlasMaterial.ambientTexture=t.texture,Ad.forEach((e=>e())),Ad.length=0):Md.warn("Could not load the MBD annotation texture atlas"))}),(e=>Md.error(e)))}appendImagesPerIcon(e,t,i){const s=i.length;i.push(this.createImageData(Od.NONE,e,t,s)),i.push(this.createImageData(Od.SELECTED,e,t,s+1)),i.push(this.createImageData(Od.HOVERED,e,t,s+2))}createImageData(e,t,i,s){const n=new Zl;n.svgToStyle=i,n.index=s;let r=t,a=yd.getColorString("ANNOTATION_DEFAULT_BACKGROUND_COLOR");const o=Bd.getHighlightBackgroundOpacity();if(e===Od.SELECTED){r=Bd.getIconSelectedName(t);const e=yd.getColor("ANNOTATION_SELECTED_BACKGROUND_COLOR");a=`rgba(${255*e[0]}, ${255*e[1]}, ${255*e[2]}, ${o})`}else if(e===Od.HOVERED){r=Bd.getIconHoveredName(t);const e=yd.getColor("ANNOTATION_HOVERED_BACKGROUND_COLOR");a=`rgba(${255*e[0]}, ${255*e[1]}, ${255*e[2]}, ${o})`}return n.id=r,n.backgroundColor=a,n}createTextureAtlas(e){const t=[];return this.appendImagesPerIcon("TRUE_POSITION","mbd/position.svg",t),this.appendImagesPerIcon("PARALLELISM","mbd/parallelism.svg",t),this.appendImagesPerIcon("PERPENDICULARITY","mbd/perpendicularity.svg",t),this.appendImagesPerIcon("PROFILE_SURFACE","mbd/profileSurface.svg",t),this.appendImagesPerIcon("TOTAL_RUNOUT","mbd/totalRunout.svg",t),this.appendImagesPerIcon("FILLET_JOINT","mbd/fillet.svg",t),this.appendImagesPerIcon("SQUARE_GROOVE","mbd/squareGroove.svg",t),this.appendImagesPerIcon("BEVEL_FLARE_GROOVE","mbd/bevelFlareGroove.svg",t),this.appendImagesPerIcon("V_GROOVE","mbd/vGroove.svg",t),this.appendImagesPerIcon("BEVEL_GROOVE","mbd/bevelGroove.svg",t),this.appendImagesPerIcon("ALL_AROUND","mbd/allAround.svg",t),this.appendImagesPerIcon("FLAG_SYMBOL","mbd/flagSymbol.svg",t),this.appendImagesPerIcon("FLAT","mbd/flatContour.svg",t),this.appendImagesPerIcon("CONVEX","mbd/convexContour.svg",t),this.appendImagesPerIcon("CONCAVE","mbd/concaveContour.svg",t),this.appendImagesPerIcon("CHIPPING","mbd/chipping.svg",t),this.appendImagesPerIcon("GRINDING","mbd/grinding.svg",t),this.appendImagesPerIcon("HAMMERING","mbd/hammering.svg",t),this.appendImagesPerIcon("MACHINING","mbd/machining.svg",t),this.appendImagesPerIcon("ROLLING","mbd/rolling.svg",t),this.appendImagesPerIcon("UNSPECIFIED","mbd/unspecified.svg",t),Ql(e,yd.getNumber("ANNOTATION_ICON_SIZE_PIXELS"),t,{sourcesHaveTransparency:!0})}}var wd=i(71615);const vd=_e.O.createLogger("AnnotationDisplay",k.bVy.MODEL_BASED_DESIGN),_d=X.default.getManager(),Nd=new Gi.hF({isPickable:!0,isTwoSided:!0,primitiveType:Ai.MX.LINES,isShowThrough:!1,isDepthTested:!0,priority:Gi.DO.DEFAULT,isStencilTested:!1}),bd=new Gi.hF({isPickable:!1,isTwoSided:!0,primitiveType:Ai.MX.LINES,isShowThrough:!0,isDepthTested:!1,priority:Gi.DO.LOWER,isStencilTested:!0}),Ld=new Gi.hF({isPickable:!0,isTwoSided:!0,material:Vi,primitiveType:Ai.MX.TRIANGLES,isShowThrough:!1,isDepthTested:!0,priority:Gi.DO.DEFAULT,isStencilWritten:!0}),Fd=new Gi.hF({isPickable:!1,isTwoSided:!0,material:Vi,primitiveType:Ai.MX.TRIANGLES,isShowThrough:!0,isDepthTested:!1,priority:Gi.DO.LOWER,isStencilTested:!0});class xd{constructor(){this.isAngle=!1,this.precision=k.d_N.DEFAULT,this.withZeros=!1,this.signOption=xd.NATURAL_SIGN}}xd.POSITIVE_ZERO=0,xd.NEGATIVE_ZERO=1,xd.NATURAL_SIGN=2;class Bd extends yi.u1{constructor(e,t,i,s){super(i),this.annotationId=e,this.annotationDisplayData=t,this.viewer=i,this.parent=s,this.baseDisplay=null,this.leaderDisplay=null,this.detailDisplay=null,this.planeCoordinateSystem=null,this.baseCoordinateSystem=null,this.isDragging=!1,this.isDraggingBase=!1,this.defaultColor=[],this.hoverColor=[],this.isPaneOpen=!1,this.isFilteredOut=null,this.lineWidth=0,this.lineStyle=[],this.font="",this.fontSize=1,this.backgroundPadding=1,this.iconSize=1,this.sideEdgeLength=0,this.dragDistance=.025,this.nextStartPoint=null,this.startDirection=null,this.newEndPoint=null,this.oldEndPoint=null,this.draggingLeaderPoints=[],this.originalDelta=null,this.lastPlaneIntersection=null,this.dragMeshIncrement=null,this.deterministicId="",this.startDetailFromFarSide=!1,this.extendedLeaderStartPoint=null,this.planeCoordinateSystem=t.annotationPlane,this.baseCoordinateSystem=t.basePlane,this.nextStartPoint=this.planeCoordinateSystem.origin.getVec3(),this.startDirection=this.planeCoordinateSystem.yAxis.getVec3(),this.lineWidth=_d.getNumber("ANNOTATION_LINE_WIDTH"),this.lineStyle=_d.getStipple("DEFAULT_LINE_STIPPLE"),this.font=_d.getString("DIMENSION_VALUE_FONT"),this.fontSize=_d.getNumber("DIMENSION_VALUE_HEIGHT_PIXELS"),this.backgroundPadding=_d.getNumber("DIMENSION_VALUE_BACKGROUND_PADDING"),this.iconSize=_d.getNumber("ANNOTATION_ICON_SIZE_PIXELS"),this.lastPlaneIntersection=M.create(),this.listenTo(this,yi.zw.MOUSE_ENTER+qd.YQ,this.onMouseEnter),this.listenTo(this,yi.zw.MOUSE_LEAVE+qd.YQ,this.onMouseLeave),this.listenTo(this,yi.zw.DRAG_START+qd.YQ,this.onDragStartBase),this.listenTo(this,yi.zw.DRAG+qd.YQ,this.onDragBase),this.listenTo(this,yi.zw.DRAG_STOP+qd.YQ,this.onDragStopBase),this.listenTo(this,yi.zw.MOUSE_ENTER+qd.Lc,this.onMouseEnter),this.listenTo(this,yi.zw.MOUSE_LEAVE+qd.Lc,this.onMouseLeave)}getPickPriority(e){return e.selectionId===qd.Lc?gI.z.ANNOTATION_LOW:gI.z.ANNOTATION_HIGH}updateView(e,t){}onViewWillDraw(e,t){if(this.isPaneOpen=this.isAnnotationPaneOpenForParent(),this.isPaneOpen){const i=this.isFilteredOutByOrientation(e),s=this.isFilteredOutByType(),n=this.isFilteredOutByPersistence(),r=i||s||n,a=this.isAnnotationActiveOrHighlighted();this.setFilteredOut(r&&!a),this.isVisibleToUser()&&!this.isFilteredOut?this.updateView(e,t):this.hide()}}isAnnotationPaneOpenForParent(){const e=this.viewer.getModelViewManagers().getManager();if(e){const t=e.getDisplayedPartStudio()?.getAnnotationComponent();if(t&&t===this.parent)return t.getIsAnnotationPaneOpen()}return!1}isFilteredOutByOrientation(e){if(!(1===_d.getNumber("ANNOTATION_FILTER_OUT_BY_ORIENTATION")))return!1;const t=this.getCurrentAxisUp(e);return!(this.getAnnotationAxisUp()===t)}isFilteredOutByType(){return this.annotationDisplayData.getAnnotationType()===k.pLb.DATUM?1===_d.getNumber("ANNOTATION_FILTER_OUT_DATUMS"):this.annotationDisplayData.getAnnotationType()===k.pLb.GTOL&&1===_d.getNumber("ANNOTATION_FILTER_OUT_GTOLS")}isFilteredOutByPersistence(){const e=this.viewer.getModelViewManagers().getManager();if(e){const t=e.getDisplayedPartStudio()?.getAnnotationComponent();if(t)return!t.isPersistent(this.annotationId)}return!1}isAnnotationActiveOrHighlighted(){const e=this.viewer.getModelViewManagers().getManager();if(e){const t=e.getDisplayedPartStudio()?.getAnnotationComponent();if(t)return t.isAnnotationActive(this.annotationId)||this.isHighlighted()}return!1}isAssociatedWithPart(e){return!1}isAnnotation(){return!0}getAnnotationDisplayData(){return this.annotationDisplayData}getPlaneCoordinateSystem(){return this.planeCoordinateSystem}getBaseCoordinateSystem(){return this.baseCoordinateSystem}setNextStartPoint(e){this.nextStartPoint=e}getNextStartPoint(){return this.nextStartPoint}setExtendedLeaderStartPoint(e){this.extendedLeaderStartPoint=e}getExtendedLeaderStartPoint(){return this.extendedLeaderStartPoint}setLeaderStartDirection(e){this.startDirection=e}getLeaderStartDirection(){return this.startDirection}getSideEdgeLength(e){return this.sideEdgeLength=_d.getNumber("ANNOTATION_BASE_SIDE_LENGTH_PX")*e,this.sideEdgeLength}getPixelSizeAtWorldPoint(e,t){return t.getPixelSizeAtWorldPoint(e)}static getFormattedValueString(e,t,i){let s=i?.isAngle?t.getAngleUnitsDisplayPrecision():t.getLengthUnitsDisplayPrecision();i&&i.precision!==k.d_N.DEFAULT&&(s=pA.Ro.getPrecisionDigitCount(i.precision));const n=(0,Ir.KZ)(Math.abs(e),i?.isAngle?t.getAngleUnits():t.getLengthUnits()),r=(0,Er.roundTo)(n,s);let a=""+r;i?.withZeros&&(a=r.toFixed(s));const o=i?.isAngle?(0,pA.$D)(t.getAngleUnits()):"",h=Sc.c.convertToCommaFormatIfNeeded(a)+o;return i?.signOption===xd.POSITIVE_ZERO?e>=0?"+"+h:"−"+h:i?.signOption===xd.NEGATIVE_ZERO?e<=0?"−"+h:"+"+h:e<0?"−"+h:h}setFilteredOut(e){this.isFilteredOut!==e&&(this.isFilteredOut=e,this.isFilteredOut?this.hide():this.isPaneOpen&&this.show())}getFilteredOut(){return this.isFilteredOut}getColor(){const e=this.getHighlight();return e?.type===Cn.o2.UI||e?.type===Cn.o2.SECONDARY?_d.getColor("ANNOTATION_SELECTED_COLOR"):e?.type===Cn.o2.PRE?_d.getColor("ANNOTATION_HOVERED_COLOR"):_d.getColor("ANNOTATION_DEFAULT_COLOR")}getDefaultValueColor(){return _d.getColor("ANNOTATION_DEFAULT_VALUE_COLOR")}getLineWidth(){return this.lineWidth}getLineStyle(){return this.lineStyle}getFont(){return this.font}getFontSize(){return this.fontSize}getBackgroundPadding(){return this.backgroundPadding}getBackgroundColor(){return _d.getNumberArray("ANNOTATION_BACKGROUND_COLOR")}getHoveredBackgroundColor(){return _d.getColor("ANNOTATION_HOVERED_BACKGROUND_COLOR")}getSelectedBackgroundColor(){return _d.getColor("ANNOTATION_SELECTED_BACKGROUND_COLOR")}static getHighlightBackgroundOpacity(){return _d.getNumber("DIMENSION_VALUE_BACKGROUND_OPACITY")}static getIconSelectedName(e){return e+"_selected"}static getIconHoveredName(e){return e+"_hovered"}getIconSize(){return this.iconSize}remove(){super.remove(),this.detailDisplay?.destroy()}getReferencedEntityIds(){return[]}getVisualVector(e){const t=this.planeCoordinateSystem.origin.getVec3(),i=M.transformMat4(M.create(),e,this.planeCoordinateSystem.getGlMatrix());return M.subtract(i,i,t),M.normalize(i,i)}getVisualUpVector(){return this.getVisualVector([0,1,0])}getVisualRightVector(){return this.getVisualVector([1,0,0])}getFlips(e){return zo(e,this.getVisualRightVector(),this.getVisualUpVector(),this.transform)}getCurrentAxisUp(e){const t=this.annotationDisplayData.annotationPlane.origin.getVec3(),i=M.fromValues(1,0,0),s=M.fromValues(0,1,0),n=M.fromValues(0,0,1),r=M.add(M.create(),t,i),a=M.add(M.create(),t,s),o=M.add(M.create(),t,n),h=e.projectWorldPointToCanvas(t),c=e.projectWorldPointToCanvas(r),l=e.projectWorldPointToCanvas(a),d=e.projectWorldPointToCanvas(o),u=Math.abs(c[1]-h[1]),g=Math.abs(l[1]-h[1]),p=Math.abs(d[1]-h[1]);let m=!1,f=!1,I=!1;return u>g&&u>p?m=!0:g>u&&g>p?f=!0:p>u&&p>g&&(I=!0),m?wd.H.Right:f?wd.H.Front:wd.H.Top}getAnnotationAxisUp(){const e=this.annotationDisplayData.annotationPlane.yAxis.getVec3(),t=M.fromValues(0,0,1),i=M.fromValues(0,1,0),s=M.fromValues(1,0,0),n=Math.abs(M.dot(e,t)),r=Math.abs(M.dot(e,i)),a=Math.abs(M.dot(e,s)),o=Math.abs(n-1),h=Math.abs(r-1),c=Math.abs(a-1);return o<h&&o<c?wd.H.Top:h<o&&h<c?wd.H.Front:wd.H.Right}getAnnotationPlaneMatrix(){return this.planeCoordinateSystem.getGlMatrix()}getSubjectPlaneMatrix(){return this.baseCoordinateSystem.getGlMatrix()}getDragIntersectionPointWithAnnotationPlane(e){const t=e.camera.getRay(e.mouseX,e.mouseY);return(0,wi.bZ)(t,this.getAnnotationPlaneMatrix())}getDragIntersectionPointWithSubjectPlane(e){const t=e.camera.getRay(e.mouseX,e.mouseY);return(0,wi.bZ)(t,this.getSubjectPlaneMatrix())}intersectRayWithSubjectAxis(e){const t=M.copy(M.create(),this.planeCoordinateSystem.origin.getVec3()),i=M.copy(M.create(),this.baseCoordinateSystem.zAxis.getVec3()),s=new wi.zH(t,i),n=s.findPositionOfPoint(e);return s.evaluate(n)}onMouseEnterBase(e,t){this.viewer.requestDraw()}onMouseLeaveBase(e,t){this.viewer.requestDraw()}onDragStartBase(e,t,i){if(!es.Jq.AnnotationService.canEditAnnotation(this.annotationId))return;const s=this.getDragIntersectionPointWithSubjectPlane(t);if(!s)return;const n=this.deterministicId;this.dragMeshIncrement=this.viewer.getModelViewManagers().getManager().extractMeshIncrement(n),this.dragMeshIncrement||vd.debug("Could not find mesh increment for face "+n),this.originalDelta=M.subtract(M.create(),s,this.annotationDisplayData.annotationPlane.origin.getVec3()),i.requestDrag=!0,this.isDraggingBase=!0}onDragBase(e,t){const i=this.getDragIntersectionPointWithSubjectPlane(t);if(!i)return;if(0===(0,wi.E7)(t.camera.getRay(t.mouseX,t.mouseY),this.dragMeshIncrement).length)return;this.lastPlaneIntersection=M.copy(M.create(),i);const s=M.subtract(M.create(),i,this.originalDelta);this.annotationDisplayData.annotationPlane.origin=k.d0F.fromArray(s),this.planeCoordinateSystem.origin.updateFromArray(this.annotationDisplayData.annotationPlane.origin.getVec3()),this.viewer.requestDraw()}onDragStopBase(e,t){this.lastPlaneIntersection=M.subtract(M.create(),this.lastPlaneIntersection,this.originalDelta),this.planeCoordinateSystem.origin.updateFromArray(this.lastPlaneIntersection),this.viewer.getEventDispatcher().trigger(nM.og,this.annotationId,this.deterministicId,this.lastPlaneIntersection),this.isDraggingBase=!1}addHighlight(e){super.addHighlight(e),this.updateHideState(),this.viewer.requestDraw()}removeHighlight(e){return!!e&&(!!super.removeHighlight(e)&&(this.viewer.requestDraw(),this.updateHideState(),!0))}hide(){this.isHighlighted()||(super.hide(),this.isDragging=!1)}getModelSelection(e){return(0,Me.zZ)(this.annotationId)}updateHideState(){!this.isVisibleToUser()&&this.isHighlighted()?this.show():this.isFilteredOut&&this.hide()}onMouseEnter(e,t){this.viewer.requestDraw()}onMouseLeave(e,t){this.viewer.requestDraw()}getCurrentSidePoint(){const e=this.detailDisplay.getSidePoints();if(!e||0===e.length)return this.nextStartPoint;return e[this.findSideForLeader(e)]}onDragStartAnnotationDetail(e,t,i){if(!es.Jq.AnnotationService.canEditAnnotation(this.annotationId))return;this.isDragging=!0;const s=this.getDragIntersectionPointWithAnnotationPlane(t);if(!s)return;const n=this.getCurrentSidePoint();this.originalDelta=M.subtract(M.create(),s,n),this.newEndPoint=s,i.requestDrag=!0}onDragAnnotationDetail(e,t){const i=this.getDragIntersectionPointWithAnnotationPlane(t);if(!i)return;const s=this.getCurrentSidePoint();this.oldEndPoint=M.copy(M.create(),s),this.newEndPoint=M.subtract(M.create(),i,this.originalDelta);const n=M.subtract(M.create(),this.newEndPoint,this.oldEndPoint),r=this.detailDisplay.getSidePoints();if(r.length>1){r[0]=M.add(M.create(),r[0],n),r[1]=M.add(M.create(),r[1],n);const e=this.findSideForLeader(r);this.adjustLeaderToSide(e,r,!0,this.getPixelSizeAtWorldPoint(r[0],t.camera))}}onDragStopAnnotationDetail(e,t){const i=this.detailDisplay.getSidePoints();if(i.length>0){const e=this.findSideForLeader(i);this.adjustLeaderToSide(e,i,!1,this.getPixelSizeAtWorldPoint(i[0],t.camera))}this.isDragging=!1}findSideForLeader(e){if(2!==e.length)return 0;const t=this.planeCoordinateSystem.origin.getVec3();return M.squaredDistance(e[0],t)>M.squaredDistance(e[1],t)?1:0}adjustLeaderToSide(e,t,i,s){const n=t[e],r=this.planeCoordinateSystem.origin.getVec3(),a=this.planeCoordinateSystem.xAxis.getVec3(),o=this.planeCoordinateSystem.yAxis.getVec3();M.normalize(a,a),M.normalize(o,o);const h=t[1-e],c=M.subtract(M.create(),n,h);M.normalize(c,c);const l=this.getSideEdgeLength(s),d=M.add(M.create(),n,M.scale(M.create(),c,l)),u=[];if(u.push(r),u.push(d),u.push(n),i){this.draggingLeaderPoints=[],this.draggingLeaderPoints.push(M.copy(M.create(),d)),this.draggingLeaderPoints.push(M.copy(M.create(),n));const e=M.subtract(M.create(),n,d);return void(this.startDetailFromFarSide=M.dot(a,e)<0)}const g=[],p=this.annotationId;this.annotationDisplayData.dxdySegments=[];for(let e=0;e<2;e++){const t=u[e],i=u[e+1],s=M.subtract(M.create(),i,t);1===e&&(this.startDetailFromFarSide=M.dot(a,s)<0);const n=M.dot(s,a),r=M.dot(s,o),h=Q.fromValues(n,r);g.push(h);const c=new k.YFv;c.x=n,c.y=r,this.annotationDisplayData.dxdySegments.push(c)}this.viewer.getEventDispatcher().trigger(nM.nu,p,g),this.viewer.requestDraw()}renderLines(e,t,i,s,n){const r=i.clone();(0,Yd.Ab)(this.applyAngleFadeToColor(s,n),r),this.updateMeshIncrement("dt."+e,t,r,Nd);const a=i.clone();(0,Yd.KZ)(_d.getStipple("DIMENSION_INACTIVE_OCCLUDED_WITNESS_STIPPLE"),a),(0,Yd.Ab)(this.applyAngleFadeToColor(_d.getColor("DIMENSION_INACTIVE_OCCLUDED_COLOR"),n),a),this.updateMeshIncrement("st."+e,t,a,bd)}renderFilledTriangle(e,t,i,s,n){const r=i.clone();(0,Yd.Ab)(this.applyAngleFadeToColor(s,n),r),this.updateMeshIncrement("dt."+e,t,i,Ld);const a=i.clone();(0,Yd.Ab)(this.applyAngleFadeToColor(_d.getColor("DIMENSION_INACTIVE_OCCLUDED_COLOR"),n),a),this.updateMeshIncrement("st."+e,t,a,Fd)}applyAngleFadeToColor(e,t){if(e.length>3&&this.annotationDisplayData?.annotationPlane){const i=pA.Ro.getAlphaScaling(t.getDirection(),this.annotationDisplayData.annotationPlane.zAxis.getVec3());return[e[0],e[1],e[2],e[3]*i]}return e}}class Vd extends Bd{constructor(e,t,i,s){super(e,t,i,s),this.listenTo(this,yi.zw.DOUBLE_CLICK+qd.YQ,this.onEditAnnotation),this.listenTo(this,yi.zw.DOUBLE_CLICK+qd.Lc,this.onEditAnnotation),this.listenTo(this,yi.zw.DOUBLE_CLICK+qd.JT,this.onEditAnnotation),this.listenTo(this,yi.zw.MOUSE_ENTER+qd.JT,this.onMouseEnter),this.listenTo(this,yi.zw.MOUSE_LEAVE+qd.JT,this.onMouseLeave),this.listenTo(this,yi.zw.DRAG_START+qd.JT,this.onDragStartAnnotationDetail),this.listenTo(this,yi.zw.DRAG+qd.JT,this.onDragAnnotationDetail),this.listenTo(this,yi.zw.DRAG_STOP+qd.JT,this.onDragStopAnnotationDetail)}processDisplayData(){0===this.deterministicId.length&&(this.deterministicId=this.annotationDisplayData.deterministicId),this.baseDisplay||(this.baseDisplay=new Qd(this)),this.leaderDisplay||(this.leaderDisplay=new ng(this)),this.detailDisplay||(this.detailDisplay=new iu(this))}updateView(e,t){this.baseDisplay.updateView(e,t),this.leaderDisplay.updateView(e,t),this.detailDisplay.updateView(e,t)}onEditAnnotation(e,t){es.Jq.AnnotationService.canEditAnnotation(this.annotationId)&&(0,mr.m)().trigger(pr.C.EDIT_ANNOTATION_DATUM,this.annotationId,t.mouseX,t.mouseY)}onDragStartAnnotationDetail(e,t,i){if(!es.Jq.AnnotationService.canEditAnnotation(this.annotationId))return;const s=this.getDragIntersectionWithBaseAxis(t);if(!s)return;this.isDragging=!0,this.newEndPoint=s;const n=M.subtract(M.create(),s,this.nextStartPoint);this.dragDistance=M.distance(M.create(),n),i.requestDrag=!0}getDragIntersectionWithBaseAxis(e){const t=this.getDragIntersectionPointWithAnnotationPlane(e);return this.intersectRayWithSubjectAxis(t)}onDragAnnotationDetail(e,t){const i=this.getDragIntersectionWithBaseAxis(t);if(!i)return;this.newEndPoint=i;const s=M.subtract(M.create(),i,this.nextStartPoint);this.dragDistance=M.distance(M.create(),s),this.viewer.requestDraw()}onDragStopAnnotationDetail(e,t){this.isDragging=!1;const i=Q.create();i[0]=0,i[1]=this.dragDistance;const s=[];s.push(i),this.viewer.getEventDispatcher().trigger(nM.nu,this.annotationId,s),this.viewer.requestDraw()}}class Ud extends Bd{constructor(e,t,i,s){super(e,t,i,s),this.listenTo(this,yi.zw.DOUBLE_CLICK+qd.YQ,this.onEditAnnotation),this.listenTo(this,yi.zw.DOUBLE_CLICK+qd.Lc,this.onEditAnnotation),this.listenTo(this,yi.zw.DOUBLE_CLICK+qd.U2,this.onEditAnnotation),this.listenTo(this,yi.zw.MOUSE_ENTER+qd.U2,this.onMouseEnter),this.listenTo(this,yi.zw.MOUSE_LEAVE+qd.U2,this.onMouseLeave),this.listenTo(this,yi.zw.DRAG_START+qd.U2,this.onDragStartAnnotationDetail),this.listenTo(this,yi.zw.DRAG+qd.U2,this.onDragAnnotationDetail),this.listenTo(this,yi.zw.DRAG_STOP+qd.U2,this.onDragStopAnnotationDetail)}processDisplayData(){0===this.deterministicId.length&&(this.deterministicId=this.annotationDisplayData.deterministicId),this.baseDisplay||(this.baseDisplay=new $d(this)),this.leaderDisplay||(this.leaderDisplay=new rg(this)),this.detailDisplay||(this.detailDisplay=new ru(this))}updateView(e,t){this.detailDisplay.isUpdateNeeded(e)&&this.removeMeshIncrements(),this.leaderDisplay.updateView(e,t),this.baseDisplay.updateView(e,t),this.detailDisplay.updateView(e,t)}onEditAnnotation(e,t){es.Jq.AnnotationService.canEditAnnotation(this.annotationId)&&(0,mr.m)().trigger(pr.C.EDIT_ANNOTATION_GTOL,this.annotationId,t.mouseX,t.mouseY)}}class Hd extends Bd{constructor(e,t,i,s){super(e,t,i,s),this.holeCalloutDisplayData=t,this.closestLabelCorner=null,this.furthestLabelCorner=null,this.startDragPoint=null,this.listenTo(this,yi.zw.DRAG_START+qd.JT,this.onStartLabelDrag),this.listenTo(this,yi.zw.DRAG+qd.JT,this.onLabelDrag),this.listenTo(this,yi.zw.DRAG_STOP+qd.JT,this.onStopLabelDrag)}getReferencedEntityIds(){return this.holeCalloutDisplayData?this.holeCalloutDisplayData.allHoleFaces:[]}getDragPoint(e){const t=(0,wi.bZ)(e,this.getAnnotationPlaneMatrix());return t?M.fromValues(t[0],t[1],t[2]):null}canDrag(){if(!this.holeCalloutDisplayData)return!1;const e=gi._3.getOpenDocumentController()?.getDocument()?.getActiveElement();if(!e)return!1;if(e.getFeatureScriptVersionNumber()<k.vgi.V2707_HOLE_CALLOUT_LOCATION)return!1;const t=gi._3.getActiveFeatureController();return!t||t.getFeatureId()===this.holeCalloutDisplayData.featureId}onStartLabelDrag(e,t,i){this.canDrag()&&(this.startDragPoint=this.getDragPoint(t.camera.getRay(t.mouseX,t.mouseY)),this.startDragPoint&&(i.requestDrag=!0))}onLabelDrag(e,t){const i=this.getDragPoint(t.camera.getRay(t.mouseX,t.mouseY));if(i){const e=M.subtract(i,i,this.startDragPoint);this.detailDisplay instanceof xu&&(this.detailDisplay.setDragOffset(e),this.viewer.requestDraw())}}onStopLabelDrag(e,t){const i=this.getDragPoint(t.camera.getRay(t.mouseX,t.mouseY)),s=M.subtract(i,i,this.startDragPoint),n=this.planeCoordinateSystem,r=this.holeCalloutDisplayData.labelLocation.x+M.dot(s,n.xAxis.getVec3()),a=this.holeCalloutDisplayData.labelLocation.y+M.dot(s,n.yAxis.getVec3()),o={featureId:this.holeCalloutDisplayData.featureId,partId:this.holeCalloutDisplayData.partId,positionX:r,positionY:a};this.viewer.getEventDispatcher()?.trigger(nM.Rq,o)}processDisplayData(){this.baseDisplay||(this.baseDisplay=new Jd(this)),this.leaderDisplay||(this.leaderDisplay=new ag(this)),this.detailDisplay||(this.detailDisplay=new xu(this,this.holeCalloutDisplayData))}setClosestLabelCorner(e){this.closestLabelCorner=e}setFurthestLabelCorner(e){this.furthestLabelCorner=e}getClosestLabelCorner(){return this.closestLabelCorner}getFurthestLabelCorner(){return this.furthestLabelCorner}getReferenceRadius(){return this.holeCalloutDisplayData.referenceRadius}updateView(e,t){this.detailDisplay&&this.detailDisplay.updateView(e,t),this.leaderDisplay?.updateView(e,t),this.baseDisplay?.updateView(e,t)}isAssociatedWithPart(e){return this.holeCalloutDisplayData?.partId===e}hide(){this.isVisibleToUser()&&super.hide()}onDefaultUnitsChanged(e){this.detailDisplay?.invalidate(),(0,Xs.vm)()}}class Gd extends Bd{constructor(e,t,i,s){super(e,t,i,s),this.listenTo(this,yi.zw.DOUBLE_CLICK+qd.YQ,this.onEditWeld),this.listenTo(this,yi.zw.DOUBLE_CLICK+qd.Lc,this.onEditWeld),this.listenTo(this,yi.zw.DOUBLE_CLICK+qd.PF,this.onEditWeld),this.listenTo(this,yi.zw.DOUBLE_CLICK+qd.kQ,this.onEditWeld),this.listenTo(this,yi.zw.DOUBLE_CLICK+qd.Nq,this.onEditWeld),this.listenTo(this,yi.zw.MOUSE_ENTER+qd.PF,this.onMouseEnter),this.listenTo(this,yi.zw.MOUSE_LEAVE+qd.PF,this.onMouseLeave),this.listenTo(this,yi.zw.DRAG_START+qd.PF,this.onDragStartAnnotationDetail),this.listenTo(this,yi.zw.DRAG+qd.PF,this.onDragAnnotationDetail),this.listenTo(this,yi.zw.DRAG_STOP+qd.PF,this.onDragStopAnnotationDetail),this.listenTo(this,yi.zw.MOUSE_ENTER+qd.kQ,this.onMouseEnter),this.listenTo(this,yi.zw.MOUSE_LEAVE+qd.kQ,this.onMouseLeave),this.listenTo(this,yi.zw.DRAG_START+qd.kQ,this.onDragStartAnnotationDetail),this.listenTo(this,yi.zw.DRAG+qd.kQ,this.onDragAnnotationDetail),this.listenTo(this,yi.zw.DRAG_STOP+qd.kQ,this.onDragStopAnnotationDetail)}processDisplayData(){this.deterministicId||(this.deterministicId=this.annotationDisplayData.deterministicId),this.baseDisplay||(this.baseDisplay=new eu(this)),this.leaderDisplay||(this.leaderDisplay=new og(this)),this.detailDisplay||(this.detailDisplay=new tg(this))}updateView(e,t){this.detailDisplay.isUpdateNeeded(e)&&this.removeMeshIncrements(),this.leaderDisplay.updateView(e,t),this.baseDisplay.updateView(e,t),this.detailDisplay.updateView(e,t)}onEditWeld(e,t){es.Jq.AnnotationService.canEditAnnotation(this.annotationId)&&(0,mr.m)().trigger(pr.C.EDIT_ANNOTATION_WELD,this.annotationId,t.mouseX,t.mouseY)}}const kd=X.default.getManager(),Wd={isVisible:!0,isTwoSided:!0,primitiveType:Ai.MX.TRIANGLES,isShowThrough:!0,isDepthTested:!1,isStencilWritten:!1,isPickable:!0,priority:Gi.DO.LOWER,isStencilTested:!0},zd={isVisible:!0,isTwoSided:!0,primitiveType:Ai.MX.TRIANGLES,isPickable:!0,priority:Gi.DO.DEFAULT,isShowThrough:!1,isDepthTested:!0,isStencilWritten:!0};class Xd{constructor(e,t,i,s){this.texture=null,this.material=null,this.textNodeProperties=null,this.texture=jo(e,t,i),this.texture.hasTransparency=!1,this.material=Hi(),this.material.setTexture(this.texture),this.textNodeProperties=new Gi.hF(Object.assign({material:this.material},s))}destroy(){this.material?.destroy(),this.material=null,this.texture?.destroy(),this.texture=null}get rightCoordinate(){return this.texture.rightCoordinate}get leftCoordinate(){return this.texture.leftCoordinate}get topCoordinate(){return this.texture.topCoordinate}get bottomCoordinate(){return this.texture.bottomCoordinate}get filledWidthPx(){return this.texture.filledWidthPx}get filledHeightPx(){return this.texture.filledHeightPx}get nodeProperties(){return this.textNodeProperties}}class Zd{constructor(e,t,i,s,n){this.showThrough=null,this.depthTested=null,this.depthTested=new Xd(e,t,s,n?Object.assign(n,zd):zd);const r={...s};if(!i){delete r.backgroundColor;const e=kd.getColor("DIMENSION_INACTIVE_OCCLUDED_COLOR");r.color=e,r.borderColor&&(r.borderColor=e)}this.showThrough=new Xd(e,t,r,n?Object.assign(n,Wd):Wd)}destroy(){this.showThrough?.destroy(),this.showThrough=null,this.depthTested?.destroy(),this.depthTested=null}get depthTestedNodeProperties(){return this.depthTested?.nodeProperties}get showThroughNodeProperties(){return this.showThrough?.nodeProperties}get rightCoordinate(){return this.depthTested?.rightCoordinate??0}get leftCoordinate(){return this.depthTested?.leftCoordinate??0}get topCoordinate(){return this.depthTested?.topCoordinate??0}get bottomCoordinate(){return this.depthTested?.bottomCoordinate??0}get filledWidthPx(){return this.depthTested?.filledWidthPx??0}get filledHeightPx(){return this.depthTested?.filledHeightPx??0}}var qd=i(75755),Yd=i(54124);const Kd=X.default.getManager();class jd extends qd.yH{constructor(e){super(e)}createArrow(e,t,i,s){const n=[],r=e.zAxis.getVec3(),a=M.create(),o=M.create(),h=M.create();M.normalize(s,s);const c=M.cross(M.create(),s,r);return M.normalize(c,c),M.scale(c,c,i/4),M.scale(s,s,i),M.copy(a,t),M.subtract(o,s,c),M.add(h,s,c),M.add(o,o,t),M.add(h,h,t),n.push(a),n.push(o),n.push(h),n}updateView(e,t){let i=[],s=null;if(i=this.createDisplayPoints(e),0===i.length)return;s=(0,Yd.aT)(i[0],i[1],i[2],qd.n7),this.annotationDisplay.renderFilledTriangle(qd.n7,qd.YQ,s,this.getColor(),e)}getArrowHeightForAnnotation(e){return Kd.getNumber("ANNOTATION_ARROW_HEIGHT_PX")*e}}class Qd extends jd{constructor(e){super(e)}createDisplayPoints(e){const t=[],i=this.getPlaneCoordinateSystem(),s=i.xAxis.getVec3(),n=i.yAxis.getVec3(),r=i.origin.getVec3(),a=this.getArrowHeightForDatum(this.getPixelSizeAtWorldPoint(r,e)),o=M.scale(M.create(),s,-a/2),h=M.scale(M.create(),n,a),c=M.scale(M.create(),s,a/2);return M.add(o,o,r),M.add(h,h,r),M.add(c,c,r),t.push(o),t.push(h),t.push(c),this.setNextStartPoint(h),t}getArrowHeightForDatum(e){return X.default.getManager().getNumber("ANNOTATION_DATUM_ARROW_HEIGHT_PX")*e}}class $d extends jd{constructor(e){super(e)}createDisplayPoints(e){const t=this.getPlaneCoordinateSystem(),i=t.origin.getVec3(),s=this.getArrowHeightForAnnotation(this.getPixelSizeAtWorldPoint(i,e)),n=M.copy(M.create(),this.getLeaderStartDirection());return this.createArrow(t,i,s,n)}}class Jd extends jd{constructor(e){super(e),this.calloutDisplay=e}createDisplayPoints(e){if(!this.calloutDisplay.getClosestLabelCorner())return[];const t=this.getPlaneCoordinateSystem(),i=t.origin.getVec3(),s=this.calloutDisplay.getReferenceRadius(),n=M.subtract(M.create(),this.calloutDisplay.getClosestLabelCorner(),i);if(this.calloutDisplay.setLeaderStartDirection(n),M.length(n)<Ri.W.ZERO_LENGTH)return[];M.normalize(n,n);const r=M.scaleAndAdd(M.create(),i,n,s),a=this.getArrowHeightForAnnotation(this.getPixelSizeAtWorldPoint(r,e));return this.createArrow(t,r,a,n)}}class eu extends jd{constructor(e){super(e)}createDisplayPoints(e){const t=this.getPlaneCoordinateSystem(),i=t.origin.getVec3(),s=this.getArrowHeightForAnnotation(this.getPixelSizeAtWorldPoint(i,e)),n=M.copy(M.create(),this.getLeaderStartDirection());return this.createArrow(t,i,s,n)}}class tu extends qd.yH{constructor(e){super(e)}isUpdateNeeded(e){return!1}invalidate(){}}class iu extends tu{constructor(e){super(e),this.textDisplay=null,this.datumDisplayData=null,this.currentHighlightType=null,this.annotationDisplay.getAnnotationDisplayData()instanceof k.UqF&&(this.datumDisplayData=this.annotationDisplay.getAnnotationDisplayData())}destroy(){this.destroyTextureAndMaterial()}getSidePoints(){return[]}destroyTextureAndMaterial(){this.textDisplay?.destroy(),this.textDisplay=null}updateView(e,t){this.currentHighlightType!==this.getHighlight()?.type&&this.destroyTextureAndMaterial();const i=this.getPlaneCoordinateSystem();let s="",n=this.getNextStartPoint();if(this.annotationDisplay.isDragging&&(n=this.annotationDisplay.newEndPoint),this.datumDisplayData&&(s=this.datumDisplayData.name),!this.textDisplay){this.currentHighlightType=this.getHighlight()?.type;let e=this.getBackgroundColor();this.currentHighlightType===Cn.o2.UI||this.currentHighlightType===Cn.o2.SECONDARY?e=this.getSelectedBackgroundColor():this.currentHighlightType===Cn.o2.PRE&&(e=this.getHoveredBackgroundColor()),this.textDisplay=new Zd(this.annotationDisplay.viewer,s,this.isHighlighted(),{color:this.getDefaultValueColor(),font:this.getFont(),size:this.getFontSize(),paddingWithinBorder:this.getBackgroundPadding(),backgroundColor:e,backgroundOpacity:this.isHighlighted()?Bd.getHighlightBackgroundOpacity():1,backgroundRadius:0,borderColor:this.getColor(),borderThickness:this.getLineWidth(),dashLength:2,dashGapLength:0})}const r=i.xAxis.getVec3(),a=i.yAxis.getVec3();let o=[!1,!1];o=this.annotationDisplay.getFlips(e);const h=e.getPixelSizeAtWorldPoint(n),c=M.add(M.create(),n,M.scale(M.create(),r,-this.textDisplay.filledWidthPx/2*h)),l=M.add(M.create(),c,M.scale(M.create(),r,this.textDisplay.filledWidthPx*h)),d=M.add(M.create(),c,M.scale(M.create(),a,this.textDisplay.filledHeightPx*h)),u=(0,Yd.fQ)(c,l,d,void 0,[o[0]?this.textDisplay.rightCoordinate:this.textDisplay.leftCoordinate,o[1]?this.textDisplay.topCoordinate:this.textDisplay.bottomCoordinate],[o[0]?this.textDisplay.leftCoordinate:this.textDisplay.rightCoordinate,o[1]?this.textDisplay.bottomCoordinate:this.textDisplay.topCoordinate]);this.annotationDisplay.updateMeshIncrement("dt."+qd._i,qd.JT,u,this.textDisplay.depthTestedNodeProperties),this.annotationDisplay.updateMeshIncrement("st."+qd._i,qd.JT,u,this.textDisplay.showThroughNodeProperties)}}class su{constructor(){this.cellIndex=-1,this.element=null,this.topNear=M.create(),this.boxWidth=0}}class nu{constructor(){this.rowIndex=-1,this.widthWithoutPrefix=0,this.rowDeltaForward=0,this.rowDeltaBackward=0,this.boxLines=[],this.gtolCellData=[]}}class ru extends tu{constructor(e){super(e),this.gtolDisplayData=null,this.gtolRowDisplayData=[],this.gtolRowData=[],this.boxEdgeLength=0,this.flips=[],this.xAxis=null,this.yAxis=null,this.adjustedStartPoint=null,this.totalDisplayWidth=0,this.lastRenderedUnitSizePx=-1,this.constraintUpperCellDisplay=null,this.constraintLowerCellDisplay=null;const t=this.getAnnotationDisplayData();t.getAnnotationType()===k.pLb.GTOL&&(this.gtolDisplayData=t instanceof k.UmN?t:null)}destroy(){this.destroyChildren()}destroyChildren(){this.constraintUpperCellDisplay?.destroy(),this.constraintLowerCellDisplay?.destroy(),this.gtolRowData.forEach((e=>{e.gtolCellData.length>0&&e.gtolCellData.forEach((e=>{e?.element?.destroy()}))}))}isUpdateNeeded(e){let t=!1,i=this.constraintUpperCellDisplay?.updateTexture(e);i=i||this.constraintLowerCellDisplay?.updateTexture(e),i||this.gtolRowData.forEach((t=>{t.gtolCellData.length>0&&t.gtolCellData.forEach((t=>{t||(i=!0),t.element||(i=!0),t.element?.hasDisplayValue()&&t.element.updateTexture(e)&&(i=!0)}))}));const s=e.getUnitSizeAtWorldPoint(this.getNextStartPoint());return Math.abs(this.lastRenderedUnitSizePx-s)>Ri.W.ZERO_LENGTH&&(i=!0),this.lastRenderedUnitSizePx=s,i&&(t=!0,this.destroyChildren(),this.gtolRowData.forEach((e=>{e.gtolCellData.forEach((e=>{null}))})),this.gtolRowData.forEach((e=>{e.boxLines=[]})),this.gtolRowData=[]),t}intializeMainDataStructure(){this.gtolRowDisplayData=[...this.gtolDisplayData.rows],this.flips[1]&&this.gtolRowDisplayData.reverse();for(let e=0;e<this.gtolRowDisplayData.length;e++){const t=new nu;t.rowIndex=e,t.widthWithoutPrefix=0,t.rowDeltaForward=0,t.rowDeltaBackward=0,t.boxLines=[];for(let e=0;e<7;e++){const i=new su;i.cellIndex=e,i.element=null,i.topNear=M.create(),i.boxWidth=0,t.gtolCellData.push(i)}this.gtolRowData.push(t)}}updateView(e,t){if(!this.gtolDisplayData||0===this.gtolDisplayData.rows.length)return;let i=this.isUpdateNeeded(e);if(0===this.gtolRowData.length&&(i=!0),!i)return;const s=this.annotationDisplay.getPlaneCoordinateSystem();this.xAxis=s.xAxis.getVec3(),this.yAxis=s.yAxis.getVec3();let n=this.getNextStartPoint();this.flips=this.annotationDisplay.getFlips(e),this.boxEdgeLength=this.getSideEdgeLength(this.getPixelSizeAtWorldPoint(n,e)),this.intializeMainDataStructure(),this.annotationDisplay.startDetailFromFarSide&&(n=M.add(M.create(),n,M.scale(M.create(),this.xAxis,-this.totalDisplayWidth))),this.adjustedStartPoint=this.adjustStartPoint(n),this.createDisplayElementCells(t),this.createTexturesAndSetWidthData(e);const r=this.findLongestPrefixWidth(),a=this.findLongestWidthNoPrefix();this.setRowDeltaToAlignBoxesForward(r),this.setRowDeltaToAlignBoxesBackward(a);for(const e of this.gtolRowData){n=this.adjustStartPoint(n),this.setCellPositionsPerRow(n,e)}this.updateTotalDisplayWidth();for(const t of this.gtolRowData)this.createBoxesForNextRow(t,e),this.instantiateRowTextures(t,e);n=this.adjustedStartPoint,this.displayUpperText(n,e),n=this.adjustedStartPoint,this.displayLowerText(n,e)}createDisplayElementCells(e){for(const t of this.gtolRowData){const i=this.gtolRowDisplayData[t.rowIndex],s=i.constraintType;let n=k.ad8[s];this.isHighlighted()&&(this.getHighlight()?.type===Cn.o2.UI||this.getHighlight()?.type===Cn.o2.SECONDARY?n=Bd.getIconSelectedName(n):this.getHighlight()?.type===Cn.o2.PRE&&(n=Bd.getIconHoveredName(n)));const r=Bd.getFormattedValueString(i.tolerance,e);let a="",o="",h="";if(i.references&&(a=i.references.length>0?i.references[0]:"",o=i.references.length>1?i.references[1]:"",h=i.references.length>2?i.references[2]:""),7===t.gtolCellData.length&&t.gtolCellData.length>6){const e=t.rowIndex.toString()+"_";t.gtolCellData[0].element=new hu(this.annotationDisplay,e+"cell_id_prefix",i.prefix),t.gtolCellData[1].element=new ou(this.annotationDisplay,e+"cell_id_constraint_type",n),t.gtolCellData[2].element=new hu(this.annotationDisplay,e+"cell_id_constraint_Value",r),t.gtolCellData[3].element=new hu(this.annotationDisplay,e+"cell_id_datum_0",a),t.gtolCellData[4].element=new hu(this.annotationDisplay,e+"cell_id_datum_1",o),t.gtolCellData[5].element=new hu(this.annotationDisplay,e+"cell_id_datum_2",h),t.gtolCellData[6].element=new hu(this.annotationDisplay,e+"cell_id_suffix",i.suffix),this.flips[0]&&t.gtolCellData.reverse()}}}adjustStartPoint(e){return M.add(M.create(),e,M.scale(M.create(),this.yAxis,this.boxEdgeLength/2))}updateTotalDisplayWidth(){this.totalDisplayWidth=0,this.gtolRowData[0].gtolCellData.forEach((e=>{this.totalDisplayWidth+=e.boxWidth}))}findLongestPrefixWidth(){let e=0;for(const t of this.gtolRowData)if(t.gtolCellData[0]){const i=t.gtolCellData[0].boxWidth;i>e&&(e=i)}return e}findLongestWidthNoPrefix(){let e=0;for(const t of this.gtolRowData){let i=0;for(const e of t.gtolCellData)e.cellIndex>0&&(i+=e.boxWidth);t.widthWithoutPrefix=i,i>e&&(e=i)}return e}setRowDeltaToAlignBoxesForward(e){for(const t of this.gtolRowData)t.gtolCellData[0]&&(t.rowDeltaForward=e-t.gtolCellData[0].boxWidth)}setRowDeltaToAlignBoxesBackward(e){for(const t of this.gtolRowData)t.rowDeltaBackward=e-t.widthWithoutPrefix}getSidePoints(){const e=[];e.push(this.adjustedStartPoint);const t=M.add(M.create(),this.adjustedStartPoint,M.scale(M.create(),this.xAxis,this.totalDisplayWidth));return e.push(t),e}createTexturesAndSetWidthData(e){const t=M.copy(M.create(),this.adjustedStartPoint);for(const i of this.gtolRowData)for(const s of i.gtolCellData)s.boxWidth=s.element.createTexture(t,e)}setCellPositionsPerRow(e,t){const i=-this.boxEdgeLength*t.rowIndex*1.5;e=M.add(M.create(),e,M.scale(M.create(),this.yAxis,i));const s=this.flips[0]?t.rowDeltaBackward:t.rowDeltaForward;e=M.add(M.create(),e,M.scale(M.create(),this.xAxis,s));for(const i of t.gtolCellData)i.topNear=e,e=M.add(M.create(),e,M.scale(M.create(),this.xAxis,i.boxWidth))}instantiateRowTextures(e,t){for(const i of e.gtolCellData)i.element.setWidth(i.boxWidth),i.element.setHeight(this.boxEdgeLength),i.element.instantiateTexture(i.topNear,t)}createBoxesForNextRow(e,t){e.boxLines=[];for(const t of e.gtolCellData){let i=M.create();i=t.topNear;const s=M.create();s[0]=i[0]+this.xAxis[0]*t.boxWidth,s[1]=i[1]+this.xAxis[1]*t.boxWidth,s[2]=i[2]+this.xAxis[2]*t.boxWidth;const n=M.create();n[0]=s[0]-this.yAxis[0]*this.boxEdgeLength,n[1]=s[1]-this.yAxis[1]*this.boxEdgeLength,n[2]=s[2]-this.yAxis[2]*this.boxEdgeLength;const r=M.create();r[0]=n[0]-this.xAxis[0]*t.boxWidth,r[1]=n[1]-this.xAxis[1]*t.boxWidth,r[2]=n[2]-this.xAxis[2]*t.boxWidth,0!==t.cellIndex&&t.cellIndex!==e.gtolCellData.length-1&&(e.boxLines.push(i),e.boxLines.push(s),e.boxLines.push(s),e.boxLines.push(n),e.boxLines.push(n),e.boxLines.push(r),e.boxLines.push(r),e.boxLines.push(i))}const i=qd.TN+"_"+e.rowIndex.toString(),s=(0,Yd.pf)(e.boxLines,i,this.getColor(),this.getLineWidth(),this.getLineStyle());this.annotationDisplay.renderLines(i,qd.U2,s,this.getColor(),t)}displayUpperText(e,t){if(0===this.gtolDisplayData.upper.length)return;this.constraintUpperCellDisplay=new hu(this.annotationDisplay,"cell_id_upper",this.gtolDisplayData.upper);const i=this.constraintUpperCellDisplay.createTexture(e,t),s=this.boxEdgeLength;this.constraintUpperCellDisplay.setWidth(i),this.constraintUpperCellDisplay.setHeight(s);let n=0;if(this.flips[1]){const e=this.gtolDisplayData.rows.length;n=-this.boxEdgeLength*e}else n=this.boxEdgeLength;const r=M.add(M.create(),e,M.scale(M.create(),this.yAxis,n));let a=0;a=this.flips[0]?this.findLongestWidthNoPrefix()-i:this.findLongestPrefixWidth();const o=M.add(M.create(),r,M.scale(M.create(),this.xAxis,a));this.constraintUpperCellDisplay.instantiateTexture(o,t)}displayLowerText(e,t){if(0===this.gtolDisplayData.lower.length)return;this.constraintLowerCellDisplay=new hu(this.annotationDisplay,"cell_id_lower",this.gtolDisplayData.lower);const i=this.constraintLowerCellDisplay.createTexture(e,t),s=this.boxEdgeLength;this.constraintLowerCellDisplay.setWidth(i),this.constraintLowerCellDisplay.setHeight(s);let n=0;if(this.flips[1])n=this.boxEdgeLength;else{const e=this.gtolDisplayData.rows.length;n=-this.boxEdgeLength*e}const r=M.add(M.create(),e,M.scale(M.create(),this.yAxis,n));let a=0;a=this.flips[0]?this.findLongestWidthNoPrefix()-i:this.findLongestPrefixWidth();const o=M.add(M.create(),r,M.scale(M.create(),this.xAxis,a));this.constraintLowerCellDisplay.instantiateTexture(o,t)}}class au extends tu{constructor(e,t,i){super(e),this.cellId=t,this.displayValue=i,this.height=0,this.width=0,this.xAxis=null,this.yAxis=null,this.lastFlips=[],this.xAxis=e.getPlaneCoordinateSystem().xAxis.getVec3(),this.yAxis=e.getPlaneCoordinateSystem().yAxis.getVec3(),this.lastFlips=[!1,!1]}getSidePoints(){return[]}setCellId(e){this.cellId=e}setDisplayValue(e){this.displayValue=e}hasDisplayValue(){return this.displayValue&&this.displayValue.length>0}setHeight(e){this.height=e}setWidth(e){this.width=e}didFlipsChange(e){const t=this.annotationDisplay.getFlips(e);return t[0]!==this.lastFlips[0]||t[1]!==this.lastFlips[1]}}class ou extends au{constructor(e,t,i){super(e,t,i),this.nodeProperties=null}destroyTextureAndMaterial(){}updateTexture(){return!1}updateView(e,t){}createTexture(e,t){const i=t.getPixelSizeAtWorldPoint(e),s=this.getSideEdgeLength(i),n=this.annotationDisplay.viewer.getResources().mbdAtlasNodeProperties;return this.nodeProperties=n[1],s}instantiateTexture(e,t){let i=[!1,!1];i=this.annotationDisplay.getFlips(t);const s=this.annotationDisplay.getIconSize(),n=this.width/2,r=this.height,a=M.add(M.create(),e,M.scale(M.create(),this.xAxis,n));M.subtract(a,a,M.scale(M.create(),this.yAxis,.9*r));const o=t.getPixelSizeAtWorldPoint(e),h=M.add(M.create(),a,M.scale(M.create(),this.xAxis,-s/2*o)),c=M.add(M.create(),h,M.scale(M.create(),this.xAxis,s*o)),l=M.add(M.create(),h,M.scale(M.create(),this.yAxis,s*o)),d=this.annotationDisplay.viewer.getResources().mbdAtlas;if(d){const e=d.getTextureCoords(this.displayValue);if(e){const t=(0,Yd.fQ)(h,c,l,void 0,[i[0]?e.highS:e.lowS,i[1]?e.lowT:e.highT],[i[0]?e.lowS:e.highS,i[1]?e.highT:e.lowT]);this.annotationDisplay.updateMeshIncrement(this.cellId,qd.U2,t,this.nodeProperties)}}}}class hu extends au{constructor(e,t,i){super(e,t,i),this.textDisplay=null,this.lastRenderedHighlightType=null,this.lastRenderedHighlightType=this.currentHighlightType}destroy(){this.destroyTextureAndMaterial()}destroyTextureAndMaterial(){this.textDisplay?.destroy(),this.textDisplay=null}updateView(e,t){}get currentHighlightType(){return this.getHighlight()?.type||null}updateTexture(e){return!!(this.lastRenderedHighlightType!==this.currentHighlightType||this.annotationDisplay.isDragging||this.annotationDisplay.isDraggingBase||this.didFlipsChange(e))&&(this.destroyTextureAndMaterial(),!0)}createTexture(e,t){this.destroyTextureAndMaterial();let i=0;if(0===this.displayValue.length)return i;if(!this.textDisplay){this.lastFlips=this.annotationDisplay.getFlips(t),this.lastRenderedHighlightType=this.currentHighlightType;let s=this.getBackgroundColor();this.currentHighlightType===Cn.o2.UI||this.currentHighlightType===Cn.o2.SECONDARY?s=this.getSelectedBackgroundColor():this.currentHighlightType===Cn.o2.PRE&&(s=this.getHoveredBackgroundColor()),this.textDisplay=new Zd(this.annotationDisplay.viewer,this.displayValue,this.isHighlighted(),{color:this.getDefaultValueColor(),font:this.getFont(),size:this.getFontSize(),paddingWithinBorder:this.getBackgroundPadding(),backgroundColor:s,backgroundOpacity:this.isHighlighted()?Bd.getHighlightBackgroundOpacity():1,backgroundRadius:0,borderThickness:0,dashLength:2,dashGapLength:0},{zOffset:25});const n=t.getPixelSizeAtWorldPoint(e);i=this.textDisplay.filledWidthPx*n}return i}instantiateTexture(e,t){if(!this.textDisplay)return;const i=this.annotationDisplay.getFlips(t),s=this.width/2,n=this.height,r=M.add(M.create(),e,M.scale(M.create(),this.xAxis,s));M.subtract(r,r,M.scale(M.create(),this.yAxis,n));const a=t.getPixelSizeAtWorldPoint(e),o=M.add(M.create(),r,M.scale(M.create(),this.xAxis,-this.textDisplay.filledWidthPx/2*a)),h=M.add(M.create(),o,M.scale(M.create(),this.xAxis,this.textDisplay.filledWidthPx*a)),c=M.add(M.create(),o,M.scale(M.create(),this.yAxis,this.textDisplay.filledHeightPx*a)),l=(0,Yd.fQ)(o,h,c,void 0,[i[0]?this.textDisplay.rightCoordinate:this.textDisplay.leftCoordinate,i[1]?this.textDisplay.topCoordinate:this.textDisplay.bottomCoordinate],[i[0]?this.textDisplay.leftCoordinate:this.textDisplay.rightCoordinate,i[1]?this.textDisplay.bottomCoordinate:this.textDisplay.topCoordinate]);this.annotationDisplay.updateMeshIncrement("st."+this.cellId,qd.U2,l,this.textDisplay.showThroughNodeProperties),this.annotationDisplay.updateMeshIncrement("dt."+this.cellId,qd.U2,l,this.textDisplay.depthTestedNodeProperties)}}const cu=X.default.getManager(),lu=" THRU",du="mbd_hc_diameter",uu="mbd_hc_depth",gu="mbd_hc_diameter_limit",pu="mbd_hc_depth_limit",mu="mbd_hc_cb_diameter",fu="mbd_hc_cb_depth",Iu="mbd_hc_cb_diameter_limit",Eu="mbd_hc_cb_depth_limit",Su="mbd_hc_cs_diameter",Tu="mbd_hc_cs_angle",Du="mbd_hc_cs_diameter_limit",Cu="mbd_hc_cs_angle_limit",Mu="mbd_hc_tap_depth",yu="mbd_hc_tap_depth_limit",Au="mbd_hc_tap_size";class Pu{constructor(e,t,i,s){this.text=e,this.incrementId=t,this.textDisplay=null,this.textDisplay=new Zd(i,e,!1,s,{isPickable:!1})}destroy(){this.textDisplay?.destroy(),this.textDisplay=null}getIncrementId(){return this.incrementId}getText(){return this.text}getWidth(){return this.textDisplay?.filledWidthPx??0}getHeight(){return this.textDisplay?.filledHeightPx??0}getLeft(){return this.textDisplay?.leftCoordinate??0}getRight(){return this.textDisplay?.rightCoordinate??0}getTop(){return this.textDisplay?.topCoordinate??0}getBottom(){return this.textDisplay?.bottomCoordinate??0}getDepthTestedNodeProperties(){return this.textDisplay?.depthTestedNodeProperties}getShowThroughNodeProperties(){return this.textDisplay?.showThroughNodeProperties}}function Ou(e){return e.toleranceType!==k.gkc.NONE||e.precision!==k.d_N.DEFAULT}function Ru(e,t){return{isAngle:e.isAngle,precision:e.precision,withZeros:Ou(e),signOption:t}}function wu(e,t){if(e.toleranceType===k.gkc.LIMITS)return"";const i=function(e,t){return Bd.getFormattedValueString(e.nominalValue,t,Ru(e,xd.NATURAL_SIGN))}(e,t);return e.toleranceType===k.gkc.MIN?i+" MIN":e.toleranceType===k.gkc.MAX?i+" MAX":e.toleranceType===k.gkc.SYMMETRICAL?i+"±"+Bd.getFormattedValueString(e.upperTolerance,t,Ru(e,xd.NATURAL_SIGN)):e.toleranceType!==k.gkc.FIT&&e.toleranceType!==k.gkc.FIT_WITH_TOLERANCE||""===e.fitClass?i:i+" "+e.fitClass}function vu(e,t){return e.toleranceType===k.gkc.LIMITS?function(e,t){return Bd.getFormattedValueString(e.nominalValue+e.upperTolerance,t,Ru(e,xd.NATURAL_SIGN))}(e,t)+"\n"+function(e,t){return Bd.getFormattedValueString(e.nominalValue+e.lowerTolerance,t,Ru(e,xd.NATURAL_SIGN))}(e,t):e.toleranceType===k.gkc.DEVIATION||e.toleranceType===k.gkc.FIT_WITH_TOLERANCE||e.toleranceType===k.gkc.FIT_TOLERANCE_ONLY?function(e,t){return Bd.getFormattedValueString(e.upperTolerance,t,Ru(e,xd.POSITIVE_ZERO))}(e,t)+"\n"+function(e,t){return Bd.getFormattedValueString(e.lowerTolerance,t,Ru(e,xd.NEGATIVE_ZERO))}(e,t):""}class _u{constructor(e,t){this.incrementId=e,this.textExtractor=t}createNode(e,t,i,s){const n=this.textExtractor(e,t);return n?new Pu(n,this.incrementId,i,s):null}}const Nu=[new _u(du,((e,t)=>e.diameter?.isDefined?"Ø"+wu(e.diameter,t):null)),new _u(gu,((e,t)=>e.diameter?.isDefined?vu(e.diameter,t):null)),new _u(uu,((e,t)=>e.depth?.isDefined?"↧"+wu(e.depth,t):lu)),new _u(pu,((e,t)=>e.depth?.isDefined?vu(e.depth,t):null)),new _u(mu,((e,t)=>e.counterboreDiameter?.isDefined?"⌴Ø"+wu(e.counterboreDiameter,t):null)),new _u(Iu,((e,t)=>e.counterboreDiameter?.isDefined?vu(e.counterboreDiameter,t):null)),new _u(fu,((e,t)=>e.counterboreDepth?.isDefined?"↧"+wu(e.counterboreDepth,t):null)),new _u(Eu,((e,t)=>e.counterboreDepth?.isDefined?vu(e.counterboreDepth,t):null)),new _u(Su,((e,t)=>e.countersinkDiameter?.isDefined?"⌵Ø"+wu(e.countersinkDiameter,t):null)),new _u(Du,((e,t)=>e.countersinkDiameter?.isDefined?vu(e.countersinkDiameter,t):null)),new _u(Tu,((e,t)=>e.countersinkAngle?.isDefined?"X"+wu(e.countersinkAngle,t):null)),new _u(Cu,((e,t)=>e.countersinkAngle?.isDefined?vu(e.countersinkAngle,t):null)),new _u(Mu,((e,t)=>!e.isTapped||e.isTaperedPipeTap?null:e.tappedDepth?.isDefined?"↧"+wu(e.tappedDepth,t):lu)),new _u(yu,((e,t)=>e.isTapped&&e.tappedDepth?.isDefined?vu(e.tappedDepth,t):null)),new _u(Au,((e,t)=>e.isTapped?e.tapSize:null))];class bu{centerOnOrigin(){const e=.5*-this.getWidth(),t=.5*-this.getHeight();this.setAnchor(e,t)}}class Lu extends bu{constructor(e){super(),this.node=e,this.anchorX=0,this.anchorY=0}getNode(){return this.node}getAnchorX(){return this.anchorX}getAnchorY(){return this.anchorY}getWidth(){return this.node?.getWidth()}getHeight(){return this.node?.getHeight()}setAnchor(e,t){this.anchorX=e,this.anchorY=t}forEachNodeLayout(e){e(this)}}class Fu extends bu{constructor(e){super(),this.group=e,this.border=0}isEmpty(){return 0===this.group.length}getNode(){return null}getAnchorX(){return Math.min(...this.group.map((e=>e.getAnchorX())))-this.border}getAnchorY(){return Math.min(...this.group.map((e=>e.getAnchorY())))-this.border}getWidth(){return Math.max(...this.group.map((e=>e.getAnchorX()+e.getWidth())))-this.getAnchorX()+this.border}getHeight(){return Math.max(...this.group.map((e=>e.getAnchorY()+e.getHeight())))-this.getAnchorY()+this.border}alignHorizontally(){if(this.isEmpty())return;const e=Math.max(...this.group.map((e=>e.getHeight())));let t=0;for(const i of this.group)i.setAnchor(t,.5*(e-i.getHeight())),t+=i.getWidth()}alignVertically(){if(this.isEmpty())return;const e=Math.max(...this.group.map((e=>e.getWidth())));let t=0;for(const i of this.group)i.setAnchor(.5*(e-i.getWidth()),t),t+=i.getHeight()}setAnchor(e,t){if(this.isEmpty())return;const i=e-this.getAnchorX(),s=t-this.getAnchorY();for(const e of this.group)e.setAnchor(e.getAnchorX()+i,e.getAnchorY()+s)}forEachNodeLayout(e){for(const t of this.group)t.forEachNodeLayout(e)}expand(e){this.border+=e}}class xu extends tu{constructor(e,t){super(e),this.calloutDisplay=e,this.calloutDisplayData=t,this.nodes={},this.topLayout=null,this.dragOffset=null}setDragOffset(e){this.dragOffset=e}destroy(){this.destroyNodes()}destroyNodes(){for(const e of Object.values(this.nodes))e.destroy();this.nodes={}}invalidate(){this.annotationDisplay.removeMeshIncrements(),this.destroyNodes(),(0,Xs.vm)()}getSidePoints(){return[]}getTextureOptions(){return{color:this.getDefaultValueColor(),font:this.getFont(),backgroundOpacity:0,size:this.getFontSize()}}getModelSpaceCorners(e,t){const i=M.scale(M.create(),t.xAxis,t.pixelSize),s=M.scale(M.create(),t.yAxis,t.pixelSize);let n=M.scaleAndAdd(M.create(),t.origin,i,e.getAnchorX());return n=M.scaleAndAdd(n,n,s,e.getAnchorY()),{lowerLeft:n,lowerRight:M.scaleAndAdd(M.create(),n,i,e.getWidth()),upperLeft:M.scaleAndAdd(M.create(),n,s,e.getHeight())}}createQuad(e,t,i){const s=this.getModelSpaceCorners(t,i);return(0,Yd.fQ)(s.lowerLeft,s.lowerRight,s.upperLeft,void 0,[e.getLeft(),e.getBottom()],[e.getRight(),e.getTop()])}getBackplateProperties(){return new Gi.hF({isVisible:!0,isTwoSided:!0,primitiveType:Ai.MX.TRIANGLES,isPickable:!0,isShowThrough:!0,isDepthTested:!1,isStencilWritten:!1,isStencilTested:!1,material:Vi,zOffset:10})}createBackplateQuad(e,t){const i=this.getModelSpaceCorners(e,t),s=(0,Yd.Dw)(i.lowerLeft,i.lowerRight,i.upperLeft,cu.getNumber("DIMENSION_VALUE_BACKGROUND_BORDER_RADIUS")*t.pixelSize,9);let n=null;const r=this.getHighlight()?.type;return r===Cn.o2.UI||r===Cn.o2.SECONDARY?n=this.getSelectedBackgroundColor():r===Cn.o2.PRE&&(n=this.getHoveredBackgroundColor()),n&&n.length>3&&(n[3]=cu.getNumber("DIMENSION_VALUE_BACKGROUND_OPACITY")),(0,Yd.Ab)(n??[0,0,0,0],s),s}updateView(e,t){if(0===Object.keys(this.nodes).length){const e=this.getTextureOptions();for(const i of Nu){const s=i.createNode(this.calloutDisplayData,t,this.annotationDisplay.viewer,e);s&&(this.nodes[s.getIncrementId()]=s)}const i=[du,gu,uu,pu].map((e=>this.nodes[e])).filter((e=>!!e)).map((e=>new Lu(e))),s=new Fu(i);s.alignHorizontally();const n=[mu,Iu,fu,Eu].map((e=>this.nodes[e])).filter((e=>!!e)).map((e=>new Lu(e))),r=new Fu(n);r.alignHorizontally();const a=[Su,Du,Tu,Cu].map((e=>this.nodes[e])).filter((e=>!!e)).map((e=>new Lu(e))),o=new Fu(a);o.alignHorizontally();const h=[Au,Mu,yu].map((e=>this.nodes[e])).filter((e=>!!e)).map((e=>new Lu(e))),c=new Fu(h);c.alignHorizontally();const l=new Fu([c,r,o,s].filter((e=>!e.isEmpty())));l.alignVertically(),this.topLayout=new Fu([l]),this.topLayout.expand(cu.getNumber("DIMENSION_VALUE_BACKGROUND_PADDING"))}if(!this.topLayout||this.topLayout.isEmpty())return;const i=this.getPlaneCoordinateSystem(),s=this.annotationDisplay.getFlips(e),n=s.length>0&&s[0],r=s.length>1&&s[1],a=i.origin.getVec3(),o=this.calloutDisplayData.labelLocation.getVec2();M.scaleAndAdd(a,a,i.xAxis.getVec3(),o[0]),M.scaleAndAdd(a,a,i.yAxis.getVec3(),o[1]),this.dragOffset&&M.add(a,a,this.dragOffset);const h={pixelSize:e.getPixelSizeAtWorldPoint(a),origin:a,xAxis:M.scale(M.create(),i.xAxis.getVec3(),n?-1:1),yAxis:M.scale(M.create(),i.yAxis.getVec3(),r?-1:1)};this.topLayout.centerOnOrigin(),this.topLayout.forEachNodeLayout((e=>{const t=e.getNode();this.annotationDisplay.updateMeshIncrement("dt."+t.getIncrementId(),"",this.createQuad(t,e,h),t.getDepthTestedNodeProperties()),this.annotationDisplay.updateMeshIncrement("st."+t.getIncrementId(),"",this.createQuad(t,e,h),t.getShowThroughNodeProperties())})),this.annotationDisplay.updateMeshIncrement("st.mbd_hc_backplate",qd.JT,this.createBackplateQuad(this.topLayout,h),this.getBackplateProperties());const c=this.getModelSpaceCorners(this.topLayout,h),l=i.origin.getVec3(),d=M.distance(c.lowerLeft,l)<M.distance(c.lowerRight,l);this.calloutDisplay.setClosestLabelCorner(d?c.lowerLeft:c.lowerRight),this.calloutDisplay.setFurthestLabelCorner(d?c.lowerRight:c.lowerLeft)}}class Bu extends tu{constructor(e){super(e),this.textDisplay=null,this.currentHighlightType=null,this.displayValue="",this.cellId="",this.lowerLeft=null,this.upperLeft=null,this.lowerRight=null,this.upperRight=null,this.boxEdgeLength=0}updateView(e,t){}getSidePoints(){return[]}setDisplayValue(e){this.displayValue=e}setCellId(e){this.cellId=e}destroy(){this.destroyTextureAndMaterial()}destroyTextureAndMaterial(){this.textDisplay?.destroy(),this.textDisplay=null}updateTexture(e,t,i,s,n){this.currentHighlightType!==this.getHighlight()?.type||this.annotationDisplay.isDragging,this.destroyTextureAndMaterial(),this.currentHighlightType=this.getHighlight()?.type;let r=this.getBackgroundColor();if(this.currentHighlightType===Cn.o2.UI||this.currentHighlightType===Cn.o2.SECONDARY?r=this.getSelectedBackgroundColor():this.currentHighlightType===Cn.o2.PRE&&(r=this.getHoveredBackgroundColor()),!this.textDisplay){const e={color:this.getDefaultValueColor(),font:this.getFont(),size:this.getFontSize(),backgroundColor:r,backgroundOpacity:this.isHighlighted()?Bd.getHighlightBackgroundOpacity():1,paddingWithinBorder:this.getBackgroundPadding()};this.textDisplay=new Zd(this.annotationDisplay.viewer,this.displayValue,this.isHighlighted(),e)}const a=this.getPixelSizeAtWorldPoint(e,n);this.boxEdgeLength=this.getSideEdgeLength(a);const o=this.textDisplay.filledWidthPx*a,h=this.boxEdgeLength;s?(this.lowerLeft=e,this.upperLeft=M.add(M.create(),this.lowerLeft,M.scale(M.create(),i,h)),this.upperRight=M.add(M.create(),this.upperLeft,M.scale(M.create(),t,o)),this.lowerRight=M.add(M.create(),this.lowerLeft,M.scale(M.create(),t,o))):(this.upperLeft=e,this.upperRight=M.add(M.create(),this.upperLeft,M.scale(M.create(),t,o)),this.lowerLeft=M.add(M.create(),this.upperLeft,M.scale(M.create(),i,-h)),this.lowerRight=M.add(M.create(),this.lowerLeft,M.scale(M.create(),t,o)));const c=zo(n,t,i),l=(0,Yd.fQ)(this.lowerLeft,this.lowerRight,this.upperLeft,void 0,[c[0]?this.textDisplay.rightCoordinate:this.textDisplay.leftCoordinate,c[1]?this.textDisplay.topCoordinate:this.textDisplay.bottomCoordinate],[c[0]?this.textDisplay.leftCoordinate:this.textDisplay.rightCoordinate,c[1]?this.textDisplay.bottomCoordinate:this.textDisplay.topCoordinate]);this.annotationDisplay.updateMeshIncrement("dt."+this.cellId,qd.PF,l,this.textDisplay.depthTestedNodeProperties),this.annotationDisplay.updateMeshIncrement("st."+this.cellId,qd.PF,l,this.textDisplay.showThroughNodeProperties)}}class Vu extends tu{constructor(){super(...arguments),this.cellId="",this.imageId="",this.lowerLeft=null,this.upperLeft=null,this.lowerRight=null,this.upperRight=null}getSidePoints(){return[]}updateView(e,t){}setCellId(e){this.cellId=e}setImageId(e){this.imageId=e}updateTexture(e,t,i,s,n,r,a){const o=this.annotationDisplay.viewer.getResources().mbdAtlasNodeProperties[1];let h=this.imageId;this.isHighlighted()&&(this.getHighlight()?.type===Cn.o2.UI||this.getHighlight()?.type===Cn.o2.SECONDARY?h=Bd.getIconSelectedName(h):this.getHighlight()?.type===Cn.o2.PRE&&(h=Bd.getIconHoveredName(h)));const c=this.getSideEdgeLength(this.getPixelSizeAtWorldPoint(e,a));s?(this.lowerLeft=e,this.upperLeft=M.add(M.create(),this.lowerLeft,M.scale(M.create(),i,c)),this.upperRight=M.add(M.create(),this.upperLeft,M.scale(M.create(),t,c)),this.lowerRight=M.add(M.create(),this.lowerLeft,M.scale(M.create(),t,c))):(this.upperLeft=e,this.upperRight=M.add(M.create(),this.upperLeft,M.scale(M.create(),t,c)),this.lowerLeft=M.add(M.create(),this.upperLeft,M.scale(M.create(),i,-c)),this.lowerRight=M.add(M.create(),this.lowerLeft,M.scale(M.create(),t,c)));const l=zo(a,t,i),d=this.annotationDisplay.viewer.getResources().mbdAtlas;if(d){const e=d.getTextureCoords(h),t=n?l[0]||!this.annotationDisplay.startDetailFromFarSide||l[1]&&this.annotationDisplay.startDetailFromFarSide:l[0],i=s||r;if(e){const s=(0,Yd.fQ)(this.lowerLeft,this.lowerRight,this.upperLeft,void 0,[t?e.highS:e.lowS,i?e.highT:e.lowT],[t?e.lowS:e.highS,i?e.lowT:e.highT]);this.annotationDisplay.updateMeshIncrement(this.cellId,qd.PF,s,o)}}}}const Uu="mbd_weld_upper_root_opening",Hu="mbd_weld_upper_groove_cell_id",Gu="mbd_weld_upper_value_one",ku="mbd_weld_upper_value_two",Wu="mbd_weld_upper_value_three",zu="mbd_weld_upper_value_four",Xu="mbd_weld_lower_root_opening",Zu="mbd_weld_lower_groove_cell_id",qu="mbd_weld_lower_value_one",Yu="mbd_weld_lower_value_two",Ku="mbd_weld_lower_value_three",ju="mbd_weld_lower_value_four",Qu=new Set([Uu,Hu,Gu,ku,Wu,zu]),$u=new Set([Xu,Zu,qu,Yu,Ku,ju]),Ju=new Set([Uu,Hu,Xu,Zu]),eg=X.default.getManager();class tg extends tu{constructor(e){super(e),this.boxEdgeLength=0,this.upperHorizontalBoxesStartPoint=null,this.upperVerticalBoxesStartPoint=null,this.lowerHorizontalBoxesStartPoint=null,this.lowerVerticalBoxesStartPoint=null,this.linePoints=[];const t=this.getAnnotationDisplayData();t.getAnnotationType()===k.pLb.WELD&&(this.weldDisplayData=t instanceof k.tGf?t:null),this.cellIdToDisplayValue=new Map([[Uu,this.weldDisplayData.upperRootOpening],[Hu,this.weldDisplayData.upperGroove],[Gu,this.weldDisplayData.upperValueOne],[ku,this.weldDisplayData.upperValueTwo],[Wu,this.weldDisplayData.upperValueThree],[zu,this.weldDisplayData.upperValueFour],[Xu,this.weldDisplayData.lowerRootOpening],[Zu,this.weldDisplayData.lowerGroove],[qu,this.weldDisplayData.lowerValueOne],[Yu,this.weldDisplayData.lowerValueTwo],[Ku,this.weldDisplayData.lowerValueThree],[ju,this.weldDisplayData.lowerValueFour]]),this.cellIdToDisplayElement=new Map;for(const t of this.cellIdToDisplayValue.keys())this.cellIdToDisplayElement.set(t,new Bu(e));this.referenceDisplayElement=new Bu(e)}updateView(e,t){this.linePoints=[],this.system=this.annotationDisplay.planeCoordinateSystem,this.startPoint=this.getNextStartPoint(),this.boxEdgeLength=this.getSideEdgeLength(this.getPixelSizeAtWorldPoint(this.startPoint,e)),this.initializeBoxPointParameters(e),this.insertAllAroundSymbol(this.getExtendedLeaderStartPoint(),e),this.insertWeldFlags(this.getExtendedLeaderStartPoint(),e),this.annotationDisplay.startDetailFromFarSide?(this.insertQuantityToBox(zu,this.upperHorizontalBoxesStartPoint,e,t),this.insertQuantityToBox(Wu,this.upperHorizontalBoxesStartPoint,e,t),this.insertQuantityToBox(ju,this.lowerHorizontalBoxesStartPoint,e,t),this.insertQuantityToBox(Ku,this.lowerHorizontalBoxesStartPoint,e,t)):(this.insertQuantityToBox(Gu,this.upperHorizontalBoxesStartPoint,e,t),this.insertQuantityToBox(ku,this.upperHorizontalBoxesStartPoint,e,t),this.insertQuantityToBox(qu,this.lowerHorizontalBoxesStartPoint,e,t),this.insertQuantityToBox(Yu,this.lowerHorizontalBoxesStartPoint,e,t));const i=this.weldDisplayData.standard===k.dXw.ISO,s=i?M.add(M.create(),this.getDeltaVectorForBoxStartPoints(this.upperHorizontalBoxesStartPoint,e),this.getOffsetVectorForBoxStartPoints(this.upperHorizontalBoxesStartPoint,e)):M.scale(M.create(),this.getOffsetVectorForBoxStartPoints(this.upperHorizontalBoxesStartPoint,e),2);M.dot(this.upperHorizontalBoxesStartPoint,this.extendedLeaderDirection)>M.dot(this.lowerHorizontalBoxesStartPoint,this.extendedLeaderDirection)?this.lowerHorizontalBoxesStartPoint=M.subtract(M.create(),this.upperHorizontalBoxesStartPoint,s):this.upperHorizontalBoxesStartPoint=M.add(M.create(),this.lowerHorizontalBoxesStartPoint,s),this.insertUpperWeldTypeIcon(this.upperHorizontalBoxesStartPoint,e),this.insertUpperContourTypeIcon(this.upperVerticalBoxesStartPoint,e),this.insertUpperFinishingIcon(this.upperVerticalBoxesStartPoint,e),this.insertQuantityToBox(Uu,this.upperVerticalBoxesStartPoint,e,t),this.insertQuantityToBox(Hu,this.upperVerticalBoxesStartPoint,e,t),this.insertLowerWeldTypeIcon(this.lowerHorizontalBoxesStartPoint,e),this.insertLowerContourTypeIcon(this.lowerVerticalBoxesStartPoint,e),this.insertLowerFinishingIcon(this.lowerVerticalBoxesStartPoint,e),this.insertQuantityToBox(Xu,this.lowerVerticalBoxesStartPoint,e,t),this.insertQuantityToBox(Zu,this.lowerVerticalBoxesStartPoint,e,t),this.annotationDisplay.startDetailFromFarSide?(this.insertQuantityToBox(ku,this.upperHorizontalBoxesStartPoint,e,t),this.insertQuantityToBox(Gu,this.upperHorizontalBoxesStartPoint,e,t),this.insertQuantityToBox(Yu,this.lowerHorizontalBoxesStartPoint,e,t),this.insertQuantityToBox(qu,this.lowerHorizontalBoxesStartPoint,e,t)):(this.insertQuantityToBox(Wu,this.upperHorizontalBoxesStartPoint,e,t),this.insertQuantityToBox(zu,this.upperHorizontalBoxesStartPoint,e,t),this.insertQuantityToBox(Ku,this.lowerHorizontalBoxesStartPoint,e,t),this.insertQuantityToBox(ju,this.lowerHorizontalBoxesStartPoint,e,t));const n=this.newEndPoint,r=i&&this.weldDisplayData.isoFlip,a=i&&!this.weldDisplayData.isoFlip;this.weldDisplayData.upperWeldType===k.RvD.NONE&&this.weldDisplayData.lowerWeldType===k.RvD.NONE||(M.dot(this.upperHorizontalBoxesStartPoint,this.extendedLeaderDirection)>M.dot(this.lowerHorizontalBoxesStartPoint,this.extendedLeaderDirection)?this.newEndPoint=M.subtract(M.create(),this.upperHorizontalBoxesStartPoint,r?this.getDeltaVectorForBoxStartPoints(this.upperHorizontalBoxesStartPoint,e):this.getOffsetVectorForBoxStartPoints(this.upperHorizontalBoxesStartPoint,e)):this.newEndPoint=M.add(M.create(),this.lowerHorizontalBoxesStartPoint,a?this.getDeltaVectorForBoxStartPoints(this.lowerHorizontalBoxesStartPoint,e):this.getOffsetVectorForBoxStartPoints(this.lowerHorizontalBoxesStartPoint,e))),this.linePoints.push(n),this.linePoints.push(this.newEndPoint);const o=this.newEndPoint;this.totalDisplayWidth=M.distance(this.startPoint,this.newEndPoint),this.createSegmentsForReferenceParameter(e),this.insertReferenceStringParameter(e);const h=(0,Yd.pf)(this.linePoints,qd.xH,this.getColor(),this.getLineWidth(),this.getLineStyle());this.annotationDisplay.renderLines(qd.Q8,qd.kQ,h,this.getColor(),e),this.createISOLine(this.getExtendedLeaderStartPoint(),o,e)}getOffsetVectorForBoxStartPoints(e,t){const i=eg.getNumber("ANNOTATION_WELD_QUANTITIES_OFFSET_PX")*this.getPixelSizeAtWorldPoint(e,t);return M.scale(M.create(),this.verticalDirection,i)}getDeltaVectorForBoxStartPoints(e,t){const i=this.getOffsetVectorForBoxStartPoints(e,t);return this.weldDisplayData.standard!==k.dXw.ISO?i:M.scale(i,this.verticalDirection,this.getDistanceBetweenLeaderAndISO(e,t))}isUpdateNeeded(){return!!this.annotationDisplay.isDragging&&(this.destroy(),this.linePoints=[],!0)}destroy(){for(const e of this.cellIdToDisplayElement.values())e.destroy()}getSidePoints(){const e=[];e.push(this.startPoint);const t=M.add(M.create(),this.startPoint,M.scale(M.create(),this.extendedLeaderDirection,this.totalDisplayWidth));return e.push(t),e}initializeBoxPointParameters(e){this.newEndPoint=this.startPoint,this.extendedLeaderDirection=this.system.xAxis.getVec3(),this.annotationDisplay.startDetailFromFarSide&&(this.extendedLeaderDirection=M.fromValues(-this.extendedLeaderDirection[0],-this.extendedLeaderDirection[1],-this.extendedLeaderDirection[2])),this.verticalDirection=this.system.yAxis.getVec3(),this.linePoints.push(this.startPoint),this.linePoints.push(this.newEndPoint),this.weldDisplayData.standard===k.dXw.ISO&&this.weldDisplayData.isoFlip?(this.upperHorizontalBoxesStartPoint=M.add(M.create(),this.newEndPoint,this.getDeltaVectorForBoxStartPoints(this.newEndPoint,e)),this.lowerHorizontalBoxesStartPoint=M.subtract(M.create(),this.newEndPoint,this.getOffsetVectorForBoxStartPoints(this.newEndPoint,e))):this.weldDisplayData.standard!==k.dXw.ISO||this.weldDisplayData.isoFlip?(this.upperHorizontalBoxesStartPoint=M.add(M.create(),this.newEndPoint,this.getOffsetVectorForBoxStartPoints(this.newEndPoint,e)),this.lowerHorizontalBoxesStartPoint=M.subtract(M.create(),this.newEndPoint,this.getOffsetVectorForBoxStartPoints(this.newEndPoint,e))):(this.upperHorizontalBoxesStartPoint=M.add(M.create(),this.newEndPoint,this.getOffsetVectorForBoxStartPoints(this.newEndPoint,e)),this.lowerHorizontalBoxesStartPoint=M.subtract(M.create(),this.newEndPoint,this.getDeltaVectorForBoxStartPoints(this.newEndPoint,e)))}insertAllAroundSymbol(e,t){const i=M.add(M.create(),e,M.scale(M.create(),this.extendedLeaderDirection,-this.boxEdgeLength/2));if(this.weldDisplayData.allAround){const e=M.add(M.create(),i,M.scale(M.create(),this.verticalDirection,-this.boxEdgeLength/2)),s=new Vu(this.annotationDisplay);s.setCellId("mbd_weld_all_around_symbol"),s.setImageId("ALL_AROUND"),s.updateTexture(e,this.extendedLeaderDirection,this.verticalDirection,!0,!1,!1,t)}}insertWeldFlags(e,t){const i=M.add(M.create(),e,M.scale(M.create(),this.extendedLeaderDirection,-this.boxEdgeLength/2));if(this.weldDisplayData.flag===k.TPE.UPPER){const e=new Vu(this.annotationDisplay);e.setCellId("mbd_weld_upper_flag"),e.setImageId("FLAG_SYMBOL"),e.updateTexture(i,this.extendedLeaderDirection,this.verticalDirection,!0,!0,!1,t)}else if(this.weldDisplayData.flag===k.TPE.LOWER){const e=new Vu(this.annotationDisplay);e.setCellId("mbd_weld_lower_flag"),e.setImageId("FLAG_SYMBOL"),e.updateTexture(i,this.extendedLeaderDirection,this.verticalDirection,!1,!0,!1,t)}}insertUpperWeldTypeIcon(e,t){if(this.weldDisplayData.upperWeldType===k.RvD.NONE)return;const i=k.jv6[this.weldDisplayData.upperWeldType],s=new Vu(this.annotationDisplay);s.setCellId("mbd_upper_weld_type_icon"),s.setImageId(i),s.updateTexture(e,this.extendedLeaderDirection,this.verticalDirection,!0,!1,!1,t),this.upperVerticalBoxesStartPoint=s.upperLeft,this.upperHorizontalBoxesStartPoint=s.lowerRight}insertUpperFinishingIcon(e,t){if(this.weldDisplayData.standard!==k.dXw.ANSI)return;if(this.weldDisplayData.upperWeldType===k.RvD.NONE||this.weldDisplayData.upperFinishing===k.GQW.NONE)return;const i=k.SYV[this.weldDisplayData.upperFinishing],s=new Vu(this.annotationDisplay);s.setCellId("mbd_upper_weld_finishing"),s.setImageId(i),s.updateTexture(e,this.extendedLeaderDirection,this.verticalDirection,!0,!1,!0,t),this.upperVerticalBoxesStartPoint=s.upperLeft}insertUpperContourTypeIcon(e,t){if(this.weldDisplayData.upperWeldType===k.RvD.NONE||this.weldDisplayData.upperContourType===k.p7j.NONE)return;const i=k.k_P[this.weldDisplayData.upperContourType],s=new Vu(this.annotationDisplay);s.setCellId("mbd_upper_weld_contour_icon"),s.setImageId(i),s.updateTexture(e,this.extendedLeaderDirection,this.verticalDirection,!0,!1,!1,t),this.upperVerticalBoxesStartPoint=s.upperLeft}insertLowerWeldTypeIcon(e,t){if(this.weldDisplayData.lowerWeldType===k.RvD.NONE)return;const i=k.jv6[this.weldDisplayData.lowerWeldType],s=new Vu(this.annotationDisplay);s.setCellId("mbd_lower_weld_type_icon"),s.setImageId(i),s.updateTexture(e,this.extendedLeaderDirection,this.verticalDirection,!1,!1,!1,t),this.lowerVerticalBoxesStartPoint=s.lowerLeft,this.lowerHorizontalBoxesStartPoint=s.upperRight}insertLowerContourTypeIcon(e,t){if(this.weldDisplayData.lowerWeldType===k.RvD.NONE||this.weldDisplayData.lowerContourType===k.p7j.NONE)return;const i=k.k_P[this.weldDisplayData.lowerContourType],s=new Vu(this.annotationDisplay);s.setCellId("mbd_lower_weld_contour_icon"),s.setImageId(i),s.updateTexture(e,this.extendedLeaderDirection,this.verticalDirection,!1,!1,!1,t),this.lowerVerticalBoxesStartPoint=s.lowerLeft}insertLowerFinishingIcon(e,t){if(this.weldDisplayData.standard!==k.dXw.ANSI)return;if(this.weldDisplayData.lowerWeldType===k.RvD.NONE||this.weldDisplayData.lowerFinishing===k.GQW.NONE)return;const i=k.SYV[this.weldDisplayData.lowerFinishing],s=new Vu(this.annotationDisplay);s.setCellId("mbd_lower_weld_finishing"),s.setImageId(i),s.updateTexture(e,this.extendedLeaderDirection,this.verticalDirection,!1,!1,!0,t),this.lowerVerticalBoxesStartPoint=s.lowerLeft}insertQuantityToBox(e,t,i,s){if(!t)return;const n=Qu.has(e),r=Ju.has(e);if(0===this.cellIdToDisplayValue.get(e))return;if(this.weldDisplayData.upperWeldType===k.RvD.NONE&&Qu.has(e))return;if(this.weldDisplayData.lowerWeldType===k.RvD.NONE&&$u.has(e))return;const a=new xd;a.isAngle=e===Hu||e===Zu;let o=Bd.getFormattedValueString(this.cellIdToDisplayValue.get(e),s,a);e!==zu&&e!==ju||(o="("+o+")"),this.cellIdToDisplayElement.get(e).setCellId(e),this.cellIdToDisplayElement.get(e).setDisplayValue(o),this.cellIdToDisplayElement.get(e).updateTexture(t,this.extendedLeaderDirection,this.verticalDirection,n,i),r?n?this.upperVerticalBoxesStartPoint=this.cellIdToDisplayElement.get(e).upperLeft:this.lowerVerticalBoxesStartPoint=this.cellIdToDisplayElement.get(e).lowerLeft:n?this.upperHorizontalBoxesStartPoint=this.cellIdToDisplayElement.get(e).lowerRight:this.lowerHorizontalBoxesStartPoint=this.cellIdToDisplayElement.get(e).upperRight}createISOLine(e,t,i){if(this.weldDisplayData.standard!==k.dXw.ISO)return;this.weldDisplayData.allAround&&(e=M.add(M.create(),e,M.scale(M.create(),this.extendedLeaderDirection,this.getAllAroundISOOffsetDistance(e,i))));const s=M.distance(e,t);let n=null;n=this.weldDisplayData.isoFlip?M.add(M.create(),e,this.getDeltaVectorForBoxStartPoints(e,i)):M.subtract(M.create(),e,this.getDeltaVectorForBoxStartPoints(e,i));const r=M.add(M.create(),n,M.scale(M.create(),this.extendedLeaderDirection,s)),a=[];a.push(n),a.push(r);const o=(0,Yd.pf)(a,qd.bU,this.getColor(),this.getLineWidth(),this.getLineStyle());(0,Yd.KZ)(this.getAnnotationISOLineStipple(),o),this.annotationDisplay.renderLines(qd.bU,qd.Nq,o,this.getColor(),i)}createSegmentsForReferenceParameter(e){if(!this.weldDisplayData.reference)return;const t=M.add(M.create(),this.extendedLeaderDirection,this.verticalDirection);M.normalize(t,t);const i=M.add(M.create(),this.extendedLeaderDirection,M.negate(M.create(),this.verticalDirection));M.normalize(i,i);const s=this.getWeldReferenceSegmentLength(this.newEndPoint,e),n=M.add(M.create(),this.newEndPoint,M.scale(M.create(),t,s)),r=M.add(M.create(),this.newEndPoint,M.scale(M.create(),i,s));this.linePoints.push(this.newEndPoint),this.linePoints.push(n),this.linePoints.push(this.newEndPoint),this.linePoints.push(r),this.newEndPoint=M.add(M.create(),this.newEndPoint,M.scale(M.create(),this.extendedLeaderDirection,s))}insertReferenceStringParameter(e){if(!this.weldDisplayData.reference)return;const t=M.add(M.create(),this.newEndPoint,M.scale(M.create(),this.verticalDirection,-this.boxEdgeLength/2));this.referenceDisplayElement.setCellId("mbd_weld_reference"),this.referenceDisplayElement.setDisplayValue(this.weldDisplayData.reference),this.referenceDisplayElement.updateTexture(t,this.extendedLeaderDirection,this.verticalDirection,!0,e)}getDistanceBetweenLeaderAndISO(e,t){return eg.getNumber("ANNOTATION_DISTANCE_BETWEEN_LEADER_AND_ISO_PX")*this.getPixelSizeAtWorldPoint(e,t)}getWeldReferenceSegmentLength(e,t){return eg.getNumber("ANNOTATION_WELD_REFERENCE_SEGMENT_LENGTH_PX")*this.getPixelSizeAtWorldPoint(e,t)}getAnnotationISOLineStipple(){return eg.getStipple("ANNOTATION_ISO_LINE_STIPPLE")}getAllAroundISOOffsetDistance(e,t){return eg.getNumber("ANNOTATION_WELD_ALL_AROUND_ISO_OFFSET_PX")*this.getPixelSizeAtWorldPoint(e,t)}}const ig=X.default.getManager();class sg extends qd.yH{constructor(e){super(e)}createDisplayPoints(e){return null}adjustLeaderPoint(e,t,i){return M.create()}createDisplayPointsForDrag(e){const t=[],i=this.getPlaneCoordinateSystem().xAxis.getVec3(),s=this.getPlaneCoordinateSystem().yAxis.getVec3();let n=M.copy(M.create(),this.getPlaneCoordinateSystem().origin.getVec3());for(let r=0;r<this.annotationDisplay.draggingLeaderPoints.length;r++){let a=M.copy(M.create(),this.annotationDisplay.draggingLeaderPoints[r]);a=this.adjustLeaderPoint(a,s,this.getPixelSizeAtWorldPoint(a,e)),t.push(n),t.push(a);const o=M.subtract(M.create(),a,n);0===r?this.setLeaderStartDirection(o):1===r&&(this.annotationDisplay.startDetailFromFarSide=M.dot(i,o)<0,this.setNextStartPoint(a),this.setExtendedLeaderStartPoint(t[1])),n=M.copy(M.create(),a)}return t}createDisplayPointsForReal(e){const t=[],i=this.getPlaneCoordinateSystem().xAxis.getVec3(),s=this.getPlaneCoordinateSystem().yAxis.getVec3();let n=this.getPlaneCoordinateSystem().origin.getVec3();for(let r=0;r<this.getAnnotationDisplayData().dxdySegments.length;r++){const a=this.getAnnotationDisplayData().dxdySegments[r].getVec2(),o=M.scale(M.create(),i,a[0]),h=M.scale(M.create(),s,a[1]),c=M.add(M.create(),o,h),l=M.add(M.create(),n,c);0===r?t.push(this.offsetBaseLeaderEnd(n,c,e)):t.push(n),t.push(l),n=l,0===r?this.setLeaderStartDirection(c):r===this.getAnnotationDisplayData().dxdySegments.length-1&&(this.annotationDisplay.startDetailFromFarSide=M.dot(i,c)<0,this.setNextStartPoint(l),this.setExtendedLeaderStartPoint(t[1]))}return t}updateView(e,t){const i=this.createDisplayPoints(e);if(0===i.length)return;const s=(0,Yd.pf)(i,qd.u5,this.getColor(),this.getLineWidth(),this.getLineStyle());this.annotationDisplay.renderLines(qd.u5,qd.Lc,s,this.getColor(),e)}getBaseHeight(e,t){return ig.getNumber("ANNOTATION_ARROW_HEIGHT_PX")*this.getPixelSizeAtWorldPoint(e,t)}offsetBaseLeaderEnd(e,t,i){const s=M.create();return M.normalize(s,t),M.scale(s,s,this.getBaseHeight(e,i)),M.add(s,s,e),s}}class ng extends sg{constructor(e){if(super(e),this.getAnnotationDisplayData()&&this.getAnnotationDisplayData().dxdySegments.length>0){const e=this.getAnnotationDisplayData().dxdySegments[0].getVec2();this.annotationDisplay.dragDistance=e[1]}}createDisplayPoints(e){const t=this.getPlaneCoordinateSystem().yAxis.getVec3(),i=this.getNextStartPoint();let s=M.create();s=this.annotationDisplay.isDragging?this.annotationDisplay.newEndPoint:M.add(M.create(),i,M.scale(M.create(),t,this.annotationDisplay.dragDistance));const n=[];return n.push(i),n.push(s),this.annotationDisplay.isDragging||this.setNextStartPoint(s),n}}class rg extends sg{constructor(e){super(e)}createDisplayPoints(e){return this.annotationDisplay.isDragging?this.createDisplayPointsForDrag(e):this.createDisplayPointsForReal(e)}adjustLeaderPoint(e,t,i){const s=this.annotationDisplay.getSideEdgeLength(i);return M.add(M.create(),e,M.scale(M.create(),t,-s/2))}}class ag extends sg{constructor(e){super(e),this.calloutDisplay=e}createDisplayPoints(e){if(!this.calloutDisplay.getClosestLabelCorner())return[];const t=this.getPlaneCoordinateSystem().origin.getVec3(),i=this.calloutDisplay.getReferenceRadius(),s=M.subtract(M.create(),this.calloutDisplay.getClosestLabelCorner(),t);if(this.calloutDisplay.setLeaderStartDirection(s),M.length(s)<Ri.W.ZERO_LENGTH)return[];M.normalize(s,s);const n=M.scaleAndAdd(M.create(),t,s,i);return[this.offsetBaseLeaderEnd(n,s,e),this.calloutDisplay.getClosestLabelCorner(),this.calloutDisplay.getClosestLabelCorner(),this.calloutDisplay.getFurthestLabelCorner()]}}class og extends sg{constructor(e){super(e)}adjustLeaderPoint(e,t){return e}createDisplayPoints(e){return this.annotationDisplay.isDragging?this.createDisplayPointsForDrag(e):this.createDisplayPointsForReal(e)}}const hg=X.default.getManager(),cg=new Gi.hF({primitiveType:Ai.MX.POINTS,isPickable:!0,isShowThrough:!0,isDepthTested:!1});class lg extends Cd{constructor(e,t,i,s){super(lg.getEdgePointLocation(s,t,i),e,hg.getColor("POINT_BODY_COLOR"),hg.getNumber("POINT_BODY_SIZE"),s,cg),this.parameter=i,this.selectionId=t.selectionId;let n=lg.getEdgePointLocation(s,t,i);const r=t.getEntityMetaData();if(this.entityMetaData=r.clone(),this.entityMetaData.setBodyMetaData(r.getBodyMetaData()),n){const e=new k.DT1;e.point=new Float32Array(3);for(let t=0;t<3;++t)e.point[t]=n[t];this.entityMetaData.geometries=[e]}else if(1===r.geometries.length&&r.geometries[0]instanceof k.DT1){const e=r.geometries[0];n=M.clone(e.point),this.entityMetaData.geometries=r.geometries}this.setStyle(hg.getPointFont("POINT_BODY_FONT")),n&&this.show()}static getEdgePointLocation(e,t,i){let s=null;const n=t.getEntityMetaData();let r=null;if(e.getIsForPreviousVersionDisplay()?r=e.getModelViewManagers().getManager().extractMeshIncrement(t.getDeterministicId()):n&&(r=n.getMeshIncrement()),!r&&n.isFromSketch()&&(r=e.getModelViewManagers().getManager().extractMeshIncrement(t.getDeterministicId())),r){s=M.create();const n=r.getLinesLength(),a=r.getPositionAtDistanceAlongLines(n*i),o=e.getModelViewManagers().getManager().getDisplayedPartStudio();if(o){const i=o.getSheetMetalTransform(t,e);ge.w$.multiplyVec3(i,a,s)}}return s}getModelSelection(e){return new Me.Y1(k.lQt.EDGE_POINT,this.selectionId,null,{sourcePick:e.sourcePick,entityMetaData:this.entityMetaData})}getClearModelSelectionsOnPrehilite(){return!1}addHighlight(e){this.addHighlightToIncrement(Cd.INCREMENT_ID,e),(0,Xs.vm)()}removeHighlight(e){return this.removeHighlightFromIncrement(Cd.INCREMENT_ID,e),(0,Xs.vm)(),!0}}class dg extends m.T{constructor(e){super(),this.viewer=e,this.cullableBodies=[],this.microversionIdAndConfiguration=null,(0,Sh.Yk)(e)}getViewer(){return this.viewer}getMicroversionIdAndConfiguration(){return this.microversionIdAndConfiguration}getUIElementsForSelection(e){return[]}getEntityIdsForSelection(e){return[]}getOccurrenceEntityIdsForHighlight(e){return[]}getInContextImportEntityIdsForSelection(e){return[]}getOccurrencesForSelection(e){return[]}callOnChildSelections(e,t){let i=[];if(t.childSelections)for(let s=0;s<t.childSelections.length;s++)i=i.concat(e.call(this,t.childSelections[s]));return i}getBoundsOutsideElementNode(){return null}getBodyBounds(e,t){return null}getBodyComponent(e){return null}populateClientCacheStateDisplayInformation(e){}checkDuplicatedMicroversionIdAndConfiguration(e,t){return!e.find((function(e){return e.equals(t)}))}getElementType(){return k.GNh.UNKNOWN}}var ug=i(66724),gg=i(66023);const pg=_e.O.createLogger("Assembly",k.bVy.GRAPHICS),mg=X.default.getManager();class fg{constructor(){this.boundingSphere=null,this.lod=null,this.cullingState=null}}class Ig extends dg{constructor(e,t,i){super(i),this.elementId=e,this.elementAccessor=t,this.occurrences={},this.occurrencePrefixToLeaves={},this.mateConnectorData={},this.mateConnectorGraphics={},this.mateIndicatorData=new Map,this.mateIndicatorGraphics={},this.occurrenceMateIndicators={},this.originDisplayData=null,this.originGraphics=null,this.isHidden_=!0,this.isForInContext=!1,this.cachedOccurrenceState={},this.fullElementIdToOccurrence=new Gl.TemplatedNestedMap,this.ownerToInstanceMateIndicatorIds=new Map,this.mateIndicatorOwnerInstanceIds=new Map,this.mateConnectorMateIndicatorIds=new Map,this.mateIndicatorMateConnectorIds=new Map,this.occurrenceMateConnectors=new Gl.TemplatedNestedMap,this.ensureRootOccurrenceDisplayData(),gd(i),this.loadDisplayManager=new Np(i)}onDeletion(){this.reset(),this.loadDisplayManager.remove()}getUsedPartStudioIds(e){e.addAll(this.fullElementIdToOccurrence.getKeys())}populateClientCacheStateDisplayInformation(e){if(this.microversionIdAndConfiguration){const t=e.getOrCreateElementDataList(this.elementId,k.D3B.DISPLAY_DATA);this.checkDuplicatedMicroversionIdAndConfiguration(t,this.microversionIdAndConfiguration)?t.push(this.microversionIdAndConfiguration):pg.warn("Found duplicated assembly microversion id and configuration "+this.microversionIdAndConfiguration)}}getIdOccurrenceNodeId(e,t){return(0,Tn.vm)(e,t)}getMateConnectorGraphicsForSelection(e){let t=[];if(e.isMateConnector()){const i=this.getMateConnectorGraphics(e.getOccurrence(),e.getIdString());i&&t.push(i)}else if(e.childSelections)for(let i=0;i<e.childSelections.length;i++){const s=e.childSelections[i];s.isMateConnector()&&(t=t.concat(this.getMateConnectorGraphicsForSelection(s)))}return t}getMateIndicatorGraphics(e,t){let i=this.mateIndicatorGraphics[e];if(!i){const s=this.mateIndicatorData.get(e);s&&(i=this.updateMateIndicatorGraphicsAndOccurrences(s,t))}return i}getMateIndicatorForSelection(e){const t=[];if(e.isMate()){const i=!0,s=this.getIdOccurrenceNodeId(e.getOccurrence(),e.getIdString()),n=this.getMateIndicatorGraphics(s,i);n&&t.push(n)}return t}getEntitiesForNonInstanceSelection(e){let t=[];const i=function(e,i){for(let s=0;s<i.length;++s)if(i[s]===k.AuL.ORIGIN_ID&&e.isRoot()){const i=(0,gg.Az)(e);t.push(i)}else t.push(new Me.Y1(k.lQt.ENTITY,i[s],e))};if(e.isMateConnector()){const t=this.getIdOccurrenceNodeId(e.getOccurrence(),e.getIdString()),s=this.mateConnectorData[t];s&&i(s.occurrence,s.entityIds)}else if(e.isSimulationLoad()){const t=this.loadDisplayManager.getDisplayDataForSelection(e);t&&i(t.occurrence,t.faceLoadDeterministicIds)}else if(e.isGeometryMate()){const t=this.getIdOccurrenceNodeId(e.getOccurrence(),e.getFeatureId()),s=(0,j.as)(k.z1E,this.mateIndicatorData.get(t));s&&(s.firstDeterministicId&&i(s.firstOccurrence,[s.firstDeterministicId]),s.secondDeterministicId&&i(s.secondOccurrence,[s.secondDeterministicId]))}else e.isMate()?t=this.callOnChildSelections(this.getEntitiesForNonInstanceSelection,e):e.isEntity()&&t.push(e);return t}getMateConnectorGraphics(e,t,i){const s=this.getIdOccurrenceNodeId(e,t),n=this.mateConnectorData[s];let r=null;if(n){if(r=this.mateConnectorGraphics[s],!r){const e=this.occurrences[n.occurrence.getPathAsString()];e&&(r=this.updateMateConnectorOccurrence(n,e,!i))}}else this.fullElementIdToOccurrence.each(((i,s)=>{const n=this.elementAccessor.getPartStudio(s);if(n&&(r=n.getMateConnectorGraphics(e,t),r))return!0}),this);return r}getMateConnectorData(e,t){const i=this.getIdOccurrenceNodeId(e,t);let s=this.mateConnectorData[i];return s||this.fullElementIdToOccurrence.each(((i,n)=>{const r=this.elementAccessor.getPartStudio(n);if(r&&(s=r.getMateConnectorData(e,t),s))return!0}),this),s}getUIElementsForSelection(e){let t=[];if(e.isMateConnector())t=this.getMateConnectorGraphicsForSelection(e);else if(e.isSimulationLoad())t=this.loadDisplayManager.getUiElementsForSelection(e);else if(e.isMate())t=this.getMateIndicatorForSelection(e),0===t.length&&(t=this.callOnChildSelections(this.getUIElementsForSelection,e));else if(e.isMateRelation())t=this.callOnChildSelections(this.getUIElementsForSelection,e);else if(e.isFeature()&&e.getIdString()===k.AuL.ORIGIN_ID&&this.originGraphics&&t.push(this.originGraphics),e.getOccurrence()&&(e.isFromSketch()||e.isFromBody()||e.isOccurrence()||e.isAssemblyOrigin())){const i=ug.m.getCommandToolbarModel(),s=!!i&&i.inShowMatesOnSelectionMode;es.Jq.ExplodedViewsService.inExplodedViewMode()||!s&&1!==mg.getNumber("OCCURRENCE_MATE_HIGHLIGHT")&&!es.Jq.NamedPositionPaneService.getIsInNamedPositionEditMode()||t.push.apply(t,this.getMateIndicatorsForOccurrence(e.getOccurrence()))}return t}getEntityIdsForSelection(e){let t=[];const i=e.getOccurrence();if(i){const s=this.occurrences[i.getPathAsString()];if(s){const i=this.elementAccessor.getPartStudio(s.fullElementId);i&&(t=i.getEntityIdsForSelection(e))}}return t}getOccurrenceEntityIdsForHighlight(e){let t=[];if(e){const i=this.occurrences[e.getPathAsString()];if(i){const s=this.elementAccessor.getPartStudio(i.fullElementId);s&&(t=t.concat(s.getOccurrenceEntityIdsForHighlight(e)))}}return t}getOccurrencesForSelection(e){let t=[];if(e.isMateConnector()){const i=this.getMateConnectorGraphicsForSelection(e);for(let e=0;e<i.length;++e)t.push(i[e].getOccurrence())}else if(e.isSimulationLoad()){const i=this.loadDisplayManager.getDisplayDataForSelection(e);i&&0===i.faceLoadDeterministicIds.length&&t.push(i.occurrence)}else e.isMate()||e.isMateRelation()||e.isNonGeometricItem()||e.isExplodeStep()||e.isFolder()?t=this.callOnChildSelections(this.getOccurrencesForSelection,e):e.getOccurrence()&&!e.isFeature()&&t.push(e.getOccurrence());return t}getDisplayDataForOccurrencePath(e){return this.occurrences[e]||null}hide(){if(this.isHidden_)return;const e=new Ih.B7("bt.graphics.assembly.Assembly.prototype.hide");for(const e in this.mateConnectorGraphics)this.mateConnectorGraphics[e].remove();this.mateConnectorGraphics={},this.removeAllMateIndicators();for(const e in this.occurrences)this.removeOccurrenceFromPartStudio(this.occurrences[e],!1);this.removeOriginGraphics(),this.loadDisplayManager.hide(),this.isHidden_=!0,e.report()}show(e){if(!this.isHidden_)return;const t=new Ih.B7("bt.graphics.assembly.Assembly.prototype.show",LD());this.isHidden_=!1;let i=new Ih.B7("Updating occurrences");for(const e in this.occurrences)this.addOrUpdateOccurrence(this.occurrences[e]);i.report(),i=new Ih.B7("Updating mate indicators");for(const e of this.mateIndicatorData.values())this.updateMateIndicatorGraphicsAndOccurrences(e);i.report(),this.createOriginGraphics(),this.loadDisplayManager.show(),e||this.viewer.setSuppressNonIsolatedPicks(!0),t.report()}get isHidden(){return this.isHidden_}getMateIndicatorData(e){return this.mateIndicatorData.get(e)}createOriginGraphics(){this.removeOriginGraphics(),this.isHidden_||!this.originDisplayData||this.isForInContext||(this.originGraphics=new Xc(this.originDisplayData,this.viewer))}removeOriginGraphics(){this.originGraphics&&(this.originGraphics.remove(),this.originGraphics=null)}reset(){let e;for(e in this.occurrences)this.removeOccurrenceFromPartStudio(this.occurrences[e],!1);this.occurrences={},this.fullElementIdToOccurrence.clear();for(const e in this.mateConnectorGraphics)this.mateConnectorGraphics[e].remove();for(const e in this.mateIndicatorGraphics)this.mateIndicatorGraphics[e].remove();this.mateConnectorGraphics={},this.mateConnectorData={},this.mateIndicatorData=new Map,this.mateIndicatorGraphics={},this.occurrenceMateIndicators={},this.occurrenceMateConnectors.clear(),this.cullableBodies=[],this.occurrencePrefixToLeaves={},this.removeOriginGraphics(),this.originDisplayData=null,this.ownerToInstanceMateIndicatorIds.clear(),this.mateIndicatorOwnerInstanceIds.clear(),this.mateConnectorMateIndicatorIds.clear(),this.mateIndicatorMateConnectorIds.clear(),this.ensureRootOccurrenceDisplayData(),this.loadDisplayManager.reset()}processSingleOccurrenceDeletion(e,t,i){if(e){let s=e;i&&e.fullElementId.equals(i.buildFullElementId(!0))&&(s=(0,j.shallowClone)(e),s.fullElementId=i.buildFullElementId(!1)),this.removeOccurrenceFromPartStudio(s,!0),this.removeOccurrenceElementAssociation(e),delete this.occurrences[t]}}processOccurrenceDeletions(e,t){let i;for(i=0;i<e.deletedOccurrences.length;++i)this.removeOccurrence(e.deletedOccurrences[i],t);if(!e.incremental){const e=Object.keys(this.occurrences);for(i=0;i<e.length;i++){const s=e[i],n=this.occurrences[s];this.processSingleOccurrenceDeletion(n,s,t)}}for(i=0;i<e.occurrences.length;++i){const s=e.occurrences[i];if(!s||!s.occurrenceData)continue;const n=s.occurrenceData.occurrence.toString(),r=this.occurrences[n];if(r){const i=e.getPartStudioDisplayDataForMicroversion(s.fullElementId),a=!t||e.partStudioDisplayData.length>0,o=i?i.buildFromFullElementId():s.fullElementId,h=!!i&&i.keepFromMicroversion,c=!r.fullElementId.equals(o)||h,l=r.sketchFeatureId!==s.sketchFeatureId||r.partIds.some((function(e){return s.partIds.indexOf(e)<0}));(c||l)&&a?this.processSingleOccurrenceDeletion(r,n,t):this.removeOccurrenceElementAssociation(r)}}}processDisplayData(e){const t=new Ih.B7("Assembly.prototype.processDisplayData",LD());if(this.elementId!==e.elementId)return void pg.warn("Tried to update a graphics assembly with data corresponding to the wrong element id");let i,s;for(e.incremental||this.reset(),this.isForInContext=e.isForInContext,i=0;i<e.occurrences.length;++i)if(e.occurrences[i]){const t=e.occurrences[i],s=!0;this.addOrUpdateOccurrence(t,s)}for(i=0;i<e.mateConnectors.length;++i)if(e.mateConnectors[i]){const t=e.mateConnectors[i];this.updateMateConnector(t)}for(i=0;i<e.occurrences.length;++i)if(e.occurrences[i]){const t=e.occurrences[i];this.updateMateIndicators(t)}for(e.originDisplayData?this.originDisplayData=e.originDisplayData:e.incremental||pg.warn("Null originDisplayData in non-incremental BTRootAssemblyDisplayData"),this.createOriginGraphics(),i=0;i<e.mates.length;++i){const t=e.mates[i];t&&this.updateMateIndicator(t)}for(i=0;i<e.assemblyFeatures.length;++i){const t=e.assemblyFeatures[i];t&&this.updateMateIndicator(t)}for(i=0;i<e.deletedMateIds.length;++i)s=e.deletedMateIds[i],this.removeMateWithId(s);for(i=0;i<e.deletedAssemblyFeatures.length;++i)s=e.deletedAssemblyFeatures[i],this.removeMateWithId(s);for(i=0;i<e.deletedMateConnectorIds.length;++i)s=e.deletedMateConnectorIds[i],this.removeMateConnectorWithId(s);for(i=0;i<e.mateGroups.length;++i){const t=e.mateGroups[i];t&&this.updateMateIndicator(t)}for(i=0;i<e.deletedMateGroupIds.length;++i)s=e.deletedMateGroupIds[i],this.removeMateWithId(s);for(i=0;i<e.geometryMates.length;++i){const t=e.geometryMates[i];t&&this.updateMateIndicator(t)}for(i=0;i<e.deletedGeometryMateIds.length;++i)s=e.deletedGeometryMateIds[i],this.removeMateWithId(s);this.loadDisplayManager.processUpdates(e,!this.isHidden_),t.report()}ensureRootOccurrenceDisplayData(){const e=k.yLM.createRootOccurrenceDisplayData(this.elementId);this.addOrUpdateOccurrence(e)}addOrUpdateOccurrence(e,t){const i=e.getOccurrenceId(),s=this.occurrences[i];if(this.occurrences[i]=e,this.addOccurrenceElementAssociation(e),!this.isHidden){const t=this.viewer.getOccurrenceIdManager().getOrCreateIdForName(i);this.viewer.getOccurrenceDataManager().setOccurrenceTransform(t,e.occurrenceData.transform.getGlMatrix());const n=this.elementAccessor.getPartStudio(e.fullElementId);n&&n.addOrUpdateOccurrence(t,e,!0),this.updateMateConnectorsForOccurrence(e),s&&s.isHidden===e.isHidden||this.trigger("OCCURRENCE_VISIBILITY_CHANGE."+i,e.isHidden?Xs.EE.HIDDEN:Xs.EE.VISIBLE)}this.addOccurrenceToPrefixMap(e.occurrenceData.occurrence),t||this.updateMateIndicators(e),this.trigger("OCCURRENCE_DATA_CHANGE."+i)}updateMateIndicators(e){const t=e.occurrenceData.occurrence.getPathAsString();this.updateOccurrenceMateIndicator(t)}updateUniqueMateIndicators(e){if(0===e.length)return;const t=[];e.forEach((e=>{const i=e.occurrenceData.occurrence.getPathAsString(),s=this.occurrenceMateIndicators[i];if(s)for(const e in s){if(t.includes(e))continue;t.push(e);const i=s[e].getDefinition();i&&this.updateMateIndicator(i)}}),this)}updateOccurrenceTransform(e,t){const i=[];i.push({pathId:e,transform:t}),this.batchUpdateOccurrenceTransforms(i)}batchUpdateOccurrenceTransforms(e){if(0===e.length)return!0;const t=[];if(!e.every((e=>{if(!this.occurrences)return pg.warn("No occurrences property for this path transform pair."),!1;const i=this.occurrences[e.pathId],s=this.viewer.getOccurrenceIdManager().getOrCreateIdForName(e.pathId);if(!i||s===TE.Qy)return pg.warn('bad occurrence display data for pathId "'+e.pathId+'", graphics ID "'+s+'".'),!1;if(!this.isHidden_){const n=i.occurrenceData.transform.getGlMatrix();t.push({displayData:i,transform:n}),i.occurrenceData&&i.occurrenceData.transform&&i.occurrenceData.transform.updateFromGlMatrix(e.transform),e.transform&&this.viewer.getOccurrenceDataManager().setOccurrenceTransform(s,e.transform);const r=this.elementAccessor.getPartStudio(i.fullElementId);if(r){const e=!0;r.addOrUpdateOccurrence(s,i,e)}}return!0}),this))return!1;const i=t.map((function(e){return e.displayData}));return this.updateUniqueMateIndicators(i),i.forEach(Ig.prototype.updateMateConnectorsForOccurrence,this),t.forEach((function(e){e.displayData.occurrenceData.transform.updateFromGlMatrix(e.transform)})),!0}getOccurrenceDisplayData(e){return e&&this.occurrences[e.getPathAsString()]||null}addOccurrenceElementAssociation(e){this.fullElementIdToOccurrence.insertNested(e.fullElementId.toString(),e.getOccurrenceId(),!0)}removeOccurrenceElementAssociation(e){this.fullElementIdToOccurrence.removeNested(e.fullElementId.toString(),e.getOccurrenceId())}removeOccurrence(e,t){const i=e.getPathAsString(),s=this.occurrences[i];s&&(this.processSingleOccurrenceDeletion(s,i,t),this.removeMateConnectorsForOccurrence(s),this.removeOccurrenceFromPrefixMap(s.occurrenceData.occurrence),this.updateOccurrenceMateIndicator(i)),this.trigger("OCCURRENCE_DELETED."+i)}removeOccurrenceFromPartStudio(e,t){if(!e||this.isHidden_)return;const i=this.elementAccessor.getPartStudio(e.fullElementId),s=e.getOccurrenceId(),n=this.viewer.getOccurrenceIdManager().getIdForName(s);i&&n!==TE.Qy&&i.removeOccurrence(n,t),this.viewer.getOccurrenceDataManager().destroyOccurrenceData(n),this.viewer.getOccurrenceIdManager().removeName(s)}getOccurrenceData(e){const t=this.occurrences[e];return t||null}getMateConnectorsForOccurrence(e){const t=[],i=this.occurrenceMateConnectors.get(e.getPathAsString());return i&&i.each((function(e,i){return t.push(e),!1}),this),t}getMateConnectorGraphicsForOccurrence(e,t){let i=[];const s=this.getMateConnectorsForOccurrence(e),n=this;for(let e=0;e<s.length;++e){const n=this.getMateConnectorGraphics(s[e].ownerOccurrence,s[e].nodeId,t);n&&(i=i.concat(n))}return this.fullElementIdToOccurrence.each((function(t,s){const r=n.elementAccessor.getPartStudio(s);return r&&function(t){i=i.concat(t.getAllMateConnectorGraphics(e))}(r),!1})),i}getMateConnectorIdsForOccurrence(e,t){const i=[];return Object.entries(this.mateConnectorData).forEach((function([s,n]){!(0,Tn.wB)(e,n.ownerOccurrence)||t&&n.implicit||i.push({Id:n.nodeId,isPartStudio:!1})})),i}getHideableSketchOccurrences(){const e=[];for(const t in this.occurrences){const i=this.occurrences[t];!i.isHidden&&i.displayedSketchEntityIds&&e.push(i.occurrenceData.occurrence)}return e}getSketchImagesForOccurrence(e){const t=this.getDisplayDataForOccurrence(e);if(!t)return[];const i=this.elementAccessor.getPartStudio(t.fullElementId);if(!i)return[];const s=this.viewer.getOccurrenceIdManager().getIdForName(e.getPathAsString());return i.getImageComponent().getDisplaysForOccurrence(s)}getInstanceMateIndicatorIdsFromOwner(e,t){const i=this.ownerToInstanceMateIndicatorIds.get(e);return i?i.get(t):void 0}getMateIndicatorsForOccurrence(e,t){const i=[],s=e.getTailNodeId();let n=e.getOccurrenceWithoutTail();!n.isRoot()&&k.s5W.isOutputInstanceNodeId(s)&&(n=n.getOccurrenceWithoutTail());const r=this.getInstanceMateIndicatorIdsFromOwner(n.getPathAsString(),s);for(const e of new Set(r)){const s=this.getMateIndicatorGraphics(e,!t);s&&i.push(s)}return i}hasMateIndicatorForOccurrence(e){let t=e.getOccurrenceWithoutTail();const i=e.getTailNodeId();!t.isRoot()&&k.s5W.isOutputInstanceNodeId(i)&&(t=t.getOccurrenceWithoutTail());const s=this.ownerToInstanceMateIndicatorIds.get(t.getPathAsString());if(s){const e=s.get(i);return!!e&&e.size>0}return!1}updateMateConnector(e){const t=this.getIdOccurrenceNodeId(e.ownerOccurrence,e.nodeId),i=this.mateConnectorData[t];i&&((0,Tn.wB)(i.occurrence,e.occurrence)||this.removeMateConnectorWithId(t)),this.mateConnectorData[t]=e;const s=e.occurrence.getPathAsString();this.occurrenceMateConnectors.insertNested(s,e.nodeId,e);const n=this.occurrences[s];this.updateMateConnectorOccurrence(e,n),this.updateMateConnectorMateIndicator(t)}updateMateConnectorMateIndicator(e){const t=this.mateConnectorMateIndicatorIds.get(e);if(t)for(const e of new Set(t).values()){const t=this.mateIndicatorData.get(e);t&&this.updateMateIndicator(t)}}updateOccurrenceMateIndicator(e){const t=this.occurrenceMateIndicators[e];if(t)for(const e in t)if(t[e]){const i=t[e].getDefinition();this.updateMateIndicator(i)}}shouldMateIndicatorBeRecreated(e){const t=this.getIdOccurrenceNodeId(e.ownerOccurrence,e.nodeId),i=this.mateIndicatorData.get(t);if(i&&e&&i.status===e.status&&i.getClassId()===e.getClassId()&&i.hidden===e.hidden&&(0,Qs.Z)(i.getMateConnectorIds(),e.getMateConnectorIds())&&(0,Qs.Z)(i.getOccurrenceIds(),e.getOccurrenceIds())){if(e instanceof k.Zdq&&i instanceof k.Zdq&&i.mateType!==e.mateType)return!0;const s=this.mateIndicatorGraphics[t];return!(!s||0!==s.mateIndicatorComponents.length)}return!0}updateMateIndicator(e){const t=this.getIdOccurrenceNodeId(e.ownerOccurrence,e.nodeId);this.shouldMateIndicatorBeRecreated(e)&&this.removeMateWithId(t),this.mateIndicatorData.set(t,e),this.updateMateIndicatorGraphicsAndOccurrences(e)}separateOccurrenceAndFeatureId(e){const t=new k._oC;let i=!1,s="";const n=e.split(k._oC.OCCURRENCE_PATH_SEPARATOR);if(n.length>0)do{s=s?n.pop()+k._oC.OCCURRENCE_PATH_SEPARATOR+s:n.pop(),t.path=n,i=this.occurrences.hasOwnProperty(t.getPathAsString())}while(!i&&n.length>0);return i?{occurrence:t,featureId:s}:null}updateMateIndicatorGraphicsAndOccurrences(e,t){if(this.isHidden_)return null;const i=this.getIdOccurrenceNodeId(e.ownerOccurrence,e.nodeId),s=!!!this.mateIndicatorGraphics[i]&&!t&&e.hidden;let n=null,r=null;const a=[];let o=null;if(e instanceof k.Zdq){const t=[],h=e.mateConnectorIds.length;o=e.mateConnectorIds;for(let i=0;i<h;++i){const s=this.separateOccurrenceAndFeatureId(e.mateConnectorIds[i]);if(!s)continue;const n=this.getMateConnectorData(s.occurrence,s.featureId);n&&(t.push(n),a.push(n.occurrence.getPathAsString()))}if(r=this.mateIndicatorGraphics[i],r){const e=r.getDefinitionOccurrenceIds(),s=(0,Qs.Z)(e,a);if(r.updateMateConnectorDisplayData(t),s)return r;this.removeOccurrenceMateIndicatorMapping(i,e),n=r}else s||(n=Kp(t,e,this.viewer))}else if(e instanceof k.IuU){const t=[],o=e.occurrenceIds.length,h=[];for(let i=0;i<o;++i){a.push(e.occurrenceIds[i]);const s=this.occurrences[e.occurrenceIds[i]];s&&(t.push(s),h.push(e.occurrenceIds[i]))}if(r=this.mateIndicatorGraphics[i],r){const e=r.getDefinitionOccurrenceIds(),s=(0,Qs.Z)(e,a);if(r.updateOccurenceDisplayData(t),s)return r;this.removeOccurrenceMateIndicatorMapping(i,e),n=r}else s||(n=new Xp(t,e,this.viewer))}else if(e instanceof k.z1E)if(r=this.mateIndicatorGraphics[i],a.push(e.firstOccurrence.getPathAsString()),a.push(e.secondOccurrence.getPathAsString()),r){const t=r.getDefinitionOccurrenceIds(),s=(0,Qs.Z)(t,a);if(r.updateMateIndicatorDefinition(e),s)return r;this.removeOccurrenceMateIndicatorMapping(i,t),n=r}else s||(n=new Zp(e,this.viewer));else if(e instanceof k.ZQK){const t=[];o=e.mateConnectorIds;for(let i=0;i<e.mateConnectorIds.length;++i){const s=this.separateOccurrenceAndFeatureId(e.mateConnectorIds[i]);if(!s)continue;const n=this.getMateConnectorData(s.occurrence,s.featureId);n&&(t.push(n),a.push(n.occurrence.getPathAsString()))}if(r=this.mateIndicatorGraphics[i],r){const s=r.getDefinitionOccurrenceIds(),o=(0,Qs.Z)(s,a);if(r.updateMateIndicatorDefinition(e),r.updateMateConnectorDisplayData(t),o)return r;this.removeOccurrenceMateIndicatorMapping(i,s),n=r}else s||(n=new Yp(t,e,this.viewer))}if(0===a.length)this.removeMateGraphicsWithId(i);else if(n){this.mateIndicatorGraphics[i]=n;const e=n.getDefinitionOccurrenceIds();for(let t=0;t<e.length;++t)this.addOccurrenceMateIndicator(e[t],i,n)}this.removeMappingsForMateIndicator(i);for(let t=0;t<a.length;++t){let s=e.ownerOccurrence;e.isDerivedFeature&&(s=s.getOccurrenceWithoutTail()),this.addOwnerOccurrenceMateIndicatorMapping(a[t],i,s)}if(o)for(let e=0;e<o.length;++e)this.addMateConnectorMateIndicatorMapping(o[e],i);return n}addOwnerOccurrenceMateIndicatorMapping(e,t,i){const s=e.split(k._oC.OCCURRENCE_PATH_SEPARATOR).slice(i.path.length);let n="";s.length>0&&(n=s.length>1&&k.s5W.isOutputInstanceNodeId(s[1])?s[1]:s[0]);const r=i.getPathAsString();let a=this.ownerToInstanceMateIndicatorIds.get(r);a||(a=new Map,this.ownerToInstanceMateIndicatorIds.set(r,a));let o=a.get(n);o||(o=new Set,a.set(n,o)),o.add(t);let h=this.mateIndicatorOwnerInstanceIds.get(t);h||(h=[],this.mateIndicatorOwnerInstanceIds.set(t,h)),h.push({owner:r,instance:n})}addMateConnectorMateIndicatorMapping(e,t){let i=this.mateConnectorMateIndicatorIds.get(e);i||(i=new Set,this.mateConnectorMateIndicatorIds.set(e,i)),i.add(t);let s=this.mateIndicatorMateConnectorIds.get(t);s||(s=new Set,this.mateIndicatorMateConnectorIds.set(t,s)),s.add(e)}removeMappingsForMateIndicator(e){const t=this.mateIndicatorOwnerInstanceIds.get(e);t&&t.forEach((t=>{const i=this.ownerToInstanceMateIndicatorIds.get(t.owner);if(i){const s=i.get(t.instance);s&&(s.delete(e),0===s.size&&i.delete(t.instance)),0===i.size&&this.ownerToInstanceMateIndicatorIds.delete(t.owner)}})),this.mateIndicatorOwnerInstanceIds.delete(e);const i=this.mateIndicatorMateConnectorIds.get(e);i&&i.forEach((t=>{const i=this.mateConnectorMateIndicatorIds.get(t);i&&(i.delete(e),0===i.size&&this.mateConnectorMateIndicatorIds.delete(t))})),this.mateIndicatorMateConnectorIds.delete(e)}updateMateConnectorsForOccurrence(e){const t=this.getMateConnectorsForOccurrence(e.occurrenceData.occurrence);for(let i=0;i<t.length;++i)this.updateMateConnectorOccurrence(t[i],e)}removeMateConnectorWithId(e){const t=this.mateConnectorData[e];t&&(delete this.mateConnectorData[e],this.occurrenceMateConnectors.removeNested(t.occurrence.getPathAsString(),t.nodeId),this.removeMateConnectorOccurrenceFromIds(t.nodeId,t.ownerOccurrence),this.updateMateConnectorMateIndicator(e),this.loadDisplayManager.processDeletedMateConnector(e))}removeOccurrenceMateIndicatorMapping(e,t){const i=this.mateIndicatorGraphics[e];if(i){t=t||i.getDefinitionOccurrenceIds();for(let i=0;i<t.length;++i)this.removeOccurrenceMateIndicator(t[i],e)}}removeMateGraphicsWithId(e){const t=this.mateIndicatorGraphics[e];t&&(this.removeOccurrenceMateIndicatorMapping(e),t.remove(),delete this.mateIndicatorGraphics[e])}removeMateWithId(e){this.removeMateGraphicsWithId(e),this.removeMappingsForMateIndicator(e),this.mateIndicatorData.delete(e)}removeMateConnectorsForOccurrence(e){const t=this.getMateConnectorsForOccurrence(e.occurrenceData.occurrence);for(let e=0;e<t.length;++e)this.removeMateConnectorOccurrenceFromIds(t[e].nodeId,t[e].ownerOccurrence)}updateMateConnectorOccurrence(e,t,i){if(this.isHidden_)return null;const s=this.getIdOccurrenceNodeId(e.ownerOccurrence,e.nodeId);let n=this.mateConnectorGraphics[s];return n||i||!(t&&t.isHidden||e.hidden)?(n?n.updateDefinition(e):this.mateConnectorGraphics[s]=n=new xl(e,uh.lL,this.viewer),t?(n.setOccurrenceTransform(t.occurrenceData.transform.getGlMatrix()),n.updateOccurrenceVisibility(t.isHidden?Xs.EE.HIDDEN:Xs.EE.VISIBLE),n.setIsParentOccurrenceDataMissing(!1)):n.setIsParentOccurrenceDataMissing(!0),n):null}removeMateConnectorOccurrenceFromIds(e,t){const i=this.getIdOccurrenceNodeId(t,e),s=this.mateConnectorGraphics[i];s&&(s.remove(),delete this.mateConnectorGraphics[i])}removeAllMateIndicators(){for(const e in this.mateIndicatorGraphics)this.mateIndicatorGraphics[e].remove();this.occurrenceMateIndicators={},this.mateIndicatorGraphics={}}addOccurrenceMateIndicator(e,t,i){e in this.occurrenceMateIndicators||(this.occurrenceMateIndicators[e]={}),this.occurrenceMateIndicators[e][t]=i;const s=this.viewer.getIsolatedOccurrenceManager().getAffectedPartIdsOrOccurrences();if(s&&s.length>0)for(let t=0;t<s.length;t++)s[t].getPathAsString()===e&&i.getOccurrenceData().setIsolated(!0)}removeOccurrenceMateIndicator(e,t){e in this.occurrenceMateIndicators&&this.occurrenceMateIndicators[e][t]&&delete this.occurrenceMateIndicators[e][t]}getDisplayDataForOccurrence(e){return e&&this.occurrences[e.getPathAsString()]||null}getOccurrenceVisibility(e){const t=this.getDisplayDataForOccurrence(e);return!t||t.isHidden?Xs.EE.HIDDEN:Xs.EE.VISIBLE}addOrRemoveOccurrenceInPrefixMap(e,t){const i=e.getPathAsString();for(let s=0;s<e.path.length;s++){const n=e.path.slice(0,s+1).join(".");this.occurrencePrefixToLeaves[n]||(this.occurrencePrefixToLeaves[n]=new mt.StringSet),t?this.occurrencePrefixToLeaves[n].add(i):this.occurrencePrefixToLeaves[n].remove(i)}}addOccurrenceToPrefixMap(e){this.addOrRemoveOccurrenceInPrefixMap(e,!0)}removeOccurrenceFromPrefixMap(e){this.addOrRemoveOccurrenceInPrefixMap(e,!1)}getLeafOccurrencesContainedWithinOccurrence(e){const t=[];if(e)if(e.isAssemblyRoot())(0,lt.Z)(this.occurrences,(e=>t.push(e.occurrenceData.occurrence)));else{const i=this.occurrencePrefixToLeaves[e.getPathAsString()];i&&i.each((e=>{const i=this.occurrences[e];i&&i.occurrenceData&&t.push(i.occurrenceData.occurrence)}))}return t}getOccurrenceBounds(e){const t=this.getLeafOccurrencesContainedWithinOccurrence(e);let i=null;return t.forEach((e=>{const t=this.viewer.getOccurrenceIdManager().getIdForName(e.getPathAsString()),s=this.getOccurrenceDisplayData(e);if(s&&t!==TE.Qy){const e=this.elementAccessor.getPartStudio(s.fullElementId);if(e){const s=e.getOccurrenceBounds(t);s&&s.isFinite()&&(i||(i=new wi.kB),i.addBox(s))}}})),i}addStatistics(e){e.uniqueMateConnectors+=this.mateIndicatorData.size}getBodyComponent(e){const t=this.getOccurrenceDisplayData(e);if(t){const e=this.elementAccessor.getPartStudio(t.fullElementId);if(e)return e.bodyComponent}return null}getBodyBounds(e,t){const i=this.getOccurrenceDisplayData(t);if(i){const s=this.elementAccessor.getPartStudio(i.fullElementId);if(s){const n=s.getBodyBounds(e,t);if(n)return n.createTransformedCopy(i.occurrenceData.transform.getGlMatrix())}}return null}getCachedOccurrenceState(e){let t=this.cachedOccurrenceState[e];return t||(this.cachedOccurrenceState[e]=t=new fg),t}clearCachedOccurrenceState(){this.cachedOccurrenceState={}}getBoundsOutsideElementNode(){const e=new wi.kB;if(this.originGraphics&&e.addBox(this.originGraphics.getBounds()),this.mateConnectorGraphics)for(const t in this.mateConnectorGraphics)this.mateConnectorGraphics[t].isHidden||e.addPoint(this.mateConnectorGraphics[t].worldSpacePosition);return this.fullElementIdToOccurrence.each(((t,i)=>{const s=this.elementAccessor.getPartStudio(i);return null!==s&&e.addBox(s.mateConnectorComponent.getVisibleMateConnectorBounds()),!1}),this),e.isInitialized()&&e.isFinite()?e:null}getMateIndicatorConnectivityMap(e){const t=new Gl.TemplatedNestedMap;for(const i of this.mateIndicatorData.values()){if(i.status===k.EFx.SUPPRESSED)continue;const s=i.getOccurrences(this);for(const i of s){const n=i.trimToTopLevel().getPathAsString(),r=i.getPathAsString();if(e.has(r))for(const e of s){const i=e.getPathAsString();n!==i&&t.insertNested(r,i,e)}}}return t}getElementType(){return k.GNh.ASSEMBLY}setExplodeViewActive(e){this.loadDisplayManager.setExplodeViewActive(e)}setEditState(e,t){this.loadDisplayManager.setEditState(e,t)}getOccurrences(){return this.occurrences}setAreOccurrencesClippedBySectionPlaneExcept(e,t){for(const t in this.occurrences){const i=this.viewer.getOccurrenceIdManager().getIdForName(t),s=this.viewer.getOccurrenceDataManager().getOccurrenceData(i);s&&s.setIsClippedBySectionPlanes(e)}for(const i of t)this.setAllLeafOccurrencesClippedForOccurrence(k._oC.getOccurrenceFromPathString(i),!e)}setAllLeafOccurrencesClippedForOccurrence(e,t){const i=this.getLeafOccurrencesContainedWithinOccurrence(e);if(i){for(const e of i){if(!this.occurrences[e.getPathAsString()]){pg.debug("Did not find occurrence data for leaf occurrence "+e.getPathAsString()+" in assembly "+this.elementId);continue}const i=this.viewer.getIdForOccurrence(e),s=this.viewer.getOccurrenceDataManager().getOccurrenceData(i);s&&s.setIsClippedBySectionPlanes(t)}const e=this.viewer.getModelViewManagers().getManager().getSimulationManager();e&&e.onSectionSetChanged()}}enterMateHideMode(e){const t=new Set;e.forEach((e=>{const i=new k._oC;i.path=e.path;const s=this.getIdOccurrenceNodeId(i,e.featureId);t.add(s)}));for(const e in this.mateIndicatorGraphics){this.mateIndicatorGraphics[e].updateHiddenMode(!t.has(e))}}exitMateHideMode(){for(const e in this.mateIndicatorGraphics){this.mateIndicatorGraphics[e].updateHiddenMode(!1)}}}const Eg=_e.O.createLogger("CommentIndicator",k.bVy.GRAPHICS),Sg="commentindicator",Tg=X.default.getManager(),Dg=20,Cg=20,Mg="n",yg="h";function Ag(e){const t=new Zl;t.id=Mg,t.backgroundColor=Tg.getString("COMMENT_INDICATOR_BACKGROUND_COLOR"),t.imageName="comment-indicator.png";const i=new Zl;return i.id=yg,i.backgroundColor=Tg.getString("COMMENT_INDICATOR_HOVER_BACKGROUND_COLOR"),i.imageName="comment-indicator.png",Ql(e,Math.max(Dg,Cg),[t,i],{sourcesHaveTransparency:!0})}function Pg(e){if(e.getResources().commentIndicatorAtlasCreationInitiated)return;e.getResources().commentIndicatorAtlasCreationInitiated=!0;e.getTextureAtlasFactory().getAtlas("COMMENT_INDICATOR_ATLAS",Ag.bind(void 0,e)).then((t=>{t?(e.getResources().commentIndicatorAtlas=t,e.getResources().commentIndicatorMaterial.ambientTexture=t.texture,(0,Xs.vm)()):Eg.warn("Could not load texture atlas")}),(e=>Eg.error(e)))}class Og extends yi.u1{constructor(e,t,i){super(i,uh.EG),this.occurrence=null,this.associatedComments=[],this.worldSpacePosition=null,this.hovered=!1,this.elementBeingListenedTo=null,this.parentHidden=!1,this.allCommentsHidden=!1,this.parentSheetMetalModelId=null,t&&(this.occurrence=k._oC.getOccurrenceFromPathString(t)),(0,Oc.isString)(e)?this.entityDeterministicId=e:this.commentCoordinates=e,this.updateWorldPosition(),this.listenTo(this.viewer.getEventDispatcher(),nM.CD,this.updateWorldPosition),this.listenTo(this.viewer.getEventDispatcher(),nM.LA,this.updateWorldPosition),this.listenTo(this.viewer.getEventDispatcher(),nM.hj,this.updateMissingWorldPosition),this.listenTo(i.getEventDispatcher(),nM.Hq,this.onActiveSheetMetalModelChanged),this.listenTo(this,yi.zw.CLICK+Sg,this.onClick),this.listenTo(this,yi.zw.MOUSE_ENTER+Sg,this.onMouseEnter),this.listenTo(this,yi.zw.MOUSE_LEAVE+Sg,this.onMouseLeave)}setCommentCoordinates(e){if(this.entityDeterministicId)throw new Error("A comment should have coordinates or entity id, but not both");this.commentCoordinates=e,this.updateWorldPosition()}addComment(e){this.associatedComments.indexOf(e)<0&&this.associatedComments.push(e);!this.entityDeterministicId&&this.updateElementListener()}removeComment(e){const t=this.associatedComments.indexOf(e);t>=0&&this.associatedComments.splice(t,1),this.entityDeterministicId||this.updateElementListener()}hasComments(){return this.associatedComments.length>0}onDevicePixelRatioChanged(e){this.updateGraphics()}updateGraphics(){if(!this.viewer.getResources().commentIndicatorAtlas)return;const e=this.viewer.getResources().commentIndicatorAtlas.getTextureCoords(this.hovered?yg:Mg);if(!e)return;const t=(0,ns.x_)(),i=(0,Yd.fQ)([0,0,0],[Dg*t,0,0],[0,Cg*t,0],void 0,[e.lowS,e.highT],[e.highS,e.lowT]);this.updateMeshIncrement("QUAD",Sg,i,this.viewer.getResources().commentIndicatorNodeProperties)}updateWorldPosition(){this.worldSpacePosition=null;const e=this.viewer.getModelViewManagers().getManager();if(this.entityDeterministicId){let t=null;if(this.occurrence&&!e.isEntityOnOccurrence(this.entityDeterministicId,this.occurrence)||(t=e.extractMeshIncrement(this.entityDeterministicId,this.occurrence)),!t)return void this.removeMeshIncrements();if(this.worldSpacePosition=this.getStickingPosition(t),this.viewer.getIsForFlattenedDisplay()){const t=e.getFlattenedEntityOwnerBodyDetails(this.entityDeterministicId,this.occurrence);if(!t||!t.transform)return this.worldSpacePosition=null,void this.removeMeshIncrements();ge.w$.multiplyVec3(t.transform,this.worldSpacePosition),this.parentSheetMetalModelId=t.bodyMetaData.sheetMetalModelId,this.updateHideState()}}else this.worldSpacePosition=[this.commentCoordinates.x,this.commentCoordinates.y,this.commentCoordinates.z];if(this.occurrence){const t=e.getOccurrenceTransform(this.occurrence);if(!t)return this.worldSpacePosition=null,void this.removeMeshIncrements();ge.w$.multiplyVec3(t,this.worldSpacePosition)}this.updateElementListener()}updateMissingWorldPosition(){this.worldSpacePosition||this.updateWorldPosition()}stopListeningToElement(){this.elementBeingListenedTo&&(this.stopListening(this.elementBeingListenedTo),this.elementBeingListenedTo=null)}updateElementListener(){if(this.stopListeningToElement(),this.hasBeenRemoved)return;const e=this.viewer.getModelViewManagers().getManager();if(this.occurrence){const t=e.getDisplayedAssembly();if(t){const e=this.occurrence.getPathAsString();this.onParentVisibilityChange(t.getOccurrenceVisibility(this.occurrence)),this.listenTo(t,"OCCURRENCE_VISIBILITY_CHANGE."+e,this.onParentVisibilityChange),this.listenTo(t,"OCCURRENCE_DATA_CHANGE."+e,this.updateWorldPosition),this.listenTo(t,"OCCURRENCE_DELETED."+e,this.updateWorldPosition),this.elementBeingListenedTo=t}}else this.entityDeterministicId?this.addEntityListeners(this.entityDeterministicId):this.addCommentListenersForAssociatedComments()}addCommentListenersForAssociatedComments(){const e=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio();if(e)for(const t of this.associatedComments)if(t.deterministicIds)for(const i of t.deterministicIds){if(e.retrieveBodyMetaData(i))this.listenToBodyVisibility(i,e);else{e.retrieveEntityMetaData(i)&&this.addEntityListeners(i)}}}addEntityListeners(e){const t=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio(),i=t?.retrieveEntityMetaData(e);t&&i&&(i.isFromBody()?this.listenToBodyVisibility(i.getBodyId(),t):this.listenToFeatureVisibility(i.getLastFeatureId(),t))}listenToBodyVisibility(e,t){this.onParentVisibilityChange(t.getBodyVisibility(e)),this.listenTo(t,"BODY_VISIBILITY_CHANGE."+e,this.onParentVisibilityChange),this.elementBeingListenedTo=t}listenToFeatureVisibility(e,t){this.onParentVisibilityChange(t.getFeatureVisibility(e)),this.listenTo(t,"FEATURE_VISIBILITY_CHANGE."+e,this.onParentVisibilityChange),this.elementBeingListenedTo=t}onParentVisibilityChange(e){this.parentHidden=e===Xs.EE.HIDDEN,this.updateHideState()}setAllCommentsHidden(e){this.allCommentsHidden=e,this.updateHideState()}updateHideState(){let e=!1;this.parentSheetMetalModelId&&this.parentSheetMetalModelId!==this.viewer.getModelViewManagers().getManager().getSelectedSheetmetalModelId()&&(e=!0),this.allCommentsHidden||this.parentHidden||e?this.hide():this.show()}getStickingPosition(e){return e.getPositionNearCenter()}onViewWillDraw(e){if(Pg(this.viewer),this.isHidden||!this.worldSpacePosition||!this.viewer.getResources().commentIndicatorAtlas)return;this.viewer.getResources().commentIndicatorMaterial.ambientTexture=this.viewer.getResources().commentIndicatorAtlas.texture;const t=e.projectWorldPointToViewport(this.worldSpacePosition),i=ue.create();i[12]=Math.floor(t[0]-Dg/2),i[13]=Math.floor(t[1]-Cg/2),this.setTransform(i),this.hasMeshIncrements()||this.updateGraphics()}onClick(e,t){t.skipCommentClearHighlight=!0,es.Jq.CommentService.highlightComments(this.associatedComments)}onMouseEnter(){this.hovered=!0,this.removeMeshIncrements(),(0,Xs.vm)()}onMouseLeave(){this.hovered=!1,this.removeMeshIncrements(),(0,Xs.vm)()}onActiveSheetMetalModelChanged(e){this.parentSheetMetalModelId&&this.updateHideState()}}class Rg extends yi.u1{constructor(e,t){super(t,uh.EG),this.elementModel=e,this.centerOfMass=null}updateCenterOfMass(e){this.centerOfMass=e}updateGraphics(){this.ensureMaterialIsCreated();const e=20*(0,ns.x_)(),t=(0,Yd.fQ)([0,0,0],[e,0,0],[0,e,0],void 0,[0,0],[1,1]);this.updateMeshIncrement("QUAD","",t,this.viewer.getResources().centerOfMassIndicatorNodeProperties)}ensureMaterialIsCreated(){if(null===this.viewer.getResources().centerOfMassIndicatorNodeProperties){const e=(0,wi.cP)(20);if(e>this.viewer.getMaximumTextureSize())throw new Error("Center of mass texture size exceeds limit");const t=new Io(this.viewer,(function(t){const i=new mo(t);return i.width=e,i.height=e,i.magnificationFilter=t.LINEAR,i.minificationFilter=t.LINEAR,i.useMipmaps=!1,i.imageSource="/images/center-of-mass.png",i}));t.setHasTransparency(!0),this.viewer.getResources().centerOfMassIndicatorNodeProperties=new Gi.hF({primitiveType:Ai.MX.TRIANGLES,material:Hi(t),isPickable:!1})}}onViewWillDraw(e){if(null===this.centerOfMass||this.isHidden)return;const t=e.projectWorldPointToViewport(this.centerOfMass),i=ue.create(),s=20*(0,ns.x_)()/2;i[12]=Math.floor(t[0]-s),i[13]=Math.floor(t[1]-s),this.setTransform(i),this.hasMeshIncrements()||this.updateGraphics()}onDevicePixelRatioChanged(e){this.updateGraphics()}}class wg{constructor(e){this.bodyComponent=e,this.geometryHandler=new vg(e)}featureEntityHasThreadData(e){return e&&e.getDomainSpecificMetadata(k.rhF)}addMaterialOverrideForEntity(e,t,i){if(!(t instanceof k.kdl))return;const s=t;this.featureEntityHasThreadData(s)&&this.geometryHandler.setFaceData(e,s,i)}removeOccurrence(e){this.geometryHandler.removeOccurrence(e)}destroy(){this.geometryHandler.destroy()}bodyHasCosmeticThreads(e){return this.geometryHandler.getBodyIdToFaces().get(e)?.size>0}getBodiesWithCosmeticThreads(e){const t=new Set;if(e.isNonGroupingCompositeBody)for(const i of e.constituentBodyIds)this.bodyHasCosmeticThreads(i)&&t.add(i);else this.bodyHasCosmeticThreads(e.id)&&t.add(e.id);return t}addCosmeticThreadGeometry(e,t,i,s,n,r,a){if(!this.bodyComponent.isBodyLoaded(t))return null;const o=this.geometryHandler.getBodyIdToFaces().get(t);if(!o)return null;let h=null;return o.forEach((o=>{const c=e.getIncrementDetails(o,this.bodyComponent.parent.getMeshOwnerId());if(!c)return;if(e===this.bodyComponent.getSharedBaseMeshManager()&&n.isIncrementHidden(c,ys.L.PREVIEW))return;const l=new qT("CosmeticThread-"+o+"-OccurrenceId-"+n.getOccurrenceId(),t);if(l.onIncrementAdded(c),this.geometryHandler.addGeometry(s,n,r,l,o,a,i),h){const e=new ST;e.setOperand(h);const t=l;e.setOperandA(t),h=e}else h=l})),h}updateEntity(e,t,i){const s=t,n=new Set,r=this.geometryHandler.removeFace(e);r&&n.add(r),this.featureEntityHasThreadData(s)&&(this.addMaterialOverrideForEntity(e,t,i),n.add(i));const a=this.bodyComponent.retrieveBodyMetaData(i);return a&&this.getBodiesWithCosmeticThreads(a).forEach((e=>{n.add(e)})),n}removeFace(e){return this.geometryHandler.removeFace(e)}cloneForPreview(e){const t=new wg(e);return this.copyToClone(t),t}copyToClone(e){e.geometryHandler=this.geometryHandler.clone(e.bodyComponent)}setTranslucentModeFaceOpacity(e){this.geometryHandler.setTranslucentModeFaceOpacity(e)}}class vg{constructor(e){this.faceIdToCosmeticThread=new Map,this.faceIdToMaterial=new Map,this.faceAndOccurrenceIdToGeometryData=new Gl.TemplatedSetMap,this.bodyIdToFaceIds=new Gl.TemplatedSetMap,this.faceIdToBodyId=new Map,this.occurrenceIdToFaceIds=new Gl.TemplatedSetMap,this.faceIdToOccurrences=new Gl.TemplatedSetMap,this.bodyComponent=e}getDataKey(e,t){return e.toString()+t}getCosmeticThreadMaterial(e){const t=new Bi;return t.shaderId="cosmeticThreads",t.setCustomFloatUniform("uThreadPitch",e.pitch),t.setCustomVectorUniform("uCylinderOrigin",e.cylinderSystem.origin.getVec3()),t.setCustomVectorUniform("uCylinderAxisX",e.cylinderSystem.xAxis.getVec3()),t.setCustomVectorUniform("uCylinderAxisY",e.cylinderSystem.yAxis.getVec3()),t.setCustomVectorUniform("uCylinderAxisZ",e.cylinderSystem.zAxis.getVec3()),t.setCustomFloatUniform("uCylinderRadius",e.cylinderRadius),t.setCustomFloatUniform("uThreadLength",e.threadLength),t}setFaceData(e,t,i){this.bodyIdToFaceIds.add(i,e),this.faceIdToBodyId.set(e,i);const s=t.getDomainSpecificMetadata(k.rhF);this.faceIdToCosmeticThread.set(e,s)}getBodyIdToFaces(){return this.bodyIdToFaceIds}addGeometry(e,t,i,s,n,r,a){const o=t.getOccurrenceId(),h=this.getDataKey(o,n),c=this.faceIdToCosmeticThread.get(n);if(!c)return;const l=this.getCosmeticThreadMaterial(c);this.bodyComponent.viewer.getIsolatedOccurrenceManager()?.isOccurrenceTranslucent(t)&&(l.isolateTranslucentAlpha=Im.material.isolateTranslucentAlpha),this.faceIdToMaterial.set(n,l);const d=e.cloneAndModify({material:l});this.faceAndOccurrenceIdToGeometryData.add(h,{nodeProperties:d,occurrenceData:t,style:i,meshRanges:s,faceId:n,nodeId:d.id,styleOverrideRanges:r,rangesToSkip:a}),this.bodyComponent.getNode().addOccurrenceGeometryToNode(d,t,i,s,r,a),this.occurrenceIdToFaceIds.add(o,n),this.faceIdToOccurrences.add(n,o)}clone(e){const t=new vg(e);return t.faceIdToCosmeticThread=new Map(this.faceIdToCosmeticThread),t}removeOccurrence(e){this.occurrenceIdToFaceIds.has(e)&&(this.occurrenceIdToFaceIds.get(e).forEach((t=>{const i=this.getDataKey(e,t),s=this.faceAndOccurrenceIdToGeometryData.get(i);s&&(s.forEach((e=>{this.bodyComponent.getNode().removeChildById(e.nodeId.toString())})),this.faceAndOccurrenceIdToGeometryData.delete(i))})),this.occurrenceIdToFaceIds.delete(e))}removeFace(e){let t=!1;this.faceIdToMaterial.has(e)&&(this.faceIdToMaterial.get(e).destroy(),this.faceIdToMaterial.delete(e),t=!0);const i=this.faceIdToBodyId.get(e);return i&&(this.bodyIdToFaceIds.deleteValue(i,e),this.faceIdToBodyId.delete(e)),this.faceIdToCosmeticThread.has(e)&&(this.faceIdToCosmeticThread.delete(e),t=!0),this.faceIdToOccurrences.has(e)&&(this.faceIdToOccurrences.get(e).forEach((i=>{const s=this.getDataKey(i,e),n=this.faceAndOccurrenceIdToGeometryData.get(s);n&&(n.forEach((e=>{this.bodyComponent.getNode().removeChildById(e.nodeId.toString()),t=!0})),this.faceAndOccurrenceIdToGeometryData.delete(s),this.occurrenceIdToFaceIds.deleteValue(i,e))})),this.faceIdToOccurrences.delete(e)),t?i:null}setTranslucentModeFaceOpacity(e){for(const[t,i]of this.faceIdToMaterial)void 0!==i.isolateTranslucentAlpha&&(i.isolateTranslucentAlpha=e)}destroy(){this.faceIdToMaterial.forEach(((e,t)=>{e.destroy()})),this.faceAndOccurrenceIdToGeometryData.forEach((e=>{e.forEach((e=>{e.nodeProperties.material.destroy(),this.bodyComponent.getNode().removeChildById(e.nodeId.toString())}))}))}}const _g=_e.O.createLogger("Decal",k.bVy.GRAPHICS),Ng="uDecalProjection",bg="uCylinderRadius",Lg="decals";function Fg(e){return e.getMaterial()?.getExtendedShaderId()===Lg}class xg{static ensureStaticStyles(){xg.TRANSLUCENT_MODIFIED_DECAL_STYLE&&xg.NON_MODIFIED_DECAL_STYLE||(xg.TRANSLUCENT_MODIFIED_DECAL_STYLE=new mS.bg,xg.TRANSLUCENT_MODIFIED_DECAL_STYLE.setFloatUniform("uIsolateTranslucentAlpha",1),xg.NON_MODIFIED_DECAL_STYLE=new mS.bg,xg.NON_MODIFIED_DECAL_STYLE.setFloatUniform("uIsolateTranslucentAlpha",1))}static setTranslucencyModifier(e){xg.ensureStaticStyles(),xg.TRANSLUCENT_MODIFIED_DECAL_STYLE.setFloatUniform("uIsolateTranslucentAlpha",e)}constructor(e,t,i){this.decalId=e,this.bodyComponent=t,this.partStudio=i,this.bodyToInstantiationDetails=new Map,this.bodyToOccurrenceId=new Map,this.occurrenceIdToInstantiatedNodeProperties=new Map,this.relatedClosedCompositeDeterministicIds=new Set,this.mappingResources=[],xg.ensureStaticStyles()}destroy(){this.removeGraphics();for(let e=0;e<this.mappingResources.length;++e)this.mappingResources[e].material.destroy()}clone(e,t){const i=new xg(this.decalId,e,t);return i.btDecal=this.btDecal,i}removeOccurrences(){for(const[e,t]of this.bodyToOccurrenceId)for(const i of t)this.removeOccurrence(i,e)}removeGraphics(){this.removeOccurrences(),this.bodyToInstantiationDetails.clear()}addOrUpdateOccurrence(e,t){t=+t;const i=this.bodyComponent.retrieveBodyMetaData(e);if(!i)return;let s;s=i.isClosedComposite?i.constituentBodyIds:[e];let n=!1;for(let i=0;i<s.length;++i){const r=s[i],a=this.bodyToInstantiationDetails.get(r);if(a)for(const[i,s]of a){const i=this.viewer.getOccurrenceDataManager().getOccurrenceData(t);let r;r=this.viewer.getIsolatedOccurrenceManager()?.isOccurrenceTranslucent(i)?xg.TRANSLUCENT_MODIFIED_DECAL_STYLE:xg.NON_MODIFIED_DECAL_STYLE;for(let e=0;e<s.nodeProperties.length;++e){this.node.addOccurrenceGeometryToNode(s.nodeProperties[e],i,r,s.incrementRanges);let a=this.occurrenceIdToInstantiatedNodeProperties.get(t);a||(a=new Set,this.occurrenceIdToInstantiatedNodeProperties.set(t,a),n=!0),a.add(s.nodeProperties[e])}let a=this.bodyToOccurrenceId.get(e);a||(a=new Set,this.bodyToOccurrenceId.set(e,a)),a.add(t)}}n&&(i.isClosedComposite?this.relatedClosedCompositeDeterministicIds.add(e):i.isClosedCompositeConstituent&&this.relatedClosedCompositeDeterministicIds.add(i.closedCompositeParentId))}removeOccurrence(e,t){e=+e;const i=this.bodyToOccurrenceId.get(t);if(i&&i.has(e)){const s=this.occurrenceIdToInstantiatedNodeProperties.get(e);if(s){for(const t of s)this.node.removeOccurrenceFromNode(t,e);this.occurrenceIdToInstantiatedNodeProperties.delete(e)}i.delete(e),0===i.size&&this.bodyToOccurrenceId.delete(t)}}update(e){return(!this.btDecal||!this.btDecal.deepEquals(e))&&(this.btDecal=e,this.updateGraphics(),!0)}debugCoordinateSystem(){for(let e=0;e<this.btDecal.mappings.length;++e){const t=this.btDecal.mappings[e];let i=null;t instanceof k.TIP?i=t.planeSystem:t instanceof k.Q7q&&(i=t.cylinderSystem),i&&TM(this.viewer,this.decalId+"."+e,i)}}onPartStudioChange(e){(this.didReferencedFaceChange(e)||this.didBodyStatusChange(e))&&this.updateGraphics()}updateGraphics(){this.btDecal&&(this.removeGraphics(),this.updateMappingResources(),this.updateIncrementRanges(),this.refreshOccurrences())}refreshOccurrences(){this.bodyComponent.getBodyToOccurrenceId().eachNested(((e,t,i)=>{this.addOrUpdateOccurrence(t,i)}))}doesReferenceEntity(e){for(const t of this.btDecal.mappings)if(t.deterministicIds.indexOf(e)>=0)return!0;return!1}didReferencedFaceChange(e){if(!this.btDecal)return!1;for(const t of this.btDecal.mappings)for(const i of t.deterministicIds)if(e.deterministicIdToEntity.hasOwnProperty(i))return!0;return!1}didBodyStatusChange(e){for(const[e,t]of this.bodyToOccurrenceId){const t=this.bodyComponent.retrieveBodyMetaData(e);if(!t||t.canBeGroupedWithOtherConstituents)return!0}let t=!1;for(const i of this.relatedClosedCompositeDeterministicIds)e.deterministicPartIdToData[i]&&(this.relatedClosedCompositeDeterministicIds.delete(i),t=!0);return t}updateMappingResources(){for(let e=0;e<this.btDecal.mappings.length;++e){const t=this.btDecal.mappings[e];let i=this.mappingResources[e];if(!i){const e=new Bi({diffuseFactor:0,ambientFactor:1,specularColor:[0,0,0]});e.shaderId=Lg,i={material:e,nodeProperties:null,transparentNodeProperties:null},this.mappingResources.push(i)}if(t instanceof k.TIP)i.material.setCustomMatrixUniform(Ng,t.planeSystem.fromWorld()),i.material.setCustomFloatUniform(bg,0);else{if(!(t instanceof k.Q7q))return void _g.debug("Unsupported decal mapping: "+t.getMessageName());i.material.setCustomMatrixUniform(Ng,t.cylinderSystem.getGlMatrix()),i.material.setCustomFloatUniform(bg,t.radius)}i.material.setCustomMatrixUniform("uUvTransform",t.uvTransform.getGlMatrix());const s=(0,qn.e)(this.btDecal.imageSourceId);i.material.setTexture(this.viewer.getResources().getImageTexture(s)),i.nodeProperties=Em.cloneAndModify({material:i.material,isPickable:!1,zOffset:X.default.getManager().getNumber("DECALS_Z_OFFSET")}),i.transparentNodeProperties=Sm.cloneAndModify({material:i.material,isPickable:!1,zOffset:X.default.getManager().getNumber("DECALS_Z_OFFSET")})}}updateIncrementRanges(){for(let e=0;e<this.btDecal.mappings.length;++e){const t=this.btDecal.mappings[e];if(0===t.deterministicIds.length)continue;const i=this.mappingResources[e];if(i)for(const s of t.deterministicIds){const t=this.bodyComponent.getEntityMetaData(s);if(!t)continue;const n=t.getBodyId();if(!this.bodyComponent.isBodyLoaded(n))continue;const r=this.partStudio.getIncrementMeshDetails(s);if(!r){_g.debug("Did not find increment details for "+s);continue}let a=this.bodyToInstantiationDetails.get(n);a||(a=new Map,this.bodyToInstantiationDetails.set(n,a));let o=a.get(e);o||(o={incrementRanges:new qT("Decal-"+this.decalId+"-Mapping-"+e+"-Body-"+n),nodeProperties:[i.nodeProperties,i.transparentNodeProperties]},a.set(e,o)),o?.incrementRanges.onIncrementAdded(r)}else _g.warn("Did not have image mapping resources for decal mapping "+e)}}get node(){return this.partStudio.getModelViewManager().getSharedBodyNode()}get viewer(){return this.partStudio.viewer}}class Bg{constructor(e,t){this.bodyComponent=e,this.partStudio=t,this.decals=new Map}destroy(){for(const[e,t]of this.decals)t.destroy()}cloneForPreview(e,t){const i=new Bg(e,t);return this.copyToClone(i),i}copyToClone(e){for(const[t,i]of this.decals){const s=i.clone(e.bodyComponent,e.partStudio);e.decals.set(t,s),s.updateGraphics()}}removeFromScene(){for(const[e,t]of this.decals)t.removeOccurrences()}update(e){if(this.partStudio.viewer.getIsForFlattenedDisplay())return;const t=new Set;for(const i in e.decalIdToDecal){const s=e.decalIdToDecal[i];let n=this.decals.get(i);s.isDeletion?n&&(n.destroy(),this.decals.delete(i)):(n||(n=new xg(i,this.bodyComponent,this.partStudio),this.decals.set(i,n)),n.update(s)&&t.add(i))}for(const[i,s]of this.decals)t.has(i)||s.onPartStudioChange(e)}onBodyLoaded(){for(const[e,t]of this.decals)t.updateGraphics()}addOrUpdateOccurrence(e,t){for(const[i,s]of this.decals)s.addOrUpdateOccurrence(e,t)}removeOccurrence(e,t){for(const[i,s]of this.decals)s.removeOccurrence(e,t)}getDecalIdsAffectingEntity(e){const t=[];for(const[i,s]of this.decals)s.doesReferenceEntity(e)&&t.push(i);return t}}var Vg=i(53708);const Ug=_e.O.createLogger("PartStudio",k.bVy.GRAPHICS),Hg=function(e){return e.isFace()||e.isFromSketch()&&e.isEdge()||e.isFromOrigin()||e.isSketchUserPoint()||e.isFromPointBody()||e.isFromWireBody()},Gg=function(e){return e.isFace()||e.isFromWireBody()&&e.isEdge()||e.isFromPointBody()};class kg extends dg{constructor(e,t,i,s,n,r,a){super(r),this.id=e,this.microversionIdAndConfiguration=t,this.modelViewManager=i,this.usage=n,this.isExternal=!1,this.isForIncontextDisplay=!1,this.bodyIdsThatAreInsertableBuffers=null,this.hideableFeatureIds=[],this.referencedInContextAssemblyIds=[],this.visibleInContextAssembly="",this.displayedContextTransform={},this.editedInContextOccurrences=[],this.partColorCycle=null,this.isCachedPartStudioPendingUse=!1,this.isMissingTangencyInformationMessageShown=!1,this.bodyIdToEntityAppearanceSettings={},this.meshOwnerId=a?a.meshOwnerId:JT(),this.sharedBaseMeshManager=i.getSharedBaseMeshManager(),this.entityIdManager=new DE.E(Mi._6.ENTITY),this.bodyComponent=new _m(this,s,this.usage,this.viewer),this.sketchComponent=new Um(this,this.usage,this.viewer),this.planeComponent=new $g(this,this.usage,this.viewer),this.pointBodyComponent=new em(this,this.viewer),this.mateConnectorComponent=new Fp(this,this.usage,this.viewer),this.errorComponent=new Nm(this,this.viewer),this.dimensionComponent=new Wg(this.usage,this.id,this.viewer,a?.getDimensionComponent()),this.imageComponent=new kl(this.usage,this.viewer),this.annotationComponent=new Rd(this.usage,this.id,this.viewer,a?.getAnnotationComponent()),this.components=[this.bodyComponent,this.sketchComponent,this.planeComponent,this.pointBodyComponent,this.mateConnectorComponent,this.errorComponent]}clone(e){const t=new kg(this.id,this.microversionIdAndConfiguration,this.modelViewManager,this.bodyComponent.getBodyLoadTasks(),this.usage,this.viewer);if(e){for(let e=0;e<t.components.length;++e)t.bodyComponent===t.components[e]?(t.bodyComponent=this.bodyComponent.clone(t),t.components[e]=t.bodyComponent):t.planeComponent===t.components[e]?(t.planeComponent=this.planeComponent.clone(t),t.components[e]=t.planeComponent):t.sketchComponent===t.components[e]?(t.sketchComponent=this.sketchComponent.clone(t),t.components[e]=t.sketchComponent):t.pointBodyComponent===t.components[e]?(t.pointBodyComponent=this.pointBodyComponent.clone(t),t.components[e]=t.pointBodyComponent):t.mateConnectorComponent===t.components[e]&&(t.mateConnectorComponent=this.mateConnectorComponent.clone(t),t.components[e]=t.mateConnectorComponent);t.imageComponent=this.imageComponent.cloneForUsage(this.usage),t.partColorCycle=this.partColorCycle,t.isCachedPartStudioPendingUse=this.isCachedPartStudioPendingUse,t.bodyIdToEntityAppearanceSettings=this.bodyIdToEntityAppearanceSettings}return t}cloneForPreview(e,t){const i=new kg(this.id,null,e,this.bodyComponent.getBodyLoadTasks(),ys.L.PREVIEW,this.viewer,this);i.entityIdManager=this.entityIdManager.clone();for(let e=0;e<i.components.length;++e)i.bodyComponent===i.components[e]?(i.bodyComponent=this.bodyComponent.cloneForPreview(i),i.components[e]=i.bodyComponent):i.planeComponent===i.components[e]?t||(i.planeComponent=this.planeComponent.cloneForPreview(i),i.components[e]=i.planeComponent):i.sketchComponent===i.components[e]?(i.sketchComponent=this.sketchComponent.cloneForPreview(i),i.components[e]=i.sketchComponent):i.pointBodyComponent===i.components[e]?t||(i.pointBodyComponent=this.pointBodyComponent.cloneForPreview(i),i.components[e]=i.pointBodyComponent):i.mateConnectorComponent===i.components[e]&&(t||(i.mateConnectorComponent=this.mateConnectorComponent.cloneForPreview(i),i.components[e]=i.mateConnectorComponent));return i.imageComponent=this.imageComponent.cloneForUsage(ys.L.PREVIEW),i.partColorCycle=this.partColorCycle,i.bodyIdToEntityAppearanceSettings=this.bodyIdToEntityAppearanceSettings,i}isBodyContainedInInsertableDisplayBuffers(e){return this.bodyIdsThatAreInsertableBuffers&&this.bodyIdsThatAreInsertableBuffers.has(e)}onPreviewDestroyed(){this.bodyComponent.onPreviewDestroyed()}copyBodyVisibility(e){this.bodyComponent.copyVisibility(e.bodyComponent)}isBase(){return this.usage===ys.L.BASE}getElementId(){return this.id}getIsMissingTangencyInformationMessageShown(){return this.isMissingTangencyInformationMessageShown}setIsMissingTangencyInformationMessageShown(e){this.isMissingTangencyInformationMessageShown=e}getIsCachedPartStudioPendingUse(){return this.isCachedPartStudioPendingUse}getFullElementId(){return this.microversionIdAndConfiguration?k.lK7.getFullElementIdString(this.id,this.microversionIdAndConfiguration.getKey()):this.id}getBtFullElementId(){const e=new k.lK7;return e.elementId=this.id,this.microversionIdAndConfiguration&&(e.microversionId=this.microversionIdAndConfiguration.microversion,e.microversionIdAndConfiguration=this.microversionIdAndConfiguration),e}getModelViewManager(){return this.modelViewManager}getMeshManager(){return this.modelViewManager.getMeshManager()}getSharedBaseMeshManager(){return this.sharedBaseMeshManager||null}populateClientCacheStateDisplayInformation(e){if(this.microversionIdAndConfiguration){const t=e.getOrCreateElementDataList(this.id,k.D3B.DISPLAY_DATA);this.checkDuplicatedMicroversionIdAndConfiguration(t,this.microversionIdAndConfiguration)?t.push(this.microversionIdAndConfiguration):Ug.warn("Found duplicated part studio microversion id and configuration "+this.microversionIdAndConfiguration),this.populateTessellationSetting(e),this.populateSketchFeatures(e)}}populateSketchFeatures(e){const t=this.getBtFullElementId(),i=this.sketchComponent.featureToIds.getKeys(),s=e.listFullElementIdToReferencedSketchFeatureIds,n=new k.luK;return n.fullElementId=t,n.referencedSketchFeatureIds=i,s.push(n),n}populateTessellationSetting(e){let t,i=e.tessellationWithConfigurationSettings[this.id];i||(e.tessellationWithConfigurationSettings[this.id]=i=[]);for(let e=0;e<i.length;e++)if(t=i[e],t.microversionIdAndConfiguration.equals(this.microversionIdAndConfiguration))return t.tessellationSettings=this.bodyComponent.getTessellationSettings(),t.partTriangleCounts=this.bodyComponent.getPartTriangleCounts(),t;return t=new k.iRj,t.microversionIdAndConfiguration=this.microversionIdAndConfiguration,t.tessellationSettings=this.bodyComponent.getTessellationSettings(),i.push(t),t}getSceneGraph(){return this.usage===ys.L.PREVIEW?this.viewer.getSceneGraphs().getPreviewSceneGraph():this.viewer.getSceneGraphs().getMainSceneGraph()}getPartColorCycle(){return this.partColorCycle}reset(e){for(let t=0;t<this.components.length;++t)this.components[t].reset(e);this.dimensionComponent.reset(),this.imageComponent.reset(),this.entityIdManager.reset(),this.referencedInContextAssemblyIds=[],this.visibleInContextAssembly="",this.editedInContextOccurrences=[],this.annotationComponent.reset(),this.sharedBaseMeshManager=null}retrieveEntityMetaData(e){for(let t=0;t<this.components.length;++t){const i=this.components[t].getEntityMetaData(e);if(i)return i}return null}retrieveBodyMetaData(e){for(let t=0;t<this.components.length;++t){const i=this.components[t].retrieveBodyMetaData(e);if(i)return i}return null}retrieveAssociatedFeatureIds(e){const t=[];for(const i of this.components){const s=i.retrieveAssociatedFeatureIds(e);s&&s.length&&t.push(...s)}return t}retrieveBodyEntityData(e){const t=[],i=this.getBodyComponent().getEntityIds(e);for(const e of i){const i=this.retrieveEntityMetaData(e);i&&t.push(i)}return t}getEntityIdManager(){return this.entityIdManager}extractMeshIncrement(e){for(let t=0;t<this.components.length;++t){const i=this.components[t].extractMeshIncrement(e);if(i)return i}return null}getHideableMateConnectorFeatureIds(){return this.mateConnectorComponent.getHideableFeatureIds()}getHideableSketchFeatureIds(){return this.sketchComponent.getHideableFeatureIds()}getHideablePlaneFeatureIds(){return this.planeComponent.getHideableFeatureIds()}getHideableFeatureIds(){return this.hideableFeatureIds}addManagedIdMappings(e){for(const t of Object.values(e)){const e=t.managedData;if(e)for(const t of e)for(const e of t.bodyIds){const i=t.creationId;switch(t.type){case k.dry.SKETCH:this.sketchComponent.addManagedIdMappings(i,e);break;case k.dry.CONSTRUCTION_PLANE:this.planeComponent.addManagedIdMappings(i,e);break;case k.dry.MATE_CONNECTOR:this.mateConnectorComponent.addManagedIdMappings(i,e);break;default:this.sketchComponent.addManagedIdMappings(i,e),this.planeComponent.addManagedIdMappings(i,e),this.mateConnectorComponent.addManagedIdMappings(i,e)}}}}fixPartAndDisplayDataForMessage(e){this.bodyIdsThatAreInsertableBuffers||(this.bodyIdsThatAreInsertableBuffers=new Set);for(const t of Object.values(e.partIdAndTessellationSettingToBuffers)){const i=Object.values(t);if(i.length>0&&i[0]instanceof k.l48){const t=i[0],s=t.getId();e.deterministicPartIdToData[s]=t.partData,e.partDisplayData.push(t.partDisplayData),this.bodyIdsThatAreInsertableBuffers.add(s)}}for(const t of Object.values(e.sketchFeatureIdAndTessellationSettingToBuffers)){const i=Object.values(t);if(i.length>0&&i[0]instanceof k.VtB){const t=i[0],s=t.getId();this.bodyIdsThatAreInsertableBuffers.add(s);for(const[i,s]of Object.entries(t.bodyIdToPartData))e.deterministicPartIdToData[i]=s,this.bodyIdsThatAreInsertableBuffers.add(i)}}}processDisplayData(e,t,i,s,n){if((this.isBase()?e.buildFullElementId().toString():e.elementId)!==(this.isBase()?this.getFullElementId():this.id))return void Ug.warn("An attempt was made to update part studio graphics with display data that do not belong to it.");if(this.updateExternalState(e.isExternal,i),e.isNoop)return;e.fromDisplayCache&&(this.isCachedPartStudioPendingUse=!0),this.viewer.areOptimizedBuffersEnabled&&this.fixPartAndDisplayDataForMessage(e),this.partColorCycle||(this.partColorCycle=e.partColorCycle),this.hideableFeatureIds=[];let r,a,o,h=0;const c=new Ih.B7("processDisplayData");if(e.incremental){const t=new Ih.B7("Deleting entities");for(r=0;r<this.components.length;++r)this.components[r].processDeletions(e);t.report()}else this.reset();let l=!this.viewer.getIsForFlattenedDisplay()||!(0,j.isEmptyObjectOrArray)(e.appearanceIdToAppearanceOverride);if(!l)for(const t in e.deterministicPartIdToData)if(e.deterministicPartIdToData[t].isForFlattenedView()){l=!0;break}l||this.bodyComponent.updateBodyDisplayData(e,s);const d=new Ih.B7("Updating entities");for(r=0;r<this.components.length;++r){this.viewer.getIsForFlattenedDisplay()&&!l||this.components[r].processAdditionsAndChanges(e,t,s);const i=this.components[r].getHideableFeatureIds();for(a=0;a<i.length;++a)this.hideableFeatureIds.push(i[a])}if(this.bodyComponent.updateCompositeConstituentCounts(e),this.bodyComponent.updateBodiesWithChangedSmoothEdgesCount(),this.viewer.getIsPrimaryViewer()&&this.annotationComponent.processDisplayData(e),d.report(),e.bodyIdToEntityAppearanceSettingsChanged&&(this.bodyIdToEntityAppearanceSettings=e.bodyIdToEntityAppearanceSettings),e.partDisplayData){const t=e.partDisplayData.length;for(o=0;o<t;o++){const t=e.partDisplayData[o].id;if(e.partDisplayData[o].baseAppearanceSettings=this.bodyIdToEntityAppearanceSettings[t],!e.partDisplayData[o].baseAppearanceSettings){const i=this.retrieveBodyMetaData(t);if(i&&i.isClosedComposite){const s=e.partDisplayData[o];let n=!1;const r=i.constituentBodyIds.length;for(h=0;h<r;h++){const e=i.constituentBodyIds[h];if(!this.bodyIdToEntityAppearanceSettings[e])continue;const r=this.bodyIdToEntityAppearanceSettings[e];if(n){if(s.baseAppearanceSettings&&r.colorIdToBaseEntityAppearanceEntry){const e=r.colorIdToBaseEntityAppearanceEntry;for(const t in e)if(t){const i=e[t];i&&(s.baseAppearanceSettings.colorIdToBaseEntityAppearanceEntry[t]?s.baseAppearanceSettings.colorIdToBaseEntityAppearanceEntry[t].affectedDeterministicIds=s.baseAppearanceSettings.colorIdToBaseEntityAppearanceEntry[t].affectedDeterministicIds.concat(i.affectedDeterministicIds):s.baseAppearanceSettings.colorIdToBaseEntityAppearanceEntry[t]=i)}}}else n=!0,s.baseAppearanceSettings=r,this.bodyIdToEntityAppearanceSettings[t]=s.baseAppearanceSettings}}}}}this.isForIncontextDisplay||this.viewer.getIsForFlattenedDisplay()||this.viewer.getEventDispatcher().trigger(nM.W2,e.partDisplayData,e.buildFullElementId(),e.usage,this.bodyComponent.bodyMetaData,n),this.dimensionComponent.processDisplayData(e),this.imageComponent.processDisplayData(e),e.incremental||t||this.bodyComponent.reloadOccurrences(),t&&(this.dimensionComponent.updateDisplays(),this.imageComponent.updateDisplays()),this.processInContextData(e,t),this.viewer.getEventDispatcher().trigger(nM.CD,e,s),c.report()}processReceivedInsertableData(e){const t={},i={};i[e.getTessellationSetting()]=e,t[e.getId()]=i;const s=e.isSketchFeature()?this.getSketchComponent():this.getBodyComponent(),n=e.getId();s.processPrecompiledGraphicsBuffers(t),e.isSketchFeature()||s.refreshBodyOccurrenceForBodyId(n),this.viewer.requestDraw()}processInContextData(e,t){if(this.isBase()){let i,s=!1;if(e.assemblyReferenceDisplayData){const t=e.assemblyReferenceDisplayData.assemblyReferences;for(i=0;i<t.length;i++)t[i].visibility===k.HRI.VISIBLE&&(s=!0)}if(s){if(t)for(this.referencedInContextAssemblyIds=[],this.visibleInContextAssembly="",this.editedInContextOccurrences=[],this.displayedContextTransform={},i=0;i<e.assemblyReferenceDisplayData.assemblyReferences.length;i++){const t=e.assemblyReferenceDisplayData.assemblyReferences[i],s=t.isTransient?"":t.referenceNodeId,n=t.assemblyDisplayData;t.occurrencesToExclude.forEach((e=>{this.editedInContextOccurrences.push({assemblyElementId:n.elementId,occurrence:e,contextId:s})}));const r=(0,Xs.dV)(n.elementId);let a=n.elementId;r!==e.assemblyReferenceDisplayData.elementId&&(a=(0,Xs.HL)(n.elementId,e.assemblyReferenceDisplayData.elementId,t.referenceNodeId)),this.referencedInContextAssemblyIds.push(a),t.visibility===k.HRI.VISIBLE&&(this.visibleInContextAssembly=a),this.displayedContextTransform[s]=t.transform}}else t&&this.removeInContextAssemblies()}else if(this.viewer.getModelViewManagers().getManager().isDisplayingIncontextAssembly()){const e=!0;(0,nM.xA)().trigger(nM.bh,e)}}updateExternalState(e,t){this.isExternal=e,this.isForIncontextDisplay=!!t}getReferencedInContextAssemblyIds(){return this.referencedInContextAssemblyIds}isDisplayingIncontextAssembly(){return!!this.visibleInContextAssembly}getVisibleInContextAssemblyId(){return this.visibleInContextAssembly}removeInContextAssemblies(){this.viewer.getModelViewManagers().getManager().resetAllIncontextGraphicsForPartstudio(this.getElementId()),this.referencedInContextAssemblyIds=[],this.visibleInContextAssembly="",this.editedInContextOccurrences=[]}getEditedOccurrenceForAssembly(e,t){const i=(0,Vg.Z)(this.editedInContextOccurrences,{assemblyElementId:e,contextId:t});return i?i.occurrence:null}removeInstantiationForEditing(e){this.removeInContextAssemblies();for(let t=0;t<this.components.length;++t)this.components[t].removePartStudioInstantiation(e);this.dimensionComponent.remove(),this.annotationComponent?.hide(),this.imageComponent.remove()}instantiateForEditingInNode(e){this.isCachedPartStudioPendingUse=!1,this.bodyComponent.instantiateForPartStudio(e),this.sketchComponent.instantiateForPartStudio(e),this.mateConnectorComponent.instantiateForPartStudio(e),this.planeComponent.instantiateForPartStudio(e),this.pointBodyComponent.instantiateForPartStudio(e),this.dimensionComponent.updateDisplays()}getDimensionGraphic(e,t){return this.dimensionComponent.getDimensionGraphic(e,t)}addOrUpdateOccurrence(e,t,i){this.isCachedPartStudioPendingUse=!1,this.sketchComponent.addOrUpdateOccurrence(e,t),this.bodyComponent.addOrUpdateOccurrence(e,t),i&&this.mateConnectorComponent.addOrUpdateOccurrence(e,t)}removeOccurrence(e,t){this.sketchComponent.removeOccurrence(e,t),this.bodyComponent.removeOccurrence(e,t),this.mateConnectorComponent.removeOccurrence(e,t),this.imageComponent.removeOccurrence(e)}getChildNodesWithId(e,t){const i=[],s=t?[t]:this.getSceneGraph().getAllNodesWithId(RE),n=function(t){return t.getId()===e&&i.push(t),!1};for(let e=0;e<s.length;++e)s[e].walk(n);return i}hideSketch(e){this.sketchComponent.hideShowFeature(e,Xs.EE.HIDDEN),this.dimensionComponent.sketchHidden(e),this.imageComponent.onSketchHidden(e),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Xs.EE.HIDDEN)}hideDimensions(e){this.dimensionComponent.sketchHidden(e)}showSketch(e){this.sketchComponent.hideShowFeature(e,Xs.EE.VISIBLE),this.dimensionComponent.sketchShown(e),this.imageComponent.onSketchShown(e),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Xs.EE.VISIBLE)}displaySketchAsActive(e,t){void 0===t&&(t=!0),this.sketchComponent.displaySketchAsActive(e,t),this.dimensionComponent.displaySketchAsActive(e,t),t?this.imageComponent.onSketchActivated(e):this.imageComponent.onSketchDeactivated(e)}displaySketchAsInactive(e){this.displaySketchAsActive(e,!1)}hasActiveSketch(){return this.sketchComponent.hasActiveSketch()}getPartNodes(e){return this.getChildNodesWithId(om,e)}setPlaneAppearance(e,t){this.planeComponent.updateFeatureAppearance(e,t)}getBoundsOutsideElementNode(){const e=new wi.kB;return e.addBox(this.planeComponent.getVisiblePlaneBounds()),e.addBox(this.dimensionComponent.getVisibleDimensionBounds()),e.addBox(this.mateConnectorComponent.getVisibleMateConnectorBounds()),e}showPointBodies(e){this.pointBodyComponent.hideShowFeature(e,Xs.EE.VISIBLE),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Xs.EE.VISIBLE)}hidePointBodies(e){this.pointBodyComponent.hideShowFeature(e,Xs.EE.HIDDEN),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Xs.EE.HIDDEN)}hidePart(e){const t=this.bodyComponent.hideShowBody(e,Xs.EE.HIDDEN,TE.KF);return t&&this.trigger("BODY_VISIBILITY_CHANGE."+e,Xs.EE.HIDDEN),t}showPart(e){const t=this.bodyComponent.hideShowBody(e,Xs.EE.VISIBLE,TE.KF);return t&&this.trigger("BODY_VISIBILITY_CHANGE."+e,Xs.EE.VISIBLE),t}changePartColor(e,t,i){this.bodyComponent.setBodyColor(e,t,i)}changePartOpacity(e,t,i){this.bodyComponent.setBodyOpacity(e,t,i)}getPartColor(e){return this.bodyComponent.getBodyColorByBodyId(e).slice(0)}getPartOpacity(e){return this.bodyComponent.getBodyColorByBodyId(e)[3]}getEntityColor(e){return this.bodyComponent.getEntityColor(e)}hideConstructionPlane(e){this.planeComponent.hideShowFeature(e,Xs.EE.HIDDEN),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Xs.EE.HIDDEN)}showConstructionPlane(e){this.planeComponent.hideShowFeature(e,Xs.EE.VISIBLE),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Xs.EE.VISIBLE)}hideFeatureBodies(e,t){this.bodyComponent.hideShowFeature(e,Xs.EE.HIDDEN,t),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Xs.EE.HIDDEN)}showFeatureBodies(e,t){this.bodyComponent.hideShowFeature(e,Xs.EE.VISIBLE,t),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Xs.EE.VISIBLE)}hideMateConnector(e,t){this.mateConnectorComponent.hideShowFeature(e,Xs.EE.HIDDEN,null,t),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Xs.EE.HIDDEN)}showMateConnector(e,t){this.mateConnectorComponent.hideShowFeature(e,Xs.EE.VISIBLE,null,t),this.trigger("FEATURE_VISIBILITY_CHANGE."+e,Xs.EE.VISIBLE)}getEntitiesForFeature(e,t){let i=[];for(let s=0;s<this.components.length;++s){const n=this.components[s].getEntitiesForFeature(e,t);n&&(i=i.concat(n))}return i}getFilteredEntityIds(e){let t=[];for(let i=0;i<this.components.length;++i){const s=this.components[i].getEntitiesForFilterFunction(e);s&&(t=t.concat(s))}return t}getEntitiesForSketchGroup(e,t,i){return this.sketchComponent.getEntitiesForFeature(t,(function(t){let s=0===t.getSketchGroupId().indexOf(e);return t.isSketchTextEntity()&&(s=s&&["left","right","ascent","baseline"].some((function(e){return t.getSketchEntityId().indexOf(e)>0}))),i&&(s=s&&i(t)),s}))||[]}getEntitiesForBody(e,t){let i=[];for(let s=0;s<this.components.length;++s){const n=this.components[s].getEntitiesForBody(e,t);n&&(i=i.concat(n))}return i}bodyEntitiesVistor(e,t,i){const s=this.getEntitiesForBody(e,i);for(let e=0;s&&e<s.length;++e){if(!t(s[e]))break}}retrieveSketchEntityDeterministicId(e,t){return this.sketchComponent.retrieveSketchEntityDeterministicId(e,t)}onDeletion(e){this.reset(e)}hasFeature(e){for(let t=0;t<this.components.length;++t)if(this.components[t].hasFeature(e))return!0;return!1}getFeatureVisibility(e){for(let t=0;t<this.components.length;++t)if(this.components[t].hasFeature(e))return this.components[t].getFeatureVisibility(e);return Xs.EE.HIDDEN}hasBody(e){for(let t=0;t<this.components.length;++t)if(this.components[t].hasBody(e))return!0;return!1}getBodyVisibility(e){return this.bodyComponent.isBodyVisible(TE.KF,e)?Xs.EE.VISIBLE:Xs.EE.HIDDEN}getUIElementsForSelection(e){let t=[];if((e.isMateConnector()||e.isFeature())&&(t=this.mateConnectorComponent.getUIElementsForSelection(e)),(e.isEntity()||e.isFromConstructionGeometry()||e.isDerivedFeature())&&(t=t.concat(this.planeComponent.getUIElementsForSelection(e))),e.isAnnotation()){const i=this.annotationComponent.getUiElementForSelection(e);i&&t.push(i)}if(e.isDimension()){const i=this.dimensionComponent.getUiElementForSelection(e);i&&t.push(i)}return t}getInContextImportEntityIdsForSelection(e){let t=[];const i=e.getInContextImports();if(i&&i.length>0)for(let e=0;e<i.length;++e){const s=this.getEntitiesForFeature(i[e],Hg);t=t.concat(s)}return t||[]}getEntityIdsForSelection(e){let t=[];if(e.isMateConnector())t=this.mateConnectorComponent.getEntityIdsForSelection(e);else if(e.isProperty()){if(e.getChildSelections())for(let i=0;i<e.getChildSelections().length;++i)t=t.concat(this.getEntityIdsForSelection(e.getChildSelections()[i]))}else if(e.isEntity())t.push(e.getIdString());else if(e.isFeature())t=this.getEntitiesForFeature(e.getIdString(),Hg);else if(e.isSketchGroup()){const i=e.getSketchGroupFeatureId();i?t=this.getEntitiesForSketchGroup(e.getIdString(),i,Hg):Ug.info("Sketch group selection did not have a valid sketch id")}else if(e.isBody()){const i=this.getEntityIdsForBodySelection(e.getIdString(),e.getOccurrence(),e.getBodyMetaData());i&&i.length&&(t=t.concat(i))}else if(e.isTableItem()){const i=e.getOccurrence();for(let s=0;s<e.getDeterministicIdList().length;++s){const n=e.getDeterministicIdList()[s],r=this.getEntityIdsForBodySelection(n,i,this.retrieveBodyMetaData(n));r&&r.length?t=t.concat(r):t.push(n)}}return t||[]}getEntityIdsForBodySelection(e,t,i){let s=[];s=i&&i.isComposite?i.constituentBodyIds:[e];let n=[];for(let e=0;e<s.length;++e){const i=s[e],r=this.retrieveBodyMetaData(i);if(r&&this.bodyComponent.hasBodyOccurrence(r.meshGroupId,t))if(this.bodyComponent.isBodyLoaded(i)){const e=this.getEntitiesForBody(i,Gg);e&&e.length&&(n=n.concat(e))}else n.push(i);else{const e=this.retrieveBodyMetaData(i),t=e?.isPointBody()?null:Hg,s=this.sketchComponent.getEntitiesForBody(i,t);n=s||this.pointBodyComponent.getEntitiesForBody(i)}}return n}getOccurrenceEntityIdsForHighlight(e){if(e){const t=this.viewer.getIdForOccurrence(e);return this.sketchComponent.getEntitiesForOccurrenceSelection(t)||[]}return[]}getOccurrencesForSelection(e){let t=[];if(e.isMateConnector())t=this.mateConnectorComponent.getOccurrencesForSelection(e);else if(e.isBody()){const i=this.bodyComponent.retrieveBodyMetaData(e.getBodyId());if(i&&!i.hasTessellationSettings()){const i=this.bodyComponent.getPartStudioBodyOccurrenceName(e.getBodyId());t.push(k._oC.getOccurrenceFromPathString(i))}}return t}getOccurrenceBounds(e){const t=new wi.kB;for(let i=0;i<this.components.length;i++){const s=this.components[i];t.addBox(s.getOccurrenceBounds(e))}return t}setPlaneName(e,t){this.planeComponent.setPlaneName(e,t)}getMateConnectorGraphics(e,t){return this.mateConnectorComponent.getMateConnectorGraphics(e,t)}getMateConnectorData(e,t){return this.mateConnectorComponent.getMateConnectorData(e,t)}getAllMateConnectorGraphics(e){const t=this;let i=[];return this.mateConnectorComponent.featureToIds.each((function(s,n){if(t.hasMateConnectorDefinition(e,n)){const s=t.getMateConnectorGraphics(e,n);s&&(i=i.concat(s))}return!1})),i}hasMateConnectorDefinition(e,t){return!!this.getMateConnectorGraphics(e,t)}addStatistics(e,t,i=!1,s=!0){this.bodyComponent.addStatistics(e,t,i,s),t&&(this.errorComponent.addStatistics(e,this.getFullElementId()),this.mateConnectorComponent.addStatistics(e),this.sketchComponent.addStatistics(e))}getBoundsForEntities(e){if(!e||0===e.length)return null;const t=new wi.kB;for(let i=0;i<e.length;++i){const s=this.extractMeshIncrement(e[i]);s&&t.addBox(s.getBounds())}return t}getFeatureBounds(e){const t=this.getBoundsForEntities(this.getEntitiesForFeature(e,(function(e){return!e.isFromSketch()||e.isUserSketchEntity()})));return t&&t.addBox(this.dimensionComponent.getDimensionBoundsForFeature(e)),t}getEntityBounds(e,t){const i=this.retrieveEntityMetaData(e);if(!i)return null;if(i.isFromBody()&&!this.bodyComponent.isBodyActiveInView(this.bodyComponent.getEntityBodyGroupId(i),t))return null;const s=this.extractMeshIncrement(e);return s?.getBounds()||null}getBodyBounds(e,t){if(this.bodyComponent.isBodyActiveInView(e,t)){const t=this.retrieveBodyMetaData(e);if(t)return t.getBounds()}return null}getBodyComponent(e){return this.bodyComponent}getDimensionComponent(){return this.dimensionComponent}getPartStudioBodyOccurrenceIds(){return this.bodyComponent.getPartStudioBodyOccurrenceIds()}getPartStudioOccurrenceIds(){const e=this.bodyComponent.getPartStudioBodyOccurrenceIds(),t=[this.sketchComponent.sketchComponentElementId],i=this.planeComponent.getPartStudioPlaneOccurrenceIds();return e.concat(t,i)}getContextCameraData(e){return this.displayedContextTransform[e]?this.viewer.getCameraData(this.displayedContextTransform[e].getGlMatrix()):{camera:null,cameraExtents:null}}getInstantiatedTriangleCount(){return this.bodyComponent.getInstantiatedTriangleCount()}getSketchComponent(){return this.sketchComponent}getImageComponent(){return this.imageComponent}getMateConnectorComponent(){return this.mateConnectorComponent}getPlaneComponent(){return this.planeComponent}getAnnotationComponent(){return this.annotationComponent}getIsInternal(){return!this.isExternal&&!this.isForIncontextDisplay}getEstimatedMemoryUsageOfBodies(){return this.bodyComponent.getEstimatedMemoryUsage()}unloadBody(e){this.bodyComponent.unloadBody(e)}getPartStudioOccurrenceIdForSelection(e){return e.getOccurrence()?TE.Qy:e.isFromBody()?this.bodyComponent.getCorrectedBodyOccurrenceId(e.getBodyId(),TE.KF):e.isFromSketch()?this.sketchComponent.sketchComponentElementId:e.isConstructionPlane()?this.planeComponent.getSelectionOccurrenceId(e):TE.KF}getBodyTransform(e,t){const i=this.bodyComponent;let s=i.partStudioBodyIdToOccurrenceId[e];if(!s){const n=t.getModelViewManagers().getManager().alternateEntityMapping.get(e);n&&(s=i.partStudioBodyIdToOccurrenceId[n])}return s?(0,j.as)(ND,t).getOccurrenceDataManager().getOccurrenceTransform(s):ue.create()}getMeshOwnerId(){return this.meshOwnerId}updateEntityHighlight(e,t,i,s){for(let n=0;n<this.components.length&&!this.components[n].updateEntityHighlight(e,t,i,s);++n);}getElementType(){return k.GNh.PARTSTUDIO}collectComponentsForHeapDump(e){this.bodyComponent.collectComponentsForHeapDump(e)}updatePSOI(e){this.bodyComponent.updatePSOI(e)}getDecalIdsAffectingEntity(e){return this.bodyComponent.getDecalComponent().getDecalIdsAffectingEntity(e)}onAppearanceConstantsUpdated(){for(const e of this.components)e.onAppearanceConstantsUpdated()}onRenderingModeChanged(){for(const e of this.components)e.onRenderingModeChanged()}getIncrementMeshDetails(e){const t=this.getMeshManager().getIncrementDetails(e,this.getMeshOwnerId());if(t)return t;const i=this.getSharedBaseMeshManager();return i?i.getIncrementDetails(e,this.getMeshOwnerId()):null}getSheetMetalTransform(e,t){return e.isFromSketch()?this.getSketchComponent().getTransformForSketchEntity(e.getDeterministicId()):this.getBodyTransform(e.getBodyId(),t)}}class Wg{constructor(e,t,i,s){this.usage=e,this.elementId=t,this.viewer=i,this.dimensionData={},this.dimensionDisplays={},this.visibleDimensionBounds=null,this.activeFeatureId=null,this.annotationPaneIsOpen=!1,(0,Sh.Yk)(i),this.activeSketchIds=new mt.StringSet,this.persistentDimensionKeys=new Set,s&&(this.activeFeatureId=s.activeFeatureId,this.activeSketchIds=s.activeSketchIds.clone())}processDisplayData(e){const t=this.usage===ys.L.PREVIEW;if(!t||this.activeFeatureId&&!this.activeSketchIds.contains(this.activeFeatureId)){this.dimensionData={};for(let i=0;i<e.dimensions.length;++i){const s=e.dimensions[i];s&&s.isAssociatedWithFlat===this.viewer.getIsForFlattenedDisplay()&&(!t||s.isAnnotationDimension&&s.featureId===this.activeFeatureId)&&(this.dimensionData[s.getFullyQualifiedId()]=s)}}}reset(){this.remove(),this.dimensionData={},this.activeSketchIds.clear()}onActiveFeatureChanged(e){this.activeFeatureId=e}getActiveFeatureId(){return this.activeFeatureId}remove(){Object.values(this.dimensionDisplays).forEach((function(e){e.remove()})),this.dimensionDisplays={}}isDimensionForDisplayedSheetMetalModel(e,t){if(!this.viewer.getIsForFlattenedDisplay())return!0;const i=this.viewer.getModelViewManagers().getManager(),s=t||i.getSelectedSheetmetalModelId(),n=this.dimensionData[e];if(n){return s===i.getDisplayedPartStudio().getSketchComponent().getSMModelIdForSketch(n.featureId)}return!0}showDimensionsWithSheetmetalModelIdOnly(e,t){for(const t in this.dimensionDisplays){const i=this.isDimensionForDisplayedSheetMetalModel(t,e),s=this.dimensionDisplays[t],n=this.dimensionData[t];i&&n&&this.shouldDisplayForFeature(n.featureId)?s&&(this.showDimension(s,!0),this.resetVisibleDimensionBounds()):s.hide()}}shouldShowDimension(e,t){return!!this.shouldDisplayForFeature(t)||!(!this.annotationPaneIsOpen||!this.persistentDimensionKeys.has(e))}shouldDisplayForFeature(e){return this.activeSketchIds.contains(e)||this.activeFeatureId===e}showDimension(e,t){e.setFeatureActive(t),e.show()}onAnnotationPaneOpenClosed(e){this.dimensionDisplays&&(this.annotationPaneIsOpen=e,Object.entries(this.dimensionDisplays).forEach((([t,i])=>{if(i.getIsAnnotationDimension()&&this.isDimensionForDisplayedSheetMetalModel(t)){const s=this.shouldDisplayForFeature(i.getFeatureId());e&&this.persistentDimensionKeys.has(t)?this.showDimension(i,s):s||i.hide()}}),this),this.resetVisibleDimensionBounds(),this.updateDimensionsToLatestFromModel())}updateDimensionsVisibility(){Object.entries(this.dimensionDisplays).forEach((([e,t])=>{if(this.isDimensionForDisplayedSheetMetalModel(e)){const i=this.shouldDisplayForFeature(t.getFeatureId());this.annotationPaneIsOpen&&this.persistentDimensionKeys.has(e)?this.showDimension(t,i):i||t.hide()}})),this.resetVisibleDimensionBounds(),this.updateDimensionsToLatestFromModel()}setPersistentDimensions(e){this.persistentDimensionKeys.clear();for(const t of e)this.persistentDimensionKeys.add(k._w.createFullyQualifiedId(t.featureId,t.constraintId,t.parameterId,t.partId));this.updateDimensionsVisibility()}updateDisplays(){let e,t;const i=[];for(e in this.dimensionDisplays)this.dimensionData.hasOwnProperty(e)||i.push(e);for(let s=0;s<i.length;++s)e=i[s],t=this.dimensionDisplays[e],t.remove(),delete this.dimensionDisplays[e];Object.entries(this.dimensionData).forEach((([e,i])=>{if(t=this.dimensionDisplays[e],t?.getShouldBeRecreated(i)&&(t.remove(),delete this.dimensionDisplays[e],t=null),!t){if(t=RA(i,this.elementId,this.viewer),!t)return;this.dimensionDisplays[e]=t,this.shouldShowDimension(e,i.featureId)&&this.isDimensionForDisplayedSheetMetalModel(e)?(this.showDimension(t,this.shouldDisplayForFeature(i.featureId)),this.resetVisibleDimensionBounds()):t.hide()}if(this.viewer.getIsForFlattenedDisplay()){const e=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio(),s=e.getSketchComponent().getOwnerFlattenedBodyIdForSketch(i.featureId);if(s){const i=e.retrieveBodyMetaData(s);if(i){const s=e.getBodyComponent().getTransformFromSheetMetalBodyMetaData(i);t.setAppliedTransform(s)}}}t.updateFromDisplayData(i)}),this),this.updateDimensionsToLatestFromModel()}displaySketchAsActive(e,t){this.activeSketchIds.contains(e)!==t&&(t?this.activeSketchIds.add(e):this.activeSketchIds.remove(e),Object.entries(this.dimensionDisplays).forEach((([i,s])=>{s.getFeatureId()!==e||s.getIsAnnotationDimension()||(t&&this.isDimensionForDisplayedSheetMetalModel(i)?this.showDimension(s,t):s.hide())}),this),this.resetVisibleDimensionBounds(),this.updateDimensionsToLatestFromModel())}updateDimensionsToLatestFromModel(){const e=ma.W.getSingleton().getModelTreeState(this.elementId);e&&this.updateDimensionsFromModel(e.getModelTree())}getDimensionId(e,t,i){let s="";return i&&Wg.parameterIdsIncludedInDisplayData.includes(i)&&(s=i),k._w.createFullyQualifiedId(e,t,s)}updateDimensionsFromModel(e){const t=new Map,i=e.children;for(const e of i)if(e instanceof k.OEu&&this.activeSketchIds.contains(e.featureId))for(const i of e.constraints)for(const s of i.parameters){if(s instanceof k.nmJ){const n=this.getDimensionId(e.featureId,i.entityId,s.parameterId),r=s.getParameterForCurrentConfiguration(es.Jq.ConfigurationsService);t.set(n,{configured:!0,expression:Xg(r)?r?.expression:void 0});break}if(Xg(s)){const n=this.getDimensionId(e.featureId,i.entityId,s.parameterId);t.set(n,{expression:s.expression})}}Object.entries(this.dimensionDisplays).forEach((([e,i])=>{const s=t.get(e);i.setIsConfigured(s?.configured??!1),i.setExpression(s?.expression??"")}))}sketchHidden(e){this.activeSketchIds.contains(e)&&Object.values(this.dimensionDisplays).forEach((t=>{t.getFeatureId()!==e||t.getIsAnnotationDimension()||(t.hide(),this.resetVisibleDimensionBounds())}),this)}sketchShown(e){this.activeSketchIds.contains(e)&&Object.entries(this.dimensionDisplays).forEach((([t,i])=>{i.getFeatureId()===e&&!i.getIsAnnotationDimension()&&this.isDimensionForDisplayedSheetMetalModel(t)&&(this.showDimension(i,this.shouldDisplayForFeature(e)),this.resetVisibleDimensionBounds())}),this)}getDimensionGraphic(e,t,i){const s=this.getDimensionId(e,t,i);return this.dimensionDisplays[s]}getFeatureDimensionGraphic(e,t,i,s){const n=k._w.createFullyQualifiedId(e,t,i,s);return this.dimensionDisplays[n]}getUiElementForSelection(e){if(this.dimensionDisplays)return this.dimensionDisplays[e.selectionId]}getDimensionGraphicFromSketch(e){return Object.values(this.dimensionDisplays).filter((t=>t?.getDisplayData()?.featureId===e))}getDimensionBoundsForFeature(e){if(!this.shouldDisplayForFeature(e))return null;const t=new wi.kB;return Object.values(this.dimensionDisplays).forEach((function(i){i.getFeatureId()===e&&t.addBox(i.getFitBounds())}),this),t}resetVisibleDimensionBounds(){this.visibleDimensionBounds=null}getVisibleDimensionBounds(){return this.activeSketchIds.isEmpty()?null:(this.visibleDimensionBounds||(this.visibleDimensionBounds=new wi.kB,Object.values(this.dimensionDisplays).forEach((e=>{e.isVisibleToUser()&&this.visibleDimensionBounds?.addBox(e.getFitBounds())}),this)),this.visibleDimensionBounds)}}Wg.parameterIdsIncludedInDisplayData=[k.s7b.RHO_PARAMETER_NAME,k.s7b.BEZIER_DEGREE_PARAMETER_NAME,k.s7b.PATTERN_INSTANCE_COUNT1_PARAMETER_NAME,k.s7b.PATTERN_INSTANCE_COUNT2_PARAMETER_NAME];const zg=new Set([k.s7b.LENGTH_PARAMETER_NAME,k.s7b.ANGLE_PARAMETER_NAME,k.s7b.RHO_PARAMETER_NAME,k.s7b.BEZIER_DEGREE_PARAMETER_NAME,k.s7b.PATTERN_INSTANCE_COUNT1_PARAMETER_NAME,k.s7b.PATTERN_INSTANCE_COUNT2_PARAMETER_NAME]);function Xg(e){return e instanceof k.wtM&&zg.has(e.parameterId)}const Zg=_e.O.createLogger("partstudiocomponent",k.bVy.GRAPHICS);var qg;!function(e){e[e.FACE=0]="FACE",e[e.EDGE=1]="EDGE"}(qg||(qg={}));class Yg{constructor(e,t,i){this.parent=e,this.viewer=t,this.idToMetaData={},this.childFeatureIds=new Set,this.removedBaseIncrements=null,this.featureVisibility={},this.insertableIdToTypeToIncrement=null,(0,Sh.Yk)(t),this.usage=void 0===i?ys.L.BASE:i,this.featureToIds=new Gl.TemplatedNestedMap,this.bodyToEntity=new Gl.TemplatedNestedMap}copyToClone(e){e.featureToIds=this.featureToIds.cloneNested(),e.bodyToEntity=this.bodyToEntity.cloneNested();for(const t in this.idToMetaData){const i=this.idToMetaData[t],s=(0,j.shallowClone)(i);e.idToMetaData[t]=s,s.setBodyId(i.getBodyId());const n=e.retrieveBodyMetaData(s.getBodyId());n&&s.setBodyMetaData(n);const r=i.getMeshIncrement();r&&(s.setMeshIncrement(r.clone(e.getMeshOwnerId())),e.isInstantiated()&&e.updateEntityGraphics(t,s.getMeshIncrement(),s))}}copyToPreview(e){for(const t in this.idToMetaData)e.idToMetaData[t]=this.idToMetaData[t];e.featureToIds=this.featureToIds.cloneNested(),e.bodyToEntity=this.bodyToEntity.cloneNested();for(const t in this.featureVisibility)e.featureVisibility[t]=this.featureVisibility[t]}reset(e){if(this.removedBaseIncrements=null,this.featureToIds.clear(),this.bodyToEntity.clear(),!e)for(const e in this.idToMetaData)this.removeMeshIncrement(e);this.idToMetaData={}}isInstantiated(){return!0}isForBase(){return this.usage===ys.L.BASE}getEntityIdManager(){return this.parent.getEntityIdManager()}getMeshManager(){return this.parent.getMeshManager()}getSharedBaseMeshManager(){return this.parent.getSharedBaseMeshManager()}getMeshOwnerId(){return this.parent.getMeshOwnerId()}getBodyManager(){return this.viewer.getBodyManager()}processDeletions(e){for(const t in e.deterministicIdToEntity){const i=e.deterministicIdToEntity[t];i&&(!i.isDeletion()&&this.handlesEntity(i)||this.removeEntity(t))}}processAdditionsAndChanges(e,t,i){for(const t in e.deterministicPartIdToData){const i=e.deterministicPartIdToData[t],s=this.parent.isBodyContainedInInsertableDisplayBuffers(t);for(let n=0;n<i.entityDIds.length;++n){const r=i.entityDIds[n],a=e.deterministicIdToEntity[r];if(!a||a.isDeletion()||!this.handlesEntity(a,i))continue;let o=null;(s||(o=xE(a,r,this.getEntityIdManager().getOrCreateIdForName(r)),o||!this.expectsTessellation()))&&(this.removeOldEntityGraphics(r,a),this.addIdMappings(r,a,t,e),s||(a.setMeshIncrement(o),this.isInstantiated()&&this.updateEntityGraphics(r,o,a)),this.viewer.getIsForFlattenedDisplay()===i.isForFlattenedView()&&a.removeGeometry())}}}processPrecompiledGraphicsBuffers(e){if(this.viewer.areOptimizedBuffersEnabled){this.insertableIdToTypeToIncrement||(this.insertableIdToTypeToIncrement=new Map);for(const[t,i]of Object.entries(e)){const e=Object.values(i);if(0===e.length)continue;const s=e[e.length-1];if(!s?.graphicsBuffers)continue;const n=this.retrieveBodyMetaData(t);if(n&&n.isForFlattenedView()!==this.viewer.getIsForFlattenedDisplay())continue;const r=s.graphicsBuffers,a=r[k.bdZ.POINTS],o=r[k.bdZ.LINES],h=r[k.bdZ.TRIANGLE_STRIP];if(a){const e=a[k.xB1.ARRAY_BUFFER];if(e){e.setPrimitiveType(Ai.MX.POINTS);e.mapGraphicsAttributeToComponentCount[k.hOe.POINT],e.bufferData}}if(o){const e=o[k.xB1.ARRAY_BUFFER];if(e){const i=o[k.xB1.ELEMENT_ARRAY_BUFFER];if(i){i.setPrimitiveType(Ai.MX.LINES);const s=new Float32Array(e.bufferData.buffer),n=new Uint32Array(i.bufferData.buffer),r=new eT(Ai.MX.LINES,s,n,t+".edges",void 0,!0);r.groupId=t,this.getMeshManager().addMeshIncrement(r,this.getMeshOwnerId());let a=this.insertableIdToTypeToIncrement.get(t);a||(a=new Map,this.insertableIdToTypeToIncrement.set(t,a)),a.set(qg.EDGE,r)}}}if(h){const e=h[k.xB1.ARRAY_BUFFER];if(e){const i=e.mapGraphicsAttributeToComponentCount[k.hOe.NORMAL],s=i&&i>0,n=h[k.xB1.ELEMENT_ARRAY_BUFFER];if(n){n.setPrimitiveType(Ai.MX.TRIANGLE_STRIP);const i=new Float32Array(e.bufferData.buffer),r=new Uint32Array(n.bufferData.buffer),a=new eT(Ai.MX.TRIANGLE_STRIP,i,r,t+".faces",void 0,!0);a.groupId=t,s&&a.addVertexAttribute(RS.NORMAL),this.getMeshManager().addMeshIncrement(a,this.getMeshOwnerId());let o=this.insertableIdToTypeToIncrement.get(t);o||(o=new Map,this.insertableIdToTypeToIncrement.set(t,o)),o.set(qg.FACE,a)}}}}}}hasBody(e){return this.bodyToEntity.has(e)}retrieveBodyMetaData(e){const t=this.bodyToEntity.get(e);let i=null;return t&&t.each(((e,t)=>{const s=this.idToMetaData[t];return s&&(i=s.getBodyMetaData()),!!i})),i}retrieveAssociatedFeatureIds(e){return this.deterministicIdToAssociatedFeatureIds&&this.deterministicIdToAssociatedFeatureIds[e]||null}getEntitiesForBody(e,t){const i=this.bodyToEntity.get(e);return i?GE(i,this.idToMetaData,t):null}onAppearanceConstantsUpdated(){}onRenderingModeChanged(){}getHideableFeatureIds(){throw"This method should be overridden by a subclass"}updateEntityGraphics(e,t,i){throw"This method should be overridden by a subclass"}expectsTessellation(){return!0}getEntityCount(){return Object.keys(this.idToMetaData).length}containsEntity(e){return this.idToMetaData.hasOwnProperty(e)}getEntityMetaData(e){const t=this.idToMetaData[e];return t||null}removeEntity(e){this.removeBaseIncrement(e);this.idToMetaData[e]&&(this.removeMeshIncrement(e),this.removeIdMappings(e),this.getEntityIdManager().removeName(e))}extractMeshIncrement(e){const t=this.idToMetaData[e];return t?t.getMeshIncrement():null}addMeshIncrement(e,t){return e.pickId=this.getEntityIdManager().getOrCreateIdForName(e.id),this.getMeshManager().addMeshIncrement(e,this.getMeshOwnerId(),t)}getOccurrenceData(e){return this.viewer.getOccurrenceDataManager().getOccurrenceData(e)}getMeshIncrementDetails(e){return this.getMeshManager().getIncrementDetails(e,this.getMeshOwnerId())}getBaseMeshIncrementDetails(e){const t=this.getSharedBaseMeshManager();return t?t.getIncrementDetails(e,this.getMeshOwnerId()):null}hideMeshIncrement(e,t){const i=this.getOccurrenceData(t),s=this.getMeshIncrementDetails(e);let n=!1;return i&&s&&(n=i.hideIncrement(s,this.usage)),this.hideBaseIncrement(e,t),n}showMeshIncrement(e,t){const i=this.getOccurrenceData(t),s=this.getMeshIncrementDetails(e);let n=!1;return i&&s&&(n=i.showIncrement(s,this.usage)),this.showBaseIncrement(e,t),n}removeMeshIncrement(e){return this.getMeshManager().removeMeshIncrement(e,this.getMeshOwnerId())}setMeshIncrementRemovedFromBase(e,t){this.removedBaseIncrements||(this.removedBaseIncrements=new Gl.TemplatedNestedMap),this.removedBaseIncrements.insertNested(t,e,!0)}wasIncrementRemovedFromBase(e,t){return!!this.removedBaseIncrements&&this.removedBaseIncrements.hasNested(t,e)}removeBaseIncrement(e){this.removeBaseIncrementFromOccurrence(e,TE.KF)}removeBaseIncrementFromOccurrence(e,t){this.hideBaseIncrement(e,t)&&this.setMeshIncrementRemovedFromBase(e,t)}hideBaseIncrement(e,t){const i=this.getSharedBaseMeshManager();if(i){const s=this.getOccurrenceData(t);if(s){const t=i.getIncrementDetails(e,this.getMeshOwnerId());if(t)return s.hideIncrement(t,this.usage),!0}}return!1}showBaseIncrement(e,t){const i=this.getSharedBaseMeshManager();if(i&&!this.wasIncrementRemovedFromBase(e,t)){const s=this.getOccurrenceData(t),n=i.getIncrementDetails(e,this.getMeshOwnerId());if(s&&n)return s.showIncrement(n,this.usage),!0}return!1}removeOldEntityGraphics(e,t){this.removeEntity(e)}updateSMMapping(e,t){}addManagedIdMappings(e,t){const i=this.bodyToEntity.get(t);if(i)for(const t of i.getKeys()){const i=this.idToMetaData[t];i?!i.isDeletion()&&this.handlesEntity(i)&&(this.updateSMMapping(t,i),this.featureToIds.insertNested(e,t,!0),i.featureIds.find((t=>e===t))||(this.childFeatureIds.add(e),i.featureIds.push(e))):Zg.warn(`entityData was not present for entityId in part studio for usage - ${this.usage} in ${this.getComponentId()}`)}}addIdMappings(e,t,i,s){this.getEntityIdManager().getOrCreateIdForName(e),this.idToMetaData[e]=t;const n=t.getFeatureIds();for(let t=0;n&&t<n.length;++t)this.featureToIds.insertNested(n[t],e,!0);t.setBodyId(i),i&&this.bodyToEntity.insertNested(i,e,!0)}removeIdMappings(e){const t=this.idToMetaData[e];if(delete this.idToMetaData[e],!t)return;const i=t.getFeatureIds();for(let t=0;t<i.length;++t)this.featureToIds.removeNested(i[t],e),this.childFeatureIds.delete(i[t]);this.bodyToEntity.removeNested(t.getBodyId(),e)}hasFeature(e){return this.featureToIds.has(e)}getEntitiesForFeature(e,t){if(this.featureIdToAssociatedDeterministicIds&&this.featureIdToAssociatedDeterministicIds.hasOwnProperty(e)){const i=new Set;for(const s of this.featureIdToAssociatedDeterministicIds[e])this.bodyToEntity.has(s)?this.bodyToEntity.get(s).each(((e,s)=>{let n=!0;if(t){const e=this.idToMetaData[s];e&&t(e)||(n=!1)}n&&i.add(s)})):i.add(s);return[...i]}{const i=this.featureToIds.get(e);return i?GE(i,this.idToMetaData,t):null}}getEntitiesForFilterFunction(e){const t=[];for(const i in this.idToMetaData)e(this.idToMetaData[i])&&t.push(i);return t}isEntityHidden(e,t){const i=e.getFeatureIds();for(let e=0;e<i.length;++e)if(this.featureVisibility[i[e]]===Xs.EE.HIDDEN)return!0;return!1}getVisibleFeatureIds(){const e=[];for(const t in this.featureVisibility)this.featureVisibility[t]!==Xs.EE.HIDDEN&&this.featureToIds.has(t)&&e.push(t);return e}hideShowFeatureEntities(e,t,i){const s=this.getEntitiesForFeature(e);if(s){for(let e=0;e<s.length;++e){const i=this.getOccurrenceIdForEntity(s[e]);this.hideShowEntity(s[e],t,i)}(0,Xs.vm)()}}hideShowFeature(e,t,i,s){this.featureVisibility[e]=t,this.hideShowFeatureEntities(e,t,s)}getFeatureVisibility(e){return this.featureVisibility.hasOwnProperty(e)?this.featureVisibility[e]:Xs.EE.VISIBLE}hideShowEntity(e,t,i){return(i=i||TE.KF)!==TE.Qy&&(t===Xs.EE.HIDDEN?this.hideMeshIncrement(e,i):this.showMeshIncrement(e,i))}instantiateForPartStudio(e){}instantiateEntities(){for(const e in this.idToMetaData){const t=this.idToMetaData[e],i=t.getMeshIncrement();!i&&this.expectsTessellation()||this.updateEntityGraphics(e,i,t)}}removePartStudioInstantiation(e){}getNode(){return null}getOccurrenceIdForEntity(e){return null}getOccurrenceBounds(e){const t=new wi.kB,i=this.getNode();return i&&i.getOccurrenceBounds(e,t),t}updateEntityHighlight(e,t,i,s){if(!this.idToMetaData.hasOwnProperty(i))return!1;const n=this.getOccurrenceData(s),r=this.getMeshIncrementDetails(i)||this.getBaseMeshIncrementDetails(i);return!(!n||!r)&&(n.updateEntityHighlight(e,t,r,this.usage),!0)}}class Kg extends Yg{constructor(e,t,i){super(e,t,i),this.occurrences={}}addOrUpdateOccurrence(e,t){this.occurrences[e]=t}removeOccurrence(e,t){delete this.occurrences[e]}isOccurrenceIdForAssembly(e){return!!this.occurrences[e]}getComponentId(){return Kg.ComponentId}}Kg.ComponentId="ASSEMBLY_ENABLED_PARTSTUDIO_COMPONENT";X.default.getManager();const jg="plane_component.";class Qg{constructor(e,t,i,s){this.entityId=e,this.label="",this.center=null,this.xAxis=null,this.yAxis=null,this.update(t,i,s)}update(e,t,i){this.center=e,this.xAxis=t,this.yAxis=i}}class $g extends Yg{constructor(e,t,i){super(e,i),this.constructionPlanes={},this.planeNames={},this.planeUi=new Map,this.usage=void 0!==t?t:ys.L.BASE}clone(e){const t=new $g(e,this.usage,this.viewer);return this.copyToClone(t),t}cloneForPreview(e){const t=new $g(e,ys.L.PREVIEW,this.viewer);this.copyToPreview(t);for(const e in this.constructionPlanes)t.constructionPlanes[e]=(0,z.Z)(this.constructionPlanes[e]);return this.planeUi.forEach(((e,i)=>(t.planeUi.set(i,e.cloneForPreview()),!1))),t}extractMeshIncrement(e){const t=super.extractMeshIncrement(e);if(t)return t;const i=this.planeUi.get(e);return i?i.getIncrement():null}getVisiblePlaneBounds(){const e=new wi.kB;return this.planeUi.forEach((t=>(t.isHidden||e.addBox(t.getBounds()),!1))),e}reset(){this.removeDefaultPlanesInstantiation(),this.constructionPlanes={},super.reset()}getComponentId(){return jg}handlesEntity(e,t){return!e.hasTessellationError()&&e.isFromConstructionPlane()&&e.isFace()&&!this.viewer.getIsForFlattenedDisplay()}processAdditionsAndChanges(e,t){super.processAdditionsAndChanges(e,t),t&&this.instantiateDefaultPlanes()}updateEntityGraphics(e,t,i){t.pickId=this.getEntityIdManager().getOrCreateIdForName(e),this.updatePlaneDefinition(t,i)}getHideableFeatureIds(){return this.featureToIds.getKeys()}removeOldEntityGraphics(e,t){const i=this.idToMetaData[e];i&&i.getFirstFeatureId()!==t.getFirstFeatureId()&&this.removeEntity(e)}removeEntity(e){this.idToMetaData[e]&&(this.removePlaneUiForEntity(e),delete this.constructionPlanes[e]),super.removeEntity(e)}removePlaneUiForEntity(e){const t=this.planeUi.get(e);t&&t.remove(),this.planeUi.delete(e)}getUIElementsForSelection(e){const t=[];let i;return e.isEntity()?(i=this.planeUi.get(e.getDeterministicId()),i&&t.push(i)):e.isFeature()&&this.iterateOverEntitiesForFeature(e.getFeatureId(),(e=>{i=this.planeUi.get(e),i&&t.push(i)})),t}updatePlaneDefinition(e,t){if(!t.isFace())return;const i=e.getBounds().center(),s=M.fromValues(e.points[0],e.points[1],e.points[2]),n=M.fromValues(e.points[3],e.points[4],e.points[5]),r=M.fromValues(e.points[6],e.points[7],e.points[8]),a=ge.S4.add(s,r,M.create());ge.S4.scale(a,.5),ge.S4.subtract(a,i);const o=ge.S4.add(s,n,M.create());ge.S4.scale(o,.5),ge.S4.subtract(o,i);const h=this.constructionPlanes[e.id];h?h.update(i,a,o):this.constructionPlanes[e.id]=new Qg(e.id,i,a,o)}iterateOverEntitiesForFeature(e,t){const i=this.getEntitiesForFeature(e);if(i)for(let e=0;e<i.length;++e)t.call(this,i[e])}getFeatureIdForEntity(e){const t=this.idToMetaData[e];return t?t.getFirstFeatureId():""}hideShowFeature(e,t,i){super.hideShowFeature(e,t,i),this.iterateOverEntitiesForFeature(e,(e=>{const i=this.planeUi.get(e);i&&(t===Xs.EE.HIDDEN?i.hide():i.show())}))}updateFeatureAppearance(e,t){this.iterateOverEntitiesForFeature(e,(e=>{const i=this.planeUi.get(e);i&&i.updateAppearance(t)}))}instantiateForPartStudio(e){super.instantiateForPartStudio(e),this.instantiateDefaultPlanes()}removePartStudioInstantiation(e){super.removePartStudioInstantiation(e),this.removeDefaultPlanesInstantiation()}instantiateDefaultPlanes(){const e=[];this.planeUi.forEach(((t,i)=>(this.constructionPlanes.hasOwnProperty(i)||e.push(i),!1)));for(let t=0;t<e.length;++t)this.removePlaneUiForEntity(e[t]);const t=Hs()?"CONSTRUCTION_PLANE_COMPARE_TEXT_COLOR":"CONSTRUCTION_PLANE_TEXT_COLOR";for(const e in this.constructionPlanes){let i=this.planeUi.get(e);const s=this.constructionPlanes[e];i||(i=void 0!==this.usage&&this.usage===ys.L.PREVIEW?new cy(t,s.entityId,uh.Vv,this.getFeatureIdForEntity(e),this.viewer):new cy(t,s.entityId,uh.lL,this.getFeatureIdForEntity(e),this.viewer),this.planeUi.set(e,i)),i.updateDefinition(s.label,s.center,s.xAxis,s.yAxis,!1);const n=this.idToMetaData[e];if(n instanceof k.kdl){const e=n.getLastFeatureId();this.featureVisibility[e]===Xs.EE.HIDDEN?i.hide():i.show()}}}getPartStudioPlaneOccurrenceIds(){const e=[];return this.planeUi.forEach((t=>(e.push(t.graphicsOccurrenceId),!1))),e}getSelectionOccurrenceId(e){const t=this.planeUi.get(e.getDeterministicId());return t?t.graphicsOccurrenceId:TE.Qy}removeDefaultPlanesInstantiation(){this.planeUi.forEach((e=>{e.remove()})),this.planeUi.clear()}setPlaneName(e,t){this.planeNames[e]=t,this.iterateOverEntitiesForFeature(e,(e=>{const i=this.constructionPlanes[e];i&&(i.label=t);const s=this.planeUi.get(e);s&&s.setName(t)}))}}var Jg=i(89699);const ep=X.default.getManager();class tp extends yi.u1{constructor(e,t,i){super(t),this.inferenceData=e,this.hovered=!1,this.selected=!1,this.lastScale=-1,this.lastPickScale=-1;const s=this.inferenceData.isInContextEntity?ue.create():this.getOccurrenceTransform(this.inferenceData.occurrence,i);this.worldSpaceTransform=ge.w$.multiply(s,this.inferenceData.coordinateSystem.getGlMatrix()),this.worldSpacePosition=[this.worldSpaceTransform[12],this.worldSpaceTransform[13],this.worldSpaceTransform[14]],this.inferenceId=Mi.JE,(0,Xs.vm)()}setInferenceId(e){this.inferenceId=e}getInferenceId(){return this.inferenceId}onDevicePixelRatioChanged(e){this.updateGraphics()}setHovered(e){e!==this.hovered&&(this.hovered=e,this.updateGraphics())}getOccurrenceTransform(e,t){return t?t(e.getPathAsString()):this.viewer.getModelViewManagers().getManager().getOccurrenceTransform(e)}onViewWillDraw(e,t){this.updateTransform(e)}updateTransform(e){const t=e.getPixelSizeAtWorldPoint(this.worldSpacePosition);if(Math.abs(this.lastScale-t)<Ri.W.ZERO_LENGTH)return;this.lastScale=t;const i=ue.create();i[0]=t,i[5]=t,i[10]=t,this.setTransform(ge.w$.multiply(this.worldSpaceTransform,i,ue.create())),this.hasMeshIncrements()||this.updateGraphics()}isAxialInference(e){return e===Jg.i.TOP_AXIS_POINT||e===Jg.i.MID_AXIS_POINT||e===Jg.i.BOTTOM_AXIS_POINT||e===Jg.i.LOOP_CENTER||e===Jg.i.CENTER}updateGraphicsNoHover(e){this.isAxialInference(this.inferenceData.inferenceType)?(this.updateMeshIncrement(bl.TRIANGLES,yi.ZJ,e[bl.INFERENCE_CENTER_TRIANGLES].clone(),wl),this.updateMeshIncrement(bl.LINES,yi.ZJ,e[bl.INFERENCE_CENTER_LINES].clone(),Pl)):this.inferenceData.inferenceType===Jg.i.MID_POINT?(this.updateMeshIncrement(bl.TRIANGLES,yi.ZJ,e[bl.INFERENCE_MID_POINT_TRIANGLES].clone(),wl),this.updateMeshIncrement(bl.LINES,yi.ZJ,e[bl.INFERENCE_MID_POINT_LINES].clone(),Pl)):this.inferenceData.inferenceType===Jg.i.CENTROID?(this.updateMeshIncrement(bl.TRIANGLES,yi.ZJ,e[bl.INFERENCE_CENTROID_TRIANGLES].clone(),wl),this.updateMeshIncrement(bl.LINES,yi.ZJ,e[bl.INFERENCE_CENTROID_LINES].clone(),Pl)):this.isOriginAxisInference()?(this.updateMeshIncrement(bl.TRIANGLES,bl.INFERENCE_ORIGIN_AXIS_LINES,e[bl.INFERENCE_POINT_TRIANGLES].clone(),wl),this.updateMeshIncrement(bl.LINES,bl.INFERENCE_ORIGIN_AXIS_LINES,e[bl.INFERENCE_ORIGIN_AXIS_LINES].clone(),Pl),this.removeMeshIncrement(bl.INFERENCE_ORIGIN_AXIS_LINES_PRESELECTED)):(this.updateMeshIncrement(bl.TRIANGLES,yi.ZJ,e[bl.INFERENCE_POINT_TRIANGLES].clone(),wl),this.updateMeshIncrement(bl.LINES,yi.ZJ,e[bl.INFERENCE_POINT_LINES].clone(),Pl))}isOriginAxisInference(){return this.inferenceData&&(this.inferenceData.inferenceType===Jg.i.ORIGIN_X||this.inferenceData.inferenceType===Jg.i.ORIGIN_Y||this.inferenceData.inferenceType===Jg.i.ORIGIN_Z)}updateGraphics(){const e=Bl();this.hovered?(this.updateMeshIncrement(bl.TRIANGLES,yi.ZJ,e[bl.TRIANGLES_PRESELECTED].clone(),wl),this.updateMeshIncrement(bl.LINES,yi.ZJ,e[bl.LINES].clone(),Pl),this.isOriginAxisInference()&&this.updateMeshIncrement(bl.INFERENCE_ORIGIN_AXIS_LINES_PRESELECTED,bl.INFERENCE_ORIGIN_AXIS_LINES_PRESELECTED,e[bl.INFERENCE_ORIGIN_AXIS_LINES_PRESELECTED].clone(),Pl)):this.updateGraphicsNoHover(e)}updateOccurrenceTransform(e){if(this.inferenceData){this.worldSpaceTransform=ge.w$.multiply(e,this.inferenceData.coordinateSystem.getGlMatrix()),this.worldSpacePosition=[this.worldSpaceTransform[12],this.worldSpaceTransform[13],this.worldSpaceTransform[14]];const t=ue.create();t[0]=this.lastScale,t[5]=this.lastScale,t[10]=this.lastScale,this.setTransform(ge.w$.multiply(this.worldSpaceTransform,t,ue.create())),this.hasMeshIncrements()||this.updateGraphics(),(0,Xs.vm)()}}getUpdatedPickIncrement(e,t){let i=null;if(this.isOriginAxisInference()){const s=t.getPixelSizeAtWorldPoint(this.worldSpacePosition);if(Math.abs(s-this.lastPickScale)>Ri.W.ZERO_LENGTH){const t=ue.create();t[0]=s,t[5]=s,t[10]=s;const n=5*ep.getNumber("MATE_CONNECTOR_AXIS_LINE_LENGTH_PX"),r=3*ep.getNumber("MATE_CONNECTOR_Z_AXIS_LINE_WIDTH"),a=[0,0,n*s],o=ge.w$.multiplyVec3(this.worldSpaceTransform,a,M.create());i=(0,Yd.W5)([0,0,0],o,e?.toString(),void 0,r),i.id=e?.toString(),this.lastPickScale=s}}else 1!==this.lastPickScale&&(i=(0,Yd.Pu)(this.worldSpacePosition,e?.toString()),this.lastPickScale=1);return i&&(i.pickId=e),i}}class ip extends tp{constructor(e,t){super(e,t)}updateGraphics(){const e=Bl();this.updateGraphicsNoHover(e)}}const sp=new Gi.hF({isShowThrough:!0,isDepthTested:!1,isPickable:!1,primitiveType:Ai.MX.LINES}),np=X.default.getManager();class rp extends yi.u1{constructor(e){super(e)}updateLines(e){(0,Yd.VQ)(np.getNumber("INFERENCE_SNAP_LINE_WIDTH"),e),(0,Yd.Ab)(np.getColor("INFERENCE_SNAP_LINE_COLOR"),e),this.updateMeshIncrement("lines",yi.ZJ,e,sp)}}const ap=_e.O.createLogger("SimulationLoadDisplay",k.bVy.GRAPHICS),op=M.fromValues(1,0,0),hp=M.fromValues(0,1,0),cp=M.fromValues(0,0,1),lp=M.fromValues(0,1,0);var dp;!function(e){e.ACCELERATION_ARROW="ACCELERATION_ARROW",e.ACCELERATION_BEHIND="ACCELERATION_BEHIND",e.BEARING_ARROWS="BEARING_ARROWS",e.FORCE_ARROW="FORCE_ARROW",e.MOMENT_BASE="MOMENT_BASE",e.PRESSURE="PRESSURE",e.PRESSURE_FLIPPED="PRESSURE_FLIPPED",e.ROUND_BASE="ROUND_BASE"}(dp||(dp={}));const up={};up[dp.ACCELERATION_ARROW]="simulation/acceleration-arrow",up[dp.ACCELERATION_BEHIND]="simulation/acceleration-behind",up[dp.BEARING_ARROWS]="simulation/bearing-arrows",up[dp.FORCE_ARROW]="simulation/force-arrow",up[dp.MOMENT_BASE]="simulation/moment-base",up[dp.PRESSURE]="simulation/pressure",up[dp.PRESSURE_FLIPPED]="simulation/pressure-flipped",up[dp.ROUND_BASE]="simulation/base";const gp=X.default.getManager().getNumber("SIMULATION_LOAD_LEADER_OFFSET_RATIO"),pp=new Gi.hF({primitiveType:Ai.MX.LINES,isShowThrough:!1,isDepthTested:!0,isPickable:!1}),mp=pp.cloneAndModify({isShowThrough:!0,isDepthTested:!1,isStencilTested:!0}),fp="obliqueBaseLine",Ip=Math.cos((0,wi.Yr)(90-X.default.getManager().getNumber("SIMULATION_LOAD_OBLIQUE_BASE_LINE_ANGLE_THRESHOLD_DEGREES"))),Ep=X.default.getManager().getColor("SIMULATION_LOAD_BASE_COLOR"),Sp=X.default.getManager().getColor("SIMULATION_PRE_HIGHLIGHT_COLOR"),Tp=X.default.getManager().getColor("SIMULATION_HIGHLIGHT_COLOR"),Dp=pp.cloneAndModify({primitiveType:Ai.MX.LINES,isShowThrough:!0,isDepthTested:!1,isPickable:!0}),Cp="loadComponent",Mp="lineAxis",yp=X.default.getManager().getStipple("SIMULATION_LINE_AXIS_STIPPLE"),Ap=M.create(),Pp=M.create(),Op=(M.create(),M.create(),X.default.getManager().getNumber("SIMULATION_LOAD_GLYPH_SIZE"));class Rp{constructor(e,t,i){this.leftPoint=e,this.rightPoint=t,this.color=i}equals(e){return!!e&&(M.equals(this.leftPoint,e.leftPoint)&&M.equals(this.rightPoint,e.rightPoint)&&(0,pi.arraysEqual)(this.color,e.color))}}class wp extends yi.u1{constructor(e,t,i,s){super(t),this.loadDisplayManager=e,this.loadDisplayData=i,this.hideLoad=s,this.worldAnchorPoint=null,this.worldOrigin_=null,this.worldXAxis=null,this.worldYAxis=null,this.worldZAxis=null,this.adjustedWorldOrigin=M.create(),this.leaderRay=null,this.occupiedScreenBounds=new wi.tO,this.glyphComponents=[],this.targetId_="",this.offsetInLeaderDirection_=0,this.hideLeader=!1,this.isBeingEdited=!1}setHideLoads(e){this.hideLoad!==e&&(this.hideLoad=e,this.updateHideState(),this.updateGraphics(this.loadDisplayData))}setEditState(e){this.isBeingEdited=e,this.updateHideState(),this.updateGraphics(this.loadDisplayData)}updateHideState(){!this.hideLoad||this.isHighlighted()||this.isBeingEdited?(this.show(),this.updateGraphics(this.loadDisplayData)):this.hide()}hide(){super.hide(),this.glyphComponents.forEach((e=>{e.hide()}))}show(){super.show(),this.glyphComponents.forEach((e=>{e.show()}))}remove(){this.clearComponents(),super.remove()}update(e){const t=e||this.loadDisplayData;t&&(this.hideLoad=this.shouldBeHidden(t),this.updateHideState(),this.updateGraphics(t))}shouldBeHidden(e){return!es.Jq.SimulationService.getCanAccessSimulations()||(!!e.hidden||(!(!this.loadDisplayManager||!this.loadDisplayManager.getExplodeViewActive())||!!this.occurrenceIsHidden(e.occurrence)))}removeMeshIncrements(){super.removeMeshIncrements(),this.lastObliqueBaseLineDisplayed=null,this.lastLineAxisDisplayed=null}updateGraphics(e){if(this.viewer.requestDraw(),this.loadDisplayData=e,this.isHidden)return void this.removeMeshIncrements();switch(this.clearComponents(),this.clearPositionalData(),e.loadType){case k.DzI.ACCELERATION:case k.DzI.BEARING_LOAD:case k.DzI.FORCE:case k.DzI.MOMENT:if(M.squaredLength(this.loadDisplayData.componentValues.getVec3())<Ri.W.ZERO_LENGTH_SQUARED)return}if(this.computePositionalData(),!this.isValid)return;const t=e.status===k.EFx.SUPPRESSED?Jl.SUPPRESSED:Jl.NORMAL;switch(e.loadType){case k.DzI.ACCELERATION:this.addBaseGlyph(dp.ROUND_BASE,t),this.addDirectionGlyph(dp.ACCELERATION_ARROW,t),this.addDirectionGlyph(dp.ACCELERATION_BEHIND,t,!0);break;case k.DzI.BEARING_LOAD:this.addBaseGlyph(dp.ROUND_BASE,t),this.addDirectionGlyph(dp.BEARING_ARROWS,t);break;case k.DzI.FORCE:this.addBaseGlyph(dp.ROUND_BASE,t),this.addDirectionGlyph(dp.FORCE_ARROW,t);break;case k.DzI.MOMENT:this.addBaseGlyph(dp.MOMENT_BASE,t);break;case k.DzI.PRESSURE:this.addPressureGlyph(t,e.isDirectionFlipped)}const i=this.getHighlight();i&&this.addHighlightToComponents(i),this.updateTargetId()}get scaledGlyphSize(){return Op*(0,ns.x_)()}updateViewDependentGraphics(e){if(!this.isValid||this.isHidden)return void this.removeMeshIncrements();if(!this.viewer.getResources().loadGlyphResources.atlasReady)return;const t=X.default.getManager(),i=e.getPixelSizeAtWorldPoint(this.worldOrigin_),s=this.scaledGlyphSize;for(let e=0;e<this.glyphComponents.length;++e)this.glyphComponents[e].setWorldOrigin(this.adjustedWorldOrigin);const n=this.getDistanceFromOriginToGlyphEdge(!0)+t.getNumber("SIMULATION_LOAD_LEADER_GAP_PX"),r=this.leaderWorldDistance+this.offsetInLeaderDirection_-i*n;if(this.hideLeader||r<0)this.removeMeshIncrement("leader"),this.removeMeshIncrement("leader-st");else{const e=(0,Yd.W5)(this.worldAnchorPoint,this.leaderRay?.evaluate(r));(0,Yd.Ab)(t.getColor("SIMULATION_LOAD_LEADER_LINE_COLOR"),e),this.updateMeshIncrement("leader",yi.ZJ,e,pp);const i=e.clone();(0,Yd.Ab)(t.getColor("SIMULATION_LOAD_LEADER_HIDDEN_LINE_COLOR"),i),this.updateMeshIncrement("leader-st",yi.ZJ,i,mp)}const a=Math.abs(M.dot(e.getDirectionToWorldPoint(this.adjustedWorldOrigin),this.worldZAxis));if(a<Ip&&this.usesBaseGlyph){const t=ge.S4.normalize(ge.S4.cross(e.getForward(),this.worldZAxis,Ap)),n=i*s*.5,r=this.getColorWithHighlight(Ep).slice();r[3]=1-a/Ip;const o=new Rp(M.subtract(M.create(),this.adjustedWorldOrigin,M.scale(Pp,t,-n)),M.subtract(M.create(),this.adjustedWorldOrigin,M.scale(Pp,t,n)),r);if(!o.equals(this.lastObliqueBaseLineDisplayed)){const e=(0,Yd.W5)(o.leftPoint,o.rightPoint);(0,Yd.Ab)(r,e),this.updateMeshIncrement(fp,Cp,e,Dp),this.lastObliqueBaseLineDisplayed=o}}else this.removeMeshIncrement(fp),this.lastObliqueBaseLineDisplayed=null;if(this.showLineAxis){const e=i*s*.25,t=new Rp(M.subtract(M.create(),this.adjustedWorldOrigin,M.scale(Pp,this.worldZAxis,-e)),M.subtract(M.create(),this.adjustedWorldOrigin,M.scale(Pp,this.worldZAxis,e)),this.getColorWithHighlight(X.default.getManager().getColor("SIMULATION_LINE_AXIS_COLOR")));if(!t.equals(this.lastLineAxisDisplayed)){const e=(0,Yd.W5)(t.leftPoint,t.rightPoint);(0,Yd.Ab)(t.color,e),(0,Yd.KZ)(yp,e),this.updateMeshIncrement(Mp,Cp,e,Dp),this.lastLineAxisDisplayed=t}}else this.removeMeshIncrement(Mp),this.lastLineAxisDisplayed=null}getModelSelection(e){const t=new Me.Y1(k.lQt.OCCURRENCE,this.loadDisplayData.occurrence);return new Me.Y1(k.lQt.SIMULATION_LOAD,this.loadDisplayData.nodeId,this.loadDisplayData.ownerOccurrence,{childSelections:[t]})}addHighlight(e){super.addHighlight(e),this.updateHideState(),this.addHighlightToComponents(e)}addHighlightToComponents(e){for(let t=0;t<this.glyphComponents.length;t++)this.glyphComponents[t].addHighlight(e)}removeHighlight(e){const t=super.removeHighlight(e);for(let t=0;t<this.glyphComponents.length;t++)this.glyphComponents[t].removeHighlight(e);return this.updateHideState(),t}get leaderDirection(){return this.leaderRay?.direction}set offsetInLeaderDirection(e){this.offsetInLeaderDirection_=e;const t=this.leaderWorldDistance+this.offsetInLeaderDirection_;this.leaderRay?.evaluate(t,this.adjustedWorldOrigin)}get offsetInLeaderDirection(){return this.offsetInLeaderDirection_}get worldOrigin(){return this.worldOrigin_}get targetId(){return this.targetId_}updateTargetId(){const e=this.loadDisplayData.faceLoadDeterministicIds.slice();e.sort(),this.targetId_=this.loadDisplayData.occurrence.toString()+"-"+e}getDistanceFromOriginToGlyphEdge(e){const t=this.scaledGlyphSize,i=e?-1:1,s=Math.max(0,this.getDirectionGlyphLength()*i*M.dot(this.worldZAxis,this.leaderRay?.direction)),n=M.dot(this.worldZAxis,this.leaderRay?.direction);return(this.usesBaseGlyph?Math.sqrt(1-n*n)*t*.5:.5*t)+s}getOccupiedScreenBounds(e,t){if(this.isHidden)return this.occupiedScreenBounds.reset(),this.occupiedScreenBounds;const i=this.scaledGlyphSize;if(this.usesBaseGlyph){this.occupiedScreenBounds.reset();for(let s=-.5;s<=.5;s+=1){for(let n=-.5;n<=.5;n+=1){let n=ge.S4.add(this.adjustedWorldOrigin,ge.S4.scale(this.worldXAxis,s*t*i,Pp),Ap);n=ge.S4.add(n,ge.S4.scale(this.worldYAxis,s*t*i,Pp),Ap),this.occupiedScreenBounds.addPoint(e.projectWorldPointToCanvas(n))}const n=ge.S4.add(this.adjustedWorldOrigin,ge.S4.scale(this.worldZAxis,t*this.getDirectionGlyphLength(),Pp),Ap);this.occupiedScreenBounds.addPoint(e.projectWorldPointToCanvas(n))}}else this.occupiedScreenBounds.makeCenteredBoxOnPoint(e.projectWorldPointToCanvas(this.adjustedWorldOrigin),i*t);return this.occupiedScreenBounds}clearComponents(){for(let e=0;e<this.glyphComponents.length;++e)this.glyphComponents[e].remove();this.glyphComponents=[],this.removeMeshIncrements()}get assembly(){return this.viewer.getModelViewManagers().getManager().getDisplayedAssembly()}clearPositionalData(){this.worldAnchorPoint=null,this.worldOrigin_=null,this.worldXAxis=null,this.worldYAxis=null,this.worldZAxis=null,this.leaderRay=null}get isValid(){return!!(this.worldAnchorPoint&&this.worldOrigin_&&this.worldXAxis&&this.worldYAxis&&this.worldZAxis)}updateWorldZAxisWithPartStudioMateConnector(){const e=k._oC.getOccurrenceFromPathString(this.loadDisplayData.directionMateConnectorId),t=e.getOccurrenceWithoutTail().getPathAsString(),i=this.assembly.getOccurrences()[t];if(i){const t=i.fullElementId.toString(),s=this.assembly.elementAccessor.getPartStudio(t);if(s){const t=i.occurrenceData,n=t.transform.getGlMatrix(),r=s.getMateConnectorData(t.occurrence,e.getTailNodeId());if(r){const e=r.location.getGlMatrix();this.updateWorldZAxisInternal(n,e)}else ap.warn("Unable to find mate connector display data")}else ap.warn("Unable to find part studio element")}else ap.warn("Unable to find part studio display data")}updateWorldZAxisInternal(e,t){if(e&&t){const i=ge.w$.multiply(e,t,ue.create());this.worldZAxis=ge.S4.normalize(ge.w$.multiplyVec4(i,(0,wi.Ot)(this.loadDisplayData.componentValues.getVec3(),0)))}else ap.warn("Unable to identify load direction.")}updateWorldZAxis(){if(this.worldZAxis=M.clone(hp),this.loadDisplayData){if(this.loadDisplayData.directionMateConnectorId){const e=this.assembly.mateConnectorData[this.loadDisplayData.directionMateConnectorId];if(e){const t=e.location.getGlMatrix(),i=this.assembly.getOccurrences()[e.occurrence.getPathAsString()];if(!i)return void ap.warn("Mate connector occurrence was falsey. World Z Axis was not updated.");const s=i.occurrenceData.transform.getGlMatrix();this.updateWorldZAxisInternal(s,t)}else this.updateWorldZAxisWithPartStudioMateConnector()}this.loadDisplayData.isDirectionFlipped&&(this.worldZAxis=ge.S4.negate(this.worldZAxis))}}computePositionalData(){const e=M.clone(op),t=this.getBounds();if(!t||!t.isFinite())return;const i=t.center(),s=this.viewer.getModelBounds();if(M.dot(e,ge.S4.subtract(i,s.center(),M.create()))<-Ri.W.ZERO_LENGTH&&ge.S4.negate(e),this.updateAnchorPoint(ge.S4.add(i,ge.S4.scale(e,t.diameter()/2,M.create()),M.create())),!this.worldAnchorPoint)return;let n=0;const r=s.getCorners();if(!r)return;const a=M.dot(this.worldAnchorPoint,e);for(let t=0;t<r.length;++t){const i=M.dot(r[t],e)-a;i>n&&(n=i)}this.worldOrigin_=ge.S4.add(this.worldAnchorPoint,ge.S4.scale(e,n+gp*s.diameter(),M.create()),M.create()),this.updateWorldZAxis(),(0,Er.areUnitVectorsParallel)(cp,this.worldZAxis)?this.worldXAxis=ge.S4.normalize(ge.S4.cross(lp,this.worldZAxis,M.create())):this.worldXAxis=ge.S4.normalize(ge.S4.cross(cp,this.worldZAxis,M.create())),this.worldYAxis=ge.S4.normalize(ge.S4.cross(this.worldZAxis,this.worldXAxis,M.create()));const o=ge.S4.subtract(this.worldOrigin_,this.worldAnchorPoint,M.create());this.leaderWorldDistance=ge.S4.length(o),this.leaderRay=new wi.zH(this.worldAnchorPoint,o)}updateAnchorPoint(e){this.worldAnchorPoint=null;const t=this.viewer.getModelViewManagers().getManager();let i;const s=this.loadDisplayData.occurrence;if(this.loadDisplayData.faceLoadDeterministicIds.length>0)i=this.loadDisplayData.faceLoadDeterministicIds;else{const e=t.getOccurrenceDisplayData(s);if(!e)return void ap.debug("Failed to find occurrence display data for load");const n=t.getPartStudioDataFromOccurrence(s);if(!n)return void ap.debug("Failed to find part studio display data for load");i=[];for(const t of e.displayedPartIds)i=i.concat(n.getEntitiesForBody(t))}if(!i||0===i.length)return void ap.debug("No deterministic ids to use for load anchor point");const n=t.getOccurrenceTransform(s);if(!n)return void ap.debug("Failed to find occurrence transform for load");const r=ge.w$.multiplyVec3(ge.w$.inverse(n,ue.create()),e,M.create());let a=null;for(let e=0;e<i.length;++e){const n=t.extractMeshIncrement(i[e],s);if(n){const e=n.getPositionNearPoint(r);e.position&&(!a||e.distance<a.distance)&&(a=e)}}a?this.worldAnchorPoint=ge.w$.multiplyVec3(n,a.position):ap.debug("Failed to find anchor point for load display")}getBounds(){if(this.loadDisplayData.faceLoadDeterministicIds.length>0){const e=new wi.kB;for(let t=0;t<this.loadDisplayData.faceLoadDeterministicIds.length;++t)e.addBox(this.viewer.getModelViewManagers().getManager().getEntityBounds(this.loadDisplayData.faceLoadDeterministicIds[t],this.loadDisplayData.occurrence));return e}return this.assembly.getOccurrenceBounds(this.loadDisplayData.occurrence)}addBaseGlyph(e,t){const i=new ad(this.viewer,this.viewer.getResources().loadGlyphResources,e,t,Op,Gi.DO.DEFAULT,this.worldOrigin_,this.worldXAxis,this.worldYAxis,this);this.glyphComponents.push(i)}addDirectionGlyph(e,t,i){const s=i?ge.S4.scale(this.worldZAxis,-1,M.create()):this.worldZAxis,n=new hd(this.viewer,this.viewer.getResources().loadGlyphResources,e,t,Op,Gi.DO.DEFAULT,this.worldOrigin_,s,[.5,0],this);this.glyphComponents.push(n)}addPressureGlyph(e,t){const i=t?dp.PRESSURE_FLIPPED:dp.PRESSURE,s=new od(this.viewer,this.viewer.getResources().loadGlyphResources,i,e,Op,Gi.DO.DEFAULT,this.worldOrigin_,[.5,.5],this);this.glyphComponents.push(s)}get usesBaseGlyph(){return this.loadDisplayData.loadType!==k.DzI.PRESSURE}get showLineAxis(){return this.loadDisplayData.loadType===k.DzI.MOMENT}getColorWithHighlight(e){const t=this.getHighlight();return t?t.type===Cn.o2.PRE?Sp:Tp:e}getDirectionGlyphLength(){switch(this.loadDisplayData.loadType){case k.DzI.ACCELERATION:case k.DzI.BEARING_LOAD:case k.DzI.FORCE:return this.scaledGlyphSize;case k.DzI.MOMENT:return.25*this.scaledGlyphSize}return 0}occurrenceIsHidden(e){const t=this.assembly.getDisplayDataForOccurrence(e);return!!t&&t.isHidden}}const vp=M.create();class _p{constructor(){this.loadDisplays=[],this.occupiedScreenBounds=new wi.tO}addDisplay(e){this.loadDisplays.push(e)}arrangeAndUpdateForView(e,t){if(0===this.loadDisplays.length||!this.loadDisplays[0].isValid)return;const i=this.loadDisplays[0].worldOrigin,s=this.loadDisplays[0].leaderDirection,n=this.loadDisplays[0].scaledGlyphSize,r=e.getPixelSizeAtWorldPoint(i),a=X.default.getManager().getNumber("SIMULATION_INTER_LOAD_GAP_PX");let o=0,h=!1;for(let e=0;e<this.loadDisplays.length;++e){const t=this.loadDisplays[e];t.isHidden||(0!==e&&(o+=r*t.getDistanceFromOriginToGlyphEdge(!0)),t.hideLeader=h,h=!0,t.offsetInLeaderDirection=o,o+=r*Math.max(t.getDistanceFromOriginToGlyphEdge(!1),a))}this.occupiedScreenBounds.reset();for(let t=0;t<this.loadDisplays.length;++t)this.occupiedScreenBounds.addBox(this.loadDisplays[t].getOccupiedScreenBounds(e,r));const c=e.projectWorldDirectionToCanvas(i,ge.S4.scale(s,r*n,vp));ge.gv.normalize(c);let l=t.getUnoccupiedOffsetAlongDirection(this.occupiedScreenBounds,c);if(l>0){l+=a;const e=l*r;for(let t=0;t<this.loadDisplays.length;++t){const i=this.loadDisplays[t];i.offsetInLeaderDirection=i.offsetInLeaderDirection+e}this.occupiedScreenBounds.translate(ge.gv.scale(c,l))}t.addOccupiedRegion(this.occupiedScreenBounds);for(let t=0;t<this.loadDisplays.length;++t)this.loadDisplays[t].updateViewDependentGraphics(e)}}class Np extends yi.u1{constructor(e){super(e),this.loadDisplayData=new Map,this.loadDisplays=new Map,this.groupedLoadDisplays=new Map,this.loadDisplayOccupancyMap=new Li,this.explodeViewActive=!1,this.mateConnectorIdToLoads=new Map,this.loadResources(),es.Jq.SimulationService.getCanAccessSimulationsObservable().subscribe((e=>{for(const t of this.loadDisplays.values())t.setHideLoads(!e),this.show()}))}setEditState(e,t){const i=this.loadDisplays.get(e);i&&i.setEditState(t)}reset(){this.clearLoadDisplays(),this.loadDisplayData.clear(),this.mateConnectorIdToLoads.clear()}hide(){this.isHidden=!0,this.clearLoadDisplays()}show(){this.isHidden=!1,this.updateLoadDisplays(this.loadDisplayData.values(),!0)}onAppearanceConstantsUpdated(){this.isHidden||(this.clearLoadDisplays(),this.updateLoadDisplays(this.loadDisplayData.values(),!0))}setExplodeViewActive(e){if(this.explodeViewActive!==e)if(this.explodeViewActive=e,e)this.clearLoadDisplays();else{const e=!0;this.updateLoadDisplays(this.loadDisplayData.values(),e)}}getExplodeViewActive(){return this.explodeViewActive}static getMateConnectorPath(e){return e.ownerOccurrence.createOccurrenceWithTailAppended(e.nodeId).getPathAsString()}processUpdates(e,t){if(!this.assembly)return;if(e.isCollapsible)return void this.hide();t&&this.isHidden&&!this.explodeViewActive&&this.show();for(const t of e.deletedLoads){const e=this.loadDisplays.get(t);e&&(e.remove(),this.loadDisplays.delete(t));const i=this.loadDisplayData.get(t);if(i){const e=i.directionMateConnectorId;if(e){const i=this.mateConnectorIdToLoads.get(e);i&&(i.delete(t),0===i.size&&this.mateConnectorIdToLoads.delete(e))}}this.loadDisplayData.delete(t)}const i=new Set(e.mateConnectors.map((e=>Np.getMateConnectorPath(e))));for(const t of e.occurrences){const e=this.assembly.getMateConnectorsForOccurrence(t.occurrenceData.occurrence);for(let t=0;t<e.length;t++)i.add(Np.getMateConnectorPath(e[t]))}this.updateLoadDisplays(e.loads.values(),t,Array.from(i))}processDeletedMateConnector(e){this.mateConnectorIdToLoads.delete(e)}getUiElementsForSelection(e){if(!e.isSimulationLoad())return[];const t=this.loadDisplays.get(e.getIdString());return t?[t]:[]}getDisplayDataForSelection(e){return e.isSimulationLoad()?this.loadDisplayData.get(e.getIdString()):null}onViewWillDraw(e){this.loadDisplayOccupancyMap.clearOccupiedRegions(),!this.groupedLoadDisplays.size&&this.loadDisplays.size&&this.updateLoadDisplays(this.loadDisplayData.values(),!1);for(const[t,i]of this.groupedLoadDisplays)i.arrangeAndUpdateForView(e,this.loadDisplayOccupancyMap)}updateDirectionMateConnectorToLoad(e){const t=e.nodeId,i=e.directionMateConnectorId,s=this.loadDisplayData.get(t);if(s){const e=s.directionMateConnectorId;if(e&&e!==i){const i=this.mateConnectorIdToLoads.get(e);i&&i.delete(t)}}if(i){const e=this.mateConnectorIdToLoads.get(i);e?e.add(t):this.mateConnectorIdToLoads.set(i,new Set([t]))}}updateLoadDisplays(e,t,i){for(const i of e){const e=i.nodeId;if(this.updateDirectionMateConnectorToLoad(i),this.loadDisplayData.set(e,i),t){let t=this.loadDisplays.get(e);if(!t){const s=i.hidden||!es.Jq.SimulationService.getCanAccessSimulations();t=new wp(this,this.viewer,i,s),this.loadDisplays.set(e,t)}t.update(i)}}if(i)for(let e=0;e<i.length;e++)this.processMateConnectorChange(i[e]);this.setupAssemblyListeners(),this.groupedLoadDisplays.clear();for(const[e,t]of this.loadDisplays){if(!t.isValid)continue;let e=this.groupedLoadDisplays.get(t.targetId);e||(e=new _p,this.groupedLoadDisplays.set(t.targetId,e)),e.addDisplay(t)}}processMateConnectorChange(e){const t=this.mateConnectorIdToLoads.get(e);t&&t.forEach((e=>{const t=this.loadDisplays.get(e);t&&t.update()}))}setupAssemblyListeners(){this.stopListening(this.assembly);const e=new Set;for(const t of this.loadDisplays.keys()){const i=this.loadDisplayData.get(t).occurrence.getPathAsString();e.add(i)}for(const t of e)this.listenTo(this.assembly,"OCCURRENCE_DATA_CHANGE."+t,this.show)}clearLoadDisplays(){for(const[e,t]of this.loadDisplays)t.remove();this.loadDisplays.clear(),this.groupedLoadDisplays.clear(),this.stopListening()}loadResources(){if(!this.viewer.getResources().loadGlyphResources){const e="LOAD_GLYPHS",t=48,i=[1,2],s=!0;this.viewer.getResources().loadGlyphResources=new bp(e,this.viewer,up,t,i,{clearColorOverride:[255,255,255,0],useMipMappingAndAnisotropicFiltering:!0},s)}}get assembly(){return this.viewer.getModelViewManagers().getManager().getDisplayedAssembly()}}class bp extends sd{getAtlasBackgroundColor(e,t){return"rgba(0, 0, 0, 0.0)"}getAtlasTextureName(e,t,i){let s="";return i!==td.NO_HIGHLIGHT?s="_"+i:t===Jl.SUPPRESSED&&(s+=ed[t]),this.textures[e]+s+this.getSystemStateSuffix()+".png"}initializeNodeProperties(){for(const e in td)for(const t in Jl){const i=this.getNodePropertyKey(e,t,Gi.DO.DEFAULT);this.nodeProperties[i]=new Gi.hF({primitiveType:Ai.MX.TRIANGLES,isShowThrough:!1,isDepthTested:!1,isTwoSided:!0,priority:Gi.DO.DEFAULT,primitivesHaveTransparency:!0,material:this.material})}}}const Lp=_e.O.createLogger("MateConnectorComponent",k.bVy.GRAPHICS);class Fp extends Kg{constructor(e,t,i){super(e,i),this.usage=t,this.mateConnectorGraphics={}}clone(e){const t=new Fp(e,this.usage,this.viewer);return this.copyToClone(t),t}cloneForPreview(e){const t=new Fp(e,ys.L.PREVIEW,this.viewer);this.copyToPreview(t);for(const e in this.mateConnectorGraphics){const i=this.mateConnectorGraphics[e],s=t.mateConnectorGraphics[e]={};for(const e in i)s[e]=i[e].cloneForPreview()}return t}getVisibleMateConnectorBounds(){const e=new wi.kB;for(const t in this.mateConnectorGraphics){const i=this.mateConnectorGraphics[t];for(const t in i)i[t].isHidden||e.addPoint(i[t].worldSpacePosition)}return e}getInstantiatedMateConnectorsForOccurrence(e){const t=[];for(const i in this.mateConnectorGraphics){const s=this.mateConnectorGraphics[i];for(const i in s){const n=s[i],r=n.getDefinition();r&&(0,Tn.wB)(e,n.getOccurrence())&&t.push({Id:r.nodeId,isPartStudio:n.getIsPartStudioMateConnector()})}}return t}getComponentId(){return"mateconnector_component."}handlesEntity(e,t){return!e.hasTessellationError()&&e.isMateConnector()&&!this.viewer.getIsForFlattenedDisplay()}expectsTessellation(){return!1}reset(e){for(const e in this.mateConnectorGraphics){const t=this.mateConnectorGraphics[e];for(const e in t)t[e].remove()}this.mateConnectorGraphics={},super.reset(e)}isInstantiated(){return!0}instantiateForPartStudio(e){this.addOrUpdateOccurrence(TE.KF,null),Yg.prototype.instantiateForPartStudio.apply(this,[e])}removePartStudioInstantiation(e){Yg.prototype.removePartStudioInstantiation.apply(this,[e]),this.removeOccurrence(TE.KF,!1)}addOrUpdateOccurrence(e,t){let i=!1;for(const s in this.idToMetaData)i=this.updateEntityMateConnector(s,this.idToMetaData[s],e,t)||i;const s=e===TE.KF;(i||s||this.occurrences.hasOwnProperty(e))&&super.addOrUpdateOccurrence(e,t)}addManagedIdMappings(e,t){super.addManagedIdMappings(e,t);const i=this.bodyToEntity.get(t)?.getKeys();if(i)for(const t of i){const i=Object.values(this.mateConnectorGraphics[t]);for(const t of i)t.partStudioFeatureId=e,t.isFromChildFeature=!0}}getConnectorHiddenState(e,t){const i=e.getFirstFeatureId();let s=!1;if(t){const e=t.occurrenceData.featureData[i];e?s=e.visibility===k.HRI.HIDDEN:t.isPatternDescendant&&(s=!0)}else s=e.getFeatureIds().reduce(((e,t)=>e||this.featureVisibility[t]===Xs.EE.HIDDEN),s);return s}occurrenceContainsBody(e,t){return this.viewer.getModelViewManagers().getManagerForUsage(this.usage).occurrenceContainsBody(e,t)}createMateConnectorDisplayData(e,t){if(t&&!this.occurrenceContainsBody(t,e.getMateConnectorPartId()))return null;const i=new k.Zcz;return i.location=e.getMateConnectorCoordinateSystem(),i.partId=e.getMateConnectorPartId(),i.nodeId=e.getFirstFeatureId(),i.occurrence=t?t.occurrenceData.occurrence:null,i.ownerOccurrence=i.occurrence,i.implicit=!1,i.hidden=this.getConnectorHiddenState(e,t),i}updateEntityMateConnector(e,t,i,s,n){if(s&&!this.occurrenceContainsBody(s,t.getMateConnectorPartId()))return!1;const r=t.getLastFeatureId(),a=this.getConnectorHiddenState(t,s);let o=this.mateConnectorGraphics[e],h=o?o[i]:null;if(!n&&s&&a&&!h){return!0}o||(o={},this.mateConnectorGraphics[e]=o);const c=this.createMateConnectorDisplayData(t,s);return!!c&&(h?h.updateDefinition(c):(h=new xl(c,mh(this.usage),this.viewer,r),o[i]=h),s&&(h.setOccurrenceTransform(s.occurrenceData.transform.getGlMatrix()),h.updateOccurrenceVisibility(s.isHidden?Xs.EE.HIDDEN:Xs.EE.VISIBLE)),!0)}removeOccurrence(e,t){super.removeOccurrence(e,t);for(const t in this.mateConnectorGraphics){const i=this.mateConnectorGraphics[t];if(!i)continue;const s=i[e];s&&(s.remove(),delete i[e])}}updateEntityGraphics(e,t,i){let s;for(s in this.occurrences){const t=this.occurrences[s];s=+s,this.updateEntityMateConnector(e,i,s,t)}}static getFirstNonCompoundFeatureId(e){const t=e.getFeatureIds();if(null===t)return Lp.warn("Unable to retrieve feature ids for entity: "+e.getMessageName()),null;for(let e=0;e<t.length;++e)if(!kE(t[e]))return t[e]}getHideableFeatureIds(){const e=[];return this.featureToIds.each(((t,i)=>{if(this.childFeatureIds.has(i))return void e.push(i);if(kE(i))return;const s=t.getKeys();for(let t=0;t<s.length;++t){const n=s[t],r=this.idToMetaData[n];if(r){const t=Fp.getFirstNonCompoundFeatureId(r);if(t&&t===i)return void e.push(i)}}})),e}removeEntity(e){const t=this.mateConnectorGraphics[e];for(const e in t)t[e].remove();delete this.mateConnectorGraphics[e],Yg.prototype.removeEntity.apply(this,[e])}hideShowEntity(e,t,i){if((i=i||TE.KF)===TE.Qy)return!1;let s=!1;const n=this.mateConnectorGraphics[e];for(const e in n)if(+e===i){const e=n[i];e&&(t===Xs.EE.HIDDEN?e.definition.hidden=!0:e.definition.hidden=!1,e.updateHideState(),s=!0)}return s}hideShowFeatureEntities(e,t,i){const s=this.getEntitiesForFeature(e);if(!s)return;let n=i;for(let i=0;i<s.length;++i){const r=this.idToMetaData[s[i]];if(!n){const t=Fp.getFirstNonCompoundFeatureId(r);n=!!t&&t===e}if(r&&n){const e=this.getOccurrenceIdForEntity(s[i]);this.hideShowEntity(s[i],t,e)}}this.viewer.requestDraw()}getAllMateConnectorGraphics(e,t){const i=this.featureToIds.get(t),s=[];return i&&i.each(((t,i)=>{const n=this.getMateConnectorGraphicsFromEntityId(e,i);return n&&s.push(n),!1})),s}getMateConnectorGraphics(e,t){const i=this.featureToIds.get(t);let s;return i&&(s=i.firstKey()),s?this.getMateConnectorGraphicsFromEntityId(e,s):null}getMateConnectorData(e,t){const i=this.featureToIds.get(t);let s;if(i&&(s=i.firstKey()),s){const t=this.idToMetaData[s],i=this.viewer.getOccurrenceIdManager().getIdForName(e.getPathAsString()),n=this.occurrences[i];if(t&&n)return this.createMateConnectorDisplayData(t,n)}return null}getMateConnectorGraphicsFromEntityId(e,t){if(t){let i=this.mateConnectorGraphics[t];if(e){const s=this.viewer.getOccurrenceIdManager().getIdForName(e.getPathAsString()),n=i?i[s]:null;if(n)return n;const r=this.idToMetaData[t],a=this.occurrences[s];if(r&&a){const e=!0;return this.updateEntityMateConnector(t,r,s,a,e),i=this.mateConnectorGraphics[t],i?i[s]:null}}else for(const e in i){const t=i[e];if(!t.getOccurrence())return t}}return null}getUIElementsForSelection(e){const t=[];if(e.isMateConnector()||e.isFeature()){this.getAllMateConnectorGraphics(e.getOccurrence(),e.getIdString()).forEach((function(e){t.push(e)}))}return t}getEntityIdsForSelection(e){return[]}getOccurrencesForSelection(e){const t=[];if(e.isMateConnector()||e.isFeature()){const i=this.getMateConnectorGraphics(e.getOccurrence(),e.getIdString());i&&t.push(i.getOccurrence())}return t}addStatistics(e){e.uniqueMateConnectors+=this.getEntityCount()}}class xp extends yi.u1{constructor(e,t,i){super(i),this.definition=e,this.mateConnectorDisplayData=t,this.mateIndicatorComponents=[],this.occurrenceData.setCanIsolateChange(!0),this.occurrenceData.setIsolated(!1)}onDevicePixelRatioChanged(e){this.updateGraphics()}getDefinition(){return this.definition?this.definition:null}remove(){for(let e=0;e<this.mateIndicatorComponents.length;e++)this.mateIndicatorComponents[e].remove();super.remove()}addHighlight(e){super.addHighlight(e);for(let t=0;t<this.mateIndicatorComponents.length;t++)this.mateIndicatorComponents[t].addHighlight(e)}removeHighlight(e){const t=super.removeHighlight(e);for(let t=0;t<this.mateIndicatorComponents.length;t++)this.mateIndicatorComponents[t].removeHighlight(e);return t}onIsolateChanged(){this.updateGraphics()}isInteractionEnabled(){return!(this.viewer.getIsolatedOccurrenceManager()?.hasIsolatedInstances()&&!this.occurrenceData.getIsolated())}updateGraphics(){for(let e=0;e<this.mateIndicatorComponents.length;e++)this.mateIndicatorComponents[e].updateGraphics()}setIsolated(e){this.occurrenceData.setIsolated(e);for(let t=0;t<this.mateIndicatorComponents.length;t++)this.mateIndicatorComponents[t].getOccurrenceData().setIsolated(e)}getDefinitionMateConnectorIds(){return this.definition.getMateConnectorIds()}getDefinitionOccurrenceIds(){return this.mateIndicatorComponents.length>0?this.mateIndicatorComponents[0].getDefinitionOccurrenceIds():this.definition.getOccurrenceIds()}getModelSelection(e){return null}addMateIndicatorComponent(e){e.isValid()&&(e.updateHideState(),this.mateIndicatorComponents.push(e),this.listenTo(e,yi.zw.LONG_PRESS_START,this.onLongPressStart),this.listenTo(e,yi.zw.LONG_PRESS_END,this.onLongPressEnd))}onLongPressStart(){const e=[];this.getDefinitionOccurrenceIds().forEach((function(t){e.push(k._oC.getOccurrenceFromPathString(t))})),this.viewer.getIsolatedOccurrenceManager().isolateOccurrences(e,tM.INITIAL),(0,Me.IQ)()}onLongPressEnd(){(0,mr.m)().trigger(pr.C.EXIT_ISOLATE,this.viewer)}updateMateConnectorDisplayData(e){this.mateConnectorDisplayData=e;for(let e=0;e<this.mateIndicatorComponents.length;++e)this.mateIndicatorComponents[e].updateMateConnectorDisplayData(this.mateConnectorDisplayData)}updateHiddenMode(e){for(let t=0;t<this.mateIndicatorComponents.length;t++)this.mateIndicatorComponents[t].updateHiddenMode(e)&&this.mateIndicatorComponents[t].updateHideState()}}class Bp extends xp{constructor(e,t,i){super(t,e,i);const s=new md(this.mateConnectorDisplayData,"FASTENED",t,this.viewer,k.qep.FASTENED);this.addMateIndicatorComponent(s)}}class Vp extends xp{constructor(e,t,i){super(t,e,i);const s=new md(this.mateConnectorDisplayData,"REVOLUTE",t,this.viewer,k.qep.REVOLUTE);this.addMateIndicatorComponent(s)}}class Up extends xp{constructor(e,t,i){super(t,e,i);const s=new md(this.mateConnectorDisplayData,"PLANAR_BASE",t,this.viewer,k.qep.PLANAR);this.addMateIndicatorComponent(s)}}class Hp extends xp{constructor(e,t,i){super(t,e,i);const s=new md(this.mateConnectorDisplayData,"PARALLEL_BASE",t,this.viewer,k.qep.PARALLEL);this.addMateIndicatorComponent(s)}}class Gp extends xp{constructor(e,t,i){super(t,e,i);const s=new md(this.mateConnectorDisplayData,"SLIDER_BASE",t,this.viewer,k.qep.SLIDER),n=new fd(this.mateConnectorDisplayData,t,-Math.PI/2,[0,1,0],this.viewer,k.qep.SLIDER);this.addMateIndicatorComponent(s),this.addMateIndicatorComponent(n)}}class kp extends xp{constructor(e,t,i){super(t,e,i);const s=new md(this.mateConnectorDisplayData,"CYLINDRICAL_BASE",t,this.viewer,k.qep.CYLINDRICAL),n=new fd(this.mateConnectorDisplayData,t,-Math.PI/2,[0,1,0],this.viewer,k.qep.CYLINDRICAL);this.addMateIndicatorComponent(s),this.addMateIndicatorComponent(n)}}class Wp extends xp{constructor(e,t,i){super(t,e,i);const s=new md(this.mateConnectorDisplayData,"PIN_SLOT_BASE",t,this.viewer,k.qep.PIN_SLOT);this.addMateIndicatorComponent(s)}}class zp extends xp{constructor(e,t,i){super(t,e,i);const s=new md(this.mateConnectorDisplayData,"BALL",t,this.viewer,k.qep.BALL);this.addMateIndicatorComponent(s)}}class Xp extends xp{constructor(e,t,i){super(t,[],i);const s=new Id(e,t,this.viewer);this.addMateIndicatorComponent(s)}updateOccurenceDisplayData(e){for(let t=0;t<this.mateIndicatorComponents.length;++t)this.mateIndicatorComponents[t].updateOccurenceDisplayData(e)}}class Zp extends xp{constructor(e,t){super(e,null,t);const i=new Ed(e,"TANGENT",this.viewer);this.addMateIndicatorComponent(i)}updateMateIndicatorDefinition(e){this.definition=e;for(let e=0;e<this.mateIndicatorComponents.length;++e)this.mateIndicatorComponents[e].updateDefinition(this.definition)}}class qp extends xp{constructor(e,t,i){super(null,null,i);const s=new Sd(e,t,this.viewer);this.addMateIndicatorComponent(s)}}class Yp extends xp{constructor(e,t,i){super(t,e,i);const s=new Td(this.mateConnectorDisplayData,t,"WIDTH",this.viewer);this.addMateIndicatorComponent(s)}updateMateIndicatorDefinition(e){this.definition=e;for(let e=0;e<this.mateIndicatorComponents.length;++e)this.mateIndicatorComponents[e].updateDefinition(this.definition)}}function Kp(e,t,i){let s=null;switch(t.mateType){case k.qep.FASTENED:s=new Bp(e,t,i);break;case k.qep.REVOLUTE:s=new Vp(e,t,i);break;case k.qep.SLIDER:s=new Gp(e,t,i);break;case k.qep.PLANAR:s=new Up(e,t,i);break;case k.qep.PARALLEL:s=new Hp(e,t,i);break;case k.qep.CYLINDRICAL:s=new kp(e,t,i);break;case k.qep.PIN_SLOT:s=new Wp(e,t,i);break;case k.qep.BALL:s=new zp(e,t,i);break;default:s=null}return s}const jp=X.default.getManager(),Qp=new Gi.hF({zOffset:jp.getNumber("ORIGIN_Z_OFFSET"),primitiveType:Ai.MX.POINTS,isPickable:!1,includedInBlend:!0,isTintedByCompare:!0}),$p=new Gi.hF({primitiveType:Ai.MX.POINTS,isShowThrough:!0,isDepthTested:!1,priority:Gi.DO.LOWER,includedInBlend:!0,isTintedByCompare:!0}),Jp=new Oi;class em extends Yg{constructor(e,t,i){super(e,t,i),this.hasBeenInstantiated=!1,this.incrementRanges={},this.styledRanges={},this.node=new Gi.NB(this.getComponentId(),new Gi.hF,i),this.instantiateRanges()}reset(){super.reset(),this.node.removeOccurrence(TE.KF),Object.values(this.styledRanges).forEach((e=>{e.getMeshRanges().destroy()})),this.incrementRanges={},this.styledRanges={},this.instantiateRanges()}getStyleId(e,t){return Jp.reset(),Jp.addBoolean(e),Jp.addBoolean(t),Jp.getId()}instantiateRanges(){for(let e=0;e<=1;++e)for(let t=0;t<=1;++t){const i=this.getStyleId(!!e,!!t),s="PointBodyComponent."+i;let n=this.incrementRanges[s];n||(n=new qT("PointBodyComponent."+i),this.usage===ys.L.PREVIEW&&n.setListenForDeletions(!0),this.incrementRanges[s]=n);const r=t?"ORIGIN":"POINT_BODY",a=new mS.bg;a.setAttribute(RS.PRIMITIVE_SIZE,jp.getNumber(r+"_SIZE")),a.setAttribute(RS.PRIMITIVE_STYLE,jp.getPointFont(r+"_FONT")),a.setAttribute(RS.COLOR,jp.getColor(r+"_COLOR"));const o=e?$p:Qp,h=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(TE.KF),c=this.node.addOccurrenceGeometryToNode(o,h,a,n);this.styledRanges[i]=c}}getComponentId(){return"point_body_component."}clone(e){const t=new em(e,this.viewer,this.usage);return this.copyToClone(t),t}cloneForPreview(e){const t=new em(e,this.viewer,ys.L.PREVIEW);return this.copyToPreview(t),t.instantiateBaseEntities(),t}instantiateBaseEntities(){const e=this.getSharedBaseMeshManager();for(const t in this.idToMetaData){const i=this.idToMetaData[t],s=e.getIncrementDetails(t,this.getMeshOwnerId());i&&s&&this.updateEntityGraphicsFromIncrementDetails(s,t,i)}this.hasBeenInstantiated=!0}isInstantiated(){return this.hasBeenInstantiated}instantiateForPartStudio(e){this.node.getParent()!==e&&e.addChild(this.node),this.hasBeenInstantiated||(this.instantiateEntities(),this.hasBeenInstantiated=!0)}removePartStudioInstantiation(e){e.removeChild(this.node,!0)}onAppearanceConstantsUpdated(){const e=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(TE.KF);this.node.removeOccurrenceFromNode(Qp,e.getOccurrenceId()),this.instantiateRanges()}handlesEntity(e,t){return!e.hasTessellationError()&&e.isPointEntity()&&!this.viewer.getIsForFlattenedDisplay()}getRanges(e,t){const i=this.getStyleId(t,e.isFromOrigin()),s=this.styledRanges[i];return s?s.getMeshRanges():null}updateEntityGraphics(e,t,i){if(!t)return;const s=this.addMeshIncrement(t);this.updateEntityGraphicsFromIncrementDetails(s,e,i)}updateEntityGraphicsFromIncrementDetails(e,t,i){if(!e)return;const s=this.getRanges(i,!1);s&&s.onIncrementAdded(e);const n=this.getRanges(i,!0);n&&n.onIncrementAdded(e),this.isEntityHidden(i,TE.KF)&&this.hideMeshIncrement(t,TE.KF)}removeMeshIncrement(e){const t=this.getMeshManager().removeMeshIncrement(e,this.getMeshOwnerId());if(!t)return null;const i=this.idToMetaData[e];if(!i)return null;const s=this.getRanges(i,!1);s&&s.onIncrementRemoved(t);const n=this.getRanges(i,!0);return n&&n.onIncrementRemoved(t),t}getHideableFeatureIds(){return this.featureToIds.getKeys()}}var tm=i(35851);const im=_e.O.createLogger("BodyComponent",k.bVy.GRAPHICS);class sm{constructor(){this.version=0,this.browserAge=0,this.time=0,this.cacheEntriesCount=0,this.faces=0,this.triangles=0,this.edges=0,this.lines=0,this.vertices=0,this.silhouettes=0,this.settingCounts={},this.uniqueParts=0,this.uniqueSurfaces=0,this.uniqueCurves=0,this.uniqueOpenComposites=0,this.uniqueClosedComposites=0,this.partOccurrences=0,this.surfaceOccurrences=0,this.curveOccurrences=0,this.openCompositeOccurrences=0,this.openCompositeConstituentOccurrences=0,this.closedCompositeOccurrences=0,this.closedCompositeConstituentOccurrences=0,this.bodiesPendingRetrieval=0,this.veryFineParts=new Array,this.veryFineOccurrences=new Array,this.errors=[],this.uniqueMateConnectors=0,this.uniqueSketches=0,this.totalJSHeapSize=0,this.usedJSHeapSize=0,this.jsHeapSizeLimit=0}}var nm,rm;!function(e){e[e.ALL_OPAQUE=0]="ALL_OPAQUE",e[e.OPAQUE_BODY_TRANSPARENT_FACE=1]="OPAQUE_BODY_TRANSPARENT_FACE",e[e.TRANSPARENT_BODY_OPAQUE_FACE=2]="TRANSPARENT_BODY_OPAQUE_FACE",e[e.ALL_TRANSPARENT=3]="ALL_TRANSPARENT"}(nm||(nm={})),function(e){e[e.OPAQUE=0]="OPAQUE",e[e.TRANSPARENT=1]="TRANSPARENT"}(rm||(rm={}));const am=X.default.getManager(),om="body_component.",hm=new Bi({}),cm=new Bi({color:am.getColor("MESH_FACET_EDGE_COLOR"),lineWidth:am.getNumber("MESH_FACET_EDGE_LINE_WIDTH")}),lm=(new Bi({shininess:am.getNumber("MESH_SHININESS"),specularColor:am.getColor("MESH_SPECULAR"),ambientFactor:am.getNumber("MESH_AMBIENT_FACTOR"),diffuseFactor:am.getNumber("MESH_DIFFUSE_FACTOR")}),new Gi.hF({material:hm,zOffset:am.getNumber("PART_FACES_Z_OFFSET"),primitiveType:Ai.MX.TRIANGLE_STRIP,includedInBlend:!0,clippedBySectionPlanes:!0,isVisible:!1})),dm=lm.cloneAndModify({zOffset:X.default.getManager().getNumber("SURFACE_Z_OFFSET"),isTwoSided:!0}),um=new Gi.hF({material:hm,zOffset:am.getNumber("NON_MODIFIABLE_Z_OFFSET"),primitiveType:Ai.MX.TRIANGLE_STRIP,includedInBlend:!0,clippedBySectionPlanes:!0,addsToSectionMask:!1,primitivesHaveTransparency:!0,isTwoSided:!0}),gm=new Gi.hF({material:hm,zOffset:am.getNumber("NON_MODIFIABLE_Z_OFFSET"),primitiveType:Ai.MX.TRIANGLE_STRIP,isTwoSided:!0,includedInBlend:!0,clippedBySectionPlanes:!0,primitivesHaveTransparency:!0}),pm=new Gi.hF({debugId:"MeshEdges",material:cm,zOffset:am.getNumber("PART_EDGES_Z_OFFSET"),primitiveType:Ai.MX.LINES,addsToBounds:!1,includedInBlend:!0,clippedBySectionPlanes:!0,isPickable:!1}),mm=pm.cloneAndModify({debugId:"TranslucentMeshEdges",isStencilWritten:!1,includedInBlend:!0,primitivesHaveTransparency:!0}),fm=new Gi.hF({material:hm,zOffset:am.getNumber("PART_FACES_Z_OFFSET"),primitiveType:Ai.MX.TRIANGLE_STRIP,includedInBlend:!0,clippedBySectionPlanes:!0,debugId:"PartFaces"}),Im=new Gi.hF({material:hm,zOffset:am.getNumber("PART_FACES_Z_OFFSET"),primitiveType:Ai.MX.TRIANGLE_STRIP,primitivesHaveTransparency:!0,includedInBlend:!0,clippedBySectionPlanes:!0,isTwoSided:!0,debugId:"TranslucentPartFaces"}),Em=new Gi.hF({material:hm,zOffset:am.getNumber("SURFACE_Z_OFFSET"),primitiveType:Ai.MX.TRIANGLE_STRIP,isTwoSided:!0,includedInBlend:!0,clippedBySectionPlanes:!0,debugId:"SurfaceFaces"}),Sm=new Gi.hF({material:hm,zOffset:am.getNumber("SURFACE_Z_OFFSET"),primitiveType:Ai.MX.TRIANGLE_STRIP,isTwoSided:!0,includedInBlend:!0,clippedBySectionPlanes:!0,primitivesHaveTransparency:!0,debugId:"TranslucentSurfaceFaces"}),Tm=new Gi.hF({zOffset:am.getNumber("PART_POINTS_Z_OFFSET"),primitiveType:Ai.MX.POINTS,isVisible:!1,addsToBounds:!1,includedInBlend:!0,clippedBySectionPlanes:!0}),Dm=fm.cloneAndModify({isTwoSided:!0}),Cm=Tm.cloneAndModify({zOffset:am.getNumber("SURFACE_POINTS_Z_OFFSET")}),Mm=Tm.cloneAndModify({zOffset:am.getNumber("WIRE_POINTS_Z_OFFSET")});function ym(e){return e.getZOffset()===Em.zOffset||e.getZOffset()===gm.zOffset}const Am={};function Pm(e,t){let i=Am[e];if(!i){i=new mS.bg;const s=[t.color[0]/255,t.color[1]/255,t.color[2]/255,t.opacity/255];i.setAttribute(RS.COLOR,s),Am[e]=i}return i}function Om(e){if(e){const t=e.getAttribute(RS.COLOR);if(t)return t[3]<1}return!1}const Rm=new Mi.si;let wm=!1,vm=!1;class _m extends Kg{constructor(e,t,i,s){super(e,s,i),this.bodyLoadTasks=t,this.bodyMetaData={},this.lastSetBodyColor={},this.subBodyStyleOverrides=new Gl.TemplatedNestedMap,this.entityStyles={},this.cachedBodyTransparencyState={},this.partStudioBodyIdToOccurrenceId={},this.cullableBodies=null,this.instantiatedTriangleCount=-1,this.sheetMetalOrderIdToTransform={},this.previewClone=null,this.baseComponent=null,this.bodiesHiddenInBase=new Set,this.tessellationSettings={},this.partTriangleCounts={},this.bodiesWithUpdatedMeshReferences=new Set,this.scalarVisualizationOccurrences=new Set,this.generativePartInstanceOccurrences=new Set,this.bodyIdToSmoothEdges=new Gl.TemplatedSetMap,this.previousBodyIdToSmoothEdgesCount=new Map,this.node=e.getModelViewManager().getSharedBodyNode(),this.collectionId=Rm.getId(),this.knownBodyIds=new Set,this.occurrenceAlphaModifiers=new Map,this.bodyVisibility=new Gl.TemplatedNestedMap,this.bodyToOccurrenceId=new Gl.TemplatedNestedMap,this.unavailableBodyOccurrences=new Gl.TemplatedNestedMap,this.silhouetteCallback=(e,t)=>{this.onSilhouetteCreated(e,t)},this.decalComponent=new Bg(this,e),this.cosmeticThreadsEnabled=es.Jq.CapabilitiesService.checkRenderCosmeticThreadsCppServerCurrentlyEnabled(),this.cosmeticThreadsEnabled&&(this.cosmeticThreadComponent=new wg(this))}getCollectionId(){return this.collectionId}getNode(){return this.node}getDecalComponent(){return this.decalComponent}getBodyIds(e=(()=>!0)){const t=[];for(const i of Object.keys(this.bodyMetaData))e(this.bodyMetaData[i])&&t.push(i);return t}getEntityIds(e){const t=[];for(const i in this.idToMetaData)e(this.idToMetaData[i])&&t.push(i);return t}getCorrectedBodyOccurrenceId(e,t){return t&&t!==TE.KF||(t=this.partStudioBodyIdToOccurrenceId[e]),t}getBodyToOccurrenceId(){return this.bodyToOccurrenceId}copyBodyDataToClone(e){let t;for(t in e.bodyLoadTasks=this.bodyLoadTasks,this.bodyMetaData)e.bodyMetaData[t]=this.bodyMetaData[t].clone();for(t in e.knownBodyIds=new Set(this.knownBodyIds),e.bodyIdToSmoothEdges=this.bodyIdToSmoothEdges.structuredClone(),e.previousBodyIdToSmoothEdgesCount=new Map(this.previousBodyIdToSmoothEdgesCount),this.lastSetBodyColor)e.lastSetBodyColor[t]=this.lastSetBodyColor[t].slice(0);this.subBodyStyleOverrides.eachNested(((t,i,s)=>{e.subBodyStyleOverrides.insertNested(i,s,t.clone())})),e.tessellationSettings=(0,z.Z)(this.tessellationSettings),e.partTriangleCounts=(0,z.Z)(this.partTriangleCounts),e.entityStyles=(0,z.Z)(this.entityStyles)}clone(e){this.bodyLoadTasks.completeTasks();const t=new _m(e,this.bodyLoadTasks,this.usage,this.viewer);return this.copyBodyDataToClone(t),this.copyToClone(t),this.decalComponent.copyToClone(t.decalComponent),this.cosmeticThreadsEnabled&&this.cosmeticThreadComponent.copyToClone(t.cosmeticThreadComponent),t}cloneForPreview(e){const t=new _m(e,this.bodyLoadTasks,ys.L.PREVIEW,this.viewer);this.copyToPreview(t),this.copyBodyDataToClone(t),Object.entries(this.occurrences).forEach((([e,i])=>{!i&&(t.occurrences[e]=i)})),this.bodyToOccurrenceId.eachNested(((e,i,s)=>{t.occurrences.hasOwnProperty(s)&&t.bodyToOccurrenceId.insertNested(i,s,e)})),this.unavailableBodyOccurrences.eachNested(((e,i,s)=>{t.occurrences.hasOwnProperty(s)&&t.unavailableBodyOccurrences.insertNested(i,s,e)}));for(const e in this.bodyMetaData)t.refreshBodyOccurrences(e);return this.previewClone=t,t.baseComponent=this,t.decalComponent=this.decalComponent.cloneForPreview(t,e),this.cosmeticThreadsEnabled&&(t.cosmeticThreadComponent=this.cosmeticThreadComponent.cloneForPreview(t)),t}onPreviewDestroyed(){this.previewClone=null}copyVisibility(e){e.bodyVisibility.eachNested(((e,t,i)=>(this.hideShowBody(i,e,+t),!1)))}getBodyLoadTasks(){return this.bodyLoadTasks}getTessellationSettings(){return this.tessellationSettings}getPartTriangleCounts(){return this.partTriangleCounts}damageInstantiatedTriangleCount(){this.instantiatedTriangleCount=-1}getInstantiatedTriangleCount(){if(this.instantiatedTriangleCount<0){this.instantiatedTriangleCount=0;const e=this.getMeshManager(),t=this.getMeshOwnerId();this.bodyToOccurrenceId.each(((i,s)=>{if(i&&!i.isEmpty()){const n=e.getGroupRangesForGroupTypeAndLod(s,t,Ai.MX.TRIANGLE_STRIP,wS.DEFAULT);n&&(this.instantiatedTriangleCount+=i.size()*n.getPrimitiveCount())}return!1}),this)}return this.instantiatedTriangleCount}hasDisplayedEdgesWithOutdatedSmoothnessInfo(){let e=!1;return this.bodyToOccurrenceId.each(((t,i)=>{const s=this.bodyToEntity.get(i);return s&&s.each(((t,i)=>{const s=this.idToMetaData[i];return s&&s.isEdge()&&(s.getEdgeSmoothnessStatus()===k.dA1.UNKNOWN||s.getEdgeSmoothnessStatus()===k.dA1.SMOOTH)&&(e=!0),e})),e})),e}getEstimatedMemoryUsage(){let e=0;for(const t in this.bodyMetaData){this.bodyMetaData[t].isClosedCompositeConstituent||(e+=this.bodyMetaData[t].getEstimatedMemoryUsage())}return e}retrieveBodyMetaData(e){return this.bodyMetaData[e]||null}getBodyDiameter(e){const t=this.bodyMetaData[e];return t?t.getBounds().diameter():0}isBodyIsolated(e,t){const i=this.getOccurrenceDataForBody(e,t);return!!i&&i.getIsolated()}isBodyVisible(e,t){const i=this.getOccurrenceDataForBody(e,t);return!!i&&i.getVisibility()!==Xs.EE.HIDDEN}getOccurrenceDataForBody(e,t){let i=this.bodyMetaData[t];if(i&&i.isClosedComposite&&!i.isGroupableCompositeBody){let e=null;for(let t=0;t<i.constituentBodyIds.length&&!e;++t)e=this.bodyMetaData[i.constituentBodyIds[t]];i=e}return this.getBodyOccurrenceData(i.meshGroupId,e)}isBodyInstantiated(e){const t=this.bodyMetaData[e];if(!t)return!1;if(!t.isNonGroupingCompositeBody)return this.bodyToOccurrenceId.has(t.meshGroupId);for(let e=0;e<t.constituentBodyIds.length;++e)if(this.bodyToOccurrenceId.has(t.constituentBodyIds[e]))return!0}getNonInstantiatedBodies(){const e=[];for(const t in this.bodyMetaData){this.bodyMetaData[t].isClosedCompositeConstituent||(this.isBodyInstantiated(t)||e.push(this.bodyMetaData[t]))}return e}getComponentId(){return om}reset(){this.bodyToOccurrenceId.eachNested(((e,t,i)=>(this.removeBodyOccurrence(i,t),!1)),this),this.unavailableBodyOccurrences.clear(),this.bodyLoadTasks.clearAllBodiesForComponent(this),this.bodyMetaData={},this.tessellationSettings={},this.knownBodyIds.clear(),this.lastSetBodyColor={},this.partStudioBodyIdToOccurrenceId={},this.sheetMetalOrderIdToTransform={},this.entityStyles={},this.subBodyStyleOverrides.clear(),this.decalComponent.destroy(),this.decalComponent=new Bg(this,this.parent),this.cosmeticThreadsEnabled&&(this.cosmeticThreadComponent.destroy(),this.cosmeticThreadComponent=new wg(this)),this.bodyIdToSmoothEdges.clear(),this.previousBodyIdToSmoothEdgesCount.clear(),this.damageInstantiatedTriangleCount(),super.reset()}updateBodyDisplayData(e,t){const i=new mt.StringSet;for(const t in e.deterministicPartIdToData){const i=e.deterministicPartIdToData[t];if(i.isDeletion){this.parent.bodyIdsThatAreInsertableBuffers?.delete(t),delete this.tessellationSettings[t],delete this.partTriangleCounts[t];const e=this.bodyMetaData[t];if(e?.isClosedComposite)for(const t of e.constituentBodyIds)this.bodyIdToSmoothEdges.delete(t),this.previousBodyIdToSmoothEdgesCount.delete(t);else this.bodyIdToSmoothEdges.delete(t),this.previousBodyIdToSmoothEdgesCount.delete(t)}else{this.tessellationSettings[t]=i.tessellationSettings;const e=new k.xTE;e.coarsePlanarFaceTriangleCount=i.coarsePlanarFaceTriangleCount,e.coarseTriangleCount=i.coarseTriangleCount,e.totalEntityCount=i.totalEntityCount,this.partTriangleCounts[t]=e}}this.knownBodyIds=new Set;for(let s=0;s<e.partDisplayData.length;++s){const n=e.partDisplayData[s].id;this.knownBodyIds.add(n);const r=e.deterministicPartIdToData[n];if(r){if(this.viewer.getIsForFlattenedDisplay()!==r.isForFlattenedView()){if(this.viewer.getIsForFlattenedDisplay())continue;n in this.partStudioBodyIdToOccurrenceId&&this.removeBodyOccurrence(TE.KF,n)}}else if(!this.bodyMetaData.hasOwnProperty(n))continue;if(i.add(n),!t||e.deterministicPartIdToData.hasOwnProperty(n)){let i=-1;t&&rl()&&this.bodyMetaData[n]&&null!==this.bodyMetaData[n].getFinestTessellationSettingInMemory()&&(i=this.bodyMetaData[n].getFinestTessellationSettingInMemory());const r=e.deterministicPartIdToData[n],a=e.partDisplayData[s];if(a||im.warn("Missing expected BTPartDisplayData"),this.updateBodyMetaData(e,n,a,r),t&&rl()){const e=this.bodyMetaData[n],t=(e.getEstimatedMemoryUsage()-e.getEstimatedMemoryUsage([i]))/1024/1024;t>am.getNumber("SINGLE_BODY_MEMORY_CHANGE_INFO_THRESHOLD_MB")&&im.info("Memory change for "+n+" to go to "+e.getFinestTessellationSettingInMemory()+": "+t+"MB")}}const a=this.bodyMetaData[n];if(a.isClosedComposite)for(let e=0;e<a.constituentBodyIds.length;++e)this.knownBodyIds.add(a.constituentBodyIds[e]),i.add(a.constituentBodyIds[e])}let s=null;for(const e in this.bodyMetaData)i.contains(e)||(this.removeBodyOccurrence(TE.KF,e),this.bodyMetaData[e].removeOpenCompositeBodyReferences(this.bodyMetaData),delete this.bodyMetaData[e],delete this.lastSetBodyColor[e],this.bodyIdToSmoothEdges.delete(e),this.previousBodyIdToSmoothEdgesCount.delete(e),this.subBodyStyleOverrides.remove(e),s||(s=new mt.StringSet),s.add(e));s&&this.bodyLoadTasks.clearBodiesForComponent(this,s)}processDeletions(e){let t,i;for(const s in e.deterministicPartIdToData){const n=e.deterministicPartIdToData[s];for(let s=0;s<n.entityDIds.length;++s)i=n.entityDIds[s],t=e.deterministicIdToEntity[i],t&&!this.handlesEntity(t,n)&&this.removeEntity(i)}for(i in e.deterministicIdToEntity)t=e.deterministicIdToEntity[i],t.isDeletion()&&(delete this.entityStyles[i],this.removeEntity(i))}removeEntity(e){const t=this.idToMetaData[e];if(t){if(this.cosmeticThreadsEnabled){const t=this.cosmeticThreadComponent.removeFace(e);t&&this.bodiesWithUpdatedMeshReferences.add(t)}t.isSmoothEdge()&&this.bodyIdToSmoothEdges.deleteValue(t.getBodyId(),e,!0),super.removeEntity(e)}}updatePSOI(e){for(const t in e.detIdToPSOIIncrement)this.bodyMetaData[t]&&(this.bodyMetaData[t].partIdentity=e.detIdToPSOIIncrement[t])}unloadBody(e){const t=this.bodyMetaData[e];if(!t)return;t.setIsTessellationLoaded(!1),t.tessellationSettings=[];const i=this.bodyToEntity.get(e);if(i&&i.each(((e,t)=>(this.removeEntity(t),!1)),this),this.tessellationSettings[e]=[k.ls1.CLIENT_UNLOADED_TESSELLATION_SETTING],this.damageInstantiatedTriangleCount(),t.isClosedComposite)for(let e=0;e<t.constituentBodyIds.length;++e)this.unloadBody(t.constituentBodyIds[e])}removeBaseIncrement(e){if(this.baseComponent){const t=this.baseComponent.idToMetaData[e];if(t){const i=this.baseComponent.getEntityBodyGroupId(t),s=this.baseComponent.bodyToOccurrenceId.get(i);s&&s.each(((t,i)=>(this.removeBaseIncrementFromOccurrence(e,i),!1)),this)}}}onBaseSilhouetteAdded(e,t,i){const s=this.bodyToOccurrenceId.get(i);s&&s.each(((i,s)=>(this.wasIncrementRemovedFromBase(e,s)&&this.hideBaseIncrement(t,s),!1)),this)}processAdditionsAndChanges(e,t,i){let s;for(s in this.updateBodyDisplayData(e,i),this.updateEntityAppearanceOverrides(e),this.processPrecompiledGraphicsBuffers(e.partIdAndTessellationSettingToBuffers),e.deterministicPartIdToData){const t=e.deterministicPartIdToData[s],i=this.bodyMetaData[s];if(!i)continue;const n=i.getIsTessellationLoaded(),r=i.canEntitiesBeLoaded();if(this.viewer.areOptimizedBuffersEnabled){if(!e.partIdAndTessellationSettingToBuffers[s])continue;this.refreshBodyOccurrences(s)}else{_m.sortEntityIdsToOptimizeBuffers(t.entityDIds,e.deterministicIdToEntity);for(let a=0;a<t.entityDIds.length;++a){const o=t.entityDIds[a],h=e.deterministicIdToEntity[o];if(!h||this.handlesEntity(h,t))if(h){const e=xE(h,o,this.getEntityIdManager().getOrCreateIdForName(o));if(!e)continue;h.setBodyMetaData(i),h.setMeshIncrement(e),this.removeOldEntityGraphics(o,h),this.addIdMappings(o,h,s),n?this.updateEntityGraphics(o,e,h):this.updateGroupId(h,e),this.viewer.getIsForFlattenedDisplay()===t.isForFlattenedView()&&h.removeGeometry()}else r&&this.changeEntityOwner(o,s)}}n||i.isClosedCompositeConstituent||!i.canEntitiesBeLoaded()||this.bodyLoadTasks.postBodyToLoad(this,s)}this.updateBodiesWithChangedMeshReferences(),this.decalComponent.update(e),this.deterministicIdToAssociatedFeatureIds=e.deterministicIdToAssociatedFeatureIds,this.featureIdToAssociatedDeterministicIds={};for(const[e,t]of Object.entries(this.deterministicIdToAssociatedFeatureIds))for(const i of t){let t=this.featureIdToAssociatedDeterministicIds[i];t||(t=[],this.featureIdToAssociatedDeterministicIds[i]=t),t.push(e)}t&&this.addPartStudioOccurrences()}getBodyType(e){const t=this.bodyMetaData[e];if(t)return t.type;const i=this.parent.getEntitiesForBody(e);for(let e=0;i&&e<i.length;e++){const t=this.parent.retrieveEntityMetaData(i[e]);if(t&&t instanceof k.sWe)return k.wG2.POINT}return null}accumulateSketchIdsFromBodyId(e,t){this.parent.sketchComponent.accumulateSketchIdsFromBodyId(e,t)}updateCompositeConstituentCounts(e){for(let t=0;t<e.partDisplayData.length;t++){const i=e.partDisplayData[t].id,s=this.bodyMetaData[i];s&&s.isComposite&&s.updateConstituentTypeCounts(this)}}handlesEntity(e,t){const i=t&&this.viewer.getIsForFlattenedDisplay()&&!t.isForFlattenedView();return!e.hasTessellationError()&&e.isFromBody()&&!i}updateEntityAppearanceOverrides(e){for(const t in e.appearanceIdToAppearanceOverride){const i=e.appearanceIdToAppearanceOverride[t],s=t===k.QHW.RESET_APPEARANCE_ID?null:Pm(t,i.appearance);for(let e=0;e<i.entityDeterministicIds.length;++e){const t=i.entityDeterministicIds[e];if(s?this.entityStyles[t]=s:delete this.entityStyles[t],this.containsEntity(t)){const e=this.getMeshIncrementDetails(t)||this.getBaseMeshIncrementDetails(t);e&&(this.removeEntityAppearanceOverride(e),s&&this.incorporateEntityAppearanceOverride(e))}}}}static sortEntityIdsToOptimizeBuffers(e,t){e.sort(((e,i)=>{const s=t[e],n=t[i];return s||n?s&&!n?-1:!s&&n?1:s.getEntityType()!==n.getEntityType()?s.getEntityType()<n.getEntityType()?-1:1:s.isEdge()&&s.isSmoothEdge()!==n.isSmoothEdge()?s.isSmoothEdge()?-1:1:0:0}))}isOccurrenceTranslucent(e){return this.viewer.getIsolatedOccurrenceManager()?.isOccurrenceTranslucent(e)}getNodePropertiesForFace(e,t,i,s){const n=i===rm.TRANSPARENT||this.isOccurrenceTranslucent(s);return e.containsOnlySheetBodies()?e.isModifiableBody()?n?Sm:Em:gm:e.isModifiableBody()?n?Im:t!==nm.ALL_OPAQUE?Dm:fm:um}getNodePropertiesForEdge(e,t=null){const i=this.viewer.getResources();if(e.getIsBendCenterLineBody())return i.CENTER_LINE_NODE_PRPOPERTIES;{const s=()=>this.isOccurrenceTranslucent(t);return e.containsOnlyWireBodies()?e.isModifiableBody()?s()?i.TRANSLUCENT_WIRE_EDGE_NODE_PROPERTIES:i.WIRE_EDGE_NODE_PROPERTIES:i.WIRE_EDGE_NODE_PROPERTIES_NON_MODIFIABLE:e.containsOnlySheetBodies()?e.isModifiableBody()?s()?i.TRANSLUCENT_SURFACE_EDGE_NODE_PROPERTIES:i.SURFACE_EDGE_NODE_PROPERTIES:i.SURFACE_EDGE_NODE_PROPERTIES_NON_MODIFIABLE:e.isModifiableBody()?s()?i.TRANSLUCENT_PART_EDGE_NODE_PROPERTIES:i.PART_EDGE_NODE_PROPERTIES:i.PART_EDGE_NODE_PROPERTIES_NON_MODIFIABLE}}getNodePropertiesForMeshEdge(e){return this.isOccurrenceTranslucent(e)?mm:pm}getNodePropertiesForSmoothEdges(e,t){const i=this.viewer.getResources(),s=this.isOccurrenceTranslucent(t);if(!this.bodyIdToSmoothEdges.get(e.getId())?.size){if(0===this.getSmoothEdgeCountForCompositeBody(e))return null}return e.containsOnlySheetBodies()?s?i.TRANSLUCENT_SURFACE_SMOOTH_EDGE_NODE_PROPERTIES:e.isModifiableBody()?i.SURFACE_SMOOTH_EDGE_NODE_PROPERTIES:i.SURFACE_SMOOTH_EDGE_NODE_PROPERTIES_NON_MODIFIABLE:e.containsOnlySolidBodies()?s?i.TRANSLUCENT_PART_SMOOTH_EDGE_NODE_PROPERTIES:e.isModifiableBody()?i.PART_SMOOTH_EDGE_NODE_PROPERTIES:i.PART_SMOOTH_EDGE_NODE_PROPERTIES_NON_MODIFIABLE:null}getNodePropertiesForSilhouettes(e){return null!==e&&this.viewer.getIsolatedOccurrenceManager()?.isOccurrenceTranslucent(e)?this.viewer.getResources().TRANSLUCENT_SILHOUETTE_NODE_PROPERTIES:this.viewer.getResources().SILHOUETTE_NODE_PROPERTIES}getNodePropertiesForPoint(e){return e.containsOnlyWireBodies()?Mm:e.containsOnlySheetBodies()?Cm:Tm}getGroupBoundsForEntity(e){const t=this.getEntityBodyGroupId(e),i=this.bodyMetaData[t];if(!i){const i=e.getEntityType();return im.info(`Could not find bodyMetaData for entityType ${i} and entityBodyGroupId ${t} while fetching group bounds for entity`),null}return i.getBounds()}addMeshIncrementAndSilhouettes(e,t){const i=this.getGroupBoundsForEntity(t),s=super.addMeshIncrement(e,i);t.isSmoothEdge()&&this.bodyIdToSmoothEdges.add(t.getBodyId(),e.id),this.incorporateEntityAppearanceOverride(s),this.addMeshTriangleEdges(e,t);e.primitiveType===Ai.MX.TRIANGLE_STRIP&&!t.isPlanar()&&this.viewer.getSilhouetteTask().postSilhouetteRequest(e,this.usage,this.silhouetteCallback),this.damageInstantiatedTriangleCount()}addMeshTriangleEdges(e,t){if(t.isFace()&&(wm||t.getSurfaceType()===k.C1H.MESH)){const i=_m.getMeshEdgeId(e.id),s=(0,Yd.sp)(e,i);if(s){s.groupId=_m.getMeshEdgeId(this.getEntityBodyGroupId(t));const e=this.getGroupBoundsForEntity(t);this.getMeshManager().addMeshIncrement(s,this.getMeshOwnerId(),e)}}}onSilhouetteCreated(e,t){const i=e.id,s=this.idToMetaData[i];s&&s.getIncrementGloballyUniqueId()===e.getGloballyUniqueId()&&t&&(t.groupId=e.groupId,this.getMeshManager().addMeshIncrement(t,this.getMeshOwnerId()),this.previewClone&&this.previewClone.onBaseSilhouetteAdded(i,t.id,e.groupId),this.viewer.requestDraw())}static getMeshEdgeId(e){return-1!==e.indexOf(_m.MESH_EDGE_GROUP_SUFFIX,e.length-_m.MESH_EDGE_GROUP_SUFFIX.length)?e:e+_m.MESH_EDGE_GROUP_SUFFIX}static getPotentialMeshGroupIdsForBody(e){return[e,e+_m.MESH_EDGE_GROUP_SUFFIX,e+_m.SMOOTH_EDGE_GROUP_SUFFIX]}callBaseVisibilityMethodForIncrementAndDerivations(e,t,i){const s=e.call(this,t,i);e.call(this,uE(t),i);const n=_m.getMeshEdgeId(t);return n!==t&&e.call(this,n,i),s}showMeshIncrement(e,t){return this.callBaseVisibilityMethodForIncrementAndDerivations(Yg.prototype.showMeshIncrement,e,t)}hideMeshIncrement(e,t){return this.callBaseVisibilityMethodForIncrementAndDerivations(Yg.prototype.hideMeshIncrement,e,t)}hideBaseIncrement(e,t){return this.callBaseVisibilityMethodForIncrementAndDerivations(Yg.prototype.hideBaseIncrement,e,t)}showBaseIncrement(e,t){return this.callBaseVisibilityMethodForIncrementAndDerivations(Yg.prototype.showBaseIncrement,e,t)}refreshEntityGraphics(e,t){let i=this.idToMetaData[e];i&&(this.removeMeshIncrement(e),this.removeBaseIncrement(e),i=i.cloneForNewBody(t),this.idToMetaData[e]=i,this.updateEntityGraphics(e,i.getMeshIncrement(),i))}removeMeshIncrement(e){const t=Yg.prototype.removeMeshIncrement.apply(this,[e]);super.removeMeshIncrement(uE(e)),t&&(this.viewer.getSilhouetteTask().removePendingRequest(t.increment,this.usage),this.removeEntityAppearanceOverride(t));const i=_m.getMeshEdgeId(e);return i!==e&&Yg.prototype.removeMeshIncrement.call(this,i),this.damageInstantiatedTriangleCount(),t}incorporateEntityAppearanceOverride(e){let t=!1;const i=e?.increment?.groupId,s=this.entityStyles[e.increment?.id];if(s){const n=Om(s)?rm.TRANSPARENT:rm.OPAQUE;let r=this.subBodyStyleOverrides.getNested(i,n);r||(r=new qT(i+" "+(n===rm.OPAQUE?"opaque":"transparent")+" entity style overrides",i),this.subBodyStyleOverrides.insertNested(i,n,r),t=!0),r.onIncrementAdded(e,s)}t&&this.bodiesWithUpdatedMeshReferences.add(i)}removeEntityAppearanceOverride(e){let t=!1;const i=e.increment?.groupId,s=this.subBodyStyleOverrides.get(i);s&&s.each(((s,n)=>{s.onIncrementRemoved(e)&&s.isEmpty()&&(s.destroy(),this.subBodyStyleOverrides.removeNested(i,n),t=!0)})),t&&this.bodiesWithUpdatedMeshReferences.add(i)}damageComputedBodyTransparency(e){delete this.cachedBodyTransparencyState[e]}getComputeBodyTransparency(e){if(this.cachedBodyTransparencyState.hasOwnProperty(e))return this.cachedBodyTransparencyState[e];const t=this.getBodyColorByBodyId(e)[3]<1,i=this.bodyMetaData[e];let s=[e];i&&i.isClosedComposite&&(s=i.constituentBodyIds);let n=0,r=0;for(let e=0;e<s.length;++e){const t=this.bodyToEntity.get(s[e]);t&&t.each(((e,t)=>{const i=this.entityStyles[t];return i&&(Om(i)?++n:++r),n>0&&r>0}))}let a=nm.ALL_OPAQUE;return t&&r>0?a=nm.TRANSPARENT_BODY_OPAQUE_FACE:!t&&n>0?a=nm.OPAQUE_BODY_TRANSPARENT_FACE:t&&(a=nm.ALL_TRANSPARENT),this.cachedBodyTransparencyState[e]=a,a}getHideableFeatureIds(){return[]}hideShowFeature(e,t,i){this.featureVisibility[e]=t;const s=this.getEntitiesForFeature(e);if(!s)return;const n=new mt.StringSet;for(let e=0;e<s.length;++e){const t=this.idToMetaData[s[e]];let r=t?t.getBodyMetaData():void 0;r?.isClosedCompositeConstituent&&(r=r.consumingClosedCompositeData),r&&!r.isModifiableBody()&&i&&n.add(r.id)}n.each((e=>{this.hideShowBody(e,t,TE.KF)}),this)}updateEdgeSmoothness(e){let t=0;for(const i in this.idToMetaData){const s=this.idToMetaData[i];if(s.isEdge()&&(s.isFromSolidBody()||s.isFromSheetBody())){e.hasOwnProperty(i)||++t;const n=s.getGeometry();e[i]&&!s.isFromWireBody()?n.edgeSmoothnessStatus=k.dA1.SMOOTH_V2:n.edgeSmoothnessStatus=k.dA1.NOT_SMOOTH}}t>0&&im.warn("Did not find edge smoothness data for "+t+" edges")}updateGroupId(e,t){const i=this.getEntityBodyGroupId(e);e.isSmoothEdge()?t.groupId=i+_m.SMOOTH_EDGE_GROUP_SUFFIX:t.groupId=i}updateEntityGraphics(e,t,i){t.pickId=this.getEntityIdManager().getOrCreateIdForName(e),!this.parent.getIsMissingTangencyInformationMessageShown()&&this.viewer.getSmoothEdgesRenderStyle()!==k.YUG.VISIBLE&&i.isEdge()&&i.getEdgeSmoothnessStatus()===k.dA1.UNKNOWN&&(this.parent===this.parent.getModelViewManager().getDisplayedPartStudio()?this.parent.getModelViewManager().updateSmoothEdgesForDisplayedPartStudio():(this.viewer.showTangencyInformationMissingMessage(),this.parent.setIsMissingTangencyInformationMessageShown(!0),setTimeout((()=>{this.viewer.setSmoothEdgesRenderStyle(k.YUG.VISIBLE)}),0))),this.updateGroupId(i,t),this.cosmeticThreadsEnabled&&this.cosmeticThreadComponent.updateEntity(e,i,t.groupId).forEach((e=>{this.bodiesWithUpdatedMeshReferences.add(e)})),this.addMeshIncrementAndSilhouettes(t,i)}instantiateForPartStudio(e){Yg.prototype.instantiateForPartStudio.apply(this,[e]),this.addPartStudioOccurrences()}removePartStudioInstantiation(e){this.usage===ys.L.PREVIEW&&Yg.prototype.removePartStudioInstantiation.apply(this,[e]),this.removeOccurrence(TE.KF,!1)}isBodyLoaded(e){const t=this.bodyMetaData[e];return!!t&&t.getIsTessellationLoaded()}processBodyAddition(e,t,i=!0){const s=this.bodyMetaData[e];if(s&&s.isClosedComposite){for(let e=0;e<s.constituentBodyIds.length;++e){const i=s.constituentBodyIds[e];if(!this.isBodyLoaded(i)){const n=!this.bodyMetaData[i].canBeGroupedWithOtherConstituents;this.processBodyAddition(s.constituentBodyIds[e],t,n)}}return s.setIsTessellationLoaded(!0),this.cosmeticThreadsEnabled&&this.cosmeticThreadComponent.getBodiesWithCosmeticThreads(s).forEach((e=>{this.bodiesWithUpdatedMeshReferences.add(e)})),this.updateBodiesWithChangedMeshReferences(),this.decalComponent.onBodyLoaded(),s.isGroupableCompositeBody&&this.updateBodyIfSmoothEdgeCountChanged(s),!0}if(this.isBodyLoaded(e)&&im.warn("The same body occurrence was loaded twice"),!this.viewer.areOptimizedBuffersEnabled){const n=this.bodyToEntity.get(e);if(!n)return!0;const r=n.getKeys();_m.sortEntityIdsToOptimizeBuffers(r,this.idToMetaData),r.forEach((e=>{const i=this.idToMetaData[e];if(!i||!i.getMeshIncrement())return!1;t&&t.addVertexCost(i.getMeshIncrement().vertexCount()),this.updateEntityGraphics(e,i.getMeshIncrement(),i)}),this),i&&this.updateBodyIfSmoothEdgeCountChanged(s)}if(s&&s.setIsTessellationLoaded(!0),this.damageInstantiatedTriangleCount(),this.getBodyManager().damageUnloadedBodyBounds(),this.partStudioBodyIdToOccurrenceId.hasOwnProperty(e)){const t=this.viewer.getOccurrenceDataManager().getOccurrenceData(this.partStudioBodyIdToOccurrenceId[e]);t&&t.clearAllOccurrenceLevelHighlights()}return this.updateBodiesWithChangedMeshReferences(),this.decalComponent.onBodyLoaded(),!0}addBodyOccurrence(e,t,i,s){if(this.bodyToOccurrenceId.hasNested(t,e)&&!i)return;const n=this.bodyMetaData[t];if(!n)return void(s||this.unavailableBodyOccurrences.insertNested(t,e,!0));this.bodyToOccurrenceId.insertNested(t,e,!0);const r=this.getBodyOccurrenceData(t,e);if(!r)return void im.warn("Tried to add occurrence without occurrence data");const a=this.getBodyColorByBodyOccurrence(n,r),o=this.getEdgeStyleByBodyOccurrence(n,r,a);if(this.cosmeticThreadsEnabled&&!this.scalarVisualizationOccurrences.has(r.getOccurrenceId())){const e=this.getEntitiesForBody(t);e&&e.forEach((e=>{const i=this.getEntityMetaData(e);this.cosmeticThreadComponent.addMaterialOverrideForEntity(e,i,t)}))}this.syncPartSmoothEdgeCount(n),this.addBodyOccurrenceFromMeshManager(this.getMeshManager(),e,r,t,n,a,o),this.getSharedBaseMeshManager()&&!this.bodiesHiddenInBase.has(t)&&this.addBodyOccurrenceFromMeshManager(this.getSharedBaseMeshManager(),e,r,t,n,a,o),this.scalarVisualizationOccurrences.has(r.getOccurrenceId())||this.decalComponent.addOrUpdateOccurrence(t,e),i||this.damageInstantiatedTriangleCount()}getEdgeStyleByBodyOccurrence(e,t,i){const s=()=>i||this.getBodyColorByBodyOccurrence(e,t),n=new mS.bg;if(this.viewer.getIsolatedOccurrenceManager()?.isOccurrenceTranslucent(t)){const e=this.getTranslucentEdgeColor(s());n.setAttribute(RS.COLOR,e)}else e.containsOnlyWireBodies()&&n.setAttribute(RS.COLOR,s());return n}addBodyOccurrenceFromMeshManager(e,t,i,s,n,r,a){if(n.hasFaces()){const o=new mS.bg;o.setAttribute(RS.COLOR,r);const h=n.getChordalTolerance();null!==h?o.setFloatUniform("uChordalTolerance",h):o.setFloatUniform("uChordalTolerance",Ri.W.MAX_MODEL_SIZE);const c=this.hasOccurrenceAlphaModifier(t)||this.viewer.getIsolatedOccurrenceManager()?.isOccurrenceTranslucent(i)?nm.ALL_TRANSPARENT:this.getComputeBodyTransparency(s);switch(c){case nm.ALL_OPAQUE:this.addFaceRangesToOccurrenceNode(e,n,i,o,c,rm.OPAQUE);break;case nm.ALL_TRANSPARENT:this.addFaceRangesToOccurrenceNode(e,n,i,o,c,rm.TRANSPARENT);break;default:this.addFaceRangesToOccurrenceNode(e,n,i,o,c,rm.OPAQUE),this.addFaceRangesToOccurrenceNode(e,n,i,o,c,rm.TRANSPARENT)}const l=e.getOrCreateGroupRangesForGroupTypeAndLod(s,this.getMeshOwnerId(),Ai.MX.SILHOUETTES,wS.DEFAULT);this.node.addOccurrenceGeometryToNode(this.getNodePropertiesForSilhouettes(i),i,a,l)}if((wm||n.containsMesh())&&!this.scalarVisualizationOccurrences.has(i.getOccurrenceId())){const t=_m.getMeshEdgeId(n.id),s=e.getOrCreateGroupRangesForGroupTypeAndLod(t,this.getMeshOwnerId(),Ai.MX.LINES,wS.DEFAULT);this.node.addOccurrenceGeometryToNode(this.getNodePropertiesForMeshEdge(i),i,a,s)}if(n.hasEdges()){const t=e.getOrCreateGroupRangesForGroupTypeAndLod(s,this.getMeshOwnerId(),Ai.MX.LINES,wS.DEFAULT);this.addSmoothEdgesBodyOccurrenceFromMeshManager(e,i,s,n,a),this.node.addOccurrenceGeometryToNode(this.getNodePropertiesForEdge(n,i),i,a,t)}if(n.hasPoints()){const t=e.getOrCreateGroupRangesForGroupTypeAndLod(s,this.getMeshOwnerId(),Ai.MX.POINTS,wS.DEFAULT);this.node.addOccurrenceGeometryToNode(this.getNodePropertiesForPoint(n),i,a,t)}}addSmoothEdgesBodyOccurrenceFromMeshManager(e,t,i,s,n){const r=this.getNodePropertiesForSmoothEdges(s,t);if(r){const s=e.getOrCreateGroupRangesForGroupTypeAndLod(i+_m.SMOOTH_EDGE_GROUP_SUFFIX,this.getMeshOwnerId(),Ai.MX.LINES,wS.DEFAULT);this.node.addOccurrenceGeometryToNode(r,t,n,s)}}addFaceRangesToOccurrenceNode(e,t,i,s,n,r){const a=t.id;let o;o=this.scalarVisualizationOccurrences.has(i.getOccurrenceId())?t.containsOnlySheetBodies()?dm:lm:this.getNodePropertiesForFace(t,n,r,i);const h=e.getOrCreateGroupRangesForGroupTypeAndLod(a,this.getMeshOwnerId(),Ai.MX.TRIANGLE_STRIP,wS.DEFAULT);let c=null,l=null,d=this.getSubBodyStyleOverrides(a,i,r),u=!1;if(n===nm.ALL_OPAQUE||n===nm.ALL_TRANSPARENT?c=h:n===nm.OPAQUE_BODY_TRANSPARENT_FACE?r===rm.OPAQUE?(c=h,l=this.subBodyStyleOverrides.getNested(a,rm.TRANSPARENT)):(c=this.subBodyStyleOverrides.getNested(a,rm.TRANSPARENT),u=!0,d=null):n===nm.TRANSPARENT_BODY_OPAQUE_FACE&&(r===rm.TRANSPARENT?(c=h,l=this.subBodyStyleOverrides.getNested(a,rm.OPAQUE),u=!0):(c=this.subBodyStyleOverrides.getNested(a,rm.OPAQUE),d=null)),c){let t=l;if(this.cosmeticThreadsEnabled){const n=this.cosmeticThreadComponent.addCosmeticThreadGeometry(e,a,l,o,i,s,u?c:d);if(n)if(t){const e=new ST;e.setOperand(t);const i=n;e.setOperandA(i),t=e}else t=n}this.node.addOccurrenceGeometryToNode(o,i,s,c,d,t)}}getSubBodyStyleOverrides(e,t,i){const s=t.getOccurrenceId(),n=this.viewer.getIsolatedOccurrenceManager()?.isOccurrenceTranslucent(t);if(this.hasOccurrenceAlphaModifier(s)||n){const t=this.subBodyStyleOverrides.getNested(e,rm.OPAQUE),i=this.subBodyStyleOverrides.getNested(e,rm.TRANSPARENT);let r=null;if(t&&i){const e=new ST;e.setOperandA(t),e.setOperand(i),r=e}else t?r=t:i&&(r=i);if(r){const e=n?Im.material.isolateTranslucentAlpha:this.getOccurrenceAlphaModifier(s),t=new hT(aT(e));return t.setOperand(r),t}return null}return this.subBodyStyleOverrides.getNested(e,i)}getOccurrenceAlphaModifier(e){return this.occurrenceAlphaModifiers.has(e)?this.occurrenceAlphaModifiers.get(e):this.generativePartInstanceOccurrences.has(e)?os.M81:void 0}hasOccurrenceAlphaModifier(e){return this.occurrenceAlphaModifiers.has(e)||this.generativePartInstanceOccurrences.has(e)}getPartStudioBodyOccurrenceName(e){return _m.PART_STUDIO_BODY_OCCURRENCE_PREFIX+"."+this.getMeshOwnerId()+"."+e}removeBodyOccurrence(e,t,i){e=this.getCorrectedBodyOccurrenceId(t,e);const s=_m.getPotentialMeshGroupIdsForBody(t);for(let t=0;t<s.length;++t)this.node.removeMeshGroupFromOccurrence(s[t],e);if(this.decalComponent.removeOccurrence(e,t),this.cosmeticThreadsEnabled&&this.cosmeticThreadComponent.removeOccurrence(e),!i){if(e===this.partStudioBodyIdToOccurrenceId[t]){let i=!1;const s=this.baseComponent||this.previewClone;s&&(i=s.partStudioBodyIdToOccurrenceId.hasOwnProperty(t)),i||(this.viewer.getOccurrenceDataManager().destroyOccurrenceData(e),this.viewer.getOccurrenceIdManager().removeName(this.getPartStudioBodyOccurrenceName(t))),delete this.partStudioBodyIdToOccurrenceId[t]}this.bodyToOccurrenceId.removeNested(t,e),this.unavailableBodyOccurrences.removeNested(t,e),this.damageInstantiatedTriangleCount(),this.contributesToBodyManager()&&this.getBodyManager().removeOccurrence(e,t)}}refreshAllBodyOccurrences(){this.bodyToOccurrenceId.eachNested(((e,t,i)=>(this.refreshBodyOccurrence(+i,t),!1)),this)}refreshBodyOccurrence(e,t){this.removeBodyOccurrence(e,t,!0),this.addBodyOccurrence(e,t,!0)}refreshBodyOccurrenceForBodyId(e){this.refreshBodyOccurrence(this.partStudioBodyIdToOccurrenceId[e],e)}refreshBodyOccurrences(e,t){if(t){const t=this.partStudioBodyIdToOccurrenceId[e];t&&this.refreshBodyOccurrence(t,e)}else{const t=this.bodyToOccurrenceId.get(e);t&&t.each(((t,i)=>(this.refreshBodyOccurrence(+i,e),!1)),this)}}refreshOccurrence(e){const t=this.occurrences[e];t&&t.displayedPartIds.forEach((t=>{this.refreshBodyOccurrence(e,t)}))}updateBodiesWithChangedMeshReferences(){for(const e of this.bodiesWithUpdatedMeshReferences)this.damageComputedBodyTransparency(e),this.refreshBodyOccurrences(e);this.bodiesWithUpdatedMeshReferences.clear()}getInstantiableConstituentIds(e){if(e.isGroupableCompositeBody)throw new Error("Cannot instantiate constituents of grouped composites");if(e.isClosedComposite)return e.constituentBodyIds;const t=new Set;for(let i=0;i<e.constituentBodyIds.length;++i){const s=e.constituentBodyIds[i],n=this.bodyMetaData[s];n&&n.isClosedCompositeConstituent&&n.consumingClosedCompositeData.isGroupableCompositeBody?t.add(n.consumingClosedCompositeData.id):t.add(s)}return Array.from(t)}addOrUpdateOccurrence(e,t){if(!t)return;const i=new Set;for(let e=0;e<t.partIds.length;++e){const s=t.partIds[e],n=this.bodyMetaData[s];if(n&&n.isNonGroupingCompositeBody){const e=this.getInstantiableConstituentIds(n);for(let t=0;t<e.length;++t){const s=e[t];this.knownBodyIds.has(s)&&i.add(s)}}else this.knownBodyIds.has(s)&&i.add(s)}t.displayedPartIds=i;const s=this.occurrences[e]?this.occurrences[e].displayedPartIds:new Set,n=(0,Xs.R)(i,s),r=(0,Xs.R)(s,i);if((n.size>0||this.occurrences[e])&&super.addOrUpdateOccurrence(e,t),this.updateOccurrenceParts(e,t,n,r),i.size>0&&this.contributesToBodyManager()){const t=this.getBodyManager();i.forEach((s=>{const n=this.bodyMetaData[s],r=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(e);n&&t.addOrUpdateOccurrence(e,r,n,i.size)}))}}addPartStudioOccurrences(){for(const e in this.bodyMetaData)this.addPartStudioOccurrenceForBodyId(e);this.updateFlattenedBodyLayout()}addPartStudioOccurrenceForBodyId(e){const t=this.getBodyManager(),i=this.bodyMetaData[e];let s=this.partStudioBodyIdToOccurrenceId[e];if(i.isForFlattenedView()!==this.viewer.getIsForFlattenedDisplay()||i.isNonGroupingCompositeBody||i.canBeGroupedWithOtherConstituents)s&&(this.removeBodyOccurrence(s,e),delete this.partStudioBodyIdToOccurrenceId[e]);else{if(!s){s=this.viewer.getOccurrenceIdManager().getOrCreateIdForName(this.getPartStudioBodyOccurrenceName(e));const n=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(s);if(n.setIsolated(!!this.viewer.getIsolatedOccurrenceManager()?.getIsNewOccurrenceDataIsolated(n,e)),this.partStudioBodyIdToOccurrenceId[e]=s,this.addBodyOccurrence(s,e),this.contributesToBodyManager()){const e=1;t.addOrUpdateOccurrence(s,n,i,e)}this.hideShowBody(e,i.partStudioVisibility,TE.KF)}super.addOrUpdateOccurrence(this.partStudioBodyIdToOccurrenceId[e],null)}}updateOccurrenceParts(e,t,i,s,n){s.forEach((t=>{this.removeBodyOccurrence(e,t),this.damageInstantiatedTriangleCount()})),i.forEach((t=>{this.addBodyOccurrence(e,t,!1,n),this.damageInstantiatedTriangleCount()})),t.displayedPartIds.forEach((i=>{this.hideShowBody(i,t.isHidden?Xs.EE.HIDDEN:Xs.EE.VISIBLE,e)}))}reloadOccurrences(){const e=new Set;let t;for(t in this.occurrences){if(t=+t,TE.KF===t){im.warn("The part studio occurrence should not be reloaded");continue}const i=this.occurrences[t];if(i){const s=!0;this.updateOccurrenceParts(t,i,i.displayedPartIds,e,s)}}}removeOccurrence(e,t){const i=this.occurrences[e];if(i||e===TE.KF){if(i)i.displayedPartIds.forEach((t=>this.removeBodyOccurrence(e,t)));else for(const e in this.partStudioBodyIdToOccurrenceId)this.removeBodyOccurrence(this.partStudioBodyIdToOccurrenceId[e],e);super.removeOccurrence(e,t)}}changeEntityOwner(e,t){const i=this.idToMetaData[e];if(!i)return void(vm||(im.error("Metadata for entity "+e+" owner "+t+" that is trying to switch between bodies was not found"),vm=!0));if(!i.isFromBody())return void im.error("Trying to switch entity to a part that did not belong to a part in the first place");if(i.getBodyId()===t)return;this.removeMeshIncrement(e),this.removeIdMappings(e);const s=this.bodyMetaData[t];if(!s)return void im.error("Failed to find body metadata for body: "+t);const n=i.cloneForNewBody(s);n.getMeshIncrement()?(this.addIdMappings(e,n,t),this.updateEntityGraphics(e,n.getMeshIncrement(),n)):im.error("Failed to find mesh increment for a body entity")}getBodyIdsWithConstituentsInScenegraph(e){const t=new Set(e);for(const i of e){const e=this.bodyMetaData[i];if(e&&e.isNonGroupingCompositeBody&&e.constituentBodyIds)for(const i of e.constituentBodyIds)t.add(i)}return t}getTranslucentEdgeColor(e){const t=this.viewer.getResources().translucentModeEdgeColorBodyColorFactor,i=[];return i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i[3]=1,i}setIsBodyClippedBySectionPlane(e,t,i,s){if(i){const i=this.getBodyOccurrenceData(e,this.partStudioBodyIdToOccurrenceId[e]);return void(i&&i.setIsClippedBySectionPlanes(t))}const n=this.getBodyIdsWithConstituentsInScenegraph(new Set([e])),r=s?this.getBodyIdsWithConstituentsInScenegraph(s):null;for(const e of n)r&&r.has(e)||this.setIsBodyClippedBySectionPlane(e,t,!0)}setAreOccurrencesClippedBySectionPlaneExcept(e,t){for(const t in this.bodyMetaData)this.setIsBodyClippedBySectionPlane(t,e);for(const i of t)this.setIsBodyClippedBySectionPlane(i,!e)}updateBodyMetaData(e,t,i,s,n,r,a){let o,h=this.bodyMetaData[t],c=!1,l=!1,d=null;h?o=h.consumingClosedCompositeData?h.consumingClosedCompositeData.id:"":(h=new xh.XH(t),this.bodyMetaData[t]=h);let u=!1;if(void 0!==o){u=o!==(r?r.id:"")}const g=h.type,p=h.meshState,m=h.isGroupableCompositeBody;if(h.setColorCycle(this.parent.getPartColorCycle()),i){h.name=i.name,h.meshState=i.meshState;let e=k.wG2.SOLID;i.isSheet?e=k.wG2.SHEET:i.isWire&&(e=k.wG2.WIRE),h.type=e,h.isModifiable!==i.isModifiable&&this.bodyVisibility.removeNested(this.partStudioBodyIdToOccurrenceId[t],t),h.isModifiable=i.isModifiable,h.setAppearanceFromDisplayData(i),h.isActiveSheetMetal=i.isActiveSheetMetal;const s=i.customProperties.properties[k.efh.TESSELLATION_SETTING_PROPERTY_ID];s&&(h.tessellationSettingOverride=+s),h.consumingClosedCompositeData&&(u=!0),h.consumingClosedCompositeData=null,d=new wi.kB(i.lowBoxCorner.getVec3(),i.highBoxCorner.getVec3())}else h.setAppearanceFromDisplayData(n),h.consumingClosedCompositeData=r,s&&(h.type=s.closedConstituentPartData.bodyType,h.isActiveSheetMetal=s.closedConstituentPartData.isActiveSheetMetal,h.meshState=s.closedConstituentPartData.meshState,d=new wi.kB(s.lowBoxCorner.getVec3(),s.highBoxCorner.getVec3()));if(s){const i=h.getFinestTessellationSettingInMemory();h.sheetMetalModelId=s.sheetMetalModelId,h.isFlattenedSheetMetalBody=s.isFlattenedSheetMetalBody,h.isBendCenterLineBody=s.isBendCenterLineBody,h.ownerFlattenedBodyId=s.ownerFlattenedBodyId,h.tessellationSettings=e.getPartTessellationSettings(t),h.sheetMetalOrderId=s.sheetMetalOrderId,s.hasTessellationComplexityInformation&&(h.coarseTriangleCount=s.coarseTriangleCount,h.coarsePlanarFaceTriangleCount=s.coarsePlanarFaceTriangleCount),h.isAssociatedWithFlat=s.isAssociatedWithFlat,h.totalEntityCount=s.totalEntityCount,h.bestAvailableTessellationSetting=s.bestAvailableTessellationSetting,null!==i&&h.getFinestTessellationSettingInMemory()!==i&&(l=!0),h.isComposite=s.isComposite,h.isClosedComposite=s.isClosedComposite,h.updateConstituentBodyIds(s.constituentBodyDeterministicIds,this.bodyMetaData)}if(h&&h.isComposite&&!this.viewer.areOptimizedBuffersEnabled&&h.updateDataDerivedFromConstituents(this.bodyMetaData,e.deterministicPartIdToData),d&&!d.equals(h.bounds)&&(h.bounds=d,h.resetMeshIncrement(),c=!0),h&&h.isClosedComposite){i||im.warn("Expected to have display data for parent composite, but none was present");const t=null;for(let s=0;s<h.constituentBodyIds.length;++s){const n=h.constituentBodyIds[s],r=e.deterministicPartIdToData[n];this.updateBodyMetaData(e,n,t,r,i,h,m)}}if(u=u||"boolean"==typeof a&&a!==h.canBeGroupedWithOtherConstituents,u){this.baseComponent&&this.bodiesHiddenInBase.add(h.meshGroupId);const e=this.bodyToEntity.get(t);e&&(e.each(((e,t)=>{this.refreshEntityGraphics(t,h)})),h.setIsTessellationLoaded(h.canEntitiesBeLoaded()))}(g!==h.type||l||p!==h.meshState)&&this.refreshBodyOccurrences(t),this.updateBodyColor(t),c&&this.updateBodyManagerReferencesForBody(t);const f=this.unavailableBodyOccurrences.get(t);f&&(f.each(((e,i)=>(this.addBodyOccurrence(+i,t),!1))),this.unavailableBodyOccurrences.remove(t))}getBodyColorByBodyId(e){const t=this.bodyMetaData[e];return this.getBodyColor(t)}getBodyColor(e){return e?e.getColor():(0,Xs.zF)(Qa.y[0])}getBodyColorByBodyIdOccurrence(e,t){const i=this.bodyMetaData[e];return this.getBodyColorByBodyOccurrence(i,t)}getBodyColorByBodyOccurrence(e,t){const i=this.getBodyColor(e);return t&&this.hasOccurrenceAlphaModifier(t.getOccurrenceId())&&(i[3]*=this.getOccurrenceAlphaModifier(t.getOccurrenceId())),i}getFaceColor(e,t){const i=this.idToMetaData[e];if(!i)return null;const s=this.entityStyles[e];if(s){let e=s.getAttribute(RS.COLOR);return this.hasOccurrenceAlphaModifier(t)&&(e=e.slice(),e[3]*=this.getOccurrenceAlphaModifier(t)),e}const n=this.viewer.getOccurrenceDataManager().getOccurrenceData(t);return this.getBodyColorByBodyIdOccurrence(i.getBodyId(),n)}setBodyOpacity(e,t,i){const s=this.bodyMetaData[e];s&&(s.appearance||(s.appearance=new k.QHW),s.appearance.color&&(s.appearance.opacity=t,this.updateBodyColor(e,i)))}setBodyColor(e,t,i){const s=this.bodyMetaData[e];if(s&&(s.appearance||(s.appearance=new k.QHW),s.appearance.color&&(s.appearance.color=t,this.updateBodyColor(e,i)),s.isComposite&&s.constituentBodyIds)){let e;e=gt.T.isElementAtVersionOrLater(k.vgi.V2422_ADJACENCY_CHECK_COPY_FACE)&&s.isOpenCompositeBody?this.replaceConsumedBodyIdsWithConsumingCompositeId(s.constituentBodyIds):s.constituentBodyIds;for(const s of e)this.setBodyColor(s,t,i)}}replaceConsumedBodyIdsWithConsumingCompositeId(e){const t=new Set;for(const i of e)t.add(this.bodyMetaData[i]?.consumingClosedCompositeData?.id??i);return[...t]}updateBodyColor(e,t){const i=this.getBodyColorByBodyId(e);(0,pi.arraysEqual)(this.lastSetBodyColor[e],i)||(this.lastSetBodyColor[e]=i,this.damageComputedBodyTransparency(e),this.refreshBodyOccurrences(e,t))}getOccurrenceColor(e){const t=this.viewer.getOccurrenceIdManager().getIdForName(e.toString());if(t===TE.Qy)return null;const i=this.occurrences[t];if(!i)return null;const s=this.viewer.getOccurrenceDataManager().getOccurrenceData(t);for(const e of i.displayedPartIds){const t=this.getBodyColorByBodyIdOccurrence(e,s);if(t)return t.slice(0)}return null}setOccurrenceAlphaModifier(e,t){if(t<0||t>=1)return void im.warn("Only alpha modifiers in the range [0, 1) are accepted");const i=this.viewer.getOccurrenceIdManager().getIdForName(e.toString());i!==TE.Qy&&(this.occurrenceAlphaModifiers.set(i,t),this.refreshOccurrence(i))}clearOccurrenceAlphaModifier(e){const t=this.viewer.getOccurrenceIdManager().getIdForName(e.toString());t!==TE.Qy&&this.occurrenceAlphaModifiers.delete(t)&&this.refreshOccurrence(t)}getEntityColor(e){const t=this.entityStyles[e];if(t){const e=t.getAttribute(RS.COLOR);if(e)return e.slice()}const i=this.idToMetaData[e];return i?this.getBodyColorByBodyId(i.getBodyId()):null}getOccurrenceBounds(e){const t=new wi.kB,i=this.occurrences[e];return i&&i.displayedPartIds.forEach((i=>{t.addBox(this.getBodyManager().getOccurrenceBounds(e,i))})),t}getEntityBodyGroupId(e){const t=e.getBodyId(),i=this.bodyMetaData[t];return i?i.meshGroupId:t}setScalarVisualizationOccurrence(e,t){this.scalarVisualizationOccurrences.add(e),t?this.refreshBodyOccurrence(e,t):this.refreshOccurrence(e)}clearScalarVisualizationOccurrence(e,t){this.scalarVisualizationOccurrences.delete(e),t&&e?this.refreshBodyOccurrence(e,t):e&&this.refreshOccurrence(e)}clearAllScalarVisualizationOccurrences(){this.scalarVisualizationOccurrences=new Set,this.refreshAllBodyOccurrences()}isVisualizingOccurrences(){return this.scalarVisualizationOccurrences.size>0}setGenerativeDesignVisualizationOccurrence(e){this.generativePartInstanceOccurrences.add(e),this.refreshOccurrence(e)}clearGenerativeDesignOccurrence(e){this.generativePartInstanceOccurrences.delete(e),this.refreshOccurrence(e)}clearAllGenerativeDesignOccurrences(){const e=this.generativePartInstanceOccurrences;this.generativePartInstanceOccurrences=new Set;for(const t of e)this.refreshOccurrence(t)}updateEntityHighlight(e,t,i,s){const n=this.idToMetaData[i];if(!n)return!1;const r=this.getEntityBodyGroupId(n);if((s=this.getCorrectedBodyOccurrenceId(r,s))===TE.Qy||!s)return!1;const a=this.bodyMetaData[n.getBodyId()];if(a&&a.isForFlattenedView()){if(!(a.sheetMetalModelId===this.viewer.getModelViewManagers().getManager().getSelectedSheetmetalModelId())&&!this.isOccurrenceIdForAssembly(s))return!1}return Yg.prototype.updateEntityHighlight.call(this,e,t,i,s)}getBodyOccurrenceData(e,t){return(t=this.getCorrectedBodyOccurrenceId(e,t))!==TE.Qy&&t&&this.bodyToOccurrenceId.hasNested(e,t)?this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(t):null}hideShowBody(e,t,i){let s=!1;const n=this.bodyMetaData[e];if(n&&n.isClosedComposite&&!n.isGroupableCompositeBody)for(let e=0;e<n.constituentBodyIds.length;++e)s=this.hideShowBody(n.constituentBodyIds[e],t,i)||s;!i&&n&&(n.partStudioVisibility=t);const r=this.getBodyOccurrenceData(e,i);return r&&r.getVisibility()!==t&&(r.setVisibility(t),this.viewer.requestDraw(),s=!0),s&&(0,tm.PT)()?.getInferenceSetController()?.updateInferencingOnPartVisibilityChange(e,t),s}setBodyCullingState(e,t,i,s){const n=this.getBodyOccurrenceData(i,e);if(n&&n.getMeshGroupCullingState(i)!==t){const r=_m.getPotentialMeshGroupIdsForBody(i);for(let e=0;e<r.length;++e)n.setCullingState(t,r[e]);t!==Xs.uc.CULLED&&s?this.decalComponent.addOrUpdateOccurrence(i,e):this.decalComponent.removeOccurrence(e,i),this.viewer.requestDraw()}}isEntityHidden(e,t){const i=this.getBodyOccurrenceData(this.getEntityBodyGroupId(e),t);return!!i&&i.getVisibility()===Xs.EE.HIDDEN}getBodyDisplay(e){const t=this.bodyMetaData[e];return t?t.meshIncrement?t.meshIncrement:t.isSolidBody()||t.isSheetBody()?(t.meshIncrement=(0,Yd.dO)(t.getBounds().getMin(),t.getBounds().getMax()),t.meshIncrement.id=e,t.meshIncrement.groupId=e,t.meshIncrement.lod=wS.LOWEST,t.meshIncrement.pickId=this.getEntityIdManager().getOrCreateIdForName(e),t.meshIncrement):null:null}getOccurrenceIdForEntity(e){let t;if(this.idToMetaData[e]&&this.idToMetaData[e]instanceof k.Wzw){const i=this.idToMetaData[e];i.bodyMetaData&&(t=this.partStudioBodyIdToOccurrenceId[i.bodyMetaData.id])}return t}addBodyMetaDataStatistics(e,t,i,s){if(i&&i.tessellationSettings&&(i.isClosedComposite?(e.uniqueClosedComposites++,e.closedCompositeOccurrences+=s):i.isOpenCompositeBody?(e.uniqueOpenComposites++,e.openCompositeOccurrences+=s):i.isSolidBody()?(e.uniqueParts++,e.partOccurrences+=s):i.isSheetBody()?(e.uniqueSurfaces++,e.surfaceOccurrences+=s):i.isWireBody()&&(e.uniqueCurves++,e.curveOccurrences+=s),i.isClosedCompositeConstituent?e.closedCompositeConstituentOccurrences+=s:i.hasReferencingOpenCompositeBody&&(e.openCompositeConstituentOccurrences+=s),!i.isClosedCompositeConstituent))for(let t=0;t<i.tessellationSettings.length;++t){const n=i.tessellationSettings[t],r=e.settingCounts[n]||0;e.settingCounts[n]=r+s}}addStatistics(e,t,i=!1,s=!0){const n=k.ls1.getTessellationSettingIndexFromEnum(k.XiJ.VERY_FINE),r=this.getMeshManager(),a=this.getMeshOwnerId();for(const o in this.bodyMetaData){const h=this.bodyMetaData[o],c=this.bodyToOccurrenceId.get(o);let l=1;if(s){const e=this.bodyToOccurrenceId.get(o);l=e?.size()||0}if(this.addBodyMetaDataStatistics(e,o,h,l),i&&!h.isClosedCompositeConstituent&&h.tessellationSettings.includes(n)){const t=new Map;c&&c.each((function(i,s){const n=this.occurrences[s];return n?e.veryFineOccurrences.push(n.occurrenceData.occurrence):h&&(t.has(o)||t.set(o,h)),!1}),this),e.veryFineParts.push(t)}if(t){const t=this.bodyToEntity.get(o);t&&t.each(((t,i)=>{const s=this.idToMetaData[i];if(s)return s.isFace()?(e.faces+=l,e.triangles+=s.getMeshIncrement().getTriangleCount()*l):s.isLine()?(e.edges+=l,e.lines+=s.getMeshIncrement().getLineCount()*l):s.isVertex()&&(e.vertices+=l),!1}));const i=r.getGroupRangesForGroupTypeAndLod(o,a,Ai.MX.SILHOUETTES,wS.DEFAULT);i&&(e.silhouettes+=i.getPrimitiveCount()*l)}}}getPartStudioBodyOccurrenceIds(){const e=[];for(const t in this.partStudioBodyIdToOccurrenceId)e.push(this.partStudioBodyIdToOccurrenceId[t]);return e}showPartsWithSheetmetalModelIdOnly(e){for(const t in this.partStudioBodyIdToOccurrenceId)if(t in this.bodyMetaData){this.bodyMetaData[t].sheetMetalModelId===e?this.hideShowBody(t,Xs.EE.VISIBLE,TE.KF):this.hideShowBody(t,Xs.EE.HIDDEN,TE.KF)}}needsDisplayData(e){let t=!1;for(let i=0;i<e.partDisplayData.length;i++){const s=e.partDisplayData[i];t=t||s.id in this.bodyMetaData&&this.bodyMetaData[s.id].isForFlattenedView()}return t}isBodyActiveInView(e,t){const i=this.bodyMetaData[e];if(i&&i.isComposite&&!t)return!0;const s=this.getCorrectedBodyOccurrenceId(e,this.viewer.getIdForOccurrence(t)),n=this.occurrences[s];return n?n.containsPart(e)||n.displayedPartIds.has(e):!!this.bodyToOccurrenceId.hasNested(e,s)&&(!this.viewer.getIsForFlattenedDisplay()||this.isBodyVisible(s,e))}getTransformFromSheetMetalBodyMetaData(e){const t=e.sheetMetalOrderId.split(" "),i=e.sheetMetalOrder;if(0===i||i>t.length)return ue.create();const s=t.slice(0,i).join(" ");return this.sheetMetalOrderIdToTransform[s]}isEntityMeasurable(e,t){const i=this.getEntityMetaData(e);return!!i&&this.isBodyActiveInView(this.getEntityBodyGroupId(i),t)}updateFlattenedBodyLayout(){if(!this.viewer.getIsForFlattenedDisplay())return;if((0,Xs.hW)(this.partStudioBodyIdToOccurrenceId))return;this.sheetMetalOrderIdToTransform={};const e=10*Math.max.apply(Math,Object.values(this.bodyMetaData||{}).map((function(e){return e.bounds.max[2]-e.bounds.min[2]}))),t={},i=Object.keys(this.bodyMetaData||{}),s=this;i.sort((function(e,t){const i=s.bodyMetaData[e],n=s.bodyMetaData[t];return!i.isSubsidiaryBody()&&n.isSubsidiaryBody()?-1:i.isSubsidiaryBody()&&!n.isSubsidiaryBody()?1:i.sheetMetalOrderId<n.sheetMetalOrderId?-1:i.sheetMetalOrderId>n.sheetMetalOrderId?1:0}));const n={};let r="";for(let s=0;s<i.length;s++){const a=i[s],o=this.bodyMetaData[a];let h=t[o.sheetMetalModelId];h||(h=new wi.kB,t[o.sheetMetalModelId]=h);const c=o.sheetMetalOrderId.split(" ");let l=c[0],d=1;for(;d<c.length&&!(r<l);d++)l+=" "+c[d];o.sheetMetalOrder=d,r=l;const u=o.bounds;let g,p;h.isInitialized()?(g=h.max[0]+e-u.min[0],p=h.max[1]-u.max[1]):(g=0,p=0);const m=-u.max[2],f=this.partStudioBodyIdToOccurrenceId[a];f||im.warn("No occurrence for flattened body "+a);let I=ue.create();if(ge.w$.translate(I,[g,p,m]),o.isSubsidiaryBody()){const e=n[o.getOwnerBodyId()];e&&(I=e)}this.viewer.getOccurrenceDataManager().setOccurrenceTransform(f,I),this.updateBodyManagerReferencesForBody(a),h.addBox(u,I),n[a]=I,this.sheetMetalOrderIdToTransform[l]=I}}hasBody(e){return this.bodyMetaData.hasOwnProperty(e)}hasBodyOccurrence(e,t){const i=this.getCorrectedBodyOccurrenceId(e,this.viewer.getIdForOccurrence(t));return this.bodyToOccurrenceId.hasNested(e,i)}contributesToBodyManager(){return this.isForBase()}updateBodyManagerReferencesForBody(e){const t=this.bodyMetaData[e];if(!t||!this.contributesToBodyManager())return;const i=this.getBodyManager(),s=this.bodyToOccurrenceId.get(e);s&&s.each(((s,n)=>{n=+n;let r=1;const a=this.occurrences[n];return a&&(r=a.displayedPartIds.size),i.addOrUpdateOccurrence(n,this.getBodyOccurrenceData(e,n),t,r),!1}),this)}setDebugFaceTriangles(e){if(wm=e,wm)for(const e in this.idToMetaData){const t=this.idToMetaData[e],i=t.getMeshIncrement();i&&this.addMeshTriangleEdges(i,t)}this.refreshAllBodyOccurrences()}integrityCheck(){const e=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio()===this.parent;for(const t in this.bodyMetaData){if(null!==this.bodyMetaData[t].getFinestTessellationSettingInMemory()){const e=this.bodyToEntity.get(t);e&&!e.isEmpty()||im.info("Body "+t+" is missing entity data in "+this.parent.getFullElementId())}else e&&im.info("Body "+t+" has no tessellation available, but it is in the active part studio: "+this.parent.getFullElementId())}}collectComponentsForHeapDump(e){for(const t in this.idToMetaData){const i=this.idToMetaData[t],s=i.getMeshIncrement();e.meshIncrements.push(s),e.entityData.push(i),i.isFace()&&!i.isPlanarFace()&&e.silhouetteIncrements.push(gE(s));const n=this.getMeshIncrementDetails(t);n?e.incrementDetails.push(n):console.warn("Did not find increment details for "+t)}this.reset()}getSmoothEdgeCountForCompositeBody(e){return e.constituentBodyIds.reduce(((e,t)=>e+(this.bodyIdToSmoothEdges.get(t)?.size??0)),0)}updateBodiesWithChangedSmoothEdgesCount(){const e=new Set;for(const[t,i]of this.bodyIdToSmoothEdges){const s=this.bodyMetaData[t];s?.consumingClosedCompositeData?.isGroupableCompositeBody?e.add(s.consumingClosedCompositeData):this.updateBodyIfSmoothEdgeCountChanged(s,i.size)}for(const t of e)this.updateBodyIfSmoothEdgeCountChanged(t)}syncPartSmoothEdgeCount(e,t){return e.isGroupableCompositeBody?this.syncGroupableBodySmoothEdgesCount(e):this.syncBodySmoothEdgesCount(e.getId(),t)}syncBodySmoothEdgesCount(e,t){if(!t&&0!==t){const i=this.bodyIdToSmoothEdges.get(e);if(!i)return[0,0];t=i.size}const i=this.previousBodyIdToSmoothEdgesCount.get(e)??0;return this.previousBodyIdToSmoothEdgesCount.set(e,t),[i,t]}syncGroupableBodySmoothEdgesCount(e){let t=0,i=0;for(const s of e.constituentBodyIds){const[e,n]=this.syncBodySmoothEdgesCount(s);i+=n,t+=e}return[t,i]}updateBodyIfSmoothEdgeCountChanged(e,t){const i=e.getId();let s;[s,t]=this.syncPartSmoothEdgeCount(e,t);const n=t>0;if(s>0!==n){const t=this.bodyToOccurrenceId.get(i);if(!t)return;const s=e=>this.node.removeMeshGroupFromOccurrence(i+_m.SMOOTH_EDGE_GROUP_SUFFIX,e);if(n)for(const n of t.getKeys()){if(!n)continue;const t=this.getBodyOccurrenceData(i,+n),r=this.getEdgeStyleByBodyOccurrence(e,t);this.node.removeMeshGroupFromOccurrence(i+_m.SMOOTH_EDGE_GROUP_SUFFIX,+n),s(+n),this.addSmoothEdgesBodyOccurrenceFromMeshManager(this.getMeshManager(),t,i,e,r),this.getSharedBaseMeshManager()&&!this.bodiesHiddenInBase.has(i)&&this.addSmoothEdgesBodyOccurrenceFromMeshManager(this.getSharedBaseMeshManager(),t,i,e,r)}else for(const e of t.getKeys())s(+e)}}setTranslucentModeFaceOpacity(e){this.cosmeticThreadsEnabled&&this.cosmeticThreadComponent.setTranslucentModeFaceOpacity(e)}}_m.PART_STUDIO_BODY_OCCURRENCE_PREFIX="body",_m.MESH_EDGE_GROUP_SUFFIX="_meshEdges",_m.SMOOTH_EDGE_GROUP_SUFFIX="_smoothEdges";class Nm extends Yg{constructor(e,t){super(e,t)}getComponentId(){return"error_component."}handlesEntity(e,t){return e.hasTessellationError()&&!this.viewer.getIsForFlattenedDisplay()}expectsTessellation(){return!1}removeBaseIncrement(e){}updateEntityGraphics(e,t,i){}getHideableFeatureIds(){return[]}addStatistics(e,t){const i=this.getEntityCount();i>0&&e.errors.push(`${t} has ${i} entities with failed tessellation.`)}}const bm=_e.O.createLogger("SketchComponent",k.bVy.GRAPHICS),Lm=X.default.getManager(),Fm=new Oi;let xm=0;Object.values(k.ea7).forEach((e=>{(0,ea.Z)(e)&&(xm=Math.max(e,xm))}));const Bm=Math.ceil(Math.log(xm)/Math.log(2)),Vm="sketch_component.";class Um extends Kg{constructor(e,t,i){super(e,i,t),this.activeSketches={},this.hasBeenInstantiated=!1,this.entityColors=new Map,this.sketchToSMModelIdMapping={},this.idToPartData={},this.sketchToSketchEntityMapping=new Gl.TemplatedNestedMap,this.styledRanges=new Gl.TemplatedNestedMap,this.node=e?e.getModelViewManager().getSharedSketchNode():null,this.sketchComponentElementId=this.viewer.getOccurrenceIdManager().getOrCreateIdForName("PART_STUDIO_SKETCHES")}getNode(){return this.node}isEntityInActiveSketch(e){return this.activeSketches.hasOwnProperty(e.getSketchFeatureId())}isSketchInContext(e){return e!==this.sketchComponentElementId&&this.viewer.getModelViewManagers().getManager().displayingPartStudio()}updateMissingEntityGraphicsForSketch(e,t){const i=this.sketchToSketchEntityMapping.get(e);for(const e in i){if(t.deterministicIdToEntity[e])continue;const s=i[e],n=this.idToMetaData[s];if(!n)continue;const r=n.getMeshIncrement();r&&(this.removeMeshIncrement(r.id),this.updateEntityGraphics(s,r,n))}}processAdditionsAndChanges(e,t){const i={};for(const t in e.deterministicPartIdToData){const s=e.deterministicPartIdToData[t];for(let t=0;t<s.entityDIds.length;++t){const n=s.entityDIds[t],r=e.deterministicIdToEntity[n];r&&!r.isDeletion()&&this.handlesEntity(r,s)&&(r.isAssociatedWithFlat=s.isAssociatedWithFlat,r.isAssociatedWithFlat&&(i[r.getFirstFeatureId()]=s.ownerFlattenedBodyId),this.idToPartData[n]=s)}}const s=Object.keys(e.sketchFeatureIdAndTessellationSettingToBuffers);this.processPrecompiledGraphicsBuffers(e.sketchFeatureIdAndTessellationSettingToBuffers);for(const t in this.sketchToSMModelIdMapping)i[t]||this.updateMissingEntityGraphicsForSketch(t,e);if(this.updateEntityAppearanceOverrides(e),super.processAdditionsAndChanges(e,t),t&&this.viewer.areOptimizedBuffersEnabled&&s.length>0){const e=this.sketchComponentElementId;for(const t of s)this.featureToIds.insertKeyOnly(t),this.addSketchFeatureToSceneGraph(t,this.getMeshManager(),e)}}getEntityColor(e){const t=this.entityColors.get(e);return t?t.color:null}getEntityOverrideId(e){const t=this.entityColors.get(e);return t?t.overrideId:""}getOverrideColor(e){return[e.color[0]/255,e.color[1]/255,e.color[2]/255,e.opacity/255]}updateEntityAppearanceOverrides(e){const t=new Set;for(const i in e.appearanceIdToAppearanceOverride){const s=e.appearanceIdToAppearanceOverride[i],n=i===k.QHW.RESET_APPEARANCE_ID?null:this.getOverrideColor(s.appearance);for(let r=0;r<s.entityDeterministicIds.length;++r){const a=s.entityDeterministicIds[r],o=e.deterministicIdToEntity[a]||this.idToMetaData[a];if(!o||!this.handlesEntity(o))continue;const h=o.getLastFeatureId();if(!t.has(h)){t.add(h);for(const e in this.occurrences)this.clearSketchGraphics(h,+e)}if(n){const e={overrideId:i,color:n};this.entityColors.set(a,e)}else this.entityColors.delete(a)}}for(const e of t)for(const t in this.occurrences)this.instantiateSketchGraphics(e,+t)}getColorForSketch(e){const t=this.featureToIds.get(e);let i=null;return t&&t.each(((e,t)=>(i=this.getEntityColor(t),!!i))),i}processDeletions(e){for(const t in e.deterministicIdToEntity){const i=e.deterministicIdToEntity[t];i&&this.handlesEntity(i)&&this.removeEntity(t)}super.processDeletions(e);for(const t in e.deterministicIdToEntity){const i=e.deterministicIdToEntity[t];i&&this.handlesEntity(i)||this.entityColors.delete(t)}}reset(){for(const e in this.idToMetaData)this.removeMeshIncrement(e);this.clearGraphics(),this.entityColors.clear(),this.sketchToSketchEntityMapping.clear(),this.sketchToSMModelIdMapping={},this.idToPartData={},super.reset()}clearGraphics(){for(const e in this.occurrences)this.node?.removeOccurrence(+e);this.styledRanges.eachNested((e=>(e.getMeshRanges().destroy(),!1))),this.styledRanges.clear()}addIdMappings(e,t,i,s){super.addIdMappings(e,t,i,s);const n=t.getSketchFeatureId();this.sketchToSketchEntityMapping.insertNested(n,t.getSketchEntityId(),e);const r=s&&s.incremental,a=this.idToPartData[e],o=!!a&&!a.isAssociatedWithFlat;r&&o&&Oa(n)}addStatistics(e){e.uniqueSketches+=this.sketchToSketchEntityMapping.size()}getSMModelIdForSketch(e){return this.sketchToSMModelIdMapping[e]}removeIdMappings(e){const t=this.idToMetaData[e];if(!t)return;const i=t.getSketchFeatureId();this.sketchToSketchEntityMapping.removeNested(i,t.getSketchEntityId()),delete this.idToPartData[e],delete this.sketchToSMModelIdMapping[i],super.removeIdMappings(e)}retrieveBodyMetaData(e){const t=this.bodyToEntity.get(e);if(t&&t.size()>0){const i=new xh.XH(e);let s="",n=!1,r=!1,a=!1;return t.each(((e,t)=>{const i=this.idToMetaData[t];i&&(i.isVertex()?n=!0:i.isEdge()?r=!0:i.isFace()&&(a=!0),s=i.getSketchFeatureId())})),a?i.type=k.wG2.SHEET:r?i.type=k.wG2.WIRE:n&&(i.type=k.wG2.POINT),i.isSketchBody=!0,i.sketchFeatureId=s,i}return null}getNodeProperties(e,t,i,s){let n=Lm.getNumber("DEFAULT_Z_OFFSET");e.isFace()?n=Lm.getNumber("SKETCH_FACES_Z_OFFSET"):e.isEdge()?n=Lm.getNumber("SKETCH_EDGES_Z_OFFSET"):e.isVertex()?n=Lm.getNumber("SKETCH_POINTS_Z_OFFSET"):e.isDegenerateEdge()&&(n=Lm.getNumber("DEGENERATE_Z_OFFSET"));let r=Gi.DO.DEFAULT;return e.isSketchConstructionEntity()&&e.isEdge()&&(Hs()?t=!1:this.isEntityInActiveSketch(e)||(r=Gi.DO.LOWER)),t&&this.isSketchInContext(i)&&(r=Gi.DO.LOWER),new Gi.hF({primitiveType:s,isTwoSided:e.isFace(),primitivesHaveTransparency:e.isFace(),material:Vi,isPickable:!(t&&e.isFace()),isShowThrough:t,isDepthTested:!t,isStencilTested:t,isHighlightable:!t||e.isSketchConstructionEntity(),zOffset:n,addsToBounds:!e.isVertex()||e.isSketchUserPoint(),priority:r,includedInBlend:!0,isTintedByCompare:!0})}getStyle(e,t,i,s){let n=null,r=null,a=null;if(e.isFace())n=i?Lm.getColor("SKETCH_FACE_SHOW_THROUGH_COLOR"):Lm.getColor("SKETCH_FACE_COLOR");else{if(t){const t=e.getSketchSolveStatus();n=e.isEdge()&&(e.isFromSketchSplineHandle()||e.isFromSketchSplineControlPolygon())?Lm.getColor("SPLINE_HANDLE_COLOR"):e.isPreviewEntity?Lm.getColor("SKETCH_PREVIEW_COLOR"):t&&t!==k.ea7.UNKNOWN?t===k.ea7.UNDER_DEFINED?i?Lm.getColor("UNDERCONSTRAINED_SHOW_THROUGH_LINE_POINT_COLOR"):Lm.getColor("UNDERCONSTRAINED_LINE_POINT_COLOR"):t===k.ea7.FIXED||t===k.ea7.WELL_DEFINED?i?Lm.getColor("CONSTRAINED_SHOW_THROUGH_LINE_POINT_COLOR"):Lm.getColor("CONSTRAINED_LINE_POINT_COLOR"):i?Lm.getColor("OVERCONSTRAINED_SHOW_THROUGH_LINE_POINT_COLOR"):Lm.getColor("OVERCONSTRAINED_LINE_POINT_COLOR"):i?Lm.getColor("SHOW_THROUGH_LINE_POINT_COLOR"):Lm.getColor("LINE_POINT_COLOR")}else n=Lm.getColor("INACTIVE_SKETCH_COLOR");e.isVertex()?(r=t?e.isFromSketchSplineHandle()||e.isFromSketchSplineControlPolygon()?Lm.getNumber("ACTIVE_SKETCH_SPLINE_HANDLE_SIZE"):e.isSketchUserPoint()?Lm.getNumber("ACTIVE_SKETCH_USER_POINT_SIZE"):Lm.getNumber("ACTIVE_SKETCH_POINT_SIZE"):e.isFromSketchSplineHandle()||e.isFromSketchSplineControlPolygon()?Lm.getNumber("INACTIVE_SKETCH_SPLINE_HANDLE_SIZE"):e.isSketchUserPoint()?Lm.getNumber("INACTIVE_SKETCH_USER_POINT_SIZE"):Lm.getNumber("INACTIVE_SKETCH_POINT_SIZE"),a=e.isFromSketchSplineHandle()||e.isFromSketchSplineControlPolygon()?Lm.getPointFont("SKETCH_SPLINE_HANDLE_POINT_FONT"):e.isSketchUserPoint()?Lm.getPointFont("SKETCH_USER_POINT_FONT"):Lm.getPointFont("SKETCH_POINT_FONT")):e.isEdge()?(r=t?i?Lm.getNumber("ACTIVE_SKETCH_SHOW_THROUGH_LINE_WIDTH"):e.isFromSketchSplineHandle()||e.isFromSketchSplineControlPolygon()?Lm.getNumber("SPLINE_HANDLE_LINE_WIDTH"):Lm.getNumber("ACTIVE_SKETCH_LINE_WIDTH"):i?Lm.getNumber("INACTIVE_SKETCH_SHOW_THROUGH_LINE_WIDTH"):e.isFromSketchSplineHandle()||e.isFromSketchSplineControlPolygon()?Lm.getNumber("INACTIVE_SKETCH_SPLINE_HANDLE_SIZE"):Lm.getNumber("INACTIVE_SKETCH_LINE_WIDTH"),a=!e.isSketchConstructionEntity()||e.isFromSketchSplineHandle()||e.isFromSketchSplineControlPolygon()?t?Lm.getStipple("DEFAULT_LINE_STIPPLE"):i?Lm.getStipple("DEFAULT_SHOW_THROUGH_LINE_STIPPLE"):Lm.getStipple("DEFAULT_LINE_STIPPLE"):Lm.getStipple("CONSTRUCTION_LINE_STIPPLE")):e.isDegenerateEdge()&&(r=t?Lm.getNumber("DEGENERATE_EDGE_ACTIVE_SIZE"):Lm.getNumber("DEGENERATE_EDGE_INACTIVE_SIZE"),a=t?Lm.getPointFont("SKETCH_DEGENERATE_EDGE_FONT"):Lm.getPointFont("SKETCH_POINT_FONT"))}if(e.isFace()&&Hs()&&e instanceof k.lo2&&(n=(0,Yd.KJ)(this.getEntityPlaneId(e))),!t){const e=this.getEntityColor(s);e&&(n=e)}const o=new mS.bg;return n&&o.setAttribute(RS.COLOR,n),null!==r&&o.setAttribute(RS.PRIMITIVE_SIZE,r),a&&o.setAttribute(RS.PRIMITIVE_STYLE,a),o}getEntityPlaneId(e){if(!e.isFace())return 0;const t=e.getMeshIncrement();if(!t)return 0;const i=t.points,s=t.normals;return(0,Yd.Tf)([i[0],i[1],i[2]],[s[0],s[1],s[2]])}handlesEntity(e,t){return!(t&&this.viewer.getIsForFlattenedDisplay()&&!t.isForFlattenedView())&&e.isFromSketch()&&(this.viewer.areOptimizedBuffersEnabled||!e.hasTessellationError())}getOwnerFlattenedBodyIdForSketch(e){const t=this.sketchToSketchEntityMapping.get(e);if(!t)return null;let i=null;return t.each(((e,t)=>{const s=this.idToPartData&&this.idToPartData[e];if(s)return s.isAssociatedWithFlat&&(i=s.ownerFlattenedBodyId),!0})),i}getOwnerFlattenedBodyId(e){const t=this.idToPartData[e];return t&&t.isAssociatedWithFlat?t.ownerFlattenedBodyId:null}getSheetMetalModelId(e){const t=this.getOwnerFlattenedBodyId(e);if(t){const e=this.parent.retrieveBodyMetaData(t);if(e)return e.sheetMetalModelId}return null}getTransformForSketchEntity(e){const t=this.getOwnerFlattenedBodyId(e),i=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio();if(t&&i){const e=i.retrieveBodyMetaData(t);if(e)return i.getBodyComponent().getTransformFromSheetMetalBodyMetaData(e)}return ue.create()}updateSMMapping(e,t){if(this.viewer.getIsForFlattenedDisplay()){const i=this.getOwnerFlattenedBodyId(e);if(this.parent&&i){const e=this.parent.retrieveBodyMetaData(i);e&&(this.sketchToSMModelIdMapping[t.getLastFeatureId()]=e.sheetMetalModelId)}}}updateEntityGraphics(e,t,i){if(!t)return;if(this.viewer.getIsForFlattenedDisplay()){const s=this.getOwnerFlattenedBodyId(e);if(this.parent&&s){const e=this.parent.retrieveBodyMetaData(s);if(e){this.sketchToSMModelIdMapping[i.getSketchFeatureId()]=e.sheetMetalModelId;const s=this.parent.getBodyComponent().getTransformFromSheetMetalBodyMetaData(e);s&&(t=t.createTransformed(s))}}}let s;for(s in this.addMeshIncrement(t),this.occurrences)s=+s,this.isEntityForDisplay(e,i,s)&&this.updateEntityOccurrenceGraphics(e,s,i)}getOccurrenceIdForEntity(e){return this.sketchComponentElementId}getHideableFeatureIds(){return this.featureToIds.getKeys()}copySketchDataToClone(e){e.sketchToSketchEntityMapping=this.sketchToSketchEntityMapping.cloneNested(),e.idToPartData=(0,j.shallowClone)(this.idToPartData),e.sketchToSMModelIdMapping=(0,j.shallowClone)(this.sketchToSMModelIdMapping),e.entityColors=new Map(this.entityColors)}clone(e){const t=new Um(e,this.usage,this.viewer);return this.copyToClone(t),this.copySketchDataToClone(t),t}cloneForPreview(e){const t=new Um(e,ys.L.PREVIEW,this.viewer);this.copyToPreview(t),this.copySketchDataToClone(t);for(const e in this.activeSketches)t.activeSketches[e]=this.activeSketches[e];t.hasBeenInstantiated=!0;for(const e in this.occurrences)t.addOrUpdateOccurrence(+e,this.occurrences[e]);return t}removeMeshIncrement(e){const t=this.getMeshManager().removeMeshIncrement(e,this.getMeshOwnerId());if(!t)return null;let i;for(i in this.occurrences){const s=this.occurrences[i];i=+i,(!s||s.containsPart(e)||s.displayedSketchEntityIds.has(e))&&this.removeEntityFromOccurrence(e,i,t)}return t}onAppearanceConstantsUpdated(){this.clearGraphics();for(const e of this.featureToIds.getKeys())for(const t of Object.keys(this.occurrences))this.instantiateSketchGraphics(e,+t)}removeEntityFromOccurrence(e,t,i){const s=this.idToMetaData[e];if(!s)return;if(!i&&!(i=this.getMeshManager().getIncrementDetails(e,this.getMeshOwnerId())))return;const n=this.isSketchDisplayedAsActive(s.getSketchFeatureId(),t);this.getRanges(e,s,t,n,!1).onIncrementRemoved(i);this.getRanges(e,s,t,n,!0).onIncrementRemoved(i)}accumulateSketchIdsFromBodyId(e,t){const i=this.bodyToEntity.get(e);if(i)for(const e of i.getKeys()){const i=this.idToMetaData[e];if(i&&i.getFeatureIds())for(const e of i.getFeatureIds())t.add(e)}}displaySketchAsActive(e,t){this.activeSketches.hasOwnProperty(e)!==t&&(this.clearSketchGraphics(e),t?this.activeSketches[e]=!0:delete this.activeSketches[e],this.instantiateSketchGraphics(e),t&&this.hideShowFeature(e,Xs.EE.VISIBLE))}isSketchDisplayedAsActive(e,t){return t===this.sketchComponentElementId&&this.activeSketches.hasOwnProperty(e)}hasActiveSketch(){return!(0,j.isEmptyObjectOrArray)(this.activeSketches)}resetPrimitiveAttributes(e,t){this.clearSketchGraphics(e,t),this.instantiateSketchGraphics(e,t)}clearSketchGraphics(e,t){const i=this.featureToIds.get(e);if(!i)return;if(t=t||this.sketchComponentElementId,!this.occurrences.hasOwnProperty(t))return;const s=i.getKeys();for(let e=0;e<s.length;e++)this.removeEntityFromOccurrence(s[e],t)}isEntityForDisplay(e,t,i){const s=this.idToPartData[e],n=!s||s.isAssociatedWithFlat,r=this.occurrences[i];return!r&&n===this.viewer.getIsForFlattenedDisplay()||!!r&&(r.containsPart(e)||r.sketchFeatureId===t.getSketchFeatureId())}instantiateSketchGraphics(e,t){const i=this.featureToIds.get(e);if(!i)return;if(t=t||this.sketchComponentElementId,!this.occurrences.hasOwnProperty(t))return;const s=i.getKeys();for(let e=0;e<s.length;e++){const i=s[e],n=this.idToMetaData[i];n&&(this.isEntityForDisplay(i,n,t)&&this.updateEntityOccurrenceGraphics(i,t,n))}}retrieveSketchEntityDeterministicId(e,t){const i=this.sketchToSketchEntityMapping.getNested(e,t);return i||null}isInstantiated(){return this.hasBeenInstantiated}instantiateForPartStudio(e){super.instantiateForPartStudio(e),this.addOrUpdateOccurrence(this.sketchComponentElementId,null)}removePartStudioInstantiation(e){this.usage===ys.L.PREVIEW&&super.removePartStudioInstantiation(e),this.removeOccurrence(this.sketchComponentElementId,!0)}addOrUpdateOccurrence(e,t){this.hasBeenInstantiated||(this.viewer.areOptimizedBuffersEnabled||this.instantiateEntities(),this.hasBeenInstantiated=!0);const i=this.addOrUpdateOccurrenceFromMeshManager(e,t,this.getMeshManager()),s=this.getSharedBaseMeshManager();s&&this.addOrUpdateOccurrenceFromMeshManager(e,t,s),t&&this.parent.imageComponent.updateDisplaysByOccurrence(e,t,this.getSketchFeatureIdsInstantiatedForOccurrence(t));const n=e===this.sketchComponentElementId;(i||n||this.occurrences.hasOwnProperty(e))&&super.addOrUpdateOccurrence(e,t)}getSketchFeatureIdsInstantiatedForOccurrence(e){const t=new Set;if(e.sketchFeatureId)t.add(e.sketchFeatureId);else for(let i=0;i<e.partIds.length;++i){const s=this.idToMetaData[e.partIds[i]];if(s&&s.getFeatureIds()){const e=s.getFeatureIds();for(let i=0;i<e.length;++i)t.add(e[i])}}return t}addOrUpdateOccurrenceFromMeshManager(e,t,i){if(t){let s=null;const n=t.sketchFeatureId;if(this.viewer.areOptimizedBuffersEnabled&&n.length>0&&this.featureToIds.get(n))return this.addSketchFeatureToSceneGraph(n,i,e),!0;if(n){const e=this.featureToIds.get(n);e&&(s=new Set(e.getKeys()))}else for(let e=0;e<t.partIds.length;++e){const i=t.partIds[e];if(this.idToMetaData.hasOwnProperty(i))s||(s=new Set),s.add(i);else{const e=this.parent.retrieveBodyMetaData(i);if(e&&e.isComposite&&e.constituentBodyIds)for(let t=0;t<e.constituentBodyIds.length;++t){const i=e.constituentBodyIds[t],n=this.bodyToEntity.get(i);n&&(s||(s=new Set),n.each(((e,t)=>{s?.add(t)})))}}}if(!s||0===s.size)return!1;const r=this.occurrences[e]?this.occurrences[e].displayedSketchEntityIds:new Set,a=(0,Xs.R)(s,r);return t.displayedSketchEntityIds=s,this.updateEntitiesOccurrences(e,t,a,s,i),!0}if(!this.occurrences.hasOwnProperty(e)){const s=new Set;Object.entries(this.idToMetaData).forEach((([t,i])=>{this.isEntityForDisplay(t,i,e)&&s.add(t)})),this.updateEntitiesOccurrences(e,t,s,s,i)}return!0}addSketchFeatureToSceneGraph(e,t,i){const s=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(i),n=[Ai.MX.LINES,Ai.MX.TRIANGLE_STRIP],r=[!1,!0];for(const t of n){const n={isPreviewEntity:!1,getSketchFeatureId:()=>e,isFace:()=>t===Ai.MX.TRIANGLE_STRIP,isEdge:()=>t===Ai.MX.LINES,isVertex:()=>t===Ai.MX.POINTS,getSketchSolveStatus:()=>k.ea7.UNKNOWN,isFromSketchSplineHandle:()=>!1,isFromSketchSplineControlPolygon:()=>!1,isSketchConstructionEntity:()=>!1,isSketchUserPoint:()=>!1,isDegenerateEdge:()=>!1};for(const a of r){const r=this.getNodeProperties(n,a,i,t),o=this.getStyle(n,!1,a,null),h=this.getMeshManager().getGroupRangesForGroupTypeAndLod(e,this.getMeshOwnerId(),t,wS.DEFAULT);h&&this.node.addOccurrenceGeometryToNode(r,s,o,h)}}}updateEntitiesOccurrences(e,t,i,s,n){if(i)for(const t of i){const i=this.idToMetaData[t];i?this.updateEntityOccurrenceGraphics(t,e,i,n):bm.warn("Could not find meta data for entity")}if(t){const i=t.isHidden?Xs.EE.HIDDEN:Xs.EE.VISIBLE;for(const t of s)this.hideShowEntity(t,i,e)}}getRanges(e,t,i,s,n){Fm.reset(),Fm.addBoolean(s),Fm.addBoolean(n),Fm.addBoolean(t.isPreviewEntity),Fm.addBoolean(t.isFace()),Fm.addBoolean(t.isEdge()),Fm.addBoolean(t.isVertex()),Fm.addBoolean(t.isDegenerateEdge()),Fm.addBoolean(t.isSketchConstructionEntity()),Fm.addBoolean(t.isSketchUserPoint()),Fm.addBoolean(t.isFromSketchSplineHandle()),Fm.addBoolean(t.isFromSketchSplineControlPolygon()),Fm.addNumber(t.getSketchSolveStatus(),Bm);let r=Fm.getId().toString();if(Hs()&&(r=Fm.getIdWithIdAppended(this.getEntityPlaneId(t)).toString()),!s){if(null!==this.getEntityColor(e)){r+=this.getEntityOverrideId(e)}}let a=this.styledRanges.getNested(i,r);if(!a){const o=this.getNodeProperties(t,n,i,HE(t)),h=this.getStyle(t,s,n,e),c=this.viewer.getOccurrenceDataManager().getOrCreateOccurrenceData(i),l=new qT("SketchComponent."+i+"."+r);this.usage===ys.L.PREVIEW&&l.setListenForDeletions(!0),a=this.node?.addOccurrenceGeometryToNode(o,c,h,l),this.styledRanges.insertNested(i,r,a)}return a.getMeshRanges()}updateEntityOccurrenceGraphics(e,t,i,s){const n=this.isSketchDisplayedAsActive(i.getSketchFeatureId(),t),r=(s=s||this.getMeshManager()).getIncrementDetails(e,this.getMeshOwnerId());if(!r)return;this.getRanges(e,i,t,n,!1).onIncrementAdded(r);this.getRanges(e,i,t,n,!0).onIncrementAdded(r),(this.isEntityHidden(i,t)||!n&&i&&(i.isFromSketchSplineHandle()||i.isFromSketchSplineControlPolygon()))&&this.hideMeshIncrement(e,t)}isEntityHidden(e,t){if(t===this.sketchComponentElementId)return super.isEntityHidden(e,t);{const e=this.occurrences[t];return!!e&&e.isHidden}}removeOccurrence(e,t){this.occurrences.hasOwnProperty(e)&&(this.styledRanges.remove(e),this.node?.removeOccurrence(e),super.removeOccurrence(e,t))}getEntitiesForOccurrenceSelection(e){const t=this.occurrences[e];if(t&&t.displayedSketchEntityIds){const e=[];for(const i of t.displayedSketchEntityIds){const t=this.idToMetaData[i];!t||t.isFromSketchSplineHandle()||t.isFromSketchSplineControlPolygon()||e.push(i)}return e}return null}updateEntityHighlight(e,t,i,s){let n=s;const r=this.idToMetaData[i];if(r&&s===TE.KF&&(n=this.sketchComponentElementId,!this.isSketchDisplayedAsActive(r.getSketchFeatureId(),n)&&(r.isFromSketchSplineHandle()||r.isFromSketchSplineControlPolygon())))return!1;if(this.viewer.getIsForFlattenedDisplay()){if(!r)return!1;const e=this.getSheetMetalModelId(i);if(!e||e!==this.viewer.getModelViewManagers().getManager().getSelectedSheetmetalModelId())return!1}return super.updateEntityHighlight(e,t,i,n)}hideShowFeature(e,t,i){const s=this.featureVisibility[e]!==t;this.featureVisibility[e]=t;const n=this.sketchToSMModelIdMapping[e],r=this.viewer.getModelViewManagers().getManager();if(r.hasSelectedSheetmetalModelId()){if(n!==r.selectedSheetmetalModelId)return;const i=this.getEntitiesForFeature(e);if(t===Xs.EE.VISIBLE&&i?.length>0&&this.getSheetMetalModelId(i[0])!==r.selectedSheetmetalModelId)return}s&&(0,tm.PT)()?.getInferenceSetController()?.updateInferencingOnFeatureVisibilityChange(e,t);if(!this.hideShowFeatureEntities(e,t)&&this.insertableIdToTypeToIncrement?.get(e)){const i=this.insertableIdToTypeToIncrement.get(e),s=i.get(qg.FACE),n=i.get(qg.EDGE),r=this.sketchComponentElementId;t===Xs.EE.HIDDEN?(s&&this.hideMeshIncrement(s.id,r),n&&this.hideMeshIncrement(n.id,r)):(s&&this.showMeshIncrement(s.id,r),n&&this.showMeshIncrement(n.id,r))}}hideShowFeatureEntity(e,t,i){const s=this.idToMetaData[e];let n=i;!t&&s&&(s.isFromSketchSplineHandle()||s.isFromSketchSplineControlPolygon())&&(n=Xs.EE.HIDDEN);const r=this.getOccurrenceIdForEntity(e),a=this.hideShowEntity(e,n,r);return a&&this.viewer.requestDraw(),a}removeBaseIncrement(e){this.removeBaseIncrementFromOccurrence(e,this.getOccurrenceIdForEntity(e))}hideShowFeatureEntities(e,t){const i=this.getEntitiesForFeature(e);if(!i)return!1;let s=!1;const n=this.activeSketches.hasOwnProperty(e);for(let e=0;e<i.length;++e)s=this.hideShowFeatureEntity(i[e],n,t)||s;return s}showPartsWithSheetmetalModelIdOnly(e){for(const t of this.featureToIds.getKeys()){const i=this.activeSketches.hasOwnProperty(t),s=this.featureToIds.get(t);for(const n of s.getKeys()){const s=this.getSheetMetalModelId(n);s&&s===e?this.hideShowFeatureEntity(n,i,this.featureVisibility[t]):this.hideShowFeatureEntity(n,i,Xs.EE.HIDDEN)}}}getFeatureIdForOccurrence(e){const t=this.occurrences[e];if(!t||!t.displayedSketchEntityIds)return null;if(t.sketchFeatureId)return t.sketchFeatureId;for(const e of t.displayedSketchEntityIds){const t=this.idToMetaData[e];if(t)return t.getSketchFeatureId()}return null}doesSketchContainBody(e,t){const i=this.featureToIds.get(e);if(!i)return!1;let s=!1;return i.each(((e,i)=>{const n=this.idToMetaData[i];return s=n?.getBodyId()===t,s})),s}getEntityTypesContainedWithinSketch(e){const t=new Set,i=this.featureToIds.get(e);return i?(i.each(((e,i)=>(t.add(this.idToMetaData[i].getEntityType()),t.has(k.ZSW.VERTEX)&&t.has(k.ZSW.EDGE)&&t.has(k.ZSW.FACE))),this),t.size>0&&t.add(k.ZSW.BODY),t):t}getComponentId(){return Vm}}const Hm=new Mi.si;class Gm extends Um{constructor(e){super(null,ys.L.BASE,(0,j.as)(ND,e)),this.idManager=new Mi.si,this.temporarySketchId=Hm.getId(),this.node=new Gi.NB(vE+this.temporarySketchId),this.meshManager=new eD((0,j.as)(ND,e),{bufferAllocationPolicy:AE.MEDIUM}),this.entityIdManager=new DE.E,this.viewer.getSceneGraphs().getMainSceneGraph().getRootNode().addChild(this.node),this.viewer.getModelViewManagers().getManager().addTemporarySketchComponent(this),this.instantiateForPartStudio(this.node)}remove(){this.viewer.getModelViewManagers().getManager().removeTemporarySketchComponent(this),this.node.remove(),Hm.freeId(this.temporarySketchId),this.temporarySketchId=Mi.JE,this.reset()}getUniqueId(){return this.temporarySketchId}addTemporaryEntity(e,t){const i=this.idManager.getId().toString(),s=new k.QsM;s.isAssociatedWithFlat=this.viewer.getIsForFlattenedDisplay(),this.idToPartData[i]=s,e.id=i,this.idToMetaData[i]=t,this.featureToIds.insertNested(this.temporarySketchId.toString(),i,!0),this.updateEntityGraphics(i,e,t)}updateTemporaryEntity(e,t,i){this.removeEntity(e);const s=new k.QsM;s.isAssociatedWithFlat=this.viewer.getIsForFlattenedDisplay(),this.idToPartData[e]=s,t.id=e,this.idToMetaData[e]=i,this.featureToIds.insertNested(this.temporarySketchId.toString(),e,!0),this.updateEntityGraphics(e,t,i)}reset(){super.reset(),this.idManager.reset(),this.entityIdManager.reset()}isEntityInActiveSketch(e){return!0}isSketchDisplayedAsActive(e,t){return!0}getNodeProperties(e,t,i){const s=super.getNodeProperties(e,t,i,HE(e));return s.isPickable=!1,s.includedInBlend=!1,s.updateId(),s}getEntityIdManager(){return this.entityIdManager}getMeshManager(){return this.meshManager}getSharedBaseMeshManager(){return null}getMeshOwnerId(){return"t"}updateEntityHighlight(e,t,i,s){return s===TE.KF&&(s=this.sketchComponentElementId),Yg.prototype.updateEntityHighlight.call(this,e,t,i,s)}}var km=i(46406);const Wm=X.default.getManager(),zm=Wm.getNumber("CONTROL_POINT_GRID_LINE_WIDTH"),Xm=Wm.getNumber("CONTROL_POINT_GRID_VERTICES_SIZE"),Zm="controlPointGrid",qm=new Gi.hF({primitiveType:Ai.MX.LINES,isPickable:!1,isHighlightable:!1,isTwoSided:!1,isShowThrough:!1,isDepthTested:!0}),Ym=new Gi.hF({primitiveType:Ai.MX.LINES,isPickable:!1,isHighlightable:!1,isShowThrough:!0,isTwoSided:!0,isDepthTested:!1,isStencilTested:!0}),Km=new Gi.hF({primitiveType:Ai.MX.POINTS,isPickable:!1,isShowThrough:!0,isDepthTested:!1}),jm=Wm.getStipple("CURVATURE_UV_TOOTH_STIPPLE");class Qm extends yi.u1{constructor(e,t,i,s){super(s),this.edgeId=e,this.controlPointData=t,this.checkboxStates=i,this.id=Zm+"."+e,this.update()}onAppearanceConstantsUpdated(){this.update()}update(){this.isHidden||(this.displayGridUProfile(),this.displayGridVProfile(),this.displayControlPoints())}displayGridUProfile(){const e=[];if(this.checkboxStates[km.N.CPT_GRIDS]){const t=this.controlPointData.controlPoints;if(t.length){const i=t.length,s=t[0].length/3;for(let n=0;n<i;n++){const i=t[n];for(let t=1;t<s;t++)for(let s=t-1;s<=t;s++){const t=M.fromValues(i[3*s],i[3*s+1],i[3*s+2]);e.push(t)}}}}const t=Wm.getColor("CONTROL_POINT_GRID_COLOR_U"),i=(0,Yd.pf)(e,void 0,t,zm);this.updateMeshIncrement(Zm+".gridU",yi.ZJ,i,qm);const s=(0,Yd.pf)(e,void 0,t,zm,jm);this.updateMeshIncrement(Zm+".stippledU",yi.ZJ,s,Ym)}displayGridVProfile(){const e=[];if(this.checkboxStates[km.N.CPT_GRIDS]){const t=this.controlPointData.controlPoints;if(t.length){const i=t.length,s=t[0].length/3;for(let n=0;n<s;n++)for(let s=1;s<i;s++)for(let i=s-1;i<=s;i++){const s=M.fromValues(t[i][3*n],t[i][3*n+1],t[i][3*n+2]);e.push(s)}}}const t=Wm.getColor("CONTROL_POINT_GRID_COLOR_V"),i=(0,Yd.pf)(e,void 0,t,zm);this.updateMeshIncrement(Zm+".gridV",yi.ZJ,i,qm);const s=(0,Yd.pf)(e,void 0,t,zm,jm);this.updateMeshIncrement(Zm+".stippledV",yi.ZJ,s,Ym)}displayControlPoints(){const e=Zm+".controlPoints";if(!this.checkboxStates[km.N.CPT_GRIDS])return void this.removeMeshIncrement(e);const t=Wm.getColor("CONTROL_POINT_GRID_VERTICES_COLOR"),i=this.controlPointData.controlPoints,s=i.length*(i[0]?.length??0)/3,n=new Float32Array(3*s),r=new Int32Array(s);let a=0;for(let e=0;e<i.length;e++)for(let t=0;t<i[e].length;t+=3)n.set([i[e][t],i[e][t+1],i[e][t+2]],3*a),r[a]=a,a++;const o=(0,Yd.mg)(n,e,t,Xm);this.updateMeshIncrement(e,yi.ZJ,o,Km)}onCheckboxStatesUpdate(e){this.checkboxStates=e,this.update()}}const $m=X.default.getManager(),Jm="knotPoint",ef=new Gi.hF({primitiveType:Ai.MX.POINTS,isPickable:!1,isShowThrough:!0,isDepthTested:!1});class tf extends yi.u1{constructor(e,t,i,s){super(s),this.entityId=e,this.knotPointsData=t,this.checkboxStates=i,this.previousIds=new Set,this.id=Jm+"."+e,this.update()}onAppearanceConstantsUpdated(){this.update()}update(){this.isHidden||this.displayKnots()}getUniqueKnotPoints(e){const t=new Set,i=[];for(const s of e){const e=s.join(",");t.has(e)||(t.add(e),i.push(s))}return i}displayKnots(){if(!this.checkboxStates[km.N.KNOT_POINTS])return void this.removeMeshIncrement(Jm);const e=this.getUniqueKnotPoints(this.knotPointsData.knotPoints),t=new Float32Array(3*e.length);for(let i=0;i<e.length;i++){const[s,n,r]=e[i];t.set([s,n,r],3*i)}const i=$m.getColor("KNOT_POINTS_COLOR"),s=$m.getNumber("KNOT_POINTS_SIZE"),n=(0,Yd.mg)(t,Jm,i,s);this.updateMeshIncrement(Jm,yi.ZJ,n,ef)}onCheckboxStatesUpdate(e){this.checkboxStates=e,this.update()}}var sf=i(5215),nf=i(46730),rf=i(19048);const af=X.default.getManager(),of="edgeCurvature",hf=new Gi.hF({primitiveType:Ai.MX.LINES,isPickable:!1,isHighlightable:!1,isTwoSided:!1,isShowThrough:!1,isDepthTested:!0}),cf=new Gi.hF({primitiveType:Ai.MX.LINES,isPickable:!1,isHighlightable:!1,isShowThrough:!0,isTwoSided:!0,isDepthTested:!1,isStencilTested:!0}),lf=new Gi.hF({primitiveType:Ai.MX.POINTS,isPickable:!1,isHighlightable:!1,isTwoSided:!0,isShowThrough:!0,priority:Gi.DO.HIGHEST}),df=new Gi.hF({primitiveType:Ai.MX.TRIANGLES,isPickable:!1,isHighlightable:!1,isTwoSided:!0,isShowThrough:!0,priority:Gi.DO.HIGHEST}),uf=af.getStipple("CURVATURE_UV_TOOTH_STIPPLE"),gf=af.getNumber("CURVATURE_TOOTH_LINE_WIDTH"),pf=af.getNumber("CURVATURE_UV_TOOTH_LINE_WIDTH"),mf=af.getNumber("CURVATURE_UV_ROOF_LINE_WIDTH"),ff=af.getNumber("CURVATURE_ROOF_LINE_WIDTH"),If=af.getStipple("CURVATURE_UV_ROOF_STIPPLE"),Ef=Math.pow(Ri.W.MAX_MODEL_SIZE,2),Sf=af.getNumber("INFLECTION_POINT_SIZE"),Tf=af.getNumber("INFLECTION_TRIANGLE_HEIGHT_PX"),Df=af.getNumber("INFLECTION_TRIANGLE_WIDTH_PX");class Cf extends yi.u1{constructor(e,t,i,s,n,r,a){super(r),this.edgeId=e,this.curvatureData=t,this.curvatureSize=i,this.checkboxStates=s,this.entityCurvatureWrapper=a,this.curvaturePower=n,this.id=of+"."+e,this.listenTo(r.getEventDispatcher(),nM.Hq,this.onActiveSheetMetalModelChanged),this.update()}onAppearanceConstantsUpdated(){this.update()}update(){if(this.isHidden)return;const e=af.getColor("CURVATURE_TOOTH_COLOR"),t=af.getColor("CURVATURE_U_TOOTH_COLOR"),i=af.getColor("CURVATURE_V_TOOTH_COLOR"),s=af.getColor("CURVATURE_U_ROOF_COLOR"),n=af.getColor("CURVATURE_V_ROOF_COLOR"),r=af.getColor("CURVATURE_ROOF_COLOR"),a=[],o=[];let h;if(this.curvatureData&&this.checkboxStates[km.N.CURVATURE_COMBS]){const e=this.curvatureData.curvatures.length;for(let t=0;t<e;t++){const i=this.curvatureData.curvatures[t],s=this.curvatureData.positions[t],n=M.fromValues(s.x,s.y,s.z),r=this.curvatureData.normals[t],c=M.fromValues(r.x,r.y,r.z),l=this.curvatureSize*Math.pow(i,this.curvaturePower),d=ge.S4.add(n,ge.S4.scale(c,l,M.create()),M.create()),u=t%nf.y.OVERSAMPLING_SCALE!=0,g=t===e-1&&t>0&&a.length>1&&M.equals(a[0],n)&&M.equals(a[1],d);Math.max(M.squaredLength(n),M.squaredLength(d))<Ef?(u||g||a.push(n,d),h&&o.push(h,d),h=d):h=void 0}}let c=e,l=gf,d=r,u=ff;this.entityCurvatureWrapper.isFaceCurvature()&&(c=this.entityCurvatureWrapper.isFaceUCurve()?t:i,l=pf,d=this.entityCurvatureWrapper.isFaceUCurve()?s:n,u=mf);const g=(0,Yd.pf)(a,void 0,c,l);this.updateMeshIncrement(of+".teeth",yi.ZJ,g,hf);const p=(0,Yd.pf)(a,void 0,c,l,uf);this.updateMeshIncrement(of+".stippledTeeth",yi.ZJ,p,cf);const m=(0,Yd.pf)(o,void 0,d,u);this.updateMeshIncrement(of+".roof",yi.ZJ,m,hf);const f=(0,Yd.pf)(o,void 0,d,u,If);this.updateMeshIncrement(of+".stippledroof",yi.ZJ,f,cf),this.updateInflectionPointIndicators(),this.updateMinimumRadiusOfCurvatureIndicator()}updateInflectionPointIndicators(){if(!this.curvatureData||!this.curvatureData.inflectionPointPositions)return;const e=[],t=this.curvatureData.inflectionPointPositions.length,i=new Float32Array(15*t),s=new Float32Array(15*t),n=new Int32Array(6*t);if(this.checkboxStates[km.N.INFLECTION_POINTS]){if(this.curvatureData.inflectionPointPositions.length!==this.curvatureData.tangentsAtInflectionPoints.length)return;for(let r=0;r<t;r++){const t=this.curvatureData.inflectionPointPositions[r],a=M.fromValues(t.x,t.y,t.z);e.push(a);const o=this.curvatureData.tangentsAtInflectionPoints[r],h=M.fromValues(o.x,o.y,o.z),c=this.viewer?.getCamera()?.getPixelSizeAtWorldPoint(a),l=this.viewer?.getCamera()?.projectWorldPointToCanvas(a),d=this.viewer?.getCamera()?.getRay(l[0],l[1]),u=d.direction,g=ge.S4.cross(u,h,M.create());ge.S4.length(g)>Ri.W.ZERO_LENGTH&&ge.S4.normalize(g);const p=ge.S4.cross(u,g,M.create()),m=ge.S4.scale(g,c*Tf,M.create()),f=ge.S4.scale(g,c*-Tf,M.create()),I=ge.S4.scale(p,c*-Df/2,M.create()),E=ge.S4.scale(p,c*Df/2,M.create()),S=[ge.S4.add(a,ge.S4.add(m,E,M.create()),M.create()),ge.S4.add(a,ge.S4.add(m,I,M.create()),M.create()),a,ge.S4.add(a,ge.S4.add(f,E,M.create()),M.create()),ge.S4.add(a,ge.S4.add(f,I,M.create()),M.create())],T=[0,1,2,3,4,2];for(let e=0;e<6;e++)5!==e&&(i.set(S[e],15*r+3*e),s.set(u,15*r+3*e)),n[6*r+e]=5*r+T[e]}}const r=new eT(Ai.MX.TRIANGLES,i,n);r.normals=s;const a=af.getColor("INFLECTION_POINT_COLOR");(0,Yd.Ab)(a,r),(0,Yd.VQ)(Sf,r),this.updateMeshIncrement(of+".inflectionTriangles",yi.ZJ,r,df);const o=new Float32Array(3*e.length),h=new Int32Array(e.length);for(let t=0;t<e.length;++t){h[t]=t;for(let i=0;i<3;++i)o[3*t+i]=e[t][i]}const c=new eT(Ai.MX.POINTS,o,h,void 0);(0,Yd.Ab)(a,c),(0,Yd.VQ)(Sf,c),this.updateMeshIncrement(of+".inflectionPoint",yi.ZJ,c,lf)}updateMinimumRadiusOfCurvatureIndicator(){if(this.checkboxStates[km.N.MINIMUM_RADIUS]&&this.curvatureData&&this.curvatureData.coordinateSystemOfCurvatureCircle){const e=this.curvatureData.coordinateSystemOfCurvatureCircle.getGlMatrix(),t=M.fromValues(e[12],e[13],e[14]),i=M.fromValues(e[8],e[9],e[10]),s=this.curvatureData.minimumRadiusOfCurvature,n=(0,Yd.y)(t,this.curvatureData.minimumRadiusOfCurvature,i,100),r=af.getColor("RADIUS_OF_CURVATURE_CIRCLE_COLOR");(0,Yd.Ab)(r,n),(0,Yd.VQ)(ff,n),this.updateMeshIncrement(of+".radius",yi.ZJ,n,hf);const a=new rf.l;a.id="fakeDimensionId",a.featureId="fakeSketchId",a.parameterId="length",a.value=this.curvatureData.minimumRadiusOfCurvature,a.coordinateSystem.m00=1,a.coordinateSystem.m01=0,a.coordinateSystem.m10=0,a.coordinateSystem.m11=1,a.coordinateSystem.m02=0,a.coordinateSystem.m12=0,a.coordinateSystem.m22=1;const o=-Math.PI,h=this.curvatureData.minimumRadiusOfCurvature/2,c=-Math.PI,l=c;a.positionR=h,a.positionT=o,a.witnessEndPoint0r=s,a.witnessEndPoint0t=c,a.witnessEndPoint1r=s,a.witnessEndPoint1t=l,a.planeMatrix=this.curvatureData.coordinateSystemOfCurvatureCircle,a.radiusDisplay=sf.M.RADIAL,a.isDriven=!0,this.diameterGraphics||(this.diameterGraphics=new AA(this.viewer,!0)),this.diameterGraphics.updateFromDisplayData(a)}else this.removeMeshIncrement(of+".radius"),this.diameterGraphics&&(this.diameterGraphics.remove(),this.diameterGraphics=null)}updateSizeAndPower(e,t){this.curvatureSize===e&&this.curvaturePower===t||(this.curvatureSize=e,this.curvaturePower=t,this.update())}show(){super.show(),this.diameterGraphics&&this.diameterGraphics.show(),this.update()}hide(){super.hide(),this.diameterGraphics&&this.diameterGraphics.hide()}remove(){super.remove(),this.diameterGraphics&&this.diameterGraphics.remove()}getFitBounds(){return this.getInstantiatedMeshIncrement(of+".teeth").meshIncrement.getBounds()}onViewWillDraw(e,t){this.updateInflectionPointIndicators()}onActiveSheetMetalModelChanged(e){this.curvatureData.ownerBodySheetMetalModelId&&(this.curvatureData.ownerBodySheetMetalModelId!==e?this.hide():this.show())}onCheckboxStatesUpdate(e){this.checkboxStates=e,this.update()}}const Mf=X.default.getManager(),yf="dihedralComb",Af=yf+".low",Pf=yf+".mid",Of=yf+".high",Rf=yf+".zeropoint",wf=Mf.getNumber("DIHEDRAL_TOOTH_LINE_WIDTH"),vf=Mf.getNumber("DIHEDRAL_ZERO_POINT_SIZE"),_f=Mf.getStipple("DIHEDRAL_TOOTH_STIPPLE"),Nf=new Gi.hF({primitiveType:Ai.MX.POINTS,isPickable:!1,isHighlightable:!1,isTwoSided:!0,isShowThrough:!0,priority:Gi.DO.HIGHEST}),bf=new Gi.hF({primitiveType:Ai.MX.LINES,isPickable:!1,isHighlightable:!1,isTwoSided:!1,isShowThrough:!1,isDepthTested:!0}),Lf=new Gi.hF({primitiveType:Ai.MX.LINES,isPickable:!1,isHighlightable:!1,isShowThrough:!0,isTwoSided:!0,isDepthTested:!1,isStencilTested:!0});class Ff extends yi.u1{constructor(e,t,i,s,n,r,a,o){super(o),this.edgeId=e,this.dihedralData=t,this.scale=i,this.coefficient=s,this.lowRadians=n,this.highRadians=r,this.useThresholdDisplay=a,this.id=yf+"."+e,this.update()}onAppearanceConstantsUpdated(){this.update()}update(){if(this.isHidden)return;const e=Mf.getColor("DIHEDRAL_HIGH_THRESHOLD_COLOR"),t=Mf.getColor("DIHEDRAL_MID_THRESHOLD_COLOR"),i=Mf.getColor("DIHEDRAL_LOW_THRESHOLD_COLOR"),s=this.createAndSortLineData();this.updateLines(s.lowLines,i,this.id+Af),this.updateLines(s.midLines,t,this.id+Pf),this.updateLines(s.highLines,e,this.id+Of),this.updatePoints(s.points)}updatePoints(e){const t=Mf.getColor("DIHEDRAL_HIGH_THRESHOLD_COLOR"),i=Mf.getColor("DIHEDRAL_MID_THRESHOLD_COLOR"),s=Mf.getColor("DIHEDRAL_LOW_THRESHOLD_COLOR"),n=new Float32Array(3*e.length),r=new Int32Array(e.length);for(let t=0;t<e.length;++t){r[t]=t;const i=e[t];for(let e=0;e<3;e++)n[3*t+e]=i[e]}let a=i;this.useThresholdDisplay&&(0<=this.lowRadians?a=s:0>=this.highRadians&&(a=t));const o=new eT(Ai.MX.POINTS,n,r,void 0);(0,Yd.Ab)(a,o),(0,Yd.VQ)(vf,o),this.updateMeshIncrement(this.id+Rf,yi.ZJ,o,Nf)}updateLines(e,t,i){const s=(0,Yd.pf)(e,void 0,t,wf);this.updateMeshIncrement(i,yi.ZJ,s,bf);const n=(0,Yd.pf)(e,void 0,t,wf,_f);this.updateMeshIncrement(i+".stipple",yi.ZJ,n,Lf)}getFitBounds(){const e=this.getInstantiatedMeshIncrement(this.id+Af).meshIncrement.getBounds(),t=this.getInstantiatedMeshIncrement(this.id+Pf).meshIncrement.getBounds(),i=this.getInstantiatedMeshIncrement(this.id+Of).meshIncrement.getBounds();return e.addBox(t),e.addBox(i),e}setScale(e){this.scale=e}setCoefficient(e){this.coefficient=e}setThresholdValues(e,t){this.lowRadians=e,this.highRadians=t}setUseThresholdDisplay(e){this.useThresholdDisplay=e}static getComb(e,t,i){const s=e.position.getVec3(),n=e.direction.getVec3(),r=(0,Oc.round)(e.magnitudeRadians,5),a=t*i*r;return[s,M.scaleAndAdd(M.create(),s,n,a),r]}createAndSortLineData(){const e=[],t=[],i=[],s=[],n=this.dihedralData.dihedrals;for(let r=0;r<n.length;r++){const[a,o,h]=Ff.getComb(n[r],this.scale,this.coefficient);Math.abs(h)<Ff.NEAR_ZERO_RADIAN_THRESHOLD?s.push(a):this.sortCombToArrays(h,a,o,t,e,i)}return{lowLines:t,midLines:e,highLines:i,points:s}}sortCombToArrays(e,t,i,s,n,r){this.useThresholdDisplay?Math.abs(e)<Math.abs(this.lowRadians)?s.push(t,i):Math.abs(e)>Math.abs(this.highRadians)?r.push(t,i):n.push(t,i):n.push(t,i)}}Ff.NEAR_ZERO_RADIAN_THRESHOLD=Math.PI/180*.05;const xf=X.default.getManager();class Bf extends yi.u1{constructor(e,t,i,s,n,r){super(r),this.id="dihedralExtrema."+e,this.dihedral=t,this.scale=i,this.coefficient=s,this.text=n,this.needsUpdating=!0,this.update()}onAppearanceConstantsUpdated(){this.needsUpdating=!0,this.update()}update(){if(this.isHidden||!this.needsUpdating)return;this.textHeightPx=xf.getNumber("DIMENSION_VALUE_HEIGHT_PIXELS"),this.font=xf.getString("DIMENSION_VALUE_FONT"),this.color=xf.getColor("DIMENSION_DRIVING_VALUE_TEXT_COLOR"),this.textDisplay?.remove();const[e,t,i]=Ff.getComb(this.dihedral,this.scale,this.coefficient),s=Math.abs(i)<Ff.NEAR_ZERO_RADIAN_THRESHOLD?e:t;this.textDisplay=new xa({origin:s,heightPx:this.textHeightPx,color:this.color,font:this.font,orientToScreen:!0,offsetRight:wi.iK.MID,offsetUp:wi.iK.LOW},this.viewer),this.textDisplay.setText(this.text),this.needsUpdating=!1}remove(){super.remove(),this.textDisplay.remove()}setScaleAndCoefficient(e,t){this.scale=e,this.coefficient=t,this.needsUpdating=!0}setString(e){this.text=e,this.needsUpdating=!0}}const Vf=k.ZIP.VIRIDIS,Uf="simulation-legend-canvas-controls";class Hf extends Ec{constructor(){super(...arguments),this.LEGEND_MAXIMUM_CLICKED=nM.Jm,this.LEGEND_MINIMUM_CLICKED=nM.xy,this.LEGEND_RANGE_CHANGED=nM.pj,this.CANVAS_CONTROLS_PANEL_ID=Uf}updateGraphics(){void 0!==this.visualizedFieldType&&super.updateGraphics()}get SNAPPING_MARGIN_TOP(){return X.default.getManager().getNumber("SIMULATION_TOP_TOOLBAR_HEIGHT_PX")}}var Gf=i(50208);const kf=_e.O.createLogger("SimulationManager",k.bVy.GRAPHICS),Wf=[0,.125,.25,.375,.5,.625,.75,.875,.92,1,1,1,1,1,.9,.5,.2,0,-.1,-.11,-.05,0,.02,.02,.01,0,-.01,0,0,0,0,0];class zf extends Dc{constructor(e){super(e),this.modelViewManager=e,this.COLOR_MAP_STORAGE_KEY=Gf.S,this.LEGEND_CLOSED=os.Ipz,this.LEGEND_OPENED=os.PXv,this.VISUALIZATION_MANAGER_NODE_ID="SimulationManager",this.graphicsRenderMode=k.P1.SIMULATION_RESULTS,this.meshOwnerId=JT(),this.tessellationCache=new Map,this.occurrenceToMaterial=new Map,this.isAnimating=!1,this.elementIdToResponseData=new Map,this.scalarVisualizationOccurrences=[],this.simulationMass=0,es.Jq.SimulationService&&es.Jq.SimulationService.getIsAnimatingObservable().subscribe((e=>{e?this.startAnimation():this.stopAnimation()})),this.connectionVisualizationManager=new Gh(es.Jq.AnalyticsService,e,this)}getContactBehavior(){return this.connectionVisualizationManager.getContactBehavior()}prepareResources(){super.prepareResources(),this.legend||(this.legend=new Hf(this))}clearScalarVisualizationStatusForOccurrences(e){const t=this.getViewer().getOccurrenceIdManager();for(const i of e){const e=k._oC.getOccurrenceFromPathString(i),s=t.getIdForName(i);if(s===TE.Qy){kf.warn("No occurrence id for "+i);continue}const n=this.modelViewManager.getPartStudioDataFromOccurrence(e);n?n.getBodyComponent().clearScalarVisualizationOccurrence(s):kf.debug("No part studio for occurrence "+i)}}get displayedSimulatedField(){return this.visualizationState?this.visualizationState.field:null}hasDisplayableFieldSet(){return!!this.displayedSimulatedField&&this.displayedSimulatedField.type!==k.DDL.UNKNOWN}readyToShowLegend(){return this.viewerIsInScalarVisualizationRenderMode()&&this.hasDisplayableFieldSet()&&this.visualizationState&&!this.visualizationState.connectionVisualizationActive}setVisualizationState(e){const t=new Ih.B7("SimulationManager.setVisualizationState",{setTraceId:!0}),i=!this.visualizationState||!(0,Qs.Z)(this.visualizationState.connectionTypeToHidden,e.connectionTypeToHidden),s=!this.visualizationState||this.visualizationState.restInDeformedState!==e.restInDeformedState,n=!this.visualizationState||this.visualizationState.deformationScale!==e.deformationScale;super.setVisualizationState(e),this.connectionVisualizationManager.setVisible(this.visualizationState.connectionVisualizationActive),i&&this.connectionVisualizationManager.updateGraphics(),this.hasDisplayableFieldSet()&&!this.visualizationState.connectionVisualizationActive||this.hideLegend(),!s&&!n||this.isAnimating||this.resetSimulationOffsetFactor(),t.report()}setContactBehavior(e){this.connectionVisualizationManager.setContactBehavior(e)}getSimulationBounds(){if(!this.rootNode)return null;let e=this.rootNode.getBoundingBox();if(this.isAnimating||this.visualizationState?.restInDeformedState){e=e.clone();const t=this.inputDisplacementRange.max>Ri.W.ZERO_LENGTH?.001*this.inputDisplacementRange.max:0,i=1e3;e.dilate(Math.min(t,i))}return e}hasSimulationResultsForElement(e){return this.elementIdToResponseData.has(e)}updateSimulation(e){const t=new Ih.B7("SimulationManager.updateSimulation",{setTraceId:!0});this.prepareResources();for(const t of e.simulationTessellations)this.tessellationCache.set(this.getTessellationCacheKey(t.sourceElement,t.deterministicId),t);for(const t in e.occurrenceToMaterial)this.occurrenceToMaterial.set(t,e.occurrenceToMaterial[t]);let i=!1,s=null;if(e.activeSimulationUpdates.length>0){if(s=e.activeSimulationUpdates[0].runStatus,s===k.zgQ.JUST_STARTED||s===k.zgQ.INVALID_ASSEMBLY)return this.clearGraphics(),s===k.zgQ.JUST_STARTED&&this.elementIdToResponseData.delete(e.sourceElementId),void(this.legend&&(this.legend.clearRanges(),this.showLegend()))}const n=e.responses[0];if(n)this.elementIdToResponseData.set(e.sourceElementId,n),i=!0;else{const e=this.modelViewManager.getDisplayedAssembly();e&&s===k.zgQ.TRANSMITTED&&this.elementIdToResponseData.has(e.elementId)&&(i=!0)}i&&(this.prepareField(this.displayedSimulatedField),this.updateGraphics()),t.report()}updateContactAnalysis(e){this.connectionVisualizationManager.updateContactAnalysis(e)}getVisualizationState(){return this.visualizationState}isIsolateEffectActive(){return this.connectionVisualizationManager.getVisible()&&this.connectionVisualizationManager.getUseIsolateEffect()}onRenderingModeChanged(){super.onRenderingModeChanged();this.viewerIsInScalarVisualizationRenderMode()&&this.getViewer().setUserEnabledAggressiveRefinement(!1)}resetMeshes(){this.meshManager&&this.meshManager.destroy(),this.meshManager=new eD(this.getViewer(),{bufferAllocationPolicy:AE.MAXIMUM})}onAssemblyDisplayed(){this.updateGraphics(),this.connectionVisualizationManager.updateGraphics()}onAssemblyChanged(){this.connectionVisualizationManager.onAssemblyChanged()}onSectionSetChanged(){this.connectionVisualizationManager.onSectionSetChanged()}onDocumentChange(){this.tessellationCache.clear(),this.elementIdToResponseData.clear()}updateGraphics(){this.clearGraphics();const e=this.modelViewManager.getDisplayedAssembly();if(!e||e.isHidden||this.visualizationState&&this.visualizationState.connectionVisualizationActive)return;this.showLegend();const t=this.elementIdToResponseData.get(e.elementId);if(!t)return void(this.legend&&this.legend.clearRanges());const i=this.getViewer().getOccurrenceIdManager(),s=this.getViewer().getOccurrenceDataManager(),n=t.firstResultDataSet;if(!n)return void kf.debug("No data set to display");if(!this.visualizationState||n.isModal!==this.visualizationState.field.isModal||!this.hasDisplayableFieldSet())return;if(!this.viewerIsInScalarVisualizationRenderMode())return;if(!n.canBeUsedToDisplay(this.displayedSimulatedField))return;this.displayedScalarRangeSpecification=n.getRangeSpecification(this.displayedSimulatedField),this.inputDisplacementRange=n.getRangeSpecification(this.displayedSimulatedField?.displacementFieldSpecification).rangeInData;const r=[];for(let e=0;e<zf.imageMaps.length;++e){const t=new Gi.hF({material:this.scalarVisualizationMaterials[e],zOffset:X.default.getManager().getNumber("PART_FACES_Z_OFFSET"),primitiveType:Ai.MX.TRIANGLES,includedInBlend:!0,clippedBySectionPlanes:!0,isPickable:!1});r.push(t)}let a=!1;this.simulationMass=0;for(const t in n.occurrenceIdToOccurrenceResult){const o=n.occurrenceIdToOccurrenceResult[t],h=k._oC.getOccurrenceFromPathString(t),c=i.getIdForName(t);if(c===TE.Qy){kf.warn("No occurrence id for "+t);continue}const l=s.getOccurrenceData(c);l||kf.warn("No occurrence data for "+t);const d=e.getOccurrenceDisplayData(h);if(!d){kf.warn("No occurrence display data for "+t);continue}const u=this.modelViewManager.getPartStudioDataFromOccurrence(h);if(!u){kf.debug("No part studio for occurrence "+t);continue}const g=o.getFieldForDisplay(this.displayedSimulatedField);if(!g)continue;if(g.isDisabled){u.getBodyComponent().clearScalarVisualizationOccurrence(c);continue}const p=this.getMeshIncrementForOccurrence(o,d);if(!p){kf.debug("No simulation tessellation for "+t),a=!0;break}this.updateMass(o),u.getBodyComponent().setScalarVisualizationOccurrence(c),p.id=t;const m=this.meshManager.addMeshIncrement(p,this.meshOwnerId),f=new qT("Simulated "+t);f.onIncrementAdded(m);const I=u.retrieveBodyMetaData(d.partIds[0]),E=new mS.bg;I&&E.setAttribute(RS.COLOR,I.getColor());for(let e=0;e<r.length;++e)this.nodes[e].addOccurrenceGeometryToNode(r[e],l,E,f);if(this.debugMeshEdges){const e=(0,Yd.EK)(p,p.id+".edges"),i=this.meshManager.addMeshIncrement(e,this.meshOwnerId),s=new qT("Simulated "+t+" edges");s.onIncrementAdded(i);for(let e=0;e<r.length;++e)this.nodes[e].addOccurrenceGeometryToNode(pm,l,E,s)}this.scalarVisualizationOccurrences.push(t)}if(a)return this.clearGraphics(),void(n.isModal&&this.getViewer().getEventDispatcher().trigger(os.R1N,!1,n));this.cursorAppendage=new as(this.getViewer(),((e,t)=>this.getCursorText(e,t))),this.legend.setInputRange(this.displayedScalarRangeSpecification),this.visualizedScalarRange&&this.legend.setVisualizedScalarRange(this.visualizedScalarRange),this.updateColorMapping(null,this.displayedColorMap),this.updateMakeUnsignedUniform(),this.getViewer().getEventDispatcher().trigger(os.R1N,!0,n),this.getViewer().requestDraw()}updateMass(e){const t=this.getTessellationForOccurrenceResult(e)?.massProperties;t&&t.hasMass&&(this.simulationMass+=t.mass[0])}clearGraphics(){this.getViewer().getEventDispatcher().trigger(os.R1N,!1),this.resetMeshes(),this.clearScalarVisualizationStatusForOccurrences(this.scalarVisualizationOccurrences),this.scalarVisualizationOccurrences=[],super.clearGraphics()}clearSimulationAndConnectionGraphics(){this.clearGraphics(),this.connectionVisualizationManager.clearGraphics()}prepareField(e){const t=this.getDisplayedResults();t&&e&&e.type===k.DDL.SAFETY_FACTOR&&t.prepareSafetyFactor(((e,t)=>{let i=this.occurrenceToMaterial.get(e);if(!i){const e=this.getTessellationForOccurrenceResult(t);e&&(i=e.material)}return i}))}startAnimation(){if(this.isAnimating)return;this.isAnimating=!0;const e=X.default.getManager().getNumber("SIMULATION_DISPLACEMENT_ANIMATION_CYCLE_PERIOD_SEC");let t=-1,i=0;this.getViewer().getAnimationController().startAnimation((s=>{if(!this.isAnimating)return os.ZK6.COMPLETE;if(t>0){i+=(s-t)/1e3/e;const n=this.displayedSimulatedField?.isModal?this.getModalOffsetFactor(i):this.getDisplacementOffsetFactor(i);this.setSimulationOffsetFactor(n)}return t=s,os.ZK6.ONGOING}))}updateVisualizedScalarRange(){this.legend&&(this.legend.visualizedFieldType=this.visualizationState.field.type),super.updateVisualizedScalarRange()}stopAnimation(){this.isAnimating&&(this.isAnimating=!1,this.resetSimulationOffsetFactor(),this.getViewer().requestDraw())}resetSimulationOffsetFactor(){this.visualizationState?.restInDeformedState?this.setSimulationOffsetFactor(1):this.setSimulationOffsetFactor(0),this.getViewer().requestDraw()}setSimulationOffsetFactor(e){for(const t of this.scalarVisualizationMaterials)t.setCustomFloatUniform("uOffsetFactor",e*this.visualizationState.deformationScale*.001)}getRangeInBaseUnits(e){return e?this.displayedSimulatedField?.hasUnits?this.displayedSimulatedField.isStress?(0,Ir.vM)(e,k.L_A.BASE_UNITS):(0,Ir.vM)(e,k.jvX.BASE_UNITS):e:null}updateMakeUnsignedUniform(){let e=II;if(this.visualizationState.field.type===k.DDL.UNSIGNED_VON_MISES_STRESS){const t=this.getDisplayedResults();if(!t)return;const i=t.getAvailableFields();i.has(k.DDL.SIGNED_VON_MISES_STRESS)&&!i.has(k.DDL.UNSIGNED_VON_MISES_STRESS)&&(e=fI)}for(const t of this.scalarVisualizationMaterials)t.setCustomIntUniform("uMakeUnsigned",e)}getDisplayedResults(){const e=this.modelViewManager.getDisplayedAssembly();if(!e)return null;const t=this.elementIdToResponseData.get(e.elementId);return t?t.firstResultDataSet:null}setDebugMeshEdges(e){this.debugMeshEdges=e}getTessellationForOccurrenceResult(e){return this.tessellationCache.get(this.getTessellationCacheKey(e.sourcePartReference,e.sourcePartReference.partId))}getMeshIncrementForOccurrence(e,t){const i=this.getTessellationForOccurrenceResult(e);if(!i)return null;let s=e.getFieldForDisplay(this.displayedSimulatedField);if(!s)return null;let n=e.getFieldForDisplay(this.displayedSimulatedField?.displacementFieldSpecification);if(!n)return null;if(s instanceof k.aj8){const e=1e3*this.visualizationState.field.directDeformationInMeters,t=s.getScaledCopy(e);s=t,n=t}const r=this.getSampleMesh(i,e),a=new eT(Ai.MX.TRIANGLES,r.points,r.getAnyIndices());s.isDisabled||a.packScalarsIntoTextureCoordinates(s.values);const o=this.modelViewManager.getPartStudio(e.sourcePartReference);if(o){const e=o.getBodyBounds(i.deterministicId,t.occurrenceData.occurrence);e&&(a.boundingBox=e)}return n instanceof k.jvX?a.offsetVectors=(0,wi.w5)(n.packedOffsetDirections,n.values):kf.warn("Unexpected displacement field type"),a}findScalarVisualizationScalar(e,t){const i=super.findScalarVisualizationScalar(e,t);if(null===i)return null;if(this.displayedSimulatedField?.hasUnits){const e=(0,fr.vx)().getUnitForSimulatedField(this.displayedSimulatedField?.type);return(0,Ir.WR)(i,this.getRangeInData()?.units,e)}return i}getTessellationCacheKey(e,t){return e.toString()+"."+t}getModalOffsetFactor(e){const t=e*Math.PI*2;return Math.sin(t)}getDisplacementOffsetFactor(e){return(0,wi.HO)(Wf,e)}getValueString(e){return Sc.c.getSimulationValueString(e)}getMass(){return this.simulationMass}}var Xf=i(81788);class Zf extends Mc{constructor(e){super(e),this.manager=e,this.LEGEND_MAXIMUM_CLICKED=nM.vk,this.LEGEND_MINIMUM_CLICKED=nM.YW,this.LEGEND_RANGE_CHANGED=nM.WB,this.CANVAS_CONTROLS_PANEL_ID=os.LIN,this.TOP_TOOPBAR_HEIGHT_CONSTANT="THICKNESS_ANALYSIS_TOP_TOOLBAR_HEIGHT_PX"}updateGraphics(){void 0!==this.visualizedFieldType&&super.updateGraphics()}getInputRangeInDisplayUnits(){return this.manager.getRangeInDisplayUnits(this.manager.getRangeInData())}getDefaultDisplayRangeInDisplayUnits(){return this.manager.getRangeInDisplayUnits(this.manager.getDefaultDisplayRange())}isInputMinimumChanged(){return!!k.ZX_.isGradientField(this.visualizedFieldType)||super.isInputMinimumChanged()}requiresHighlightGraphics(){return this.manager.getUseMinValueHighlight()||this.manager.getUseMaxValueHighlight()||this.manager.getUseDimColorScale()}}var qf=i(10745);const Yf=1e-5,Kf=[k.NSu.PREPROCESSING,k.NSu.QUEUED,k.NSu.WORKING,k.NSu.POSTPROCESSING,k.NSu.COMPLETE],jf=new Map([[k.NSu.PREPROCESSING,Xf.bY.PROCESSING],[k.NSu.QUEUED,Xf.bY.PREPARING],[k.NSu.WORKING,Xf.bY.CALCULATING],[k.NSu.POSTPROCESSING,Xf.bY.POSTPROCESSING],[k.NSu.COMPLETE,Xf.bY.COMPLETE]]),Qf=new Map(Kf.map(((e,t)=>[e,t])));var $f;!function(e){e[e.LENGTH=0]="LENGTH",e[e.UNITLESS=1]="UNITLESS"}($f||($f={}));const Jf=new Map([[k.DDL.ROLLING_BALL_THICKNESS,$f.LENGTH],[k.DDL.RAY_THICKNESS,$f.LENGTH],[k.DDL.ROLLING_BALL_THICKNESS_DERIVATIVE,$f.UNITLESS],[k.DDL.RAY_THICKNESS_DERIVATIVE,$f.UNITLESS]]);class eI extends yc{constructor(e){super(e),this.COLOR_MAP_STORAGE_KEY=Xf.d0,this.LEGEND_CLOSED=nM.aI,this.LEGEND_OPENED=nM.Cv,this.VISUALIZATION_MANAGER_NODE_ID="ThicknessAnalysisManager",this.graphicsRenderMode=k.P1.THICKNESS_ANALYSIS_VISUALIZATION,this.elementIdToElementState=new Map,this.meshOwnerId=JT(),this.isEnabledSubject=new As.x,this.bodyFilter=null,this.displayDataFunctionQueue=[],this.displayedScalarRangeSpecification={rangeInData:null,defaultDisplayRange:null},(0,os.eRd)(os.CrY).subscribe((()=>this.updateVisualizedScalarRange()))}getVisualizationStateForField(e){const t=this.getActiveElementState();return t?.visualizationStates.get(e)??null}initializeFieldType(e,t){const i=new k.ZX_,s=new k.dGY;s.addUnits(this.getBaseUnitsForField(t)),i.visualizedRange=s,i.displayedField=t,i.colorMapping=this.getStoredColorMapping();const n=this.computeDefaultFieldRange(t),{visualizationStates:r}=this.getOrCreateElementState(e);r.set(t,{visualizationState:i,defaultRange:{rangeInData:n,defaultDisplayRange:n}})}initializeFieldTypes(e){for(const t of eI.ENABLED_FIELD_TYPES)this.initializeFieldType(e,t)}updateVisualizationState(){const e=this.getActiveVisualizedField();if(null===e)return;const t=this.getVisualizationStateForField(e);t&&(t.visualizationState.colorMapping=this.getStoredColorMapping(),t.visualizationState.userSetRangeMax||(t.visualizationState.visualizedRange.max=t.defaultRange.defaultDisplayRange?.max),t.visualizationState.userSetRangeMin||(t.visualizationState.visualizedRange.min=t.defaultRange.defaultDisplayRange?.min),this.setVisualizationState(t.visualizationState))}setVisualizationState(e){const t=this.getVisualizationStateForField(e.displayedField),{defaultRange:i}=t;this.displayedScalarRangeSpecification.rangeInData=i.rangeInData,this.displayedScalarRangeSpecification.defaultDisplayRange=i.defaultDisplayRange,this.legend&&(this.legend.visualizedFieldType=e.displayedField,this.legend.setInputRange(this.displayedScalarRangeSpecification)),t.visualizationState=e,super.setVisualizationState(e)}resetMeshes(){this.meshManager?.destroy(),this.meshManager=new eD(this.getViewer(),{bufferAllocationPolicy:AE.MAXIMUM})}prepareResources(){super.prepareResources(),this.getOrCreateElementState(this.activeElementId),this.updateVisualizationState(),null!==this.displayedColorMap&&this.displayedColorMap!==k.ZIP.UNKNOWN||this.setColorMapping(this.getStoredColorMapping()),this.legend||(this.legend=new Zf(this))}setVisualizedField(e){const t=this.getActiveElementState();t&&e!==t.visualizedField&&(t.visualizedField=e,this.updateVisualizationState())}convertRadiiToDiameters(e){const t=e.clone();for(const e of t.result.fields){e.minValue*=2,e.maxValue*=2;for(let t=0;t<e.values.length;t+=1)e.values[t]*=2}return t}getOrCreateElementState(e){let t=this.elementIdToElementState.get(e);return t||(t={resultsCache:new Map,visualizedField:k.DDL.ROLLING_BALL_THICKNESS,visualizationStates:new Map,displayedColorMap:this.getStoredColorMapping(),hasScalarVisualizationOccurrences:!1,lastMicroversionIdAndConfiguration:null},this.elementIdToElementState.set(e,t),this.initializeFieldTypes(e)),t}getElementState(e){return this.elementIdToElementState.get(e)??null}getActiveElementState(){return this.getElementState(this.activeElementId)}getActiveVisualizedField(){return this.getActiveElementState()?.visualizedField??null}hasActiveSketch(){return!!this.getViewer().getSketch()||gi._3.getActiveFeatureController()?.isSketchFeatureController()}updateLastMicroversionIdAndConfiguration(e){if(!Us())return;const t=this.getActiveElementState();t&&(t.lastMicroversionIdAndConfiguration=e)}onUpdate(e){const t=e.sourceElementId,i=this.getOrCreateElementState(t);for(const t of e.results){const e=this.convertRadiiToDiameters(t);i.resultsCache.set(t.bodyDeterministicId,e)}t===this.activeElementId&&(this.updateFieldRanges(),this.updateVisualizationState())}getAnalysisDisplayStatus(e){return e.isComplete&&e.status===k.NSu.WORKING?Xf.bY.REFINING:jf.get(e.status)??Xf.bY.UNKNOWN}getOverallStatus(e){const t=this.getElementState(e);if(!t)return k.NSu.UNKNOWN;let i=Number.POSITIVE_INFINITY;for(const e of t.resultsCache.values())i=Math.min(i,(s=e.status,Qf.get(s)??Number.POSITIVE_INFINITY));var s;return Kf[i]??k.NSu.UNKNOWN}getOverallDisplayStatus(e){const t=this.getElementState(e);if(!t)return Xf.bY.UNKNOWN;let i=Xf.bY.COMPLETE;for(const e of t.resultsCache.values())i=Math.min(this.getAnalysisDisplayStatus(e),i);return i}resetState(e){const t=this.getElementState(e);t&&t.resultsCache.clear(),e===this.activeElementId&&(this.resetMeshes(),this.clearScalarVisualizationForVisualizedBodies()),this.updateGraphics()}isEnabledForElement(e){return this.getViewer().getRenderingModeOfElement(e)===this.graphicsRenderMode&&this.elementIdToElementState.has(e)}onRenderingModeChanged(){super.onRenderingModeChanged(),this.viewerIsInScalarVisualizationRenderMode()&&(this.getViewer().getUserEnabledAggressiveRefinement()&&this.getViewer().setUserEnabledAggressiveRefinement(!1),this.isEnabledSubject.next([this.activeElementId,!0]))}disable(){es.Jq.UserSettingsService.getUserSettings().then((e=>{if(!this.viewerIsInScalarVisualizationRenderMode())return;const t=Number(e.graphicsRenderMode);this.getViewer().setRenderingMode(t)})),this.isEnabledForElement(this.activeElementId)&&(this.resetState(this.activeElementId),this.isEnabledSubject.next([this.activeElementId,!1]))}isEnabled(){return!!this.getActiveElementState()}getNodeProperties(){return eI.imageMaps.map(((e,t)=>new Gi.hF({material:this.scalarVisualizationMaterials[t],zOffset:X.default.getManager().getNumber("PART_FACES_Z_OFFSET"),primitiveType:Ai.MX.TRIANGLES,includedInBlend:!0,clippedBySectionPlanes:!0,isPickable:!1})))}getCurrentVisualizedField(e){return e.getFieldOfType(this.visualizationState.displayedField)}computeDefaultFieldRange(e){const t=this.getBaseUnitsForField(e);let i=null;this.getBaseUnitsForField(e);const s=this.getActiveElementState();if(s){for(const n of s.resultsCache.values()){const s=n.getFieldOfType(e);if(!s)continue;const r=k.dGY.fromMinMax(s.minValue,s.maxValue);r.addUnits(t),i=k.dGY.combine(i,r)}return i?.noRange&&(i.min-=Yf,i.max+=Yf),i}}updateFieldRanges(){for(const e of eI.ENABLED_FIELD_TYPES){const t=this.computeDefaultFieldRange(e);if(!t||Number.isNaN(t.min))continue;const i=this.getVisualizationStateForField(e);if(!i)continue;const{defaultRange:s,visualizationState:n}=i;s.rangeInData=t,s.defaultDisplayRange=t,null===this.getBaseUnitsForField(e)&&(s.defaultDisplayRange=k.dGY.fromMinMax(.05,5)),n.visualizedRange?.noRange&&(n.visualizedRange=s.defaultDisplayRange)}const e=this.getRangeInData();this.updateDefaultDisplayRange(e),this.legend.visualizedFieldType=this.visualizationState.displayedField,this.updateVisualizedScalarRange()}shouldVisualizeBody(e,t){return!!e&&!!e.isSolidBody()}getMeshIncrementForBody(e,t){const i=this.getCurrentVisualizedField(e),{sampleMesh:s}=e,n=new eT(Ai.MX.TRIANGLES,s.points,s.getAnyIndices());return n.packScalarsIntoTextureCoordinates(i.values),n.id=t.getId(),n}getBodyComponent(){return this.modelViewManager?.getDisplayedPartStudio()?.getBodyComponent()}clearScalarVisualizationForVisualizedBodies(){const e=this.getElementState(this.activeElementId);if(!e)return;if(!e.hasScalarVisualizationOccurrences)return;const t=this.getBodyComponent();t&&(t.clearAllScalarVisualizationOccurrences(),e.hasScalarVisualizationOccurrences=!1)}updateGraphicsForBody(e,t,i){if(!i.isComplete)return;const s=i.bodyDeterministicId,n=e.getBodyOccurrenceData(s);if(!n)return;const r=n.getOccurrenceId(),a=e.retrieveBodyMetaData(s);if(!this.shouldVisualizeBody(a,n))return;const o=this.getMeshIncrementForBody(i,a),h=this.meshManager.addMeshIncrement(o,this.meshOwnerId),c=new qT(this.VISUALIZATION_MANAGER_NODE_ID+" "+r);c.onIncrementAdded(h);const l=new mS.bg;a&&l.setAttribute(RS.COLOR,a.getColor());for(let e=0;e<t.length&&e<this.nodes.length;++e)this.nodes[e].addOccurrenceGeometryToNode(t[e],n,l,c);e.setScalarVisualizationOccurrence(r,a.getId());const d=this.getActiveElementState();d&&(d.hasScalarVisualizationOccurrences=!0)}clearGraphics(){this.clearScalarVisualizationForVisualizedBodies(),this.resetMeshes(),super.clearGraphics()}updateGraphics(){if(this.clearGraphics(),!this.isEnabled())return;if(!this.viewerIsInScalarVisualizationRenderMode())return;const e=this.getActiveElementState()?.resultsCache;if(!e)return;if(ks())return;if(this.hasActiveSketch())return;const t=this.getNodeProperties(),i=this.getBodyComponent();if(i&&0!==e.size){this.cursorAppendage||(this.cursorAppendage=new as(this.getViewer(),((e,t)=>this.getCursorText(e,t))));for(const s of e.values())s&&s.isComplete&&(s.result.fields.length<1||this.updateGraphicsForBody(i,t,s));this.updateColorMapping(null,this.displayedColorMap),this.getViewer().requestDraw()}}getCurrentMicroversionIdAndConfiguration(){return this.modelViewManager.getDisplayedElementMicroversionIdAndConfiguration()}onPartStudioDisplayDataChanged(e){if(e.elementId===this.activeElementId&&!e.isNoop&&this.viewerIsInScalarVisualizationRenderMode()){for(const e of this.displayDataFunctionQueue)e();if(this.displayDataFunctionQueue=[],e.usage===k.rvN.BASE){if(this.hasActiveSketch())this.clearGraphics();else if(!e.microversionIdAndConfigurationInterval.isEmptyInterval())return e.hasPartGeometryChanges()?void this.reactivate(e.elementId):(this.updateLastMicroversionIdAndConfiguration(e.microversionIdAndConfigurationInterval.to),void(this.getActiveElementState()?.hasScalarVisualizationOccurrences||this.updateGraphics()))}else this.clearGraphics()}}hasDefinedRange(){const e=this.visualizedScalarRange;return!!e&&(void 0!==e.min&&void 0!==e.max)}readyToShowLegend(){return!!this.legend&&(!!this.viewerIsInScalarVisualizationRenderMode()&&(!!this.isEnabled()&&(!!this.hasDefinedRange()&&(!!this.hasAnyDisplayableResults()&&(!this.hasActiveSketch()&&(!ks()&&!!this.getBodyComponent()))))))}hasAnyDisplayableResults(){for(const e of this.getActiveElementState().resultsCache.values())if(e.isComplete)return!0;return!1}getBaseUnitsForField(e){switch(Jf.get(e)){case $f.LENGTH:return Ir.ML.MILLIMETER;case $f.UNITLESS:return null}}getCurrentBaseUnits(){const e=this.getActiveVisualizedField();return null===e?null:this.getBaseUnitsForField(e)}getDisplayUnitsForField(e){switch(Jf.get(e)){case $f.LENGTH:return(0,fr.vx)().getLengthUnits();case $f.UNITLESS:return null}}getCurrentDisplayUnits(){return this.getDisplayUnitsForField(this.getActiveVisualizedField())}convertRangeToUnits(e,t){return t?(0,Ir.vM)(e,t):k.dGY.fromMinMax(100*e.min,100*e.max)}getRangeInDisplayUnits(e){const t=this.getCurrentDisplayUnits();if(!e)return null;return this.convertRangeToUnits(e,t)}convertValueBetweenDisplayAndBaseUnits(e,t){const i=this.getCurrentDisplayUnits();if(!i)return t?e/100:100*e;const s=this.getCurrentBaseUnits();return t?(0,Ir.WR)(e,i,s):(0,Ir.WR)(e,s,i)}getUseMinValueHighlight(){return!!this.isDisplayingGradientField()||k.dGY.isMinChanged(this.getDefaultDisplayRange(),this.visualizedScalarRange,Ri.W.ZERO_LENGTH)}getUseMaxValueHighlight(){return k.dGY.isMaxChanged(this.getDefaultDisplayRange(),this.visualizedScalarRange,Ri.W.ZERO_LENGTH)}getUseDimColorScale(){return this.visualizationState.dimColorScale}setUseDimColorScale(e){this.visualizationState.dimColorScale=e,this.updateScalarRangeUniforms(),this.updateGraphics()}reactivate(e){if(e===this.activeElementId){const e=this.getCurrentMicroversionIdAndConfiguration(),t=this.getActiveElementState().lastMicroversionIdAndConfiguration;if(!e)return;if(e.equals(t))return void this.updateGraphics()}es.Jq.ThicknessAnalysisService.updateVisualization(e)}getIsEnabledObservable(){return this.isEnabledSubject.asObservable()}getBodyFilter(){return this.bodyFilter||(this.bodyFilter=(0,qf.v)([(0,cs._x)(k.ZSW.BODY),(0,cs.NC)(k.wG2.SOLID),(0,cs.O6)(!0),(0,cs.II)()])),this.bodyFilter}isDisplayingGradientField(){return this.visualizationState?.isDisplayingGradientField()??!1}getMinHighlightColor(){if(this.isDisplayingGradientField()){const e=X.default.getManager(),t=this.getColorMappingName();return e.getColor(Dc.DIM_COLOR_CONSTANT+t)}return super.getMinHighlightColor()}setActiveElementId(e){this.activeElementId!==e&&this.runAfterNextDisplayDataUpdate((()=>{this.updateFieldRanges(),this.updateVisualizationState()})),this.activeElementId=e}runAfterNextDisplayDataUpdate(e){this.displayDataFunctionQueue.push(e)}onDocumentDestroyed(){this.resetState(this.activeElementId),this.elementIdToElementState.clear()}}eI.ENABLED_FIELD_TYPES=[k.DDL.ROLLING_BALL_THICKNESS,k.DDL.RAY_THICKNESS,k.DDL.ROLLING_BALL_THICKNESS_DERIVATIVE,k.DDL.RAY_THICKNESS_DERIVATIVE];var tI=i(67604),iI=i(9851),sI=i(99454),nI=i(51962),rI=i(11653),aI=i(1509);const oI=new Gi.hF({material:new Bi,zOffset:X.default.getManager().getNumber("PART_FACES_Z_OFFSET"),primitiveType:Ai.MX.TRIANGLES,includedInBlend:!0,clippedBySectionPlanes:!0,isPickable:!1,primitivesHaveTransparency:!0});oI.material?.setCustomFloatUniform("uOcclusionFactor",0);const hI=oI.cloneAndModify({primitivesHaveTransparency:!1});class cI{constructor(e){this.modelViewManager=e,this.meshOwnerId=JT(),this.runningMultiPart=null,this.previewCache=new Map,this.getViewer().getEventDispatcher().on(os.t0J,(()=>this.onAssemblyDisplayed())),(0,mr.m)().on(pr.C.GET_GENERATIVE_INPUT_TRS,(()=>this.getGenerativeInputTrs())),(0,mr.m)().on(pr.C.CANCEL_GENERATIVE_RUN,(()=>this.cancelGenerativeRun()))}onChangeActiveElement(){this.clearGraphics()}getCachedResponseForElementId(e){return this.previewCache.get(e)}cacheResponse(e){if(!e.hasResults()){const t=this.getCachedResponseForElementId(e.elementId);t?.hasResults()&&(e.generativeFeatureIdToResult=t.generativeFeatureIdToResult)}this.previewCache.set(e.elementId,e)}resetCache(e){const t=new k.ZjL;t.completionPercentage=0,this.previewCache.set(e,t)}restorePreviewForActiveElement(){const e=this.getCachedResponseForElementId(this.getViewer().getActiveElementId());e&&this.displayGenerativeResponse(e)}onAssemblyDisplayed(){this.restorePreviewForActiveElement()}getViewer(){return this.modelViewManager.getViewer()}runGenerative(e){if(0===e.size)return es.Jq.MessageBubbleService.showMessageWithAutoDismiss(i18n("No generative features detected."),"warning"),void es.Jq.AngularEventService.ensureDigest();this.generativeRunStart=new Date;const t=new k.ijO;t.generativeFeatureIds=[...e],t.skipCompute=!1,t.elementId=this.getViewer().getActiveElementId(),this.runningMultiPart=t.generativeFeatureIds.length>1,this.updateGraphics(),this.resetCache(t.elementId),this.updateBeeper(0),tI.Op.getConnection(tI.tl).send(t)}updateGraphics(){this.clearGraphics()}displayGenerativeResponse(e){if(Object.values(e.generativeFeatureIdToResult).length>0&&this.drawPreview(e),e.isRunComplete)return this.beeper?.stopBeeper(),void(this.beeper=null);this.updateBeeper(e.completionPercentage)}onFgsErrorInfo(e){this.clearGraphics();const t=i18n("Generative returned an error: __errorText__",{errorText:e.errorText});es.Jq.MessageBubbleService.showMessageWithWarning(t),es.Jq.AngularEventService.ensureDigest(),iI.log.warn(t),this.generativeRunStart&&(iI.log.debug(`generative.onFgsErrorInfo: Generative run finished exceptionally. Client-side timing information: ${rI.B.withStartTime(this.generativeRunStart)}`),this.generativeRunStart=null)}onGenerativeResponse(e){this.getViewer().getActiveElementId()===e.elementId&&this.displayGenerativeResponse(e),this.cacheResponse(e),e.isRunComplete&&this.generativeRunStart&&(iI.log.debug(`generative.onGenerativeResponse: Generative run completed. Client-side timing information: ${rI.B.withStartTime(this.generativeRunStart)}`),this.generativeRunStart=null)}updateBeeper(e,t){let i;if(t)i=t;else if(e){const t=(0,Er.roundTo)(e,2);i=this.runningMultiPart?i18n("Generating designs (__roundedPercentage__%)",{roundedPercentage:t}):i18n("Generating design (__roundedPercentage__%)",{roundedPercentage:t})}else i=this.runningMultiPart?i18n("Generating designs"):i18n("Generating design");if(this.beeper)this.beeper.setExplanation(i);else{const e=new nI.e("generativeDesign").setImportant(i);this.beeper=(0,sI.l)().startTaskBeeper(this.getViewer().getActiveElementId(),e)}}resetMeshes(){this.meshManager?.destroy(),this.meshManager=new eD(this.getViewer(),{bufferAllocationPolicy:AE.MAXIMUM})}clearGraphics(){this.resetScenegraphNode(),this.resetMeshes(),this.beeper?.stopBeeper(),this.beeper=null,this.getViewer().requestDraw()}resetScenegraphNode(){this.previewNode?.remove(),this.previewNode=new Gi.NB(cI.PREVIEW_NODE_ID,oI),this.previewNode.setVisible(!1),this.modelViewManager.getSharedBodyNode().addChild(this.previewNode)}drawPreview(e){const t=this.getViewer().getOccurrenceIdManager(),i=this.getViewer().getOccurrenceDataManager(),s=this.modelViewManager.getDisplayedAssembly();if(s&&s.elementId===e.elementId){for(const n of Object.values(e.generativeFeatureIdToResult)){const r=n.preview.sampleMesh,a=new eT(Ai.MX.TRIANGLES,r.points,r.getAnyIndices());(0,Yd.wK)(a),a.replicateTextureCoordinate([0,0]);for(const r of n.relatedOccurrences){this.modelViewManager.setOccurrenceAlphaModifier(r,os.M81);const n=r.getPathAsString(),o=t.getIdForName(n);if(o===TE.Qy){iI.log.warn("No occurrence id for "+n);continue}const h=i.getOccurrenceData(o);h||iI.log.warn("No occurrence data for "+n);const c=s.getOccurrenceDisplayData(r);if(!c){iI.log.warn("No occurrence display data for "+n);continue}const l=this.modelViewManager.getPartStudioDataFromOccurrence(r);if(!l){iI.log.debug("No part studio for occurrence "+n);continue}a.id=n;const d=this.meshManager.addMeshIncrement(a,this.meshOwnerId),u=new qT("Generated "+n);u.onIncrementAdded(d);const g=l.retrieveBodyMetaData(c.partIds[0]),p=new mS.bg;g&&p.setAttribute(RS.COLOR,g.getColor());const m=e.isRunComplete?hI:oI;if(this.previewNode.addOccurrenceGeometryToNode(m,h,p,u),this.debugMeshEdges){const e=(0,Yd.EK)(a,a.id+".edges"),t=this.meshManager.addMeshIncrement(e,this.meshOwnerId),i=new qT("Generated "+n+" edges");i.onIncrementAdded(t),this.previewNode.addOccurrenceGeometryToNode(pm,h,null,i)}}}this.previewNode.setVisible(!0),this.getViewer().requestDraw()}else iI.log.debug("Tried to display generative response in the wrong element")}getGenerativeInputTrs(){if(!es.Jq.CapabilitiesService.checkGenerativeDesignCurrentlyEnabled())return;if(this.requestedInputTrsForAssembly){const e=i18n("Still waiting on an input TRS for __assemblyName__.",{assemblyName:this.requestedInputTrsForAssembly});es.Jq.MessageBubbleService.showMessageWithWarning(e)}const e=gi._3.getOpenDocumentController();if(!e)return;const t=e.getActiveAssemblyModel();if(!t)return;const i=e.getElementConnection();if(!i)return;this.updateBeeper(0,i18n("Generating input TRS..."));const s=new k.ijO;s.generativeFeatureIds=t.getUnsuppressedGenerativeFeatures().map((e=>e.featureId)),s.skipCompute=!0,s.elementId=this.getViewer().getActiveElementId(),i.send(s),this.requestedInputTrsForAssembly=t.getName()}onComputedDataResponse(e){this.requestedInputTrsForAssembly?((0,aI.G)(new Blob([e.computedData]),`${this.requestedInputTrsForAssembly}_generative_input.trs`),this.requestedInputTrsForAssembly=null,this.beeper?.stopBeeper(),this.beeper=null):iI.log.warn("Received unexpected BTFgsComputedDataResponse")}cancelGenerativeRun(){if(!es.Jq.CapabilitiesService.isDebugEnabled())return;const e=new k.eng;e.elementId=this.getViewer().getActiveElementId(),gi._3.getOpenDocumentController().getElementConnection().send(e)}}cI.PREVIEW_NODE_ID="GenerativeDesignPreview";var lI=i(68734),dI=i(60137);class uI extends dI.W{constructor(){super("/js/GraphicsWebAssemblyUtils.js","createGraphicsUtilsModule")}static get module(){return uI.singleton||(uI.singleton=new uI),uI.singleton}replaySampleMeshRefinementRoutine(e,t){const i=new Ih.B7("GraphicsWebAssemblyUtils.replaySampleMeshRefinementRoutine"),s=this.copyFloat32ArrayToWasmHeap(e.points),n=this.copyInt32ArrayToWasmHeap(e.intIndices),r=this.copyTypedUint8ArrayToWasmHeap(t.history),a=this.module.replaySampleMeshRefinementRoutine(s,e.points.length,n,e.intIndices.length,r,t.recordCount),o=new k.JW9;return o.points=this.copyFloat32ArrayFromWasmHeap(a.getPointsLocation(),a.getPointsSize()),o.intIndices=this.copyInt32ArrayFromWasmHeap(a.getIndicesLocation(),a.getIndicesSize()),this.free(s),this.free(n),this.free(r),a.delete(),i.report(),o}}var gI=i(46165);const pI={blitFunctions:i(33998).Z,compareFunctions:i(44562).Z,constants:i(58091).Z,contactVisualizationFunctions:i(3041).Z,cosmeticThreadFunctions:i(34596).Z,decalFunctions:i(84175).Z,depthNormalFunctions:i(49863).Z,edgeFragmentUtilityFunctions:i(44387).Z,edgeUtilityFunctions:i(67044).Z,fragmentCurvatureUtilityFunctions:i(27007).Z,fragmentLightingUtilityFunctions:i(27797).Z,"fs-OITAccumulation":i(77129).Z,"fs-OITAccumulation-faces":i(77129).Z,"fs-OITAccumulation-faces-contact":i(85592).Z,"fs-OITAccumulation-faces-decals":i(55545).Z,"fs-OITAccumulation-faces-cosmeticThreads":i(94379).Z,"fs-OITAccumulation-edges":i(18257).Z,"fs-OITAccumulation-silhouettes":i(18350).Z,"fs-OITComposite":i(78568).Z,"fs-OITRevealage":i(12237).Z,"fs-OITRevealage-faces":i(12237).Z,"fs-OITRevealage-faces-contact":i(69497).Z,"fs-OITRevealage-faces-decals":i(80710).Z,"fs-OITRevealage-faces-cosmeticThreads":i(55492).Z,"fs-OITRevealage-edges":i(83351).Z,"fs-OITRevealage-silhouettes":i(15426).Z,"fs-backfacesil-faces":i(77541).Z,"fs-blitBodyCheck":i(90112).Z,"fs-compareBlend":i(29731).Z,"fs-debugPickPass":i(81130).Z,"fs-depth-edges":i(51534).Z,"fs-depth-faces":i(7121).Z,"fs-depth-points":i(39029).Z,"fs-draftAngle-faces":i(57006).Z,"fs-draftShadow-faces":i(19108).Z,"fs-draw-draftAnalysis":i(58204).Z,"fs-draw-edges":i(83351).Z,"fs-draw-endcap":i(45205).Z,"fs-draw-endcap-depth":i(94085).Z,"fs-draw-faces":i(81444).Z,"fs-draw-faces-contact":i(60162).Z,"fs-draw-faces-decals":i(89185).Z,"fs-draw-faces-cosmeticThreads":i(95354).Z,"fs-draw-faces-scalarVisualization":i(18169).Z,"fs-draw-points":i(19950).Z,"fs-draw-qualityVisualization":i(92884).Z,"fs-draw-silhouettes":i(15426).Z,"fs-draw-zebraStripes":i(96002).Z,"fs-drawTexture":i(61200).Z,"fs-edgeDetect":i(86862).Z,"fs-endcapMask-faces":i(55458).Z,"fs-endcapMask-faces-simulation":i(92090).Z,"fs-gaussianFilter":i(98635).Z,"fs-highlightBuffer-faces":i(37259).Z,"fs-highlightDraw-edges":i(50936).Z,"fs-highlightDraw-points":i(25552).Z,"fs-highlightDraw":i(97769).Z,"fs-highlightMask-faces":i(18627).Z,"fs-normalDepth-faces":i(93287).Z,"fs-normalDepthFilter":i(38975).Z,"fs-normalDepthWithMask-edges":i(46547).Z,"fs-normalDepthWithMask-faces":i(5285).Z,"fs-normalDepthWithMask-points":i(34456).Z,"fs-occlusion":i(74421).Z,"fs-occlusionFilter":i(1132).Z,"fs-pick-alternates-edges":i(46554).Z,"fs-pick-alternates-faces":i(7185).Z,"fs-pick-edges":i(94197).Z,"fs-pick-endcap":i(1181).Z,"fs-pick-faces":i(5821).Z,"fs-pick-points":i(32003).Z,"fs-planeId-faces":i(37702).Z,"fs-previewBlend":i(7793).Z,"fs-retrieveScalar-faces":i(21305).Z,"fs-tintByDepth-edges":i(38656).Z,"fs-tintByDepth-points":i(74762).Z,"fs-tintByNormalDepth-faces":i(36463).Z,"fs-tintByNormalDepth-faces-decals":i(53002).Z,"fs-tintByNormalDepth-faces-cosmeticThreads":i(49909).Z,"fs-tintByPlaneId-faces":i(62336).Z,getNormalSign:i(10097).Z,highlightFunctions:i(42398).Z,normalDepthWithMaskFunctions:i(23601).Z,picking:i(2958).Z,planeIdFunctions:i(3830).Z,pointFragmentUtilityFunctions:i(64918).Z,sectionPlaneClippingFunctions:i(54625).Z,sectionPlaneConstants:i(34826).Z,sectionPlaneEndcapFunctions:i(19461).Z,sectionPlaneEndcapMedianFilter:i(32651).Z,sectionPlaneEndcapPatternFunctions:i(98808).Z,sectionPlaneFragmentUtilityFunctions:i(42549).Z,setContactVaryings:i(43589).Z,undercutWeightFunction:i(2749).Z,utilityFunctions:i(55667).Z,vertexPicking:i(54957).Z,vertexUtilityFunctions:i(32454).Z,"vs-OITAccumulation":i(10808).Z,"vs-OITAccumulation-faces":i(10808).Z,"vs-OITAccumulation-faces-contact":i(54987).Z,"vs-OITAccumulation-faces-decals":i(36479).Z,"vs-OITAccumulation-faces-cosmeticThreads":i(22939).Z,"vs-OITAccumulation-edges":i(97068).Z,"vs-OITAccumulation-silhouettes":i(97414).Z,"vs-OITComposite":i(73070).Z,"vs-OITRevealage":i(89968).Z,"vs-OITRevealage-faces":i(89968).Z,"vs-OITRevealage-faces-contact":i(15539).Z,"vs-OITRevealage-faces-decals":i(94669).Z,"vs-OITRevealage-faces-cosmeticThreads":i(69441).Z,"vs-OITRevealage-edges":i(97068).Z,"vs-OITRevealage-silhouettes":i(97414).Z,"vs-backfacesil-faces":i(20019).Z,"vs-blitBodyCheck":i(70124).Z,"vs-compareBlend":i(4570).Z,"vs-debugPickPass":i(18773).Z,"vs-depth-edges":i(19554).Z,"vs-depth-faces":i(70183).Z,"vs-depth-points":i(83221).Z,"vs-draftAngle-faces":i(16253).Z,"vs-draftShadow-faces":i(98977).Z,"vs-draw-draftAnalysis":i(36179).Z,"vs-draw-edges":i(97068).Z,"vs-draw-endcap":i(75868).Z,"vs-draw-endcap-depth":i(53106).Z,"vs-draw-faces":i(72203).Z,"vs-draw-faces-contact":i(41578).Z,"vs-draw-faces-decals":i(23463).Z,"vs-draw-faces-cosmeticThreads":i(62796).Z,"vs-draw-faces-scalarVisualization":i(47102).Z,"vs-draw-points":i(1194).Z,"vs-draw-qualityVisualization":i(87525).Z,"vs-draw-silhouettes":i(97414).Z,"vs-draw-zebraStripes":i(68572).Z,"vs-drawTexture":i(44209).Z,"vs-edgeDetect":i(4049).Z,"vs-endcapMask-faces":i(75810).Z,"vs-endcapMask-faces-simulation":i(62056).Z,"vs-gaussianFilter":i(82806).Z,"vs-highlightBuffer-faces":i(18466).Z,"vs-highlightDraw-edges":i(51761).Z,"vs-highlightDraw-points":i(58496).Z,"vs-highlightDraw":i(81906).Z,"vs-highlightMask-faces":i(3905).Z,"vs-normalDepth-faces":i(43570).Z,"vs-normalDepthFilter":i(87243).Z,"vs-normalDepthWithMask-edges":i(27637).Z,"vs-normalDepthWithMask-faces":i(20767).Z,"vs-normalDepthWithMask-points":i(51996).Z,"vs-occlusion":i(65545).Z,"vs-occlusionFilter":i(34752).Z,"vs-pick-alternates-edges":i(65912).Z,"vs-pick-alternates-faces":i(39902).Z,"vs-pick-edges":i(35383).Z,"vs-pick-endcap":i(98763).Z,"vs-pick-faces":i(23305).Z,"vs-pick-points":i(85426).Z,"vs-planeId-faces":i(71772).Z,"vs-previewBlend":i(85135).Z,"vs-retrieveScalar-faces":i(71386).Z,"vs-tintByDepth-edges":i(26133).Z,"vs-tintByDepth-points":i(17206).Z,"vs-tintByNormalDepth-faces":i(25887).Z,"vs-tintByNormalDepth-faces-decals":i(68355).Z,"vs-tintByNormalDepth-faces-cosmeticThreads":i(64644).Z,"vs-tintByPlaneId-faces":i(24428).Z,weightFunctions:i(93991).Z},mI=_e.O.createLogger("ShaderProgram",k.bVy.GRAPHICS),fI=1,II=0;var EI;!function(e){e.SKIP_SECTION_PLANES="SKIP_SECTION_PLANES",e.USE_OCCURRENCE_TEXTURE="USE_OCCURRENCE_TEXTURE",e.USE_SECTION_PLANES="USE_SECTION_PLANES",e.USE_VERTEX_HIGHLIGHT_TEXTURE="USE_VERTEX_HIGHLIGHT_TEXTURE",e.DERIVATIVES_SUPPORTED="DERIVATIVES_SUPPORTED",e.LOOP_BREAK_SUPPORTED="LOOP_BREAK_SUPPORTED",e.OIT_SHADER="OIT_SHADER"}(EI||(EI={}));const SI="-nosection";function TI(e,t){return t?"#define "+e+" 1\n":""}let DI=null;function CI(e){return e.includes("vs-OIT")&&(e.includes("edges")||e.includes("silhouettes"))}function MI(e,t){if(DI&&!t)return;if(!pI)return;const i=(0,z.Z)(pI);for(const e in i){let t=i[e];const s=/{{{.*}}}/g;let n=0,r=s.exec(t);for(;r;){const a=r[0].substr(3,r[0].length-6);if(!i.hasOwnProperty(a)){mI.warn("Missing shader include: "+a);break}const o=r.index+r[0].length;t=t.substr(0,r.index)+i[a]+t.substr(o,t.length-o),++n>100&&mI.warn("Encountered a large number of includes while substituting shader "+e+". An include cycle may have been introduced."),s.lastIndex=0,r=s.exec(t)}i[e]=t}DI={};let s=TI(EI.USE_SECTION_PLANES,e.supportsGraphicalSectionPlanes());s+=TI(EI.USE_VERTEX_HIGHLIGHT_TEXTURE,e.areHighlightVertexTexturesSupported()),s+=TI(EI.DERIVATIVES_SUPPORTED,e.areShaderDerivativesSupported()),s+=TI(EI.LOOP_BREAK_SUPPORTED,!(0,pt.isPlatformMac)()||(0,pt.isBrowserSafari)());const n=s+TI(EI.SKIP_SECTION_PLANES,!0),r=Object.keys(i);for(let e=0;e<r.length;++e){const t=r[e],a=CI(t),o=TI(EI.OIT_SHADER,a),h=i[t];if(DI[t]=s+o+h,t.startsWith("fs-")&&-1!==h.indexOf("discardIfPositionFails")||a){DI[t+SI]=n+h;const e=a?t:"v"+t.substr(1,t.length);e in i&&(DI[e+SI]=n+o+i[e])}}}function yI(e,t){const i=e.indexOf(SI);return i<0?e+"-"+t:e.substr(0,i)+"-"+t+SI}class AI{constructor(e,t,i,s,n=!1,r=1){this.type=e,this.dimension=t,this.offset=i,this.stride=s,this.normalize=n,this.secondDimension=r,this.columnStride=kt(this.type)*this.dimension}clone(){return new AI(this.type,this.dimension,this.offset,this.stride,this.normalize,this.secondDimension)}offsetForColumn(e){return this.offset+e*this.columnStride}get multiDimensionStride(){return this.stride+this.secondDimension*this.columnStride}get elementCount(){return this.dimension*this.secondDimension}}function PI(e){const t="vs"+e,i="fs"+e;return DI.hasOwnProperty(t)&&DI.hasOwnProperty(i)}class OI extends m.T{constructor(e,t){super(),this.viewer=e,this.id=t,this.vertexShader=null,this.fragmentShader=null,this.shaderProgram=null,this.uniformLocations={},this.attribLocations={},this.boundTextures={},this.shaderValidated=!1,this.disableVertexAttribArrayIfVaoUnavailable=null,(0,Sh.Yk)(e),this.listenTo(this.viewer.getEventDispatcher(),nM.cW,this.onGlContextLost),this.listenTo(this.viewer.getEventDispatcher(),nM.pO,this.onGlContextRestored),this.listenTo(this.viewer.getEventDispatcher(),nM.so,this.destroy),this.reinitialize(),this.disableVertexAttribArrayIfVaoUnavailable=this.viewer.areVertexArrayObjectsAvailable?e=>{}:e=>this.enableVertexAttribArray(e,!1),this.numericId=++OI.numericIdIncrementer}getId(){return this.id}getNumericId(){return this.numericId}destroy(){this.stopListening(),this.clearGlReferences()}clearGlReferences(){this.shaderValidated=!1,this.shaderProgram=null,this.vertexShader=null,this.fragmentShader=null,this.uniformLocations={},this.attribLocations={}}onGlContextLost(){this.clearGlReferences()}onGlContextRestored(){this.reinitialize()}reinitialize(){this.initializationFailed||(this.clearGlReferences(),this.viewer.getGlContext()&&(this.shaderProgram=this.initProgram()),this.unbindTextures())}equals(e){return null!==e&&this.id===e.id}deactivate(){if(!this.viewer.areVertexArrayObjectsAvailable)for(const e in this.attribLocations)this.enableVertexAttribArray(e,!1);this.unbindTextures()}unbindTextures(){for(const e in this.boundTextures)So(this.viewer,e);this.boundTextures={}}makeShader(e,t){const i=DI[e];if(!i||i.length<1)return mI.warn('Shader "'+e+'" not found'),null;const s=this.viewer.getGlContext();if(!s)return null;const n=s.createShader(t);return s.shaderSource(n,i),s.compileShader(n),n}getVertexShaderId(){return"vs"+this.id}getFragmentShaderId(){return"fs"+this.id}get initializationFailed(){return this.viewer.badShaders.hasOwnProperty(this.id)}set initializationFailed(e){e?this.viewer.badShaders[this.id]=!0:delete this.viewer.badShaders[this.id]}initProgram(){if(this.initializationFailed)return null;const e=this.viewer.getGlContext();if(this.vertexShader=this.makeShader(this.getVertexShaderId(),e.VERTEX_SHADER),this.fragmentShader=this.makeShader(this.getFragmentShaderId(),e.FRAGMENT_SHADER),!this.vertexShader||!this.fragmentShader)return this.initializationFailed=!0,null;const t=e.createProgram();return e.attachShader(t,this.vertexShader),e.attachShader(t,this.fragmentShader),e.bindAttribLocation(t,0,PS.POSITION),e.linkProgram(t),t}validateProgram(){if(this.shaderValidated)return;this.validateShader(this.vertexShader,this.getVertexShaderId()),this.validateShader(this.fragmentShader,this.getFragmentShaderId());const e=this.viewer.getGlContext();try{if(!e.getProgramParameter(this.shaderProgram,e.LINK_STATUS)&&!e.isContextLost()){this.clearGlReferences();const t=e.getProgramInfoLog(this.shaderProgram);mI.warn(cM+"Could not link shaders for "+this.id+":\n "+t),RI(this.getVertexShaderId()),RI(this.getFragmentShaderId()),this.initializationFailed=!0}}catch(e){this.initializationFailed=!0,mI.warn(cM+"Could not link shaders for "+this.id+", and log info retrieval failed. (Try in a different browser to see if it gives you more details.)")}this.shaderValidated=!0}validateShader(e,t){const i=this.viewer.getGlContext();try{e&&(i.getShaderParameter(e,i.COMPILE_STATUS)||i.isContextLost())||(mI.warn(cM+"Error compiling shader "+t+":\n"+i.getShaderInfoLog(e)),RI(t))}catch(e){mI.debug(cM+"Error getting shader info for: "+t+":\n"+e)}}ensureShaderIsInitialized(){this.shaderProgram||this.reinitialize()}useShader(){this.ensureShaderIsInitialized(),this.validateProgram(),this.viewer.getGlContext().useProgram(this.shaderProgram)}getUniformLocation(e){this.ensureShaderIsInitialized();let t=this.uniformLocations[e];return void 0!==t||(t=this.initializationFailed?null:this.viewer.getGlContext().getUniformLocation(this.shaderProgram,e),this.uniformLocations[e]=t),t}hasUniform(e){return!!this.getUniformLocation(e)}outputUniforms(){const e=this.viewer.getGlContext();let t=e.getProgramParameter(this.shaderProgram,e.ACTIVE_UNIFORMS);if(isNaN(t))return;t=+t.toString(),mI.debug("Uniforms for shader: "+this.id);const i=function(e){let t="<";for(let i=0;i<e.length;++i)t+=e[i],i<e.length-1&&(t+=", ");return t+=">",t};for(let s=0;s<t;++s){const t=e.getActiveUniform(this.shaderProgram,s);if(t){let s=e.getUniform(this.shaderProgram,this.getUniformLocation(t.name));(s instanceof Float32Array||s instanceof Int32Array||s instanceof Array)&&(s=i(s)),mI.debug("  Uniform: "+t.name+", size: "+t.size+", type: "+t.type+", value: "+s)}}}outputAttributes(){const e=this.viewer.getGlContext();let t=e.getProgramParameter(this.shaderProgram,e.ACTIVE_ATTRIBUTES);if(isNaN(t))return;const i=["VERTEX_ATTRIB_ARRAY_BUFFER_BINDING","VERTEX_ATTRIB_ARRAY_ENABLED","VERTEX_ATTRIB_ARRAY_SIZE","VERTEX_ATTRIB_ARRAY_STRIDE","VERTEX_ATTRIB_ARRAY_TYPE","VERTEX_ATTRIB_ARRAY_NORMALIZED","CURRENT_VERTEX_ATTRIB"];t=+t.toString(),mI.debug("Attributes for shader: "+this.id);for(let s=0;s<t;++s){const t=e.getActiveAttrib(this.shaderProgram,s);if(t){const n=this.getAttribLocation(t.name);mI.debug("  Attribute "+s+": "+t.name+", size: "+t.size+", type: "+t.type),mI.debug("    Location: "+n),mI.debug("    Pointer offset: "+e.getVertexAttribOffset(n,e.VERTEX_ATTRIB_ARRAY_POINTER));for(let t=0;t<i.length;++t){const s=i[t],r=e.getVertexAttrib(n,e[s]);"CURRENT_VERTEX_ATTRIB"===s?mI.debug("    "+s+" : ["+r[0]+", "+r[1]+", "+r[2]+", "+r[3]+"]"):mI.debug("    "+s+" : "+r)}}}}getAttribLocation(e){this.ensureShaderIsInitialized();let t=this.attribLocations[e];return void 0!==t||(t=this.initializationFailed?-1:this.viewer.getGlContext().getAttribLocation(this.shaderProgram,e),this.attribLocations[e]=t),t}hasAttribute(e){return this.getAttribLocation(e)>=0}vertexAttribPointer(e,t){const i=this.getAttribLocation(e);if(i<0)return;const s=this.viewer.getGlContext();if(1===t.secondDimension)s.vertexAttribPointer(i,t.dimension,t.type,t.normalize,t.stride,t.offset);else for(let e=0;e<t.secondDimension;++e)s.vertexAttribPointer(i+e,t.dimension,t.type,t.normalize,t.multiDimensionStride,t.offsetForColumn(e));this.enableVertexAttribArray(e,!0,t.secondDimension)}enableVertexAttribArray(e,t,i){void 0===t&&(t=!0);const s=this.getAttribLocation(e);if(!(s<0))if(i)for(let e=0;e<i;++e)this.viewer.enableVertexAttributeArray(s+e,t);else this.viewer.enableVertexAttributeArray(s,t)}useTexture(e,t){if(!this.hasUniform(e))return;let i;i=t instanceof Io?t.updateAndBindTexture(e):Eo(this.viewer,t,e),i<0?this.useBlankTexture(e):(this.boundTextures[e]=i,this.uniform1i(e,i))}setAttribute(e,t){switch(e.dimension){case 1:this.vertexAttrib1f(e.name,t);break;case 2:this.vertexAttrib2fv(e.name,t);break;case 3:this.vertexAttrib3fv(e.name,t);break;case 4:this.vertexAttrib4fv(e.name,t)}}setFloatUniform(e,t){switch(t.length){case 2:this.uniform2fv(e,t);break;case 3:this.uniform3fv(e,t);break;case 4:this.uniform4fv(e,t);break;default:this.uniform1f(e,t)}}setIntUniform(e,t){switch(t.length){case 2:this.uniform2iv(e,t);break;case 3:this.uniform3iv(e,t);break;case 4:this.uniform4iv(e,t);break;default:this.uniform1i(e,t)}}setMatrixUniform(e,t,i=!1){switch(t.length){case 16:this.uniformMatrix4fv(e,i,t);break;case 9:this.uniformMatrix3fv(e,i,t);break;case 4:this.uniformMatrix2fv(e,i,t);break;default:mI.debug(`Unsupported matrix size in setMatrixUniform. ${e}, length: ${t.length}`)}}setVectorUniform(e,t){switch(t.length){case 4:this.uniform4fv(e,t);break;case 3:this.uniform3fv(e,t);break;case 2:this.uniform2fv(e,t);break;default:mI.debug(`Unsupported vector size in setVectorUniform. ${e}, length: ${t.length}`)}}useBlankTexture(e){if(!this.hasUniform(e))return;const t=this.viewer.getResources().getBlankTexture().updateAndBindTexture(e);t>=0&&(this.boundTextures[e]=t,this.uniform1i(e,t))}uniform1f(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform1f(i,t)}uniform1fv(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform1fv(i,t)}uniform1i(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform1i(i,t)}uniform1iv(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform1iv(i,t)}uniform2f(e,t,i){const s=this.getUniformLocation(e);null!==s&&this.viewer.getGlContext().uniform2f(s,t,i)}uniform2fv(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform2fv(i,t)}uniform2i(e,t,i){const s=this.getUniformLocation(e);null!==s&&this.viewer.getGlContext().uniform2i(s,t,i)}uniform2iv(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform2iv(i,t)}uniform3f(e,t,i,s){const n=this.getUniformLocation(e);null!==n&&this.viewer.getGlContext().uniform3f(n,t,i,s)}uniform3fv(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform3fv(i,t)}uniform3i(e,t,i,s){const n=this.getUniformLocation(e);null!==n&&this.viewer.getGlContext().uniform3i(n,t,i,s)}uniform3iv(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform3iv(i,t)}uniform4f(e,t,i,s,n){const r=this.getUniformLocation(e);null!==r&&this.viewer.getGlContext().uniform4f(r,t,i,s,n)}uniform4fv(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform4fv(i,t)}uniform4i(e,t,i,s,n){const r=this.getUniformLocation(e);null!==r&&this.viewer.getGlContext().uniform4i(r,t,i,s,n)}uniform4iv(e,t){const i=this.getUniformLocation(e);null!==i&&this.viewer.getGlContext().uniform4iv(i,t)}uniformMatrix2fv(e,t,i){const s=this.getUniformLocation(e);null!==s&&this.viewer.getGlContext().uniformMatrix2fv(s,t,i)}uniformMatrix3fv(e,t,i){const s=this.getUniformLocation(e);null!==s&&this.viewer.getGlContext().uniformMatrix3fv(s,t,i)}uniformMatrix4fv(e,t,i){const s=this.getUniformLocation(e);null!==s&&this.viewer.getGlContext().uniformMatrix4fv(s,t,i)}vertexAttrib1f(e,t){const i=this.getAttribLocation(e);i<0||(this.disableVertexAttribArrayIfVaoUnavailable(e),this.viewer.getGlContext().vertexAttrib1f(i,t))}vertexAttrib1fv(e,t){const i=this.getAttribLocation(e);i<0||(this.disableVertexAttribArrayIfVaoUnavailable(e),this.viewer.getGlContext().vertexAttrib1fv(i,t))}vertexAttrib2f(e,t,i){const s=this.getAttribLocation(e);s<0||(this.disableVertexAttribArrayIfVaoUnavailable(e),this.viewer.getGlContext().vertexAttrib2f(s,t,i))}vertexAttrib2fv(e,t){const i=this.getAttribLocation(e);i<0||(this.disableVertexAttribArrayIfVaoUnavailable(e),this.viewer.getGlContext().vertexAttrib2fv(i,t))}vertexAttrib3f(e,t,i,s){const n=this.getAttribLocation(e);n<0||(this.disableVertexAttribArrayIfVaoUnavailable(e),this.viewer.getGlContext().vertexAttrib3f(n,t,i,s))}vertexAttrib3fv(e,t){const i=this.getAttribLocation(e);i<0||(this.disableVertexAttribArrayIfVaoUnavailable(e),this.viewer.getGlContext().vertexAttrib3fv(i,t))}vertexAttrib4f(e,t,i,s,n){const r=this.getAttribLocation(e);r<0||(this.disableVertexAttribArrayIfVaoUnavailable(e),this.viewer.getGlContext().vertexAttrib4f(r,t,i,s,n))}vertexAttrib4fv(e,t){const i=this.getAttribLocation(e);i<0||(this.disableVertexAttribArrayIfVaoUnavailable(e),this.viewer.getGlContext().vertexAttrib4fv(i,t))}}function RI(e){const t=DI[e];if(!t||t.length<1)return void mI.warn('Shader "'+e+'" not found');const i=t.split("\n");for(let e=0;e<i.length;++e)i[e]=e+1+": "+i[e];mI.warn(cM+e+" source:\n"+i.join("\n"))}OI.numericIdIncrementer=0;class wI extends yi.u1{constructor(e,t){super(e),this.POINT_NODE_PROPERTIES=new Gi.hF({primitiveType:Ai.MX.POINTS,isPickable:!1}),this.LINE_NODE_PROPERTIES=new Gi.hF({primitiveType:Ai.MX.LINES,isPickable:!1,addsToBounds:!1});const i=e.getSceneBounds().diameter(),s=X.default.getManager();if(t.point){const e=(0,Yd.Pu)(t.point,void 0,s.getColor("RAY_COLOR"),s.getNumber("RAY_ORIGIN_WIDTH_PX"));this.updateMeshIncrement("point",yi.ZJ,e,this.POINT_NODE_PROPERTIES)}const n=(0,Yd.W5)(t.point,ge.S4.add(ge.S4.scale(t.direction,i,M.create()),t.point),void 0,s.getColor("RAY_COLOR"),s.getNumber("RAY_LINE_WIDTH_PX"));this.updateMeshIncrement("line",yi.ZJ,n,this.LINE_NODE_PROPERTIES)}}const vI=new Gi.hF({primitiveType:Ai.MX.TRIANGLE_STRIP}),_I=new Gi.hF({primitiveType:Ai.MX.LINES});let NI=null,bI=null;class LI extends yi.u1{constructor(e,t,i){super(t),this.primitiveType=e;const s=ue.create();switch(s[12]=32*i.random(),s[13]=18*i.random(),s[14]=18*i.random(),this.setTransform(s),NI||(NI=(0,Yd.E3)(100,100),bI=(0,Yd.sp)(NI)),this.primitiveType){case Ai.MX.TRIANGLE_STRIP:this.updateMeshIncrement("s","s",NI,vI);break;case Ai.MX.LINES:this.updateMeshIncrement("s","s",bI,_I)}}getPrimitiveCount(){switch(this.primitiveType){case Ai.MX.TRIANGLE_STRIP:return NI.getTriangleCount();case Ai.MX.LINES:return bI.getLineCount()}return 0}}class FI{constructor(e,t){this.primitiveType=e,this.viewer=t,this.primitiveCount=0,this.spheres=[],this.randomNumberGenerator=new de.H(0)}addPrimitivesToScene(){let e=0;for(;e<75e4;){const t=new LI(this.primitiveType,this.viewer,this.randomNumberGenerator);this.spheres.push(t),this.primitiveCount+=t.getPrimitiveCount(),e+=t.getPrimitiveCount()}}getPrimitiveCount(){return this.primitiveCount}remove(){for(let e=0;e<this.spheres.length;++e)this.spheres[e].remove();this.spheres=[]}}class xI{constructor(){this.trianglesPerSecond=0,this.trianglesPerSecondMeasurementHaltedEarly=!1,this.linesPerSecond=0,this.linesPerSecondMeasurementHaltedEarly=!1,this.executionTimeMs=0,this.refreshRate=0,this.testSkippedDueToLowRefreshRate=!0}getScore(){return Math.min(this.getModelSize()/BI.getModelSize(),1)}getModelSize(){return(5*this.linesPerSecond+this.trianglesPerSecond)/20}}const BI=new xI;BI.trianglesPerSecond=8e7,BI.linesPerSecond=6e7;const VI=1500,UI=3e3,HI=45;class GI{constructor(){this.deferred=null,this.startTime=null,this.lastFrameTime=null,this.fpsSamples=[]}refreshCallback(){const e=performance.now(),t=e-this.startTime;if(t>=UI){let e=0;for(let t=0;t<this.fpsSamples.length;++t)e+=this.fpsSamples[t];const t=this.fpsSamples.length>0?e/this.fpsSamples.length:0;this.deferred.resolve(t)}else t>VI&&null!==this.lastFrameTime&&this.fpsSamples.push(1e3/(e-this.lastFrameTime)),this.lastFrameTime=e,window.requestAnimationFrame((()=>this.refreshCallback()))}measureRefreshRate(){return this.deferred||(this.deferred=Jr.defer(),this.startTime=window.performance.now(),window.requestAnimationFrame((()=>this.refreshCallback()))),this.deferred.promise}}class kI{constructor(e){this.viewer=e,this.deferred=null,this.frameBuffer=null,this.blitPass=null,this.canvasViewport=y.fromValues(0,0,1,1),this.testViewport=y.fromValues(0,0,1,1),this.startTime=0,this.results=new xI,this.fastFrameThresholdMS=1e3/45}execute(){if(this.deferred)return this.deferred.promise;this.startTime=(0,Xs.Wj)(),this.canvasViewport=this.viewer.getCamera().getViewport(),this.testViewport=y.fromValues(0,0,1280,720),this.viewer.renderContext.pushViewport(this.canvasViewport),this.viewer.getCamera().setViewport(this.testViewport),this.viewer.renderContext.pushViewport(this.testViewport);const e=this.viewer.getGlContext();this.frameBuffer=this.viewer.getOrCreateFrameBuffer(e.UNSIGNED_BYTE,"",{storageType:e.DEPTH_STENCIL,attachmentType:e.DEPTH_STENCIL_ATTACHMENT}),this.frameBuffer.update(this.viewer.renderContext),this.viewer.renderContext.popViewport(),this.blitPass=new S(this.viewer,this.frameBuffer),this.deferred=Jr.defer();return(new GI).measureRefreshRate().then((e=>{this.results.refreshRate=e,e<HI?(this.results.testSkippedDueToLowRefreshRate=!0,this.resolve()):(this.results.testSkippedDueToLowRefreshRate=!1,this.measureTrianglesPerSecond())})),this.deferred.promise}resolve(){this.frameBuffer.destroy(),this.viewer.renderContext.popViewport(),this.results.executionTimeMs=(0,Xs.Es)(this.startTime),this.deferred.resolve(this.results)}measureFrameTime(e){const t=(0,pt.isBrowserSafari)()?20:5;let i=!1,s=0,n=0,r=0,a=0;const o={performFrameTiming:!1};this.viewer.getCamera().setViewport(this.testViewport),this.viewer.getPrimaryViewController().setStandardView("XZ"),this.viewer.zoomFit();let h=500;const c=l=>{const d=(0,Xs.Wj)(),u=this.viewer.getPrimaryViewController();if(u.rotateAbout(.0698131701,[0,0,1],u.camera.focalPoint()),r){a+=d-r,++s}i?r=d:(n=d,i=!0);const g=d-n;if(g>500&&2500!==h){a/s>=this.fastFrameThresholdMS&&(h=2500)}s>=t&&g>=h?e(a/s):(this.frameBuffer.bindBuffer(),this.viewer.getCamera().setViewport(this.testViewport),this.viewer.renderContext.pushViewport(this.testViewport),this.viewer.draw(l),this.viewer.renderContext.popViewport(),this.viewer.getCamera().setViewport(this.canvasViewport),this.frameBuffer.unbindBuffer(),this.blitPass.draw(this.viewer.renderContext),this.viewer.requestDraw(c,o,!0))};this.viewer.requestDraw(c,o,!0)}measureTrianglesPerSecond(){this.measurePrimitivesPerSecond(Ai.MX.TRIANGLE_STRIP,BI.trianglesPerSecond,((e,t)=>{this.results.trianglesPerSecond=e,this.results.trianglesPerSecondMeasurementHaltedEarly=t,this.measureLinesPerSecond()}))}measureLinesPerSecond(){this.measurePrimitivesPerSecond(Ai.MX.LINES,BI.linesPerSecond,((e,t)=>{this.results.linesPerSecond=e,this.results.linesPerSecondMeasurementHaltedEarly=t,this.resolve()}))}measurePrimitivesPerSecond(e,t,i){const s=new FI(e,this.viewer);s.addPrimitivesToScene();const n=10*t,r=e=>{const t=s.getPrimitiveCount()/e*1e3;e<this.fastFrameThresholdMS&&t<=n?(s.addPrimitivesToScene(),this.measureFrameTime(r)):(s.remove(),this.viewer.cleanUpOrphanedObjects(),i(t,t>n))};this.measureFrameTime(r)}}function WI(e){return new kI(e).execute()}class zI{constructor(){this.TOTAL_PROPERTY="total",this.BYTE_TO_MB=1/1048576,this.memoryUsage={}}reset(){this.memoryUsage={}}incrementMemoryUsage(e,t){if(e===this.TOTAL_PROPERTY)throw'Do not use "'+this.TOTAL_PROPERTY+'" as memory type.';this.memoryUsage.hasOwnProperty(e)?this.memoryUsage[e]+=t:this.memoryUsage[e]=t}decrementMemoryUsage(e,t){if(e===this.TOTAL_PROPERTY)throw'Do not use "'+this.TOTAL_PROPERTY+'" as memory type.';this.memoryUsage.hasOwnProperty(e)&&(this.memoryUsage[e]-=t)}addToStatistics(){const e=(0,Ln.qn)();for(const t in this.memoryUsage)e.increment("MB "+t,this.memoryUsage[t]*this.BYTE_TO_MB)}getUsageDetails(){const e=(0,z.Z)(this.memoryUsage);let t=0;for(const e in this.memoryUsage)t+=this.memoryUsage[e];return e[this.TOTAL_PROPERTY]=t,e}getUsageDetailsAsString(){const e=this.getUsageDetails(),t={};return Object.entries(e).forEach((([e,i])=>{t[e]=(i/1048576).toFixed(1)+" MB"})),JSON.stringify(t)}}var XI=i(4982);const ZI=_e.O.createLogger("silhouettes",k.bVy.GRAPHICS),qI=X.default.getManager();let YI=new Int32Array(0),KI=new Float32Array(0),jI=new Int32Array(0),QI=0,$I=0;const JI=1024*qI.getNumber("MAX_EDGE_BASED_SILHOUETTE_MEMORY_USE_MB")*1024;function eE(){return $I>=JI}let tE=0,iE=[];const sE=function(e,t,i,s,n,r,a,o,h,c,l,d,u){const g=e.normals[3*l+0],p=e.normals[3*l+1],m=e.normals[3*l+2],f=e.normals[3*d+0],I=e.normals[3*d+1],E=e.normals[3*d+2],S=e.normals[3*u+0],T=e.normals[3*u+1],D=e.normals[3*u+2],C=(0,Er.crossProduct)(o-n,h-r,c-a,n-t,r-i,a-s);ge.S4.normalize(C);let y=g*C[0]+p*C[1]+m*C[2];y<0&&(ge.S4.negate(C),y*=-1);const A=f*C[0]+I*C[1]+E*C[2],P=S*C[0]+T*C[1]+D*C[2],O=Ri.W.FACE_NORMAL_IS_BAD;return(y<O||A<O||P<O)&&M.set(C,(g+f+S)/3,(p+I+T)/3,(m+E+D)/3),C},nE=function(e,t,i,s,n,r,a){let o;o=t<i?t+"__"+i:i+"__"+t;let h=a[o],c=0;void 0!==h?(c=YI[h],YI[h]=c+1):(h=QI,a[o]=h,jI[2*h+0]=s,jI[2*h+1]=n,YI[h]=1,QI++),c<2&&(KI[6*h+3*c+0]=r[0],KI[6*h+3*c+1]=r[1],KI[6*h+3*c+2]=r[2])},rE=function(e,t,i,s,n){let r=ge.S4.subtract(t,e,n);ge.S4.normalize(r),r=ge.S4.cross(r,i,r);const a=Math.atan2(i[1],i[0]),o=ge.gv.length(i),h=Math.atan2(i[2],o),c=M.dot(i,s),l=M.dot(r,s),d=Math.atan2(l,c);M.set(n,a,h,d)},aE=function(e,t){if(e.indices.length<3||e.indices.length>qI.getNumber("MAX_SINGLE_SILHOUETTE_INCREMENT_SIZE"))return null;!function(e){QI=0;const t=2*e;YI.length<t&&(YI=new Int32Array(t),KI=new Float32Array(6*t),jI=new Int32Array(2*t))}(e.indices.length);const i={},s=function(t,s,n){return function(t,i){return M.set(i,e.points[3*t+0],e.points[3*t+1],e.points[3*t+2])}(jI[2*i[t]+s],n)},n=function(e,t,s){const n=i[e];M.set(s,KI[6*n+3*t+0],KI[6*n+3*t+1],KI[6*n+3*t+2])};for(let t=2;t<e.indices.length;++t){const s=e.indices[t-2],n=e.indices[t-1],r=e.indices[t];if(!(s===n||n===r||s===r)){const t=e.points[3*s+0],a=e.points[3*s+1],o=e.points[3*s+2],h=(0,Yd.nw)(t,a,o),c=e.points[3*n+0],l=e.points[3*n+1],d=e.points[3*n+2],u=(0,Yd.nw)(c,l,d),g=e.points[3*r+0],p=e.points[3*r+1],m=e.points[3*r+2],f=(0,Yd.nw)(g,p,m),I=sE(e,t,a,o,c,l,d,g,p,m,s,n,r);nE(0,h,u,s,n,I,i),nE(0,u,f,n,r,I,i),nE(0,h,f,s,r,I,i)}}const r=function(e){return 2===YI[i[e]]},a=[];for(const e in i)r(e)&&a.push(e);const o=a.length;if(0===o)return null;const h=new Float32Array(6*o),c=new Int32Array(2*o),l=new Float32Array(6*o),d=M.create(),u=M.create(),g=M.create(),p=M.create(),m=M.create();for(let e=0;e<o;++e){const t=a[e];s(t,0,d),s(t,1,u),n(t,0,g),n(t,1,p),rE(d,u,g,p,m),c[2*e]=2*e,c[2*e+1]=2*e+1;for(let t=0;t<3;++t)h[6*e+t]=d[t],h[6*e+3+t]=u[t],l[6*e+t]=m[t],l[6*e+3+t]=m[t]}const f=new eT(Ai.MX.SILHOUETTES,h,c,t,!0);f.normals=l,f.prepareForBuffering();const I=!eE();return $I+=e.getTriangleCount()*XI.a.SILHOUETTE_BYTES_PER_TRIANGLE,I&&eE()&&ZI.info("Edge-based silhouette memory use exhausted"),f};function oE(e,t){return e.getFullId()+"_"+t}class hE{constructor(e,t,i){this.parentIncrement=e,this.usage=t,this.callback=i,this.key=oE(e,t),this.id=(tE++,tE);const s=this.parentIncrement.getBounds();this.bboxDiameter=s.diameter()}}class cE{constructor(e,t){this.parentIncrementGuid=e,this.silhouetteIncrement=t}}const lE=function(e){for(let t=iE.length-1;t>=0;--t)if(iE[t].parentIncrementGuid===e)return iE[t];return null},dE=function(e){iE.length>=100&&iE.shift(),iE.push(e)};function uE(e){return e+"_siledges"}function gE(e){const t=e.getGloballyUniqueId(),i=lE(t);let s=null;if(i)s=i.silhouetteIncrement;else{const i=uE(e.id);s=aE(e,i),s&&dE(new cE(t,s))}return s}class pE{constructor(e){this.viewer=e,this.silhouetteIncrementToRequest={},this.silhouetteRequestQueue=[],this.silhouetteRequestQueueIsSorted=!1}process(e){if(this.hasPendingWork())for(this.silhouetteRequestQueueIsSorted||(this.silhouetteRequestQueue.sort((function(e,t){return t.bboxDiameter-e.bboxDiameter})),this.silhouetteRequestQueueIsSorted=!0);this.silhouetteRequestQueue.length>0;){if(eE())return this.silhouetteRequestQueue=[],void(this.silhouetteIncrementToRequest={});const t=this.silhouetteRequestQueue.shift();if(this.silhouetteIncrementToRequest[t.key]!==t.id)continue;delete this.silhouetteIncrementToRequest[t.key];const i=gE(t.parentIncrement);if(i&&(e&&e.addVertexCost(i.vertexCount()),t.callback(t.parentIncrement,i)),e&&e.budgetExceeded())break}}hasPendingWork(){return this.silhouetteRequestQueue.length>0}postSilhouetteRequest(e,t,i){if(!this.viewer.areEdgeSilhouettesEnabled())return;if(eE())return;const s=new hE(e,t,i);this.silhouetteRequestQueue.push(s),this.silhouetteRequestQueueIsSorted=!1,this.silhouetteIncrementToRequest[s.key]=s.id}clearPendingRequests(){this.silhouetteRequestQueue=[]}clearPendingRequestsForUsage(e){const t=[];for(let i=0;i<this.silhouetteRequestQueue.length;++i){const s=this.silhouetteRequestQueue[i];s.usage!==e&&t.push(s)}this.silhouetteRequestQueue=t,this.silhouetteRequestQueue=this.silhouetteRequestQueue.filter((function(t){return t.usage!==e}))}removePendingRequest(e,t){delete this.silhouetteIncrementToRequest[oE(e,t)]}}function mE(){iE=[]}class fE{constructor(e,t){this.viewer=e,this.sceneGraphs=t,this.nodes={},this.meshManager=new eD(this.viewer,{bufferAllocationPolicy:AE.MEDIUM}),this.onSessionEnded=()=>{this.meshManager.destroy(),this.viewer.getEventDispatcher().off(nM.so,this.onSessionEnded)},this.viewer.getEventDispatcher().on(nM.so,this.onSessionEnded)}getMeshManager(){return this.meshManager}getNode(e){if(!this.nodes[e]){const t=new Gi.NB("uinode");this.nodes[e]=t,this.sceneGraphs.getSceneGraph(e).getRootNode().addChild(t)}return this.nodes[e]}destroyPreviewGraphics(){delete this.nodes[uh.Vv]}clean(){this.meshManager.removeEmptyMeshes();for(const e in this.nodes)this.nodes[e].cleanEmptyMeshNodes()}}const IE=new Bi({diffuseFactor:.5,ambientFactor:.5});function EE(){return{0:new Gi.hF({isPickable:!1,zOffset:3,isShowThrough:!0,primitiveType:Ai.MX.POINTS}),1:new Gi.hF({isPickable:!1,zOffset:4,isShowThrough:!0,primitiveType:Ai.MX.LINES,priority:Gi.DO.HIGHEST}),4:new Gi.hF({isPickable:!1,isTwoSided:!0,zOffset:5,primitiveType:Ai.MX.TRIANGLE_STRIP,material:IE,primitivesHaveTransparency:!0})}}class SE extends yi.u1{constructor(e,t){super(t),this.sheetMetalModelId=null,this.incrementIdToHightlight={};X.default.getManager();e.forEach(((e,t)=>{let i=null;if(e instanceof k.TT0&&(i=e,this.sheetMetalModelId=i.sheetMetalModelId,i.deterministicId&&i.style===k.$76.ERROR)){const e=(0,Me.cF)(i.deterministicId);if(e)return void(0,Me.yb)().add(e)}const s=UE(e);if(s){if(!s.colors){const e=BE(k.FVx.FEATURE_ERROR,s.primitiveType);(0,Yd.Ab)(e,s)}s.primitiveType===Ai.MX.POINTS?s.primitiveSizes||(0,Yd.VQ)(7,s):s.primitiveType===Ai.MX.LINES&&(0,Yd.VQ)(2.5,s);const e=EE(),n="id"+t;if(this.updateMeshIncrement(n,yi.ZJ,s,e[s.primitiveType]),i&&i.style===k.$76.ERROR){const e=this.addNewHighlightToIncrement(n,Cn.o2.ERROR);this.incrementIdToHightlight[n]=e,this.hideIncrement(n)}this.viewer.getIsolatedOccurrenceManager()?.addIdsToIsolate([this.graphicsOccurrenceId])}}),this)}show(){super.show();for(const e in this.incrementIdToHightlight){const t=this.addNewHighlightToIncrement(e,Cn.o2.ERROR);this.incrementIdToHightlight[e]=t,this.hideIncrement(e)}}hide(){super.hide();for(const e in this.incrementIdToHightlight)this.removeHighlightFromIncrement(e,this.incrementIdToHightlight[e]);this.freeAllocatedHighlights()}remove(){(0,Me.yb)().reset(),this.viewer.getIsolatedOccurrenceManager()?.removeFromIsolate([this.graphicsOccurrenceId]),super.remove()}}var TE=i(40869),DE=i(97248),CE=i(51310);class ME extends yi.u1{constructor(e,t){super(t,uh.lL),this.idToSilhouetteInfo={},this.sketchProperties=new Gi.hF({isPickable:!0,isShowThrough:!0,isDepthTested:!1,primitiveType:Ai.MX.LINES,zOffset:1}),this.worldProperties=new Gi.hF({isPickable:!0,isShowThrough:!0,isDepthTested:!0,primitiveType:Ai.MX.LINES,zOffset:1});const i=X.default.getManager();let s;for(this.width=i.getNumber("SKETCH_SILHOUETTE_WIDTH"),this.sketchColor=i.getColor("SKETCH_PREVIEW_COLOR"),this.worldColor=i.getColor("SKETCH_SILHOUETTE_WORLD_COLOR"),this.hoverWidth=i.getNumber("HIGHLIGHT_LINE_WIDTH_MIN"),this.hoverColor=i.getColor("PRE_HIGHLIGHT_COLOR_BORDER"),this.worldStipple=i.getStipple("SKETCH_SILHOUETTE_WORLD_STIPPLE"),s=0;s<e.length;++s){const t=e[s].silhouetteId;this.idToSilhouetteInfo[t]=e[s],this.updateSilhouette(t,!1),this.listenTo(this,yi.zw.MOUSE_ENTER+t,this.onMouseEnter),this.listenTo(this,yi.zw.MOUSE_LEAVE+t,this.onMouseLeave),this.listenTo(this,yi.zw.CLICK+t,this.onMouseClick)}}updateAllSilhouettes(){Object.entries(this.idToSilhouetteInfo).forEach((([e,t])=>{this.updateSilhouette(e,!1)}))}updateSilhouette(e,t){const i=this.idToSilhouetteInfo[e];if(!i)return;(0,Yd.Ab)(t?this.hoverColor:this.worldColor,i.worldMesh),(0,Yd.VQ)(t?this.hoverWidth:this.width,i.worldMesh),(0,Yd.KZ)(this.worldStipple,i.worldMesh),this.updateMeshIncrement(e,e,i.worldMesh,this.worldProperties);const s=this.getProjectedMeshId(e),n=co(this.viewer,i.sketchPolyline);(0,Yd.Ab)(t?this.hoverColor:this.sketchColor,n),(0,Yd.VQ)(t?this.hoverWidth:this.width,n),this.updateMeshIncrement(s,e,n,this.sketchProperties)}getProjectedMeshId(e){return e+".ske"}getClearModelSelectionsOnPrehilite(){return!1}onMouseEnter(e){this.updateSilhouette(e.selectionId,!0),(0,Xs.vm)()}onMouseLeave(e){this.updateSilhouette(e.selectionId,!1),(0,Xs.vm)()}onMouseClick(e){const t=this.idToSilhouetteInfo[e.selectionId];t&&this.trigger(CE.AW,this,t.disambiguation,e.selectionId)}removeOtherSilhouettes(e){for(const t in this.idToSilhouetteInfo)t!==e&&(this.removeMeshIncrement(t),this.removeMeshIncrement(this.getProjectedMeshId(t)),delete this.idToSilhouetteInfo[t]);this.stopListening(),this.updateSilhouette(e,!1),(0,Xs.vm)()}}const yE=_e.O.createLogger("Mesh",k.bVy.GRAPHICS);var AE;!function(e){e[e.MINIMUM=0]="MINIMUM",e[e.MEDIUM=1]="MEDIUM",e[e.MAXIMUM=2]="MAXIMUM"}(AE||(AE={}));const PE=(0,Ln.qn)();class OE extends m.T{constructor(e,t){super(),this.viewer=e,this.bufferSets=[],this.buffersNeedCompilation=!1,this.vertexSize=0,(0,Sh.Yk)(e),this.bufferAllocationPolicy=t&&void 0!==t.bufferAllocationPolicy?t.bufferAllocationPolicy:AE.MINIMUM,this.id=t?t.id:void 0,this.primitiveType=Ai.MX.PRIMITIVE_UNKNOWN,this.incrementToBufferSetIndex=new Gl.TemplatedCountedMap,this.listenTo(this.viewer.getEventDispatcher(),nM.pO,this.onGlContextRestored),this.listenTo(this.viewer.getEventDispatcher(),nM.so,this.onGlContextDestroyed)}destroy(){let e;for(e=0;e<this.bufferSets.length;++e)this.bufferSets[e].destroy();this.incrementToBufferSetIndex.clear(),this.bufferSets.length=0,this.stopListening()}getBufferSetWithIndex(e){return this.bufferSets[e]}getId(){return this.id}onGlContextRestored(e){for(let e=0;e<this.bufferSets.length;++e)this.bufferSets[e].reinitialize()}onGlContextDestroyed(){this.destroy()}getPrimitiveType(){return this.primitiveType}setPrimitiveType(e){this.primitiveType=e}getBuffersNeedCompilation(){return this.buffersNeedCompilation}setBuffersNeedCompilation(){this.buffersNeedCompilation=!0}onPermanentlyRemoved(){this.destroy()}incrementStatisticsForCall(e,t){switch(PE.increment(Ln.kW.DRAW_CALLS,t),this.primitiveType){case Ai.MX.LINES:PE.increment(Ln.kW.LINES,Math.floor(e/6));break;case Ai.MX.POINTS:PE.increment(Ln.kW.POINTS,Math.floor(e/6));break;case Ai.MX.TRIANGLES:PE.increment(Ln.kW.TRIANGLES,Math.floor(e/3));break;case Ai.MX.TRIANGLE_STRIP:PE.increment(Ln.kW.TRIANGLES,e-2)}}getPrimitiveMode(){const e=this.viewer.getGlContext();switch(this.primitiveType){case Ai.MX.POINTS:case Ai.MX.INFINITE_LINES:case Ai.MX.TRIANGLES:case Ai.MX.SILHOUETTES:return e.TRIANGLES;case Ai.MX.TRIANGLE_STRIP:return e.TRIANGLE_STRIP;case Ai.MX.LINES:return this.viewer.areOptimizedBuffersEnabled?e.LINES:e.TRIANGLES;default:yE.warn("Unknown mesh primitive type: "+this.primitiveType)}return 0}getAlternatePrimitiveMode(){const e=this.viewer.getGlContext();switch(this.primitiveType){case Ai.MX.LINES:return e.POINTS;case Ai.MX.TRIANGLE_STRIP:return e.LINE_STRIP}return 0}getBufferSetIndexForIncrement(e){return this.incrementToBufferSetIndex.has(e)?this.incrementToBufferSetIndex.get(e):-1}addBufferSet(e){this.bufferSets.push(e),e.setParentMesh(this)}removeBufferSet(e){const t=this.bufferSets.indexOf(e);t>-1&&this.bufferSets.splice(t,1)}addIncrement(e){if(!e.getFullId())return yE.warn("An attempt was made to add a increment without a valid id"),null;if(!this.updateMeshPropertiesFromIncrement(e))return null;let t=null,i=-1;const s=this.getBufferSetIndexForIncrement(e.getFullId());let n=null;if(s>=0&&!this.bufferSets[s].hasOptimizedBuffers()&&(n=this.bufferSets[s],n.deleteIncrement(e.getFullId())),!e.isPrecompiledBuffer)for(let s=0;s<this.bufferSets.length;++s){if(this.bufferSets[s].hasOptimizedBuffers())continue;if(t=this.bufferSets[s].incorporateIncrement(e),t){i=s;break}}if(e.isPrecompiledBuffer&&s>=0)t=n.incorporateIncrement(e);else{if(i<0){const s=new zT(this,e.isPrecompiledBuffer);t=s.incorporateIncrement(e),t?(i=this.bufferSets.length,this.bufferSets.push(s)):yE.warn("A new buffer set failed to incorporate a single mesh increment")}i>=0&&this.incrementToBufferSetIndex.insert(e.getFullId(),i),this.setBuffersNeedCompilation()}return t}updateMeshPropertiesFromIncrement(e){if(this.primitiveType===Ai.MX.PRIMITIVE_UNKNOWN)this.primitiveType=e.primitiveType;else if(this.primitiveType!==e.primitiveType)return yE.warn("Tried to add two different increment types to the same mesh."),!1;const t=e.getVertexSize();if(this.vertexSize){if(this.vertexSize!==t)return yE.warn("Encountered primitives with different sized vertices in the same mesh"),!1}else this.vertexSize=t;return!0}getIncrementDetails(e){const t=this.getBufferSetIndexForIncrement(e);if(t<0||this.bufferSets[t].hasOptimizedBuffers())return null;return this.bufferSets[t].getIncrementDetails(e)}deleteIncrement(e){const t=this.getBufferSetIndexForIncrement(e);let i=null;if(t<0||this.bufferSets[t].hasOptimizedBuffers())return null;return i=this.bufferSets[t].deleteIncrement(e),this.incrementToBufferSetIndex.remove(e),this.setBuffersNeedCompilation(),i}updateIncrementAttribute(e,t,i){const s=this.getBufferSetIndexForIncrement(t);if(s<0||this.bufferSets[s].hasOptimizedBuffers())return;this.bufferSets[s].updateIncrementAttribute(e,t,i),this.setBuffersNeedCompilation()}extractMeshIncrement(e){const t=this.getBufferSetIndexForIncrement(e);if(t<0||this.bufferSets[t].hasOptimizedBuffers())return null;return this.bufferSets[t].getIncrement(e)}compileBuffers(e){if(!this.buffersNeedCompilation)return;const t=new Ih.B7("Mesh.compileBuffers");this.buffersNeedCompilation=!1;let i=!1;for(let e=0;e<this.bufferSets.length;++e){if(this.bufferSets[e].hasOptimizedBuffers())continue;const t=this.bufferSets[e];i=t.updateBuffers()||i,this.buffersNeedCompilation=this.buffersNeedCompilation||t.hasBufferUpdates()}e&&i&&e.setLastBufferBound(null),t.report()}copyOptimizedBuffersToGl(e){let t=!1;for(let e=0;e<this.bufferSets.length;++e)this.bufferSets[e].hasOptimizedBuffers()&&(t=this.bufferSets[e].copyBuffersToGl()||t);e&&t&&e.setLastBufferBound(null)}isEmpty(){return this.incrementToBufferSetIndex.isEmpty()}collectViewerMetrics(e){for(let t=0;t<this.bufferSets.length;++t)this.bufferSets[t].collectViewerMetrics(e)}getBufferSetSceneDebugObjects(){const e=[];for(let t=0;t<this.bufferSets.length;++t){const i=this.bufferSets[t];i instanceof zT&&e.push(i.makeSceneDebugObject())}return e}}const RE="element.",wE="elementpreview.",vE="temporary_sketch_component.",_E="partStudio.",NE="assembly.",bE="occurrence",LE="",FE={bufferAllocationPolicy:AE.MAXIMUM};function xE(e,t,i){const s=e.getMeshIncrement(),n=s?s.clone():UE(e);return n&&(t&&(n.id=t),n.pickId=i),n}function BE(e,t){let i="";switch(e){case k.FVx.RED:i="CPP_RED";break;case k.FVx.GREEN:i="CPP_GREEN";break;case k.FVx.BLUE:i="CPP_BLUE";break;case k.FVx.CYAN:i="CPP_CYAN";break;case k.FVx.YELLOW:i="CPP_YELLOW";break;case k.FVx.MAGENTA:i="CPP_MAGENTA";break;case k.FVx.BLACK:i="CPP_BLACK";break;case k.FVx.TRANSLUCENT_PURPLE:i="CPP_TRANSLUCENT_PURPLE";break;case k.FVx.FEATURE_ERROR:case k.FVx.FEATURE_DEBUG:i="FEATURE_ERROR_GRAPHIC_COLOR";break;case k.FVx.TRANSLUCENT_GREEN:i="CPP_TRANSLUCENT_GREEN";break;case k.FVx.TRANSLUCENT_BLUE:i="CPP_TRANSLUCENT_BLUE";break;case k.FVx.TRANSLUCENT_CYAN:i="CPP_TRANSLUCENT_CYAN";break;case k.FVx.TRANSLUCENT_YELLOW:i="CPP_TRANSLUCENT_YELLOW";break;case k.FVx.TRANSLUCENT_BLACK:i="CPP_TRANSLUCENT_BLACK";break;case k.FVx.TRANSLUCENT_ORANGE:i="CPP_TRANSLUCENT_ORANGE";break;case k.FVx.ORANGE:i="CPP_ORANGE";break;default:i="CPP_RED"}const s=X.default.getManager().getColor(i);return e!==k.FVx.FEATURE_ERROR||t!==Ai.MX.POINTS&&t!==Ai.MX.LINES?s:[s[0],s[1],s[2],1]}const VE=function(e){let t=null;if(e&&e.length>1){const i=new Float32Array(e.buffer,0,6),s=new Uint16Array(e.buffer,24);t=new Float32Array(s.length);const n=(i[3]-i[0])/65535,r=(i[4]-i[1])/65535,a=(i[5]-i[2])/65535,o=i[0],h=i[1],c=i[2];for(let e=0;e<s.length;e+=3)t[e+0]=o+n*s[e+0],t[e+1]=h+r*s[e+1],t[e+2]=c+a*s[e+2]}return t};function UE(e){let t=null;switch(e.getMessageName()){case"display.GBTEntityFace":const i=e;if(i.decompress(),!i.points||!i.indices||!i.normals)return null;t=new eT(Ai.MX.TRIANGLE_STRIP,i.points,i.indices),t.normals=i.normals;break;case"display.GBTEntityEdge":const s=e;if((!s.points||s.points.length<6)&&(!s.compressedPoints||s.compressedPoints.length<6))return null;s.compressedPoints&&s.compressedPoints.length>1&&(s.points=VE(s.compressedPoints),s.compressedPoints=new Uint8Array(0));const n=Math.floor(s.points.length/3)-1,r=new Int32Array(2*n);for(let e=0;e<n;++e)r[2*e]=e,r[2*e+1]=e+1;t=new eT(Ai.MX.LINES,s.points,r,void 0,!0);break;case"display.GBTEntityPoint":case"display.GBTEntityDegenerateEdge":const a=e;if(!a.point)return null;t=new eT(Ai.MX.POINTS,a.point,[0],void 0,!0);break;case"display.GBTFeatureEntity":case"display.GBTConstructionPlaneEntity":case"display.GBTBodyEntity":case"display.GBTPointEntity":case"display.GBTOriginEntity":case"display.GBTMateConnectorEntity":case"display.GBTSketchEntity":const o=e;t=o.getGeometry()?UE(o.getGeometry()):null;break;case"display.GBTDebugGeometry":const h=e;if(!h.tessellation)return null;if(t=UE(h.tessellation),h.style!==k.$76.ERROR){const e=BE(h.color,t.primitiveType);(0,Yd.Ab)(e,t),t.primitiveType===Ai.MX.POINTS&&(h.style===k.$76.STAR?((0,Yd.KZ)(X.default.getManager().getPointFont("STAR_POINT"),t),(0,Yd.VQ)(X.default.getManager().getNumber("STAR_POINT_SIZE"),t)):(0,Yd.VQ)(X.default.getManager().getNumber("DEBUG_POINT_SIZE"),t))}}return t}function HE(e){switch(e.getEntityType()){case k.ZSW.VERTEX:return Ai.MX.POINTS;case k.ZSW.EDGE:return Ai.MX.LINES;case k.ZSW.FACE:return Ai.MX.TRIANGLE_STRIP;case k.ZSW.DEGENERATE_EDGE:return Ai.MX.POINTS}return Ai.MX.PRIMITIVE_UNKNOWN}function GE(e,t,i){if(!e)return[];let s;return i?(s=[],e.each((function(e,n){return i(t[n])&&s.push(n),!1}))):s=e.getKeys(),s}function kE(e){return!!e&&-1!==e.indexOf(".")}const WE={mouseup:"mouseup"};class zE{constructor(e,t){this.element=e,this.firstMiddleMouseButtonUp=!1,this.timeOfFirstMiddleMouseUp=-1,this.elementDoubleClickHandler=t,this.mouseUpHandler=e=>this.MouseUpHandler(e),this.setupEventHandlers()}setupEventHandlers(){this.element&&this.element.on(WE.mouseup,this.mouseUpHandler)}off(){this.element&&this.element.off(WE.mouseup,this.mouseUpHandler)}resetFirstMiddleButtonUpState(){this.firstMiddleMouseButtonUp=!1,this.timeOfFirstMiddleMouseUp=-1}setFirstMiddleButtonUpState(){this.firstMiddleMouseButtonUp=!0,this.timeOfFirstMiddleMouseUp=(0,Xs.Wj)()}MouseUpHandler(e){if(e.which!==Qn.tc.MIDDLE)return void this.resetFirstMiddleButtonUpState();if(!this.firstMiddleMouseButtonUp)return void this.setFirstMiddleButtonUpState();if((0,Xs.Es)(this.timeOfFirstMiddleMouseUp)<=X.default.getManager().getNumber("MIDDLE_MOUSE_BUTTON_DOUBLE_CLICK_TIMEOUT"))return this.resetFirstMiddleButtonUpState(),void this.elementDoubleClickHandler(e);this.setFirstMiddleButtonUpState()}}var XE=i(84853);const ZE=_e.O.createLogger("range",k.bVy.GRAPHICS);function qE(e,t,i,s,n){let r,a=t;for(;t!==i;)if(a=Math.floor(.5*(t+i)),r=e[a][s],n>r)a=t=a+1;else{if(!(n<r))break;i=a}return a}function YE(e,t){if(t.length<1)t.push(e.slice(0));else{const i=qE(t,0,t.length,0,e[0]);let s=!1,n=0,r=e[1];i>0&&t[i-1][1]>=e[0]&&(s=!0,r=Math.max(r,t[i-1][1]));for(let s=i;s<t.length&&t[s][0]<=e[1];++s)++n,r=Math.max(r,t[s][1]);s?(t[i-1][1]=r,t.splice(i,n)):t.splice(i,n,[e[0],r])}}const KE=[0,1];function jE(e,t,i){KE[0]=e,KE[1]=t,YE(KE,i)}function QE(e,t){if(e[0]===e[1])return;const i=qE(t,0,t.length,1,e[0]),s=qE(t,i,t.length,0,e[1]);if(i>=t.length||i===s)return void ZE.warn("Failed to find range to remove");let n=null,r=null;t[i][0]<e[0]&&(n=[t[i][0],e[0]]),t[s-1][1]>e[1]&&(r=[e[1],t[s-1][1]]),n&&r?t.splice(i,s-i,n,r):n?t.splice(i,s-i,n):r?t.splice(i,s-i,r):t.splice(i,s-i)}function $E(e,t){let i=0;for(let s=0;s<t.length;++s){const n=t[s],r=n[0]-i,a=n[1]-n[0];e.splice(r,a),i+=a}}const JE=_e.O.createLogger("RenderContext",k.bVy.GRAPHICS),eS=X.default.getManager(),tS="uViewport",iS="uBlitTextureOffset",sS=-1,nS=[0,0],rS=[1,1];let aS=!1;class oS extends m.T{constructor(e){super(),this.viewer=e,this.MAXIMUM_Z_OFFSET=eS.getNumber("MAXIMUM_Z_OFFSET"),this.activeShader=null,this.shaderStack=[],this.modelViewMatrixStack=[],this.projectionMatrixStack=[],this.viewport=[0,0,1,1],this.viewportStack=[],this.materialPushedShaderStack=[!1],this.activePass=null,this.lastPolygonOffsetFactor=NaN,this.lastPolygonOffsetUnits=NaN,this.overridePolygonOffset=!1,this.lastCullFace=null,this.pickBackFaces=!1,this.pickPrimitiveAlternates=!1,this.baseHighlightsEnabled=!0,this.activeCamera=null,this.isPickingHiddenOccurrences=!1,this.useHiddenOpacityForEdgeHighlights=!1,this.frameId=0,this.lastBufferBound=null,this.lastStyleApplied=new mS.bg,this.hasIsolate=!1,this.nodeOccurrenceFilterFunction=null,this.isWebXrEnabled=!1,(0,Sh.Yk)(e),this.state=new ui,this.modelViewMatrix=ue.create(),this.projectionMatrix=ue.create(),this.materialStack=[Ui],this.overrideFaceCullingMode=bh.UNSPECIFIED,this.renderingMode=k.P1.SHADED_WITH_EDGES,this.detailSettings=new ga,this.listenTo(this.viewer.getEventDispatcher(),nM.cW,this.onGlContextLost),this.listenTo(this.viewer.getEventDispatcher(),nM.b3,this.onDevicePixelRatioChanged),es.Jq.CapabilitiesService.isWebxrEnabled().then((e=>{this.isWebXrEnabled=e}))}onNewContext(e){this.state.setGlContext(e),this.setFacesToCull(bh.BACK)}onDevicePixelRatioChanged(e){if(this.activeShader){const e=(0,ns.x_)();this.activeShader.uniform1f("uDevicePixelRatio",e)}}destroy(){this.stopListening()}onGlContextLost(){this.activeShader=null}setOccurrencePickId(e){this.activeShader&&this.activeShader.uniform4fv("uOccurrencePickId",e)}getViewer(){return this.viewer}setActiveCamera(e){this.activeCamera=e}getActiveCamera(){return this.activeCamera}getState(){return this.state}pushModelViewMatrix(e){this.modelViewMatrixStack.push(this.modelViewMatrix),this.modelViewMatrix=e}getModelViewMatrix(){return this.modelViewMatrix}popModelViewMatrix(){0!==this.modelViewMatrixStack.length?this.modelViewMatrix=this.modelViewMatrixStack.pop():JE.warn("Tried to pop modelview matrix from stack with zero length")}updateModelviewUniforms(){const e=this.activeShader;e&&(e.uniformMatrix4fv("uMVMatrix",!1,this.modelViewMatrix),e.uniformMatrix4fv("uMVMatrix_fs",!1,this.modelViewMatrix))}pushProjectionMatrix(e){this.projectionMatrixStack.push(this.projectionMatrix),this.projectionMatrix=e,this.updateProjectionUniforms()}updateProjectionUniforms(){this.activeShader&&(this.activeShader.uniformMatrix4fv("uPMatrix",!1,this.projectionMatrix),this.activeShader.uniformMatrix4fv("uPMatrix_fs",!1,this.projectionMatrix))}getProjectionMatrix(){return this.projectionMatrix}popProjectionMatrix(){0!==this.projectionMatrixStack.length?(this.projectionMatrix=this.projectionMatrixStack.pop(),this.updateProjectionUniforms()):JE.warn("Tried to pop projection matrix from stack with zero length")}updateViewportUniforms(){const e=this.getActiveShader();if(e&&e.getUniformLocation(tS)&&e.uniform4fv(tS,this.viewport),e&&e.getUniformLocation(iS)){let t=nS,i=rS;this.isWebXrEnabled&&!this.isCustomViewportActive&&(t=Q.fromValues(this.viewport[0]/this.viewer.getBaseFrameBufferWidth(),this.viewport[1]/this.viewer.getBaseFrameBufferHeight()),i=Q.fromValues(this.viewport[2]/this.viewer.getBaseFrameBufferWidth(),this.viewport[3]/this.viewer.getBaseFrameBufferHeight())),e.uniform2fv(iS,t),e.uniform2fv("uBlitTextureScale",i)}}setViewport(e){this.viewport=e,this.viewer.getGlContext().viewport(e[0],e[1],e[2],e[3]),this.updateViewportUniforms()}pushViewport(e){this.viewportStack.push(this.viewport),this.setViewport(e)}getViewport(){return this.viewport}popViewport(){if(0===this.viewportStack.length)return void JE.warn("Tried to pop viewport from stack with zero length");const e=this.viewportStack.pop();this.setViewport(e)}get isCustomViewportActive(){return this.viewportStack.length>1}activateShader(e,t){if(null!==this.activeShader&&this.activeShader.equals(e))this.activePass?.onShaderActivated(this,this.activeShader);else if(this.activeShader&&this.activeShader.deactivate(),this.lastBufferBound=null,this.defaultStyle=null,this.lastStyleApplied.clear(),this.activeShader=e,t||(this.shaderStack=[this.activeShader]),null!==this.activeShader){this.lastNormalMatrixComputed=null,this.activeShader.useShader(),this.updateProjectionUniforms(),this.updateModelviewUniforms(),this.updateViewportUniforms();const e=[0,0,0,0],t=[0,0,0,-1],i=[0,0,0,0];this.activeShader.vertexAttrib4fv(PS.COLOR,t),this.activeShader.vertexAttrib4fv(PS.HIGHLIGHT_ID,e),this.activeShader.vertexAttrib4fv(PS.PRIMITIVE_STYLE,i),this.activeShader.vertexAttrib1f(PS.OCCURRENCE_ID,0),this.activeShader.uniform2fv("uHighlightPointFont",eS.getPointFont("HIGHLIGHT_POINT_FONT")),this.activeShader.uniform1f("uHighlightPointSizeMin",eS.getNumber("HIGHLIGHT_POINT_SIZE_MIN_PX")),this.activeShader.uniform1f("uHighlightPointSizeScale",eS.getNumber("HIGHLIGHT_POINT_SIZE_SCALE")),this.activeShader.uniform4fv("uHighlightLineStipple",eS.getStipple("HIGHLIGHT_LINE_STIPPLE")),this.activeShader.uniform1f("uHighlightLineWidthMin",eS.getNumber("HIGHLIGHT_LINE_WIDTH_MIN_PX")),this.activeShader.uniform1f("uHighlightLineWidthScale",eS.getNumber("HIGHLIGHT_LINE_WIDTH_SCALE")),this.activeShader.uniform1f("uHighlightCount",this.viewer.getReferenceHighlights().sortedHighlights.length),this.activeShader.uniform4fv("uBackgroundColor",eS.getColor("BACKGROUND_COLOR"));const s=(0,ns.x_)();this.activeShader.uniform1f("uDevicePixelRatio",s),this.activePass?.onShaderActivated(this,this.activeShader)}}getActiveShader(){return this.activeShader}pushShader(e){this.shaderStack.push(e)}activateTopShader(){this.shaderStack.length>0&&this.activateShader(this.shaderStack[this.shaderStack.length-1],!0)}popShader(){0!==this.shaderStack.length?this.shaderStack.pop():JE.warn("Tried to pop a shader off of an empty stack")}getExtendedShaderForMaterial(e){const t=e.getExtendedShaderId();if(!t)return null;const i=yI((this.shaderStack.length>0?this.shaderStack[this.shaderStack.length-1]:this.activeShader).getId(),t);return PI(i)?this.viewer.getShader(i):null}pushMaterial(e){this.materialStack.push(e);const t=this.getExtendedShaderForMaterial(e);t&&this.pushShader(t),this.materialPushedShaderStack.push(!!t)}setMaterial(){this.activeShader&&this.materialStack&&this.materialStack.length>0&&this.materialStack[this.materialStack.length-1].setAttributes(this.activeShader,this)}popMaterial(){if(0===this.materialStack.length)return void JE.warn("Tried to pop a material off of an empty stack");this.materialStack.pop();this.materialPushedShaderStack.pop()&&this.popShader()}setActivePass(e){this.activePass=e}getActivePass(){return this.activePass}setIsPickingHiddenOccurrences(e){this.isPickingHiddenOccurrences=e}getIsPickingHiddenOccurrences(){return this.isPickingHiddenOccurrences}isPicking(){return!!this.activePass&&this.activePass.isPickPass()}isHighlighting(){return!!this.activePass&&this.activePass.isHighlightPass()}getActiveHighlightType(){return this.activePass?this.activePass.getActiveHighlightType():null}needsAttribute(e){return!!this.activePass&&this.activePass.needsAttribute(e)}getPickPassIteration(){return this.activePass&&this.activePass.isPickPass()?this.activePass.getPickIteration():-1}isShowthrough(){return!!this.activePass&&this.activePass.isShowthroughPass()}setBackFacePicking(e){this.pickBackFaces=e}isPickingBackFaces(){return this.isPicking()&&this.pickBackFaces}setOverrideFaceCullingMode(e){this.overrideFaceCullingMode=e}clearOverrideFaceCullingMode(){this.overrideFaceCullingMode=bh.UNSPECIFIED}nodeFilter(e){return!0}setZOffset(e){const t=e/this.MAXIMUM_Z_OFFSET;this.setPolygonOffset(t,e)}setOverridePolygonOffset(e,t){this.overridePolygonOffset=!1,this.setPolygonOffset(e,t),this.overridePolygonOffset=!0}clearOverridePolygonOffset(){this.overridePolygonOffset=!1}setPolygonOffset(e,t){if(this.overridePolygonOffset||e===this.lastPolygonOffsetFactor&&t===this.lastPolygonOffsetUnits)return;const i=this.viewer.getGlContext();0===e&&0===t?i.disable(i.POLYGON_OFFSET_FILL):(i.polygonOffset(e,t),i.enable(i.POLYGON_OFFSET_FILL)),this.lastPolygonOffsetFactor=e,this.lastPolygonOffsetUnits=t}setFacesToCull(e){if(this.lastCullFace===e)return;let t=e;this.overrideFaceCullingMode!==bh.UNSPECIFIED&&(t=this.overrideFaceCullingMode);const i=this.viewer.getGlContext();bh.BACK===t?(i.enable(i.CULL_FACE),i.cullFace(i.BACK)):bh.FRONT===t?(i.enable(i.CULL_FACE),i.cullFace(i.FRONT)):bh.NONE===t?i.disable(i.CULL_FACE):JE.error("Unknown face culling parameter: "+t)}setPointSize(e){this.setPrimitiveSize(e)}setPointFont(e){this.setPrimitiveStyle([e[0],e[1],e[2],0])}setLineWidth(e){this.setPrimitiveSize(e)}setLineStipple(e){this.setPrimitiveStyle(e)}setPrimitiveSize(e){const t=this.getActiveShader();t&&t.vertexAttrib1f(PS.PRIMITIVE_SIZE,e)}setPrimitiveStyle(e){const t=this.getActiveShader();t&&t.vertexAttrib4fv(PS.PRIMITIVE_STYLE,e)}setPickPrimitiveAlternates(e){this.pickPrimitiveAlternates=e}getPickPrimitiveAlternates(){return this.pickPrimitiveAlternates}setBaseHighlightsEnabled(e){this.baseHighlightsEnabled=e}getBaseHighlightsEnabled(){return this.baseHighlightsEnabled}setUseHiddenOpacityForEdgeHighlights(e){this.useHiddenOpacityForEdgeHighlights=e}getUseHiddenOpacityForEdgeHighlights(){return this.useHiddenOpacityForEdgeHighlights}prepareForNextFrame(){this.frameId<wi.s9?this.frameId+=1:this.frameId=0,this.hasIsolate=this.viewer.getIsolatedOccurrenceManager()?.hasIsolatedInstances(),!aS&&this.materialStack.length>5&&(JE.warn("Material stack has grown unexpectedly long"),aS=!0)}getFrameId(){return this.frameId}getHasIsolate(){return this.hasIsolate}setRenderingMode(e){this.renderingMode=e}setDetailSettings(e){this.detailSettings=e}getDetailSettings(){return this.detailSettings}setUsage(e){this.usage=e}getUsage(){return this.usage}getLastBufferBound(){return this.lastBufferBound}setLastBufferBound(e){this.lastBufferBound=e}applyStyle(e){e&&!(0,mS.d8)(e,this.lastStyleApplied)&&e.applyStyle(this),e?this.lastStyleApplied.copyFrom(e):this.lastStyleApplied.clear()}activePassNeedsIsolationTest(){return!!this.activePass&&this.activePass.testIsolation(this)}activePassIsForIsolate(){return!!this.activePass&&this.activePass.forIsolate()}activePassIsForSectionPlaneEndcapMask(){return!!this.activePass&&this.activePass.forSectionPlaneEndcapMask()}activePassIsForOIT(){const e=this.activePass;return!!e?.oitComponent}setNodeOccurrenceFilterFunction(e){this.nodeOccurrenceFilterFunction=e}doesNodeOcccurrencePassFilter(e){return!this.nodeOccurrenceFilterFunction||this.nodeOccurrenceFilterFunction(e)}activePassNeedsFaceAppearances(){return!this.activePass||this.activePass.needsFaceAppearances()}}class hS{constructor(){this.mouseKeyFlags={},this.mouseKeyManipulationModeBinding={},this.hasShiftKeyBinding=!1,this.hasControlKeyBinding=!1,this.hasAltKeyBinding=!1,this.mouseKeyFlags[Qn.tc.MIDDLE]=1,this.mouseKeyFlags[Qn.tc.RIGHT]=2,this.mouseKeyFlags[Is.R8.SHIFT]=4,this.mouseKeyFlags[Is.R8.CONTROL]=8,this.mouseKeyFlags[Is.R8.ALT]=16}getMouseKeyCombinationID(e,t){let i=0,s=0;for(s=0;s<e.length;++s)i|=this.mouseKeyFlags[e[s]];for(s=0;s<t.length;++s)i|=this.mouseKeyFlags[t[s]];return i}clearMouseKeyManipulationBindings(){this.mouseKeyManipulationModeBinding={},this.hasShiftKeyBinding=!1,this.hasControlKeyBinding=!1,this.hasAltKeyBinding=!1}addMouseKeyManipulationModeBinding(e,t,i){const s=this.getMouseKeyCombinationID(e,t);s>0&&(this.mouseKeyManipulationModeBinding[s]=i,this.hasControlKeyBinding||(this.hasControlKeyBinding=0!=(s&this.mouseKeyFlags[Is.R8.CONTROL])),this.hasShiftKeyBinding||(this.hasShiftKeyBinding=0!=(s&this.mouseKeyFlags[Is.R8.SHIFT])),this.hasAltKeyBinding||(this.hasAltKeyBinding=0!=(s&this.mouseKeyFlags[Is.R8.ALT])))}getManipulationMode(e,t){return this.mouseKeyManipulationModeBinding[this.getMouseKeyCombinationID(e,t)]}isManipulationModeEnabled(e,t,i){const s=this.getMouseKeyCombinationID(t,i);for(const t in this.mouseKeyManipulationModeBinding){const i=parseInt(t,10);if(this.mouseKeyManipulationModeBinding[i]===e){if((s&i)===i)return!0}}return!1}getClosestMode(e,t,i){let s=aA.k.NONE,n=0;for(const r in this.mouseKeyManipulationModeBinding){const a=parseInt(r,10),o=this.mouseKeyManipulationModeBinding[a];o!==i&&(this.isManipulationModeEnabled(o,e,t)&&a>n&&(n=a,s=o))}return s}usesShiftKey(){return this.hasShiftKeyBinding}usesControlKey(){return this.hasControlKeyBinding}usesAltKey(){return this.hasAltKeyBinding}}let cS=null;function lS(){return cS||(cS=new hS,cS.addMouseKeyManipulationModeBinding([Qn.tc.RIGHT],[],aA.k.ROTATE),cS.addMouseKeyManipulationModeBinding([Qn.tc.RIGHT],[Is.R8.ALT],aA.k.AXIS_ROTATE),cS.addMouseKeyManipulationModeBinding([Qn.tc.RIGHT],[Is.R8.CONTROL],aA.k.PAN),cS.addMouseKeyManipulationModeBinding([Qn.tc.MIDDLE],[],aA.k.PAN)),cS}function dS(e,t){if(t.length<1)t.push(e.slice(0));else{const i=qE(t,0,t.length,0,e[0]);let s,n=!1,r=0,a=e[1];if(i>0){const r=t[i-1];r[1]>=e[0]&&((0,mS.d8)(r[2],e[2])?(n=!0,a=Math.max(a,r[1])):(r[1]>a&&(s=[e[1],r[1],r[2]]),r[1]=e[0]))}for(let s=i;s<t.length;++s){const i=t[s];if(!(i[0]<=e[1]))break;i[1]<=e[1]?++r:(0,mS.d8)(i[2],e[2])?(++r,a=Math.max(a,i[1])):i[0]<a&&(i[0]=a)}n?(t[i-1][1]=a,t.splice(i,r)):s?t.splice(i,r,[e[0],a,e[2]],s):t.splice(i,r,[e[0],a,e[2]])}}function uS(e,t){if(e[0]===e[1])return;const i=qE(t,0,t.length,1,e[0]),s=qE(t,i,t.length,0,e[1]);if(i>=t.length||i===s)return;let n=null,r=null;t[i][0]<e[0]&&(n=[t[i][0],e[0],t[i][2]]),t[s-1][1]>e[1]&&(r=[e[1],t[s-1][1],t[s-1][2]]),n&&r?t.splice(i,s-i,n,r):n?t.splice(i,s-i,n):r?t.splice(i,s-i,r):t.splice(i,s-i)}function gS(e){return 0===e.length?"[]":"[["+e.join("],[")+"]]"}function pS(e){const t=new Array(e.length);for(let i=0;i<e.length;++i)t[i]=e[i].slice();return t}var mS=i(27261),fS=i(7412);class IS extends fS.q{constructor(){super(2),this.baseIterator=null,this.resetStyle=null}setResetStyle(e){this.resetStyle=e}reset(e){return this.baseIterator=e,this.nextResult=this.findNextRange(),this}findNextRange(){const e=this.baseIterator.getNextRange();if(!e)return null;const t=this.getStorageForNextResult();return t[0]=e[0],t[1]=e[1],t[2]=(0,mS.TS)(e[2],this.resetStyle,this.getStyleMergeStorage()),t}}class ES{constructor(){this.operand=null,this.iterator=new IS}setResetStyle(e){this.iterator.setResetStyle(e)}setOperand(e){this.operand=e}getRangeIteratorForBufferSet(e){if(!this.operand)return null;const t=this.operand.getRangeIteratorForBufferSet(e);return t?this.iterator.reset(t):null}makeSceneDebugObject(){const e={text:"StyleResetOperator",children:[]};return(0,Xs.n9)(e,this.operand),e}}const SS=new ES;class TS{constructor(e,t,i,s,n){this.parent=e,this.style=t,this.meshRanges=i,this.styleOverrideRanges=s,this.styleOverrideOperator=null,this.meshRangeGroupIdHash=null,this.meshRanges.addBoundable(this),n&&(this.rangeSkipOperator=new tD,this.rangeSkipOperator.setSubtrahend(n))}destroy(){this.meshRanges.removeBoundable(this)}getMeshRanges(){return this.meshRanges}getMeshRangesGroupIdHash(){if(this.meshRangeGroupIdHash)return this.meshRangeGroupIdHash;const e=this.getMeshRangesGroupId();if(e){this.meshRangeGroupIdHash=0;for(let t=0;t<e.length;t++)this.meshRangeGroupIdHash+=e.charCodeAt(t)}return this.meshRangeGroupIdHash}getMeshRangesGroupId(){return this.meshRanges.getMeshGroupId()}draw(e,t){if(!this.meshRanges.shouldDrawForOccurrences(t))return;e.applyStyle(this.style);let i=t.getMeshRangeOperator(e);i!==CS&&(i&&i.setOperand(this.meshRanges),this.rangeSkipOperator&&(this.rangeSkipOperator.setOperand(i||this.meshRanges),i=this.rangeSkipOperator),e.activePassNeedsFaceAppearances()&&this.styleOverrideRanges&&(this.styleOverrideOperator||(this.styleOverrideOperator=new lT,this.styleOverrideOperator.setOverwriteOperand(this.styleOverrideRanges),this.styleOverrideOperator.setDefaultStyle(this.style)),this.styleOverrideOperator.setOperand(i||this.meshRanges),i=this.styleOverrideOperator),e.activePassNeedsFaceAppearances()||(SS.setOperand(i||this.meshRanges),SS.setResetStyle(this.style),i=SS),this.meshRanges.draw(e,i))}isCheaplyBoundable(){return this.meshRanges.isCheaplyBoundable()}damageBounds(){this.parent.damageBounds()}getBounds(e,t){return this.meshRanges.getBounds(e,t)}makeSceneDebugObject(e){let t="Styled mesh range: (style: "+this.style+")";const i=[this.meshRanges.makeSceneDebugObject(e)];return this.styleOverrideRanges&&(i.push(this.styleOverrideRanges.makeSceneDebugObject()),t+=", with style overrides"),{text:t,children:i}}}class DS{getRangeIteratorForBufferSet(e){return null}setOperand(e){}makeSceneDebugObject(){return{text:"NoRangeOperator",children:[]}}}const CS=new DS,MS=_e.O.createLogger("Attribute",k.bVy.GRAPHICS),yS=Ht;class AS{constructor(e,t,i,s,n=!1,r=1){this.name=e,this.dimension=t,this.type=i,this.incrementProperty=s,this.normalize=n,this.secondDimension=r,this.elementCount=this.dimension*this.secondDimension,this.secondDimension>1&&this.dimension!==this.secondDimension&&MS.warn("Only square matrices are supported as glsl attributes. Attribute "+this.name+" will have issues")}typeSize(){return kt(this.type)}sizeInBytes(){return this.elementCount*this.typeSize()}}var PS,OS;!function(e){e.POSITION="aVertexPosition",e.NORMAL="aVertexNormal",e.OFFSET_VECTOR="aOffsetVector",e.COLOR="aVertexColor",e.PICKING="aPickId",e.TEXTURE="aTextureCoordinate",e.HIGHLIGHT_ID="aHighlightId",e.POINT_DATA="aPointData",e.EDGE_DATA="aEdgeData",e.PRIMITIVE_SIZE="aPrimitiveSize",e.PRIMITIVE_STYLE="aPrimitiveStyle",e.PRIMITIVE_RESTART="aPrimitiveRestart",e.OCCURRENCE_ID="aOccurrenceId",e.CONTACT_TRACTION="aContactTraction",e.CONTACT_PAIR_COORDINATE="aContactPairCoordinate"}(PS||(PS={})),function(e){e.POINT="points",e.NORMAL="normals",e.OFFSET_VECTOR="offsetVectors",e.COLOR="colors",e.TEXTURE="textureCoordinates",e.POINT_DATA="pointData",e.EDGE_DATA="edgeData",e.PRIMITIVE_SIZE="primitiveSizes",e.PRIMITIVE_STYLE="primitiveStyles",e.HIGHLIGHT_ID="highlightVisibility",e.CONTACT_TRACTION="contactTraction",e.CONTACT_PAIR_COORDINATE="contactPairCoordinate",e.INDEX="indices"}(OS||(OS={}));const RS={POINT:new AS(PS.POSITION,3,yS.FLOAT,OS.POINT),NORMAL:new AS(PS.NORMAL,3,yS.FLOAT,OS.NORMAL),OFFSET_VECTOR:new AS(PS.OFFSET_VECTOR,3,yS.FLOAT,OS.OFFSET_VECTOR),COLOR:new AS(PS.COLOR,4,yS.UNSIGNED_BYTE,OS.COLOR,!0),TEXTURE:new AS(PS.TEXTURE,2,yS.FLOAT,OS.TEXTURE),POINT_DATA:new AS(PS.POINT_DATA,1,yS.FLOAT,OS.POINT_DATA),EDGE_DATA:new AS(PS.EDGE_DATA,4,yS.FLOAT,OS.EDGE_DATA),PRIMITIVE_SIZE:new AS(PS.PRIMITIVE_SIZE,1,yS.FLOAT,OS.PRIMITIVE_SIZE),PRIMITIVE_STYLE:new AS(PS.PRIMITIVE_STYLE,4,yS.UNSIGNED_BYTE,OS.PRIMITIVE_STYLE),HIGHLIGHT_ID:new AS(PS.HIGHLIGHT_ID,4,yS.UNSIGNED_BYTE,OS.HIGHLIGHT_ID,!0),CONTACT_TRACTION:new AS(PS.CONTACT_TRACTION,4,yS.UNSIGNED_BYTE,OS.CONTACT_TRACTION,!1,4),CONTACT_PAIR_COORDINATE:new AS(PS.CONTACT_PAIR_COORDINATE,4,yS.FLOAT,OS.CONTACT_PAIR_COORDINATE,!1,4)};var wS;!function(e){e.LOWEST="LOWEST",e.LOW="LOW",e.MEDIUM="MEDIUM",e.HIGH="HIGH",e.DEFAULT="MEDIUM"}(wS||(wS={}));var vS=i(35104);const _S=_e.O.createLogger("MeshIncrement",k.bVy.GRAPHICS),NS=RS,bS={globallyUniqueId:!0,pickId:!0,properties:!0},LS=yh.create(),FS=ue.create(),xS=M.create(),BS=M.create();Math.pow(2,16);function VS(e,t){return t?t+"."+e:e}let US=1;const HS=function(e,t,i,s,n,r,a,o,h,c,l,d,u,g){return t[3*e+0]=o[0],t[3*e+1]=o[1],t[3*e+2]=o[2],h&&(i[3*e+0]=h[0],i[3*e+1]=h[1],i[3*e+2]=h[2]),c&&(s[4*e+0]=c[0],s[4*e+1]=c[1],s[4*e+2]=c[2],s[4*e+3]=c[3]),null!==l&&(n[e]=l),d&&(r[4*e+0]=d[0],r[4*e+1]=d[1],r[4*e+2]=d[2],r[4*e+3]=d[3]),a[4*e+0]=u[0],a[4*e+1]=u[1],a[4*e+2]=u[2],a[4*e+3]=g,e+1},GS=M.create(),kS=M.create(),WS=M.create(),zS=M.create(),XS=y.create(),ZS=y.create(),qS=M.create(),YS=M.create(),KS=y.create(),jS=y.create(),QS=M.create(),$S=M.create(),JS=M.create();class eT{addVertexAttribute(e){this.additionalVertexAttributes&&(this.additionalVertexAttributes.add(e.incrementProperty),this.totalVertexBufferDimensionSize+=e.dimension)}hasAsAVertexAttribute(e){return this.additionalVertexAttributes&&this.additionalVertexAttributes.has(e.incrementProperty)}constructor(e,t,i,s,n,r=!1){this.primitiveType=e,this.points=t,this.isPrecompiledBuffer=r,this.properties={},this.additionalVertexAttributes=null,this.totalVertexBufferDimensionSize=NS.POINT.dimension,this.id=s||"",this.indices=i,n||this.prepareForBuffering(),r&&(this.additionalVertexAttributes=new Set)}clone(e){const t=new eT(this.primitiveType,this.points,this.indices,this.id,!0,this.isPrecompiledBuffer);(0,j.overwriteMatchingProperties)(t,this,bS);for(const e in this.properties)bS[e]||(t.properties[e]=this.properties[e]);return e&&(t.ownerId=e),t.additionalVertexAttributes=this.additionalVertexAttributes,t.totalVertexBufferDimensionSize=this.totalVertexBufferDimensionSize,t}setProperty(e,t){null==t?delete this.properties[e]:this.properties[e]=t}set indices(e){this.setProperty("indices",e)}get indices(){return this.properties.indices||null}set normals(e){this.setProperty("normals",e)}get normals(){return this.properties.normals||null}set offsetVectors(e){this.setProperty("offsetVectors",e)}get offsetVectors(){return this.properties.offsetVectors||null}set colors(e){this.setProperty("colors",e)}get colors(){return this.properties.colors||null}set textureCoordinates(e){this.setProperty("textureCoordinates",e)}get textureCoordinates(){return this.properties.textureCoordinates||null}set primitiveSizes(e){this.setProperty("primitiveSizes",e)}get primitiveSizes(){return this.properties.primitiveSizes||null}set primitiveStyles(e){this.setProperty("primitiveStyles",e)}get primitiveStyles(){return this.properties.primitiveStyles||null}set contactTraction(e){this.setProperty("contactTraction",e)}get contactTraction(){return this.properties.contactTraction||null}set contactPairCoordinate(e){this.setProperty("contactPairCoordinate",e)}get contactPairCoordinate(){return this.properties.contactPairCoordinate||null}set pointData(e){this.setProperty("pointData",e)}get pointData(){return this.properties.pointData||null}set edgeData(e){this.setProperty("edgeData",e)}get edgeData(){return this.properties.edgeData||null}set pickId(e){this.setProperty("pickId",e)}get pickId(){return this.properties.pickId||void 0}set groupId(e){this.setProperty("groupId",e)}get groupId(){return this.properties.groupId||""}set ownerId(e){this.setProperty("ownerId",e)}get ownerId(){return this.properties.ownerId||""}set boundingBox(e){this.setProperty("boundingBox",e)}get boundingBox(){return this.properties.boundingBox||null}set globallyUniqueId(e){this.setProperty("globallyUniqueId",e)}get globallyUniqueId(){return this.properties.globallyUniqueId||null}set lod(e){this.setProperty("lod",e)}get lod(){return this.properties.lod||wS.DEFAULT}getFullId(){return VS(this.id,this.ownerId)}getFullGroupId(){return VS(this.groupId,this.ownerId)}isAPrecompiledBuffer(){return this.isPrecompiledBuffer}getPoint(e,t){const i=3*e;return e<0||i>=this.points.length?null:t?(t[0]=this.points[i],t[1]=this.points[i+1],t[2]=this.points[i+2],t):this.points instanceof Float32Array?this.points.subarray(i,i+3):this.points.slice(i,i+3)}getLinesLength(){if(this.primitiveType!==Ai.MX.LINES)return-1;this.isPreparedForBuffering()||this.prepareForBuffering();let e=0;for(let t=0;t<this.indices.length;t+=6)e+=ge.S4.dist(this.getPoint(this.indices[t+0]),this.getPoint(this.indices[t+1]));return e}getPositionAtDistanceAlongLines(e){if(this.primitiveType!==Ai.MX.LINES)return null;this.isPreparedForBuffering()||this.prepareForBuffering();let t=0;for(let i=0;i<this.indices.length;i+=6){const s=this.getPoint(this.indices[i+0]),n=this.getPoint(this.indices[i+1]),r=ge.S4.dist(s,n);if(t+r>=e){const i=(e-t)/r;return ge.S4.add(s,ge.S4.scale(ge.S4.subtract(n,s,M.create()),i),M.create())}t+=r}return null}getLineDirection(e){if(!this.isLines())return null;if(this.isPreparedForBuffering()||this.prepareForBuffering(),e<0||6*(e+1)>this.indices.length)return null;const t=6*e,i=ge.S4.subtract(this.getPoint(this.indices[t+1]),this.getPoint(this.indices[t+0]),M.create());return ge.S4.normalize(i)}getRepresentativeDirection(){return this.isLines()?this.getLineDirection(0):this.isTriangles()&&this.normals&&this.normals.length>=3?this.normals instanceof Float32Array?this.normals.subarray(0,3):this.normals.slice(0,3):null}equals(e){return!(!e||this.primitiveType!==e.primitiveType)&&(this.id===e.id&&(null===this.additionalVertexAttributes&&null===e.additionalVertexAttributes||(0,vS.n)(this.additionalVertexAttributes,e.additionalVertexAttributes))&&this.totalVertexBufferDimensionSize===e.totalVertexBufferDimensionSize&&(0,pi.arraysEqual)(this.pickId,e.pickId)&&(0,pi.arraysEqual)(this.points,e.points)&&(0,pi.arraysEqual)(this.indices,e.indices)&&(0,pi.arraysEqual)(this.normals,e.normals)&&(0,pi.arraysEqual)(this.offsetVectors,e.offsetVectors)&&(0,pi.arraysEqual)(this.colors,e.colors)&&(0,pi.arraysEqual)(this.textureCoordinates,e.textureCoordinates)&&(0,pi.arraysEqual)(this.primitiveSizes,e.primitiveSizes)&&(0,pi.arraysEqual)(this.primitiveStyles,e.primitiveStyles)&&(0,pi.arraysEqual)(this.pointData,e.pointData)&&(0,pi.arraysEqual)(this.edgeData,e.edgeData))}getBounds(){if(!this.boundingBox){const e=RS.POINT.dimension,t=this.getTotalVertexBufferDimensionsSize();this.boundingBox=new wi.kB;const i=this.boundingBox,s=this.points.length/t*e;for(let t=0;t<s;t+=e)i.addXYZ(this.points[t],this.points[t+1],this.points[t+2])}return this.boundingBox}getGloballyUniqueId(){return this.globallyUniqueId||(this.globallyUniqueId=US,US+=1),this.globallyUniqueId}isPreparedForBuffering(){return this.isPrecompiledBuffer||this.isTriangles()||this.isPoints()&&!!this.pointData||this.isLines()&&!!this.edgeData}hasAttribute(e){const t=RS[e];if(!t)return!1;const i=t.incrementProperty;return!(this.isPrecompiledBuffer||!(this.isLines()&&"edgeData"===i||this.isPoints()&&"pointData"===i))||(!(!this.isPrecompiledBuffer||!this.additionalVertexAttributes.has(i))||!!this[i])}getPrimitiveType(){return this.primitiveType}prepareForBuffering(){this.isPrecompiledBuffer||(this.points&&this.indices&&!this.pointData&&this.isPoints()&&this.createPointData(),this.points&&this.indices&&!this.edgeData&&this.isLines()&&this.createEdgeData())}isPoints(){return this.primitiveType===Ai.MX.POINTS}isLines(){return this.primitiveType===Ai.MX.LINES||this.primitiveType===Ai.MX.INFINITE_LINES||this.primitiveType===Ai.MX.SILHOUETTES}isTriangles(){return this.primitiveType===Ai.MX.TRIANGLES||this.primitiveType===Ai.MX.TRIANGLE_STRIP}getTriangleCount(){return this.primitiveType===Ai.MX.TRIANGLES?this.indices.length/3:this.primitiveType===Ai.MX.TRIANGLE_STRIP?this.indices.length-2:0}getLineCount(){return this.isLines()?this.isPreparedForBuffering()?this.indices.length/6:this.indices.length/2:0}createPointData(){const e=this.indices.length,t=4*e,i=6*e,s=new Float32Array(NS.POINT.dimension*t),n=new Int32Array(i),r=this.colors?new Uint8Array(NS.COLOR.dimension*t):null,a=this.primitiveSizes?new Float32Array(NS.PRIMITIVE_SIZE.dimension*t):null,o=this.primitiveStyles?new Uint8Array(NS.PRIMITIVE_STYLE.dimension*t):null,h=new Float32Array(NS.POINT_DATA.dimension*t);let c=0;const l=function(e,t,i,n,l){s[3*c+0]=e[0],s[3*c+1]=e[1],s[3*c+2]=e[2],t&&(r[4*c+0]=t[0],r[4*c+1]=t[1],r[4*c+2]=t[2],r[4*c+3]=t[3]),null!==i&&(a[c]=i),n&&(o[4*c+0]=n[0],o[4*c+1]=n[1],o[4*c+2]=n[2],o[4*c+3]=n[3]),h[c]=l,c+=1};let d=0;for(let t=0;t<e;++t){const e=this.indices[t],i=[this.points[3*e+0],this.points[3*e+1],this.points[3*e+2]];let s=null;if(this.colors){s=[this.colors[4*e+0],this.colors[4*e+1],this.colors[4*e+2],this.colors[4*e+3]]}let r=null;this.primitiveSizes&&(r=this.primitiveSizes[4*e]);let a=null;if(this.primitiveStyles){a=[this.primitiveStyles[4*e+0],this.primitiveStyles[4*e+1],this.primitiveStyles[4*e+2],this.primitiveStyles[4*e+3]]}l(i,s,r,a,1),l(i,s,r,a,2),l(i,s,r,a,3),l(i,s,r,a,4),n[6*t+0]=d+0,n[6*t+1]=d+1,n[6*t+2]=d+2,n[6*t+3]=d+0,n[6*t+4]=d+2,n[6*t+5]=d+3,d+=4}this.points=s,this.indices=n,this.colors=r,this.primitiveSizes=a,this.primitiveStyles=o,this.pointData=h,this.normals=null,this.textureCoordinates=null}createEdgeData(){this.indices.length%2!=0&&_S.warn("Trying to create lines with an odd number of indices");const e=Math.floor(this.indices.length/2),t=4*e,i=6*e,s=new Float32Array(NS.POINT.dimension*t),n=new Int32Array(i),r=this.normals?new Float32Array(NS.NORMAL.dimension*t):null,a=this.colors?new Uint8Array(NS.COLOR.dimension*t):null,o=this.primitiveSizes?new Float32Array(NS.PRIMITIVE_SIZE.dimension*t):null,h=this.primitiveStyles?new Uint8Array(NS.PRIMITIVE_STYLE.dimension*t):null,c=new Float32Array(NS.EDGE_DATA.dimension*t);let l=0,d=0,u=1;for(let t=0;t<e;++t){const e=this.indices[2*t+0],i=M.set(WS,this.points[3*e+0],this.points[3*e+1],this.points[3*e+2]),g=this.normals?M.set(zS,this.normals[3*e+0],this.normals[3*e+1],this.normals[3*e+2]):null,p=this.colors?y.set(XS,this.colors[4*e+0],this.colors[4*e+1],this.colors[4*e+2],this.colors[4*e+3]):null,m=this.primitiveSizes?this.primitiveSizes[e]:null,f=this.primitiveStyles?y.set(ZS,this.primitiveStyles[4*e+0],this.primitiveStyles[4*e+1],this.primitiveStyles[4*e+2],this.primitiveStyles[4*e+3]):null,I=this.indices[2*t+1];let E=M.set(qS,this.points[3*I+0],this.points[3*I+1],this.points[3*I+2]);const S=this.normals?M.set(YS,this.normals[3*I+0],this.normals[3*I+1],this.normals[3*I+2]):null,T=this.colors?y.set(KS,this.colors[4*I+0],this.colors[4*I+1],this.colors[4*I+2],this.colors[4*I+3]):null,D=this.primitiveSizes?this.primitiveSizes[I]:null,C=this.primitiveStyles?y.set(jS,this.primitiveStyles[4*I+0],this.primitiveStyles[4*I+1],this.primitiveStyles[4*I+2],this.primitiveStyles[4*I+3]):null,A=ge.S4.subtract(E,i,GS),P=ge.S4.length(A);ge.S4.normalize(A);let O=u;u+=P;let R=u;this.primitiveType===Ai.MX.INFINITE_LINES&&(O=-O,R=-R,E=i),l=HS(l,s,r,a,o,h,c,i,g,p,m,f,ge.S4.scale(A,1,kS),O),l=HS(l,s,r,a,o,h,c,E,S,T,D,C,ge.S4.scale(A,2,kS),R),l=HS(l,s,r,a,o,h,c,E,S,T,D,C,ge.S4.scale(A,3,kS),R),l=HS(l,s,r,a,o,h,c,i,g,p,m,f,ge.S4.scale(A,4,kS),O),n[6*t+0]=d+0,n[6*t+1]=d+1,n[6*t+2]=d+2,n[6*t+3]=d+0,n[6*t+4]=d+2,n[6*t+5]=d+3,d+=4}this.points=s,this.indices=n,this.normals=r,this.colors=a,this.primitiveSizes=o,this.primitiveStyles=h,this.edgeData=c,this.textureCoordinates=null}createTransformed(e){let t;const i=[0,0,0],s=ge.w$.toMat3(ge.w$.toRotationMat(e,FS),LS),n=this.clone();for(n.boundingBox=null,n.points=new Float32Array(n.points.length),t=0;t<this.points.length;t+=3)i[0]=this.points[t],i[1]=this.points[t+1],i[2]=this.points[t+2],ge.w$.multiplyVec3(e,i),n.points[t]=i[0],n.points[t+1]=i[1],n.points[t+2]=i[2];function r(e){const n=new Float32Array(e.length);for(t=0;t<e.length;t+=3)i[0]=e[t],i[1]=e[t+1],i[2]=e[t+2],ge.xB.multiplyVec3(s,i),ge.S4.normalize(i),n[t]=i[0],n[t+1]=i[1],n[t+2]=i[2];return n}if(this.normals&&(n.normals=r(this.normals)),this.offsetVectors&&(n.offsetVectors=r(this.offsetVectors)),this.edgeData){const e=this.edgeData,r=new Float32Array(n.edgeData.length);for(t=0;t<this.edgeData.length;t+=4){i[0]=e[t],i[1]=e[t+1],i[2]=e[t+2];const n=ge.S4.length(i);ge.xB.multiplyVec3(s,i),ge.S4.scale(i,n/ge.S4.length(i)),r[t]=i[0],r[t+1]=i[1],r[t+2]=i[2],r[t+3]=this.edgeData[t+3]}n.edgeData=r}return n}concatenate(e){if(!(e&&e.primitiveType===this.primitiveType&&(0,j.objectsDefinedInSameWay)(this.normals,e.normals)&&(0,j.objectsDefinedInSameWay)(this.offsetVectors,e.offsetVectors)&&(0,j.objectsDefinedInSameWay)(this.colors,e.colors)&&(0,j.objectsDefinedInSameWay)(this.textureCoordinates,e.textureCoordinates)&&(0,j.objectsDefinedInSameWay)(this.primitiveSizes,e.primitiveSizes)&&(0,j.objectsDefinedInSameWay)(this.primitiveStyles,e.primitiveStyles)&&(0,j.objectsDefinedInSameWay)(this.edgeData,e.edgeData)&&(0,j.objectsDefinedInSameWay)(this.pointData,e.pointData)))return null;const t=(0,Xs.Mz)(this.points,e.points),i=new Int32Array(this.indexLengthWithDegenerates()+e.indices.length);i.set(this.indices);const s=this.indexLengthWithDegenerates(),n=this.vertexCount();for(let t=0;t<e.indices.length;++t)i[s+t]=e.indices[t]+n;this.primitiveType===Ai.MX.TRIANGLE_STRIP&&(i[s-2]=this.indices[this.indices.length-1],this.indices.length%2&&(i[s-3]=this.indices[this.indices.length-1]),i[s-1]=e.indices[0]+n);const r=new eT(this.primitiveType,t,i,void 0,!0);return this.normals&&e.normals&&(r.normals=(0,Xs.Mz)(this.points,e.points)),this.colors&&e.colors&&(r.colors=(0,Xs.Lf)(this.colors,e.colors)),this.textureCoordinates&&e.textureCoordinates&&(r.textureCoordinates=(0,Xs.Mz)(this.textureCoordinates,e.textureCoordinates)),this.primitiveSizes&&e.primitiveSizes&&(r.primitiveSizes=(0,Xs.Mz)(this.primitiveSizes,e.primitiveSizes)),this.primitiveStyles&&e.primitiveStyles&&(r.primitiveStyles=(0,Xs.Lf)(this.primitiveStyles,e.primitiveStyles)),this.edgeData&&e.edgeData&&(r.edgeData=(0,Xs.Mz)(this.edgeData,e.edgeData)),this.pointData&&e.pointData&&(r.pointData=(0,Xs.Mz)(this.pointData,e.pointData)),this.offsetVectors&&e.offsetVectors&&(r.offsetVectors=(0,Xs.Mz)(this.offsetVectors,e.offsetVectors)),r}indexLengthWithDegenerates(){return this.primitiveType!==Ai.MX.TRIANGLE_STRIP||this.isPrecompiledBuffer?this.indices.length:this.indices.length%2==0?this.indices.length+2:this.indices.length+3}getTotalVertexBufferDimensionsSize(){return this.totalVertexBufferDimensionSize}vertexCount(){return this.points.length/this.getTotalVertexBufferDimensionsSize()}getPreparedVertexCount(){return this.isPreparedForBuffering()?this.vertexCount():4*this.vertexCount()}getPreparedIndexCount(){if(this.isPreparedForBuffering())return this.indexLengthWithDegenerates();if(this.isLines()){return 6*Math.floor(this.indices.length/2)}return this.isPoints()?6*this.indices.length:(_S.warn("Found unprepared increment that was not lines or points"),this.indexLengthWithDegenerates())}getVertexSize(){let e=0;for(const t in RS){const i=RS[t];(this.hasAttribute(t)||i.name===PS.OCCURRENCE_ID)&&(e+=i.sizeInBytes())}return e}iteratePrimitives(e){switch(this.primitiveType){case Ai.MX.POINTS:this.iteratePoints(e);break;case Ai.MX.LINES:this.iterateLines(e);break;case Ai.MX.TRIANGLES:this.iterateTriangles(e);break;case Ai.MX.TRIANGLE_STRIP:this.iterateTriangleStrip(e);break;default:_S.warn("Cannot iterate over primitive type "+this.primitiveType)}}iteratePoints(e){this.prepareForBuffering();for(let t=0;t<this.indices.length;t+=6)e(this.getPoint(this.indices[t],QS))}iterateLines(e){this.prepareForBuffering();for(let t=0;t<this.indices.length;t+=6)e(this.getPoint(this.indices[t],QS),this.getPoint(this.indices[t+1],$S))}iterateTriangles(e){const t=Math.floor(this.indices.length/3);for(let i=0;i<3*t;i+=3)e(this.getPoint(this.indices[i],QS),this.getPoint(this.indices[i+1],$S),this.getPoint(this.indices[i+2],JS))}iterateTriangleStrip(e){for(let t=0;t<this.indices.length-2;++t)this.indices[t]!==this.indices[t+1]&&this.indices[t]!==this.indices[t+2]&&this.indices[t+1]!==this.indices[t+2]&&(t%2?e(this.getPoint(this.indices[t],QS),this.getPoint(this.indices[t+2],$S),this.getPoint(this.indices[t+1],JS)):e(this.getPoint(this.indices[t],QS),this.getPoint(this.indices[t+1],$S),this.getPoint(this.indices[t+2],JS)))}getPositionNearCenter(){return this.getPositionNearPoint(this.getBounds().center()).position}getPositionNearPoint(e){let t=null,i=1/0;function s(s){const n=ge.S4.distanceSquared(e,s);n<i&&(t=M.clone(s),i=n)}function n(t,i){s((0,wi.vu)(t,i,e))}return this.iteratePrimitives((function(e,t,i){t||i?i?function(e,t,i){n(e,t),n(t,i),n(i,e);const r=xS;ge.S4.add(r,ge.S4.scale(e,1/3,BS)),ge.S4.add(r,ge.S4.scale(t,1/3,BS)),ge.S4.add(r,ge.S4.scale(i,1/3,BS)),s(r)}(e,t,i):n(e,t):s(e)})),{position:t,distance:i}}packScalarsIntoTextureCoordinates(e){const t=new Float32Array(this.vertexCount()*RS.TEXTURE.dimension);if(e.length!==this.vertexCount())return void _S.debug(`Scalars of length ${e.length} did not match increment vertex count of ${this.vertexCount()}`);const i=[1,0];for(let s=0;s<this.vertexCount();++s)i[1]=e[s],t.set(i,RS.TEXTURE.dimension*s);this.textureCoordinates=t}replicateTextureCoordinate(e){const t=new Float32Array(this.vertexCount()*RS.TEXTURE.dimension);for(let i=0;i<this.vertexCount();++i)t.set(e,RS.TEXTURE.dimension*i);this.textureCoordinates=t}}var tT=i(68822);class iT{constructor(){this.bufferSetRanges=new Fi.N,this.boundables=new Set,this.iterator=new tT.I,this.listenForDeletions=!1,this.listenerId=kT()}getMeshGroupId(){return null}destroy(){this.setListenForDeletions(!1)}copyDataTo(e){const t=this.bufferSetRanges.getKeyValues();for(let i=0;i<t.length;i+=2)e.bufferSetRanges.set(t[i],pS(t[i+1]));e.boundables=new Set(this.boundables),e.setListenForDeletions(this.listenForDeletions)}getListenerId(){return this.listenerId}onIncrementDeleted(e){this.onIncrementRemoved(e)}setListenForDeletions(e){if(this.listenForDeletions===e)return;this.listenForDeletions=e;const t=this.bufferSetRanges.getKeyValues();for(let e=0;e<t.length;e+=2)this.listenForDeletions?t[e].addIncrementDeletionListener(this):t[e].removeIncrementDeletionListener(this)}isEmpty(){return 0===this.bufferSetRanges.size}onIncrementAdded(e,t){let i=this.bufferSetRanges.get(e.bufferSet);i||(i=[],this.bufferSetRanges.set(e.bufferSet,i));let s=e.indexRange;return t&&(s=[s[0],s[1],t]),dS(s,i),this.damageBounds(),!0}onIncrementRemoved(e){const t=this.bufferSetRanges.get(e.bufferSet);return!!t&&(uS(e.indexRange,t),0===t.length&&this.bufferSetRanges.delete(e.bufferSet),this.damageBounds(),!0)}addBoundable(e){this.boundables.add(e)}removeBoundable(e){this.boundables.delete(e)}damageBounds(){for(const e of this.boundables.values())e.damageBounds()}isCheaplyBoundable(){return!1}getRangeIteratorForBufferSet(e){const t=this.bufferSetRanges.get(e);return t?(this.iterator.resetForRangeSet(t),this.iterator):null}shouldDrawForOccurrences(e){return!0}draw(e,t){const i=this.bufferSetRanges.getKeyValues();for(let s=0;s<i.length;s+=2)i[s].draw(e,t||this)}getChildSceneDebugObjects(){const e=[],t=this.bufferSetRanges.getKeyValues();for(let i=0;i<t.length;i+=2){const s=t[i];e.push({text:"Bufferset "+(s.getIsForPrecompiledIncrements()?"(For precompiled increments) ":"")+s.getDebugId()+", ranges: ("+gS(t[i+1])+")",children:[]})}return e}}var sT=i(46560);class nT extends sT.Y{constructor(){super(),this.operandA=null,this.currentARange=null,this.operandB=null,this.currentBRange=null}reset(e,t){this.operandA=e,this.currentARange=null,this.operandB=t,this.currentBRange=null,this.nextResult=this.findNextRange()}findNextRange(){if(this.currentARange||(this.currentARange=this.operandA.getNextRange()),!this.currentARange)return null;for(;this.bIsBehind();)this.currentBRange=this.operandB.getNextRange();if(!this.currentBRange)return null;if(this.currentARange[1]<=this.currentBRange[0])return this.currentARange=null,this.findNextRange();const e=this.getStorageForNextResult();return e[2]=this.currentARange[2],this.currentARange[0]>=this.currentBRange[0]?e[0]=this.currentARange[0]:e[0]=this.currentBRange[0],this.currentARange[1]<=this.currentBRange[1]?(e[1]=this.currentARange[1],this.currentARange[1]===this.currentBRange[1]&&(this.currentBRange=null),this.currentARange=null):(e[1]=this.currentBRange[1],this.currentBRange=null),e}bIsBehind(){return this.currentBRange?this.currentBRange[1]<=this.currentARange[0]:this.operandB.hasMoreRanges()}}class rT{constructor(){this.operandA=null,this.operandB=null,this.iterator=new nT}setOperandA(e){this.operandA=e}setOperand(e){this.operandB=e}getRangeIteratorForBufferSet(e){if(!this.operandA||!this.operandB)return null;const t=this.operandA.getRangeIteratorForBufferSet(e);if(!t)return null;const i=this.operandB.getRangeIteratorForBufferSet(e);return i?(this.iterator.reset(t,i),this.iterator):null}makeSceneDebugObject(){const e={text:"IntersectOperator",children:[]};return(0,Xs.n9)(e,this.operandA),(0,Xs.n9)(e,this.operandB),e}}function aT(e){return t=>{const i=t.getAttribute(RS.COLOR);if(i){const s=t.clone(),n=i.slice();return n[3]*=e,s.setAttribute(RS.COLOR,n),s}return t}}class oT{constructor(e){this.styleModifier=e,this.baseIterator=null}reset(e){return this.baseIterator=e,this}hasMoreRanges(){return this.baseIterator.hasMoreRanges()}getNextRange(){const e=this.baseIterator.getNextRange();if(e){const t=[e[0],e[1],e[2]];return t[2]&&(t[2]=this.styleModifier(t[2])),t}return null}}class hT{constructor(e){this.baseOperand=null,this.iterator=new oT(e)}setOperand(e){this.baseOperand=e}getRangeIteratorForBufferSet(e){if(!this.baseOperand)return null;const t=this.baseOperand.getRangeIteratorForBufferSet(e);return t?this.iterator.reset(t):null}makeSceneDebugObject(){const e={text:"StyleModificationOperator",children:[]};return(0,Xs.n9)(e,this.baseOperand),e}}class cT extends fS.q{constructor(){super(4),this.baseIterator=null,this.currentBaseRange=null,this.currentBaseOffset=-1,this.overwriteIterator=null,this.currentOverwriteRange=null,this.defaultStyle=null}setDefaultStyle(e){this.defaultStyle=e}reset(e,t){return this.baseIterator=e,this.currentBaseRange=null,this.currentBaseOffset=-1,this.overwriteIterator=t,this.currentOverwriteRange=null,this.nextResult=this.findNextRange(),this}findNextRange(){if(this.currentBaseRange||(this.currentBaseRange=this.baseIterator.getNextRange(),this.currentBaseOffset=-1),!this.currentBaseRange)return null;for(;this.overwriteIteratorIsBehind();)this.currentOverwriteRange=this.overwriteIterator.getNextRange();const e=this.getStorageForNextResult();if(!this.currentOverwriteRange||this.currentOverwriteRange[0]>=this.currentBaseRange[1])e[0]=this.currentBaseOffset>=0?this.currentBaseOffset:this.currentBaseRange[0],e[1]=this.currentBaseRange[1],e[2]=(0,mS.TS)(this.defaultStyle,this.currentBaseRange[2],this.getStyleMergeStorage()),this.currentBaseRange=null;else{const t=this.currentBaseOffset>=0?this.currentBaseOffset:this.currentBaseRange[0];e[0]=t;const i=(0,mS.TS)(this.defaultStyle,this.currentBaseRange[2],this.getStyleMergeStorage());this.currentOverwriteRange[0]<=t?(e[2]=(0,mS.TS)(i,this.currentOverwriteRange[2],this.getStyleMergeStorage()),this.currentBaseRange[1]<this.currentOverwriteRange[1]?(e[1]=this.currentBaseRange[1],this.currentBaseRange=null):this.currentBaseRange[1]>this.currentOverwriteRange[1]?(e[1]=this.currentOverwriteRange[1],this.currentBaseOffset=this.currentOverwriteRange[1],this.currentOverwriteRange=null):(e[1]=this.currentBaseRange[1],this.currentBaseRange=null,this.currentOverwriteRange=null)):(e[1]=this.currentOverwriteRange[0],e[2]=i,this.currentBaseOffset=this.currentOverwriteRange[0])}return e}overwriteIteratorIsBehind(){if(this.overwriteIterator){if(this.currentOverwriteRange){const e=this.currentBaseOffset>=0?this.currentBaseOffset:this.currentBaseRange[0];return this.currentOverwriteRange[1]<=e}return this.overwriteIterator.hasMoreRanges()}return!1}}class lT{constructor(){this.baseOperand=null,this.overwriteOperand=null,this.iterator=new cT}setDefaultStyle(e){this.iterator.setDefaultStyle(e)}setOverwriteOperand(e){this.overwriteOperand=e}setOperand(e){this.baseOperand=e}getRangeIteratorForBufferSet(e){if(!this.baseOperand)return null;const t=this.baseOperand.getRangeIteratorForBufferSet(e);if(!t)return null;const i=this.overwriteOperand?this.overwriteOperand.getRangeIteratorForBufferSet(e):null;return this.iterator.reset(t,i)}makeSceneDebugObject(){const e={text:"StyleOverwriteOperator",children:[]};return(0,Xs.n9)(e,this.baseOperand),(0,Xs.n9)(e,this.overwriteOperand),e}}let dT=new rT,uT=new jr,gT=new lT,pT={};const mT=new mS.bg;mT.setAttribute(RS.HIGHLIGHT_ID,[0,0,0,0]);class fT{constructor(){this.entityHighlightRanges=new Map,this.entityHighlights=new Map,this.occurrenceHighlights=new Map}destroy(){for(const e of this.entityHighlightRanges.values())e.destroy();this.occurrenceHighlights.clear()}hasHighlight(){if(this.occurrenceHighlights.size>0)return!0;for(const e of this.entityHighlightRanges.values())if(!e.isEmpty())return!0;return!1}hasHighlightOfType(e){return this.entityHighlightRanges.has(e)}entityHasHighlight(e){if(this.occurrenceHighlights.size>0)return!0;for(const t of this.entityHighlightRanges.values())if(t.containsIncrement(e))return!0;return!1}getEntityHighlights(e){return this.entityHighlights.get(e)}removeEntityHighlights(e){this.entityHighlights.delete(e)}getOrCreateEntityRangesForType(e){let t=this.entityHighlightRanges.get(e);return t||(t=new qT(e),this.entityHighlightRanges.set(e,t),t.setListenForDeletions(!0)),t}updateEntityHighlight(e,t,i){const s=this.getOrCreateEntityRangesForType(t.type),n=(0,Gl.getOrCreateSubMap)(this.entityHighlights,i),r=this.getHighestPriorityHighlightFromMap(n);if(e===Cn.aU.ADD){if(n.set(t.getIdString(),t),!r||r.priority<t.priority){if(r){const e=this.entityHighlightRanges.get(r.type);e&&e.onIncrementRemoved(i)}s.onIncrementAdded(i,t.getStyle())}}else{n.delete(t.getIdString()),s.onIncrementRemoved(i);const e=this.getHighestPriorityHighlightFromMap(n);if(e){this.getOrCreateEntityRangesForType(e.type).onIncrementAdded(i,e.getStyle())}s.isEmpty()&&(this.entityHighlightRanges.delete(t.type),s.destroy()),0===n.size&&this.entityHighlights.delete(i)}}updateOccurrenceHighlight(e,t){let i;e===Cn.aU.ADD?(i=(0,Gl.getOrCreateSubMap)(this.occurrenceHighlights,t.type),i.set(t.getIdString(),t)):(i=this.occurrenceHighlights.get(t.type),i&&(i.delete(t.getIdString()),0===i.size&&this.occurrenceHighlights.delete(t.type)))}getHighestPriorityOccurrenceHighlight(){if(0===this.occurrenceHighlights.size)return null;let e=null;for(const t of this.occurrenceHighlights.values())for(const i of t.values())(!e||i.priority>e.priority)&&(e=i);return e}clearHighlight(e){this.occurrenceHighlights.delete(e.type);const t=this.entityHighlightRanges.get(e.type);t&&(this.entityHighlightRanges.delete(e.type),t.destroy()),this.entityHighlights.forEach(((t,i)=>{let s=!1;if(t.forEach(((i,n)=>{i.type===e.type&&(s=!0,t.delete(n))})),s)if(t.size>0){const s=this.getHighestPriorityHighlightFromMap(t);if(s&&s.priority<=e.priority){this.getOrCreateEntityRangesForType(s.type).onIncrementAdded(i,s.getStyle())}}else this.entityHighlights.delete(i)}))}clearAllOccurrenceLevelHighlights(){this.occurrenceHighlights.clear()}getUnionOperator(e,t){let i=pT[e];return i||(pT[e]=i=new ST),i.setOperandA(t),i.setOperand(null),i}getHighestPriorityHighlightFromMap(e){if(!e)return null;let t=null;for(const i of e.values())(!t||i.priority>t.priority)&&(t=i);return t}getFirstHighlightFromMap(e){if(e)for(const t of e.values())return t;return null}getFirstOccurrenceHighlightOfType(e){return this.getFirstHighlightFromMap(this.occurrenceHighlights.get(e))}getHighlightOperator(e){const t=e.getActiveHighlightType(),i=this.getFirstOccurrenceHighlightOfType(t);if(i)return e.applyStyle(i.getStyle()),null;const s=this.entityHighlightRanges.get(t);return s?(dT.setOperandA(s),dT):CS}getHighlightStyleOperator(e,t){if(!e.getActiveShader().hasAttribute(PS.HIGHLIGHT_ID)||!this.hasHighlight())return t;const i=gT;i.setDefaultStyle(mT);let s=null,n=null;const r=e.getActiveHighlightType(),a=e.getViewer().getReferenceHighlights().getSortedHighlights();for(let e=0;e<a.length;++e){const t=a[e].type;if(r&&t!==r)continue;const o=this.getFirstOccurrenceHighlightOfType(t);if(o){i.setDefaultStyle(o.getStyle()),s=null,n=null;continue}const h=this.entityHighlightRanges.get(t);if(h){const t=this.getUnionOperator(e,h);s||(s=t),n&&n.setOperand(t),n=t}}return i.setOverwriteOperand(s),t?uT.resetWithOperands(t,i):i}makeSceneDebugObject(e){const t=[],i=[];for(const e of this.entityHighlightRanges.values())i.push(e.makeSceneDebugObject());t.push({text:"entityHighlightRanges",children:i}),t.push({text:"entityHighlights",children:this.getEntityHighlightsDebugInfo()});const s=[];return this.occurrenceHighlights.forEach(((e,t)=>{const i=[];for(const t of e.keys())i.push({text:t.toString(),children:[]});s.push({text:t.toString(),children:i})})),t.push({text:"occurrenceHighlights",children:s}),{text:e,children:t}}getEntityHighlightsDebugInfo(){const e=[];return this.entityHighlights.forEach(((t,i)=>{const s=[];for(const e of t.keys()){const i=[],n=t.get(e);n.debugStack&&i.push({text:"Stack: "+n.debugStack}),s.push({text:e.toString(),children:i})}e.push({text:i.increment.id,children:s})})),e}}function IT(){dT=new rT,uT=new jr,gT=new lT,pT={}}class ET extends sT.Y{constructor(){super(),this.iteratorA=null,this.currentARange=null,this.currentAOffset=-1,this.iteratorB=null,this.currentBRange=null,this.currentBOffset=-1}reset(e,t){return this.iteratorA=e,this.currentARange=null,this.currentAOffset=-1,this.iteratorB=t,this.currentBRange=null,this.currentBOffset=-1,this.nextResult=this.findNextRange(),this}findNextRange(){if(this.currentARange||(this.currentARange=this.iteratorA.getNextRange(),this.currentAOffset=-1),this.currentBRange||(this.currentBRange=this.iteratorB.getNextRange(),this.currentBOffset=-1),!this.currentARange&&!this.currentBRange)return null;const e=this.getStorageForNextResult();if(!this.currentARange){const t=this.currentBOffset>=0?this.currentBOffset:this.currentBRange[0];return e[0]=t,e[1]=this.currentBRange[1],e[2]=this.currentBRange[2],this.currentBRange=null,e}if(!this.currentBRange){const t=this.currentAOffset>=0?this.currentAOffset:this.currentARange[0];return e[0]=t,e[1]=this.currentARange[1],e[2]=this.currentARange[2],this.currentARange=null,e}const t=this.currentAOffset>=0?this.currentAOffset:this.currentARange[0],i=this.currentBOffset>=0?this.currentBOffset:this.currentBRange[0];return t<i?(e[0]=t,e[2]=this.currentARange[2],i<this.currentARange[1]?(e[1]=i,this.currentAOffset=i):(e[1]=this.currentARange[1],this.currentARange=null)):i<t?(e[0]=i,e[2]=this.currentBRange[2],t<this.currentBRange[1]?(e[1]=t,this.currentBOffset=t):(e[1]=this.currentBRange[1],this.currentBRange=null)):(e[0]=i,e[2]=this.currentBRange[2],this.currentARange[1]<this.currentBRange[1]?(e[1]=this.currentARange[1],this.currentBOffset=this.currentARange[1],this.currentARange=null):this.currentBRange[1]<this.currentARange[1]?(e[1]=this.currentBRange[1],this.currentAOffset=this.currentBRange[1],this.currentBRange=null):(e[1]=this.currentARange[1],this.currentARange=null,this.currentBRange=null)),e}}class ST{constructor(){this.operandA=null,this.operandB=null,this.iterator=new ET}setOperandA(e){this.operandA=e}setOperand(e){this.operandB=e}getRangeIteratorForBufferSet(e){const t=this.operandA?this.operandA.getRangeIteratorForBufferSet(e):null,i=this.operandB?this.operandB.getRangeIteratorForBufferSet(e):null;return t||i?t?i?this.iterator.reset(t,i):t:i:null}makeSceneDebugObject(){const e={text:"StyleUnionOperator",children:[]};return(0,Xs.n9)(e,this.operandA),(0,Xs.n9)(e,this.operandB),e}}const TT=_e.O.createLogger("Buffer",k.bVy.GRAPHICS);let DT=!1;function CT(){return DT}function MT(e){DT=e}const yT=[];function AT(e,t){let i=1/0,s=-1,n=1/0,r=-1;for(let t=0;t<yT.length;++t)yT[t].byteLength>=e&&yT[t].byteLength<n?(n=yT[t].byteLength,r=t):yT[t].byteLength<i&&(i=yT[t].byteLength,s=t);if(r>=0){const i=yT[r];return t&&(0,Xs.rS)(i,e),yT.splice(r,1),i}return s>=0&&yT.splice(s,1),new ArrayBuffer(e)}function PT(e){e&&yT.push(e)}class OT{constructor(e,t,i,s){this.viewer=e,this.target=i,this.componentCount=s,this.GAUGE_MEMORY_TYPE="Vertex buffer",this.scratchSpace=null,this.floatView=null,this.indexView=null,this.uint8View=null,this.initialCopyPerformed=!1,this.rangesToCopy=[],this.gl=this.viewer.getGlContext(),this.size=t,this.webGlBuffer=this.gl.createBuffer(),this.webGlBuffer||TT.error("Failed to create gl buffer")}ensureScratchSpace(){if(!this.scratchSpace){const e=!this.initialCopyPerformed;this.scratchSpace=AT(this.size,e)}}releaseScratchSpace(){this.scratchSpace&&!CT()&&(PT(this.scratchSpace),this.scratchSpace=null,this.floatView=null,this.indexView=null,this.uint8View=null)}destroy(){this.gl&&this.webGlBuffer&&this.gl.deleteBuffer(this.webGlBuffer),this.webGlBuffer&&this.viewer.getMemoryGauge().decrementMemoryUsage(this.GAUGE_MEMORY_TYPE,this.size),this.webGlBuffer=null}getComponentCount(){return this.componentCount}copyToGl(){if(!this.scratchSpace)return this.rangesToCopy.length>0&&TT.warn("Encountered buffer with ranges that need copying, but no scratch space to copy from"),!1;let e;return e=this.initialCopyPerformed?this.copyPartialUpdatesToGl():this.copyWholeBufferToGl(),this.releaseScratchSpace(),e}copyWholeBufferToGl(){if(!this.webGlBuffer)return!1;this.gl.bindBuffer(this.target,this.webGlBuffer);const e=new DataView(this.scratchSpace,0,this.size);return this.gl.bufferData(this.target,e,this.gl.STATIC_DRAW),this.gl.bindBuffer(this.target,null),this.viewer.getMemoryGauge().incrementMemoryUsage(this.GAUGE_MEMORY_TYPE,this.size),this.initialCopyPerformed=!0,this.rangesToCopy=[],!0}addRangeToCopyToGl(e,t){this.initialCopyPerformed&&jE(e,t,this.rangesToCopy)}copyPartialUpdatesToGl(){if(this.rangesToCopy.length<1)return!1;this.gl.bindBuffer(this.target,this.webGlBuffer);for(let e=0;e<this.rangesToCopy.length;++e){const t=this.rangesToCopy[e],i=new Uint8Array(this.scratchSpace,t[0],t[1]-t[0]);this.gl.bufferSubData(this.target,t[0],i)}return this.gl.bindBuffer(this.target,null),this.rangesToCopy=[],!0}getSize(){return this.size}getFloatView(){return this.ensureScratchSpace(),this.floatView||(this.floatView=new Float32Array(this.scratchSpace,0,this.size/4)),this.floatView}getIndexView(e){if(this.ensureScratchSpace(),!this.indexView){const t=e===Uint32Array?4:2;this.indexView=new e(this.scratchSpace,0,this.size/t)}return this.indexView}getUint8View(){return this.ensureScratchSpace(),this.uint8View||(this.uint8View=new Uint8Array(this.scratchSpace,0,this.size)),this.uint8View}getGlBuffer(){return this.webGlBuffer}bind(){this.webGlBuffer?this.gl.bindBuffer(this.target,this.webGlBuffer):TT.warn("Attempting to bind a null gl buffer")}makeSceneDebugObject(e){const t=new e(this.scratchSpace),i=[];for(let e=0;e<t.length;++e)i.push(t[e].toString());return"["+i.join(", ")+"]"}isInitialCopyPerformed(){return this.initialCopyPerformed}}const RT=ue.create();class wT{constructor(e,t){this.parent=e,this.occurrenceData=t,this.styledRanges=[],this.bounds=null,this.occurrenceData.addBoundable(this)}destroy(){for(let e=0;e<this.styledRanges.length;++e)this.styledRanges[e].destroy();this.occurrenceData.removeBoundable(this)}addStyledMeshRanges(e,t,i,s){const n=new TS(this,e,t,i,s);return this.styledRanges.push(n),n}removeAllChildrenForMeshGroup(e){return this.removeStyledMeshRangesForGroup(e)}removeStyledMeshRangesForGroup(e){const t=[];let i=!1;for(let s=0;s<this.styledRanges.length;++s){const n=this.styledRanges[s];n.getMeshRangesGroupId()===e?(i=!0,n.destroy()):t.push(n)}return this.styledRanges=t,i}get isEmpty(){return 0===this.styledRanges.length}draw(e){const t=e.getActiveShader();if(!t)return;if(!this.occurrenceData.isVisible(e)&&!e.getIsPickingHiddenOccurrences())return;if(!e.doesNodeOcccurrencePassFilter(this))return;if(e.activePassNeedsIsolationTest()&&e.activePassIsForIsolate()!==this.occurrenceData.getIsolated()&&!e.viewer.getIsolatedOccurrenceManager()?.isOccurrenceTranslucent(this.occurrenceData)&&(!e.viewer.getIsolatedOccurrenceManager()?.isInPickingMode()||!e.activePass.isPickPass()))return;let i=!1;const s=e.viewer.areOptimizedBuffersEnabled?1:0;for(let n=0;n<this.styledRanges.length;++n){const r=this.styledRanges[n];this.occurrenceData.isStyledRangeCulled(r,e)||(t.uniform1f("uUsePrimitiveLines",s),i||(this.pushGraphicsState(e,t),i=!0),this.occurrenceData.getShouldSetOccurrenceUniform()&&t.uniform1f("uMeshGroupIdHash",r.getMeshRangesGroupIdHash()),r.draw(e,this.occurrenceData))}i&&wT.popGraphicsState(e)}pushGraphicsState(e,t){wT.pushGraphicsState(e,t,this.occurrenceData,this.parent)}static pushGraphicsState(e,t,i,s){if(e.pushModelViewMatrix(ge.w$.multiply(e.getModelViewMatrix(),i.getTransform(),RT)),e.updateModelviewUniforms(),e.activePassIsForSectionPlaneEndcapMask()||e.activePassIsForOIT()){const s=e.viewer.getIsolatedOccurrenceManager()?.isInIsolateOrMakeTransparentMode()&&!i.getIsolated();t.uniform1f("uOutsideIsolation",s?1:0)}i.getShouldSetOccurrenceUniform()&&t.uniform1f("uOccurrenceId",i.getOccurrenceId()),t.uniform1i("uClippedBySectionPlanes",s.getClippedBySectionPlanes()&&i.getIsClippedBySectionPlanes()?1:0);let n=e.isPicking()?s.getPickZOffset():s.getZOffset();e.getHasIsolate()&&!i.getIsolated()&&(n+=wT.NON_ISOLATED_Z_OFFSET_ADDITION),e.setZOffset(n)}static popGraphicsState(e){e.popModelViewMatrix()}damageBounds(){this.bounds&&this.bounds.reset(),this.parent.damageBounds()}addBounds(e,t){if(this.bounds||(this.bounds=new wi.kB),(this.occurrenceData.isBoundable()||t&&t.includeHiddenBounds)&&!this.bounds.isInitialized()){let e,t=!1;for(e=0;e<this.styledRanges.length;++e)if(this.styledRanges[e].isCheaplyBoundable()){const i=this.styledRanges[e].getBounds(this.occurrenceData,this.parent.getUsage());i.isInitialized()&&(this.bounds.addBox(i,this.occurrenceData.getTransform()),t=!0)}if(!t)for(e=0;e<this.styledRanges.length;++e)this.bounds.addBox(this.styledRanges[e].getBounds(this.occurrenceData,this.parent.getUsage()),this.occurrenceData.getTransform())}e.addBox(this.bounds,null,!0)}makeSceneDebugObject(e){const t="NodeOccurrence: (Occurrence id: "+this.occurrenceData.getOccurrenceId()+")",i=[this.occurrenceData.makeSceneDebugObject()];this.bounds&&i.push(this.bounds.makeSceneDebugObject());for(let e=0;e<this.styledRanges.length;++e)i.push(this.styledRanges[e].makeSceneDebugObject(this.occurrenceData));return{text:t,children:i,state:{opened:!0}}}parentHasTransparency(){return this.parent.hasTransparency()}}wT.NON_ISOLATED_Z_OFFSET_ADDITION=X.default.getManager().getNumber("NON_ISOLATED_Z_OFFSET_ADDITION");const vT=RS,_T=[vT.POINT,vT.NORMAL,vT.OFFSET_VECTOR,vT.COLOR,vT.TEXTURE,vT.POINT_DATA,vT.EDGE_DATA,vT.PRIMITIVE_SIZE,vT.PRIMITIVE_STYLE,vT.CONTACT_TRACTION,vT.CONTACT_PAIR_COORDINATE];class NT{constructor(e){this.parentMesh=e,this.vertexBuffer=null,this.indexBuffer=null,this.attributeBindings=null}getVertexBuffer(){return this.vertexBuffer}getIndexBuffer(){return this.indexBuffer}getParentMesh(){return this.parentMesh}setParentMesh(e){this.parentMesh=e}logInconsistency(e){NT.loggedInconsistency||(iI.log.warn(e),NT.loggedInconsistency=!0)}hasOptimizedBuffers(){return!1}getComponentCount(){return this.vertexBuffer?this.vertexBuffer.getComponentCount():0}isTriangleStrip(){return this.parentMesh.getPrimitiveType()===Ai.MX.TRIANGLE_STRIP}reinitialize(){this.vertexBuffer=null,this.indexBuffer=null}areBuffersInitialized(){return(0,j.objectsDefinedInSameWay)(this.vertexBuffer,this.indexBuffer)||this.logInconsistency("BEL-56218, BEL-55900, BEL-56214 The vertex buffer and index buffer were initialized independently"),!!this.vertexBuffer&&!!this.indexBuffer}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null),this.indexBuffer&&(this.indexBuffer.destroy(),this.indexBuffer=null)}bindBuffers(e,t,i,s,n){e.setLastBufferBound(this)}buffersNeedBinding(e){return e.getLastBufferBound()!==this}initializeAttributes(e,t,i){for(let t=0;t<_T.length;++t){const i=_T[t],s=this.attributeBindings[i.name];s?e.vertexAttribPointer(i.name,s):e.enableVertexAttribArray(i.name,!1)}}bindAttributeStateWithoutVAOs(e,t,i,s){e&&(this.bindBuffers(i,t,s,!0,!1),this.initializeAttributes(t,i,s))}copyBuffersToGl(){if(!this.vertexBuffer||!this.indexBuffer)return;let e=this.vertexBuffer.copyToGl();return e=this.indexBuffer.copyToGl()||e,e}}NT.loggedInconsistency=!1;const bT=_e.O.createLogger("BufferSet",k.bVy.GRAPHICS),LT=0,FT=1,xT=[1/0,1/0,1/0],BT=8388608,VT=new AI(Ht.UNSIGNED_BYTE,4,0,0,!0);let UT=null;class HT{constructor(e,t,i,s){this.increment=e,this.bufferSet=s,this.vertexRange=t,this.indexRange=i,this.pickId=e?.pickId}}let GT=1;function kT(){return GT++}let WT=0;class zT extends NT{constructor(e,t=!1){super(e),this.isForPrecompiledIncrements=t,this.lineStripIndexBuffer=null,this.pickIdBuffers=[],this.indexRangesToDelete=[],this.pendingFreeSpace=[[],[]],this.freeSpace=[[],[]],this.incrementDeletionListeners=null,this.shaderIdToVAOs=new Map,this.initialVertexCount=t?0:1,this.initialIndexCount=t?0:this.getDefaultIndexCount(),this.incrementsToBuffer=new Gl.TemplatedCountedMap,this.increments=new Gl.TemplatedCountedMap,this.debugId=WT++}clone(e){const t=new zT(e);if(t.increments.insertCountedMap(this.increments),this.attributeBindings){t.attributeBindings={};for(const e in this.attributeBindings)this.attributeBindings[e]&&(t.attributeBindings[e]=this.attributeBindings[e].clone())}t.initialVertexCount=this.initialVertexCount,t.initialIndexCount=this.initialIndexCount;for(let e=0;e<this.freeSpace[LT].length;++e)t.freeSpace[LT].push(this.freeSpace[LT][e].slice(0));for(let e=0;e<this.freeSpace[FT].length;++e)t.freeSpace[FT].push(this.freeSpace[FT][e].slice(0));return t.markAllIncrementsForBuffering(),t.updateBuffers({forClone:!0}),t}markAllIncrementsForBuffering(){this.incrementsToBuffer.insertCountedMap(this.increments)}getIsForPrecompiledIncrements(){return this.isForPrecompiledIncrements}destroy(){if(super.destroy(),this.lineStripIndexBuffer&&(this.lineStripIndexBuffer.destroy(),this.lineStripIndexBuffer=null),this.pickIdBuffers){for(let e=0;e<this.pickIdBuffers.length;++e)this.pickIdBuffers[e].destroy();this.pickIdBuffers=[]}if(this.parentMesh.viewer.areVertexArrayObjectsAvailable){for(const[e,t]of this.shaderIdToVAOs)this.parentMesh.viewer.getVertexArrayExtension().deleteVertexArrayOES(t);this.shaderIdToVAOs.clear()}}getDebugId(){return this.debugId.toString()}addIncrementDeletionListener(e){this.incrementDeletionListeners||(this.incrementDeletionListeners={}),this.incrementDeletionListeners[e.getListenerId()]=e}removeIncrementDeletionListener(e){this.incrementDeletionListeners&&delete this.incrementDeletionListeners[e.getListenerId()]}triggerDeletedListeners(e){if(e&&this.incrementDeletionListeners)for(const t in this.incrementDeletionListeners)this.incrementDeletionListeners[t].onIncrementDeleted(e)}getDefaultIndexCount(){return!this.isForPrecompiledIncrements&&this.isTriangleStrip()?1:0}getUsedVertexCount(){let e=0;return this.increments.each((function(t){return e+=t.increment.points.length/3,!1}),this),e}addFreeSpace(e,t,i,s){jE(t,i,s?this.pendingFreeSpace[e]:this.freeSpace[e])}incorporatePendingFreeSpace(){for(let e=0;e<this.pendingFreeSpace.length;++e){const t=this.pendingFreeSpace[e],i=this.freeSpace[e];for(let e=0;e<t.length;++e)YE(t[e],i);t.splice(0,t.length)}}findFreeSpace(e,t){for(let i=0;i<this.freeSpace[e].length;++i){const s=this.freeSpace[e][i];if(s[1]-s[0]>=t)return s[0]}return-1}markFreeSpaceUsed(e,t,i){QE([t,t+i],this.freeSpace[e])}getLastUsedIndex(){const e=this.freeSpace[FT][this.freeSpace[FT].length-1],t=this.indexBuffer.getComponentCount();return e&&e[1]===t?e[0]:t}reinitialize(){super.reinitialize(),this.lineStripIndexBuffer=null,this.pickIdBuffers=[],this.markAllIncrementsForBuffering(),this.updateBuffers({forReinitialize:!0}),this.shaderIdToVAOs=new Map}getIncrement(e){const t=this.increments.get(e);return t?t.increment:null}incorporateIncrement(e){if(!e||!e.getFullId())return null;let t,i;const s=e.getPreparedVertexCount(),n=e.getPreparedIndexCount(),r=this.findFreeSpace(LT,s),a=this.findFreeSpace(FT,n);if(r>=0&&a>=0)t=[r,r+s],i=[a,a+n],this.markFreeSpaceUsed(LT,r,s),this.markFreeSpaceUsed(FT,a,n);else if(!this.areBuffersInitialized()){const r=ci(),a=this.initialVertexCount+s<=r;!a&&e.isPrecompiledBuffer&&bT.warn(`USE_DISPLAY_DATA_GPU_BUFFERS error: Cannot fit increment id ${e.getFullId()} with vertexCount ${s} into BufferSet with maximum vertices per VBO ${r}`);const o=(this.initialVertexCount+s)*this.parentMesh.vertexSize,h=o<=BT,c=this.initialIndexCount===this.getDefaultIndexCount();if(o>268435456){const t=zT.mapOwnerIdToMaxSingleIncrementWarningsShownCount.get(e.ownerId)??1;t<=5&&(bT.warn(`Warning ${t}/5: size exceeds safe limit for single mesh increment with id ${e.getFullId()} and size ${o}`),zT.mapOwnerIdToMaxSingleIncrementWarningsShownCount.set(e.ownerId,t+1))}a&&(h||c)&&(t=[this.initialVertexCount,this.initialVertexCount+s],i=[this.initialIndexCount,this.initialIndexCount+n],this.initialVertexCount+=s,this.initialIndexCount+=n)}if(t&&i){const s=new HT(e,t,i,this);return this.incrementsToBuffer.insert(e.getFullId(),s),this.increments.insert(e.getFullId(),s),s}return null}getIncrementDetails(e){return this.increments.get(e)||null}deleteIncrement(e){const t=this.increments.get(e);return t&&(this.addFreeSpace(LT,t.vertexRange[0],t.vertexRange[1],!1),this.addFreeSpace(FT,t.indexRange[0],t.indexRange[1],!0),YE(t.indexRange,this.indexRangesToDelete),this.increments.remove(e)),this.incrementsToBuffer.remove(e),this.triggerDeletedListeners(t),t||null}hasBufferUpdates(){return!this.incrementsToBuffer.isEmpty()||this.indexRangesToDelete.length>0}updateBuffers(e){this.areBuffersInitialized()||this.initializeBuffers(e),this.processDeletedRanges(),this.processNewIncrements();const t=this.copyBuffersToGl();return this.incorporatePendingFreeSpace(),t}validateBufferIndices(e){if(!CT())return void bT.warn("Can only validate index buffers when getTestingBuffers is true");const t=this.vertexBuffer.getUint8View(),i=this.indexBuffer.getIndexView(ai());for(const s in this.attributeBindings){const n=this.attributeBindings[s],r=n.elementCount*kt(n.type);e||(e=[0,i.length]);for(let a=e[0];a<e[1];++a){const e=i[a];if(n.offset+e*(n.stride+r)+r>t.length){bT.warn("Found inconsistency in buffer set "+this.debugId+" for attribute "+s);break}}}}copyBuffersToGl(){let e=super.copyBuffersToGl();this.lineStripIndexBuffer&&(e=this.lineStripIndexBuffer.copyToGl()||e);for(let t=0;t<this.pickIdBuffers.length;++t)e=this.pickIdBuffers[t].copyToGl()||e;return e}initializeBuffers(e){if(this.areBuffersInitialized())return;const t=this.parentMesh.viewer,i=t.getGlContext();let s,n=this.initialVertexCount,r=this.initialIndexCount;const a=e&&e.forClone,o=e&&e.forReinitialize;if(this.parentMesh.bufferAllocationPolicy===AE.MAXIMUM&&this.parentMesh.vertexSize>0){const e=Math.floor(BT/this.parentMesh.vertexSize);n=Math.max(n,e);const t=Math.ceil(1.5*n);r=Math.max(r,t)}else if(this.parentMesh.bufferAllocationPolicy===AE.MEDIUM)n=Math.max(n,512),r=Math.max(r,2048);else if(this.isForPrecompiledIncrements&&this.parentMesh.bufferAllocationPolicy===AE.MINIMUM&&1===this.increments.size()){const e=this.increments.get(this.increments.firstKey()).increment;n=e.getPreparedVertexCount(),r=e.getPreparedIndexCount()}if(this.vertexBuffer=new OT(t,n*this.parentMesh.vertexSize,i.ARRAY_BUFFER,n),this.indexBuffer=new OT(t,r*hi(),i.ELEMENT_ARRAY_BUFFER,r),!this.isForPrecompiledIncrements){this.initialVertexCount<n&&!a&&!o&&this.addFreeSpace(LT,this.initialVertexCount,n,!1);const e=this.vertexBuffer.getFloatView();for(s=0;s<vT.POINT.dimension;++s)e[s]=xT[s];this.initialIndexCount<r&&!a&&!o&&this.addFreeSpace(FT,this.initialIndexCount,r,!1);const h=this.indexBuffer.getIndexView(ai());for(s=0;s<this.getDefaultIndexCount();++s)h[s]=0;this.isTriangleStrip()&&(this.lineStripIndexBuffer=new OT(t,r*hi(),i.ELEMENT_ARRAY_BUFFER,r),function(e,t){const i=e.getGlContext();UT||(UT=new AI(i.FLOAT,1,0,0)),(!e.getResources().primitiveRestartBuffer||e.getResources().primitiveRestartBuffer.getComponentCount()<t)&&(e.getResources().primitiveRestartBuffer=new OT(e,4*t,i.ARRAY_BUFFER,t),e.getResources().primitiveRestartBuffer.getFloatView()[0]=16384,e.getResources().primitiveRestartBuffer.copyToGl())}(t,r))}this.pickIdBuffers=[]}processDeletedRanges(){for(let e=0;e<this.indexRangesToDelete.length;++e){const t=this.indexRangesToDelete[e],i=t[1]-t[0],s=t[0],n=this.indexBuffer.getIndexView(ai());for(let e=t[0];e<t[1];++e)n[e]=0;this.isTriangleStrip()&&this.updateLineStripIndices(t),this.indexBuffer.addRangeToCopyToGl(s*hi(),(s+i)*hi())}this.indexRangesToDelete=[]}updateLineStripIndices(e){if(!this.isTriangleStrip()||this.isForPrecompiledIncrements)return;if(!this.lineStripIndexBuffer)return void bT.warn("Did not find line strip index buffer for triangle strip");const t=this.indexBuffer.getIndexView(ai()),i=this.lineStripIndexBuffer.getIndexView(ai());let s=!1,n=0;i[e[0]]=0;for(let r=e[0]+1;r<e[1]-1;++r)s?(t[r]!==t[r-1]?++n:n=0,2===n&&(s=!1,i[r-2]=t[r-2],i[r-1]=t[r-1])):t[r]===t[r-1]&&(s=!0,n=0),i[r]=s?0:t[r];i[e[1]-1]=0,this.lineStripIndexBuffer.addRangeToCopyToGl(e[0]*hi(),e[1]*hi())}processNewIncrements(){this.incrementsToBuffer.each(((e,t)=>(e.increment.isPreparedForBuffering()||e.increment.prepareForBuffering(),this.copyIncrementVertices(e.increment,e.vertexRange),this.copyIncrementPickIds(e,e.vertexRange),this.copyIncrementIndices(e.increment,e.indexRange,e.vertexRange),!1))),this.incrementsToBuffer.clear()}replicateAttributeValue(e,t,i,s){if(e.elementCount!==s.length)return void bT.warn("An attempt was made to update a vertex attribute with a value with the wrong dimension");const n=t/e.typeSize(),r=n+i[0]*e.elementCount,a=n+i[1]*e.elementCount,o=e.type===Ht.FLOAT?this.vertexBuffer.getFloatView():this.vertexBuffer.getUint8View();for(let t=r;t<a;t+=e.elementCount)o.set(s,t)}copyIncrementVertices(e,t){const i=this.vertexBuffer.getComponentCount(),s=this.vertexBuffer.getFloatView(),n=this.vertexBuffer.getUint8View(),r=e.vertexCount(),a=t[0];let o=0,h=0,c=0,l=!1;this.attributeBindings||(this.attributeBindings={},l=!0);for(let t=0;t<_T.length;++t){const d=_T[t];let u=!1;e.hasAsAVertexAttribute(d)?u=!0:e[d.incrementProperty]&&(d.type===Ht.FLOAT?s.set(e[d.incrementProperty],o+d.elementCount*a):n.set(e[d.incrementProperty],h+d.elementCount*a),u=!0),l&&u&&(this.attributeBindings[d.name]=new AI(+d.type,d.dimension,c,0,d.normalize,d.secondDimension),c+=d.sizeInBytes()*i),u&&(this.vertexBuffer.addRangeToCopyToGl(h+a*d.sizeInBytes(),h+(a+r)*d.sizeInBytes()),h+=d.sizeInBytes()*i,o+=d.sizeInBytes()/4*i)}}updateIncrementAttribute(e,t,i){if(this.areBuffersInitialized()||this.updateBuffers(),this.isForPrecompiledIncrements)return void bT.debug("Not supporting updating increment attributes for buffersets with precompiled increments.");const s=this.increments.get(t);if(!s)return void bT.warn("Increment was not found in updateIncrementAttribute");const n=this.attributeBindings[e.name];n?(this.replicateAttributeValue(e,n.offset,s.vertexRange,i),this.vertexBuffer.addRangeToCopyToGl(n.offset+s.vertexRange[0]*e.sizeInBytes(),n.offset+s.vertexRange[1]*e.sizeInBytes())):bT.warn("An attempt was made to update an attribute that did not have a binding")}copyIncrementPickIds(e,t){const i=e.pickId;if((0,Mi.rp)(i)){this.parentMesh.viewer.notifyOfPickPassCount(i.length);for(let e=0;e<i.length;++e){let s=this.pickIdBuffers[e];s||(this.pickIdBuffers[e]=s=new OT(this.parentMesh.viewer,4*this.vertexBuffer.getComponentCount(),this.parentMesh.viewer.getGlContext().ARRAY_BUFFER,this.vertexBuffer.getComponentCount()));const n=s.getUint8View(),r=(0,Xs.fA)(i[e]);for(let e=t[0];e<t[1];++e)n.set(r,4*e);s.addRangeToCopyToGl(4*t[0],4*t[1])}}}copyIncrementIndices(e,t,i){if(!this.indexBuffer)return;const s=this.indexBuffer.getIndexView(ai());if(e.isPrecompiledBuffer)return void s.set(e.indices,0);let n=0;this.isTriangleStrip()&&(s[t[0]]=i[0]+e.indices[n],n=1);let r=0;for(r=0;r<e.indices.length;++r)s[t[0]+r+n]=i[0]+e.indices[r];if(this.isTriangleStrip()){const n=i[0]+e.indices[e.indices.length-1];for(;r<e.indexLengthWithDegenerates();++r)s[t[0]+r]=n;this.updateLineStripIndices(t)}this.indexBuffer.addRangeToCopyToGl(t[0]*hi(),t[1]*hi())}bindBuffers(e,t,i,s,n){super.bindBuffers(e,t,i,s,n),s&&this.vertexBuffer.bind();let r=this.indexBuffer;e.getPickPrimitiveAlternates()&&i&&(r=this.lineStripIndexBuffer),r.bind(),n&&e.isPicking()&&e.getPickPassIteration()>=0&&(this.pickIdBuffers[e.getPickPassIteration()]?this.pickIdBuffers[e.getPickPassIteration()].bind():t.vertexAttrib4fv(PS.PICKING,Xs.o0))}initializeAttributes(e,t,i){super.initializeAttributes(e,t,i),t.isPicking()&&t.getPickPassIteration()>=0?this.pickIdBuffers[t.getPickPassIteration()]?(this.pickIdBuffers[t.getPickPassIteration()].bind(),e.vertexAttribPointer(PS.PICKING,VT)):e.vertexAttrib4fv(PS.PICKING,Xs.o0):e.enableVertexAttribArray(PS.PICKING,!1),t.getPickPrimitiveAlternates()&&i?(this.parentMesh.viewer.getResources().primitiveRestartBuffer.bind(),e.vertexAttribPointer(PS.PRIMITIVE_RESTART,UT)):e.enableVertexAttribArray(PS.PRIMITIVE_RESTART,!1)}bindAttributeStateWithVAOs(e,t,i,s){let n=t.getNumericId();i.getPickPassIteration()>0&&(n=1e3*n+i.getPickPassIteration());let r=this.shaderIdToVAOs.get(n);e?r?(this.parentMesh.viewer.bindVao(r),this.bindBuffers(i,t,s,!1,!0)):(r=this.parentMesh.viewer.getVertexArrayExtension().createVertexArrayOES(),this.shaderIdToVAOs.set(n,r),this.parentMesh.viewer.bindVao(r),this.bindAttributeStateWithoutVAOs(e,t,i,s)):this.parentMesh.viewer.bindVao(r)}draw(e,t){this.drawRanges(e,t)}drawRanges(e,t){if(this.parentMesh.compileBuffers(e),!this.attributeBindings)return;if(!this.areBuffersInitialized())return void this.logInconsistency("BEL-53632 BufferSet.prototype.draw without initialized buffers");const i=t.getRangeIteratorForBufferSet(this);if(!i||!i.hasMoreRanges())return;const s=e.getActiveShader(),n=this.parentMesh.viewer.getGlContext(),r=this.isTriangleStrip(),a=e.getPickPrimitiveAlternates()?this.parentMesh.getAlternatePrimitiveMode():this.parentMesh.getPrimitiveMode(),o=this.buffersNeedBinding(e);this.parentMesh.viewer.areVertexArrayObjectsAvailable?this.bindAttributeStateWithVAOs(o,s,e,r):this.bindAttributeStateWithoutVAOs(o,s,e,r);let h=0,c=0;for(;i.hasMoreRanges();){const t=i.getNextRange();if(!t)continue;let s=t[0],o=t[1]-t[0];1&s&&r&&(o-=1,s+=1),o<3&&r||(e.applyStyle(t[2]),n.drawElements(a,o,oi(),s*hi()),h++,c+=o,e.getPickPrimitiveAlternates()&&r&&n.drawElements(n.POINTS,o,oi(),s*hi()))}this.parentMesh.incrementStatisticsForCall(c,h)}makeSceneDebugObject(){const e="BufferSet "+this.getDebugId(),t=[];let i=0;return this.increments.each((function(e){if(500==i++)return t.push({text:"... (truncated)",children:[]}),!0;const s={text:"",children:[]};s.text="Increment "+e.increment.id,s.children.push({text:`Vertex Range: [${e.vertexRange}]`,children:[]}),s.children.push({text:`Index Range: [${e.indexRange}]`,children:[]}),s.children.push({text:"PickId: "+e.pickId,children:[]}),t.push(s)}),this),{text:e,children:t}}addGroupIncrementsToBounds(e,t,i,s){this.increments.each((function(n){const r=n.increment;return r.groupId===e&&r.ownerId===t&&r.lod===i&&s.addBox(r.getBounds()),!1}),this)}collectViewerMetrics(e){if(!this.areBuffersInitialized())return;if(!this.vertexBuffer.isInitialCopyPerformed())return;e.numberOfBuffers+=2+this.pickIdBuffers.length+(this.lineStripIndexBuffer?1:0);const t=this.freeSpace[LT],i=t.length;e.maxFreeBlocksInASingleBuffer<i&&(e.maxFreeBlocksInASingleBuffer=i);let s=e.freeBlocksSizes.length,n=0,r=0;for(let a=0;a<i;++a){const i=t[a],o=(i[1]-i[0])*this.parentMesh.vertexSize;n+=o,r<o&&(r=o),e.freeBlocksSizes.push(o),s++,e.averageSizeOfFreeBlocksInBytes=(e.averageSizeOfFreeBlocksInBytes*(s-1)+o)/s}const a=1-r/n;if(e.worstFragmentationRatio<a){e.worstFragmentationRatio=a;const t=this.increments.size();e.bufferSetWithWorstFragmentation={debugId:this.debugId,primitiveType:this.parentMesh.getPrimitiveType(),incrementsCount:t,aRandomIncrementInTheBuffer:t>0?this.increments.get(this.increments.firstKey()).increment.id:"",vertexFreeSpaceLength:this.freeSpace[LT].length,maxFreeSizeForThisBufferInBytes:r}}}}zT.mapOwnerIdToMaxSingleIncrementWarningsShownCount=new Map;class XT extends sT.Y{constructor(){super(),this.minuendRangeIterator=null,this.currentMinuendRange=null,this.minuendSubRangeStart=-1,this.subtrahendRangeIterator=null,this.currentSubtrahendRange=null}reset(e,t){this.minuendRangeIterator=e,this.currentMinuendRange=null,this.minuendSubRangeStart=-1,this.subtrahendRangeIterator=t,this.currentSubtrahendRange=null,this.nextResult=this.findNextRange()}findNextRange(){if(this.currentMinuendRange||(this.currentMinuendRange=this.minuendRangeIterator.getNextRange()),!this.currentMinuendRange)return null;for(;this.subtrahendIsBehind();)this.currentSubtrahendRange=this.subtrahendRangeIterator.getNextRange();const e=this.getStorageForNextResult();if(!this.currentSubtrahendRange||this.currentSubtrahendRange[0]>this.currentMinuendRange[1])e[0]=this.minuendSubRangeStart>=0?this.minuendSubRangeStart:this.currentMinuendRange[0],e[1]=this.currentMinuendRange[1],e[2]=this.currentMinuendRange[2],this.currentMinuendRange=null,this.minuendSubRangeStart=-1;else{const t=this.minuendSubRangeStart>=0?this.minuendSubRangeStart:this.currentMinuendRange[0];if(this.currentSubtrahendRange[0]<=t)return this.currentSubtrahendRange[1]>=this.currentMinuendRange[1]?(this.currentMinuendRange=null,this.minuendSubRangeStart=-1):this.minuendSubRangeStart=this.currentSubtrahendRange[1],this.findNextRange();e[0]=t,e[1]=this.currentSubtrahendRange[0],e[2]=this.currentMinuendRange[2],this.currentSubtrahendRange[1]>=this.currentMinuendRange[1]?(this.currentMinuendRange=null,this.minuendSubRangeStart=-1):this.minuendSubRangeStart=this.currentSubtrahendRange[1]}return e}subtrahendIsBehind(){if(this.currentSubtrahendRange){const e=this.minuendSubRangeStart>=0?this.minuendSubRangeStart:this.currentMinuendRange[0];return this.currentSubtrahendRange[1]<=e}return this.subtrahendRangeIterator.hasMoreRanges()}}class ZT extends iT{constructor(e,t,i,s){super(),this.groupId=e,this.ownerId=t,this.primitiveType=i,this.lod=s,this.bounds=null}getOwnerId(){return this.ownerId}getMeshGroupId(){return this.groupId}cloneForPreview(){const e=new ZT(this.groupId,this.ownerId,this.primitiveType,this.lod);return this.copyDataTo(e),e.setListenForDeletions(!0),e.setBounds(this.bounds),e}onIncrementDeleted(e){e.increment.groupId===this.groupId&&e.increment.ownerId===this.ownerId&&this.onIncrementRemoved(e)}makeSceneDebugObject(e){const t=e?this.shouldDrawForOccurrences(e):void 0,i="Group ranges: (ownerId: "+this.ownerId+", groupId: "+this.groupId+", primitiveType: "+(0,Ai.E1)(this.primitiveType)+", lod: "+this.lod+", shouldDrawForOccurrence: "+t+", listenForDeletions: "+this.listenForDeletions+")",s=this.getChildSceneDebugObjects();return this.bounds&&s.push(this.bounds.makeSceneDebugObject()),{text:i,children:s,state:{opened:t}}}isCheaplyBoundable(){return this.lod===wS.LOWEST}damageBounds(){this.bounds=null,iT.prototype.damageBounds.apply(this,[...arguments])}setBounds(e){this.bounds=e}getBounds(e,t){if(!this.bounds){this.bounds=new wi.kB;const e=this.bufferSetRanges.getKeyValues();for(let t=0;t<e.length;t+=2){e[t].addGroupIncrementsToBounds(this.groupId,this.ownerId,this.lod,this.bounds)}}return this.bounds}shouldDrawForOccurrences(e){return e.getLod()===this.lod}getPrimitiveCount(){let e=0;const t=this.bufferSetRanges.getKeyValues();for(let i=0;i<t.length;i+=2){const s=t[i+1];for(let t=0;t<s.length;++t){const i=s[t];this.primitiveType===Ai.MX.TRIANGLE_STRIP?e+=i[1]-i[0]-2:this.primitiveType===Ai.MX.TRIANGLES?e+=(i[1]-i[0])/3:this.primitiveType===Ai.MX.SILHOUETTES&&(e+=(i[1]-i[0])/6)}}return e}}class qT extends iT{constructor(e,t){super(),this.debugId=e,this.sourceMeshGroupId=t,this.incrementDetails=new Set}clone(){const e=new qT(this.debugId,this.sourceMeshGroupId);return e.incrementDetails=new Set(this.incrementDetails),this.copyDataTo(e),e}getMeshGroupId(){return this.sourceMeshGroupId}makeSceneDebugObject(){let e="",t=!0;this.incrementDetails.forEach((function(i){t||(e+=","),t=!1,e+=i.increment.getFullId()}));return{text:"Increment ranges "+this.debugId+": (incrementIds: ["+e+"], listenForDeletions: "+this.listenForDeletions+")",children:this.getChildSceneDebugObjects()}}isEmpty(){return 0===this.incrementDetails.size}containsIncrement(e){return this.incrementDetails.has(e)}onIncrementAdded(e,t){if(this.incrementDetails.has(e)&&!t)return!1;this.incrementDetails.add(e);const i=iT.prototype.onIncrementAdded.apply(this,[...arguments]);return this.listenForDeletions&&e.bufferSet.addIncrementDeletionListener(this),i}onIncrementRemoved(e){if(!this.incrementDetails.has(e))return!1;this.incrementDetails.delete(e);const t=iT.prototype.onIncrementRemoved.apply(this,[...arguments]);return this.listenForDeletions&&!this.bufferSetRanges.has(e.bufferSet)&&e.bufferSet.removeIncrementDeletionListener(this),t}getListenerId(){return this.listenerId}onIncrementDeleted(e){this.onIncrementRemoved(e)}getBounds(e,t){const i=new wi.kB;return this.incrementDetails.forEach((s=>{e.isIncrementBoundable(s,t)&&i.addBox(s.increment.getBounds())})),i}}class YT{constructor(e){this.subtractMeshRanges=e}getRangeIteratorForBufferSet(e){return qT.prototype.getRangeIteratorForBufferSet.call(this.subtractMeshRanges,e)}makeSceneDebugObject(){const e={text:"SubtractMeshRangeIncrementProvider",children:[]};return(0,Xs.n9)(e,this.subtractMeshRanges),e}}class KT extends qT{constructor(e){super(e),this.subtractOperator=new tD,this.subtractOperator.setSubtrahend(new YT(this)),this.setListenForDeletions(!0)}setOperand(e){this.subtractOperator.setOperand(e)}getRangeIteratorForBufferSet(e){return this.subtractOperator.getRangeIteratorForBufferSet(e)}}const jT=new Oi;function QT(e){jT.reset(),jT.addNumber(e.getPrimitiveType(),Ai.ip);for(const t in RS)jT.addBoolean(e.hasAttribute(t));return jT.addBoolean(e.isAPrecompiledBuffer()),jT.getId()}let $T=1;function JT(){const e=$T.toString();return++$T,e}class eD{constructor(e,t){this.viewer=e,this.meshCreationOptions=t,this.meshes={},this.incrementIdToMesh=new Map,this.groupRanges={},this.ownsMeshes=!0}destroy(){if(this.ownsMeshes){for(const e in this.meshes)this.meshes[e].destroy();this.meshes={}}for(const e in this.groupRanges)this.groupRanges[e].destroy();this.groupRanges={}}cloneForPreview(e){const t=new eD(this.viewer,this.meshCreationOptions);t.ownsMeshes=!1,t.meshes=(0,z.Z)(this.meshes),t.incrementIdToMesh=new Map(this.incrementIdToMesh);for(const i in this.groupRanges){this.groupRanges[i].getOwnerId()===e&&(t.groupRanges[i]=this.groupRanges[i].cloneForPreview())}return t}addMeshIncrement(e,t,i){this.removeMeshIncrement(e.id,t),e.ownerId=t;const s=QT(e);let n=this.meshes[s];if(!n){const t=e.isPrecompiledBuffer?{bufferAllocationPolicy:AE.MINIMUM}:this.meshCreationOptions;this.meshes[s]=n=new OE(this.viewer,t)}const r=n.addIncrement(e);if(r){this.incrementIdToMesh.set(e.getFullId(),n);const t=this.getGroupRangesForIncrement(e);t&&(t.onIncrementAdded(r),i&&t.setBounds(i))}return r}getIncrementDetails(e,t){const i=VS(e,t),s=this.incrementIdToMesh.get(i);return s?s.getIncrementDetails(i):null}removeMeshIncrement(e,t){const i=VS(e,t),s=this.incrementIdToMesh.get(i);let n=null;if(s){if(n=s.deleteIncrement(i),n){const e=this.getGroupRangesForIncrement(n.increment);e&&e.onIncrementRemoved(n)}this.incrementIdToMesh.delete(i)}return n}getGroupRangesForIncrement(e){return e.groupId?this.getOrCreateGroupRangesForGroupTypeAndLod(e.groupId,e.ownerId,e.primitiveType,e.lod):null}getGroupRangesId(e,t,i,s){return e+"."+t+"."+i+"."+s}getOrCreateGroupRangesForGroupTypeAndLod(e,t,i,s){const n=this.getGroupRangesId(e,t,i,s);let r=this.groupRanges[n];return r||(this.groupRanges[n]=r=new ZT(e,t,i,s)),r}getGroupRangesForGroupTypeAndLod(e,t,i,s){const n=this.getGroupRangesId(e,t,i,s);return this.groupRanges[n]||null}removeEmptyMeshes(){const e=[];let t=null;for(t in this.meshes)this.meshes[t].isEmpty()&&e.push(t);for(let i=0;i<e.length;++i)t=e[i],this.meshes[t].destroy(),delete this.meshes[t]}getMeshForIncrement(e){return this.meshes[QT(e)]||null}compileBuffers(){const e=new Ih.B7("MeshManager: Compiling Vertex Buffers");for(const e in this.meshes)this.meshes[e].compileBuffers();e.report()}reportMeshManagerMemoryMetrics(e,t){const i=new sD;for(const e in this.meshes)this.meshes[e].collectViewerMetrics(i);i.logWithFilterableFields(e,t)}getBufferSetSceneDebugObjects(){const e=[];for(const t in this.meshes)e.push(...this.meshes[t].getBufferSetSceneDebugObjects());return e}}class tD{constructor(){this.minuend=null,this.subtrahend=null,this.resultIterator=new XT}setOperand(e){this.minuend=e}setSubtrahend(e){this.subtrahend=e}getRangeIteratorForBufferSet(e){if(!this.minuend||!this.subtrahend)return iI.log.info("SubtractOperator.getRangeIteratorForBufferSet should be called with subtrahend and minuend"),null;const t=this.minuend.getRangeIteratorForBufferSet(e);if(!t)return null;const i=this.subtrahend.getRangeIteratorForBufferSet(e);return i?(this.resultIterator.reset(t,i),this.resultIterator):t}makeSceneDebugObject(e){const t={text:"SubtractOperator",children:[]};return(0,Xs.n9)(t,this.minuend),(0,Xs.n9)(t,this.subtrahend),t}}var iD=i(52309);class sD{constructor(){this.numberOfBuffers=0,this.averageSizeOfFreeBlocksInBytes=0,this.medianSizeOfFreeBlocksInBytes=0,this.freeBlocksSizes=new Array,this.maxFreeBlocksInASingleBuffer=0,this.worstFragmentationRatio=0}logWithFilterableFields(e,t){const i=this.freeBlocksSizes.length;this.medianSizeOfFreeBlocksInBytes=(0,Er.medianOfArrayValues)(this.freeBlocksSizes);const s={numberOfBuffers:this.numberOfBuffers,numberOfFreeBlocks:i,maxFreeBlocksInASingleBuffer:this.maxFreeBlocksInASingleBuffer,averageSizeOfFreeBlocksInBytes:this.averageSizeOfFreeBlocksInBytes,medianSizeOfFreeBlocksInBytes:this.medianSizeOfFreeBlocksInBytes,worstFragmentationPercent:Math.floor(100*this.worstFragmentationRatio),bufferSetWithWorstFragmentation:this.bufferSetWithWorstFragmentation};iI.log.info(`Buffer memory metrics: MeshManager: ${e}: sessionTime: ${rI.B.withElapsedTime(t)}, `+(0,iD.g)("BufferMemoryMetrics",s))}}var nD=i(53420),rD=i(97939),aD=i(19147),oD=i(73133),hD=i(94344),cD=i(74029),lD=i(30108),dD=i(29154),uD=i(21767),gD=i(60482),pD=i(57702);const mD=_e.O.createLogger("Viewer",k.bVy.GRAPHICS),fD=i(41406),ID=1600,ED=1200,SD=new Set([k.P1.DRAFT_ANALYSIS,k.P1.THICKNESS_ANALYSIS_VISUALIZATION]);dD.ZR(Array);{const e=window;e.vec2=Q,e.vec3=M,e.vec4=y,e.mat2=gD,e.mat3=yh,e.mat4=ue,e.quat4=js}let TD=0;function DD(e,t){return Math.floor(e*t)}if(window.matchMedia){window.matchMedia("print").addListener((function(e){e.matches?(0,li.lp)():(0,li.py)()}))}window.onbeforeprint=li.lp,window.onafterprint=li.py;const CD=X.default.getManager();class MD{constructor(e){this.elementId=e,this.camera=null,this.userEnabledAggressiveRefinement=!1,this.activeSectionPlanes=[],this.zebraStripeCount=CD.getNumber("ZEBRA_STRIPE_COUNT"),this.zebraStripeRotation=CD.getNumber("ZEBRA_STRIPE_ROTATION"),this.zebraStripeEdgesOn=!0,this.renderingMode=k.P1.SHADED_WITH_EDGES,this.smoothEdgeStyle=k.YUG.VISIBLE}}var yD;!function(e){e[e.VIEWER_DESTROYED=-1]="VIEWER_DESTROYED",e[e.WAITING_FOR_DISPLAY_DATA=0]="WAITING_FOR_DISPLAY_DATA",e[e.WAITING_FOR_COMPARE_DISPLAY_DATA=1]="WAITING_FOR_COMPARE_DISPLAY_DATA",e[e.LOADING_DISPLAY_DATA=2]="LOADING_DISPLAY_DATA",e[e.LOADED_DISPLAY_DATA=3]="LOADED_DISPLAY_DATA",e[e.LOADED_ALL_DATA=4]="LOADED_ALL_DATA"}(yD||(yD={}));const AD={performFrameTiming:!0},PD={performFrameTiming:!1};let OD={antialias:!0,depth:!0,stencil:!0,preserveDrawingBuffer:!0,powerPreference:"high-performance"};const RD=localStorage.getItem("osWebGlContextOptions");if(RD)try{mD.info("Using custom set of WebGL context options: "+RD),OD=JSON.parse(RD)}catch(e){mD.warn("Failed to use custom WebGL context options: "+RD)}const wD={},vD=new Set([k.P1.SIMULATION_RESULTS,k.P1.SHADED_CURVATURE_VISUALIZATION,k.P1.THICKNESS_ANALYSIS_VISUALIZATION]);var _D;!function(e){e[e.UNSET=0]="UNSET",e[e.PICK_BODY=1]="PICK_BODY",e[e.PICK_ENTITY=2]="PICK_ENTITY"}(_D||(_D={}));class ND extends nD.View{setTranslucentModeFaceOpacity(e){Sm.material.isolateTranslucentAlpha=e,Im.material.isolateTranslucentAlpha=e,xg.setTranslucencyModifier(e),this.modelViewManagers.getManager().setTranslucentModeFaceOpacity(e)}setTranslucentModeEdgeOpacity(e){this.resources.TRANSLUCENT_PART_EDGE_NODE_PROPERTIES.material.isolateTranslucentAlpha=e,this.resources.TRANSLUCENT_PART_SMOOTH_EDGE_NODE_PROPERTIES.material.isolateTranslucentAlpha=e,this.resources.TRANSLUCENT_SURFACE_EDGE_NODE_PROPERTIES.material.isolateTranslucentAlpha=e,this.resources.TRANSLUCENT_PART_EDGE_NODE_PROPERTIES.material.isolateTranslucentAlpha=e,this.resources.TRANSLUCENT_SILHOUETTE_NODE_PROPERTIES.material.isolateTranslucentAlpha=e,this.resources.TRANSLUCENT_WIRE_EDGE_NODE_PROPERTIES.material.isolateTranslucentAlpha=e,mm.material.isolateTranslucentAlpha=e}resetIsolateContextTransparency(){const e=X.default.getManager();this.isolateContextFaceTransparency=e.getNumber("ISOLATE_CONTEXT_FACE_TRANSPARENCY"),this.isolateContextEdgeTransparency=e.getNumber("ISOLATE_CONTEXT_EDGE_TRANSPARENCY")}constructor(e){super(e),this.viewerPreferences=new uD.g,this.shouldUpdatePairedViewer=!1,this.scalarRetrievalPasses=[],this.hasMouseOver=!1,this.boundVAO=null,this.areOptimizedBuffersEnabled_=void 0,this.loggedPickIssue=!1,this.renderModeSubject=new As.x,this.isBrowserTabVisible="visible"===document.visibilityState,this.debugCamera=null,this.isSynchingView=!0,this.themeChangeSubscription=null,this.followGraphicsData=new k.xzX,this.followGraphicsDataSubject=new As.x,this.emptyBoxDeselectModeCount=0,this.resetIsolateContextTransparency(),TD=X.default.getManager().getNumber("PICK_WINDOW_PREVENT_CULL_MARGIN_PIXELS"),this.followGraphicsData.zebraStripeCount=CD.getNumber("ZEBRA_STRIPE_COUNT"),this.followGraphicsData.zebraStripeRotation=CD.getNumber("ZEBRA_STRIPE_ROTATION")}get areOptimizedBuffersEnabled(){return void 0===this.areOptimizedBuffersEnabled_&&(this.areOptimizedBuffersEnabled_=es.Jq.CapabilitiesService.checkDebugCurrentlyEnabled()&&"true"===localStorage.getItem("osForceEnableGPUBuffers")||es.Jq.CapabilitiesService.checkUseDisplayDataGPUBuffersCurrentlyEnabled()),this.areOptimizedBuffersEnabled_}bindVao(e){this.boundVAO!==e&&(this.getVertexArrayExtension().bindVertexArrayOES(e),this.boundVAO=e)}initialize(e){if(this.eventDispatcher=new nM.pB,this.gl=null,this.requestDraw=this.requestDrawUsingTimer,window.requestAnimationFrame&&(this.requestDraw=this.requestDrawUsingAnimationFrame),this.timeOfContextLoss=null,this.extensions={},this.highlightVertexTexturesSupported=null,this.SSAOFilteringSupported=null,this.highPrecisionSupportedInFragmentShader=null,this.hidden=!1,this.readyState=!1,this.isForFlattenedDisplay=e&&!!e.isForFlattenedDisplay,this.isForPreviousVersionDisplay=e&&!!e.isForPreviousVersionDisplay,this.renderContext=new oS(this),this.frameTimer=new eh(this),this.handleContextLoss=e=>{!function(e,t){mD.info(cM+"The WebGL context was lost. Memory usage at time of loss: "+e.getMemoryGauge().getUsageDetailsAsString()),e.gl=null,e.areVertexArrayObjectsAvailable=!1,e.timeOfContextLoss=(0,Xs.Wj)(),e.getEventDispatcher().trigger(nM.cW),e.showWebGLContextLostMessage(),t.preventDefault()}(this,e)},this.handleContextRestored=e=>{!function(e,t){e.getGlContext()&&(mD.info("A context restore was received without a context loss - simulating"),e.gl=null,e.getEventDispatcher().trigger(nM.cW)),e.setupGlContext(),mD.warn(cM+"The WebGL context was restored after "+(0,Xs.Es)(e.timeOfContextLoss).toFixed(0)+" ms"),e.timeOfContextLoss=null,e.getEventDispatcher().trigger(nM.pO,e.getGlContext()),e.onResize(),e.requestDraw(),e.hideWebGLContextLostMessage(),t.preventDefault()}(this,e)},!this.el)return void(this.viewerDestroyed=!0);this.el.addEventListener("webglcontextlost",this.handleContextLoss),this.el.addEventListener("webglcontextrestored",this.handleContextRestored);const t=e&&e.hidden;if(e&&e.glContext)this.gl=e.glContext,this.onNewGlContext();else if(!t&&(this.setupGlContext(),!this.gl))return;t&&this.hide(),(0,rD.WD)(this.getRendererInfo()),this.glSyncEveryFrame=!1,this.occurrenceDataManager=new Nh(this),this.modelViewManagers=new Mh(this.occurrenceDataManager,this),this.sceneGraphs=new ph,this.uiResourceManager=new fE(this,this.sceneGraphs),this.uiSelectionManager=new Lh.z,this.edgePointController=null,this.silhouetteTask=new pE(this),this.occurrenceIdManager=new TE.yx(this);e&&e.dontSetActive||((0,Sh.e$)(this),(0,nM.xA)().trigger(nM.zT)),this.getIsPrimaryViewer()&&(this.curvatureAnalysisManager=new Lc(this)),this.disableAutomaticDrawing=e&&!!e.disableAutomaticDrawing,this.disableViewManipulator=e&&!!e.disableViewManipulator,this.instantiatedShaders={},this.badShaders={},this.attribVertexEnabled={},this.boundTextures={},this.listenTo(this.getEventDispatcher(),nM.so,this.onSessionEnded),this.listenTo(this.getEventDispatcher(),nM.cW,this.onGlContextLost),this.listenTo(this.getEventDispatcher(),nM.pO,this.onGlContextRestored),this.listenTo(this.getEventDispatcher(),nM.u9,this.onViewDidDrawSynchronizeLocalView),MI(this),(0,Xs.jo)(this.getViewerId(),this),this.animationController=new OC(this),this.viewController=null,this.viewInitialized=!1,this.detailManager=new pa(es.Jq.AnalyticsService,this,this.frameTimer),this.loadTimer=null,this.bodyLoadTimer=null,this.elementLoadState=yD.WAITING_FOR_DISPLAY_DATA,this.shouldWaitForCompareDisplayData=!0,this.readyToUpdateElementLoadState=!1,this.receivedFeatureData=!1,this.receivedAssemblyDefinition=!1,this.isReadyForDrawOnLinkOpen=!0,this.initializedForDrawing=!1,this.renderingMode=k.P1.SHADED_WITH_EDGES,this.drawPasses=[],this.mainDrawPass=null,this.combinedPickPass=null,this.depthRetrievalPass=null,this.draftAngleRetrievalPass=null,this.depthSamplingPass=null,this.uiElements={},this.elementToPerElementState={},this.activeElementId="",this.printCanvas=null,this.suppressModelSelection=!1,this.queuedBaseData=null,this.selectionMapperForQueuedBase=null,this.queuedDisplayData=[],this.haveUnitsBeenReceived=!1,this.elementUnitChangedSubscription=(0,fr.vx)().elementUnitChangedObservable.subscribe((()=>this.requestDraw())),this.memoryGauge=new zI,this.boxSelectionDeferred=null,this.cursorStack=[],this.selectionCursor=kn.C.DEFAULT,this.lastMouseLocation=[-1,-1],this.frustumToPreventCulling=null;e&&e.disableSpaceball||Xa(),this.canEdit=!0,this.timestampOfLastDraw=0,this.averagePickDuration=-1,this.pickRadius=this.getDefaultPickRadius(),this.bodyLoadTasks=new Cl(this),this.bodyLoadTask=this.bodyLoadTasks.getLoadTask(),this.bodyManager=new ml(this,this.bodyLoadTasks.getUnloadTask()),this.modelViewManagers.getManager().setBodyLoadTasks(this.bodyLoadTasks),e.isForFlattenedDisplay||e.isForPreviousVersionDisplay||(this.isolatedOccurrenceManager=new sM(this)),this.taskManager=new _C,this.taskManager.addTask(this.bodyLoadTasks.getUnloadTask(),wC),this.taskManager.addTask(this.bodyLoadTask,vC),this.taskManager.addTask(this.silhouetteTask,wC),this.lastDevicePixelRatio=0,this.recordCapabilitiesTimeout=null,this.hidden||(this.recordCapabilitiesTimeout=window.setTimeout((()=>{xM(this.gl),this.recordCapabilitiesTimeout=null}),5e3)),this.MAX_TEXTURE_UNITS=8,this.textureNameToUnitMap={},this.textureUnitToNameMap={},this.textureAtlasFactory=null,this.sharedFrameBuffers={},this.sharedRenderBuffers={},this.resources=new Hn(this),this.activeElementPreviewManager=null;const i=(e,t)=>{let i=null;const s=this.pick(e,t);for(let e=0;e<s.length&&!i;++e)i=s[e].getModelSelection();let n;this.getModelViewManagers().getManager().displayingPartStudio()&&i&&i.isModifiable()&&(n=(0,Me.fM)(i),n&&n.getIsShowDimensionsEligible()&&n.getIsComputed()&&(0,mr.m)().trigger(pr.C.SHOW_DIMENSIONS_FOR_NODE_WITH_ID,n.getNodeId()))};this.inputHandler=null;e&&e.disableInput||(this.inputHandler=new Cs(i,this)),this.sketch=null,this.returnToPerspective=!1,this.viewManipulator=null,e&&e.disableViewManipulator||(this.viewManipulator=new mC(this,e.contextMenuMgr)),this.pickPassCount=0,this.drawTimer=null,this.standardRequestCallbackQueued=!1,this.inRequestDrawCallback=!1,this.referenceHighlights=new wn(this),this.highlightManager=new vn(this.referenceHighlights),this.compareHighlightManager=new vn(this.referenceHighlights),this.compareHighlightManager.usage=ys.L.PREVIEW,this.selectionsToKeepHiddenFromPick=[],this.performBodyCheck=!1,this.bodyCheckPass=new Et(this),this.hasElementPreviewLoaded=!1,this.storedCameraState=null,this.contextLossTimeout=null,this.zoomToSelectionBounds=null,this.listenTo(this.getEventDispatcher(),nM.ox,this.onMouseEnter),this.listenTo(this.getEventDispatcher(),nM.u5,this.onMouseLeave),this.latestDisplayDataUsageSubscription=Ls().latestDisplayDataUsageChangedObservable.subscribe((()=>this.onDisplayDataUsageChange())),this.listenTo((0,nM.xA)(),nM.Cr,this.onDefaultUnitsChanged),this.filteredEntitiesHighlightController=null,this.interferenceCallId="",this.xrController=new Dy(this),this.localDisplayDataCacheCleared=!1,this.debugShowSilhouetteEdgesOnNonVisibleTangentEdgeStyle=!1,this.smoothEdgeStyle=k.YUG.VISIBLE,this.browserTabVisibilityHandler=()=>this.onBrowserTabVisibilityChanged(),document.addEventListener("visibilitychange",this.browserTabVisibilityHandler),this.themeChangeSubscription=zl.GW.getThemeChangedObservable().subscribe((()=>this.onAppearanceConstantsUpdated())),this.pickRectPixelOffset=1,this.emptyBoxDeselectModeCount=0,this.initializationTime=performance.now()}enterEmptyBoxDeselectMode(){this.emptyBoxDeselectModeCount++}leaveEmptyBoxDeselectMode(){this.emptyBoxDeselectModeCount--,this.emptyBoxDeselectModeCount<0&&(mD.warn("EmptyBoxDeselectMode enter and leave is not paired!"),this.emptyBoxDeselectModeCount=0)}isEmptyBoxDeselectMode(){return this.emptyBoxDeselectModeCount>0}onViewDidDrawSynchronizeLocalView(){this.pairedViewer&&this.getIsSynchingView()&&this.shouldUpdatePairedViewer&&this.syncPairedView(),this.shouldUpdatePairedViewer=!0}onViewerReactivated(){this.getBodyManager().resetSelectionListHandlers(),this.isolatedOccurrenceManager?.stopListening(),this.isolatedOccurrenceManager?.setUpListeners(),this.modelViewManagers.getManager().resetSelectionListHandlers(),this.clearElementPreview(),this.elementToPerElementState={},this.localDisplayDataCacheCleared=!1;const e=this.getModelViewManagers().getManager().getSimulationManager();e&&e.onDocumentChange(),this.resetViewState()}showWebGLContextLostMessage(){const e=this.getModelViewManagers().getManager();if(e.displayingPartStudio()||e.displayingAssembly()){const e=pD('<div class="context-loss-message">'+i18n("One moment…")+"</div>").appendTo(this.$el.parent());this.clearContextLossTimeout(),this.contextLossTimeout=window.setTimeout((()=>{e.html(fD())}),X.default.getManager().getNumber("WEBGL_CONTEXT_WARNING_TIMEOUT_MS")),this.viewManipulator&&this.viewManipulator.hide()}}clearContextLossTimeout(){(0,ea.Z)(this.contextLossTimeout)&&(window.clearTimeout(this.contextLossTimeout),this.contextLossTimeout=null)}hideWebGLContextLostMessage(){const e=this.$el.parent().find(".context-loss-message");e.length>0&&(e.remove(),this.viewManipulator&&!this.hidden&&this.viewManipulator.show())}getEventDispatcher(){return this.eventDispatcher}setEventDispatcher(e){this.eventDispatcher=e}getOccurrenceIdManager(){return this.occurrenceIdManager}getActiveElementId(){return this.activeElementId}getBodyManager(){return this.bodyManager}getIdForOccurrence(e){return e?this.occurrenceIdManager.getIdForName(e.getPathAsString()):TE.KF}getModelViewManagers(){return this.modelViewManagers}isReadyToUpdateElementLoadState(){return this.readyToUpdateElementLoadState}getReceivedFeatureData(){return this.receivedFeatureData}getSceneGraphs(){return this.sceneGraphs}getUiResourceManager(){return this.uiResourceManager}getOccurrenceDataManager(){return this.occurrenceDataManager}getIsolatedOccurrenceManager(){return this.isolatedOccurrenceManager}getUISelectionManager(){return this.uiSelectionManager}getSilhouetteTask(){return this.silhouetteTask}areEdgeSilhouettesEnabled(){return this.detailManager.areFullDetailEdgeSilhouettesEnabled()}isInteractiveFramerateBelowThreshold(){return this.detailManager.isInteractiveFramerateBelowThreshold()}areInteractiveDetailsSignficantlyReduced(){return this.detailManager.getInteractiveSettings().lowLevelBodyProportion>0}isInteractiveSsaoEnabled(){return this.detailManager.isInteractiveSsaoEnabled()}areInteractiveSilhouettesEnabled(){return this.detailManager.areInteractiveSilhouettesEnabled()}getEdgePointController(){return this.edgePointController}createEdgePointController(){this.edgePointController&&this.edgePointController.disable(),this.edgePointController=new Ci(this)}getDefaultStandardView(){return this.getIsForFlattenedDisplay()?"XY":"Trimetric"}onMouseEnter(){(0,Sh.KO)(this),this.hasMouseOver=!0}onMouseLeave(){this.hasMouseOver=!1}getHasMouseOver(){return this.hasMouseOver}getIsForFlattenedDisplay(){return!!this.isForFlattenedDisplay}getIsForPreviousVersionDisplay(){return!!this.isForPreviousVersionDisplay}getIsPrimaryViewer(){return!this.getIsForFlattenedDisplay()&&!this.getIsForPreviousVersionDisplay()}getSupportsPreview(){return!this.getIsForPreviousVersionDisplay()}requestDrawUsingTimer(e,t,i){t=t||AD;const s=this;if(!this.drawTimer||i){if(!e){if(this.disableAutomaticDrawing)return;e=function(){s.drawTimer=null;s.draw(undefined,t)}}this.drawTimer=window.setTimeout(e,10)}}requestDrawUsingAnimationFrame(e,t,i){if(this.isOngoingRenderLoopRunning)return;t=t||AD;const s=this;if(i||e||!this.standardRequestCallbackQueued&&!this.inRequestDrawCallback){if(e){const t=e;e=e=>{this.inRequestDrawCallback=!0,t(e),this.inRequestDrawCallback=!1}}else{if(this.disableAutomaticDrawing)return;e=function(e){s.standardRequestCallbackQueued=!1,s.inRequestDrawCallback=!0,s.draw(e,t),s.inRequestDrawCallback=!1},s.standardRequestCallbackQueued=!0}window.requestAnimationFrame(e)}}setInRequestDrawCallback(e){this.inRequestDrawCallback=e}forceRequestDraw(e){this.requestDraw(void 0,e,!0)}requestDrawForInteractiveProcessing(){this.requestDrawUsingTimer(undefined,PD)}resetPickPassCount(){this.pickPassCount=0}notifyOfPickPassCount(e){e>this.pickPassCount&&(this.pickPassCount=e)}getPickPassCount(){return this.pickPassCount}onGlContextLost(){this.resetCachedState(),this.resetSharedBuffers(),this.memoryGauge.reset(),this.frameTimer.onContextLost()}onGlContextRestored(){this.frameTimer.onContextRestored()}onSessionEnded(){this.resetShaders(),this.resetSharedBuffers(),this.resources.reset()}bindTextureToUnit(e,t){this.gl&&this.boundTextures[t]!==e&&(this.gl.activeTexture(this.gl.TEXTURE0+t),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.boundTextures[t]=e)}getSketch(){return this.sketch}setSketch(e){this.sketch&&(e&&this.sketch.id===e.id||this.getModelViewManagers().getManager().displaySketchAsInactive(this.sketch.id),this.sketch=null);const t=this.getPrimaryViewController();e?(e.viewer=this,this.sketch=e,this.getModelViewManagers().getManager().displaySketchAsActive(this.sketch.id),t&&t.isPerspective()&&(this.returnToPerspective=!0,this.setPrimaryViewController(t.getMatchingOrthographicController())),(0,nM.xA)().trigger(nM.Fc,ts.SKETCH)):this.returnToPerspective&&(t&&t.isOrthographic()&&this.setPrimaryViewController(t.getMatchingPerspectiveController()),this.returnToPerspective=!1),this.getInputHandler()&&this.getInputHandler().setSketch(this.sketch),this.sketch||(0,nM.xA)().trigger(nM.Fc,ts.PART_STUDIO)}disableCurrentLaminarHighlightController(){const e=this.getFilteredEntitiesHighlightController();e&&(e.disable(),this.setFilteredEntitiesHighlightController(null))}clearSketch(e){this.sketch===e?this.setSketch(null):mD.info("sketch to be cleared does not match the current sketch")}setHoveredSelection(e){if(this.clearHoveredSelection(),e instanceof Me.Y1)(0,Me.a3)(e);else if(e instanceof Lh.i){const t=this.getUISelectionManager();t&&t.setHoveredSelection(e,{})}}setUISelection(e){const t=this.getUISelectionManager();t&&t.setSelection(e)}clearHoveredSelection(){const e=this.getUISelectionManager();e&&e.setHoveredSelection(null,{});(0,Me.Zs)(!0,!1)}getInputHandler(){return this.inputHandler}setSuppressMouseMovePick(e){this.inputHandler&&this.inputHandler.setSuppressMouseMovePick(e)}getLastMouseMovedEvent(){return this.inputHandler?this.inputHandler.getLastMouseMovedEvent():null}getLastMouseLocation(){return this.lastMouseLocation}getFrustumToPreventCulling(){return this.frustumToPreventCulling}getPickFrustum(){return this.pickFrustum}getResources(){return this.resources}setViewInitialized(e){this.viewInitialized=e}resetCachedState(){this.attribVertexEnabled={},this.boundTextures={}}resetShaders(){this.instantiatedShaders={},this.resetCachedState()}resetSharedBuffers(){this.sharedFrameBuffers={},this.sharedRenderBuffers={}}getOrCreateFrameBuffer(e,t,i){if(e!==this.getHalfFloatType()||this.getExtension("EXT_color_buffer_half_float")?e!==this.gl.FLOAT||this.getExtension("WEBGL_color_buffer_float")||mD.debug("WEBGL_color_buffer_float extension not supported"):mD.debug("EXT_color_buffer_half_float extension not supported"),!t)return new ih(this,e,t,i);let s=this.sharedFrameBuffers[t];return s||(this.sharedFrameBuffers[t]=s=new ih(this,e,t,i)),s}getOrCreateRenderBuffer(e,t,i){const s=i?.id;let n=null;if(!this.gl)return null;if(!s)return n=this.gl.createRenderbuffer(),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,n),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,i.storageType,e,t),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null),n;const r=this.sharedRenderBuffers[s];return r&&r.width===e&&r.height===t?r.buffer:(n=this.gl.createRenderbuffer(),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,n),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,i.storageType,e,t),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null),this.sharedRenderBuffers[s]={buffer:n,width:e,height:t},n)}resetExtensions(){const e=Object.keys(this.extensions);this.extensions={};for(let t=0;t<e.length;++t)this.getExtension(e[t])}getExtension(e){if(!this.gl)return mD.warn(`Tried to get webgl extension ${e} without valid webgl context`),null;let t=this.extensions[e];return void 0!==t||(t=this.gl.getExtension(e),this.extensions[e]=t),t}getMaximumTextureSize(){return this.gl?this.gl.getParameter(this.gl.MAX_TEXTURE_SIZE):1024}isExtensionSupported(e){return!!this.getExtension(e)}areFloatTexturesSupported(){return this.isExtensionSupported("OES_texture_float")}isFloatBufferBlendingSupported(){return this.isExtensionSupported("EXT_float_blend")}are32BitIndicesSupported(){return this.isExtensionSupported("OES_element_index_uint")}areShaderDerivativesSupported(){return!!this.getExtension("OES_standard_derivatives")}isHighPrecisionFragmentShaderSupported(){return(0,Xs.J5)(this.gl)}getAnisotropicExtension(){return this.getExtension("EXT_texture_filter_anisotropic")||this.getExtension("WEBKIT_EXT_texture_filter_anisotropic")}getDrawbuffersExtension(){return this.getExtension("WEBGL_draw_buffers")||this.getExtension("EXT_draw_buffers")}getVertexArrayExtension(){return this.getExtension("OES_vertex_array_object")}getHalfFloatType(){const e=this.getExtension("OES_texture_half_float");return e?e.HALF_FLOAT_OES:0}getDefaultFloatTextureType(){return this.getHalfFloatType()||this.gl?.FLOAT}getHighPrecisionFloatTextureType(){return this.gl?.FLOAT}getReferenceHighlights(){return this.referenceHighlights}getHighlightManager(e){return ys.L.PREVIEW===e?this.compareHighlightManager:this.highlightManager}resetHighlightManagers(){this.highlightManager=new vn(null),this.compareHighlightManager=new vn(null)}updateHighlightColors(e){os.PoX.forEach((t=>{this.getReferenceHighlights().updateHighlightColor(t,e)})),Vl(e);for(const e in this.uiElements)this.uiElements[e].onHighlightColorUpdated()}areHighlightVertexTexturesSupported(){if(null===this.highlightVertexTexturesSupported)if(this.gl){const e=this.gl.getParameter(this.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS);this.highlightVertexTexturesSupported=e>1}else mD.warn("An attempt was made to evaluate whether or not highlight vertex textures are supported before the gl context was initialized");return!!this.highlightVertexTexturesSupported}getRendererInfo(){return this.rendererInfo||(this.rendererInfo=Qt(this.gl)),this.rendererInfo}isSSAOFilteringSupported(){return null===this.SSAOFilteringSupported&&(this.SSAOFilteringSupported=!/intel/gi.test(this.getRendererInfo().glRenderer)),this.SSAOFilteringSupported}isHighPrecisionSupportedInFragmentShader(){if(null!==this.highPrecisionSupportedInFragmentShader)return this.highPrecisionSupportedInFragmentShader;if(!this.gl)return!1;const e=this.gl.getShaderPrecisionFormat(this.gl.FRAGMENT_SHADER,this.gl.HIGH_FLOAT);return this.highPrecisionSupportedInFragmentShader=!!e&&0!==e.precision,this.highPrecisionSupportedInFragmentShader}supportsOrderIndependentTranslucency(){return this.areFloatTexturesSupported()}supportsGraphicalSectionPlanes(){return this.areFloatTexturesSupported()&&this.isFloatBufferBlendingSupported()}getIsExcludingItemsForSection(){return(0,lD.Ky)().getIsExcludingItemsForSection()}supportsDraftAnalysis(){return this.areFloatTexturesSupported()}getTextureAtlasFactory(){return this.textureAtlasFactory||(this.textureAtlasFactory=new QM.Fk),this.textureAtlasFactory}debugGetAllocatedTextureUnitsString(){const e=Object.keys(this.textureNameToUnitMap);let t="Texture allocation: ";for(let i=0;i<e.length;++i)t+=e[i]+": "+this.textureNameToUnitMap[e[i]]+", ";return t}getOrAllocateTextureUnit(e){if(this.textureNameToUnitMap.hasOwnProperty(e))return this.textureNameToUnitMap[e];let t=0;for(;t<this.MAX_TEXTURE_UNITS&&this.textureUnitToNameMap[t];)t++;return t>=this.MAX_TEXTURE_UNITS?(mD.error("Ran out of texture units (max "+this.MAX_TEXTURE_UNITS+") storing "+e+". Allocation: "+this.debugGetAllocatedTextureUnitsString()),-1):(this.textureNameToUnitMap[e]=t,this.textureUnitToNameMap[t]=e,t)}releaseTextureUnit(e){if(!this.textureNameToUnitMap.hasOwnProperty(e))return void mD.error("Could not find texture unit for "+e);const t=this.textureNameToUnitMap[e];delete this.textureNameToUnitMap[e],delete this.textureUnitToNameMap[t]}getTextureUnit(e){return this.textureNameToUnitMap[e]}getGlContext(){return this.gl}getShader(e){let t=this.instantiatedShaders[e];return t||(t=new OI(this,e),this.instantiatedShaders[e]=t),t}enableVertexAttributeArray(e,t){(this.areVertexArrayObjectsAvailable||this.attribVertexEnabled[e]!==t)&&this.gl&&(t?this.gl.enableVertexAttribArray(e):this.gl.disableVertexAttribArray(e),this.areVertexArrayObjectsAvailable||(this.attribVertexEnabled[e]=t))}disableAllVertexAttributeArrays(){for(const e in this.attribVertexEnabled)this.enableVertexAttributeArray(+e,!1)}setupGlContext(){if(this.gl=null,!(this.el instanceof HTMLCanvasElement))return;let e=null;const t=["webgl","experimental-webgl","webkit-3d","moz-webgl"];for(let i=0;i<t.length;++i){try{e=this.el.getContext(t[i],OD),e instanceof WebGLRenderingContext||e instanceof CaptureContext||(e=null)}catch(e){}if(e)break}e&&(this.gl=e,this.onNewGlContext())}onNewGlContext(){this.gl&&(this.gl.frontFace(this.gl.CCW),this.gl.enable(this.gl.DEPTH_TEST)),this.resetExtensions(),this.rendererInfo=Qt(this.gl),(0,rD.WD)(this.rendererInfo),this.glSyncEveryFrame=(0,pt.isPlatformMac)()&&(0,pt.isBrowserSafari)()&&/intel/i.test(this.rendererInfo.glVendor),this.renderContext.onNewContext(this.gl),ri(this.are32BitIndicesSupported()),(0,Fh.Vp)(this.rendererInfo),this.areVertexArrayObjectsAvailable=!!this.getVertexArrayExtension(),this.frameTimer.onContextCreated()}getWebGlSupport(){let e=hD.c.SUPPORTED;return this.el?window.WebGLRenderingContext?this.gl||(e=hD.c.OTHER_PROBLEM):e=hD.c.MISSING:e=hD.c.OTHER_PROBLEM,e}getViewerId(){return this.cid}getFrameTimer(){return this.frameTimer}setDevicePixelRatioOverride(e){const t=DD(Math.max(this.$el.width(),1),e),i=DD(Math.max(this.$el.height(),1),e);(0,ns.Lt)(e),this.el.width=t,this.el.height=i,this.getCamera()?.setViewportFromCanvasElement(this.$el),this.stopBoxSelection(),this.draw()}onResize(e){e=void 0===e||e;const t=this.getGlContext();if(!t)return;if(!this.el)return;let i=(0,ns.XC)(),s=DD(Math.max(this.$el.width(),1),i),n=DD(Math.max(this.$el.height(),1),i);if((0,pt.isBrowserSafari)()){const e=DD(screen.width,i),t=DD(screen.height,i);if(s>e||n>t){const r=Math.min(e/s,t/n);mD.info("Canvas dimensions exceeded screen size, scaling by a factor of: "+r.toFixed(4)),i*=r,(0,ns.Lt)(i),s=DD(Math.max(this.$el.width(),1),i),n=DD(Math.max(this.$el.height(),1),i)}else(0,ns.eu)()}this.el.width=s,this.el.height=n,t.viewportWidth=this.el.width,t.viewportHeight=this.el.height,t.aspectRatio=this.el.width/this.el.height,this.mainDrawPass&&(this.setUserIsManipulatingWithTimeout(),this.getCamera()?.setViewportFromCanvasElement(this.$el),this.stopBoxSelection(),e&&this.requestDraw())}pushCameraState(e){const t=e||this.getCamera();t?(this.renderContext.setActiveCamera(t),this.renderContext.pushModelViewMatrix(t.getViewMatrix()),this.renderContext.pushProjectionMatrix(t.getProjectionMatrix()),this.renderContext.pushViewport(t.getViewport())):mD.warn("Camera not found")}popCameraState(){this.renderContext.popModelViewMatrix(),this.renderContext.popProjectionMatrix(),this.renderContext.popViewport()}setBaseFrameBuffer(e){this.baseFrameBuffer=e}setBaseFrameBufferToDefault(){this.baseFrameBuffer=null}getBaseFrameBufferWidth(){return this.baseFrameBuffer?this.baseFrameBuffer.getWidth():this.getCamera().getCanvasWidth()}getBaseFrameBufferHeight(){return this.baseFrameBuffer?this.baseFrameBuffer.getHeight():this.getCamera().getCanvasHeight()}onComputedData(e){if(e.elementId!==this.activeElementId)return;(this.modelViewManagers.getPreviewManager()||this.modelViewManagers.getManager()).processManagedData(e),this.readyAndUpdateElementLoadState(e.elementId)}readyAndUpdateElementLoadState(e){e===this.activeElementId&&(this.readyToUpdateElementLoadState=!0,this.updateElementLoadState())}onFeatureData(e){e===this.activeElementId&&(this.receivedFeatureData=!0,this.updateElementLoadState())}onAssemblyDefinition(e){e===this.activeElementId&&(this.receivedAssemblyDefinition=!0,this.readyToUpdateElementLoadState=!0,this.updateElementLoadState())}setWaitingForLinkOpen(){this.isReadyForDrawOnLinkOpen=!1}onReadyForDrawOnLinkOpen(){this.isReadyForDrawOnLinkOpen=!0,this.updateElementLoadState()}prepareElementDisplayData(){this.elementLoadState===yD.LOADING_DISPLAY_DATA&&(this.modelViewManagers.getManager().getModelBounds(),this.loadingDisplayDataTimer?.report(),this.loadingDisplayDataTimer=null,this.elementLoadState=yD.LOADED_DISPLAY_DATA,this.updateElementLoadState())}updateElementLoadState(){const e=this.modelViewManagers.getManager();this.elementLoadState!==yD.LOADED_DISPLAY_DATA||!this.readyToUpdateElementLoadState||!this.isReadyForDrawOnLinkOpen||!this.receivedFeatureData&&e.displayingPartStudio()||!this.receivedAssemblyDefinition&&e.displayingAssembly()||(this.getEventDispatcher().trigger(nM.cp,this.activeElementId),this.elementLoadState=yD.LOADED_ALL_DATA,this.clearElementPreview(),this.bodyLoadTask.hasPendingWork()?(this.doesControlBodySpinner()&&(0,sI.l)().startBodyLoadBeeper(),this.bodyLoadTimer=new Ih.B7("Loading bodies, isForFlattened: "+this.getIsForFlattenedDisplay(),LD())):this.doesControlBodySpinner()&&(0,sI.l)().stopBodyLoadBeeper(),this.loadTimer&&(this.loadTimer.report(),this.loadTimer=null),this.setReadyState(!0),this.requestDraw())}hasPendingBodiesToLoad(){return this.bodyLoadTask.hasPendingWork()}getPendingBodiesToLoadPromise(){return this.bodyLoadTask.getTaskFinishedPromise()}hasPendingWork(){return this.bodyLoadTask.hasPendingWork()||this.taskManager.hasPendingWork()}doesControlBodySpinner(){return!this.getIsForFlattenedDisplay()}getRenderContext(){return this.renderContext}getMemoryGauge(){return this.memoryGauge}getRenderingMode(){return this.renderingMode}isRenderingModeSafeForLinkSharing(e){return e!==k.P1.UNKNOWN&&!SD.has(e)}preventChangeToRenderMode(e){return!!this.getCurvatureAnalysisManager()?.preventChangeToRenderMode(e)||(!!this.preventZebraStripesDuringInterferenceDetection(e)||!this.getIsPrimaryViewer()&&e===k.P1.SHADED_CURVATURE_VISUALIZATION)}preventZebraStripesDuringInterferenceDetection(e){const t=i18n("Zebra stripes are not supported during interference detection");if(void 0===e&&this.renderingMode===k.P1.CURVATURE_VISUALIZATION)return es.Jq.MessageBubbleService.showMessageWithAutoDismiss(t,"warning"),this.resetToDefaultRenderingMode(),!0;if(e===k.P1.CURVATURE_VISUALIZATION){if(gi._3.getOpenDocumentController().isInterferenceDetectionActive())return es.Jq.MessageBubbleService.showMessageWithAutoDismiss(t,"warning"),!0}return!1}setRenderingMode(e){if(this.preventChangeToRenderMode(e))return;this.renderingMode=e,this.renderContext.setRenderingMode(e),this.mainDrawPass?.setRenderingMode(e),this.combinedPickPass?.setRenderingMode(e);const t=this.getModelViewManagers().getManager().getSimulationManager();t&&t.onRenderingModeChanged(),this.getCurvatureAnalysisManager()?.onRenderingModeChanged(),this.getThicknessAnalysisManager()?.onRenderingModeChanged(),this.resources.onRenderingModeChanged(),this.modelViewManagers.onRenderingModeChanged(),this.renderModeSubject.next(e),this.getIsPrimaryViewer()&&(this.followGraphicsData.renderingMode=e,this.followGraphicsDataSubject.next(this.followGraphicsData)),this.isolatedOccurrenceManager?.setRenderingMode(e),this.requestDraw()}resetToDefaultRenderingMode(){this.setRenderingMode(this.viewerPreferences.renderingMode)}toggleDebugShowSilhouetteEdgesOnNonVisibleTangentEdgeStyle(){this.debugShowSilhouetteEdgesOnNonVisibleTangentEdgeStyle=!this.debugShowSilhouetteEdgesOnNonVisibleTangentEdgeStyle}debugIsShowingSilhouetteEdgesOnNonVisibleTangentEdgeStyle(){return this.debugShowSilhouetteEdgesOnNonVisibleTangentEdgeStyle}showTangencyInformationMissingMessage(){this.localDisplayDataCacheCleared||(mD.trace("Unknown smoothness status edge found, clearing local display data cache"),(0,mr.m)().trigger(pr.C.CLEAR_LOCAL_DISPLAY_DATA_CACHE),this.localDisplayDataCacheCleared=!0),es.Jq.MessageBubbleService.showMessageWithAutoDismiss(i18n("Render mode could not be applied. Necessary information is missing in older display data."),"warning")}getSmoothEdgesRenderStyle(){return this.smoothEdgeStyle}setSmoothEdgesRenderStyle(e){if(this.smoothEdgeStyle===e)return;this.smoothEdgeStyle=e,this.resources.updateSmoothEdgeMaterial();const t=this.getModelViewManagers();if(t.getManager().refreshSmoothEdgesForAllPartStudios()){if(t.previewManagerExists()&&t.getPreviewManager().refreshSmoothEdgesForAllPartStudios(),!this.getIsForFlattenedDisplay()){const t=fa.t.getController();t&&t.onSmoothEdgeStyleChanged(this);const i=gi._3.getOpenDocumentController();if(i){const t=i.getSheetMetalViewer();t&&this!==t&&this.getActiveElementId()===t.getActiveElementId()&&(t.setSmoothEdgesRenderStyle(e),t.requestDraw())}}this.getIsPrimaryViewer()&&(this.followGraphicsData.smoothEdgeStyle=e,this.followGraphicsDataSubject.next(this.followGraphicsData))}else this.setSmoothEdgesRenderStyle(k.YUG.VISIBLE)}initializeForDrawing(){this.initializedForDrawing||(this.onResize(),this.mainDrawPass=new Ot(this),this.drawPasses.push(this.mainDrawPass),this.combinedPickPass=new we(this,this.mainDrawPass),this.mainDrawPass.getDebugDrawPickPass().setPickPass(this.combinedPickPass),this.drawPasses.push(this.combinedPickPass),this.depthRetrievalPass=new Ze(this),this.drawPasses.push(this.depthRetrievalPass),this.draftAngleRetrievalPass=new dt(this),this.drawPasses.push(this.draftAngleRetrievalPass),this.depthSamplingPass=new ce(this),this.drawPasses.push(this.depthSamplingPass),this.mainDrawPass.prepareShaders(),this.combinedPickPass.prepareShaders(),this.depthRetrievalPass.prepareShaders(),this.depthSamplingPass.prepareShaders(),this.viewController||(this.viewController=new hr(this),this.viewController.getCamera().setViewportFromCanvasElement(this.$el),this.viewController.setStandardView(this.getDefaultStandardView())),this.initializedForDrawing=!0,(0,pt.isPlatformChromebook)()&&(0,pt.getChromeVersion)()>=107&&this.mainDrawPass.setClearColor(1,1,1,1))}initializeView(){if(!this.viewInitialized){const e=this.getCamera(),t=e.getViewportWidth()*e.getViewportHeight()>=CD.getNumber("MIN_MODEL_PIXEL_SIZE"),i=this.getModelBounds();if(t&&i.isInitialized()&&i.isExtensive()){const e=!0;this.zoomFit(e),this.viewInitialized=!0}this.findDepthsInRect(0,0,1,1)}}hasResourcesNeededForDrawing(){const e=!this.isForFlattenedDisplay||this.modelViewManagers.getManager().hasSelectedSheetmetalModelId();return(this.hasElementPreviewLoaded||this.elementLoadState===yD.LOADED_ALL_DATA)&&!po()&&e}isReadyForDrawing(){return!!this.getGlContext()&&this.initializedForDrawing&&this.hasResourcesNeededForDrawing()}getFilteredEntitiesHighlightController(){return this.filteredEntitiesHighlightController}onLaminarEdgesChanged(e){this.getIsPrimaryViewer()&&(this.followGraphicsData.isBoundaryEdgeHighlightOn=e,this.followGraphicsDataSubject.next(this.followGraphicsData))}setFilteredEntitiesHighlightController(e){return this.filteredEntitiesHighlightController=e,this.filteredEntitiesHighlightController}draw(e,t){if(this.viewerDestroyed)return;const i=this.getGlContext();if(!i)return;t=t||wD;const s=(0,ns.x_)();if(s!==this.lastDevicePixelRatio){t.forPrint||this.el.width===DD(this.$el.width(),s)&&this.el.height===DD(this.$el.height(),s)||this.onResize(!1),this.lastDevicePixelRatio=s;const e=t.camera||this.getCamera();this.getEventDispatcher().trigger(nM.b3,e),this.resources.onDevicePixelRatioChanged(t.forPrint);for(const t in this.uiElements)this.uiElements[t].onDevicePixelRatioChanged(e);this.resetPickRadius()}if(e){if(e===this.timestampOfLastDraw)return;this.timestampOfLastDraw=e,Ya(this,e)}if(this.initializeForDrawing(),!this.mainDrawPass)return;if(this.prepareElementDisplayData(),!this.hasResourcesNeededForDrawing())return void(this.hidden||this.processPendingWork());this.initializeView(),t.performFrameTiming&&this.frameTimer.onDrawStart(),this.renderContext.setDetailSettings(this.detailManager.getDetailSettings()),(0,Ln.qn)().resetCounters();const n=t.camera?t.camera:this.getCamera();this.triggerOnViewWillDraw(n),this.processPendingWork(),this.cleanUpOrphanedObjects(),n.setSceneBounds(this.getSceneBounds()),this.pushCameraState(n),t.skipUpdateBodyCulling||this.bodyManager.updateForFrame(this.renderContext,!0),this.renderContext.prepareForNextFrame(),this.mainDrawPass.drawInputs(this.renderContext),this.mainDrawPass.draw(this.renderContext),this.popCameraState(),this.getEventDispatcher().trigger(nM.u9,this),this.memoryGauge.addToStatistics(),(0,Ln.qn)().updateModel(),this.performBodyCheckAsNeeded(),this.glSyncEveryFrame&&i.finish(),t.performFrameTiming&&this.frameTimer.onDrawEnd()}triggerOnViewWillDraw(e){const t=(0,fr.vx)();this.getEventDispatcher().trigger(nM.Hv,e,t);for(const i in this.uiElements)this.uiElements[i].onViewWillDraw(e,t)}processPendingWork(){this.taskManager.hasPendingWork()&&(this.taskManager.processInteractively(),this.requestDrawForInteractiveProcessing()),this.bodyLoadTask.hasPendingWork()||(this.bodyLoadTimer&&(this.doesControlBodySpinner()&&(0,sI.l)().stopBodyLoadBeeper(),this.bodyManager.initiateAutomaticRetrieval(!0),this.bodyLoadTimer.report(),this.frameTimer.resetTimings(),this.bodyLoadTimer=null),this.hasResourcesNeededForDrawing()||this.modelViewManagers.getManager().getMeshManager().compileBuffers())}performBodyCheckAsNeeded(){this.performBodyCheck&&this.areFloatTexturesSupported()&&!this.bodyLoadTask.hasPendingWork()&&this.modelViewManagers.getManager().displayingPartStudio()&&(this.bodyCheckPass.draw(this.renderContext),this.performBodyCheck=!1)}cleanUpOrphanedObjects(){this.getUiResourceManager().clean(),(0,Gi.Gy)(),this.disableAllVertexAttributeArrays()}getSceneBounds(){let e=new wi.kB;const t=this.sceneGraphs.getMainSceneGraph().getRootNode().getBoundingBox({includeHiddenBounds:this.renderContext.getIsPickingHiddenOccurrences()}),i=this.sceneGraphs.getPreviewSceneGraph().getRootNode().getBoundingBox();e.addBox(t),e.addBox(i);const s=this.modelViewManagers.getManager().getSimulationManager();s&&e.addBox(s.getSimulationBounds());return(!e.isInitialized()||!e.isExtensive())&&this.hasElementPreviewLoaded&&this.activeElementPreviewManager&&e.addBox(this.activeElementPreviewManager.getModelBounds()),this.zoomToSelectionBounds&&this.zoomToSelectionBounds.isFinite()&&e.addBox(this.zoomToSelectionBounds),e.isInitialized()&&e.isExtensive()||(e=this.getDefaultBounds()),e}getDefaultBounds(){const e=new wi.kB;return e.set([-1,-1,-1],[1,1,1]),e}getModelBounds(e){const t=new wi.kB,i=this.modelViewManagers.getManager().getModelBounds(e);i&&t.addBox(i,null);const s=this.modelViewManagers.getPreviewManager();return s&&t.addBox(s.getModelBounds(e),null),t.isInitialized()&&t.isExtensive()||!this.hasElementPreviewLoaded||!this.activeElementPreviewManager||t.addBox(this.activeElementPreviewManager.getModelBounds()),t}getUiElementsBounds(){const e=new wi.kB;for(const t in this.uiElements){const i=this.uiElements[t];i.isVisibleToUser()&&e.addBox(i.getFitBounds(),i.getTransform())}return e}getFitBounds(e){let t=this.getUiElementsBounds();if(t.addBox(this.getModelBounds()),!t.isInitialized()||!t.isExtensive())return this.getSceneBounds();if((0,lD.ti)()>0&&this.isReadyForDrawing()&&this.depthSamplingPass){e||(e=this.getCamera()?.getFrame());const i=this.getPrimaryViewController()?.getZoomFitTargetCamera(e,t,!0);if(!i)return t;this.pushCameraState(i),(0,lD.qf)(),this.bodyManager.updateForFrame(this.renderContext,!1),this.depthSamplingPass.retrieve(this.renderContext,{numSamples:CD.getNumber("HIGH_QUALITY_DEPTH_SAMPLES_PER_VIEWPORT"),performIsolationTest:!1}),this.popCameraState();const s=new wi.kB;for(let e=0;e<this.depthSamplingPass.points.length;++e)s.addPoint(i.canvasToWorld(this.depthSamplingPass.points[e]));if(!s.isInitialized()||!s.isExtensive())return this.getSceneBounds();s.maxDimension()/t.maxDimension()<.9&&s.scale(CD.getNumber("CAMERA_ZOOM_TO_FIT_SECTION_PLANE_EXTRA_SLOP")),t=s}return t}getAnimationController(){return this.animationController}getPrimaryViewController(){return this.viewController}getFollowGraphicsDataObservable(){return this.followGraphicsDataSubject.asObservable()}getCurrentFollowingGraphicsData(){return this.followGraphicsData}getCamera(){return this.debugCamera?this.debugCamera:this.viewController?this.viewController.getCamera():null}setPrimaryViewController(e){this.viewController!==e&&(this.viewController=(0,j.as)(ar,e),this.requestDraw())}setPickRadius(e){this.pickRadius=e}needToChangePickRectDimensions(){if(!(0,pt.isPlatformWindows)())return!1;if(!this.getRendererInfo())return!1;const e=this.getRendererInfo().glRenderer.toLowerCase();return e.includes("adreno")&&e.includes("qualcomm")||(0,pt.isBrowserFirefox)()&&Jt(e)&&e.includes("direct3d")}getDefaultPickRadius(){let e=CD.getNumber("MOUSE_PICK_RADIUS_PX");return e<8&&this.needToChangePickRectDimensions()&&(e<=3?e=4:e<=5?e=6:e<=7&&(e=8),this.pickRectPixelOffset=0),e}resetPickRadius(){this.setPickRadius(this.getDefaultPickRadius())}pick(e,t,i){return this.pickIteratively(e,t,this.getDefaultPickTerminationEvaluator(),i)}getDefaultPickTerminationEvaluator(){let e=0;return(t,i)=>++e>100||(!this.combinedPickPass||this.combinedPickPass.updatePickMask(t,this.renderingMode,i))}pickIteratively(e,t,i,s){const n=[];let r,a;const o=2*this.pickRadius+this.pickRectPixelOffset,h=2*this.pickRadius+this.pickRectPixelOffset,c=e-this.pickRadius,l=t-this.pickRadius;let d=0;const u={},g=(0,j.as)(Ch,this.modelViewManagers.getManagerForUsage(Vs())),p=this.getRenderingMode();let m=!0;for(;;){const e=this.pickInRect(c,l,o,h,m,{pickHiddenOccurrences:!!s&&!!s.pickHiddenOccurrences,cameraOverride:s?s.cameraOverride:null,cullOutsideOccurrencesForPicking:!0});if(m=!1,e.length<1)break;for(r=0;r<e.length;++r){a=e[r];const t=a.getModelSelection();if(t){const e=t.getIdForCollection();if(!e||u[e])continue;u[e]=e}a.fromPass=d,a.entityMetaData&&this.getSketch()&&(a.isFromActiveSketch=a.entityMetaData.getSketchFeatureId()===this.getSketch()?.getId()),n.push(a)}if(i(e,s))break;for(r=0;r<e.length;++r)e[r].canPickThrough(p,this,s)&&this.hidePick(e[r],g);++d}return this.combinedPickPass?.clearPickMask(),this.resetIdsHiddenFromPick(),s&&s.altKey?(0,cD.Z)(n,(e=>{const t=e.getModelSelection();if(null===t)return mD.warn("Cannot determine translucency of pick element for sorting, assuming default opacity."),!1;if(t.entityMetaData&&t.entityMetaData.isTranslucent())return!0;const i=t.getOccurrence(),s=e.getOccurrenceId(),n=g.getPartStudioDataFromOccurrence(i);if(!n)return!1;const r=n.getBodyComponent().getFaceColor(e?.deterministicId,s);return r&&r[3]<1})):n.sort(cD.G)}pickMany(e,t,i,s){const n=2*i+1,r=2*i+1,a=e-i,o=t-i;return this.pickManyInRect(a,o,n,r,!0,!1,s)}getBodyOccurrenceIndex(e){const t=e.getOccurrenceId(),i=e.bodyMetaData.getId(),s=this.getOccurrenceIdManager().getNameForId(+t);return{occurrenceId:t,occurrenceBodyId:i,occurrence:k._oC.getOccurrenceFromPathStringWithCheck(s)}}pickInRect(e,t,i,s,n=!0,r){if(!this.isReadyForDrawing()||!this.combinedPickPass)return[];const a=r&&r.cameraOverride?r.cameraOverride:this.getCamera();this.getEventDispatcher().trigger(nM.b9,a,(0,fr.vx)());const o=r?.pickHiddenOccurrences;let h,c;this.renderContext.setIsPickingHiddenOccurrences(!!o),a?.setSceneBounds(this.getSceneBounds()),this.pushCameraState(a),this.combinedPickPass.setPickRect(e,t,i,s,r&&r.sampleLimit),r&&r.doNotAffectFrustumCulling||(this.frustumToPreventCulling=this.combinedPickPass.getPickFrustum(this.renderContext,TD)),this.pickFrustum=this.combinedPickPass.getPickFrustum(this.renderContext,0),this.renderContext.setDetailSettings(this.detailManager.getInteractiveSettings()),n&&this.bodyManager.updateForFrame(this.renderContext,!1,r?.cullOutsideOccurrencesForPicking,r?.bodyOccurrencesInsidePickFrustumOut),r&&r.nodeFilterOverride?this.combinedPickPass.setNodeFilterOverride(r.nodeFilterOverride):this.combinedPickPass.setNodeFilterOverride(null),this.combinedPickPass.setPickFromPreview(Bs()||!!r&&!!r.forcePreviewPick),this.combinedPickPass.draw(this.renderContext),this.renderContext.setIsPickingHiddenOccurrences(!1),this.popCameraState();const l=this.modelViewManagers.getManagerForUsage(this.combinedPickPass.getUsage()),d=this.combinedPickPass.gatherPicksFromPickPass(),u=[];let g;for(c in d){c=+c;const e=this.getOccurrenceIdManager().getNameForId(+c);e||c===TE.QC||this.loggedPickIssue||(mD.warn("Did not find valid occurrence name for occurrence id: "+c),this.loggedPickIssue=!0);let t=null,i=null;const s=(0,XE.E)(e);if(s){if(i=this.uiElements[e],!i){this.loggedPickIssue||(mD.warn("Could not find ui element with name: "+e),this.loggedPickIssue=!0);continue}}else t=k._oC.getOccurrenceFromPathStringWithCheck(e);if(this.bodyManager.isBodyManagerOccurrence(t))for(h in d[c])g=d[c][h],o?this.bodyManager.updatePickData(g)&&u.push(g):r&&r.bodyPicks?r.bodyPicks.push(g):this.bodyManager.pickedOccurrenceId(g.primitiveId);else for(h in d[c]){if(g=d[c][h],s){if(g.uiSelection=i?.getSelection(g.occurrenceId,g.primitiveId),!g.uiSelection){this.loggedPickIssue||(mD.warn("Could not find owner of mouse pick"),this.loggedPickIssue=!0);continue}g.uiSelection.sourcePick=g}else{if(g.deterministicId=l.getDeterministicIdForPickId(t,g.primitiveId),!g.deterministicId){this.loggedPickIssue||(mD.warn("Did not find picked entity's deterministic id"),this.loggedPickIssue=!0);continue}const e=l.retrieveEntityMetaData(t,g.deterministicId);if(g.featureIdList=l.retrieveAssociatedFeatureIds(t,g.deterministicId),e)g.entityMetaData=e;else if(g.bodyMetaData=l.retrieveBodyMetaData(t,g.deterministicId),!g.bodyMetaData){this.loggedPickIssue||(mD.warn("Did not find picked deterministic id's metadata"),this.loggedPickIssue=!0);continue}g.occurrence=t}u.push(g)}}return this.mainDrawPass?.getDebugDrawPickPass().getEnabled()&&this.requestDraw(),u}retrieveVisiblePicks(e,t,i,s){if(!this.combinedPickPass)return mD.warn("Pick pass is not initialized"),null;this.combinedPickPass.setEnablePickViewportScaling(!1);const n=this.pickInRect(e,t,i,s);return this.combinedPickPass.setEnablePickViewportScaling(!0),n}getUiElements(){return this.uiElements}pickManyInRect(e,t,i,s,n,r,a){this.combinedPickPass?.setPickAlternatesEnabled(!0),this.renderContext.setBackFacePicking(n),r&&this.subtractEntitiesIntersectingBox(e,t,i,s);const o=this.pickManyInRectInternal(e,t,i,s,!0,a,void 0,!0);return this.renderContext.setBackFacePicking(!1),this.combinedPickPass?.setPickAlternatesEnabled(!1),this.resetIdsHiddenFromPick(),o}subtractEntitiesIntersectingBox(e,t,i,s){const n=this.getCamera();if(!n)return;const r=Math.max(e-1,0),a=Math.max(t-1,0),o=Math.min(t+s,n.getViewportHeight()-1),h=Math.min(e+i,n.getViewportWidth()-1);this.pickAllInBox(r,a,h-r,1),this.pickAllInBox(r,o,h-r,1),o-a>2&&(this.pickAllInBox(r,a+1,1,o-a-2),this.pickAllInBox(h,a+1,1,o-a-2))}pickAllInBox(e,t,i,s){this.pickManyInRectInternal(e,t,i,s,!0,void 0,void 0,!0)}performingBoxSelection(){return!!this.boxSelectionDeferred}performBoxSelection(e,t,i,s,n,r=!1){if(e=Math.floor(e),t=Math.floor(t),i=Math.floor(i),s=Math.floor(s),this.performingBoxSelection())return null;if(0===i||0===s)return null;if(r&&!(0,Me.cU)()&&!this.isEmptyBoxDeselectMode())return null;const a=(0,Me.Ac)().allowsBodies;(0,sI.l)().startBoxSelectionBeeper(),(0,Me.B8)(),this.combinedPickPass?.setPickAlternatesEnabled(!0),this.combinedPickPass?.setIsBoxSelecting(!0),this.renderContext.setBackFacePicking(!0),n&&this.subtractEntitiesIntersectingBox(e,t,i,s),this.boxSelectionDeferred=Jr.defer();const o=this.boxSelectionDeferred.promise;let h=!0;const c=this,l=function(){if(!c.performingBoxSelection())return;c.setUserIsManipulatingWithTimeout();const n=c.pickManyInRectInternal(e,t,i,s,h,void 0,15,!0,a,!0);h=!1,n.length>0?((0,Me.d)(n,r),(0,nM.xA)().trigger(os.f4Y,n),c.draw(),setTimeout(l,45)):((0,Me.mO)(r),c.stopBoxSelection())};return setTimeout(l,10),o}setSuppressNonIsolatedPicks(e){this.combinedPickPass?.setSuppressNonIsolatedPicks(e)}stopBoxSelection(){this.performingBoxSelection()&&(this.renderContext.setBackFacePicking(!1),this.combinedPickPass?.setIsBoxSelecting(!1),this.combinedPickPass?.setPickAlternatesEnabled(!1),this.resetIdsHiddenFromPick(),this.boxSelectionDeferred?.resolve(),this.boxSelectionDeferred=null,(0,sI.l)().stopBoxSelectionBeeper(),(0,Me.B8)(),this.processQueuedDisplayData(),this.doPreHighlightPick(!0),(0,nM.xA)().trigger(os.KB0))}canProcessDisplayData(){return this.haveUnitsBeenReceived&&!this.performingBoxSelection()}processQueuedDisplayData(e){if(e&&this.stopBoxSelection(),this.canProcessDisplayData()){for(let e=0;e<this.queuedDisplayData.length;++e){const t=this.queuedDisplayData[e];t.displayData instanceof k.hDL?this.onNewPartStudioDisplayData(t.displayData,t.selectionMapper):t.displayData instanceof k.F_7&&this.onRootAssemblyDisplayData(t.displayData)}this.queuedDisplayData=[]}}setUnitsReceived(e){this.haveUnitsBeenReceived=e,e&&this.processQueuedDisplayData()}isPickFromHiddenOccurrence(e){const t=this.occurrenceDataManager.getOccurrenceData(e.occurrenceId);return!!t&&t.getVisibility()===Xs.EE.HIDDEN}resetIdsHiddenFromPick(){this.occurrenceDataManager.resetHiddenFromPick(),(0,lD.X9)();const e=this.getModelViewManagers().getManager();for(let t=0;t<this.selectionsToKeepHiddenFromPick.length;++t){const i=this.selectionsToKeepHiddenFromPick[t],s=e.getEntityIdsForSelection(i),n=e.getOccurrenceIdForSelection(i),r=i.getOccurrence();if((0,TE.$J)(n))for(let t=0;s&&t<s.length;++t)e.hideEntityFromPick(s[t],n,r)}}setSelectionsToKeepHiddenFromPick(e){this.selectionsToKeepHiddenFromPick=e,this.resetIdsHiddenFromPick()}resetSelectionsToKeepHiddenFromPick(){this.setSelectionsToKeepHiddenFromPick([])}getClosestPointAtPixel(e,t,i){const s=2*i+1,n=2*i+1,r=e-i,a=t-i,o=this.findDepthsInRect(r,a,s,n);let h=null,c=1/0;for(let e=0;e<o.length;++e)if(o[e][2]!==Xs.BG){const t=o[e],i=t[2];i<c&&(h=t,c=i)}return h?(h[0]=e,h[1]=t,this.getCamera().canvasToWorld(h)):null}bodyListToPicks(e,t,i,s,n,r,a){const o=this.combinedPickPass.getUsage();for(const h of r)i.bodyEntitiesVistor(h,(r=>{const h=(0,Xs.ft)(i,n,r,s,o);return a.push(h),!(e&&(!t||t.doesBodyLevelSelectionPass(h.getModelSelection())))}))}collectPicksInsideFrustum(e,t,i,s,n){for(const r of s){const{occurrenceId:s,occurrence:a}=this.getBodyOccurrenceIndex(r),o=i.getPartStudioDataFromOccurrence(a);if(!o)continue;const h=this.getOccurrenceDataManager().getOccurrenceData(s);if(!h)continue;h.isHiddenFromPick=!0;const c=r.bodyMetaData.findAllLeafBodies(o);this.bodyListToPicks(e,t,o,s,a,c,n)}}pickManyInRectInternal(e,t,i,s,n=!0,r,a,o,h=(0,Me.Ac)().allowsBodies,c=!1){const l=[];let d=new mt.StringSet;const u=new mt.StringSet,g=(0,Xs.Wj)(),p=o?(0,Me.y_)():(0,Me.Nd)(),m=(0,j.as)(Ch,this.modelViewManagers.getManagerForUsage(Vs()));let f=n,I=0;do{const n={bodyOccurrencesInsidePickFrustumOut:new Array,cullOutsideOccurrencesForPicking:c},a=this.pickInRect(e,t,i,s,f,n);f=!1;const o=new mt.StringSet;this.collectPicksInsideFrustum(h,p,m,n.bodyOccurrencesInsidePickFrustumOut,l);for(let e=0;e<a.length;++e){const t=a[e];t.fromPass=I;let i=!0,s=t.getId();const n=t.getBodyId();if(n&&h){const e=n+Dn.ID_SEPARATOR+t.occurrenceId;u.contains(e)?i=!1:!p||p.doesBodyLevelSelectionPass(t.getModelSelection())?(m.hideBodyFromPick(n,t.occurrenceId,t.occurrence),u.add(e),s=e):this.hidePick(t,m)}else this.hidePick(t,m);if(d.contains(s))return mD.warn("The same pick was found twice, when it should have been hidden"),[];if(o.add(s),i&&l.push(t),r&&l.length>=r)break}if(0===a.length||r&&l.length>=r)break;d=o,++I}while(void 0===a||(0,Xs.Wj)()-g<a);return l}hidePick(e,t){e.isUIPick()?e.uiSelection.hideFromPick():!e.deterministicId&&e.isBodyPick()?this.bodyManager.hideBodyFromPick(e):t.hideEntityFromPick(e.getIncrementId(),e.occurrenceId,e.occurrence),(0,lD.Mi)(e.occurrenceId)}findDepthsInRect(e,t,i,s,n,r){return this.isReadyForDrawing()&&this.depthRetrievalPass?(this.pushCameraState(r),this.renderContext.setDetailSettings(this.detailManager.getInteractiveSettings()),this.bodyManager.updateForFrame(this.renderContext,!1),n=void 0===n||n,this.depthRetrievalPass.setPickRect(e,t,i,s),this.depthRetrievalPass.retrieve(this.renderContext,n),this.popCameraState(),this.depthRetrievalPass.points):[]}findDraftAngle(e,t,i,s,n){return s=s||1,n=n||1,this.isReadyForDrawing()&&this.draftAngleRetrievalPass&&this.mainDrawPass?(this.pushCameraState(),this.renderContext.setDetailSettings(this.detailManager.getInteractiveSettings()),this.bodyManager.updateForFrame(this.renderContext,!1),this.draftAngleRetrievalPass.setOccurrenceIds(this.mainDrawPass.draftAnalysisPass.getIdsToParts()),this.draftAngleRetrievalPass.setDirection(e),this.draftAngleRetrievalPass.setPickRect(t,i,s,n),this.draftAngleRetrievalPass.retrieve(this.renderContext),this.popCameraState(),this.draftAngleRetrievalPass.points):[]}findScalarVisualizationScalar(e,t,i,s,n,r){if(!this.isReadyForDrawing())return[];n=n||1,r=r||1;let a=this.scalarRetrievalPasses.find((t=>t.managerNodeId===e));a||(a=new _t(this,e),this.scalarRetrievalPasses.push(a),this.drawPasses.push(a)),this.pushCameraState(),this.renderContext.setDetailSettings(this.detailManager.getInteractiveSettings()),this.bodyManager.updateForFrame(this.renderContext,!1),a.setPickRect(i,s,n,r);const o=a.retrieve(this.renderContext,t);return this.popCameraState(),o}retrieveSelectionPosition(e){return this.retrieveCanvasLocationWorldPosition(e.getPickLocation())}retrieveCanvasLocationWorldPosition(e){if(!this.isReadyForDrawing()||!this.depthRetrievalPass)return null;const t=e;if(!t)return null;this.depthRetrievalPass.setRetrieveFromPreview(!1);const i=this.findDepthsInRect(t[0],t[1],1,1);return this.depthRetrievalPass.setRetrieveFromPreview(!0),i.length>0&&i[0][2]!==Xs.BG?this.getCamera().canvasToWorld(i[0]):null}retrieveDepthSampling(e){return this.isReadyForDrawing()&&this.depthSamplingPass?(this.pushCameraState(),this.renderContext.setDetailSettings(this.detailManager.getInteractiveSettings()),this.bodyManager.updateForFrame(this.renderContext,!1),this.depthSamplingPass.retrieve(this.renderContext,e),this.popCameraState(),this.depthSamplingPass.points):[]}retrieveHighlightsOnlyDepthSampling(){return this.isReadyForDrawing()&&this.depthSamplingPass?(this.pushCameraState(),this.renderContext.setDetailSettings(this.detailManager.getInteractiveSettings()),this.bodyManager.updateForFrame(this.renderContext,!1),this.depthSamplingPass.retrieve(this.renderContext,{useHighlightsOnly:!0}),this.popCameraState(),this.depthSamplingPass.points):[]}addUIElement(e){this.uiElements[e.getCollectionId()]=e}removeUIElement(e){delete this.uiElements[e.getCollectionId()],this.uiSelectionManager.removeSelectionForUiElement(e)}reportViewerMemoryMetrics(){if(this.viewerDestroyed)return void mD.info("Buffer memory metrics could not be captured as the viewer was destroyed.");const e=performance.now()-this.initializationTime;mD.info(`Buffer memory metrics: Viewer: Primary: sessionTime: ${rI.B.withElapsedTime(e)}, memory usage: ${this.getMemoryGauge().getUsageDetailsAsString()}`),this.modelViewManagers.getManager().getMeshManager().reportMeshManagerMemoryMetrics("ModelViewManager",e),this.getBodyManager().getMeshManager().reportMeshManagerMemoryMetrics("BodyManager",e),this.getUiResourceManager().getMeshManager().reportMeshManagerMemoryMetrics("UiResourceManager",e)}makeBufferSetSceneDebugObject(){const e=[];return e.push(...this.modelViewManagers.getManager().getMeshManager().getBufferSetSceneDebugObjects()),e.push(...this.getBodyManager().getMeshManager().getBufferSetSceneDebugObjects()),e.push(...this.getUiResourceManager().getMeshManager().getBufferSetSceneDebugObjects()),e.sort(((e,t)=>{const i=e.text.match(/\d+/),s=t.text.match(/\d+/);return(i?parseInt(i[0],10):0)-(s?parseInt(s[0],10):0)})),{text:"BufferSets",children:e}}onBeforeUnload(){this.getIsPrimaryViewer()&&this.reportViewerMemoryMetrics()}destroy(){if(this.viewerDestroyed)return;this.selectOtherView&&this.selectOtherView.destroy(),this.areSectionPlanesEnabled()&&(0,lD.UB)(!1),(0,Yd.G0)(),this.stopBoxSelection();const e=this.uiElements;this.uiElements={};for(const t in e)e[t]&&e[t].remove();this.referenceHighlights.destroy(),this.resetHighlightManagers(),this.getEventDispatcher()&&this.getEventDispatcher().trigger(nM.so),this.sceneGraphs.destroySceneGraphs(),this.cleanUpOrphanedObjects(),this.getOccurrenceIdManager().reset(),Za(),this.el.removeEventListener("webglcontextlost",this.handleContextLoss,!1),this.el.removeEventListener("webglcontextrestored",this.handleContextRestored,!1),this.el.width=0,this.el.height=0,this.renderContext.destroy(),this.bodyManager.destroy(),mE(),(0,Xs.Dz)(this.getViewerId()),this.resetPickPassCount(),(0,ea.Z)(this.recordCapabilitiesTimeout)&&(clearTimeout(this.recordCapabilitiesTimeout),this.recordCapabilitiesTimeout=null),(0,ea.Z)(this.drawTimer)&&(clearTimeout(this.drawTimer),this.drawTimer=null),this.remove(),this.$el.off(),this.elementUnitChangedSubscription.unsubscribe(),this.modelViewManagers.clearTheManagers(),this.sceneGraphs.destroySceneGraphs(),this.occurrenceDataManager.destroy(),this.isolatedOccurrenceManager?.destroy(),this.edgePointController&&this.edgePointController.disable(),this.inputHandler&&this.inputHandler.remove(),this.themeChangeSubscription?.unsubscribe(),this.latestDisplayDataUsageSubscription?.unsubscribe(),this.printCanvas&&this.onAfterPrint(),this===(0,Sh.uQ)()&&(0,Sh.e$)(null),this===(0,Sh.N9)()&&(0,Sh.KO)(null),document.removeEventListener("visibilitychange",this.browserTabVisibilityHandler),(0,j.clearObject)(this),this.viewerDestroyed=!0}setBaseHighlightsEnabled(e){this.renderContext.setBaseHighlightsEnabled(e)}visualizeInferenceSceneGraph(e){this.mainDrawPass&&(this.mainDrawPass.visualizeInferenceSceneGraph(e),this.requestDraw())}getCanvasCoordinateFromEvent(e){if(!e)return[0,0];const t=this.el.getBoundingClientRect(),i=(0,ns.x_)();return[(e.pageX-t.left)*i,(e.pageY-t.top)*i]}getPageCoordinateFromCanvasXY(e,t){const i=(0,ns.x_)(),s=this.el.getBoundingClientRect();return[e/i+s.left,t/i+s.top]}zoomFit(e){this.resetZoomToSelectionBounds(),this.getPrimaryViewController()?.zoomFit(this.getFitBounds(),e)}rotateInDirection(e,t){t===os.Vf$.COARSE?this.rotateInDirectionWithAngle(e,(0,wi.Yr)(X.default.getManager().getNumber("COARSE_ROTATE_ANGLE"))):t===os.Vf$.FINE?this.rotateInDirectionWithAngle(e,(0,wi.Yr)(X.default.getManager().getNumber("PRECISION_ROTATE_ANGLE"))):this.rotateInDirectionWithAngle(e,(0,wi.Yr)(X.default.getManager().getNumber("ROTATE_ANGLE")))}rotateInDirectionWithAngle(e,t){this.resetZoomToSelectionBounds(),this.getPrimaryViewController()?.rotateInDirection(e,t)}animateToStandardView(e){this.resetZoomToSelectionBounds(),this.getPrimaryViewController()?.animateToStandardView(e,this.getFitBounds(sr[e]))}animateToStandardViewIgnoringUIPanels(e,t){this.resetZoomToSelectionBounds(),this.getPrimaryViewController()?.animateToStandardViewIgnoringUIPanels(e,this.getFitBounds(sr[e]),t)}animateZoomFit(e){e?this.zoomToSelectionBounds=e:this.resetZoomToSelectionBounds(),this.getPrimaryViewController()?.animateZoomToFit(e||this.getFitBounds())}resetZoomToSelectionBounds(){this.zoomToSelectionBounds=null}animateZoomToRectangle(e,t,i,s){const n=this.getCamera();if(!n)return;const r=[e,t,0],a=n.canvasToWorld(r),o=[e+i,t+s,0],h=n.canvasToWorld(o),c=new wi.kB;c.addPoint(a),c.addPoint(h),this.animateZoomFit(c)}animateTo(e){this.resetZoomToSelectionBounds(),this.animateToWithBounds(e,this.getFitBounds(e))}animateToWithBounds(e,t){this.getPrimaryViewController()?.animateToFrameWithZoomFit(e,t,CD.getNumber("CAMERA_LONG_ANIMATION_TIME_MS"))}animateRotation(e,t,i){this.getPrimaryViewController()?.animateRotation(e,t,CD.getNumber("CAMERA_LONG_ANIMATION_TIME_MS"),i)}setWaitingForDisplayData(){this.elementLoadState=yD.WAITING_FOR_DISPLAY_DATA,this.waitingForDisplayDataTimer=new Ih.B7("Waiting for display data",LD())}setWaitingForCompareDisplayData(){this.elementLoadState=yD.WAITING_FOR_COMPARE_DISPLAY_DATA}stopWaitingForCompareDisplayData(){if(this.elementLoadState===yD.WAITING_FOR_COMPARE_DISPLAY_DATA){const e=!1;this.setGraphicsLoading(e,0)}this.elementLoadState===yD.WAITING_FOR_DISPLAY_DATA&&(this.shouldWaitForCompareDisplayData=!1)}setGraphicsLoading(e,t){this.waitingForDisplayDataTimer?.report(),this.waitingForDisplayDataTimer=null,this.loadingDisplayDataTimer=new Ih.B7("Loading display data on client",LD()),this.elementLoadState=yD.LOADING_DISPLAY_DATA,this.getEventDispatcher().trigger(nM.Wp,this.activeElementId,e,t),this.shouldWaitForCompareDisplayData=!0,this.requestDrawForInteractiveProcessing()}onNewPartStudioDisplayData(e,t){if(this.getIsPrimaryViewer()&&e.isReadyForMetricsReporting()&&(this.eventDispatcher.trigger(os.pFt,os.$_3,e.deserializeDurationInMillis,e.fromDisplayCache,e._serializedByteLength,e.elementId),e.resetTimes()),!this.canProcessDisplayData())return void this.queuedDisplayData.push({displayData:e,selectionMapper:t});const i=new Ih.B7("Viewer.onNewPartStudioDisplayData",{setTraceId:!0}),s=this.activeElementId===e.elementId||this.activeElementId===e.forCachedElement,n=this.elementLoadState===yD.WAITING_FOR_DISPLAY_DATA,r=this.elementLoadState===yD.WAITING_FOR_COMPARE_DISPLAY_DATA;let a=!1;if(!s)return void mD.info("Received display data for inactive element: "+e.elementId);if(Hs()){const t=e.usage===k.rvN.BASE,i=e.usage===k.rvN.COMPARE_TARGET;if(n&&t)this.shouldWaitForCompareDisplayData?this.setWaitingForCompareDisplayData():a=!0;else if(r&&i)a=!0;else if(n&&i)return}else n&&(a=!0);if(a){const t=e.microversionIdAndConfigurationInterval.hasFromMicroversion()&&e.microversionIdAndConfigurationInterval.isEmptyInterval();this.setGraphicsLoading(e.fromDisplayCache||t,e.fromDisplayCache||t?100:0)}const o=this.isForFlattenedDisplay&&this.viewInitialized&&!this.isHidden();let h=!1;if(o){const e=this.getModelBounds({doNotBoundTemporarySketchEntities:!0});h=!e.isInitialized()||this.getCamera().doBoundsFitInViewport(e)}if(this.queuedBaseData&&this.queuedBaseData.elementId===e.elementId&&(this.queuedBaseData.incremental||this.modelViewManagers.resetPreviewManager(),t=this.selectionMapperForQueuedBase,this.modelViewManagers.getManager().processPartStudioDisplayData(this.queuedBaseData,t),this.queuedBaseData=null,this.selectionMapperForQueuedBase=null),e.usage===k.rvN.PREVIEW_BEFORE)return this.queuedBaseData=e,void(this.selectionMapperForQueuedBase=t);let c=this.modelViewManagers.getManager();switch(e.usage){case k.rvN.PREVIEW_AFTER:case k.rvN.PREVIEW_FINAL:case k.rvN.COMPARE_TARGET:c=this.modelViewManagers.getPreviewManager(e)}const l=gi._3.activeFeatureControllerIsSketch(),d=e.usage===k.rvN.PREVIEW_FINAL&&!l;this.setSuppressModelSelection(d),this.setBaseHighlightsEnabled(!d),this.isForPreviousVersionDisplay&&this.setSuppressModelSelection(!0),this.mainDrawPass&&this.mainDrawPass.updateHideInteriorSelections(),this.getSupportsPreview()&&(Ls().latestDisplayDataUsage=e.usage);const u=c.processPartStudioDisplayData(e,t);e.usage!==k.rvN.BASE?(this.bodyLoadTasks.completeTasks(),this.getIsForFlattenedDisplay()||this.bodyManager.initiateAutomaticRetrieval(!u)):(this.bodyLoadTask.performInitialLoad(),this.bodyLoadTask.hasPendingWork()||this.getIsForFlattenedDisplay()||this.bodyManager.initiateAutomaticRetrieval(!u)),this.setUserIsManipulatingWithTimeout(),e.usage===k.rvN.BASE&&(this.performBodyCheck=!0),this.requestDrawForInteractiveProcessing(),this.detailManager.updateFromLoadedScene(),o&&h&&this.getModelBounds().isInitialized()&&this.animateZoomFit(),i.report()}onNewInsertableDisplayData(e){this.getModelViewManagers().getManager().processReceivedInsertableDisplayData(e)}onRootAssemblyDisplayData(e,t,i){if(!this.getIsForFlattenedDisplay()&&e.isReadyForMetricsReporting()&&(this.eventDispatcher.trigger(os.pFt,os.uvd,e.deserializeDurationInMillis,e.fromDisplayCache,e._serializedByteLength,e.elementId),e.resetTimes()),!this.canProcessDisplayData())return void this.queuedDisplayData.push({displayData:e,selectionMapper:null});if(!(this.activeElementId===e.elementId||t&&this.activeElementId===t.elementId))return void mD.info("Received display data for inactive element: "+e.elementId);if(this.elementLoadState===yD.WAITING_FOR_DISPLAY_DATA&&this.activeElementId===e.elementId&&!i){const t=e.fromDisplayCache?100:e.getPartstudioDisplayDataNoopPercent();this.setGraphicsLoading(e.fromDisplayCache,t)}const s=this.bodyLoadTask.hasPendingWork();this.modelViewManagers.getManager().processRootAssemblyDisplayData(e,t),!s&&this.bodyLoadTask.hasPendingWork()&&this.bodyLoadTask.performInitialLoad(),e.isCollapsible&&this.setUserIsManipulatingWithTimeout(),this.detailManager.updateFromLoadedScene()}updateGraphicsData(e){if(e.renderingMode!==this.getRenderingMode()&&this.setRenderingMode(e.renderingMode),e.smoothEdgeStyle!==this.getSmoothEdgesRenderStyle()&&this.setSmoothEdgesRenderStyle(e.smoothEdgeStyle),e.zebraStripeCount!==this.getZebraStripeCount()&&this.setZebraStripeCount(e.zebraStripeCount),e.zebraStripeRotation!==this.getZebraStripeRotation()&&this.setZebraStripeRotation(e.zebraStripeRotation),e.zebraStripeEdgesOn!==this.getZebraStripeEdgesOn()&&this.setZebraStripeEdgesOn(e.zebraStripeEdgesOn),e.isBoundaryEdgeHighlightOn){const e=this.setFilteredEntitiesHighlightController(this.createFilteredEntitiesHighlightController(os.i8U));e?.enable()}else{const e=this.getFilteredEntitiesHighlightController();e&&(e.disable(),this.setFilteredEntitiesHighlightController(null))}}destroyPreviewGraphics(){aD.L.resetPartListToBase(this.activeElementId),this.modelViewManagers.resetPreviewManager(),Fs(),this.mainDrawPass&&this.mainDrawPass.setHideSelectionInterior(!1),this.requestDraw()}setForceHideInteriorSelections(e){this.mainDrawPass?.setForceHideInteriorSelections(e)}updateLastMouseLocation(e){this.lastMouseLocation=this.getCanvasCoordinateFromEvent(e)}resetLastMouseLocation(){this.lastMouseLocation=[-1,-1]}raycast(e,t,i,s){let n=-1,r=null;const a=M.create(),o=this.getCamera().getRay(e,t);let h=ue.create();s&&(o.point=ge.w$.multiplyVec3(s,o.point,M.create()),o.direction=M.clone(ge.w$.multiplyVec3(s,M.fromValues(o.direction[0],o.direction[1],o.direction[2]),M.create())),h=ge.w$.inverse(s));const c=i.points,l=i.indices,d=function(e){return e*=3,M.fromValues(c[e],c[e+1],c[e+2])},u=Ri.W.ZERO_LENGTH,g=this.getCamera(),p=Q.fromValues(e,t),m=M.create(),f=M.create(),I=M.create(),E=M.create(),S=M.create();for(let e=0;e<l.length-2;e++){if(l[e+2]===l[e+1]||l[e+1]===l[e]||l[e]===l[e+2])continue;const t=[d(l[e]),d(l[e+1]),d(l[e+2])];ge.S4.subtract(t[1],t[0],f),ge.S4.subtract(t[2],t[0],I),ge.S4.cross(o.direction,I,E);const i=M.dot(E,f);if(Math.abs(i)<u)continue;const s=1/i;ge.S4.subtract(o.point,t[0],m);const c=M.dot(m,E)*s;if(c<0||c>1)continue;ge.S4.cross(m,f,S);const T=M.dot(o.direction,S)*s;if(T<0||c+T>1)continue;const D=M.dot(I,S)*s;if(!(D<u)&&(n<0||n>D)){n=D,r=null;for(let e=0;e<3;e++)if(ge.gv.dist(g.projectWorldPointToCanvas(ge.w$.multiplyVec3(h,t[e],M.create())),p)<12){r=t[e],ge.S4.cross(f,I,a);break}}}return new Me.O5(r,a)}doPick(e,t,i,s,n){const r=Bs()&&!this.modelViewManagers.getPreviewManager();if(this.performingBoxSelection()||r)return!1;(n=n||{}).mouseX=e,n.mouseY=t,n.camera=this.getCamera(),n.click&&(this.getEventDispatcher().trigger(nM.rw),this.getEventDispatcher().trigger(nM.AD));const a=(0,Xs.Wj)(),o=this.pick(e,t,n);let h=!1;for(let e=0;e<o.length&&!h;++e){const t=o[e],r=t.getModelSelection();if(r&&!this.suppressModelSelection)h=(0,Me.rQ)(r,i,s,n),h&&(i&&t.isUIPick()?this.uiSelectionManager.processUiPick(t,n):this.uiSelectionManager.handleEmptyUiPick(i,n));else if(t.isUIPick()&&(t.uiSelection.isInteractionEnabled()&&n.click&&this.getEventDispatcher().trigger(nM.fu),h=this.uiSelectionManager.processUiPick(t,n),h&&!this.suppressModelSelection)){const e=t.getUISelection();e&&!e.getClearModelSelectionsOnPrehilite()||(0,Me.Zs)(i,!0,n)}}h||(this.suppressModelSelection||(0,Me.Zs)(i,!1,n),this.uiSelectionManager.handleEmptyUiPick(i,n)),h&&i&&this.setUserIsManipulatingWithTimeout();const c=(0,Xs.Wj)()-a;return this.averagePickDuration<0?this.averagePickDuration=c:this.averagePickDuration=.8*this.averagePickDuration+.2*c,h}doPreHighlightPick(e){this.doPick(this.lastMouseLocation[0],this.lastMouseLocation[1],!0,!0,{skipPreHighlight:e,shiftKey:this.inputHandler?.getAltHeld()})}onDoubleClick(e,t,i){const s={};s.mouseX=e,s.mouseY=t,s.camera=this.getCamera(),s.doubleClick=!0,s.altKey=i.altKey;const n=this.pick(e,t,s);let r=!1;for(let e=0;e<n.length&&!r;++e){const t=n[e];t.isUIPick()&&(r=this.uiSelectionManager.processUiPick(t,s))}return r}getAveragePickDuration(){return Math.max(0,this.averagePickDuration)}setSuppressModelSelection(e){this.suppressModelSelection=e,this.suppressModelSelection&&this.stopBoxSelection()}getSuppressModelSelection(){return this.suppressModelSelection}getCameraPropertiesForElement(e){let t=null;const i={graphicsElementId:e=e||"",isValid:!1,projectionType:"",viewMatrix:ue.create(),projectionMatrix:ue.create(),verticalFieldOfView:0,viewportHeight:0,viewportWidth:0};if(this.elementToPerElementState&&this.elementToPerElementState.hasOwnProperty(e)){const s=this.elementToPerElementState[e];s&&(t=s.camera,t&&(i.isValid=!0,t.isOrthographic()?i.projectionType="orthographic":t.isPerspective()&&(i.projectionType="perspective"),i.viewMatrix=t.getViewMatrix(),i.projectionMatrix=t.getProjectionMatrix(),i.verticalFieldOfView=t.getFieldOfView(),i.viewportHeight=t.getViewportHeight(),i.viewportWidth=t.getViewportWidth()))}return i}closeSelectOtherView(){this.selectOtherView.close()}resetActiveElement(){this.modelViewManagers.getManager().resetDisplayedElement()}setActiveElement(e,t,i,s,n){if(e||n||!this.getIsPrimaryViewer()||this.viewerDestroyed||this.reportViewerMemoryMetrics(),!this.selectOtherView){const e={viewer:this};this.selectOtherView=new oD.Q(e)}if(this.selectOtherView.setActiveElement(s,n),e===this.activeElementId)return;if(this.loadTimer=new Ih.B7("Time from element switch to graphics display",LD()),Hs()||this.destroyPreviewGraphics(),Us()&&!i&&La(this,70,40),this.activeElementId&&this.elementToPerElementState&&this.viewInitialized){const e=this.getCamera();if(e){let t=this.elementToPerElementState[this.activeElementId];t||(t=this.elementToPerElementState[this.activeElementId]=new MD(this.activeElementId)),t.camera=e.clone(),t.renderingMode=this.renderingMode,t.smoothEdgeStyle=this.smoothEdgeStyle,t.activeFilteredEntitiesHighlightController=this.filteredEntitiesHighlightController,t.userEnabledAggressiveRefinement=this.bodyManager.getUserEnabledAggressiveRefinement(),t.activeFilteredEntitiesHighlightController&&t.activeFilteredEntitiesHighlightController.disable(),this.getIsPrimaryViewer()&&(t.sectionViewState=(0,lD.o_)(this.activeElementId))}}let r=!1;s&&(r=s.getIsPublicationItem()),this.modelViewManagers.getManager().onChangeActiveElement(e,t,r),this.draw(),this.activeElementId=e||"";const a=t===k.GNh.PARTSTUDIO||t===k.GNh.ASSEMBLY,o=this.elementToPerElementState[this.activeElementId];if(a&&o){const e=o.camera;if(e&&(this.viewController?.isPerspective()!==e.isPerspective()&&(this.viewController?.isPerspective()?this.viewController=new hr(this):this.viewController=new or(this)),e.setViewportFromCanvasElement(this.$el),this.getCamera()?.copyFrom(e)),this.setZebraStripeEdgesOn(o.zebraStripeEdgesOn),this.setRenderingMode(o.renderingMode),t!==k.GNh.PARTSTUDIO&&t!==k.GNh.ASSEMBLY||this.setSmoothEdgesRenderStyle(o.smoothEdgeStyle),t===k.GNh.PARTSTUDIO&&o.activeFilteredEntitiesHighlightController){const e=this.setFilteredEntitiesHighlightController(o.activeFilteredEntitiesHighlightController);e?.enable()}else this.disableCurrentLaminarHighlightController();this.getIsPrimaryViewer()&&(0,lD.Wh)(o.sectionViewState,this.activeElementId),this.bodyManager.setUserEnabledAggressiveRefinement(o.userEnabledAggressiveRefinement),"number"==typeof o.zebraStripeCount&&this.setZebraStripeCount(o.zebraStripeCount),"number"==typeof o.zebraStripeRotation&&this.setZebraStripeRotation(o.zebraStripeRotation),this.viewInitialized=!0}else this.viewController&&this.resetViewState();this.setWaitingForDisplayData(),this.readyToUpdateElementLoadState=!1,this.receivedFeatureData=!1,this.receivedAssemblyDefinition=!1,this.averagePickDuration=-1,this.frameTimer.resetTimings(),this.detailManager.onSettingStateChange(),this.uiSelectionManager.reset(),this.bodyManager.resetOccurrenceRetrieval(),mE(),this.resetLastMouseLocation(),this.setReadyState(!1);let h=ts.UNSUPPORTED;t===k.GNh.PARTSTUDIO?h=ts.PART_STUDIO:t===k.GNh.ASSEMBLY?h=ts.ASSEMBLY:this.hideWebGLContextLostMessage(),(0,nM.xA)().trigger(nM.Fc,h)}resetViewState(){this.initializedForDrawing&&(this.viewInitialized=!1,this.viewController?.isPerspective()&&(this.viewController=this.viewController.getMatchingOrthographicController()),this.viewController?.setStandardView(this.getDefaultStandardView()),es.Jq.UserSettingsService.getUserSettings().then((e=>{if(this.viewerPreferences.isolateHideTransparent="true"===e.isolateHideTransparent,this.viewerPreferences.renderingMode=Number(e.graphicsRenderMode),this.viewerPreferences.smoothEdge=Number(e.graphicsSmoothEdge),this.viewerPreferences.highlightLaminarEdges="true"===e.highlightLaminarEdges,this.viewerPreferences.perspectiveModeOn="true"===e.perspectiveModeOn,this.viewerPreferences.isolateEnableSelectionDesire=e.isolateEnableSelectionDesire,this.viewerPreferences.isolateOpacitySliderValue=e.isolateOpacitySliderValue,this.viewerPreferences.makeTransparentEnableSelectionDesire=e.makeTransparentEnableSelectionDesire,this.viewerPreferences.makeTransparentOpacitySliderValue=e.makeTransparentOpacitySliderValue,this.setSmoothEdgesRenderStyle(Number(e.graphicsSmoothEdge)),this.setRenderingMode(Number(e.graphicsRenderMode)),"true"===e.highlightLaminarEdges){const e=this.setFilteredEntitiesHighlightController(new Iy(this,os.i8U));e?.enable()}else this.setFilteredEntitiesHighlightController(null);if("true"===e.perspectiveModeOn){const e=this.getCamera();e?.setSceneBounds(this.getSceneBounds());const t=this.getPrimaryViewController();this.setPrimaryViewController(t.getMatchingPerspectiveController())}})),this.filteredEntitiesHighlightController&&this.filteredEntitiesHighlightController.disable(),this.bodyManager.setUserEnabledAggressiveRefinement(!1),this.debugShowSilhouetteEdgesOnNonVisibleTangentEdgeStyle=!1,this.mainDrawPass?.setZebraStripeCount(CD.getNumber("ZEBRA_STRIPE_COUNT")),this.mainDrawPass?.setZebraStripeRotation(CD.getNumber("ZEBRA_STRIPE_ROTATION")))}getViewerPreferences(){return this.viewerPreferences}updateCanvasVisibility(){this.readyState&&!this.hidden?(this.$el.show(),this.viewManipulator&&this.viewManipulator.show()):(this.$el.hide(),this.viewManipulator&&this.viewManipulator.hide())}setReadyState(e){this.readyState=e,e?this.storedCameraState&&(this.updateCamera(this.storedCameraState),this.storedCameraState=null):this===(0,Sh.N9)()&&(0,Sh.KO)(null),this.updateCanvasVisibility()}isHidden(){return this.hidden}hide(){this.hidden=!0,this.updateCanvasVisibility()}show(){this.hidden=!1,this.gl||this.setupGlContext(),this.updateCanvasVisibility(),this.modelViewManagers.getManager().onViewerShown()}setSelectionCountCursor(e){this.selectionCursor=e,0===this.cursorStack.length&&this.$el.css({cursor:e})}pushCursor(e){this.$el.css({cursor:e}),this.cursorStack.push(e)}peekCursor(){return this.cursorStack&&this.cursorStack.length>0?this.cursorStack[this.cursorStack.length-1]:null}popCursor(){0!==this.cursorStack.length?(this.cursorStack.pop(),this.cursorStack.length>0?this.$el.css({cursor:this.cursorStack[this.cursorStack.length-1]}):this.$el.css({cursor:this.selectionCursor})):mD.warn("Tried to pop a cursor off an empty stack in the graphics viewer")}removeTopOccurrenceOfCursor(e,t){if(0===this.cursorStack.length&&!t)return void mD.warn("Tried to remove a cursor from an empty stack in the graphics viewer");const i=(0,pi.findLastIndex)(this.cursorStack,(function(t){return t===e}));i<0?t||mD.warn("Tried to remove a cursor not present on stack in graphics viewer"):i===this.cursorStack.length-1?this.popCursor():this.cursorStack.splice(i,1)}onBeforePrint(){const e=this.getCamera()?.getViewport();if(!e)return;this.printCanvas||(this.printToCanvas(e[2],e[3],e[2],e[3]),pD(this.printCanvas).css({width:"100%"}));const t=pD("body");t.addClass("printing"),t.append(this.printCanvas)}onAfterPrint(){pD(this.printCanvas).remove(),this.printCanvas=null,pD("body").removeClass("printing")}printToCanvas(e,t,i,s,n){if(!this.isReadyForDrawing())return;this.viewManipulator&&this.viewManipulator.hide();const r=this.getCamera();if(!r)return;const a=r.clone();let o=null;n&&(o={previousOverride:(0,ns.AO)()},(0,ns.Lt)(n));const h=r.getViewportWidth(),c=r.getViewportHeight(),l=e/i,d=i*l,u=s*l,g=h*l,p=c*l,m=(h-i)/2*l,f=(c-s)/2*l;a?.setViewport([0,0,g,p]);const I=d,E=u,S=1024,T=1024,D=1042,C=1042,M=this.el.width,y=this.el.height;this.el.width=Math.max(D,M),this.el.height=Math.max(C,y),a?.setCanvasDimensions(this.el.width,this.el.height);const A=Math.ceil(I/S),P=Math.ceil(E/T);this.printCanvas=document.createElement("canvas"),this.printCanvas.id="print-canvas",this.printCanvas.width=I,this.printCanvas.height=E;const O=this.printCanvas.getContext("2d"),R=new Uint8Array(4343056),w=O.createImageData(S,T),v=this.getGlContext(),_=[0,0,D,C];this.frameTimer.resetInteractionStatus();for(let e=0;e<P;++e)for(let t=0;t<A;++t){_[0]=m+t*S-9,_[1]=f+e*T-9,a?.setTileViewport(_);const i=null;this.draw(i,{forPrint:!0,camera:a}),v.readPixels(0,0,D,C,v.RGBA,v.UNSIGNED_BYTE,R);for(let e=0;e<T;++e)for(let t=0;t<S;++t){const i=4*((T-e-1)*S+t),s=4*((e+9)*D+t+9),n=1/(R[s+3]/255);w.data[i]=R[s]*n,w.data[i+1]=R[s+1]*n,w.data[i+2]=R[s+2]*n,w.data[i+3]=R[s+3]}O?.putImageData(w,t*S,e*T)}this.el.width=M,this.el.height=y,this.viewManipulator&&this.viewManipulator.show(),o&&(o.previousOverride?(0,ns.Lt)(o.previousOverride):(0,ns.eu)()),this.draw()}createPrintView(e,t,i,s,n,r,a){const o=11800;if(!this.mainDrawPass)return;const h=this.mainDrawPass.getClearColor();this.mainDrawPass.setClearColor(0,0,0,0);let c=null;if(a){c=a*o/CD.getNumber("DEFAULT_LINE_WIDTH")}this.printToCanvas(e*o,t*o,s,n,c),pD(this.printCanvas).css({width:100*e+"cm",height:100*t+"cm"}),r?this.printCanvas?.toBlob((e=>{(0,aI.G)(e,i+".png"),this.onAfterPrint()})):window.print(),this.mainDrawPass.setClearColor(h[0],h[1],h[2],h[3])}getEntityCanvasLocation(e){const t=this.modelViewManagers.getManager().extractMeshIncrement(e);if(t&&t.points&&t.points.length>=3){const e=[t.points[0],t.points[1],t.points[2]];return this.getCamera()?.projectWorldPointToCanvas(e)}return null}triggerContextLoss(e){const t=this.getExtension("WEBGL_lose_context");t?(t.loseContext(),setTimeout((function(){t.restoreContext()}),e||500)):alert("This system does not support the context loss extension")}toggleDebugDrawPickPass(){const e=this.mainDrawPass?.getDebugDrawPickPass();e?.setEnabled(!e?.getEnabled())}isMouseInsideViewManipulator(){return!!this.viewManipulator&&this.viewManipulator.isMouseInside()}setCanEdit(e){this.canEdit=e}getCanEdit(){return this.canEdit}completeTasks(){this.taskManager.complete(),this.draw()}getSelectionFitBounds(e){if(!e)return null;const t=this.getModelViewManagers().getManagerForUsage(e.getUsage());if(!t)return null;const i=t.getSelectionFitBounds(e);if(!this.getIsForFlattenedDisplay()||!i)return i;const s=(0,j.as)(kg,t.getDisplayedElement());if(!s)return i;const n=s.getSheetMetalTransform(e,this);return i.createTransformedCopy(n)}retrieveViewportAsImage(e){const t=e.width,i=e.height,s=this.getCamera();if(!s)return null;const n=s.clone();s.setViewport([0,0,t,i]),s.setCanvasDimensions(t,i);let r=this.getFitBounds();e.zoomToSelection&&(r=new wi.kB,(0,Me.vi)().each((e=>{r.addBox(this.getSelectionFitBounds(e))})),r.isFinite()&&r.isExtensive()||mD.warn("zoomToSelection was requested in retrieveZoomedFitViewport but a valid bounds was not found")),(0,lD.jf)(!0),void 0===e.zoomToFit&&(e.zoomToFit=!0),e.zoomToFit&&this.getPrimaryViewController().zoomFitWithoutPanels(r),!e.showViewCube&&this.viewManipulator&&this.viewManipulator.hide(),e.useInteractiveSettings?this.frameTimer.setUserIsAdjustingCamera():this.frameTimer.resetInteractionStatus(),this.mainDrawPass?.setClearColor(1,1,1,1),this.draw();const a=new Uint8Array(t*i*4),o=this.getGlContext();return o&&o.readPixels(0,0,t,i,o.RGBA,o.UNSIGNED_BYTE,a),(0,Xs.Dy)(a,t,i),this.getCamera()?.copyFrom(n),this.mainDrawPass?.setClearColor(0,0,0,0),!e.showViewCube&&this.viewManipulator&&this.viewManipulator.show(),(0,lD.jf)(!1),{width:t,height:i,data:a}}retrievePrintedCanvasPixels(e){const t=this.createPrintOfCanvas(e.width,e.height,ID,ED,!0),i=this.printCanvas?.getContext("2d"),s=i?.getImageData(0,0,ID,ED);return this.removePrintOfCanvas(t),{width:ID,height:ED,data:s.data}}printToCanvasRenderingContext(e,t,i,s,n){const r=(0,ns.x_)(),a=r*i,o=r*s;this.getEventDispatcher().trigger(nM.m2);const h=this.createPrintOfCanvas(a,o,a,o);this.getEventDispatcher().trigger(nM.nh),n.drawImage(this.printCanvas,e,t,i,s),this.removePrintOfCanvas(h)}createPrintOfCanvas(e,t,i,s,n){const r=this.getCamera();if(!r)return null;const a=r.clone();return r.setViewport([0,0,e,t]),n&&this.getPrimaryViewController()?.zoomFitWithoutPanels(this.getFitBounds()),this.printToCanvas(i,s,e,t),a}removePrintOfCanvas(e){pD(this.printCanvas)?.remove(),this.getCamera()?.copyFrom(e)}getViewData(e,t){const i=new k.Lf5,s=this.getCamera();let n=s.getFrame();if(e){const t=this.modelViewManagers.getManager().getOccurrenceTransform(e);if(t){const e=ge.w$.inverse(t,ue.create());n=ge.w$.multiply(e,n,ue.create())}}i.viewMatrix=n,i.isPerspective=s.isPerspective();const r=s;r.top&&r.bottom&&r.right&&r.left?i.cameraViewport=[r.top,r.bottom,r.right,r.left]:i.cameraViewport=[0,0,0,0];const a=s;a.angle?i.angle=a.angle:i.angle=0;const o=function(e){const t=new k.d0F;return t.x=e[0],t.y=e[1],t.z=e[2],t},h=[];return(0,lD.nL)().forEach((function(e){const t=new k.cB6;t.center=o(e.center),t.tangent=o(e.tangent),t.normal=o(e.normal),h.push(t)})),i.sectionPlaneParameters=h,t||(i.sectionViewData=(0,lD.p$)()),i}getViewDataWithPersistentSectionedItemQueries(e){return(0,lD.bm)().then((e=>{const t=this.getViewData(null,!0);return t.sectionViewData=e,t}))}animateToView(e,t){const i=this.getCameraForViewData(e,t);this.prepareViewControllerForNewCamera(e.isPerspective);const s=X.default.getManager(),n=this.getPrimaryViewController();n?.animateToCustomView(i,s.getNumber("CAMERA_LONG_ANIMATION_TIME_MS"),e.name)}prepareViewControllerForNewCamera(e){const t=this.getPrimaryViewController();e?t?.isOrthographic()&&this.setPrimaryViewController(t.getMatchingPerspectiveController()):t?.isPerspective()&&this.setPrimaryViewController(t.getMatchingOrthographicController())}getCameraForViewData(e,t){const i=this.getCamera();i.setSceneBounds(this.getSceneBounds());let s=e.viewMatrix;const n=e.cameraViewport,r=e.angle;if(t){const e=k._oC.getOccurrenceFromPathString(t),i=this.modelViewManagers.getManager().getOccurrenceTransform(e);i&&(s=ge.w$.multiply(i,s,ue.create()))}let a;return e.isPerspective?(a=i.getPerspectiveCamera(),a.angle=r):(a=i.getOrthographicCamera(),a.top=n[0],a.bottom=n[1],a.right=n[2],a.left=n[3],a.correctAspectRatio()),a.setFrame(s),a}animateIsolation(e,t){const i=X.default.getManager().getNumber("ISOLATE_CONTEXT_TRANSITION_TIME_MS"),s=(0,Xs.Wj)();this.animationController.startAnimation((n=>{const r=(0,Xs.Es)(s),a=Math.min((0,wi.CW)(0,1,r/i),1);let o=os.ZK6.ONGOING;return a>=1&&(o=os.ZK6.COMPLETE,t&&t()),Qe(e?a:1-a),o}))}onIsolateChanged(){for(const e in this.uiElements)this.uiElements[e].onIsolateChanged()}setUserIsManipulatingWithTimeout(){this.frameTimer.setUserIsManipulatingWithTimeout()}setUserIsAdjustingCamera(){this.bodyManager.onUserIsAdjustingCamera(),this.frameTimer.setUserIsAdjustingCamera()}setSystemIsAnimating(){this.frameTimer.setSystemIsAnimating()}executePerformanceTests(){return this.elementLoadState=yD.LOADED_ALL_DATA,(0,Fh.Xd)(Fh.oA.OFF),this.initializeForDrawing(),this.onResize(),this.viewInitialized=!0,WI(this)}getInteractiveFrameDetails(){return this.frameTimer.getTimingDetails(os.QpP.INTERACTIVE)}getPingStats(){if(!this.isReadyForDrawing()||!this.isBrowserTabVisible||this.taskManager.hasPendingWork())return null;const e=this.getInteractiveFrameDetails(),t=this.getCamera();return e&&e.hasTimings()&&t?{framerate:e.getAverageFramerate(),triangleCount:this.modelViewManagers.getManager().getInstantiatedTriangleCount(),pixelCount:t.getViewportWidth()*t.getViewportHeight()}:null}areSectionPlanesEnabled(){return!this.isForFlattenedDisplay}onDisplayDataUsageChange(){this.detailManager.onSettingStateChange()}onDefaultUnitsChanged(e){for(const t in this.uiElements)this.uiElements[t].onDefaultUnitsChanged(e)}setDraftAnalysisPullDirection(e){this.mainDrawPass?.setDraftAnalysisPullDirection(e),this.requestDraw()}setDraftAnalysisMinimumAngle(e){this.mainDrawPass?.setDraftAnalysisMinimumAngle(e),this.requestDraw()}setDraftAnalysisParts(e){this.mainDrawPass?.setDraftAnalysisParts(e),this.requestDraw()}setDraftAnalysisShowUndercut(e){this.mainDrawPass?.setDraftAnalysisShowUndercut(e),this.requestDraw()}clearDraftAnalysis(){this.setDraftAnalysisPullDirection(null),this.setDraftAnalysisMinimumAngle(k.zG4.DEFAULT_MINIMUM_ANGLE_RADIANS),this.setDraftAnalysisParts([])}getRenderingModeOfElement(e){const t=this.elementToPerElementState[e];return t?t.renderingMode:null}updateElementPreviewNodeVisibility(e){const t=this.getModelViewManagers().getManager().getElementRootNode().getParent();if(t)for(let i=0;i<t.getChildCount();++i)t.getChildByIndex(i).setVisible(!e);const i=this.getModelViewManagers().getManager().getElementPreviewRootNode();i&&i.setVisible(e)}onElementPreviewDisplayData(e){mD.trace("Invoking onElementPreviewDisplayData for element "+e.elementId),this.activeElementId===e.elementId&&this.elementLoadState!==yD.LOADED_ALL_DATA?(this.activeElementPreviewManager=new Hl(this),this.activeElementPreviewManager.processGLDisplayDataResponse(e),this.hasElementPreviewLoaded=!0,this.setReadyState(!0),this.updateElementPreviewNodeVisibility(!0),this.requestDraw(),this.getEventDispatcher().trigger(nM.Vp,this.activeElementId),mD.trace("Drawing Preview for element "+e.elementId)):mD.trace("Skipping processing previewDisplayData because display data has been loaded "+e.elementId)}clearElementPreview(){this.updateElementPreviewNodeVisibility(!1),this.activeElementPreviewManager&&(mD.trace("Removing elementPreviewManager for elementId "+this.activeElementId),this.activeElementPreviewManager.destroy(),this.activeElementPreviewManager=null,this.requestDraw()),this.hasElementPreviewLoaded=!1}getCameraData(e){const t={camera:null,cameraExtents:null};let i=ge.w$.inverse(e,ue.create());return i||(i=ue.create()),t.camera=this.getCamera().clone(),t.camera.setFrame(ge.w$.multiply(i,t.camera.getFrame())),this.getCamera()?.isOrthographic()&&(t.cameraExtents=this.getCamera().getExtents()),t}updateCamera(e){const t=e.camera;t&&e.honorPerspective&&this.prepareViewControllerForNewCamera(t.isPerspective());const i=this.getCamera();i.isOrthographic()&&e.cameraExtents&&i.setExtents(e.cameraExtents),t&&(e.honorPerspective?i.copyFrom(t):i.copyFrom(t.getOrthographicCamera())),i.setViewportFromCanvasElement(this.$el),this.setViewInitialized(!0)}storeCameraState(e){this.storedCameraState=e}setInterferenceCallId(e){this.interferenceCallId=e}getInterferenceCallId(){return this.interferenceCallId}createDistanceDisplay(e,t){return new YM(e,t,this)}createAngleDisplay(e,t,i,s,n,r){return new KM(e,t,i,s,n,r,this)}getDimensionComponent(){const e=this.getModelViewManagers().getManager().getDisplayedPartStudio();return e?e.getDimensionComponent():null}createCombDisplay(e,t,i,s,n){return new jM(e,t,i,s,n,this)}createAngularDimension(e,t){return new EA.$(this,e,t)}createCurveLengthDimension(e,t){return new MA(this,e,t)}createLinearDimension(e,t){return new mA(this,e,t)}createEllipseDiameterDimension(e,t){return new yA(this,e,t)}createRadialDimension(e,t){return new AA(this,e,t)}createArcLengthDimension(e,t){return new SA(this,e,t)}createCenterlineDimension(e,t){return new DA(this,e,t)}createCountDimension(e,t){return new CA(this,e,t)}createBezierDegreeDimension(e,t){return new TA(this,e,t)}createAngularWithArrowManipulator(){return new kr(this)}createLinearManipulator(e){return new Lr(this,e)}createPlanarManipulator(e){return new Vr(this,e)}createTriadManipulator(e,t){return new Kr._(this,e,t)}createFeatureManipulator(e,t){return(0,Wl.wA)(e,this,t)}createLinearToolPreview(e,t,i,s,n){return tn(e,t,i,s,this,n)}createAngularToolPreview(e,t,i,s,n){return Js(e,t,i,s,n,this)}createAxes(e){return new Ji(this,e)}createEmptyBoundingBox(){return new wi.kB}createOrthographicCamera(){return new wh}createPerspectiveCamera(){return new Rh}createCommentIndicator(e,t){return new Og(e,t,this)}createCenterOfMassIndicator(e){return new Rg(e,this)}createFeatureDisplay(e){return new SE(e,this)}createControlPointGridDisplay(e,t,i){return new Qm(e,t,i,this)}createKnotPointDisplay(e,t,i){return new tf(e,t,i,this)}createEdgeCurvatureDisplay(e,t,i,s,n,r){return new Cf(e,t,i,s,n,this,r)}createDihedralDisplay(e,t,i,s){return new Ff(e,t,i,s,0,0,!1,this)}createDihedralExtremaDisplay(e,t,i,s,n){return new Bf(e,t,i,s,n,this)}createFixedMateIndicator(e,t){return new qp(e,t,this)}createImageDisplay(e,t,i,s,n,r,a,o,h,c){return new jn(e,t,i,s,n,r,a,this,o,h,c)}createInferenceDisplay(e,t){return new tp(e,this,t)}createInferencePicker(e,t,i){return new DC(this,e,t,i)}createInterferenceDisplay(e,t,i,s,n,r,a){return new yC(e,this,t,i,s,n,r,a)}createFilteredEntitiesHighlightController(e){return new Iy(this,e)}createMateConnectorManager(){return this.activeMateConnectorManager=new Sn.d,this.activeMateConnectorManager}destroyMateConnectorManager(){this.activeMateConnectorManager&&(this.activeMateConnectorManager.destroy(),this.activeMateConnectorManager=null)}getMateConnectorManager(){return this.activeMateConnectorManager}setMateConnectorInteractionEnabled(e){xl.setInteractionEnabled(e)}createMeshIncrement(e,t,i,s,n){return new eT(e,t,i,s,n)}createSnapIndicator(){return new rp(this)}createPointElement(e,t,i,s,n){return new Cd(e,t,i,s,this,n)}createSilhouette(e){return new ME(e,this)}canUserEnableAggressiveRefinement(){return!vD.has(this.renderingMode)}getUserEnabledAggressiveRefinement(){return this.bodyManager.getUserEnabledAggressiveRefinement()}setUserEnabledAggressiveRefinement(e){return this.getUserEnabledAggressiveRefinement()||!e||this.canUserEnableAggressiveRefinement()?(this.bodyManager.setUserEnabledAggressiveRefinement(e),!0):(es.Jq.MessageBubbleService.showMessageWithAutoDismiss(i18n("Viewing in high quality is disabled for this view mode."),"warning"),!1)}getOrCreateActiveElementViewerState(){let e=this.elementToPerElementState[this.activeElementId];return void 0===e&&(e=this.elementToPerElementState[this.activeElementId]=new MD(this.activeElementId)),e}getActiveElementViewerState(){return this.elementToPerElementState[this.activeElementId]}setZebraStripeCount(e){this.getOrCreateActiveElementViewerState().zebraStripeCount=e,this.mainDrawPass?.setZebraStripeCount(e),this.getIsPrimaryViewer()&&(this.followGraphicsData.zebraStripeCount=e,this.followGraphicsDataSubject.next(this.followGraphicsData))}setZebraStripeRotation(e){this.getOrCreateActiveElementViewerState().zebraStripeRotation=e,this.mainDrawPass?.setZebraStripeRotation(e),this.getIsPrimaryViewer()&&(this.followGraphicsData.zebraStripeRotation=e,this.followGraphicsDataSubject.next(this.followGraphicsData))}getZebraStripeCount(){return this.getActiveElementViewerState()?.zebraStripeCount??CD.getNumber("ZEBRA_STRIPE_COUNT")}getZebraStripeRotation(){return this.getActiveElementViewerState()?.zebraStripeRotation??CD.getNumber("ZEBRA_STRIPE_ROTATION")}getZebraStripeEdgesOn(){return this.getActiveElementViewerState()?.zebraStripeEdgesOn??!0}setZebraStripeEdgesOn(e){this.getOrCreateActiveElementViewerState().zebraStripeEdgesOn=e,this.renderingMode===k.P1.CURVATURE_VISUALIZATION&&this.setRenderingMode(this.renderingMode),this.requestDraw(),this.getIsPrimaryViewer()&&(this.followGraphicsData.zebraStripeEdgesOn=e,this.followGraphicsDataSubject.next(this.followGraphicsData))}getRenderModeObservable(){return this.renderModeSubject.asObservable()}logDisplayDataRefinementState(){mD.info("Display data refinement state logged. Details:\n\n"+this.bodyManager.getDisplayDataRefinementState())}unloadSelectedBodies(){(0,Me.vi)().each((e=>{this.bodyManager.unloadSelectionBody(e)}))}isIsolateEffectInUseForVisualization(){const e=this.modelViewManagers.getManager().getSimulationManager();return!!e&&e.isIsolateEffectActive()}onBrowserTabVisibilityChanged(){switch(document.visibilityState){case"hidden":this.isBrowserTabVisible=!1;break;case"visible":this.isBrowserTabVisible=!0,this.frameTimer.resetTimings()}}getCurvatureAnalysisManager(){return this.curvatureAnalysisManager}getThicknessAnalysisManager(){return this.modelViewManagers.getManager()?.getThicknessAnalysisManager()??null}getXrController(){return this.xrController}get isOngoingRenderLoopRunning(){return this.xrController?.getIsXrRunning()}getXrInputCamera(e){const t=new wh;t.setFrame(ue.multiply(ue.create(),this.xrController.modelTransformInverse,e.worldSpacePose)),t.setViewportFromCanvasElement(this.$el);const i=1e-4,s=t.getViewportWidth()*i*.5,n=t.getViewportHeight()*i*.5;t.setExtentsByComponent(-s,s,-n,n),t.sceneBounds=this.getSceneBounds();const r=Ay,a=Math.max(t.near+.001,M.dot(t.getForward(),M.subtract(M.create(),t.sceneBounds.center(),t.getEye()))+t.sceneBounds.diameter()/2);return t.setNearFar(r,a),t}pickWithXrInput(e){if(e.picks)return e.picks;const t=this.getXrInputCamera(e),i=t.getViewportWidth()/2,s=t.getViewportHeight()/2;return e.picks=this.pickIteratively(i,s,this.getDefaultPickTerminationEvaluator(),{cameraOverride:t}),e.picks}getDepthForXrInput(e){const t=this.getXrInputCamera(e),i=t.getViewportWidth()/2,s=t.getViewportHeight()/2,n=this.findDepthsInRect(i-2,s-2,5,5,!1,t);if(0===n.length)return-1;let r=0;const a=e.modelSpaceRay;for(const e of n)r+=a.findPositionOfPoint(t.canvasToWorld(e));return r/n.length}getIsSynchingView(){return this.isSynchingView}setIsSynchingView(e){this.isSynchingView=e,this.pairedViewer&&(this.pairedViewer.isSynchingView=e)}setShouldUpdatePairedViewer(e){this.shouldUpdatePairedViewer=e}syncPairedView(){if(!this.pairedViewer.getCamera())return;const e=this.getCameraData(ue.identity(ue.create()));e.honorPerspective=!0,this.pairedViewer.updateCamera(e),this.pairedViewer.setShouldUpdatePairedViewer(!1),this.pairedViewer.requestDraw()}onAppearanceConstantsUpdated(){this.resources.onAppearanceConstantsUpdated();for(const e of Object.values(this.uiElements))e.onAppearanceConstantsUpdated();const e=this.getReferenceHighlights();Object.values(e.highlights).forEach((t=>{e.updateHighlightColor(t.type)})),this.getModelViewManagers().onAppearanceConstantsUpdated(),this.mainDrawPass?.onAppearanceConstantsUpdated(),this.isolatedOccurrenceManager?.refreshTranslucentOccurrences(),this.requestDraw()}onActiveFeatureChanged(e){for(const t of[this.modelViewManagers.getManager(),this.modelViewManagers.getPreviewManager()])if(t){const i=t.getDisplayedPartStudio()?.getDimensionComponent();i&&i.onActiveFeatureChanged(e)}}clearActiveAnnotation(){const e=this.modelViewManagers.getManager();if(e){const t=e.getDisplayedPartStudio()?.getAnnotationComponent();t&&t.clearActiveAnnotation()}}onActiveAnnotationChanged(e){const t=this.modelViewManagers.getManager();if(t){const i=t.getDisplayedPartStudio()?.getAnnotationComponent();i&&i.onActiveAnnotationChanged(e)}}createLineDisplay(e,t,i){return new an(this,e,t,i)}isolateEffectPickFilter(e){const t=this.getIsolatedOccurrenceManager();if(e.getIsolated()||!t?.isInIsolateOrMakeTransparentMode()||t?.isInIsolateOrMakeTransparentMode()&&t.isInPickingMode()||this.getIsForFlattenedDisplay())return!0;const i=e.getOccurrenceId();return i===TE.KF||!(!this.getModelViewManagers().getManager().isDisplayingIncontextAssembly()||!this.getModelViewManagers().getManager().isOccurrenceIdForInContext(i))}}function bD(e){return new ND({el:e,disableAutomaticDrawing:!0,disableInput:!0,disableViewManipulator:!0})}function LD(){if(localStorage.getItem("osDisplayDataTimersLoggingEnabled"))return{logResult:!0}}var FD=i(91695),xD=i(87949),BD=i(57702);const VD=i(85841),UD=X.default.getManager(),HD="viewManipulatorEvent";let GD=null;function kD(e){GD=e}var WD;function zD(e){return 0===e.indexOf("Trimetric")}!function(e){e.TOP="Top",e.BOTTOM="Bottom",e.FRONT="Front",e.BACK="Back",e.RIGHT="Right",e.LEFT="Left",e.TRIMETRIC_TOP_RIGHT_FRONT="Trimetric",e.TRIMETRIC_TOP_LEFT_FRONT="TrimetricTopLeftFront",e.TRIMETRIC_TOP_RIGHT_BACK="TrimetricTopRightBack",e.TRIMETRIC_TOP_LEFT_BACK="TrimetricTopLeftBack",e.TRIMETRIC_BOTTOM_RIGHT_FRONT="TrimetricBottomRightFront",e.TRIMETRIC_BOTTOM_LEFT_FRONT="TrimetricBottomLeftFront",e.TRIMETRIC_BOTTOM_RIGHT_BACK="TrimetricBottomRightBack",e.TRIMETRIC_BOTTOM_LEFT_BACK="TrimetricBottomLeftBack",e.LEFT_ARROW="LeftArrow",e.RIGHT_ARROW="RightArrow",e.UP_ARROW="UpArrow",e.DOWN_ARROW="DownArrow",e.CW_ARROW="CwArrow",e.CCW_ARROW="CcwArrow",e.VIEW_CONTROL_ICON="ViewCtrlIcon"}(WD||(WD={}));const XD=new Gi.hF({primitiveType:Ai.MX.TRIANGLES,material:Vi,zOffset:2}),ZD=new Gi.hF({isPickable:!1,primitiveType:Ai.MX.LINES,isVisible:!1}),qD=new Gi.hF({isPickable:!1,primitiveType:Ai.MX.LINES}),YD=qD,KD=new Gi.hF({isPickable:!1,isShowThrough:!0,isDepthTested:!1,isStencilTested:!0,primitiveType:Ai.MX.LINES}),jD=new Gi.hF({isPickable:!1,primitiveType:Ai.MX.TRIANGLES,material:null}),QD=new Gi.hF({isPickable:!1,isShowThrough:!0,isDepthTested:!1,primitiveType:Ai.MX.TRIANGLES,material:null});let $D;const JD=.5,eC=.5*UD.getNumber("VIEW_CUBE_ARROW_WIDTH"),tC=.5*UD.getNumber("VIEW_CUBE_ARROW_HEIGHT"),iC=JD-tC;function sC(){return(JD-2*eC)/1.6-UD.getNumber("VIEW_CUBE_AXIS_TEXT_HEIGHT_PX")/$D/1.5}let nC;const rC="viewmanipulator",aC="viewmanipulatorbuttons",oC=".highlight";class hC extends yi.u1{constructor(e){super(e,uh.EG),this.staticIncrements=null,this.cubeCenter=[0,0,0],this.setId(aC),this.highlightedId=yi.ZJ;for(const e of Object.values(WD))this.listenTo(this,yi.zw.CLICK+e,this.onMouseClick),this.listenTo(this,yi.zw.MOUSE_ENTER+e,this.onMouseEnter),this.listenTo(this,yi.zw.MOUSE_LEAVE+e,this.onMouseLeave),e===WD.VIEW_CONTROL_ICON&&this.listenTo(this.viewer.getEventDispatcher(),nM.oL,this.unselectViewControlIcon)}onDevicePixelRatioChanged(e){this.staticIncrements=null,this.updateGraphics()}setCubeCenter(e){this.cubeCenter=e}getStaticIncrements(){if(this.staticIncrements)return this.staticIncrements;const e=this;this.staticIncrements={};const t=function(t,i,s,n){ge.S4.scale(i,$D),ge.S4.scale(s,$D),ge.S4.scale(n,$D);const r=t+"Face",a=(0,Yd.aT)(i,s,n);e.staticIncrements[r]={selection:t,data:a,type:XD,color:UD.getColor("VIEW_CUBE_ARROW_COLOR")}};t(WD.LEFT_ARROW,[-.5,0,-.5],[-iC,-eC,-.5],[-iC,eC,-.5]),t(WD.RIGHT_ARROW,[JD,0,-.5],[iC,eC,-.5],[iC,-eC,-.5]),t(WD.UP_ARROW,[0,JD,-.5],[-eC,iC,-.5],[eC,iC,-.5]),t(WD.DOWN_ARROW,[0,-.5,-.5],[eC,-iC,-.5],[-eC,-iC,-.5]);const i=Math.sin(Math.PI/4),s=Math.cos(Math.PI/4),n=Math.sin(Math.PI/4-tC/JD),r=Math.cos(Math.PI/4-tC/JD);t(WD.CW_ARROW,[s*JD,i*JD,-.5],[s*(JD-2*eC),i*(JD-2*eC),-.5],[r*(JD-eC),n*(JD-eC),-.5]),t(WD.CCW_ARROW,[-s*(JD-2*eC),i*(JD-2*eC),-.5],[-s*JD,i*JD,-.5],[-r*(JD-eC),n*(JD-eC),-.5]);const a=function(t,i,s){const n=Math.ceil(36*Math.abs(s-i)/Math.PI),r=(JD-eC-UD.getNumber("VIEW_CUBE_ARROW_ARC_WIDTH")/2)*$D,a=(JD-eC+UD.getNumber("VIEW_CUBE_ARROW_ARC_WIDTH")/2)*$D,o=(0,Yd.zl)([0,0,0],r,[0,0,1],n,[1,0,0],i,s),h=(0,Yd.zl)([0,0,0],a,[0,0,1],n,[1,0,0],i,s),c=(h.length+o.length)/3,l=new Float32Array(3*c);for(let e=0;e<c/2;++e)l[6*e+0]=o[3*e+0],l[6*e+1]=o[3*e+1],l[6*e+2]=o[3*e+2],l[6*e+3]=h[3*e+0],l[6*e+4]=h[3*e+1],l[6*e+5]=h[3*e+2];const d=t+"ArcFace",u=new Float32Array(3*c);for(let e=0;e<c;++e)u[3*e+0]=0,u[3*e+1]=0,u[3*e+2]=1;const g=new Int32Array(6*(c/2-1));for(let e=0;e<c/2-1;++e)g[6*e+0]=2*e+0,g[6*e+1]=2*e+1,g[6*e+2]=2*e+2,g[6*e+3]=2*e+1,g[6*e+4]=2*e+3,g[6*e+5]=2*e+2;const p=new eT(Ai.MX.TRIANGLES,l,g);p.normals=u,e.staticIncrements[d]={selection:t,data:p,type:XD,color:UD.getColor("VIEW_CUBE_ARROW_COLOR")}};return a(WD.CW_ARROW,.25*Math.PI,.4*Math.PI),a(WD.CCW_ARROW,.6*Math.PI,.75*Math.PI),e.staticIncrements}updateGraphics(){this.updateIncrementsOnEntity(WD.LEFT_ARROW,"Face"),this.updateIncrementsOnEntity(WD.RIGHT_ARROW,"Face"),this.updateIncrementsOnEntity(WD.UP_ARROW,"Face"),this.updateIncrementsOnEntity(WD.DOWN_ARROW,"Face"),this.updateIncrementsOnEntity(WD.CW_ARROW,"Face"),this.updateIncrementsOnEntity(WD.CCW_ARROW,"Face"),this.updateIncrementsOnEntity(WD.CW_ARROW,"ArcFace"),this.updateIncrementsOnEntity(WD.CCW_ARROW,"ArcFace")}updateIncrementsOnEntity(e,t){const i=this,s=this.getStaticIncrements();(s[e+t].type===XD||s[e+t].type===qD&&s[e+t].color)&&(0,Yd.Ab)(i.highlightedId===s[e+t].selection?UD.getColor("VIEW_CUBE_FACE_HIGHLIGHT"):s[e+t].color,s[e+t].data),this.updateMeshIncrement(e+t,s[e+t].selection,s[e+t].data.clone(),s[e+t].type)}updateTransform(){const e=ue.create();e[12]=this.cubeCenter[0],e[13]=this.cubeCenter[1],e[14]=this.cubeCenter[2],this.setTransform(e),this.hasMeshIncrements()||this.updateGraphics()}onMouseClick(e,t,i){this.trigger(HD,e.selectionId),es.Jq.AnalyticsService.trackEventForDocumentId("VIEW_CUBE_COMMAND","click_"+e.selectionId,(0,ia.n)());let s="";WD.LEFT_ARROW===e.selectionId?s="left":WD.RIGHT_ARROW===e.selectionId?s="right":WD.UP_ARROW===e.selectionId?s="up":WD.DOWN_ARROW===e.selectionId?s="down":WD.CW_ARROW===e.selectionId?s="clockwise":WD.CCW_ARROW===e.selectionId&&(s="counterclockwise"),s&&(t.shiftKey?this.viewer.rotateInDirection(s,os.Vf$.COARSE):t.ctrlKey?this.viewer.rotateInDirection(s,os.Vf$.FINE):this.viewer.rotateInDirection(s,os.Vf$.DEFAULT),i.requestSelectedStatus=!1)}unselectViewControlIcon(){this.highlightedId===WD.VIEW_CONTROL_ICON&&(this.highlightedId=yi.ZJ,this.updateGraphics()),this.viewer.requestDraw()}onMouseEnter(e,t){this.highlightedId=e.selectionId,this.updateGraphics(),this.viewer.requestDraw()}onMouseLeave(e,t){this.highlightedId===e.selectionId&&(this.highlightedId=yi.ZJ,this.updateGraphics()),this.viewer.requestDraw()}isViewManipulator(){return!0}shouldTreatCtrlClickAsClick(e){return e.which===os.tcH.LEFT&&e.ctrlKey}}const cC="label",lC="label.showthrough",dC=(0,wi.Yr)(UD.getNumber("VIEW_CUBE_AXIS_LABEL_FADE_START_ANGLE")),uC=(0,wi.Yr)(UD.getNumber("VIEW_CUBE_AXIS_LABEL_FADE_END_ANGLE"));class gC extends yi.u1{constructor(e,t,i,s){super(s,uh.EG),this.label=e,this.direction=t,this.colorName=i,this.labelTexture=null,this.center=[0,0,0,0],this.cubeCenter=M.create(),this.lastSetOpacity=-1,this.nodeProperties=new Gi.hF(jD),this.nodeProperties.material=Hi(),this.nodeProperties.updateId(),this.showThroughNodeProperties=new Gi.hF(QD),this.showThroughNodeProperties.material=this.nodeProperties.material,this.showThroughNodeProperties.updateId(),this.ensureTexture()}onDevicePixelRatioChanged(e){this.refreshGraphics()}onAppearanceConstantsUpdated(){this.refreshGraphics()}refreshGraphics(){this.labelTexture&&(this.labelTexture.destroy(),this.labelTexture=null),this.viewer.getGlContext()&&(this.ensureTexture(),this.updateIncrements())}remove(){this.labelTexture&&this.labelTexture.destroy(),this.nodeProperties.material&&(this.nodeProperties.material.destroy(),this.nodeProperties.material=null),super.remove()}updateIncrements(){if(!this.labelTexture)return;const e=UD.getNumber("VIEW_CUBE_AXIS_TEXT_HEIGHT_PX"),t=this.labelTexture.filledWidthPx,i=(0,Yd.fQ)([-t/2,-e/2,0],[t/2,-e/2,0],[-t/2,e/2,0],void 0,[this.labelTexture.leftCoordinate,this.labelTexture.bottomCoordinate],[this.labelTexture.rightCoordinate,this.labelTexture.topCoordinate]);(0,Yd.Ab)([1,1,1,.5],i),this.updateMeshIncrement(cC,yi.ZJ,i,this.nodeProperties);const s=i.clone();(0,Yd.Ab)([1,1,1,UD.getNumber("VIEW_CUBE_HIDDEN_AXIS_OPACITY")],s),this.updateMeshIncrement(lC,yi.ZJ,s,this.showThroughNodeProperties);const n=$D*nC,r=UD.getNumber("VIEW_CUBE_AXIS_GAP"),a=[-n-r,-n-r,-n-r],o=Math.sqrt(t*t+e*e)/2+3,h=ge.S4.add(ge.S4.scale(this.direction,2*n+o,M.create()),a);this.center=[h[0],h[1],h[2],0]}ensureTexture(){this.viewer.getGlContext()&&(this.labelTexture||(this.labelTexture=jo(this.viewer,this.label,{color:UD.getColor(this.colorName),font:UD.getString("VIEW_CUBE_TEXT_FONT"),size:UD.getNumber("VIEW_CUBE_AXIS_TEXT_HEIGHT_PX")}),this.nodeProperties.material.ambientTexture=this.labelTexture,this.showThroughNodeProperties.material.ambientTexture=this.labelTexture,this.updateIncrements()))}setCubeCenter(e){this.cubeCenter=e}setOpacity(e){if(e===this.lastSetOpacity)return;const t=new Uint8Array([255,255,255,255*e]);this.updateIncrementAttribute(cC,RS.COLOR,t),t[3]=255*Math.min(e,UD.getNumber("VIEW_CUBE_HIDDEN_AXIS_OPACITY")),this.updateIncrementAttribute(lC,RS.COLOR,t),this.lastSetOpacity=e}updateTransform(e){const t=Math.acos(Math.abs(M.dot(e.getForward(),this.direction))),i=(0,wi.CW)(uC,dC,t);this.setOpacity(i);const s=ge.w$.multiplyVec4(e.getViewMatrix(),this.center,y.create()),n=ge.S4.add(s,this.cubeCenter);this.setTransform(ge.w$.translate(ue.create(),n))}}let pC=class extends nD.View{constructor(e,t){super(t),this.contextMenuMgr=e}initialize(e){this.viewer=e.viewer,this.parentManipulator=e.parentManipulator,this.mouseMoveFunction=e=>this.onMouseMove(e),this.mouseUpFunction=e=>this.onMouseUp(e),this.distanceDraggedPx=0,this.rightPostion=-1,this.topPosition=-1,this.$el.hide(),this.$el.html(VD()),this.$el.attr("data-bs-original-title",i18n("Camera and render options")),this.userLanguageChangeSubscription=es.Jq.LocaleService.getUserLanguageChangeObservable().subscribe((()=>{this.$el.attr("data-bs-original-title",i18n("Camera and render options"))}));const t=UD.getNumber("VIEW_CUBE_SCREEN_SIZE_PX")/(0,ns.x_)();this.$el.find(".os-view-cube-bounds").css({width:t+"px",height:t+"px",right:0,bottom:"5px"})}remove(){return this.userLanguageChangeSubscription.unsubscribe(),super.remove()}appendToCanvasParent(){this.$el.appendTo(this.viewer.$el.parent()),this.delegateEvents()}position(e,t){this.rightPostion===e&&this.topPosition===t||(this.$el.css({right:e,top:t}),this.rightPostion=e,this.topPosition=t)}onClick(){this.distanceDraggedPx<=UD.getNumber("LEFT_MOUSE_DRAG_DISTANCE_TOLERANCE")&&GD?.toggleViewCubeMenuVisibility(this.$el,this.viewer),this.distanceDraggedPx=0}getCanvasPositionFromEvent(e){const t=this.viewer.getCanvasCoordinateFromEvent(e);return{mouseX:t[0],mouseY:t[1]}}onMouseDown(e){this.viewer.isReadyForDrawing()&&(es.Jq.FlyoutService.collapseAllFlyouts(),1===e.which&&(this.parentManipulator.setDragStart(this.getCanvasPositionFromEvent(e)),BD(document).on("mousemove",this.mouseMoveFunction),BD(document).on("mouseup",this.mouseUpFunction)))}onMouseMove(e){this.viewer.isReadyForDrawing()&&(this.distanceDraggedPx+=this.parentManipulator.updateDragPosition(this.getCanvasPositionFromEvent(e)))}onMouseUp(e){BD(document).off("mousemove",this.mouseMoveFunction),BD(document).off("mouseup",this.mouseUpFunction)}};pC=(0,FD.__decorate)([(0,xD.g)({className:"os-graphics-dropdown",events:{click:"onClick",mousedown:"onMouseDown"}}),(0,FD.__metadata)("design:paramtypes",[Object,Object])],pC);class mC extends yi.u1{constructor(e,t){super(e,uh.EG),this.contextMenuMgr=t,this.labelTextures={},this.labelProperties={},this.topRightCorner=M.create(),this.center=M.create(),this.staticIncrements=null,this.axisLabels={},this.dropdownButton=null,this.i18next=i18n,"function"!=typeof this.i18next&&(this.i18next=function(e){return e}),$D=UD.getNumber("VIEW_CUBE_SCREEN_SIZE_PX"),nC=sC(),this.setId(rC),this.highlightedId=yi.ZJ,this.oldDevicePixelRatio=(0,ns.x_)(),this.manipulatorButtons=new hC(this.viewer),this.listenTo(this.viewer.getEventDispatcher(),nM.pO,this.ensureTextures);for(const e of Object.values(WD))this.listenTo(this,yi.zw.CLICK+e,this.onMouseClick),this.listenTo(this,yi.zw.MOUSE_ENTER+e,this.onMouseEnter),this.listenTo(this,yi.zw.MOUSE_LEAVE+e,this.onMouseLeave),this.listenTo(this,yi.zw.DRAG_START+e,this.onDragStart),this.listenTo(this,yi.zw.DRAG+e,this.onDrag),this.listenTo(this,yi.zw.DRAG_STOP+e,this.onDragStop),this.listenTo(this.manipulatorButtons,yi.zw.DRAG_START+e,this.onDragStart),this.listenTo(this.manipulatorButtons,yi.zw.DRAG+e,this.onDrag),this.listenTo(this.manipulatorButtons,yi.zw.DRAG_STOP+e,this.onDragStop);this.axisLabels.X=new gC("X",[1,0,0],"X_AXIS_COLOR",this.viewer),this.axisLabels.Y=new gC("Y",[0,1,0],"Y_AXIS_COLOR",this.viewer),this.axisLabels.Z=new gC("Z",[0,0,1],"Z_AXIS_COLOR",this.viewer),this.viewer.getIsPrimaryViewer()&&(this.dropdownButton=new pC(t,{viewer:this.viewer,parentManipulator:this})),this.ensureTextures(),this.userLanguageChangeSubscription=es.Jq.LocaleService.getUserLanguageChangeObservable().subscribe((()=>{this.refreshGraphics()}))}onDevicePixelRatioChanged(e){const t=(0,ns.x_)();ge.S4.scale(this.topRightCorner,t/this.oldDevicePixelRatio),this.oldDevicePixelRatio=t,$D=UD.getNumber("VIEW_CUBE_SCREEN_SIZE_PX"),nC=sC(),this.refreshGraphics(),this.updateDropdownPosition()}onAppearanceConstantsUpdated(){this.refreshGraphics()}refreshGraphics(){this.staticIncrements=null,this.destroyTextures(),this.viewer.getGlContext()&&(this.ensureTextures(),this.updateGraphics())}destroyTextures(){Object.values(this.labelTextures).forEach((function(e){e.destroy()})),this.labelTextures={}}remove(){Object.values(this.labelProperties).forEach((function(e){e.material&&(e.material.destroy(),e.material=null)})),this.dropdownButton&&this.dropdownButton.remove(),this.userLanguageChangeSubscription.unsubscribe(),super.remove()}hide(){super.hide(),this.manipulatorButtons.hide(),Object.values(this.axisLabels).forEach((function(e){e.hide()})),this.dropdownButton&&this.dropdownButton.$el.hide()}show(){super.show(),this.manipulatorButtons.show(),Object.values(this.axisLabels).forEach((function(e){e.show()})),this.dropdownButton&&(this.dropdownButton.appendToCanvasParent(),this.dropdownButton.$el.show())}getPickPriority(e){return zD(e.selectionId)?gI.z.UI+5:gI.z.UI}onViewWillDraw(e,t){this.updateTransform(e),this.manipulatorButtons.updateTransform();for(const t in this.axisLabels)this.axisLabels[t].updateTransform(e)}ensureTextures(){if(!this.viewer.getGlContext())return;const e=this,t=function(t,i,s,n){e.labelTextures[t]||(e.labelTextures[t]=jo(e.viewer,i,{color:n?UD.getColor("VIEW_CUBE_TEXT_COLOR_HIGHLIGHT"):UD.getColor("VIEW_CUBE_TEXT_COLOR"),font:UD.getString("VIEW_CUBE_TEXT_FONT"),size:s,paddingWithinBorder:UD.getNumber("VIEW_CUBE_TEXT_BACKGROUND_PADDING")}));let r=e.labelProperties[t];r||(r=new Gi.hF(jD),r.material=Hi(),e.labelProperties[t]=r),r.material.ambientTexture=e.labelTextures[t],r.updateId()},i=function(e,i,s){t(e,i,s,!1),t(e+oC,i,s,!0)};i(WD.TOP,this.i18next("Top"),UD.getNumber("VIEW_CUBE_TEXT_HEIGHT_PX")),i(WD.BOTTOM,this.i18next("Bottom"),UD.getNumber("VIEW_CUBE_TEXT_HEIGHT_PX")),i(WD.FRONT,this.i18next("Front"),UD.getNumber("VIEW_CUBE_TEXT_HEIGHT_PX")),i(WD.BACK,this.i18next("Back"),UD.getNumber("VIEW_CUBE_TEXT_HEIGHT_PX")),i(WD.RIGHT,this.i18next("Right"),UD.getNumber("VIEW_CUBE_TEXT_HEIGHT_PX")),i(WD.LEFT,this.i18next("Left"),UD.getNumber("VIEW_CUBE_TEXT_HEIGHT_PX"));for(const e in this.axisLabels)this.axisLabels[e].ensureTexture()}updateCenter(e){const t=e.getViewport(),i=-vh(t)[0]-.5*$D;this.center=ge.S4.add([t[0]+t[2]-$D/2,t[1]+t[3]-$D/2,i],this.topRightCorner);const s=t[0]+UD.getNumber("VIEW_CUBE_LEFT_MARGIN_PX")+$D/2,n=t[1]+UD.getNumber("VIEW_CUBE_BOTTOM_MARGIN_PX")+$D/2,r=t[0]+t[2]-UD.getNumber("VIEW_CUBE_RIGHT_MARGIN_PX")-$D/2,a=t[1]+t[3]-UD.getNumber("VIEW_CUBE_TOP_MARGIN_PX")-$D/2;this.center[0]=Math.min(Math.max(s,this.center[0]),r),this.center[1]=Math.min(Math.max(n,this.center[1]),a),this.topRightCorner=[this.center[0]+$D/2-t[0]-t[2],this.center[1]+$D/2-t[1]-t[3],0],this.updateDropdownPosition();for(const e in this.axisLabels)this.axisLabels[e].setCubeCenter(this.center);this.manipulatorButtons.setCubeCenter(this.center)}getStaticIncrements(){if(this.staticIncrements)return this.staticIncrements;const e=this;this.staticIncrements={};const t=function(t,i,s,n){ge.S4.scale(i,$D),ge.S4.scale(s,$D),ge.S4.scale(n,$D);const r=ge.S4.subtract(s,i,M.create()),a=ge.S4.subtract(n,i,M.create()),o=ge.S4.add(i,ge.S4.scale(ge.S4.add(r,a,M.create()),.5),M.create()),h=ge.S4.length(r),c=ge.S4.length(a);ge.S4.scale(r,1/h),ge.S4.scale(a,1/c);const l=(h+c)/2*UD.getNumber("VIEW_CUBE_CORNER_SIZE"),d=t+"Front",u=h*UD.getNumber("VIEW_CUBE_FRONT_SIZE"),g=c*UD.getNumber("VIEW_CUBE_FRONT_SIZE");let p=ge.S4.add(ge.S4.scale(r,-.5*u,M.create()),ge.S4.scale(a,-.5*g,M.create()),M.create());p=ge.S4.add(p,o);const m=ge.S4.add(ge.S4.scale(r,u,M.create()),p),f=ge.S4.add(ge.S4.scale(a,g,M.create()),p),I=(0,Yd.Dw)(p,m,f,l,9);e.staticIncrements[d]={selection:t,data:I,type:XD,color:UD.getColor("VIEW_CUBE_FRONT_COLOR")};const E=t+"Edge",S=I.points;let T=S.length/3;const D=new Int32Array(2*T);for(let e=0;e<T;++e)D[2*e]=e,D[2*e+1]=(e+1)%T;const C=new eT(Ai.MX.LINES,S,D);e.staticIncrements[E]={selection:t,data:C,type:ZD,color:UD.getColor("VIEW_CUBE_EDGE_HIGHLIGHT")};const y=t+"Back",A=h*UD.getNumber("VIEW_CUBE_BACK_SIZE"),P=c*UD.getNumber("VIEW_CUBE_BACK_SIZE");let O=ge.S4.add(ge.S4.scale(r,-.5*A,M.create()),ge.S4.scale(a,-.5*P,M.create()),M.create());O=ge.S4.add(O,o);const R=ge.S4.add(ge.S4.scale(r,A,M.create()),O),w=ge.S4.add(ge.S4.scale(a,P,M.create()),O),v=(0,Yd.Dw)(O,w,R,l,9);e.staticIncrements[y]={selection:t,data:v,type:XD,color:UD.getColor("VIEW_CUBE_BACK_COLOR")};const _=t+"BackEdge",N=v.points;T=S.length/3;const b=new Int32Array(2*T);for(let e=0;e<T;++e)b[2*e]=e,b[2*e+1]=(e+1)%T;const L=new eT(Ai.MX.LINES,N,b);e.staticIncrements[_]={selection:t,data:L,type:ZD,color:UD.getColor("VIEW_CUBE_EDGE_HIGHLIGHT")};const F=t+"Label",x=e.labelTextures[t],B=x.filledWidthPx,V=x.filledHeightPx,U=(h-B)/2,H=(c-V)/2,G=ge.S4.add(ge.S4.scale(r,U,M.create()),ge.S4.scale(a,H,M.create()),M.create());ge.S4.add(G,i);const k=ge.S4.add(G,ge.S4.scale(r,B,M.create()),M.create()),W=ge.S4.add(G,ge.S4.scale(a,V,M.create()),M.create()),z=(0,Yd.fQ)(G,k,W,void 0,[x.leftCoordinate,x.bottomCoordinate],[x.rightCoordinate,x.topCoordinate]);e.staticIncrements[F]={selection:t,data:z,type:e.labelProperties[t],color:null},e.staticIncrements[F+oC]={selection:t,data:z,type:e.labelProperties[t+oC],color:null}},i=nC;t(WD.TOP,[-i,-i,i],[i,-i,i],[-i,i,i]),t(WD.BOTTOM,[-i,i,-i],[i,i,-i],[-i,-i,-i]),t(WD.FRONT,[-i,-i,-i],[i,-i,-i],[-i,-i,i]),t(WD.BACK,[i,i,-i],[-i,i,-i],[i,i,i]),t(WD.RIGHT,[i,-i,-i],[i,i,-i],[i,-i,i]),t(WD.LEFT,[-i,i,-i],[-i,-i,-i],[-i,i,i]);const s=function(t,i,s,n){ge.S4.scale(i,$D),n*=$D;const r=t+"Face",a=(0,Yd.$)(i,n,s,36);e.staticIncrements[r]={selection:t,data:a,type:XD,color:UD.getColor("VIEW_CUBE_FRONT_COLOR")};const o=t+"Edge",h=a.points,c=h.length/3,l=new Int32Array(2*c);for(let e=0;e<c;++e)l[2*e]=e,l[2*e+1]=(e+1)%c;const d=new eT(Ai.MX.LINES,h,l);e.staticIncrements[o]={selection:t,data:d,type:ZD,color:UD.getColor("VIEW_CUBE_EDGE_HIGHLIGHT")}},n=.8*i,r=.24*i;return s(WD.TRIMETRIC_TOP_RIGHT_FRONT,[n,-n,n],[1,-1,1],r),s(WD.TRIMETRIC_TOP_LEFT_FRONT,[-n,-n,n],[-1,-1,1],r),s(WD.TRIMETRIC_TOP_RIGHT_BACK,[n,n,n],[1,1,1],r),s(WD.TRIMETRIC_TOP_LEFT_BACK,[-n,n,n],[-1,1,1],r),s(WD.TRIMETRIC_BOTTOM_RIGHT_FRONT,[n,-n,-n],[1,-1,-1],r),s(WD.TRIMETRIC_BOTTOM_LEFT_FRONT,[-n,-n,-n],[-1,-1,-1],r),s(WD.TRIMETRIC_BOTTOM_RIGHT_BACK,[n,n,-n],[1,1,-1],r),s(WD.TRIMETRIC_BOTTOM_LEFT_BACK,[-n,n,-n],[-1,1,-1],r),e.staticIncrements}updateGraphics(){const e=WD,t=[e.TOP,e.BOTTOM,e.FRONT,e.BACK,e.LEFT,e.RIGHT];let i;for(i=0;i<t.length;i++)this.updateIncrementsOnEntity(t[i],"Front"),this.updateIncrementsOnEntity(t[i],"Edge"),this.updateIncrementsOnEntity(t[i],"Back"),this.updateIncrementsOnEntity(t[i],"BackEdge"),this.highlightedId===t[i]?(this.removeMeshIncrement(t[i]+"Label"),this.updateIncrementsOnEntity(t[i],"Label"+oC)):(this.removeMeshIncrement(t[i]+"Label"+oC),this.updateIncrementsOnEntity(t[i],"Label"));const s=[e.TRIMETRIC_TOP_RIGHT_FRONT,e.TRIMETRIC_TOP_LEFT_FRONT,e.TRIMETRIC_TOP_RIGHT_BACK,e.TRIMETRIC_TOP_LEFT_BACK,e.TRIMETRIC_BOTTOM_RIGHT_FRONT,e.TRIMETRIC_BOTTOM_LEFT_FRONT,e.TRIMETRIC_BOTTOM_RIGHT_BACK,e.TRIMETRIC_BOTTOM_LEFT_BACK];for(i=0;i<s.length;i++)this.updateIncrementsOnEntity(s[i],"Face"),this.updateIncrementsOnEntity(s[i],"Edge");this.addAxes()}addAxes(){const e=this,t=function(t,i,s){const n=$D*nC,r=UD.getNumber("VIEW_CUBE_AXIS_GAP"),a=[-n-r,-n-r,-n-r],o=ge.S4.add(ge.S4.scale(i,2*n,M.create()),a),h=(0,Yd.W5)(a,o);(0,Yd.VQ)(UD.getNumber("VIEW_CUBE_AXIS_WIDTH"),h),(0,Yd.Ab)(s,h),e.updateMeshIncrement(t,yi.ZJ,h,YD);const c=h.clone();(0,Yd.KZ)(UD.getStipple("VIEW_CUBE_HIDDEN_AXIS_STIPPLE"),c);const l=s.slice(0);l[3]=UD.getNumber("VIEW_CUBE_HIDDEN_AXIS_OPACITY"),(0,Yd.Ab)(l,c),e.updateMeshIncrement(t+".st",yi.ZJ,c,KD)};t("X",[1,0,0],UD.getColor("X_AXIS_COLOR")),t("Y",[0,1,0],UD.getColor("Y_AXIS_COLOR")),t("Z",[0,0,1],UD.getColor("Z_AXIS_COLOR"))}updateIncrementsOnEntity(e,t){const i=this,s=this.getStaticIncrements();s[e+t].type===XD?(0,Yd.Ab)(i.highlightedId===s[e+t].selection?UD.getColor("VIEW_CUBE_FACE_HIGHLIGHT"):s[e+t].color,s[e+t].data):s[e+t].type===qD&&(0,Yd.Ab)(s[e+t].color,s[e+t].data),this.updateMeshIncrement(e+t,s[e+t].selection,s[e+t].data.clone(),s[e+t].type)}updateTransform(e){this.updateCenter(e);const t=ue.create();t[12]=this.center[0],t[13]=this.center[1],t[14]=this.center[2];const i=ge.w$.lookAt([0,0,0,1],e.direction,e.up,ue.create()),s=ge.w$.multiply(t,i,ue.create());this.setTransform(s),this.hasMeshIncrements()||this.updateGraphics()}isMouseInside(){return this.highlightedId!==yi.ZJ||this.manipulatorButtons.highlightedId!==yi.ZJ}onMouseClick(e,t,i){this.trigger(HD,e.selectionId),es.Jq.AnalyticsService.trackEventForDocumentId("VIEW_CUBE_COMMAND","click_"+e.selectionId,(0,ia.n)()),WD.TOP===e.selectionId?this.viewer.animateToStandardView("XY"):WD.BOTTOM===e.selectionId?this.viewer.animateToStandardView("XYback"):WD.FRONT===e.selectionId?this.viewer.animateToStandardView("XZ"):WD.BACK===e.selectionId?this.viewer.animateToStandardView("XZback"):WD.RIGHT===e.selectionId?this.viewer.animateToStandardView("YZ"):WD.LEFT===e.selectionId?this.viewer.animateToStandardView("YZback"):zD(e.selectionId)&&this.viewer.animateToStandardView(e.selectionId),i.requestSelectedStatus=!1}onMouseEnter(e,t){this.highlightedId=e.selectionId,this.updateGraphics(),this.viewer.requestDraw()}onMouseLeave(e,t){this.highlightedId===e.selectionId&&(this.highlightedId=yi.ZJ,this.updateGraphics()),this.viewer.requestDraw()}onDragStart(e,t,i){i.requestDrag=!0,this.setDragStart(t)}onDrag(e,t){this.updateDragPosition(t)}setDragStart(e){this.dragStart=[e.mouseX,e.mouseY]}updateDragPosition(e){this.topRightCorner[0]+=e.mouseX-this.dragStart[0],this.topRightCorner[1]+=-(e.mouseY-this.dragStart[1]);const t=Math.abs(e.mouseX-this.dragStart[0])+Math.abs(e.mouseY-this.dragStart[1]);return this.setDragStart(e),this.manipulatorButtons.updateGraphics(),this.updateDropdownPosition(),this.viewer.requestDraw(),t}updateDropdownPosition(){if(this.dropdownButton){const e=(0,ns.x_)(),t=UD.getNumber("VIEW_CUBE_SCREEN_SIZE_PX");this.dropdownButton.position(-this.topRightCorner[0]/e,(-this.topRightCorner[1]+t)/e-this.dropdownButton.$el.height()+5)}}onDragStop(e,t){delete this.dragStart,this.viewer.requestDraw()}isViewManipulator(){return!0}}const fC=new Gi.hF({isPickable:!1,primitiveType:Ai.MX.LINES,isStencilWritten:!1,includedInBlend:!0}),IC="text",EC=X.default.getManager();class SC extends yi.u1{constructor(e,t,i){super(i),this.name=e,this.featureModel=t,this.minPlanePoint=null,this.maxPlanePoint=null,this.textTexture=null,this.planeMatrix=null,this.planeMatrixInverse=null,this.lineColor=EC.getColor("SKETCH_PLANE_LINE_COLOR"),this.textColor=EC.getColor("SKETCH_PLANE_TEXT_COLOR"),this.textMaterial=Hi(),this.textNodeProperties=new Gi.hF({isPickable:!1,isTwoSided:!0,primitiveType:Ai.MX.TRIANGLES,material:this.textMaterial}),this.onPlaneChange(),this.listenTo(t,"change:planeMatrix",this.onPlaneChange),this.listenTo(t,"change:hasRegenError",this.onRegenErrorChange)}remove(){this.destroyText(),this.textMaterial&&(this.textMaterial.destroy(),this.textMaterial=null),super.remove()}destroyText(){this.textTexture&&(this.textTexture.destroy(),this.textTexture=null)}onRegenErrorChange(){this.featureModel.getHasRegenError()===k.AAq.ERROR!==this.isHidden&&this.onPlaneChange()}onPlaneChange(){this.planeMatrix=null,this.planeMatrixInverse=null,this.destroyText(),this.minPlanePoint=null,this.maxPlanePoint=null;const e=this.featureModel.getHasRegenError()===k.AAq.ERROR;this.viewer.getSketch()&&!e?(this.planeMatrix=this.viewer.getSketch().getPlaneMatrix(),this.planeMatrixInverse=ge.w$.inverse(this.planeMatrix,ue.create()),this.show()):this.hide(),(0,Xs.vm)()}getEntityBoundsCenter(){const e=this.featureModel.parameters[0].getBtParameterForCurrentConfiguration();if(this.featureModel&&this.featureModel.parameters&&this.featureModel.parameters.length>0&&e.getIsAQueryList()&&!e.getIsEmptyQueryList()){const t=e.getQueryListItems()[0],i=t.getDeterministicIds();if(i&&i.length>0){const e=this.viewer.getModelViewManagers().getManager(),s=e.extractMeshIncrement(i[0]);if(s){let t=null;const n=e.getDisplayedElement();if(n instanceof kg){const e=(0,Me.cF)(i[0]);e&&(t=n.getBodyTransform(e.getBodyId(),this.viewer))}return t?ge.w$.multiplyVec3(t,s.getBounds().center()):s.getBounds().center()}const n=e.getMateConnectorGraphics(null,t.getFeatureId());if(n)return n.worldSpacePosition}}return null}hasBounds(){return!!this.minPlanePoint&&!!this.maxPlanePoint}updateBounds(e){if(!this.planeMatrix||this.hasBounds())return;const t=this.getEntityBoundsCenter();if(!t)return;let i=(0,wi.Oh)(t,this.planeMatrixInverse);const s=e.projectWorldPointToViewport(t);if(s[0]<e.getViewportLeft()||s[0]>=e.getViewportWidth()||s[1]<e.getViewportBottom()||s[1]>=e.getViewportHeight()){const t=e.viewportToCanvas([e.getViewportWidth()/2,e.getViewportHeight()/2,0]),s=e.getRay(t[0],t[1]),n=.258819,r=(0,wi.bZ)(s,this.planeMatrix,n);r&&(i=(0,wi.Oh)(r,this.planeMatrixInverse))}const n=e.getPixelSizeAtWorldPoint((0,wi.KU)(i,this.planeMatrix)),r=EC.getNumber("VIEWPORT_HEIGHT_TO_PLANE_HEIGHT_RATIO")*e.getViewportHeight()*n,a=r*EC.getNumber("PLANE_DEFAULT_WIDTH_HEIGHT_RATIO");this.minPlanePoint=[i[0]-a/2,i[1]-r/2],this.maxPlanePoint=[i[0]+a/2,i[1]+r/2];const o=(0,wi.KU)([this.minPlanePoint[0],this.minPlanePoint[1]],this.planeMatrix),h=(0,wi.KU)([this.maxPlanePoint[0],this.minPlanePoint[1]],this.planeMatrix),c=(0,wi.KU)([this.maxPlanePoint[0],this.maxPlanePoint[1]],this.planeMatrix),l=(0,wi.KU)([this.minPlanePoint[0],this.maxPlanePoint[1]],this.planeMatrix),d=(0,Yd.pf)([o,h,h,c,c,l,l,o]);(0,Yd.Ab)(this.lineColor,d),this.updateMeshIncrement("edges",yi.ZJ,d,fC)}updateText(e){if(!this.planeMatrix||!this.hasBounds())return;const t=this.getTextTexture(),i=(0,wi.KU)([this.minPlanePoint[0],this.minPlanePoint[1]],this.planeMatrix),s=(0,wi.KU)([this.maxPlanePoint[0],this.minPlanePoint[1]],this.planeMatrix),n=(0,wi.KU)([this.minPlanePoint[0],this.maxPlanePoint[1]],this.planeMatrix),r=ge.S4.subtract(s,i,M.create()),a=ge.S4.length(r);ge.S4.normalize(r);const o=ge.S4.subtract(n,i,M.create()),h=ge.S4.length(o);ge.S4.normalize(o);const c=1/e.getUnitSizeAtWorldPoint(n);let l=c*t.filledWidthPx,d=c*t.filledHeightPx;const u=c*EC.getNumber("PLANE_TEXT_MARGIN");if(l>a-2*u||d>h-2*u){const e=Math.min((a-2*u)/l,(h-2*u)/d);if(e<=0)return void this.removeMeshIncrement(IC);l*=e,d*=e}const g=ge.S4.add(n,ge.S4.scale(o,-u-d,M.create()),M.create());ge.S4.add(g,ge.S4.scale(r,u,M.create()));const p=ge.S4.add(g,ge.S4.scale(r,l,M.create()),M.create()),m=ge.S4.add(g,ge.S4.scale(o,d,M.create()),M.create());this.textMaterial.ambientTexture=t;const f=(0,Yd.fQ)(g,p,m,void 0,[t.leftCoordinate,t.bottomCoordinate],[t.rightCoordinate,t.topCoordinate]);this.updateMeshIncrement(IC,yi.ZJ,f,this.textNodeProperties)}getTextTexture(){return this.textTexture||(this.textTexture=jo(this.viewer,this.name,{color:this.textColor,font:EC.getString("PLANE_TEXT_FONT"),size:EC.getNumber("PLANE_TEXT_HEIGHT_PX"),paddingWithinBorder:EC.getNumber("PLANE_TEXT_BACKGROUND_PADDING")})),this.textTexture}onViewWillDraw(e,t){this.updateBounds(e),this.updateText(e)}onAppearanceConstantsUpdated(){this.lineColor=EC.getColor("SKETCH_PLANE_LINE_COLOR"),this.textColor=EC.getColor("SKETCH_PLANE_TEXT_COLOR"),this.onPlaneChange()}}const TC=X.default.getManager();class DC extends yi.u1{constructor(e,t,i,s){super(e,uh.Jh),this.pickPass=new ve(this.viewer),this.pickPass.setSceneGraph(this.getSceneGraph()),this.pointSizeConstantName=void 0!==t?t:"INFERENCE_POINT_SIZE_PX",this.lineWidthConstantName=void 0!==i?i:"INFERENCE_LINE_WIDTH_PX",this.pickRadiusConstantName=void 0!==s?s:"INFERENCE_PICK_RADIUS_PX",this.inferencePointMaterial=new Bi({color:TC.getColor("INFERENCE_DEBUG_POINT_COLOR"),pointSize:TC.getNumber(this.pointSizeConstantName)}),this.inferenceLineMaterial=new Bi({color:TC.getColor("INFERENCE_DEBUG_LINE_COLOR"),lineWidth:TC.getNumber(this.lineWidthConstantName)}),this.inferenceCurveMaterial=new Bi({base:TC.getColor("INFERENCE_DEBUG_CURVE_COLOR"),lineWidth:TC.getNumber(this.lineWidthConstantName)}),this.pointNodeProperties=new Gi.hF({primitiveType:Ai.MX.POINTS,isShowThrough:!0,isDepthTested:!1,material:this.inferencePointMaterial,priority:Gi.DO.HIGHER}),this.importantNodeProperties=new Gi.hF({primitiveType:Ai.MX.POINTS,isShowThrough:!0,isDepthTested:!1,material:this.inferencePointMaterial,priority:Gi.DO.HIGHEST}),this.linesNodeProperties=new Gi.hF({primitiveType:Ai.MX.INFINITE_LINES,isShowThrough:!0,isDepthTested:!1,material:this.inferenceLineMaterial,priority:Gi.DO.LOWER}),this.curvesNodeProperties=new Gi.hF({primitiveType:Ai.MX.LINES,isShowThrough:!0,isDepthTested:!1,material:this.inferenceCurveMaterial,priority:Gi.DO.DEFAULT}),this.pickRadius=TC.getNumber(this.pickRadiusConstantName),this.viewer.visualizeInferenceSceneGraph(this.getSceneGraph())}getSceneGraph(){return this.viewer.getSceneGraphs().getSceneGraph(uh.Jh)}onDevicePixelRatioChanged(e){this.pickRadius=TC.getNumber(this.pickRadiusConstantName),this.inferencePointMaterial.pointSize=TC.getNumber(this.pointSizeConstantName),this.inferenceLineMaterial.lineWidth=TC.getNumber(this.lineWidthConstantName),this.inferenceCurveMaterial.lineWidth=TC.getNumber(this.lineWidthConstantName)}remove(){super.remove(),this.viewer&&this.viewer.visualizeInferenceSceneGraph(null),this.inferencePointMaterial.destroy(),this.inferenceLineMaterial.destroy(),this.inferenceCurveMaterial.destroy()}setIncrementPickId(e,t){if(!t.pickId)throw"InferencePicker should be supplied increments that already have a pick id set"}pick(e,t){if(this.viewer){const i=this.pickInRect(e,t,this.pickRadius),s=i.length>0?i[0]:null;return s?s.primitiveId:Mi.JE}return Mi.JE}pickMultiple(e,t){if(this.viewer){const i=this.pickIteratively(e,t,this.pickRadius,TC.getNumber("MAXIMUM_INFERENCE_PICKS")).map((function(e){return e?e.primitiveId:Mi.JE}));return this.getHighestPriorityInferences(i)}return[]}pickInRect(e,t,i){if(!this.viewer.isReadyForDrawing())return[];const s=2*i+1,n=2*i+1,r=e-i,a=t-i;this.viewer.pushCameraState(),this.pickPass.setSceneGraph(this.getSceneGraph()),this.pickPass.setPickRect(r,a,s,n),this.pickPass.draw(this.viewer.getRenderContext()),this.viewer.popCameraState();const o=this.pickPass.gatherPicksFromPickPass(),h=[];for(const e in o){const t=o[e];for(const e in t)h.push(t[e])}return h.sort(cD.G)}pickIteratively(e,t,i,s){const n=[];let r,a,o=!1,h=0;for(;!(h>s);){const s=this.pickInRect(e,t,i);if(s.length<1)break;for(r=0;r<s.length;++r)a=s[r],a.fromPass=h,n.push(a);for(r=0;r<s.length;++r)this.hideIncrementFromPick(s[r].primitiveId.toString()),o=!0;++h}return o&&this.occurrenceData.resetHiddenFromPick(),n}getHighestPriorityInferences(e){if(0===e.length)return[];const t=[e[0]],i=this.getRenderOrderPriority(e[0]);for(let s=1;s<e.length;s++){const n=this.getRenderOrderPriority(e[s]);if(n<0)return t;if(n!==i)break;t.push(e[s])}return t}getMeshIncrementForPrimitiveId(e){const t=this.getInstantiatedMeshIncrement(e.toString());return t?t.meshIncrement:null}getRenderOrderPriority(e){const t=this.getInstantiatedMeshIncrement(e.toString());return t?t.nodeProperties.priority:-1}updateInference(e,t){const i=e.id;if(!i)return;let s=null;e.primitiveType===Ai.MX.POINTS?(s=t?this.importantNodeProperties:this.pointNodeProperties,(0,Yd.VQ)(TC.getNumber(this.pointSizeConstantName),e)):e.primitiveType===Ai.MX.INFINITE_LINES?(s=this.linesNodeProperties,(0,Yd.VQ)(TC.getNumber(this.lineWidthConstantName),e)):e.primitiveType===Ai.MX.LINES&&(s=this.curvesNodeProperties,(0,Yd.VQ)(TC.getNumber(this.lineWidthConstantName),e)),s&&this.updateMeshIncrement(i,i,e,s)}deleteInference(e){this.removeMeshIncrement(e)}resetInferences(){this.removeMeshIncrements()}}var CC=i(39371);const MC="boxId";class yC extends yi.u1{constructor(e,t,i,s,n,r,a,o){super(t),this.firstClashParentId=i,this.secondClashParentId=s,this.interferenceIndex=n,this.boundingBox=r,this.LINE_WIDTH=2.5,this.lineNodeProps=new Gi.hF({primitiveType:Ai.MX.LINES,isPickable:!0,isHighlightable:!0,isTwoSided:!0,isShowThrough:!1}),this.boxLineNodeProps=new Gi.hF({primitiveType:Ai.MX.LINES,isPickable:!1,isHighlightable:!0,isVisible:!1}),this.faceNodeProps=new Gi.hF({isPickable:!0,primitiveType:Ai.MX.TRIANGLE_STRIP}),this.interferenceIndex=n,this.selectionId=i+s+n,e.tessellation.forEach(((t,i)=>{const s=UE(t),n=e.appearance,r="id"+i;let a;if(s.primitiveType===Ai.MX.LINES){a=this.lineNodeProps,(0,Yd.VQ)(this.LINE_WIDTH,s);const e=BE(n,Ai.MX.LINES);(0,Yd.Ab)(e,s)}else if(s.primitiveType===Ai.MX.TRIANGLE_STRIP){a=this.faceNodeProps;const e=BE(n,Ai.MX.TRIANGLE_STRIP);(0,Yd.Ab)(e,s)}a&&(this.updateMeshIncrement(r,this.selectionId,s,a),this.viewer.getIsolatedOccurrenceManager()?.addIdsToIsolate([this.graphicsOccurrenceId],!0))})),this.boxIncrement=(0,Yd.U0)(this.boundingBox.minCorner.getVec3(),this.boundingBox.maxCorner.getVec3()).createTransformed(a.getGlMatrix()),o&&this.setTransform(o.getGlMatrix())}getSelectionId(){return this.selectionId}remove(){this.viewer.getIsolatedOccurrenceManager()?.removeFromIsolate([this.graphicsOccurrenceId]),super.remove()}getModelSelection(){return new CC.Y(k.lQt.TEMPORARY_GEOMETRY,this.selectionId)}processResetSelection(e){e===Cn.o2.SECONDARY&&this.boxIncrement&&this.removeMeshIncrement(MC),this.removeHighlightFromOccurrence(e)}processAddSelection(e,t){this.selectionId===e&&(t===Cn.o2.SECONDARY&&this.boxIncrement&&this.updateMeshIncrement(MC,this.selectionId,this.boxIncrement,this.boxLineNodeProps),this.addNewHighlightToOccurrence(t))}processRemoveSelection(e,t){this.selectionId===e&&this.removeHighlightFromOccurrence(t)}}class AC extends yi.u1{constructor(e,t,i,s,n,r){super(n,r);const a=(0,Yd.fQ)(e,t,i);this.updateMeshIncrement("quad",yi.ZJ,a,s)}}const PC=_e.O.createLogger("AnimationController",k.bVy.GRAPHICS);class OC{constructor(e){this.viewer=e,this.cameraAnimationCallback=null,this.animationLoopInProgress=!1,this.animationSequenceCounter=0,this.animationSequenceStartTime=0,this.animationSequenceFrameCount=0,this.frameCallback=e=>this.onRequestDrawFulfilled(e),this.ongoingAnimations=new Set,this.incrementAnimationSequence()}onRequestDrawFulfilled(e){if(this.viewer.isOngoingRenderLoopRunning)return;const t=this.advanceAnimation(e);this.viewer.draw(t?e:void 0)}advanceAnimation(e){if(!this.animationLoopInProgress)return!1;let t=!1;if(this.cameraAnimationCallback){this.cameraAnimationCallback(e)===Jn.Z.COMPLETE?this.cameraAnimationCallback=null:t=!0}for(const i of this.ongoingAnimations.values()){i(e)===Jn.Z.COMPLETE?this.ongoingAnimations.delete(i):t=!0}if(t)this.viewer.setSystemIsAnimating(),this.viewer.isOngoingRenderLoopRunning||this.viewer.requestDraw(this.frameCallback),++this.animationSequenceFrameCount;else if(this.animationLoopInProgress=!1,this.incrementAnimationSequence(),this.viewer.setSuppressMouseMovePick(!1),this.viewer.isOngoingRenderLoopRunning||this.viewer.getInputHandler().isMouseInCanvas()&&this.viewer.doPreHighlightPick(),this.animationSequenceFrameCount>0){const e=(this.animationSequenceFrameCount/((0,Xs.Es)(this.animationSequenceStartTime)/1e3)).toFixed(1);PC.trace("Animation completed with average framerate of "+e+" fps")}return t}requestAnimationFrameIfNeeded(){this.animationLoopInProgress&&!this.viewer.isOngoingRenderLoopRunning&&this.viewer.requestDraw(this.frameCallback)}startCameraAnimation(e){this.haltCameraAnimation(),this.cameraAnimationCallback=e,this.startAnimationRenderLoop()}isCameraAnimating(){return!!this.cameraAnimationCallback}haltCameraAnimation(){this.cameraAnimationCallback=null}startAnimation(e){this.ongoingAnimations.add(e),this.startAnimationRenderLoop()}incrementAnimationSequence(){this.viewer.$el.attr("animation-sequence",++this.animationSequenceCounter)}startAnimationRenderLoop(){this.animationLoopInProgress||(this.viewer.setSuppressMouseMovePick(!0),this.viewer.setSystemIsAnimating(),this.viewer.isOngoingRenderLoopRunning||this.viewer.requestDraw(this.frameCallback),this.animationLoopInProgress=!0,this.animationSequenceStartTime=(0,Xs.Wj)(),this.animationSequenceFrameCount=0)}}class RC{constructor(e,t){this.timeBudget=e,this.vertexBudget=t,this.startTime=0,this.verticesSpent=0}addVertexCost(e){this.verticesSpent+=e}reset(){this.startTime=(0,Xs.Wj)(),this.verticesSpent=0}budgetExceeded(){return this.verticesSpent>this.vertexBudget||(0,Xs.Es)(this.startTime)>this.timeBudget}}const wC=new RC(X.default.getManager().getNumber("GRAPHICS_TASK_SMALL_INTERACTIVE_TIME_BUDGET"),X.default.getManager().getNumber("GRAPHICS_TASK_SMALL_INTERACTIVE_VERTEX_BUDGET")),vC=new RC(X.default.getManager().getNumber("GRAPHICS_TASK_MEDIUM_INTERACTIVE_TIME_BUDGET"),X.default.getManager().getNumber("GRAPHICS_TASK_MEDIUM_INTERACTIVE_VERTEX_BUDGET"));class _C{constructor(){this.tasks=[]}addTask(e,t){this.tasks.push({task:e,budget:t})}processWithBudget(e){e&&e.reset();for(let t=0;t<this.tasks.length&&(!e||!e.budgetExceeded());++t)this.tasks[t].task.process(e)}processInteractively(){let e=null;for(let t=0;t<this.tasks.length;++t)if(this.tasks[t].task.hasPendingWork()){e=this.tasks[t].budget;break}e&&this.processWithBudget(e)}complete(){this.processWithBudget(null)}hasPendingWork(){for(let e=0;e<this.tasks.length;++e)if(this.tasks[e].task.hasPendingWork())return!0;return!1}}var NC=i(57702);const bC=_e.O.createLogger("webglproxy",k.bVy.GRAPHICS);class LC{constructor(e){this.gl=e;for(const t in this.gl)"gl"!==t&&("function"==typeof e[t]?t in this||(this[t]=function(e,t,i){return function(){return i.apply(e,arguments)}}(this.gl,0,this.gl[t])):function(e,t){e[t]=e.gl[t]}(this,t))}apply(){}printState(){bC.debug("BLEND \t\t"+this.gl.isEnabled(this.gl.BLEND)),bC.debug("CULL_FACE \t\t"+this.gl.isEnabled(this.gl.CULL_FACE)),bC.debug("DEPTH_TEST \t\t"+this.gl.isEnabled(this.gl.DEPTH_TEST)),bC.debug("DITHER \t\t"+this.gl.isEnabled(this.gl.DITHER)),bC.debug("POLYGON_OFFSET_FILL \t\t"+this.gl.isEnabled(this.gl.POLYGON_OFFSET_FILL)),bC.debug("SAMPLE_ALPHA_TO_COVERAGE \t\t"+this.gl.isEnabled(this.gl.SAMPLE_ALPHA_TO_COVERAGE)),bC.debug("SAMPLE_COVERAGE \t\t"+this.gl.isEnabled(this.gl.SAMPLE_COVERAGE)),bC.debug("SCISSOR_TEST \t\t"+this.gl.isEnabled(this.gl.SCISSOR_TEST)),bC.debug("STENCIL_TEST \t\t"+this.gl.isEnabled(this.gl.STENCIL_TEST)),bC.debug("\n")}}class FC{constructor(e,t){this.callCounts={},t=void 0!==t&&t,this.gl=e;for(const i in this.gl)"gl"!==i&&"callCounts"!==i&&"printCallStats"!==i&&("function"==typeof e[i]?i in this||(this[i]=((e,i,s)=>()=>(t&&(i in this.callCounts?this.callCounts[i]++:this.callCounts[i]=1),bC.debug(s.toString()),s.apply(e,arguments)))(this.gl,i,this.gl[i])):function(e,t){e[t]=e.gl[t]}(this,i))}printCallStats(){let e=[];for(const t in this.callCounts)e.push([t,this.callCounts[t]]);e=e.sort((function(e,t){return t[1]-e[1]}));for(const t in e)bC.debug(e[t][0]+" "+e[t][1])}}class xC extends LC{constructor(e){super(e),this.nextId=1,this.uniqueIds=new Map}assignNextId(e){e.tempId=this.nextId,this.uniqueIds.set(e,this.nextId),this.nextId++}createProgram(){const e=this.gl.createProgram();return this.assignNextId(e),e}}class BC extends LC{constructor(e){super(new xC(e)),this.currentProgram=null,this.programFlags=[],this.programNames={},this.programSources=[]}getProgramFlags(){return this.programFlags}setProgramFlags(e){this.programFlags=e}onlyProgram(e){for(let t=0;t<this.programFlags.length;t++)this.programFlags[t]=e===t}allButProgram(e){for(let t=0;t<this.programFlags.length;t++)this.programFlags[t]=e!==t}allPrograms(){for(let e=0;e<this.programFlags.length;e++)this.programFlags[e]=!0}noPrograms(){for(let e=0;e<this.programFlags.length;e++)this.programFlags[e]=!1}createProgram(e){const t=super.createProgram();return this.programNames[t.tempId]=e,t}useProgram(e){this.currentProgram=e,this.gl.useProgram(e),e.tempId in this.programFlags||(this.programFlags[e.tempId]=!0)}drawArrays(e,t,i){this.programFlags[this.currentProgram.tempId]&&this.gl.drawArrays(e,t,i)}drawElements(e,t,i,s){this.programFlags[this.currentProgram.tempId]&&this.gl.drawElements(e,t,i,s)}}class VC extends LC{constructor(e,t,i){super(e),this.numChanges=t,this.numRepeats=i}enable(e){this.gl.enable(e);for(let t=0;t<this.numChanges;t++)this.gl.disable(e),this.gl.enable(e);for(let t=0;t<this.numRepeats;t++)this.gl.enable(e)}disable(e){this.gl.disable(e);for(let t=0;t<this.numChanges;t++)this.gl.enable(e),this.gl.disable(e);for(let t=0;t<this.numRepeats;t++)this.gl.disable(e)}enableVertexAttribArray(e){this.gl.enableVertexAttribArray(e);for(let t=0;t<this.numChanges;t++)this.gl.disableVertexAttribArray(e),this.gl.enableVertexAttribArray(e);for(let t=0;t<this.numRepeats;t++)this.gl.enableVertexAttribArray(e)}disableVertexAttribArray(e){this.gl.disableVertexAttribArray(e);for(let t=0;t<this.numChanges;t++)this.gl.enableVertexAttribArray(e),this.gl.disableVertexAttribArray(e);for(let t=0;t<this.numRepeats;t++)this.gl.disableVertexAttribArray(e)}useProgram(e){this.gl.useProgram(e);for(let t=0;t<this.numChanges;t++)this.gl.useProgram(null),this.gl.useProgram(e);for(let t=0;t<this.numRepeats;t++)this.gl.useProgram(e)}activeTexture(e){this.gl.activeTexture(e);for(let t=0;t<this.numChanges;t++)this.gl.activeTexture(this.gl.TEXTURE25),this.gl.activeTexture(e);for(let t=0;t<this.numRepeats;t++)this.gl.activeTexture(e)}bindTexture(e,t){this.gl.bindTexture(e,t);for(let i=0;i<this.numChanges;i++)this.gl.bindTexture(e,null),this.gl.bindTexture(e,t);for(let i=0;i<this.numRepeats;i++)this.gl.bindTexture(e,t)}}class UC extends LC{constructor(e,t,i){super(e),this.numChanges=t,this.numRepeats=i;const s=e=>()=>{e.apply(this.gl,arguments);for(let t=0;t<this.numRepeats;t++)e.apply(this.gl,arguments)},n=this;for(let e=1;e<=4;e++)NC.each(["f","i","fv","iv"],(function(t,i){let r="uniform"+e+i;n[r]=s(n.gl[r]),e>1&&(r="uniformMatrix"+e+i,n[r]=s(n.gl[r]))}));for(let e=1;e<=4;e++)NC.each(["f","fv"],(function(t,i){const r="vertexAttrib"+e+i;n[r]=s(n.gl[r])}))}}class HC extends LC{constructor(e){super(e),this.programUniforms=[],this.attributes=[],this.state=new Map,this.attribarraystate=new Map,this.currentProgram=e.getParameter(e.CURRENT_PROGRAM),this.currentProgramSent=e.getParameter(e.CURRENT_PROGRAM),this.activeTextureUnit=e.getParameter(e.ACTIVE_TEXTURE),this.activeTextureUnitSent=e.getParameter(e.ACTIVE_TEXTURE),this.textureUnits=new Map}getUniformLocation(e,t){const i=this.gl.getUniformLocation(e,t),s=this.programUniforms[e.tempId].length;return i&&(i.tempId=s,this.programUniforms[e.tempId][i.tempId]=null),i}apply(){this.applyProgram(),this.applyAttributes()}applyProgram(){this.currentProgramSent!==this.currentProgram&&(this.gl.useProgram(this.currentProgram),this.currentProgramSent=this.currentProgram);const e=this.programUniforms[this.currentProgram.tempId];if(e)for(let t=0;t<e.length;t++){const i=e[t];if(i){if(i[2])continue;const e=i[0],t=i[1];e.apply(this.gl,t),i[2]=!0}}}applyAttributes(){for(let e=0;e<this.attributes.length;e++){const t=this.attributes[e];if(t){if(t[2])continue;const e=t[0],i=t[1];e.apply(this.gl,i),t[2]=!0}}}createProgram(){const e=this.gl.createProgram();return this.programUniforms[e.tempId]=[],e}useProgram(e){this.currentProgram=e}deleteProgram(e){return this.gl.deleteProgram(e)}getCurrentProgramUniforms(){let e=this.programUniforms[this.currentProgram.tempId];return e||(e=[],this.programUniforms[this.currentProgram.tempId]=e),e}uniform1f(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform1f,n[2]=n[2]&&n[1][1]===t,n[1][1]=t):i[s]=[this.gl.uniform1f,[e,t],!1]}uniform1i(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform1i,n[2]=n[2]&&n[1][1]===t,n[1][1]=t):i[s]=[this.gl.uniform1i,[e,t],!1]}uniform2f(e,t,i){const s=this.getCurrentProgramUniforms(),n=e.tempId,r=s[n];r&&r[1].length===arguments.length?(r[0]=this.gl.uniform2f,r[2]=r[2]&&r[1][1]===t&&r[1][2]===i,r[1][1]=t,r[1][2]=i):s[n]=[this.gl.uniform2f,[e,t,i],!1]}uniform2i(e,t,i){const s=this.getCurrentProgramUniforms(),n=e.tempId,r=s[n];r&&r[1].length===arguments.length?(r[0]=this.gl.uniform2i,r[2]=r[2]&&r[1][1]===t&&r[1][2]===i,r[1][1]=t,r[1][2]=i):s[n]=[this.gl.uniform2i,[e,t,i],!1]}uniform3f(e,t,i,s){const n=this.getCurrentProgramUniforms(),r=e.tempId,a=n[r];a&&a[1].length===arguments.length?(a[0]=this.gl.uniform3f,a[2]=a[2]&&a[1][1]===t&&a[1][2]===i&&a[1][3]===s,a[1][1]=t,a[1][2]=i,a[1][3]=s):n[r]=[this.gl.uniform3f,[e,t,i,s],!1]}uniform3i(e,t,i,s){const n=this.getCurrentProgramUniforms(),r=e.tempId,a=n[r];a&&a[1].length===arguments.length?(a[0]=this.gl.uniform3i,a[2]=a[2]&&a[1][1]===t&&a[1][2]===i&&a[1][3]===s,a[1][1]=t,a[1][2]=i,a[1][3]=s):n[r]=[this.gl.uniform3i,[e,t,i,s],!1]}uniform4f(e,t,i,s,n){const r=this.getCurrentProgramUniforms(),a=e.tempId,o=r[a];o&&o[1].length===arguments.length?(o[0]=this.gl.uniform4f,o[2]=o[2]&&o[1][1]===t&&o[1][2]===i&&o[1][3]===s&&(o[1][4]=n),o[1][1]=t,o[1][2]=i,o[1][3]=s,o[1][4]=n):r[a]=[this.gl.uniform4f,[e,t,i,s,n],!1]}uniform4i(e,t,i,s,n){const r=this.getCurrentProgramUniforms(),a=e.tempId,o=r[a];o&&o[1].length===arguments.length?(o[0]=this.gl.uniform4i,o[2]=o[2]&&o[1][1]===t&&o[1][2]===i&&o[1][3]===s&&(o[1][4]=n),o[1][1]=t,o[1][2]=i,o[1][3]=s,o[1][4]=n):r[a]=[this.gl.uniform4i,[e,t,i,s,n],!1]}uniform1fv(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform1fv,n[2]=n[2]&&(0,Qs.Z)(n[1][1],t),n[1][1]=t):i[s]=[this.gl.uniform1fv,[e,t],!1]}uniform1iv(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform1iv,n[2]=n[2]&&(0,Qs.Z)(n[1][1],t),n[1][1]=t):i[s]=[this.gl.uniform1iv,[e,t],!1]}uniform2fv(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform2fv,n[2]=n[2]&&(0,Qs.Z)(n[1][1],t),n[1][1]=t):i[s]=[this.gl.uniform2fv,[e,t],!1]}uniform2iv(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform2iv,n[2]=n[2]&&(0,Qs.Z)(n[1][1],t),n[1][1]=t):i[s]=[this.gl.uniform2iv,[e,t],!1]}uniform3fv(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform3fv,n[2]=n[2]&&(0,Qs.Z)(n[1][1],t),n[1][1]=t):i[s]=[this.gl.uniform3fv,[e,t],!1]}uniform3iv(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform3iv,n[2]=n[2]&&(0,Qs.Z)(n[1][1],t),n[1][1]=t):i[s]=[this.gl.uniform3iv,[e,t],!1]}uniform4fv(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform4fv,n[2]=n[2]&&(0,Qs.Z)(n[1][1],t),n[1][1]=t):i[s]=[this.gl.uniform4fv,[e,t],!1]}uniform4iv(e,t){const i=this.getCurrentProgramUniforms(),s=e.tempId,n=i[s];n&&n[1].length===arguments.length?(n[0]=this.gl.uniform4iv,n[2]=n[2]&&(0,Qs.Z)(n[1][1],t),n[1][1]=t):i[s]=[this.gl.uniform4iv,[e,t],!1]}uniformMatrix2fv(e,t,i){const s=this.getCurrentProgramUniforms(),n=e.tempId,r=s[n];r&&r[1].length===arguments.length?(r[0]=this.gl.uniformMatrix2fv,r[2]=r[2]&&r[1][1]===t&&(0,Qs.Z)(r[1][2],i),r[1][1]=t,r[1][2]=i):s[n]=[this.gl.uniformMatrix2fv,[e,t,i],!1]}uniformMatrix3fv(e,t,i){const s=this.getCurrentProgramUniforms(),n=e.tempId,r=s[n];r&&r[1].length===arguments.length?(r[0]=this.gl.uniformMatrix3fv,r[2]=r[2]&&r[1][1]===t&&(0,Qs.Z)(r[1][2],i),r[1][1]=t,r[1][2]=i):s[n]=[this.gl.uniformMatrix3fv,[e,t,i],!1]}uniformMatrix4fv(e,t,i){const s=this.getCurrentProgramUniforms(),n=e.tempId,r=s[n];r&&r[1].length===arguments.length?(r[0]=this.gl.uniformMatrix4fv,r[2]=r[2]&&r[1][1]===t&&(0,Qs.Z)(r[1][2],i),r[1][1]=t,r[1][2]=i):s[n]=[this.gl.uniformMatrix4fv,[e,t,i],!1]}vertexAttrib1f(e,t){const i=this.attributes[e];i&&i[1].length===arguments.length?(i[0]=this.gl.vertexAttrib1f,i[2]=i[2]&&i[1][1]===t,i[1][1]=t):this.attributes[e]=[this.gl.vertexAttrib1f,[e,t],!1]}vertexAttrib2f(e,t,i){const s=this.attributes[e];s&&s[1].length===arguments.length?(s[0]=this.gl.vertexAttrib2f,s[2]=s[2]&&s[1][1]===t&&s[1][2]===i,s[1][1]=t,s[1][2]=i):this.attributes[e]=[this.gl.vertexAttrib2f,[e,t,i],!1]}vertexAttrib3f(e,t,i,s){const n=this.attributes[e];n&&n[1].length===arguments.length?(n[0]=this.gl.vertexAttrib3f,n[2]=n[2]&&n[1][1]===t&&n[1][2]===i&&n[1][3]===s,n[1][1]=t,n[1][2]=i,n[1][3]=s):this.attributes[e]=[this.gl.vertexAttrib3f,[e,t,i,s],!1]}vertexAttrib4f(e,t,i,s,n){const r=this.attributes[e];r&&r[1].length===arguments.length?(r[0]=this.gl.vertexAttrib4f,r[2]=r[2]&&r[1][1]===t&&r[1][2]===i&&r[1][3]===s&&r[1][4]===n,r[1][1]=t,r[1][2]=i,r[1][3]=s,r[1][4]=n):this.attributes[e]=[this.gl.vertexAttrib4f,[e,t,i,s,n],!1]}vertexAttrib1fv(e,t){const i=this.attributes[e];i&&i[1].length===arguments.length?(i[0]=this.gl.vertexAttrib1fv,i[2]=i[2]&&(0,Qs.Z)(i[1][1],t),i[1][1]=t):this.attributes[e]=[this.gl.vertexAttrib1fv,[e,t],!1]}vertexAttrib2fv(e,t){const i=this.attributes[e];i&&i[1].length===arguments.length?(i[0]=this.gl.vertexAttrib2fv,i[2]=i[2]&&(0,Qs.Z)(i[1][1],t),i[1][1]=t):this.attributes[e]=[this.gl.vertexAttrib2fv,[e,t],!1]}vertexAttrib3fv(e,t){const i=this.attributes[e];i&&i[1].length===arguments.length?(i[0]=this.gl.vertexAttrib3fv,i[2]=i[2]&&(0,Qs.Z)(i[1][1],t),i[1][1]=t):this.attributes[e]=[this.gl.vertexAttrib3fv,[e,t],!1]}vertexAttrib4fv(e,t){const i=this.attributes[e];i&&i[1].length===arguments.length?(i[0]=this.gl.vertexAttrib4fv,i[2]=i[2]&&(0,Qs.Z)(i[1][1],t),i[1][1]=t):this.attributes[e]=[this.gl.vertexAttrib4fv,[e,t],!1]}drawArrays(e,t,i){this.apply(),this.gl.drawArrays(e,t,i)}drawElements(e,t,i,s){this.apply(),this.gl.drawElements(e,t,i,s)}}var GC=i(44470),kC=i(42812);class WC extends m.T{isForIsolate(){return!this.isForMakeTransparent()}translucentModeNotValid(){return!this.currentRenderModeSupportsTranslucentMode&&(this.showTranslucentModeWarning(),this.requestedTranslucentMode=!0,this.viewer.requestDraw(),!0)}setRenderingMode(e){const{renderModeSupported:t,renderModeExitsEffect:i}=this.renderModeSupportsTranslucentMode(e);i||(this.currentRenderModeSupportsTranslucentMode=t,this.isTranslucentModeEnabled&&!this.currentRenderModeSupportsTranslucentMode?(this.disableTranslucentMode(!1,!1),this.showTranslucentModeWarning()):this.isolatedOccurrencesManager.isInIsolateOrMakeTransparentMode()&&this.requestedTranslucentMode&&this.currentRenderModeSupportsTranslucentMode&&this.updateTranslucencyState())}updateTranslucencyState(){const e=this.opacitySliderValue;if(this.viewer.isolateContextFiltersTranslucentOccurrences=!0,e<=GC.F1.transparencyCap)this.disableTranslucentMode();else if(e<=GC.F1.transitionCap){if(this.translucentModeNotValid())return;this.viewer.isolateContextFiltersTranslucentOccurrences=!1;const t=(0,wi.KK)(e,GC.F1.transparencyCap,GC.F1.transitionCap)/100,i=1-t;this.viewer.isolateContextFaceTransparency=this.startingFaceTransparency*i,this.viewer.isolateContextEdgeTransparency=this.startingEdgeTransparency*i,this.viewer.setTranslucentModeFaceOpacity(t*this.startingFaceTranslucency),this.viewer.setTranslucentModeEdgeOpacity(t*this.startingEdgeTranslucency),this.enableTranslucentMode(),this.isInPickingMode=!1}else if(e<=GC.F1.visibilityCap){if(this.translucentModeNotValid())return;const t=(100-(0,wi.IH)(e,GC.F1.transitionCap+1,GC.F1.visibilityCap))/100,i=(100-(0,wi.IH)(e,GC.F1.transitionCap+1,GC.F1.visibilityCap))/100;this.viewer.setTranslucentModeFaceOpacity(this.startingFaceTranslucency*i),this.viewer.setTranslucentModeEdgeOpacity(this.startingEdgeTranslucency*t),this.enableTranslucentMode(),this.isInPickingMode=this.getEnableSelectionDesire()}else this.disableTranslucentMode();this.viewer.requestDraw()}showTranslucentModeWarning(){es.Jq.MessageBubbleService.showMessageWithAutoDismiss(i18n("Internal geometry not shown in current graphics mode"))}enableTranslucentMode(){this.requestedTranslucentMode=!0,this.isTranslucentModeEnabled||(this.isTranslucentModeEnabled=!0,this.updateTranslucencyState(),this.viewer.mainDrawPass.setDrawNonIsolatedByOITPass(!0),this.refreshTranslucentOccurrences())}disableTranslucentMode(e,t=!0){this.requestedTranslucentMode=!t&&this.requestedTranslucentMode,this.isTranslucentModeEnabled&&(this.isTranslucentModeEnabled=!1,this.isInPickingMode=!1,this.viewer.mainDrawPass.setDrawNonIsolatedByOITPass(!1),this.refreshTranslucentOccurrences(),e||this.refreshTranslucentOccurrences())}isDialogOpen(){return!!this.dialog&&(0,ss.Xt)().getIsPanelOpen(this.dialog.getPanelId())}constructor(e,t){if(super(),this.viewer=e,this.isolatedOccurrencesManager=t,this.affectedOccurrenceIds=[],this.centersOfInitialAffectedInstances=null,this.degreeOfDistance=0,this.degreeOfConnectivity=-1,this.isPersistentModeEnabled=!1,this.dialog=null,this.newDialogEnabled=es.Jq.CapabilitiesService.checkNewIsolateDialogCurrentlyEnabled(),this.setRenderingMode(this.viewer.getRenderingMode()),this.setUpListeners(),es.Jq.CapabilitiesService.checkNewIsolateDialogCurrentlyEnabled()){const e=X.default.getManager();this.startingFaceTransparency=e.getNumber("ISOLATE_CONTEXT_FACE_TRANSPARENCY"),this.startingEdgeTransparency=e.getNumber("ISOLATE_CONTEXT_EDGE_TRANSPARENCY"),this.startingFaceTranslucency=e.getNumber("MAX_ISOLATE_FACE_TRANSLUCENCY"),this.startingEdgeTranslucency=e.getNumber("MAX_ISOLATE_EDGE_TRANSLUCENCY")}}destroy(){this.dialog&&(this.dialog.destroy(),this.dialog=null),this.stopListening()}setIsIsolateFullyTransparent(e){this.viewer.getViewerPreferences().isolateHideTransparent!==e&&(es.Jq.UserSettingsService.updateIsolateHideTransparent(e?"true":"false"),this.viewer.getViewerPreferences().isolateHideTransparent=e,this.triggerIsolateFullyTransparentChangeEvent())}getIsolatedOccurrenceManager(){return this.isolatedOccurrencesManager}triggerIsolateFullyTransparentChangeEvent(){this.isolatedOccurrencesManager.onIsIsolateFullyTransparentChanged(),this.viewer.requestDraw()}setIsIsolateFullyTransparentAsDefault(){this.viewer.getViewerPreferences().isolateHideTransparent=!0}getIsIsolateFullyTransparent(){return(this.newDialogEnabled?this.opacitySliderValue>GC.F1.visibilityCap:this.viewer.getViewerPreferences().isolateHideTransparent)&&this.getIsolatedOccurrenceManager().isInIsolateOrMakeTransparentMode()}clearEffectNoAnimation(){this.hasAffectedInstances()&&(this.clearEffect(),this.viewer.onIsolateChanged(),(0,Xs.vm)()),this.dialog&&(this.dialog.destroy(),this.dialog=null)}clearEffect(){this.isTranslucentModeEnabled&&this.disableTranslucentMode(!0)}clearEffectExit(e){if(this.viewer!==e)return;let t=!0;this.currentRenderModeSupportsAnimation()?this.hasAffectedInstances()&&(t=!1,this.viewer.animateIsolation(!1,(()=>{this.destroyDialog(),this.clearEffect(),this.viewer.onIsolateChanged(),(0,Xs.vm)()}))):this.clearEffectNoAnimation(),t&&this.destroyDialog(),this.degreeOfConnectivity=-1,this.degreeOfDistance=0}destroyDialog(){this.dialog&&(this.dialog.destroy(),this.dialog=null)}currentRenderModeSupportsAnimation(){return!(this.viewer.getRenderingMode()===k.P1.TRANSLUCENT)}getModelViewManager(){return this.viewer.getModelViewManagers().getManager()}getPreviewViewManager(){return this.viewer.getModelViewManagers().getPreviewManager()}hasAffectedInstances(){return this.affectedOccurrenceIds.length>0}addIdsToAffect(e,t){if(this.hasAffectedInstances()||t){let t=!1;for(let i=0;i<e.length;i++)this.affectedOccurrenceIds.indexOf(e[i])<0&&(this.affectedOccurrenceIds.push(e[i]),t=!0);t&&this.updateOccurrenceManagerAndPreviewBoundingBoxes()}}removeFromEffect(e){if(this.hasAffectedInstances()){let t=!1;for(let i=0;i<e.length;i++){const s=this.affectedOccurrenceIds.indexOf(e[i]);s>-1&&(this.affectedOccurrenceIds.splice(s,1),t=!0)}t&&this.updateOccurrenceManagerAndPreviewBoundingBoxes()}}makeTransparent(e,t){const i=t?function(){const e=(0,Sh.uQ)();e.setSuppressMouseMovePick(!1),e.getInputHandler().isMouseInCanvas()&&e.doPreHighlightPick()}:()=>{};e&&this.currentRenderModeSupportsAnimation()?this.viewer.animateIsolation(!0):(Qe(1),this.viewer.requestDraw((()=>{this.viewer.getAnimationController().incrementAnimationSequence(),i()})))}getSelectionFromNodeModelOrSelection(e){return sM.getSelectionFromNodeModelOrSelection(e,this.viewer)}setAffectedOccurrenceIds(e){this.affectedOccurrenceIds=e,this.updateOccurrenceManagerAndPreviewBoundingBoxes()}isIsolateInEffectMode(){return this.dialog&&this.isForIsolate()||this.isolatedOccurrencesManager.initializingDialog===kC.P.ISOLATE||this.isPersistentModeEnabled}isMakeTransparentInEffectMode(){return this.dialog&&this.isForMakeTransparent()||this.isolatedOccurrencesManager.initializingDialog===kC.P.MAKE_TRANSPARENT||this.isPersistentModeEnabled}isWithinDistanceOfAnInitialAffectedOccurrence(e,t){const i=this.getModelViewManager().getOccurrenceBounds(t);return!!i&&this.isBoundsWithinDistanceOfInitialAffectedInstances(i,e)}isBoundsWithinDistanceOfInitialAffectedInstances(e,t){const i=e.center();return this.isPointWithinDistanceOfInitialAffectedInstances(i,t)}isPointWithinDistanceOfInitialAffectedInstances(e,t){for(const i of this.centersOfInitialAffectedInstances){if(ge.S4.distanceSquared(i,e)<t)return!0}return!1}expandEffectByProximity(e){this.degreeOfDistance=e}getMinDistanceSquaredFromInitialAffectedInstanceToCenterOfModel(){let e=1/0;const t=this.getModelBoundsForEffect();if(t){const i=t.center();this.updateCentersOfInitialAffectedInstances();const s=this.centersOfInitialAffectedInstances.map((function(e){return ge.S4.distanceSquared(e,i)}));e=Math.min(...s)}return e}getModelBoundsForEffect(){return this.viewer.getModelBounds()}expandEffectByConnectivity(e){return this.degreeOfConnectivity=e,!1}affectOccurrences(e,t,i){}updateOccurrenceManagerAndPreviewBoundingBoxes(){this.updateOccurrenceDataManager(),this.updatePreviewBoundingBoxes(),this.viewer.onIsolateChanged()}updatePreviewBoundingBoxes(){this.viewer.getBodyManager().refreshReducedDetailBoxes()}clearAffectedOccurrenceIdsNoGraphicsUpdate(){this.affectedOccurrenceIds=[]}renderModeSupportsTranslucentMode(e){let t,i;switch(e){case k.P1.SHADED_WITH_EDGES:case k.P1.SHADED_WITHOUT_EDGES:case k.P1.SHADED_WITH_HIDDEN_EDGES:case k.P1.TRANSLUCENT:t=!0,i=!1;break;case k.P1.SIMULATION_RESULTS:t=!1,i=!0;break;default:t=!1,i=!1}return{renderModeSupported:t,renderModeExitsEffect:i}}}var zC=i(99720),XC=i(19354);const ZC=function(e){return e.getPathAsString()};function qC(e,t,i,s,n,r){const a=new Map;function o(e){const t=e.trimToTopLevel();return a.set(t.getPathAsString(),t),!1}Array.isArray(e)?e.forEach(o):e&&e.each(o);for(const e of a.values()){const a=t.getOccurrencesStartingWithPath(e);for(let e=0;e<a.length;++e){const t=a[e].getPathAsString(),o=!i.has(t),h=r.isForMakeTransparent()?o:!o,c=a[e];o&&(i.set(t,c),s.set(t,c)),h&&r.isTranslucentModeEnabled&&n.delete(c)}}}class YC extends WC{getSeedPartOrOccurrenceIds(){return this.initialAffectedOccurrences}getAffectedPartOrOccurrenceIds(){return this.affectedOccurrences}refreshTranslucentOccurrences(e=[],t){const i=this.getModelViewManager().getDisplayedAssembly();if(!i)return;const s=[...t?[]:this.getOccurrencesWithAffectedGraphics(),...e];for(const e of s){const t=i.getBodyComponent(e),s=this.viewer.getIdForOccurrence(e);t?.refreshOccurrence(s)}this.viewer.requestDraw()}resetAffectWithIsolatableIds(e){this.affectOccurrences(e,tM.INITIAL)}constructor(e,t){super(e,t),this.initialAffectedOccurrences=[],this.affectedOccurrences=[],this.setSeedComponentsNull()}setUpListeners(){this.stopListening(),this.listenTo(this.viewer.getEventDispatcher(),nM.hj,this.onAssemblyDataProcessed)}setSeedComponentsNull(){this.nodeModelOrSelection=null,this.includeSelections=!1,this.initialSelectionList=null}onAssemblyDataProcessed(){this.hasAffectedInstances()&&(0,gt._R)()&&(this.affectedOccurrencesPreUpdate=this.isForMakeTransparent()?[...this.affectedOccurrences]:[],this.updateNodeModelOrSelection(),this.reAffectComponents(tM.ASSEMBLY_DATA_UPDATE,!1))}setIsolationForRelatedGraphics(e,t){const i=this.getModelViewManager().getDisplayedAssembly();if(i)for(const s of e){const e=i.getMateConnectorGraphicsForOccurrence(s,false);for(let i=0;i<e.length;i++)e[i].getOccurrenceData().setIsolated(t);const n=i.getMateIndicatorsForOccurrence(s,false);for(let e=0;e<n.length;e++)n[e].setIsolated(t);const r=i.getSketchImagesForOccurrence(s);for(let e=0;e<r.length;++e)r[e].setIsolated(t)}}affectComponents(e,t,i,s,n){this.viewer===s&&(this.includeSelections=t,i&&0!==i.length?this.reaffectSelections(i,tM.INITIAL,n):(this.nodeModelOrSelection=e,this.reAffectComponents(tM.INITIAL,n)))}reaffectSelections(e,t,i){let s=[];e.forEach((e=>{s=s.concat(e.getOccurrencesFromSelection())})),s=(0,j.unionWithoutDuplicateValues)(s,ZC);const n=!this.getIsOperationInProgress()&&t!==tM.ASSEMBLY_DATA_UPDATE&&!gi._3.getOpenDocumentController().getActiveElementController().getViewAlignmentController().isSectionViewDialogVisible();let r;n&&(0,Me.MO)(),this.shouldAddPreexistingOccurrences()?s=(0,j.unionWithoutDuplicateValues)([...s,...this.initialAffectedOccurrences],ZC):this.initialAffectedOccurrences.length>0&&null===this.isolatedOccurrencesManager.initializingDialog&&(r=[...s]),this.affectOccurrences(s,t,i,r),n&&(0,Me.IQ)()}reAffectComponents(e,t){if(this.nodeModelOrSelection||this.includeSelections){const i=this.getSelectionFromNodeModelOrSelection(this.nodeModelOrSelection),s=[];if(i&&s.push(i),this.includeSelections){e!==tM.ASSEMBLY_DATA_UPDATE&&(this.initialSelectionList=(0,z.Z)((0,Me.vi)())),this.initialSelectionList?.forEach((e=>{s.push(e)}))}this.reaffectSelections(s,e,t)}}affectOccurrences(e,t,i,s){if(0===e.length&&!this.isPersistentModeEnabled)return(0,mr.m)().trigger(pr.C.EXIT_ISOLATE,this.viewer),void(0,mr.m)().trigger(pr.C.EXIT_MAKE_TRANSPARENT,this.viewer);const n=t!==tM.EXPAND;let r=!0;this.hasAffectedInstances()&&(r=!1),this.shouldClearOccurrenceIds()&&this.setAffectedOccurrenceIds([]),this.resetIsolationForRelatedGraphics(e),n?this.setInitialAffectedOccurrences(e):this.setAffectedOccurrences(e),this.isTranslucentModeEnabled?this.refreshTranslucentOccurrences(s):this.makeTransparent(r,i),n&&this.isolatedOccurrencesManager.initializingDialog!==os.Pmj.ISOLATE&&this.showDialog()}areSelectionsAlreadyAffected(e){const t=this.getSelectionFromNodeModelOrSelection(e),i=[];return(0,Me.vi)().forEach((e=>{i.push(e)})),t&&i.push(t),this.areSelectionsInListAlreadyAffected(i)}areSelectionsInListAlreadyAffected(e){if((0,gt._R)()){let t=[];e.forEach((e=>{t=t.concat(e.getOccurrencesFromSelection())}));const i=(0,j.unionWithoutDuplicateValues)(t,ZC);return(0,j.hasEquivalentValues)(i,this.initialAffectedOccurrences,(e=>e.toString()))}return!1}setInitialAffectedOccurrences(e){this.initialAffectedOccurrences=e,this.centersOfInitialAffectedInstances=null,this.setAffectedOccurrences(e)}setAffectedOccurrences(e){this.affectedOccurrences=e,this.setAffectedOccurrenceIdsFromOccurrences(e)}setAffectedOccurrenceIdsFromOccurrences(e){const t=e.map((e=>this.viewer.getIdForOccurrence(e)));this.setAffectedOccurrenceIds(t)}expandEffectByProximity(e){super.expandEffectByProximity(e);const{affectedIds:t,changedIds:i}=this.getAffectedOccurrencesForExpandEffectByProximity(e);t&&this.affectOccurrences(t,tM.EXPAND,!1,i)}updateCentersOfInitialAffectedInstances(){if(!this.centersOfInitialAffectedInstances){const e=this.getModelViewManager(),t=function(t){const i=e.getOccurrenceBounds(t);return i?i.center():null},i=this.initialAffectedOccurrences.map(t,this);this.centersOfInitialAffectedInstances=i.filter(j.isDefined,this)}}expandEffectByConnectivity(e,t,i=!0){super.expandEffectByConnectivity(e);const{affectedIds:s,changedIds:n}=this.getAffectedOccurrencesForExpandEffectByConnectivity(e,t);return i&&this.affectOccurrences(s,tM.EXPAND,!1,n),this.refreshTranslucentOccurrences(n,!0),s.length>this.initialAffectedOccurrences.length}getAffectedOccurrencesForExpandEffectByConnectivity(e,t){if(-1===e){const e=new Set(this.initialAffectedOccurrences);return{affectedIds:this.initialAffectedOccurrences,changedIds:this.affectedOccurrences.filter((t=>!e.has(t)))}}{const i=this.getModelViewManager(),s=new Map,n=new Set(this.getOccurrencesWithAffectedGraphics(t));let r=new Map;if(qC(this.initialAffectedOccurrences,i,s,r,n,this),r.size===this.initialAffectedOccurrences.length&&(e+=1),e>=1){const t=i.getDisplayedAssembly();if(t)for(let a=1;a<=e;a++){const e=t.getMateIndicatorConnectivityMap(r),a=r;r=new Map;for(const[t,o]of a){qC(e.get(o.getPathAsString()),i,s,r,n,this)}}}return{affectedIds:Array.from(s.values()),changedIds:Array.from(n)}}}getAffectedOccurrencesForExpandEffectByProximity(e){if(0===e){const e=new Set(this.initialAffectedOccurrences);return{affectedIds:this.initialAffectedOccurrences,changedIds:this.affectedOccurrences.filter((t=>!e.has(t)))}}const t=this.getModelViewManager().getDisplayedAssembly();if(t){const i=Object.values(t.occurrences).map((function(e){return e.occurrenceData.occurrence}));this.updateCentersOfInitialAffectedInstances();const s=e*e,n=[],r=[];for(const e of i){const t=this.isWithinDistanceOfAnInitialAffectedOccurrence(s,e),i=this.isForMakeTransparent()?t:!t;t&&n.push(e),i||r.push(e)}return{affectedIds:(0,j.unionWithoutDuplicateValues)([...n,...this.initialAffectedOccurrences],ZC),changedIds:r}}return null}getIsOperationInProgress(){const e=gt.T.getOpenDocumentActiveElement();return gi._3.hasActiveFeatureController()||e&&e.get("isOperationInProgress")}getAffectedOccurrences(){return this.affectedOccurrences}updateNodeModelOrSelection(){if(this.nodeModelOrSelection&&this.nodeModelOrSelection instanceof zC.I){const e=XC.AssemblyTreeMap.getTreeItem(this.nodeModelOrSelection.getFeatureId());if(!e)return;if(!e.children||!this.nodeModelOrSelection.children)return;e.children.length<this.nodeModelOrSelection.children.length&&(this.initialAffectedOccurrences=[]),this.nodeModelOrSelection=e}}affectId(e){this.initialAffectedOccurrences.push(e),this.affectOccurrences(this.initialAffectedOccurrences,tM.INITIAL,!1,[e])}deAffectId(e){this.initialAffectedOccurrences=this.initialAffectedOccurrences.filter((t=>t!==e)),this.affectOccurrences(this.initialAffectedOccurrences,tM.INITIAL,!1,[e])}}class KC extends YC{getOccurrencesWithAffectedGraphics(){const e=this.viewer.getOccurrenceDataManager().getOccurrencesData(),t=[];for(const i of e)if(!i.getIsolated()&&!i.isUIElement){const e=this.viewer.getOccurrenceIdManager().getNameForId(i.getOccurrenceId()),s=k._oC.getOccurrenceFromPathString(e);t.push(s)}return t}setUpListeners(){super.setUpListeners(),this.listenTo((0,mr.m)(),pr.C.EXIT_ISOLATE,this.clearEffectExit),this.listenTo((0,mr.m)(),pr.C.ISOLATE_COMPONENTS,this.affectComponents)}clearIsolateNoAnimation(){this.clearEffectNoAnimation()}hasIsolatedInstances(){return this.hasAffectedInstances()}areSelectionsAlreadyIsolated(e){return this.areSelectionsAlreadyAffected(e)}areSelectionsInListAlreadyIsolated(e){return this.areSelectionsInListAlreadyAffected(e)}isInIsolateMode(){return this.isIsolateInEffectMode()}addIdsToIsolate(e,t){this.addIdsToAffect(e,t)}removeFromIsolate(e){this.removeFromEffect(e)}isolateOccurrences(e,t){this.affectOccurrences(e,t)}setIsolatedOccurrenceIds(e){this.setAffectedOccurrenceIds(e)}get opacitySliderValue(){return this.viewer.getViewerPreferences().isolateOpacitySliderValue}clearEffect(){super.clearEffect(),this.setSeedComponentsNull(),this.setIsolationForRelatedGraphics(this.affectedOccurrences,!1),this.setInitialAffectedOccurrences([])}shouldAddPreexistingOccurrences(){return!1}shouldClearOccurrenceIds(){return this.hasAffectedInstances()}resetIsolationForRelatedGraphics(e){this.setIsolationForRelatedGraphics(this.affectedOccurrences,!1),this.setIsolationForRelatedGraphics(e,!0)}showDialog(){this.dialog?this.dialog.onAssemblyOrPartStudioDataProcessed():this.dialog=eM.createIsolateDialog(this)}updateOccurrenceDataManager(){eM.updateOccurrenceDataManager(this.affectedOccurrenceIds,this.viewer.getOccurrenceDataManager())}isForMakeTransparent(){return!1}getEnableSelectionDesire(){return this.viewer.getViewerPreferences().isolateEnableSelectionDesire}}class jC extends YC{constructor(e,t){super(e,t)}getTransparentOccurrences(){return this.getAffectedOccurrences()}getOccurrencesWithAffectedGraphics(e){return e?this.affectedOccurrencesPreUpdate:this.affectedOccurrences}areSelectionsAlreadyTransparent(e){return this.areSelectionsAlreadyAffected(e)}areSelectionsInListAlreadyTransparent(e){return this.areSelectionsInListAlreadyAffected(e)}hasTransparentInstances(){return this.hasAffectedInstances()}clearTransparentNoAnimation(){this.clearEffectNoAnimation()}setUpListeners(){super.setUpListeners(),this.listenTo((0,mr.m)(),pr.C.MAKE_TRANSPARENT_COMPONENTS,this.affectComponents),this.listenTo((0,mr.m)(),pr.C.EXIT_MAKE_TRANSPARENT,this.clearEffectExit)}showDialog(){if(this.dialog)this.dialog.onAssemblyOrPartStudioDataProcessed();else{const e={isolateManager:this};this.dialog=new GC.o8(e)}}get opacitySliderValue(){return this.viewer.getViewerPreferences().makeTransparentOpacitySliderValue}clearEffect(){super.clearEffect(),this.viewer.getOccurrenceDataManager().clearIsolation(),this.isolatedOccurrencesManager.removeMakeTransparentManager()}updateOccurrenceDataManager(){0===this.affectedOccurrenceIds.length?this.viewer.getOccurrenceDataManager().isolateAll():this.affectedOccurrenceIds.forEach((e=>{e!==TE.Qy&&this.viewer.getOccurrenceDataManager().setOccurrenceIsolated(e,!1)}))}shouldAddPreexistingOccurrences(){return!0}shouldClearOccurrenceIds(){return!0}resetIsolationForRelatedGraphics(e){this.setIsolationForRelatedGraphics(this.affectedOccurrences,!0),this.setIsolationForRelatedGraphics(e,!1)}isForMakeTransparent(){return!0}getEnableSelectionDesire(){return this.viewer.getViewerPreferences().makeTransparentEnableSelectionDesire}}class QC extends WC{constructor(e,t){super(e,t),this.affectedPartIds=new Set,this.initialAffectedPartIds=[],this.initialAffectedSheetMetalIds=new Set}getSeedPartOrOccurrenceIds(){return this.initialAffectedPartIds}getAffectedPartOrOccurrenceIds(){return this.affectedPartIds}refreshBodyOccurrenceIfExists(e,t){const i=e.partStudioBodyIdToOccurrenceId[t];if(i)e.refreshBodyOccurrence(i,t);else{const i=e.bodyMetaData[t];i?.isNonGroupingCompositeBody&&i.constituentBodyIds.forEach((t=>this.refreshBodyOccurrenceIfExists(e,t)))}}refreshTranslucentOccurrences(e){const t=this.getBodyComponent(ys.L.BASE);if(!t)return;let i=this.getPartIdsWithAffectedGraphics(t);e&&(i=(0,pi.combineItr)(i,e));for(const e of i)this.refreshBodyOccurrenceIfExists(t,e);const s=this.getBodyComponent(ys.L.PREVIEW);if(s){let t=this.getPartIdsWithAffectedGraphics(s);e&&(t=(0,pi.combineItr)(t,e));for(const e of t)this.refreshBodyOccurrenceIfExists(s,e)}this.viewer.requestDraw()}affectId(e){this.affectPartIds([e],this.viewer,!0,[e])}deAffectId(e){this.initialAffectedPartIds=this.initialAffectedPartIds.filter((t=>t!==e)),this.affectPartIds([],this.viewer,!0)}resetAffectWithIsolatableIds(e){this.initialAffectedPartIds=e,this.affectPartIds([],this.viewer,!0)}setUpListeners(){this.stopListening(),this.listenTo(this.viewer.getEventDispatcher(),nM.CD,this.onPartDataProcessed)}reMapIds(e,t){return t?this.initialAffectedPartIds.map((i=>t.remapDetId(i,e.featureIdToOperationIndices))):[]}onPartDataProcessed(e){if(!(this.isForIsolate()&&this.isIsolateInEffectMode()||this.isForMakeTransparent()&&this.isMakeTransparentInEffectMode())||!(0,gt._B)())return;const t=e.elementId,i=gi._3.getOpenDocumentController().getDeterministicIdMapper(t);if(!i)return;const s=gi._3.getOpenDocumentController().getPreviewDeterministicIdMapper(t);switch(e.usage){case k.rvN.PREVIEW_BEFORE:return void(this.queuedBaseData=e);case k.rvN.PREVIEW_AFTER:case k.rvN.PREVIEW_FINAL:const t=this.queuedBaseData?this.reMapIds(this.queuedBaseData,i):[],n=this.reMapIds(e,s);this.initialAffectedPartIds=[...t,...n],this.queuedBaseData=null;break;default:this.initialAffectedPartIds=this.reMapIds(e,i)}this.reAffectParts(this.initialAffectedPartIds,tM.PART_STUDIO_UPDATE,!1,void 0,void 0,e.usage)}affectParts(e,t,i,s){return this.affectPartIds(e.map((e=>e.id)),t,this.shouldAddPreexistingParts(),void 0,i,s)}affectPartIds(e,t,i,s,n,r){this.viewer===t&&(r&&this.setIsIsolateFullyTransparentAsDefault(),this.reAffectParts(e,tM.INITIAL,n,i,s))}clearEffectExit(e){const t=this.viewer.getModelViewManagers().getManager().isDisplayingIncontextAssembly();t?(this.clearEffectNoAnimation(),(0,nM.xA)().trigger(nM.bh,t)):(super.clearEffectExit(e),this.updateLaminarEdges())}clearEffectNoAnimation(){super.clearEffectNoAnimation(),this.updateLaminarEdges()}reAffectParts(e,t,i,s=!1,n,r){let a=!1;s||this.shouldAddPreexistingParts()?e=(0,j.unionWithoutDuplicateValues)([...e,...this.initialAffectedPartIds],(e=>e)):this.initialAffectedPartIds.length>0&&null===this.isolatedOccurrencesManager.initializingDialog&&((n=n||[]).push(...e),a=!0),t===tM.INITIAL&&(this.initialAffectedSheetMetalIds=this.getSheetMetalIds(e,this.getModelViewManager()));const o=this.getPreviewViewManager(),h=this.getModelViewManager();let c=this.getAssociatedPartIdsFromSheetMetalIds(this.initialAffectedSheetMetalIds,h);o&&(c=c.concat(this.getAssociatedPartIdsFromSheetMetalIds(this.initialAffectedSheetMetalIds,this.getPreviewViewManager()))),a&&n.push(...c),e=(0,j.unionWithoutDuplicateValues)([...e,...c],(e=>e));const l=this.getIndividualOccurrenceIdsFromPartIds(e,h);if(o){const t=this.getIndividualOccurrenceIdsFromPartIds(e,o);l.push(...t)}if(!this.isPersistentModeEnabled&&0===l.length)return void this.triggerExit();let d=!0;this.shouldNotDoAnimation()&&(d=!1),this.shouldClearOccurrenceIds()&&this.setAffectedOccurrenceIds([]);!(0,Me.yz)()&&t!==tM.PART_STUDIO_UPDATE&&!gi._3.getOpenDocumentController().getActiveElementController().getViewAlignmentController().isSectionViewDialogVisible()&&((0,Me.MO)(),(0,Me.IQ)()),t!==tM.INITIAL&&t!==tM.PART_STUDIO_UPDATE||(this.initialAffectedPartIds=e,this.centersOfInitialAffectedInstances=null),this.affectedPartIds=new Set(e),this.refreshMateIsolation(this.affectedPartIds),this.affectPartOccurrenceIds(l,t,d,i,n)}getSheetMetalIds(e,t){const i=t.getDisplayedPartStudio(),s=new Set;return e.forEach((e=>{const t=i.retrieveBodyMetaData(e);t&&t.sheetMetalModelId&&s.add(t.sheetMetalModelId)})),s}getAssociatedPartIdsFromSheetMetalIds(e,t){const i=t.getDisplayedPartStudio(),s=[];for(const t in i.bodyComponent.bodyMetaData){const n=i.bodyComponent.bodyMetaData[t];n.sheetMetalModelId&&e.has(n.sheetMetalModelId)&&s.push(t)}return s}getBodyComponent(e){return this.viewer.getModelViewManagers().getManagerForUsage(e)?.getDisplayedPartStudio()?.getBodyComponent()}setIsolatedPartMates(e,t){const i=this.getModelViewManager().getDisplayedPartStudio();if(i){const s=i.getAllMateConnectorGraphics(null).filter((e=>""!==e.definition.partId));this.isolateMateConnectors(s,this.getModelViewManager(),e,t)}const s=this.getPreviewViewManager();if(s){const i=s.getDisplayedPartStudio();if(i){const n=i.getAllMateConnectorGraphics(null).filter((e=>""!==e.definition.partId));this.isolateMateConnectors(n,s,e,t)}}}isolateMateConnectors(e,t,i,s){if(s){const n=this.getIndividualPartIds(s,t),r=t.getDisplayedPartStudio();e.forEach((e=>{let t=e.definition.partId;const s=r.retrieveBodyMetaData(t);s&&s.consumingClosedCompositeData&&(t=s.consumingClosedCompositeData.id),n.has(t)&&e.getOccurrenceData().setIsolated(i)}))}else e.forEach((e=>{e.getOccurrenceData().setIsolated(i)}))}shouldAddSketchesToEffect(){return!0}updateLaminarEdges(){const e=this.viewer.getFilteredEntitiesHighlightController();e&&e.updateSetOfFilteredEntities()}affectPartOccurrenceIds(e,t,i,s,n){this.shouldAddSketchesToEffect()&&e.push(this.getModelViewManager().getDisplayedPartStudio().getSketchComponent().sketchComponentElementId),this.hasAffectedInstances()&&this.setAffectedOccurrenceIds([]),this.addIdsToAffect(e,!0),this.refreshMateIsolation(this.affectedPartIds),this.makeTransparent(i,s),null!==!this.isolatedOccurrencesManager.initializingDialog&&(t===tM.INITIAL||t===tM.PART_STUDIO_UPDATE&&this.isIsolateInEffectMode())&&this.showDialog(),this.updateLaminarEdges(),this.isTranslucentModeEnabled&&this.refreshTranslucentOccurrences(n)}getIndividualOccurrenceIdsFromPartIds(e,t){const i=[],s=this.getIndividualPartIds(e,t);for(const e of s){const s=this.getOccurrenceIdFromPartId(e,t);s&&i.push(s)}return i}getIndividualPartIds(e,t){const i=t.getDisplayedPartStudio(),s=new Set;for(const t of e){const e=i.retrieveBodyMetaData(t);e&&(e.isComposite&&!e.isGroupableCompositeBody?e.constituentBodyIds.forEach((e=>{s.add(e)})):s.add(t))}return s}getOccurrenceIdFromPartId(e,t){const i=t.getDisplayedPartStudio().getBodyComponent().getBodyOccurrenceData(e);if(i){const e=i.getOccurrenceId();if(e&&e!==TE.Qy)return e}return null}areSelectionsAlreadyAffected(e){if((0,gt._B)()){const t=QC.getSelectedParts(e,this.viewer);return this.arePartsAlreadyAffected(t)}return!1}areSelectionsInListAlreadyAffected(e){const t=this.viewer.getModelViewManagers().getManager().getDisplayedPartStudio().id;if((0,gt._B)()){const i=(0,Me.mZ)(t,e);return this.arePartsAlreadyAffected(i)}return!1}arePartsAlreadyAffected(e){const t=e.map((e=>e.id));return(0,j.hasEquivalentValues)(t,this.initialAffectedPartIds,(e=>e))}static getSelectedParts(e,t){const i=sM.getSelectionFromNodeModelOrSelection(e,t),s=t.getModelViewManagers().getManager().getDisplayedPartStudio();if(!s)return[];const n=s.getElementId();let r;return i&&(r=aD.L.getPartModelFromPartId(i.getPartId(),n)),(0,Me.JA)(n,r)}updateCentersOfInitialAffectedInstances(){if(!this.centersOfInitialAffectedInstances){const e=[];this.initialAffectedPartIds.forEach((t=>{const i=this.getModelViewManager().getBodyBounds(t,null);i&&e.push(i.center())})),this.centersOfInitialAffectedInstances=e.filter(j.isDefined,this)}}expandEffectByProximity(e){super.expandEffectByProximity(e);const t=this.getModelViewManager(),{affectedIds:i,changedIds:s}=this.getAffectedPartIdsForExpandEffectByProximity(e,t,!1);let n=this.getIndividualOccurrenceIdsFromPartIds(i,t);const r=this.getPreviewViewManager();if(r){const{affectedIds:t,changedIds:a}=this.getAffectedPartIdsForExpandEffectByProximity(e,r,!0),o=r.getDisplayedPartStudio().getBodyComponent(),h=[];t.forEach((e=>{const t=o.getBodyOccurrenceData(e);t&&h.push(t.getOccurrenceId())})),(0,Gl.addToSet)(i,t),(0,Gl.addToSet)(s,a),n=(0,j.unionWithoutDuplicateValues)([...n,...h],(e=>e+"")),n=n.concat(this.getAffectedOwnerlessMatesOccurrenceIdsByProximity(e,r))}this.affectedPartIds=i,this.affectPartOccurrenceIds(n,tM.EXPAND,!1,!1,s)}getAffectedOwnerlessMatesOccurrenceIdsByProximity(e,t){if(Math.abs(e)<=Ri.W.ZERO_LENGTH)return[];const i=[],s=t.getDisplayedPartStudio().getAllMateConnectorGraphics(null).filter((e=>""===e.definition.partId)),n=e*e;for(const e of s)this.isPointWithinDistanceOfInitialAffectedInstances(e.worldSpacePosition,n)&&i.push(e.getOccurrenceData().getOccurrenceId());return i}getAffectedPartIdsForExpandEffectByProximity(e,t,i){const s=this.getAssociatedPartIdsFromSheetMetalIds(this.initialAffectedSheetMetalIds,t);if(!i&&Math.abs(e)<=Ri.W.ZERO_LENGTH){const e=new Set(this.initialAffectedPartIds);return{affectedIds:(0,Gl.addToSet)(new Set,this.initialAffectedPartIds,s),changedIds:this.affectedPartIds.difference(e)}}this.updateCentersOfInitialAffectedInstances();const n=t.getDisplayedPartStudio().getBodyComponent(),r=[],a=e*e,o=[];for(const e of Object.keys(n.partStudioBodyIdToOccurrenceId)){const i=this.isWithinDistanceOfAnInitialIsolatedPart(a,e,null,t),s=this.isForMakeTransparent()?i:!i;i&&r.push(e),s||o.push(e)}const h=this.getSheetMetalIds(r,t),c=this.getAssociatedPartIdsFromSheetMetalIds(h,t);return{affectedIds:(0,Gl.addToSet)(new Set,r,this.initialAffectedPartIds,c,s),changedIds:new Set(o)}}isWithinDistanceOfAnInitialIsolatedPart(e,t,i,s){const n=s.getBodyBounds(t,i);return!!n&&this.isBoundsWithinDistanceOfInitialAffectedInstances(n,e)}}class $C extends QC{getPartIdsWithAffectedGraphics(e){return e.getBodyIds((e=>!e.isFlattenedSheetMetalBody&&!e.isBendCenterLineBody&&!this.affectedPartIds.has(e.getId())))}setUpListeners(){super.setUpListeners(),this.listenTo((0,mr.m)(),pr.C.EXIT_ISOLATE,this.clearEffectExit),this.listenTo((0,mr.m)(),pr.C.ISOLATE_PARTS,this.affectParts)}clearIsolateNoAnimation(){this.clearEffectNoAnimation()}hasIsolatedInstances(){return this.hasAffectedInstances()}areSelectionsAlreadyIsolated(e){return this.areSelectionsAlreadyAffected(e)}areSelectionsInListAlreadyIsolated(e){return this.areSelectionsInListAlreadyAffected(e)}isInIsolateMode(){return this.isIsolateInEffectMode()}addIdsToIsolate(e,t){this.addIdsToAffect(e,t)}removeFromIsolate(e){this.removeFromEffect(e)}isolateOccurrences(e,t){this.affectOccurrences(e,t)}setIsolatedOccurrenceIds(e){this.setAffectedOccurrenceIds(e)}get opacitySliderValue(){return this.viewer.getViewerPreferences().isolateOpacitySliderValue}clearEffect(){this.initialAffectedPartIds=[],this.setAffectedOccurrenceIds([]),this.setIsolatedPartMates(!1),this.initialAffectedSheetMetalIds=new Set,super.clearEffect()}triggerExit(){(0,mr.m)().trigger(pr.C.EXIT_ISOLATE,this.viewer)}shouldNotDoAnimation(){return this.hasAffectedInstances()}shouldClearOccurrenceIds(){return this.hasAffectedInstances()}refreshMateIsolation(e){this.setIsolatedPartMates(!1),this.setIsolatedPartMates(!0,e)}shouldAddPreexistingParts(){return!1}shouldAddSketchesToIsolate(){return!0}showDialog(){this.dialog?this.dialog.onAssemblyOrPartStudioDataProcessed():this.dialog=eM.createIsolateDialog(this)}updateOccurrenceDataManager(){eM.updateOccurrenceDataManager(this.affectedOccurrenceIds,this.viewer.getOccurrenceDataManager())}isForMakeTransparent(){return!1}getEnableSelectionDesire(){return this.viewer.getViewerPreferences().isolateEnableSelectionDesire}}class JC extends QC{getEnableSelectionDesire(){return this.viewer.getViewerPreferences().makeTransparentEnableSelectionDesire}getPartIdsWithAffectedGraphics(e){return this.affectedPartIds}constructor(e,t,i,s){super(e,t)}areSelectionsAlreadyTransparent(e){return this.areSelectionsAlreadyAffected(e)}areSelectionsInListAlreadyTransparent(e){return this.areSelectionsInListAlreadyAffected(e)}hasTransparentInstances(){return this.hasAffectedInstances()}clearTransparentNoAnimation(){this.clearEffectNoAnimation()}setUpListeners(){super.setUpListeners(),this.listenTo((0,mr.m)(),pr.C.MAKE_TRANSPARENT_PARTS,this.affectParts),this.listenTo((0,mr.m)(),pr.C.EXIT_MAKE_TRANSPARENT,this.clearEffectExit)}showDialog(){if(this.dialog)this.dialog.onAssemblyOrPartStudioDataProcessed();else{const e={isolateManager:this};this.dialog=new GC.o8(e)}}get opacitySliderValue(){return this.viewer.getViewerPreferences().makeTransparentOpacitySliderValue}clearEffect(){super.clearEffect(),this.viewer.getOccurrenceDataManager().clearIsolation(),this.isolatedOccurrencesManager.removeMakeTransparentManager(),this.updateLaminarEdges()}updateOccurrenceDataManager(){if(0===this.affectedOccurrenceIds.length){let e=this.getModelViewManager().getDisplayedPartStudio().getPartStudioOccurrenceIds();this.getPreviewViewManager()&&(e=e.concat(this.getPreviewViewManager().getDisplayedPartStudio().getPartStudioOccurrenceIds())),e.forEach((e=>{e!==TE.Qy&&this.viewer.getOccurrenceDataManager().setOccurrenceIsolated(e,!0)}))}else this.affectedOccurrenceIds.forEach((e=>{e!==TE.Qy&&this.viewer.getOccurrenceDataManager().setOccurrenceIsolated(e,!1)}))}refreshMateIsolation(e){this.setIsolatedPartMates(!0),this.setIsolatedPartMates(!1,e)}triggerExit(){(0,mr.m)().trigger(pr.C.EXIT_MAKE_TRANSPARENT,this.viewer)}shouldAddPreexistingParts(){return!0}shouldAddSketchesToEffect(){return!1}shouldNotDoAnimation(){return this.viewer.getIsolatedOccurrenceManager()?.hasIsolatedInstances()}shouldClearOccurrenceIds(){return!0}isForMakeTransparent(){return!0}}class eM{static createIsolateDialog(e){const t={isolateManager:e};return new GC.sl(t)}static updateOccurrenceDataManager(e,t){e&&t&&(0===e.length?t.clearIsolation():e.forEach((e=>{e!==TE.Qy&&t.setOccurrenceIsolated(e,!0)})))}}var tM,iM=i(53241);!function(e){e[e.INITIAL=0]="INITIAL",e[e.ASSEMBLY_DATA_UPDATE=1]="ASSEMBLY_DATA_UPDATE",e[e.EXPAND=2]="EXPAND",e[e.PART_STUDIO_UPDATE=3]="PART_STUDIO_UPDATE"}(tM||(tM={}));class sM extends m.T{constructor(e){super(),this.viewer=e,this.contextTransparencyMultiplier=1,(0,gt._B)()?this.currentIsolateManager=new $C(e,this):this.currentIsolateManager=new KC(e,this),this.setUpListeners()}isInMakeTransparentModeWithoutDialog(){return this.isInMakeTransparentMode()&&!this.currentMakeTransparentManager.isDialogOpen()}isInIsolateModeWithoutDialog(){return this.isInIsolateMode()&&!this.currentIsolateManager.isDialogOpen()}getIsNewOccurrenceDataIsolated(e,t){if(this.isOccurrenceIdForInContext(e.getOccurrenceId()))return!1;const i=e.getOccurrenceId(),s=e=>(0,gt._R)()||!t?e.affectedOccurrenceIds.includes(i):e.getAffectedPartOrOccurrenceIds().has(t);return this.isInMakeTransparentMode()?!s(this.currentMakeTransparentManager):!!this.isInIsolateMode()&&!!s(this.currentIsolateManager)}switchActiveElement(e){this.currentIsolateManager.destroy(),this.currentMakeTransparentManager&&(this.currentMakeTransparentManager.destroy(),this.currentMakeTransparentManager=null),this.currentIsolateManager=e?new $C(this.viewer,this):new KC(this.viewer,this)}clearIsolateManagerNoGraphicsUpdate(){this.currentIsolateManager.clearAffectedOccurrenceIdsNoGraphicsUpdate()}removeMakeTransparentManager(){this.currentMakeTransparentManager&&this.currentMakeTransparentManager.destroy(),this.currentMakeTransparentManager=null}getContextTransparencyMultiplier(){return this.contextTransparencyMultiplier}getIsIsolateFullyTransparent(){return this.currentMakeTransparentManager?this.currentMakeTransparentManager.getIsIsolateFullyTransparent():this.currentIsolateManager.getIsIsolateFullyTransparent()}onIsIsolateFullyTransparentChanged(){this.trigger(sM.IS_ISOLATE_FULLY_TRANSPARENT_CHANGED_EVENT)}setContextTransparencyMultiplier(e){this.contextTransparencyMultiplier=e,this.viewer.requestDraw()}onMakeTransparentParts(e,t){if(0===e.length||this.currentMakeTransparentManager)this.currentMakeTransparentManager&&this.currentMakeTransparentManager.showDialog();else{this.currentMakeTransparentManager=new JC(t,this,e,t),this.currentMakeTransparentManager.affectParts(e,t);const i=t.getFilteredEntitiesHighlightController();i&&i.updateSetOfFilteredEntities()}}onMakeTransparentComponents(e,t,i,s){this.currentMakeTransparentManager||(this.currentMakeTransparentManager=new jC(this.viewer,this),this.currentMakeTransparentManager.affectComponents(e,t,i,s))}static partCanBeIsolated(e){return e.bodyType===k.wG2.SOLID||e.bodyType===k.wG2.SHEET||e.bodyType===k.wG2.WIRE||e.isComposite}setUpListeners(){this.listenTo((0,mr.m)(),pr.C.MAKE_TRANSPARENT_COMPONENTS,this.onMakeTransparentComponents),this.listenTo((0,mr.m)(),pr.C.MAKE_TRANSPARENT_PARTS,this.onMakeTransparentParts),this.currentIsolateManager.setUpListeners()}destroy(){this.currentIsolateManager.destroy(),this.currentMakeTransparentManager&&this.currentMakeTransparentManager.destroy()}isIsolateManagerInUse(){return this.isInIsolateMode()||!!(0,Me.Eo)()||gi._3.getOpenDocumentController().isInterferenceDetectionActive()}clearAllIsolateNoAnimation(){this.currentIsolateManager.clearIsolateNoAnimation(),this.currentMakeTransparentManager&&this.currentMakeTransparentManager.clearTransparentNoAnimation()}hasIsolatedInstances(){return this.currentIsolateManager.hasIsolatedInstances()||this.currentMakeTransparentManager&&this.currentMakeTransparentManager.hasTransparentInstances()}areSelectionsAlreadyIsolated(e){return this.currentIsolateManager.areSelectionsAlreadyIsolated(e)}areSelectionsInListAlreadyIsolated(e){return this.currentIsolateManager.areSelectionsInListAlreadyIsolated(e)}isInIsolateMode(){return this.currentIsolateManager?.isInIsolateMode()}addIdsToIsolate(e,t){this.currentIsolateManager.addIdsToIsolate(e,t)}removeFromIsolate(e){this.currentIsolateManager.removeFromIsolate(e)}isolateOccurrences(e,t){this.currentIsolateManager.isolateOccurrences(e,t)}getAffectedPartIdsOrOccurrences(){return this.currentMakeTransparentManager?this.currentMakeTransparentManager.getAffectedPartOrOccurrenceIds():this.currentIsolateManager.getAffectedPartOrOccurrenceIds()}setIsolatedOccurrenceIds(e){this.currentIsolateManager.setIsolatedOccurrenceIds(e)}isInMakeTransparentMode(){return!!this.currentMakeTransparentManager||this.initializingDialog===os.Pmj.MAKE_TRANSPARENT}isInTranslucentMode(){return this.currentIsolateManager?.isTranslucentModeEnabled||this.currentMakeTransparentManager?.isTranslucentModeEnabled}isInPickingMode(){return this.currentIsolateManager?.isInPickingMode||this.currentMakeTransparentManager?.isInPickingMode}areSelectionsInListAlreadyTransparent(e){if(this.currentMakeTransparentManager)return this.currentMakeTransparentManager.areSelectionsInListAlreadyTransparent(e);{let t=!0;return e.forEach((e=>{this.noOccurrencesOrPartsSelected(e)||(t=!1)})),t}}areSelectionsAlreadyTransparent(e){return this.currentMakeTransparentManager?this.currentMakeTransparentManager.areSelectionsAlreadyTransparent(e):this.noOccurrencesOrPartsSelected(e)}isInIsolateOrMakeTransparentMode(){return this.isInIsolateMode()||this.isInMakeTransparentMode()}isInIsolateOrMakeTransparentModeWithoutDialog(){return this.currentMakeTransparentManager?.isPersistentModeEnabled||this.currentIsolateManager?.isPersistentModeEnabled}affectSelection(e,t){(0,gt._R)()?e.forEach((e=>t.affectId(e.getOccurrence()))):e.forEach((e=>t.affectId(e.getBodyId()))),t.isDialogOpen()||t.showDialog()}isolateSelections(e){this.affectSelection(e,this.currentIsolateManager)}makeTransparentSelections(e){this.affectSelection(e,this.currentMakeTransparentManager)}noOccurrencesOrPartsSelected(e){if((0,gt._B)())return 0===QC.getSelectedParts(e,this.viewer).length;if((0,gt._R)()){if(e){if(0!==sM.getSelectionFromNodeModelOrSelection(e,this.viewer).getOccurrencesFromSelection().length)return!1}let t=!1;return(0,Me.vi)().forEach((e=>{0!==e.getOccurrencesFromSelection().length&&(t=!0)})),!t}return!0}refreshTranslucentOccurrences(){this.currentIsolateManager?.refreshTranslucentOccurrences(),this.currentMakeTransparentManager?.refreshTranslucentOccurrences()}static getSelectionFromNodeModelOrSelection(e,t){return e?e instanceof Me.Y1?e:e instanceof iM.e?e.getSelection():e.getSelection(t):null}isOccurrenceIdForInContext(e){return this.viewer.getModelViewManagers().getManager().isOccurrenceIdForInContext(e)}isOccurrenceIdTranslucent(e){const t=this.viewer.getOccurrenceDataManager().getOccurrenceData(e);return this.isOccurrenceTranslucent(t)}isOccurrenceTranslucent(e){if(!e)return!1;if(this.isOccurrenceIdForInContext(e.getOccurrenceId()))return!1;let t;return this.isInMakeTransparentMode()?t=this.currentMakeTransparentManager:this.isInIsolateMode()&&(t=this.currentIsolateManager),t?.isTranslucentModeEnabled&&!e.getIsolated()&&!e.isUIElement}setRenderingMode(e){this.currentIsolateManager?.setRenderingMode(e),this.currentMakeTransparentManager?.setRenderingMode(e)}}sM.IS_ISOLATE_FULLY_TRANSPARENT_CHANGED_EVENT="IS_ISOLATE_FULLY_TRANSPARENT_CHANGED_EVENT";var nM=i(65915);class rM{constructor(){this.zoomScrollDirection=!1,this.viewManipulationMouseKeyMapping={},this.allowDefaultAxisRotationLock=!1,this.axisRotationLock=!1,this.mouseStringCodeMap={},this.keyStringCodeMap={},this.defaultReverseScrollWheelZoomDirection=!1,this.mouseStringCodeMap.LMB=Qn.tc.LEFT,this.mouseStringCodeMap.MMB=Qn.tc.MIDDLE,this.mouseStringCodeMap.RMB=Qn.tc.RIGHT,this.keyStringCodeMap.CTRL=Is.R8.CONTROL,this.keyStringCodeMap.SHIFT=Is.R8.SHIFT,this.keyStringCodeMap.ALT=Is.R8.ALT,this.allowDefaultAxisRotationLock=es.Jq.CapabilitiesService.checkAllowDefaultAxisRotationLockCurrentlyEnabled()}setMouseSettings(e){this.zoomScrollDirection=e.reverseScrollWheelZoomDirection,this.viewManipulationMouseKeyMapping=e.viewManipulationMouseKeyMapping,this.axisRotationLock=e.axisRotationLock,this.applyViewManipulationMouseKeyMapping()}getMouseButtons(e){const t=[];return e.forEach((e=>{this.mouseStringCodeMap.hasOwnProperty(e)&&t.push(this.mouseStringCodeMap[e])})),t}getKeyCodes(e){const t=[];return e.forEach((e=>{this.keyStringCodeMap.hasOwnProperty(e)&&t.push(this.keyStringCodeMap[e])})),t}applyViewManipulationMouseKeyMapping(){if(!this.viewManipulationMouseKeyMapping)return;const e=lS();e.clearMouseKeyManipulationBindings(),Object.keys(this.viewManipulationMouseKeyMapping).forEach((t=>{let i=aA.k.NONE;switch(t){case"pan3DMapping":i=aA.k.PAN;break;case"zoom3DMapping":i=aA.k.ZOOM;break;case"rotate3DMapping":i=!0===this.axisRotationLock&&this.allowDefaultAxisRotationLock?aA.k.AXIS_ROTATE:aA.k.ROTATE;break;case"axisRotate3DMapping":i=!0===this.axisRotationLock&&this.allowDefaultAxisRotationLock?aA.k.ROTATE:aA.k.AXIS_ROTATE;break;default:i=aA.k.NONE}if(i!==aA.k.NONE){const s=this.viewManipulationMouseKeyMapping[t];for(let t=0;t<s.length;++t){const n=s[t],r=this.getMouseButtons(n.mouseButtons),a=this.getKeyCodes(n.keys);(0,j.isEmptyObjectOrArray)(r)&&(0,j.isEmptyObjectOrArray)(a)||e.addMouseKeyManipulationModeBinding(r,a,i)}}}))}isScrollZoomDefault(){return this.zoomScrollDirection===this.defaultReverseScrollWheelZoomDirection}}let aM=null;function oM(){return aM||(aM=new rM),aM}i(57702);const hM=_e.O.createLogger("debugtools",k.bVy.GRAPHICS),cM="WebGL Error: ",lM=200;function dM(e){const t=e.getCamera(),i=e.retrieveVisiblePicks(0,0,t.getViewportWidth(),t.getViewportHeight());DM(e,i)}const uM=new Gi.hF({primitiveType:Ai.MX.POINTS,isShowThrough:!0,isDepthTested:!1,isPickable:!1}),gM=new Gi.hF({primitiveType:Ai.MX.LINES,isShowThrough:!0,isDepthTested:!1,isPickable:!1}),pM=new Map;function mM(e){let t=pM.get(e);return t||(t=new yi.u1(e),pM.set(e,t)),t}let fM=0;function IM(e,t,i,s,n,r){const a=mM(e),o=X.default.getManager(),h=(0,Yd.Pu)(i,"p"+fM++);(0,Yd.Ab)(s||o.getColor("DEBUG_POINT_DEFAULT_COLOR"),h),(0,Yd.VQ)(n||o.getNumber("DEBUG_POINT_DEFAULT_SIZE"),h),(0,Yd.KZ)(r||o.getPointFont("DEBUG_POINT_DEFAULT_POINT_FONT"),h),a.updateMeshIncrement(t,yi.ZJ,h,uM),e.requestDraw()}function EM(e,t,i,s){const n=mM(e),r=X.default.getManager(),a=(0,Yd.U0)(i.getMin(),i.getMax());(0,Yd.Ab)(s||r.getColor("DEBUG_BOUNDINGBOX_DEFAULT_COLOR"),a),n.updateMeshIncrement(t,yi.ZJ,a,gM),e.requestDraw()}function SM(e,t,i,s,n){const r=(0,Yd.W5)(i,s,t,n);mM(e).updateMeshIncrement(t,yi.ZJ,r,gM),e.requestDraw()}function TM(e,t,i){const s=X.default.getManager(),n=i.origin.getVec3(),r=100*e.getCamera().getPixelSizeAtWorldPoint(n);SM(e,t+".xAxis",n,M.scaleAndAdd(M.create(),n,i.xAxis.getVec3(),r),s.getColor("DEBUG_X_AXIS_COLOR")),SM(e,t+".yAxis",n,M.scaleAndAdd(M.create(),n,i.yAxis.getVec3(),r),s.getColor("DEBUG_Y_AXIS_COLOR")),SM(e,t+".zAxis",n,M.scaleAndAdd(M.create(),n,i.zAxis.getVec3(),r),s.getColor("DEBUG_Z_AXIS_COLOR"))}function DM(e,t){const i=X.default.getManager(),s=mM(e),n=e.getCamera();s.removeMeshIncrements();const r=function(t,i,s,r,a){const o=n.canvasToWorld([i[0],i[1],.5]);IM(e,t,o,s,r,a)};for(let e=0;e<t.length;++e){const s=t[e];let n=[1,1,1];const a=s.getEntityMetaData();a&&a.isVertex()?n=i.getColor("DEBUG_PICK_VERTEX_COLOR"):a&&a.isEdge()?n=i.getColor("DEBUG_PICK_EDGE_COLOR"):a&&a.isFace()&&(n=i.getColor("DEBUG_PICK_FACE_COLOR"));const o=ge.S4.add(n,[.2,.2,.2],M.create());for(let t=0;t<s.locationSamples.length;++t)r(e+"."+t,s.locationSamples[t],o,i.getNumber("DEBUG_PICK_SAMPLE_SIZE"));r(e+".average",ge.gv.scale(s.locationSum,1/s.locationCount,Q.create()),ge.S4.scale(n,.6,M.create()),i.getNumber("DEBUG_PICK_AVERAGE_SIZE"),i.getPointFont("DEBUG_PICK_POINT_AVERAGE_FONT")),r(e+".location",s.location,n,i.getNumber("DEBUG_PICK_SIZE"),i.getPointFont("DEBUG_PICK_POINT_FONT"))}e.requestDraw()}let CM=null,MM=!1;const yM=null;let AM=null;function PM(e){if(CM&&CM.closed&&(CM=null,MM=!1),!CM){CM=window.open("/debugwindows/scenedebug.html");let e=0;const t=setInterval((function(){CM?.document&&"complete"===CM.document.readyState&&(MM=!0,AM&&(AM(),AM=null)),(MM||e++>lM)&&clearInterval(t)}),200)}const t=(0,li.f1)(e),i=t.getSceneGraphs().getMainSceneGraph().makeSceneDebugObject(),s=t.getSceneGraphs().getPreviewSceneGraph().makeSceneDebugObject(),n=t.getSceneGraphs().getHudSceneGraph().makeSceneDebugObject(),r=t.getOccurrenceDataManager().makeSceneDebugObject();let a;"true"===localStorage.getItem("osDumpBufferSetsInSceneDebugger")&&(a=t.makeBufferSetSceneDebugObject());const o=location.protocol+"//"+location.hostname+(location.port?":"+location.port:""),h=function(){CM?.postMessage([r,i,s,n,a],o)};MM?h():AM=h}let OM=0;function RM(e){OM=0;let t=0,i=0;const s=(e=e||{}).numFrames?e.numFrames:720;let n=null;const r=!!e?.flat,a=(0,li.f1)({useFlattenedView:r,useRepairView:!1});if(!a)return;a.draw(),a.setSuppressMouseMovePick(!0),a.completeTasks(),e?.forceLowDetail&&a.detailManager.forceLowestDetailSettings();let o=0,h=[],c=[];const l=a.getGlContext();let d=[];if(e?.timeShadersPrograms){const e=l.getProgramFlags().length;c=[],d=[],h=[];for(let t=0;t<e;t++)if(t in l.programNames){const i=new Array(e);for(let s=0;s<e;s++)i[s]=s===t;c.push(i),d.push(t)}let t,i=new Array(e);for(t=0;t<e;t++)i[t]=!1;for(c.push(i),i=new Array(e),t=0;t<e;t++)i[t]=!0;c.push(i),console.dir(c),o=0,l.setProgramFlags(c[0])}const u={performFrameTiming:!1},g=function(){const r=window.performance.now();if(n&&(t+=(r-n)/1e3,++i),n=r,i<s){const e=a.getPrimaryViewController();e?.rotateAbout(.0698131701,[0,1,0],e.camera.focalPoint()),a.setUserIsAdjustingCamera(),a.forceRequestDraw(u)}else if(e?.timeShadersPrograms&&o<c.length)h[o]=t/i*1e3,o++,o<c.length&&l.setProgramFlags(c[o]),t=0,i=0,n=null;else{a.getEventDispatcher()?.off(nM.u9,g);const s=(i/t).toFixed(2);t=t.toFixed(2),OM=1e3*t/i;const n="Rendered "+i+" frames in "+t+" seconds at "+s+" fps "+OM.toFixed(2)+" ms frametime";if(es.Jq.MessageBubbleService.showMessage(n),hM.debug(n),a.setSuppressMouseMovePick(!1),e?.timeShadersPrograms){for(let e=0;e<h.length-2;e++)d[e]in l.programNames&&hM.debug("program "+e+" "+l.programNames[d[e]]+" "+h[e]+" ms");hM.debug("no programs  "+h[h.length-2]+" ms"),hM.debug("all programs "+h[h.length-1]+" ms")}e?.browserProfile&&console.profile&&console.profileEnd()}};a.getEventDispatcher()?.on(nM.u9,g),e?.browserProfile&&console.profile&&console.profile(e.browserProfileName||"timeRendering"),g()}function wM(){const e=(0,Ka.getActiveViewer)();return e?(e.completeTasks(),e.getMemoryGauge().getUsageDetails()):null}function vM(e){const t=e.getError();if(t!==e.NO_ERROR){let i="Unknown: 0x"+t.toString(16);switch(t){case e.INVALID_ENUM:i="GL_INVALID_ENUM";break;case e.INVALID_VALUE:i="GL_INVALID_VALUE";break;case e.INVALID_OPERATION:i="GL_INVALID_OPERATION";break;case e.INVALID_FRAMEBUFFER_OPERATION:i="GL_INVALID_FRAMEBUFFER_OPERATION";break;case e.OUT_OF_MEMORY:i="GL_OUT_OF_MEMORY"}return hM.warn("GL error: "+i),!0}return!1}class _M{constructor(){this.meshIncrements=[],this.silhouetteIncrements=[],this.entityData=[],this.incrementDetails=[]}removeCrossReferences(){for(const e of this.entityData)e.setMeshIncrement(null),e.setBodyMetaData(null);for(const e of this.incrementDetails)e.increment=null}}function NM(){const e=new _M;(0,Ka.getActiveViewer)().getModelViewManagers().getManager().collectComponentsForHeapDump(e),e.removeCrossReferences(),window.trackedGraphicsComponents=e;let t=0;for(let i=0;i<e.meshIncrements.length;++i)t+=e.meshIncrements[i].getTriangleCount();hM.info("Graphics triangle count: "+t+"\nGraphics body entity count: "+e.entityData.length)}function bM(){const e=(0,Ka.getActiveViewer)().getModelViewManagers().getManager().getModelStatistics(!0,!1,!1);hM.info(`Objects count to estimate memory usage: ${JSON.stringify(e)}`)}var LM=i(34434);const FM=_e.O.createLogger("clientcapabilities",k.bVy.GRAPHICS);function xM(e){const t={angleInstancedArrays:"ANGLE_instanced_arrays",extTextureFilterAnisotropic:"EXT_texture_filter_anisotropic",oesElementIndexUint:"OES_element_index_uint",oesStandardDerivatives:"OES_standard_derivatives",oesTextureFloat:"OES_texture_float",oesTextureFloatLinear:"OES_texture_float_linear",oesTextureHalfFloat:"OES_texture_half_float",oesTextureHalfFloatLinear:"OES_texture_half_float_linear",oesVertexArrayObject:"OES_vertex_array_object",compressedTextureS3tc:"WEBGL_compressed_texture_s3tc",depthTexture:"WEBGL_depth_texture",drawBuffers:"WEBGL_draw_buffers"};let i,s={};if(e){const n=Qt(e);for(i in s=n?{vendor:n.glVendor,renderer:n.glRenderer}:{vendor:"unavailable",renderer:"unavailable"},t){const n=t[i];try{s[i]=!!e.getExtension(n)}catch(e){FM.warn('Web client capability - failed at "gl.getExtension" call on '+n+" -- "+e)}}}else for(i in FM.warn("No gl context was available when attempting to get renderer information"),s={vendor:"unsupported",renderer:"unsupported"},t)s[i]=!1;s.has3dMouse=qa(),s.screenWidth=window.screen.width,s.screenHeight=window.screen.height;const n=document.createElement("canvas");try{s.supportsWebGL2=!!n.getContext("webgl2")}catch(e){FM.warn("Web client capability - failed at checking supportsWebGL2 -- "+e)}n.remove(),s.devicePixelRatio=window.devicePixelRatio?window.devicePixelRatio:-1,(async()=>{if(navigator.storage?.estimate)try{const e=await navigator.storage.estimate();s.clientBrowserStorageUsed=e.usage/1048576,s.clientBrowserStorageQuota=e.quota/1048576}catch(e){FM.info("Error in estimating storage: "+e),s.clientBrowserStorageUsed=-1,s.clientBrowserStorageQuota=-1}else FM.info("Storage estimation is not supported in this browser."),s.clientBrowserStorageUsed=-1,s.clientBrowserStorageQuota=-1;if(navigator.gpu)try{s.supportsWebGPU=!!await navigator.gpu.requestAdapter()}catch(e){FM.warn("Web client capability - failed at checking gpu.requestAdapter -- "+e)}else s.supportsWebGPU=!1;if(window.localStorage)try{window.localStorage.setItem("webClientCapabilities",JSON.stringify(s))}catch(e){FM.warn("Error writing client capabilities to local storage: "+e)}})()}const BM=new Gi.hF({isPickable:!1,isShowThrough:!0,isDepthTested:!1,primitiveType:Ai.MX.LINES}),VM=new Gi.hF({isPickable:!1,isShowThrough:!0,isDepthTested:!1,primitiveType:Ai.MX.POINTS}),UM=new Gi.hF({primitiveType:Ai.MX.LINES,isPickable:!1,isHighlightable:!1,isTwoSided:!1,isShowThrough:!1,isDepthTested:!0}),HM=new Gi.hF({primitiveType:Ai.MX.LINES,isPickable:!1,isHighlightable:!1,isShowThrough:!0,isTwoSided:!0,isDepthTested:!1,isStencilTested:!0}),GM=X.default.CONSTANT_DEFAULTS,kM=X.default.getManager(),WM=kM.getStipple("CURVATURE_UV_TOOTH_STIPPLE"),zM=kM.getNumber("CURVATURE_TOOTH_LINE_WIDTH"),XM=kM.getNumber("CURVATURE_ROOF_LINE_WIDTH"),ZM=kM.getStipple("CURVATURE_UV_ROOF_STIPPLE"),qM="distanceedge";class YM extends yi.u1{constructor(e,t,i){super(i),this.startPoint=e,this.endPoint=t,this.drawDeltaP=!1,this.drawStartPointP=!1,this.drawEndPointP=!1,this.drawDistanceP=!1,this.deltaPoint=ge.S4.subtract(t,e,M.create()),this.distance=ge.S4.length(this.deltaPoint),this.distanceColor=kM.getColor("PROJECT_MEASUREMENT_DISTANCE_COLOR"),this.componentColors=[kM.getColor("X_AXIS_COLOR"),kM.getColor("Y_AXIS_COLOR"),kM.getColor("Z_AXIS_COLOR")],this.measurementStipple=kM.getStipple("PROJECT_MEASUREMENT_STIPPLE"),this.pointSize=GM.PROJECT_MEASUREMENT_POINT_SIZE,this.lineWidth=GM.PROJECT_MEASUREMENT_DISTANCE_LINE_WIDTH}onViewWillDraw(e,t){this.updateGraphics()}onAppearanceConstantsUpdated(){this.distanceColor=kM.getColor("PROJECT_MEASUREMENT_DISTANCE_COLOR"),this.componentColors=[kM.getColor("X_AXIS_COLOR"),kM.getColor("Y_AXIS_COLOR"),kM.getColor("Z_AXIS_COLOR")]}updateGraphics(){if(this.drawDistanceP||this.drawDeltaP){const e=[this.deltaPoint[0],0,0],t=[0,this.deltaPoint[1],0],i=ge.S4.add(this.startPoint,e,M.create()),s=ge.S4.add(i,t,M.create()),n=this.endPoint;if(this.drawDeltaP){const e=(0,Yd.W5)(this.startPoint,i);(0,Yd.Ab)(this.componentColors[0],e),(0,Yd.VQ)(this.lineWidth,e),(0,Yd.KZ)(this.measurementStipple,e),this.updateMeshIncrement("xedge",yi.ZJ,e,BM);const t=(0,Yd.W5)(i,s);(0,Yd.Ab)(this.componentColors[1],t),(0,Yd.VQ)(this.lineWidth,t),(0,Yd.KZ)(this.measurementStipple,t),this.updateMeshIncrement("yedge",yi.ZJ,t,BM);const r=(0,Yd.W5)(s,n);(0,Yd.Ab)(this.componentColors[2],r),(0,Yd.VQ)(this.lineWidth,r),(0,Yd.KZ)(this.measurementStipple,r),this.updateMeshIncrement("zedge",yi.ZJ,r,BM)}if(this.drawDistanceP){const e=(0,Yd.W5)(this.startPoint,this.endPoint);(0,Yd.Ab)(this.distanceColor,e),(0,Yd.VQ)(this.lineWidth,e),(0,Yd.KZ)(this.measurementStipple,e),this.updateMeshIncrement(qM,yi.ZJ,e,BM)}}else if(this.drawStartPointP&&this.startPoint){const e=(0,Yd.Pu)(this.startPoint,"startPoint",this.distanceColor,this.pointSize);this.updateMeshIncrement("point0",yi.ZJ,e,VM)}else if(this.drawEndPointP&&this.endPoint){const e=(0,Yd.Pu)(this.endPoint,"endPoint",this.distanceColor,this.pointSize);this.updateMeshIncrement("point1",yi.ZJ,e,VM)}}setPermanentlyHighlightDistance(e){this.permanentlyHighlightDistance=e}drawNothing(){this.removeMeshIncrements(),this.drawDeltaP=!1,this.drawStartPointP=!1,this.drawEndPointP=!1,this.permanentlyHighlightDistance?this.drawDistanceP=!0:this.drawDistanceP=!1,this.viewer.requestDraw()}drawDelta(){this.removeMeshIncrements(),this.drawDeltaP=!0,this.drawStartPointP=!1,this.drawEndPointP=!1,this.permanentlyHighlightDistance?this.drawDistanceP=!0:this.drawDistanceP=!1,this.viewer.requestDraw()}drawStartPoint(){this.removeMeshIncrements(),this.drawDeltaP=!1,this.drawStartPointP=!0,this.drawEndPointP=!1,this.permanentlyHighlightDistance?this.drawDistanceP=!0:this.drawDistanceP=!1,this.viewer.requestDraw()}drawEndPoint(){this.removeMeshIncrements(),this.drawDeltaP=!1,this.drawStartPointP=!1,this.drawEndPointP=!0,this.permanentlyHighlightDistance?this.drawDistanceP=!0:this.drawDistanceP=!1,this.viewer.requestDraw()}drawDistance(){this.removeMeshIncrements(),this.drawDeltaP=!1,this.drawStartPointP=!1,this.drawEndPointP=!1,this.drawDistanceP=!0,this.viewer.requestDraw()}drawAngle(){}drawComb(){}callMethod(e){switch(e){case"drawAngle":this.drawAngle();break;case"drawComb":this.drawComb();break;case"drawDistance":this.drawDistance();break;case"drawDelta":this.drawDelta();break;case"drawStartPoint":this.drawStartPoint();break;case"drawEndPoint":this.drawEndPoint();break;default:this.drawNothing()}}getValue(){return this.distance}getDeltaPoint(){return this.deltaPoint}getStartPoint(){return this.startPoint}getEndPoint(){return this.endPoint}}class KM extends YM{constructor(e,t,i,s,n,r,a){super(e,t,a),this.startVector=i,this.endVector=s,this.angle=r,this.isInvalid=!1,this.drawAngleP=!1,this.startLength=ge.S4.length(i),this.startDir=ge.S4.normalize(i,M.create()),this.endLength=ge.S4.length(s),this.endDir=ge.S4.normalize(s,M.create()),this.normalDir=n,this.angleColor=kM.getColor("PROJECT_MEASUREMENT_ANGLE_COLOR"),this.angleLineWidth=GM.PROJECT_MEASUREMENT_ANGLE_LINE_WIDTH,this.measurementStipple=kM.getStipple("PROJECT_MEASUREMENT_STIPPLE")}onAppearanceConstantsUpdated(){this.angleColor=kM.getColor("PROJECT_MEASUREMENT_ANGLE_COLOR"),super.onAppearanceConstantsUpdated()}getValue(){return this.angle}updateGraphics(){if(this.drawAngleP){const e=50,t=(0,Yd.W5)(this.getStartPoint(),this.getEndPoint());(0,Yd.Ab)(this.distanceColor,t),(0,Yd.VQ)(this.lineWidth,t),(0,Yd.KZ)(this.measurementStipple,t),this.updateMeshIncrement(qM,yi.ZJ,t,BM);const i=ge.S4.add(this.getStartPoint(),this.startVector,M.create()),s=ge.S4.add(this.getStartPoint(),this.endVector,M.create()),n=ge.S4.add(this.getEndPoint(),this.startVector,M.create()),r=ge.S4.add(this.getEndPoint(),this.endVector,M.create()),a=(0,Yd.W5)(this.getStartPoint(),i);(0,Yd.Ab)(this.angleColor,a),(0,Yd.VQ)(this.angleLineWidth,a),this.updateMeshIncrement("edge00",yi.ZJ,a,BM);const o=(0,Yd.W5)(this.getStartPoint(),s);(0,Yd.Ab)(this.angleColor,o),(0,Yd.VQ)(this.angleLineWidth,o),(0,Yd.KZ)(kM.getStipple("PROJECT_MEASUREMENT_STIPPLE"),o),this.updateMeshIncrement("edge01",yi.ZJ,o,BM);const h=(this.startLength+this.endLength)/4,c=(0,Yd.QV)(this.getStartPoint(),h,this.normalDir,this.startDir,0,this.angle,e);(0,Yd.Ab)(this.angleColor,c),(0,Yd.VQ)(this.angleLineWidth,c),this.updateMeshIncrement("arc0",yi.ZJ,c,BM);const l=(0,Yd.W5)(this.getEndPoint(),n);(0,Yd.Ab)(this.angleColor,l),(0,Yd.VQ)(this.angleLineWidth,l),(0,Yd.KZ)(kM.getStipple("PROJECT_MEASUREMENT_STIPPLE"),l),this.updateMeshIncrement("edge10",yi.ZJ,l,BM);const d=(0,Yd.W5)(this.getEndPoint(),r);(0,Yd.Ab)(this.angleColor,d),(0,Yd.VQ)(this.angleLineWidth,d),this.updateMeshIncrement("edge11",yi.ZJ,d,BM);const u=(0,Yd.QV)(this.getEndPoint(),h,this.normalDir,this.startDir,0,this.angle,e);(0,Yd.Ab)(this.angleColor,u),(0,Yd.VQ)(this.angleLineWidth,u),this.updateMeshIncrement("arc1",yi.ZJ,u,BM)}}drawNothing(){this.removeMeshIncrements(),this.drawAngleP=!1,(0,Xs.vm)()}drawAngle(){this.removeMeshIncrements(),this.drawAngleP=!0,(0,Xs.vm)()}drawDistance(){}drawDelta(){}drawStartPoint(){}drawEndPoint(){}}class jM extends YM{constructor(e,t,i,s,n,r){super(e[0],e[0],r),this.isInvalid=!1,this.drawCombP=!1,this.combIndex=0,this.oversampling=1,this.points=e,this.normals=t,this.lengths=i,this.combIndex=s,this.oversampling=n}getValue(){return 0}updateGraphics(){if(this.drawCombP){const e=this.points.length,t=[],i=[],s=[];for(let s=0;s<e;s++){const e=M.create();ge.S4.linComb(this.points[s],1,this.normals[s],this.lengths[s],e),i.push(e),s%this.oversampling||t.push(this.points[s],e)}for(let t=1;t<e;t++)s.push(i[t-1]),s.push(i[t]);const n=(0,Yd.pf)(t,"comb",kM.getColor(this.combIndex?"PROJECT_MEASUREMENT_CURVATURE_COLOR_2":"PROJECT_MEASUREMENT_CURVATURE_COLOR_1"),zM);this.updateMeshIncrement("combIncrement",yi.ZJ,n,UM);const r=(0,Yd.pf)(t,"stippledComb",kM.getColor(this.combIndex?"PROJECT_MEASUREMENT_CURVATURE_COLOR_2":"PROJECT_MEASUREMENT_CURVATURE_COLOR_1"),zM,WM);this.updateMeshIncrement("stippledCombIncrement",yi.ZJ,r,HM);const a=(0,Yd.pf)(s,"spine",kM.getColor(this.combIndex?"PROJECT_MEASUREMENT_CURVATURE_COLOR_2":"PROJECT_MEASUREMENT_CURVATURE_COLOR_1"),XM);this.updateMeshIncrement("spineCombIncrement",yi.ZJ,a,UM);const o=(0,Yd.pf)(s,"stippledSpine",kM.getColor(this.combIndex?"PROJECT_MEASUREMENT_CURVATURE_COLOR_2":"PROJECT_MEASUREMENT_CURVATURE_COLOR_1"),XM,ZM);this.updateMeshIncrement("stippledSpineIncrement",yi.ZJ,o,HM)}}drawNothing(){this.removeMeshIncrements(),this.drawCombP=!1,(0,Xs.vm)()}drawComb(){this.removeMeshIncrements(),this.drawCombP=!0,(0,Xs.vm)()}drawDistance(){}drawDelta(){}drawStartPoint(){}drawEndPoint(){}}var QM=i(9283);const $M=X.default.getManager(),JM=new Gi.hF({isPickable:!0,isTwoSided:!0,isStencilWritten:!1,primitivesHaveTransparency:!0,primitiveType:Ai.MX.LINES,material:Vi,includedInBlend:!0,debugId:"cPlaneOutline"}),ey=new Gi.hF({isPickable:!0,isTwoSided:!0,isTintedByCompare:!0,primitiveType:Ai.MX.LINES,includedInBlend:!0}),ty=M.create(),iy=M.create(),sy=M.create();var ny;!function(e){e.TOP_LEFT="TOP_LEFT",e.TOP_RIGHT="TOP_RIGHT",e.BOTTOM_LEFT="BOTTOM_LEFT",e.BOTTOM_RIGHT="BOTTOM_RIGHT"}(ny||(ny={}));const ry=new Gi.hF({isPickable:!0,primitiveType:Ai.MX.TRIANGLES,primitivesHaveTransparency:!0,material:Vi,isTwoSided:!0,includedInBlend:!0,isTintedByCompare:!0,zOffset:X.default.getManager().getNumber("CPLANE_Z_OFFSET"),debugId:"cPlaneFace"});function ay(e){const t=e.getProperties().id;return t===ry.id||t===ey.id||t===JM.id}const oy="quadFace",hy="outline";class cy extends yi.u1{constructor(e,t,i,s,n){super(n,i),this.textColorName=e,this.entityId=t,this.planeId=s,this.name="",this.center=M.create(),this.centerOffset=M.create(),this.xAxis=M.fromValues(1,0,0),this.yAxis=M.fromValues(0,1,0),this.lastSetAppearance=void 0,this.node=null,this.width=0,this.height=0,this.initialWidth=0,this.initialHeight=0,this.increments={},this.lastTextScale=-1,this.textTexture=null,this.resizeManipulators={},this.usage=i===uh.Vv?ys.L.PREVIEW:ys.L.BASE,this.textMaterial=Hi(),this.textNodeProperties=new Gi.hF({isPickable:!1,isTwoSided:!0,primitiveType:Ai.MX.TRIANGLES,material:this.textMaterial,includedInBlend:!0}),this.occurrenceData.setCanIsolateChange(!0),this.occurrenceData.setIsolated(!1)}getDebugId(){return"ConstructionPlaneDisplay"}onDevicePixelRatioChanged(e){this.destroyText()}remove(){this.destroyText(),this.textMaterial&&(this.textMaterial.destroy(),this.textMaterial=null),this.removeResizeManipulators(),super.remove()}destroyText(){this.textTexture&&(this.textTexture.destroy(),this.textTexture=null)}setName(e){e=(0,Dn.truncate)(e,32),this.name!==e&&(this.destroyText(),(0,Xs.vm)()),this.name=e}updateAppearance(e){if(e&&e instanceof k.yVM){if(this.lastSetAppearance&&this.lastSetAppearance.equals(e))return;this.lastSetAppearance=e.clone(),this.width=e.width,this.height=e.height}else{if(null===this.lastSetAppearance)return;this.lastSetAppearance=null,this.width=this.initialWidth,this.height=this.initialHeight,this.centerOffset=[0,0,0]}this.updateDefinition(this.name,this.center,this.xAxis,this.yAxis,!0,!0),(0,Xs.vm)()}updateDefinition(e,t,i,s,n,r){if(this.name===e&&M.equals(t,this.center)&&M.equals(i,this.xAxis)&&M.equals(s,this.yAxis)||(this.destroyText(),(0,Xs.vm)()),0!==this.initialWidth||0!==this.initialHeight||M.equals(i,this.xAxis)||M.equals(s,this.yAxis)||(this.initialWidth=2*ge.S4.length(i),this.initialHeight=2*ge.S4.length(s)),this.width>0&&this.height>0&&(i=ge.S4.scale(ge.S4.normalize(i,M.create()),this.width/2,M.create()),s=ge.S4.scale(ge.S4.normalize(s,M.create()),this.height/2,M.create())),this.setName(e),this.center=t,this.xAxis=i,this.yAxis=s,Us()?n&&this.updateResizeManipulators(!1):this.removeResizeManipulators(),this.lastSetAppearance&&(!n||r)){const e=ge.S4.normalize(ge.S4.cross(this.xAxis,this.yAxis,M.create()),M.create());this.centerOffset=ge.S4.subtract((0,wi.qm)([this.lastSetAppearance.xOffset,this.lastSetAppearance.yOffset],this.center,e,ge.S4.normalize(this.xAxis,M.create())),this.center,M.create())}this.updatePlaneGraphics(),this.updateResizeManipulators(!1),this.isHidden&&this.hideIncrements()}updateResizeManipulators(e){const t=this,i=function(i,s,n){const r=ge.S4.add(t.center,t.centerOffset,M.create()),a=ge.S4.normalize(ge.S4.cross(t.xAxis,t.yAxis,M.create())),o=ge.S4.scale(t.xAxis,s,M.create()),h=ge.S4.scale(t.yAxis,n,M.create()),c=ge.S4.add(ge.S4.add(r,o,M.create()),h,M.create());t.resizeManipulators[i]?t.resizeManipulators[i].updateDefinition(c,a,o,h):e&&(t.resizeManipulators[i]=new fy(i,c,a,t,o,h,t.viewer))};i(ny.TOP_LEFT,-1,1),i(ny.TOP_RIGHT,1,1),i(ny.BOTTOM_LEFT,-1,-1),i(ny.BOTTOM_RIGHT,1,-1)}removeResizeManipulators(){for(const e in this.resizeManipulators){const t=this.resizeManipulators[e];t&&(t.cleanup(),t.remove()),this.resizeManipulators[e]=null}}updateText(e){const t=this.getTextTexture(),i=ge.S4.add(this.center,this.centerOffset,M.create()),s=ge.S4.add(i,ge.S4.scale(this.xAxis,-1,M.create()),M.create());ge.S4.add(s,this.yAxis);const n=e.getPixelSizeAtWorldPoint(this.transformPoint(s));let r=n*t.filledWidthPx,a=n*t.filledHeightPx,o=Math.min(ge.S4.length(this.xAxis)/r,ge.S4.length(this.yAxis)/a);if(o<0&&(o=0),o<1&&(r*=o,a*=o),Math.abs(this.lastTextScale-o)<=Ri.W.ZERO_LENGTH)return;this.lastTextScale=o;const h=ge.S4.normalize(this.xAxis,M.create()),c=ge.S4.normalize(this.yAxis,M.create()),l=ge.S4.add(s,ge.S4.scale(c,-a,M.create()),M.create()),d=ge.S4.add(l,ge.S4.scale(h,r,M.create()),M.create()),u=ge.S4.add(l,ge.S4.scale(c,a,M.create()),M.create());this.updateMeshIncrement("quad",yi.ZJ,(0,Yd.fQ)(l,d,u,void 0,[t.leftCoordinate,t.bottomCoordinate],[t.rightCoordinate,t.topCoordinate]),this.textNodeProperties),this.textMaterial.ambientTexture=t}updatePlaneGraphics(){const e=ge.S4.add(this.center,this.centerOffset,M.create()),t=X.default.getManager(),i=t.getColor("CONSTRUCTION_PLANE_OUTLINE_COLOR"),s=t.getNumber("CONSTRUCTION_PLANE_OUTLINE_WIDTH"),n=(0,Yd.PU)(e,this.xAxis,this.yAxis,i,s),r=Hs()?ey:JM;this.updateMeshIncrement(hy,hy,n,r),this.increments[hy]=n;const a=ge.S4.add(ge.S4.add(e,ge.S4.scale(this.xAxis,-1,M.create()),M.create()),this.yAxis,M.create()),o=ge.S4.add(ge.S4.add(e,ge.S4.scale(this.xAxis,-1,M.create()),M.create()),ge.S4.scale(this.yAxis,-1,M.create()),M.create()),h=ge.S4.add(ge.S4.add(e,this.xAxis,M.create()),ge.S4.scale(this.yAxis,-1,M.create()),M.create()),c=(0,Yd.fQ)(o,h,a);let l;if(Hs()){const e=ge.S4.cross(this.xAxis,this.yAxis,M.create()),t=(0,Yd.X)(this.center,e);(0,Yd.FT)(t,c)}else{l=t.getColor("CONSTRUCTION_PLANE_AMBIENT_COLOR").slice(0),l[3]=t.getNumber("CONSTRUCTION_PLANE_OPACITY"),(0,Yd.Ab)(l,c)}this.increments[oy]=c,this.updateMeshIncrement(oy,oy,c,ry),this.invalidateTextGraphics()}getIncrement(e){return e&&this.increments[e]?this.increments[e].clone():this.increments[oy]?this.increments[oy].clone():null}getBounds(){const e=new wi.kB,t=ge.S4.add(this.center,this.centerOffset,ty);for(let i=-1;i<=1;i+=2)for(let s=-1;s<=1;s+=2){const n=ge.S4.add(ge.S4.add(ge.S4.scale(this.xAxis,i,iy),ge.S4.scale(this.yAxis,s,sy)),t);e.addPoint(n)}return e}invalidateTextGraphics(){this.lastTextScale=-1}getTextTexture(){return this.textTexture||(this.textTexture=jo(this.viewer,this.name,{color:$M.getColor(this.textColorName),font:$M.getString("PLANE_TEXT_FONT"),size:$M.getNumber("PLANE_TEXT_HEIGHT_PX"),paddingWithinBorder:$M.getNumber("PLANE_TEXT_BACKGROUND_PADDING")}),this.invalidateTextGraphics()),this.textTexture}onViewWillDraw(e,t){this.isHidden||this.name&&this.updateText(e)}canPickThrough(){return!0}getModelSelection(e){const t=e.uiElement.getUsage(),i=(0,Me.cF)(this.entityId,void 0,t);return i&&(i.sourcePick=e.sourcePick,i.secondarySelectionData={isFromPlaneEdge:e.selectionId===hy}),i}getPickPriority(e){return e.selectionId===hy?gI.z.CONSTRUCTION_PLANE_EDGE:gI.z.CONSTRUCTION_PLANE}getUsage(){return this.usage}addHighlight(e){this.addHighlightToIncrement(hy,e),this.addHighlightToIncrement(oy,e),e.type!==Cn.o2.ENTITY&&e.type!==Cn.o2.FEATURE||!Us()||this.isHidden||this.updateResizeManipulators(!0),(0,Xs.vm)()}removeHighlight(e){return this.removeHighlightFromIncrement(hy,e),this.removeHighlightFromIncrement(oy,e),e.type!==Cn.o2.ENTITY&&e.type!==Cn.o2.FEATURE||this.removeResizeManipulators(),(0,Xs.vm)(),!0}cloneForPreview(){const e=Hs()?"CONSTRUCTION_PLANE_COMPARE_TEXT_COLOR":"CONSTRUCTION_PLANE_TEXT_COLOR",t=new cy(e,this.entityId,uh.Vv,this.planeId,this.viewer);return t.width=this.width,t.height=this.height,t.centerOffset=this.centerOffset,t.setName(this.name),t.updatePlaneGraphics(),t}isInteractionEnabled(){return!1}getCenter(){return M.fromValues(this.center[0],this.center[1],this.center[2])}getXAxis(){return M.fromValues(this.xAxis[0],this.xAxis[1],this.xAxis[2])}getYAxis(){return M.fromValues(this.yAxis[0],this.yAxis[1],this.yAxis[2])}getName(){return this.name}onAppearanceConstantsUpdated(){this.destroyText(),this.updatePlaneGraphics()}}const ly=X.default.getManager(),dy=1e-6,uy=500,gy="move",py=new Gi.hF({primitiveType:Ai.MX.TRIANGLES,material:Vi,zOffset:2,isTwoSided:!0,includedInBlend:!1,primitivesHaveTransparency:!0,isShowThrough:!0,isDepthTested:!1,addsToBounds:!1}),my=new Gi.hF({primitiveType:Ai.MX.TRIANGLE_STRIP,material:Vi,zOffset:2,isTwoSided:!0,includedInBlend:!1,primitivesHaveTransparency:!0,isShowThrough:!0,isDepthTested:!1,addsToBounds:!1});class fy extends yi.u1{constructor(e,t,i,s,n,r,a){super(a,s.usage===ys.L.BASE?uh.lL:uh.Vv),this.highlighted=!1,this.dragOffset=[0,0],this.resizeUniformly=!1,this.cursorString="",this.staticIncrements=null,this.center=t,this.normal=i,this.direction0=n,this.direction1=r,this.offset=Q.create(),this.parent=s,this.selectionId=e,this.listenTo(this,yi.zw.MOUSE_ENTER+this.selectionId,this.onMouseEnter),this.listenTo(this,yi.zw.MOUSE_LEAVE+this.selectionId,this.onMouseLeave),this.listenTo(this,yi.zw.DRAG_START+this.selectionId,this.onDragStart),this.listenTo(this,yi.zw.DRAG+this.selectionId,this.onDrag),this.listenTo(this,yi.zw.DRAG_STOP+this.selectionId,this.onDragStop)}onViewWillDraw(e,t){this.updateTransform(e),this.hasMeshIncrements()||this.updateGraphics()}onAppearanceConstantsUpdated(){this.removeMeshIncrements(),this.staticIncrements=null}updateTransform(e){const t=ue.create(),i=M.fromValues(this.center[0],this.center[1],this.center[2]),s=(ge.S4.length(this.parent.getXAxis())+ge.S4.length(this.parent.getYAxis()))/2,n=Math.min(e.getPixelSizeAtWorldPoint(this.transformPoint(i)),s/16),r=(0,ns.x_)();t[0]=n*r,t[5]=n*r,t[10]=n*r,t[12]=this.center[0],t[13]=this.center[1],t[14]=this.center[2],this.setTransform(t)}getClearModelSelectionsOnPrehilite(){return!1}getStaticIncrements(){if(this.staticIncrements)return this.staticIncrements;this.staticIncrements={};const e=[0,0,0],t=ge.S4.normalize(this.direction0,M.create()),i=ly.getNumber("RESIZE_MANIPULATOR_RADIUS"),s=this.selectionId+"FrontFace",n=(0,Yd.$)(e,i,this.normal,36);this.staticIncrements[s]={selection:this.selectionId,data:n,type:py,color:ly.getColor("RESIZE_MANIPULATOR_INNER_COLOR")};const r=this.selectionId+"Border",a=(0,Yd.I$)(e,i,1.3*i,this.normal,t,0,2*Math.PI,36);return this.staticIncrements[r]={selection:this.selectionId,data:a,type:my,color:ly.getColor("RESIZE_MANIPULATOR_OUTER_COLOR")},this.staticIncrements}updateGraphics(){this.updateIncrementsOnEntity(this.selectionId,"FrontFace"),this.updateIncrementsOnEntity(this.selectionId,"Border")}updateIncrementsOnEntity(e,t){const i=this,s=this.getStaticIncrements();s[e+t].type===py?(0,Yd.Ab)(s[e+t].color,s[e+t].data):s[e+t].type===my&&(0,Yd.Ab)(i.highlighted?ly.getColor("RESIZE_MANIPULATOR_OUTER_COLOR_HIGHLIGHT"):s[e+t].color,s[e+t].data),this.updateMeshIncrement(e+t,s[e+t].selection,s[e+t].data.clone(),s[e+t].type)}cleanup(){this.cursorString===gy&&(this.cursorString="",this.viewer.popCursor())}updateDefinition(e,t,i,s){this.staticIncrements=null,this.center=e,this.normal=ge.S4.normalize(t,M.create()),this.direction0=ge.S4.normalize(i,M.create()),this.direction1=ge.S4.normalize(s,M.create()),this.updateGraphics()}onMouseEnter(e,t){this.highlighted=!0,0===this.cursorString.length&&(this.cursorString=gy,this.viewer.pushCursor(this.cursorString)),this.updateGraphics(),(0,Xs.vm)()}onMouseLeave(e,t){this.highlighted&&(this.highlighted=!1,this.updateGraphics()),this.cursorString===gy&&(this.cursorString="",this.viewer.popCursor()),(0,Xs.vm)()}getOffsetFromEvent(e){const t=e.camera.getRay(e.mouseX,e.mouseY),i=M.create(),s=this.normal,n=y.fromValues(s[0],s[1],s[2],-M.dot(s,this.center)),r=(0,wi.fE)(t,n);if(null===r)return null;return[M.dot(ge.S4.subtract(r,this.center,i),this.direction0),M.dot(ge.S4.subtract(r,this.center,i),this.direction1)]}onDragStart(e,t,i){const s=this.getOffsetFromEvent(t);s&&(this.dragOffset=ge.gv.subtract(s,this.offset,Q.create()),i.requestDrag=!0,this.resizeUniformly=this.viewer.getLastMouseMovedEvent().shiftKey)}onDrag(e,t){const i=this.getOffsetFromEvent(t);if(!i)return;this.offset=ge.gv.subtract(i,this.dragOffset,Q.create());for(let e=0;e<this.offset.length;e++)this.offset[e]=parseFloat(this.offset[e].toFixed(8));let s,n,r=0,a=0;this.resizeUniformly?(s=2*ge.S4.length(this.parent.getXAxis())+2*this.offset[0],n=2*ge.S4.length(this.parent.getYAxis())+2*this.offset[1],s>dy&&s<uy&&(this.parent.width=s),n>dy&&n<uy&&(this.parent.height=n)):(s=2*ge.S4.length(this.parent.getXAxis())+1*this.offset[0],n=2*ge.S4.length(this.parent.getYAxis())+1*this.offset[1],s>dy&&s<uy&&(this.parent.width=s,r=this.offset[0]/2*M.dot(this.direction0,ge.S4.normalize(this.parent.getXAxis(),M.create()))),n>dy&&n<uy&&(this.parent.height=n,a=this.offset[1]/2*M.dot(this.direction1,ge.S4.normalize(this.parent.getYAxis(),M.create()))),this.parent.centerOffset=ge.S4.subtract(ge.S4.add(this.parent.centerOffset,(0,wi.qm)([r,a],this.parent.getCenter(),this.normal,ge.S4.normalize(this.parent.getXAxis(),M.create())),M.create()),this.parent.getCenter(),M.create())),this.parent.updateDefinition(this.parent.getName(),this.parent.getCenter(),this.parent.getXAxis(),this.parent.getYAxis(),!0),(0,Xs.vm)()}onDragStop(e,t){const i=new k.yVM;i.width=this.parent.width,i.height=this.parent.height;const s=(0,wi.LK)(ge.S4.add(this.parent.centerOffset,this.parent.getCenter(),M.create()),this.parent.getCenter(),this.normal,ge.S4.normalize(this.parent.getXAxis(),M.create()));i.xOffset=s[0],i.yOffset=s[1],this.viewer.getEventDispatcher().trigger(nM.P1,i,this.parent.planeId),this.offset=[0,0]}}class Iy extends m.T{constructor(e,t){super(),this.isEnabled=!1,this.selectionList=new Me.nZ(Iy.SELECTION_LIST_NAME),(0,Sh.Yk)(e),this.graphicsViewer=e,this.highlightFilterFunction=t}getIsEnabled(){return this.isEnabled}enable(){this.isEnabled=!0,this.setupHandlers(),this.updateSetOfFilteredEntities(),this.stopListening(),this.listenTo(this.graphicsViewer.getEventDispatcher(),nM.cy,this.updateSetOfFilteredEntities),this.latestDisplayDataUsageSubscription=Ls().latestDisplayDataUsageChangedObservable.subscribe((()=>this.updateSetOfFilteredEntities())),this.graphicsViewer.onLaminarEdgesChanged(!0)}disable(){this.isEnabled&&(this.isEnabled=!1,this.removeHandlers(),this.stopListening(),this.latestDisplayDataUsageSubscription.unsubscribe(),this.clearSelections(),this.graphicsViewer.onLaminarEdgesChanged(!1))}setupHandlers(){this.graphicsViewer.getModelViewManagers().getManager().handleSelectionListHighlights(Iy.SELECTION_LIST_NAME,this.selectionList,Cn.o2.FILTERED_ENTITIES);const e=(0,j.as)(Ch,this.graphicsViewer.getModelViewManagers().getPreviewManager());e?.handleSelectionListHighlights(Iy.SELECTION_LIST_NAME,this.selectionList,Cn.o2.FILTERED_ENTITIES)}removeHandlers(){this.graphicsViewer.getModelViewManagers().getManager().removeSelectionListHandler(Iy.SELECTION_LIST_NAME);const e=(0,j.as)(Ch,this.graphicsViewer.getModelViewManagers().getPreviewManager());e?.removeSelectionListHandler(Iy.SELECTION_LIST_NAME)}clearSelections(){this.selectionList.reset()}getSelectionList(){return this.selectionList}updateSetOfFilteredEntities(){this.clearSelections();const e=this.graphicsViewer.getModelViewManagers().getManager();this.updateHighlightsForPartStudio((0,j.as)(kg,e.getDisplayedPartStudio()));const t=(0,j.as)(Ch,this.graphicsViewer.getModelViewManagers().getPreviewManager());t&&this.updateHighlightsForPartStudio(t.getDisplayedPartStudio())}updateHighlightsForPartStudio(e){if(!e)return;const t=e.getFilteredEntityIds(this.highlightFilterFunction),i=!this.graphicsViewer.getIsolatedOccurrenceManager()?.isInIsolateOrMakeTransparentMode(),s=e.getBodyComponent();for(let n=0;n<t.length;++n){const r=(0,Me.cF)(t[n],null,e.usage);r&&e.getBodyVisibility(r.getBodyId())===Xs.EE.VISIBLE&&(i||s.isBodyIsolated(TE.KF,r.getBodyId()))&&this.selectionList.add(r)}}}Iy.SELECTION_LIST_NAME="filteredEntitiesList";var Ey=i(57702),Sy=i(84685);const Ty=_e.O.createLogger("XrController",k.bVy.GRAPHICS);class Dy{constructor(e){this.viewer=e,this.supportedSessionTypes=new Set,this.activeSessionType=null,this.startingSession=!1,this.animationFrameCallback=null,this.overrideCamera=new _h,this.modelViewInitialized=!1,this.modelTransform_=ue.create(),this.modelTransformInverse_=ue.create(),this.orderIndependentTransparencyEnabledOutsideXr=!0,this.xrInputDispatcher=new xy(this.viewer,this),this.xrSelectionHandler=new ky(this.viewer),this.xrInputDispatcher.addSelectHandler(this.xrSelectionHandler),this.xrInputDispatcher.addGamepadButtonHandler(this),this.xrViewController=new $y(e,this.xrInputDispatcher),this.xrMarkupController=new Hy(e,this.xrInputDispatcher),this.xrCommentController=new yy(e,this.xrInputDispatcher),this.animationFrameCallback=(e,t)=>this.onAnimationFrame(e,t),es.Jq.CapabilitiesService.isWebxrEnabled().then((t=>{if(!t)return;const i=Ky();i&&(i.isSessionSupported("immersive-vr").then((e=>{e&&this.supportedSessionTypes.add(Sy.$.VR)})),i.isSessionSupported("immersive-ar").then((e=>{e&&this.supportedSessionTypes.add(Sy.$.AR)}))),this.xrBaseFrameBuffer=new ih(e)}))}getSupportedSessionTypes(){return this.supportedSessionTypes}getActiveSessionType(){return this.activeSessionType}get xrReferenceSpace(){return this.xrReferenceSpace_}set modelTransform(e){this.modelTransform_=e,ue.invert(this.modelTransformInverse_,e),this.xrInputDisplay&&this.xrInputDisplay.onModelTransformChange(this.modelTransformInverse_)}get modelTransform(){return this.modelTransform_}get modelTransformInverse(){return this.modelTransformInverse_}startXr(e){if(this.startingSession)return void Ty.info("Attempt to start xr while session start was already pending");if(this.xrSession)throw new Error("XR session already in progress");if(!e)throw new Error("Invalid XrSessionType "+e);if(!this.supportedSessionTypes.has(e))throw new Error("Attempt to start unsuppported XrSessionType "+e);const t=this.viewer.getGlContext();t?.makeXRCompatible?(this.modelViewInitialized=!1,this.startingSession=!0,this.xrCommentController.checkMicrophonePermission().finally((()=>{t.makeXRCompatible().then((()=>this.startXrSession(e))).catch((e=>{Ty.warn("Error making context xr compatible: "+e)})).finally((()=>{this.startingSession=!1}))}))):Ty.warn("Could not make XR compatible context")}startXrSession(e){const t=Ky();t?t.requestSession(e).then((t=>(this.activeSessionType=e,this.xrSession=t,this.xrInputDispatcher.setXrSession(this.xrSession),(0,pt.isPlatformMetaQuest)()&&this.reduceDetailForSession(),this.xrSession.updateRenderState({baseLayer:new XRWebGLLayer(this.xrSession,this.viewer.getGlContext())})))).then((()=>{this.startXrRendering()})).catch((e=>{Ty.warn("Failed to create xr session: "+e)})):Ty.warn("Could not get xr system")}stopXr(){this.xrSession&&((0,pt.isPlatformMetaQuest)()&&this.restoreNonXrDetail(),this.xrInputDispatcher.resetXrSession(),this.xrSession.end().catch((e=>{Ty.debug("XR session end failed: "+e)})).finally((()=>{this.viewer.viewManipulator.show(),this.viewer.forceRequestDraw()})),this.modelTransform=ue.identity(ue.create()),this.removeInputDisplay(),this.xrMarkupController.clearMarkup(),Ey(".exit-xr-button").remove(),this.xrSession=null,this.activeSessionType=null,this.viewer.getAnimationController().requestAnimationFrameIfNeeded())}getIsXrRunning(){return!!this.xrSession}getXrInputDispatcher(){return this.xrInputDispatcher}startXrRendering(){this.xrSession?.requestReferenceSpace("local").then((e=>{this.xrReferenceSpace_=e,this.lastXrFrameTimeMs=(0,Xs.Wj)(),this.xrSession?.requestAnimationFrame(this.animationFrameCallback);const t=this.activeSessionType===Sy.$.AR?i18n("Exit AR"):i18n("Exit VR");Ey(`<button class="btn btn-default exit-xr-button" type="button">${t}</button>`).appendTo(".canvas-container").click((()=>{this.stopXr()}))})).catch((e=>{Ty.warn("Failed to get xr reference space: "+e)}))}onAnimationFrame(e,t){if(!this.xrSession)return;this.updateInput(t),this.viewer.setInRequestDrawCallback(!0);const i=t.getViewerPose(this.xrReferenceSpace_);if(!i)return Ty.debug("No pose found for device"),void this.xrSession.requestAnimationFrame(this.animationFrameCallback);const s=this.xrSession?.renderState?.baseLayer;if(!s)return;this.viewer.setSystemIsAnimating(),this.viewer.getAnimationController().advanceAnimation(e);const n=this.viewer.getGlContext();if(!n)return;n.bindFramebuffer(n.FRAMEBUFFER,s.framebuffer),this.xrBaseFrameBuffer.setExternalFrameBuffer(this.getFrameBufferWidth(),this.getFrameBufferHeight(),s.framebuffer),this.viewer.setBaseFrameBuffer(this.xrBaseFrameBuffer),this.activeSessionType===Sy.$.VR&&(n.clearColor(1,1,1,1),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT|n.STENCIL_BUFFER_BIT));for(let e=0;e<i.views.length;++e){const t=i.views[e];this.overrideCamera.setTransforms(this.modelTransform_,t.transform.inverse.matrix,t.projectionMatrix),this.lastXrViewMatrixInverse=ue.copy(ue.create(),t.transform.inverse.matrix),this.initializeModelView();const n=s.getViewport(t);this.overrideCamera.setViewport([n.x,n.y,n.width,n.height]);const r=null;this.viewer.draw(r,{camera:this.overrideCamera,performFrameTiming:0===e}),this.imageCaptureSuccessCallback&&"right"===t.eye&&this.performImageCapture(n)}const r=(0,Xs.Wj)();r-this.lastXrFrameTimeMs>=5e3&&(Ty.debug("XR frame rate: "+this.viewer.getFrameTimer().getAverageFrameRate(os.QpP.INTERACTIVE)+" fps"),this.lastXrFrameTimeMs=r),n.bindFramebuffer(n.FRAMEBUFFER,null),this.viewer.setBaseFrameBufferToDefault(),this.viewer.setInRequestDrawCallback(!1),this.xrSession.requestAnimationFrame(this.animationFrameCallback)}getCamera(){return this.overrideCamera}captureViewportImage(){return new Promise(((e,t)=>{this.imageCaptureSuccessCallback=e,this.imageCaptureErrorCallback=t}))}performImageCapture(e){const t=this.viewer.getGlContext();if(!this.imageCaptureSuccessCallback||!t)return;const i=X.default.getManager().getNumber("XR_COMMENT_VIEW_CAPTURE_PROPORTION"),s=Math.floor(e.width*i),n=Math.floor(e.height*i),r=e.x+Math.floor(s/2),a=e.y+Math.floor(n/2),o=new Uint8Array(s*n*4);t.readPixels(r,a,s,n,t.RGBA,t.UNSIGNED_BYTE,o),(0,Xs.Dy)(o,s,n),this.imageCaptureSuccessCallback({width:s,height:n,data:o}),this.imageCaptureSuccessCallback=null,this.imageCaptureErrorCallback=null}getFrameBufferWidth(){return this.xrSession?.renderState&&this.xrSession.renderState.baseLayer?this.xrSession.renderState.baseLayer.framebufferWidth:null}getFrameBufferHeight(){return this.xrSession?.renderState&&this.xrSession.renderState.baseLayer?this.xrSession.renderState.baseLayer.framebufferHeight:null}initializeModelView(){this.modelViewInitialized||(this.viewer.viewManipulator.hide(),this.xrViewController.initializeModelView(this.overrideCamera),this.modelViewInitialized=!0)}updateInput(e){const t=this.xrSession?.inputSources;if(!t)return;this.xrInputDispatcher.onFrameStart(e);let i=null;for(let e=0;e<t.length;++e)if(t[e].handedness===this.xrInputDispatcher.primaryControllerHandedness){i=t[e];break}if(!i||!this.xrSession)return void this.removeInputDisplay();const s=e.getPose(i.targetRaySpace,this.xrReferenceSpace_);s&&s.transform&&(this.xrInputDisplay||(this.xrInputDisplay=new wy(this.viewer,this.modelTransformInverse)),this.xrInputDisplay.update(s.transform.matrix,s.transform.inverse.matrix))}removeInputDisplay(){this.xrInputDisplay&&(this.xrInputDisplay.remove(),this.xrInputDisplay=null)}getDominantXrInputDisplay(){return this.xrInputDisplay}onGamepadButtonDown(e){return this.isStopXrButton(e)}onGamepadButtonDrag(e){}onGamepadButtonUp(e){this.isStopXrButton(e)&&this.stopXr()}isStopXrButton(e){return e.buttonNumber===os.qT7.B&&e.handType===os.dPT.DOMINANT}reduceDetailForSession(){this.orderIndependentTransparencyEnabledOutsideXr=(0,Xs.Z)(),(0,Xs.uP)(!1)}restoreNonXrDetail(){(0,Xs.uP)(this.orderIndependentTransparencyEnabledOutsideXr)}}const Cy=_e.O.createLogger("XrCommentController",k.bVy.GRAPHICS),My=window.SpeechRecognition||window.webkitSpeechRecognition;class yy{constructor(e,t){this.viewer=e,this.commentStarted=!1,this.commentImage=null,this.recognition=null,this.recognitionResult="",this.lastPreviewedText="",this.textPreview=null,t.addGamepadButtonHandler(this),My?(this.recognition=new My,this.recognition.continuous=!0,this.recognition.lang="en-US",this.recognition.interimResults=!0,this.recognition.onstart=()=>{Cy.trace("Speech recognition started")},this.recognition.onerror=e=>{Cy.info("Speech recognition error: "+e.error),this.abortComment()},this.recognition.onresult=e=>this.processRecognitionResult(e),this.recognition.onend=()=>{this.finishComment()}):Cy.debug("Speech recognition not available")}checkMicrophonePermission(){return new Promise(((e,t)=>{const i="os-microphone-permission-check-completed";if(localStorage.getItem(i))e();else{const s=new My;function n(){s.abort(),localStorage.setItem(i,"true"),e()}s.continuous=!0,s.lang="en-US",s.interimResults=!0,s.onstart=n,s.onerror=n,s.start()}}))}onGamepadButtonDown(e){return!(!this.commentStarted||!this.isAbortCommentButton(e))||!!this.recognition&&this.isDoCommentButton(e)}onGamepadButtonDrag(e){}onGamepadButtonUp(e){this.isDoCommentButton(e)?this.commentStarted?this.stopRecognition():this.startComment():this.isAbortCommentButton(e)&&this.abortComment()}isDoCommentButton(e){return e.buttonNumber===os.qT7.A&&e.handType===os.dPT.NON_DOMINANT}isAbortCommentButton(e){return e.buttonNumber===os.qT7.B&&e.handType===os.dPT.NON_DOMINANT}startComment(){this.commentStarted||(this.commentStarted=!0,this.recognitionResult="",this.lastPreviewedText="",this.viewer.getXrController().getIsXrRunning()?(this.viewer.getXrController().captureViewportImage().then((e=>{this.commentImage=e})).finally((()=>{this.startRecognition()})),this.updateTextPositionFromCamera(this.viewer.getXrController().getCamera())):(this.commentImage=this.viewer.retrieveViewportAsImage({width:this.viewer.getCamera().getCanvasWidth(),height:this.viewer.getCamera().getCanvasHeight(),useFlattenedView:!1,usePrint:!1,zoomToFit:!1,zoomToSelection:!1,showViewCube:!0,useRepairView:!1}),this.updateTextPositionFromCamera(this.viewer.getCamera()),this.startRecognition()))}startRecognition(){this.updateTextDisplay("Listening for comment…"),this.recognition?.start()}processRecognitionResult(e){if(void 0===e.results)return Cy.debug("Speech recognition gave no result"),void this.abortComment();let t="";for(let i=e.resultIndex;i<e.results.length;++i)e.results[i].isFinal?this.recognitionResult+=e.results[i][0].transcript:t+=e.results[i][0].transcript;this.updateTextDisplay(this.recognitionResult+t)}stopRecognition(){this.recognition?.stop()}finishComment(){if(!this.commentStarted)return;if(this.commentStarted=!1,!this.commentImage)return void Cy.warn("No image for xr comment");const e=this.recognitionResult;e?(0,Xs.Z$)(this.commentImage).then((t=>{const i={isNew:!0,elementId:this.viewer.getActiveElementId(),attachment:new File([t],"XR view.jpg")};(0,mr.m)().trigger(pr.C.PUBLISH_NEW_COMMENT,e,i)})):Cy.trace("Cannot post comment without message"),this.clearTextDisplay(),this.recognitionResult="",this.commentImage=null}abortComment(){this.clearTextDisplay(),this.commentStarted=!1,this.commentImage=null,this.recognition?.abort()}updateTextPositionFromCamera(e){this.textPreviewRight=M.copy(M.create(),e.getRight()),this.textPreviewUp=M.copy(M.create(),e.getUp());this.textPreviewOrigin=M.add(M.create(),e.getEye(),M.scale(M.create(),e.getForward(),1.5))}clearTextDisplay(){this.textPreview&&(this.textPreview.remove(),this.textPreview=null)}updateTextDisplay(e){if(this.lastPreviewedText===e)return;this.clearTextDisplay(),this.lastPreviewedText=e;let t="New comment:\n\n";const i=e.split(" ");let s=0;for(let e=0;e<i.length;++e)s>0&&(t+=" ",s+=1),t+=i[e],s+=i[e].length,s>=50&&(t+="\n",s=0);t+="\n\nLeft A: confirm     Left B: cancel",this.textPreview=new xa({origin:this.textPreviewOrigin,right:this.textPreviewRight,up:this.textPreviewUp,heightPx:20},this.viewer),this.textPreview.setText(t),this.textPreview.updateOnEachFrame=!1}}const Ay=.102,Py=[[-.032,0,0],[.032,0,0],[-.032,0,0],[0,-.038,0],[.032,0,0],[0,-.038,0],[0,0,-Ay],[-.032,0,0],[0,0,-Ay],[.032,0,0],[0,0,-Ay],[0,-.038,0]],Oy=new Gi.hF({isVisible:!0,isPickable:!1,isTwoSided:!0,isShowThrough:!1,isDepthTested:!0,priority:Gi.DO.DEFAULT,primitiveType:Ai.MX.LINES}),Ry=Oy.cloneAndModify({addsToBounds:!1});class wy extends yi.u1{constructor(e,t){super(e),this.modelTransformInverse=t,this.color=[1,0,0,1],this.pose=ue.create(),this.combinedTransform=ue.create(),this.hidePointerRay_=!1;const i=(0,Yd.pf)(Py,null,this.color);this.updateMeshIncrement("LINES",yi.ZJ,i,Oy)}update(e,t){if(!this.hidePointerRay_){const e=(0,Yd.pf)([[0,0,-Ay],[0,0,-10]],null,this.color);this.updateMeshIncrement("RAY",yi.ZJ,e,Ry)}ue.copy(this.pose,e),this.updateTransform()}onModelTransformChange(e){this.modelTransformInverse=e,this.updateTransform()}hidePointerRay(){this.removeMeshIncrement("RAY"),this.hidePointerRay_=!0}showPointerRay(){this.hidePointerRay_=!1}updateTransform(){ue.multiply(this.combinedTransform,this.modelTransformInverse,this.pose),this.setTransform(this.combinedTransform)}}const vy=_e.O.createLogger("XrInputDispatcher",k.bVy.GRAPHICS);var _y;!function(e){e.select="select",e.selectstart="selectstart",e.selectend="selectend",e.squeeze="squeeze",e.squeezestart="squeezestart",e.squeezeend="squeezeend"}(_y||(_y={}));class Ny{constructor(e,t,i,s){this.worldSpacePose=e,this.worldSpaceRay=t,this.modelSpacePose=i,this.modelSpaceRay=s}}class by{constructor(e,t,i){this.handType=e,this.buttonNumber=t,this.xrInputEvent=i}}class Ly{constructor(e,t,i){this.handType=e,this.gamepad=t,this.xrInputEvent=i}}class Fy{}class xy{constructor(e,t){this.viewer=e,this.xrController=t,this.eventToCallback=new Map,this.selectHandlers=[],this.activeSelectHandler=null,this.activeSelectSource=null,this.squeezeHandlers=[],this.activeSqueezeHandler=null,this.activeSqueezeSource=null,this.gamepadButtonStates=[],this.gamepadButtonHandlers=[],this.activeGamepadButtonHandlers=new Map,this.gamepadAxesHandlers=[],this.activeGamepadAxesHandler=[null,null],this.primaryControllerHandedness_=null,this.resetGamepadState()}resetGamepadState(){this.gamepadButtonStates=[],this.activeGamepadButtonHandlers=new Map;for(let e=os.dPT.DOMINANT;e<=os.dPT.NON_DOMINANT;++e){const t=[],i=new Map;for(let e=0;e<10;++e)t.push(new Fy),i.set(e,null);this.gamepadButtonStates.push(t),this.activeGamepadButtonHandlers.set(e,i)}}destroy(){this.removeXrSessionListeners()}get primaryControllerHandedness(){return this.primaryControllerHandedness_}setXrSession(e){this.xrSession!==e?(this.xrSession&&this.resetXrSession(),this.xrSession=e,this.bindListener(_y.select,this.onSelect),this.bindListener(_y.selectstart,this.onSelectStart),this.bindListener(_y.selectend,this.onSelectEnd),this.bindListener(_y.squeeze,this.onSqueeze),this.bindListener(_y.squeezestart,this.onSqueezeStart),this.bindListener(_y.squeezeend,this.onSqueezeEnd)):vy.debug("Called setXrSession twice for same session")}resetXrSession(){this.removeXrSessionListeners(),this.xrSession=null}removeXrSessionListeners(){for(const[e,t]of this.eventToCallback)this.xrSession?.removeEventListener(e,t);this.eventToCallback.clear()}addHandler(e,t){t.indexOf(e)<0&&t.unshift(e)}removeHandler(e,t){const i=t.indexOf(e);i>=0&&t.splice(i,1)}addSelectHandler(e){this.addHandler(e,this.selectHandlers)}removeSelectHandler(e){this.removeHandler(e,this.selectHandlers),this.activeSelectHandler===e&&(this.activeSelectHandler=null)}addSqueezeHandler(e){this.addHandler(e,this.squeezeHandlers)}removeSqueezeHandler(e){this.removeHandler(e,this.squeezeHandlers),this.activeSqueezeHandler===e&&(this.activeSqueezeHandler=null)}addGamepadButtonHandler(e){this.addHandler(e,this.gamepadButtonHandlers)}removeGamepadButtonHandler(e){this.removeHandler(e,this.gamepadButtonHandlers);for(const[t,i]of this.activeGamepadButtonHandlers)for(const[t,s]of i)s===e&&i.set(t,null)}addGamepadAxesHandler(e){this.addHandler(e,this.gamepadAxesHandlers)}removeGamepadAxesHandler(e){this.removeHandler(e,this.gamepadAxesHandlers);for(let t=0;t<this.activeGamepadAxesHandler.length;++t)this.activeGamepadAxesHandler[t]===e&&(this.activeGamepadAxesHandler[t]=null)}onFrameStart(e){const t=new Map;if(this.activeSelectSource&&this.activeSelectHandler){const i=this.getOsEventFromFrameAndSource(e,this.activeSelectSource,t);i&&this.activeSelectHandler.onXrSelectDrag(i)}if(this.activeSqueezeSource&&this.activeSqueezeHandler){const i=this.getOsEventFromFrameAndSource(e,this.activeSqueezeSource,t);i&&this.activeSqueezeHandler.onXrSqueezeDrag(i)}if(this.primaryControllerHandedness_||this.initializeHandedness(),!this.xrSession)return;let i=null,s=null;for(let e=0;e<this.xrSession.inputSources.length;++e)this.xrSession.inputSources[e].gamepad&&(this.xrSession.inputSources[e].handedness===this.primaryControllerHandedness?i||(i=this.xrSession.inputSources[e]):s||(s=this.xrSession.inputSources[e]));i&&this.updateGamepadState(os.dPT.DOMINANT,i,e,t),s&&this.updateGamepadState(os.dPT.NON_DOMINANT,s,e,t)}updateGamepadState(e,t,i,s){const n=t.gamepad;if(t.gamepad){for(let r=0;r<n.buttons.length;++r){if(r>=10){vy.debug("Trying to track a button beyond what we support: "+r);continue}const a=n.buttons[r],o=this.gamepadButtonStates[e][r],h=this.activeGamepadButtonHandlers.get(e).get(r);if(a.pressed&&!o.timePressed){o.timePressed=(0,Xs.Wj)();const n=new by(e,r,this.getOsEventFromFrameAndSource(i,t,s));for(const t of this.gamepadButtonHandlers)if(t.onGamepadButtonDown(n)){this.activeGamepadButtonHandlers.get(e).set(r,t);break}}else if(!a.pressed&&o.timePressed){if(o.timePressed=null,h){const n=new by(e,r,this.getOsEventFromFrameAndSource(i,t,s));h.onGamepadButtonUp(n),this.activeGamepadButtonHandlers.get(e).set(r,null)}}else if(a.pressed&&h){const n=new by(e,r,this.getOsEventFromFrameAndSource(i,t,s));h.onGamepadButtonDrag(n)}}if(this.activeGamepadAxesHandler[e]){const r=new Ly(e,n,this.getOsEventFromFrameAndSource(i,t,s));this.activeGamepadAxesHandler[e].onGamepadAxesUpdate(r)||(this.activeGamepadAxesHandler[e]=null)}else if(this.gamepadButtonHandlers.length>0){const r=new Ly(e,n,this.getOsEventFromFrameAndSource(i,t,s));for(const t of this.gamepadAxesHandlers)t.onGamepadAxesUpdate(r)&&(this.activeGamepadAxesHandler[e]=t)}}else vy.warn("Should only update with gamepad input sources")}initializeHandedness(){if(!this.xrSession)return;let e,t;for(let i=0;i<this.xrSession.inputSources.length;++i)this.xrSession.inputSources[i].gamepad&&("right"===this.xrSession.inputSources[i].handedness?e=!0:"left"===this.xrSession.inputSources[i].handedness&&(t=!0));e?this.primaryControllerHandedness_="right":t&&(this.primaryControllerHandedness_="left")}bindListener(e,t){const i=e=>{t.bind(this)(this.getOsEventFromSourceEvent(e),e)};this.xrSession.addEventListener(e,i),this.eventToCallback.set(e,i)}getOsEventFromSourceEvent(e){return this.getOsEventFromFrameAndSource(e.frame,e.inputSource)}getOsEventFromFrameAndSource(e,t,i){const s=i?.get(t);if(s)return s;const n=e.getPose(t.targetRaySpace,this.xrController.xrReferenceSpace);if(!n?.transform)return null;const r=this.xrController.modelTransformInverse,a=ge.w$.multiplyVec3(n.transform.matrix,[0,0,0]),o=ge.w$.multiplyVec3(r,a,M.create()),h=ge.w$.multiplyVec4(n.transform.matrix,[0,0,-1,0]),c=ge.w$.multiplyVec4(r,h,y.create()),l=new wi.zH(a,h),d=new wi.zH(o,c),u=ue.multiply(ue.create(),r,n.transform.matrix),g=new Ny(n.transform.matrix,l,u,d);return i&&i.set(t,g),g}onSelectStart(e,t){for(let t=0;t<this.selectHandlers.length;++t)if(this.selectHandlers[t].onXrSelectStart(e)){this.activeSelectHandler=this.selectHandlers[t];break}this.activeSelectSource=t.inputSource}onSelect(e,t){if(t.inputSource.handedness!==this.primaryControllerHandedness_){this.primaryControllerHandedness_=t.inputSource.handedness;const e=this.gamepadButtonStates[os.dPT.DOMINANT];return this.gamepadButtonStates[os.dPT.DOMINANT]=this.gamepadButtonStates[os.dPT.NON_DOMINANT],void(this.gamepadButtonStates[os.dPT.NON_DOMINANT]=e)}this.activeSelectHandler&&this.activeSelectHandler.onXrSelect(e)}onSelectEnd(e,t){this.activeSelectHandler&&(this.activeSelectHandler.onXrSelectEnd(e),this.activeSelectHandler=null),this.activeSelectSource=null}onSqueezeStart(e,t){for(let t=0;t<this.squeezeHandlers.length;++t)if(this.squeezeHandlers[t].onXrSqueezeStart(e)){this.activeSqueezeHandler=this.squeezeHandlers[t];break}this.activeSqueezeSource=t.inputSource}onSqueeze(e,t){this.activeSqueezeHandler&&this.activeSqueezeHandler.onXrSqueeze(e)}onSqueezeEnd(e,t){this.activeSqueezeHandler&&(this.activeSqueezeHandler.onXrSqueezeEnd(e),this.activeSqueezeHandler=null),this.activeSqueezeSource=null}}const By=new Gi.hF({isVisible:!0,isPickable:!1,isTwoSided:!0,isShowThrough:!1,isDepthTested:!0,priority:Gi.DO.DEFAULT,primitiveType:Ai.MX.LINES});class Vy extends yi.u1{constructor(e,t,i){super(e);const s=(0,Yd.pf)(t,null,i,2);this.updateMeshIncrement("LINES",yi.ZJ,s,By)}}const Uy=[1,0,0,1];class Hy{constructor(e,t){this.viewer=e,this.lineMarkup=[],this.inProgressLine=[],this.inProgressMarkup=null,t.addGamepadButtonHandler(this)}clearMarkup(){for(const e of this.lineMarkup)e.remove();this.lineMarkup=[]}onGamepadButtonDown(e){return this.isDrawMarkupButton(e)?(this.inProgressLine=[],this.updateLineMarkupWithCurrentPosition(e),this.viewer.getXrController().getDominantXrInputDisplay().hidePointerRay(),!0):this.isClearMarkupButton(e)}onGamepadButtonDrag(e){this.isDrawMarkupButton(e)&&this.updateLineMarkupWithCurrentPosition(e)}onGamepadButtonUp(e){this.isDrawMarkupButton(e)?(this.inProgressMarkup&&(this.lineMarkup.push(this.inProgressMarkup),this.inProgressMarkup=null,this.inProgressLine=[]),this.viewer.getXrController().getDominantXrInputDisplay().showPointerRay()):this.isClearMarkupButton(e)&&this.clearMarkup()}updateLineMarkupWithCurrentPosition(e){const t=e.xrInputEvent.modelSpaceRay.evaluate(Ay);if(0===this.inProgressLine.length)return void this.inProgressLine.push(t);const i=this.inProgressLine[this.inProgressLine.length-1];M.dist(i,t)<1e-4||(1===this.inProgressLine.length||this.inProgressLine.push(i),this.inProgressLine.push(t),this.inProgressMarkup&&this.inProgressMarkup.remove(),this.inProgressMarkup=new Vy(this.viewer,this.inProgressLine,Uy))}isDrawMarkupButton(e){return e.buttonNumber===os.qT7.A&&e.handType===os.dPT.DOMINANT}isClearMarkupButton(e){return e.buttonNumber===os.qT7.B&&e.handType===os.dPT.NON_DOMINANT}}const Gy=_e.O.createLogger("XrSelectionHandler",k.bVy.GRAPHICS);class ky{constructor(e){this.viewer=e,this.draggedUiElement=null}onXrSelectStart(e){this.draggedUiElement=null;const t=this.handleEvent(e,!0);return!(!t.handledUiSelection||!t.handledUiSelection.uiElement.triggerXrDragStart(t.handledUiSelection,e))&&(this.draggedUiElement=t.handledUiSelection,!0)}onXrSelectDrag(e){this.draggedUiElement&&this.draggedUiElement.uiElement.triggerXrDrag(this.draggedUiElement,e)}onXrSelect(e){this.draggedUiElement&&Gy.debug("Had dragged ui element during xr select event")}onXrSelectEnd(e){this.draggedUiElement&&(this.draggedUiElement.uiElement.triggerXrDragStop(this.draggedUiElement,e),this.draggedUiElement=null)}handleEvent(e,t){const i=this.viewer.pickWithXrInput(e),s={};s.click=!t;let n=!1;const r=this.viewer.getUISelectionManager(),a={handledUiSelection:null};for(let e=0;e<i.length&&!n;++e){const o=i[e],h=o.getModelSelection();if(h&&!this.viewer.getSuppressModelSelection())n=(0,Va.rQ)(h,t,true,s),n&&r.handleEmptyUiPick(t,s);else if(o.isUIPick()&&(n=r.processUiPick(o,{}),n&&!this.viewer.getSuppressModelSelection())){const e=o.getUISelection();e&&!e.getClearModelSelectionsOnPrehilite()||(0,Va.Zs)(t,!0),a.handledUiSelection=o.uiSelection}}return n||this.viewer.getSuppressModelSelection()||(0,Va.Zs)(t,!1),a}}const Wy=new Gi.hF({isVisible:!0,isPickable:!1,isTwoSided:!0,isShowThrough:!0,isDepthTested:!1,priority:Gi.DO.DEFAULT,primitiveType:Ai.MX.LINES}),zy=[0,1,0,1],Xy=[0,0,1];class Zy extends yi.u1{constructor(e){super(e);const t=(0,Yd.y)([0,0,0],.5,Xy,128);(0,Yd.Ab)(zy,t),(0,Yd.VQ)(2,t),this.updateMeshIncrement("preview_circle",yi.ZJ,t,Wy)}updateLocation(e){const t=ue.create();ue.translate(t,t,e),this.setTransform(t)}}const qy=ue.rotateX(ue.create(),ue.identity(ue.create()),-Math.PI/2),Yy=ue.invert(ue.create(),qy);function Ky(){return navigator.xr}const jy=_e.O.createLogger("XrViewController",k.bVy.GRAPHICS);var Qy;!function(e){e[e.NONE=0]="NONE",e[e.FORWARD=1]="FORWARD",e[e.ROTATE_LEFT=2]="ROTATE_LEFT",e[e.ROTATE_RIGHT=3]="ROTATE_RIGHT"}(Qy||(Qy={}));class $y{constructor(e,t){this.viewer=e,this.initialModelTransform=null,this.initialWorldTransformInverse=null,this.activeTeleportMode=Qy.NONE,this.teleportPreview=null,this.modelCamera=new wh,t.addSqueezeHandler(this),t.addGamepadAxesHandler(this)}initializeModelView(e){const t=this.viewer.getCamera();if(!t)return;const i=this.viewer.getModelViewManagers().getManager().getModelBounds();if(!i.isInitialized()||!i.isFinite())return void jy.warn("Could not initialize xr view with bounds: "+i);const s=[e.getDirection()[0],0,e.getDirection()[2]];M.normalize(s,s);let n=null;const r=this.viewer.retrieveCanvasLocationWorldPosition([t.getCanvasWidth()/2,t.getCanvasHeight()/2]);if(r){const e=t.getPixelSizeAtWorldPoint(r),s=t.getCanvasHeight()*e,n=2;if(i.diameter()>s*n){const e=s/2/Math.tan((0,wi.Yr)(Oh/2)),i=M.scaleAndAdd(M.create(),r,t.getForward(),-e);return void this.setModelTransform(this.getTransform(i,t.getForward()))}}if(!n){const t=.4+i.diameter()/5,r=M.add(M.create(),e.getEye(),M.scale(M.create(),s,t));r[1]-=i.diameter()/2,n=ue.translate(ue.create(),ue.identity(ue.create()),r)}this.setModelTransform(ue.multiply(ue.create(),n,qy))}onXrSqueezeStart(e){return this.initialWorldTransformInverse=ue.invert(ue.create(),e.worldSpacePose),this.initialModelTransform=ue.copy(ue.create(),this.viewer.getXrController().modelTransform),!0}onXrSqueezeDrag(e){const t=ue.multiply(ue.create(),e.worldSpacePose,this.initialWorldTransformInverse);this.setModelTransform(ue.multiply(ue.create(),t,this.initialModelTransform))}onXrSqueeze(e){}onXrSqueezeEnd(e){this.initialWorldTransformInverse=null,this.initialModelTransform=null}onGamepadAxesUpdate(e){if(e.handType===os.dPT.NON_DOMINANT)return!1;const t=Math.abs(e.gamepad.axes[2])>=.5&&(this.activeTeleportMode===Qy.NONE||this.activeTeleportMode===Qy.ROTATE_LEFT||this.activeTeleportMode===Qy.ROTATE_RIGHT),i=e.gamepad.axes[3]<-.5&&(this.activeTeleportMode===Qy.NONE||this.activeTeleportMode===Qy.FORWARD);if(t)e.gamepad.axes[2]<0?(this.updateRotationTeleport(45),this.activeTeleportMode=Qy.ROTATE_LEFT):(this.updateRotationTeleport(-45),this.activeTeleportMode=Qy.ROTATE_RIGHT);else if(i)this.updateTeleportLocationAndPreview(e),this.activeTeleportMode=Qy.FORWARD;else{if(this.activeTeleportMode!==Qy.NONE){this.teleportPreview&&(this.teleportPreview.remove(),this.teleportPreview=null);const e=M.fromValues(this.xrTeleportLocation[0],this.xrTeleportLocation[1],this.xrTeleportLocation[2]);this.setModelTransform(this.getTransform(e,this.xrTeleportDirection))}this.activeTeleportMode=Qy.NONE}return this.activeTeleportMode!==Qy.NONE}updateRotationTeleport(e){const t=this.viewer.getXrController().getCamera().getViewMatrixInverse(),i=ue.rotateY(ue.create(),ue.create(),(0,wi.Yr)(e));ue.multiply(i,this.viewer.getXrController().lastXrViewMatrixInverse,i);const s=y.transformMat4(y.create(),[0,0,-1,0],i);this.xrTeleportDirection=y.transformMat4(y.create(),s,t),this.xrTeleportLocation=M.transformMat4(M.create(),[0,0,0],t)}updateTeleportLocationAndPreview(e){this.teleportPreview||(this.teleportPreview=new Zy(this.viewer));const t=this.viewer.getDepthForXrInput(e.xrInputEvent);t<0&&jy.debug("Teleport depth distance was negative: "+t.toFixed(3)),this.teleportPreview.show();const i=e.xrInputEvent.modelSpaceRay.evaluate(t);this.xrTeleportLocation=M.copy(M.create(),i);this.xrTeleportLocation[2]+=1.7;const s=y.transformMat4(y.create(),[0,0,-1,0],this.viewer.getXrController().lastXrViewMatrixInverse);this.xrTeleportDirection=y.transformMat4(y.create(),s,this.viewer.getXrController().getCamera().getViewMatrixInverse()),this.teleportPreview.updateLocation(i)}setModelTransform(e){this.viewer.getXrController().modelTransform=e}getTransform(e,t){const i=M.fromValues(t[0],t[1],0);M.normalize(i,i);const s=M.fromValues(0,0,1);return this.modelCamera.setViewPositionAndOrientation(e,i,s),this.modelCamera.getViewMatrix()}}const Jy=new Gi.hF({isShowThrough:!1,isPickable:!1,primitiveType:Ai.MX.LINES});class eA extends yi.u1{constructor(e,t){super(e),this.graphicsId=eA.GRAPHICS_ID_PREFIX+t,this.setId(this.graphicsId)}getExplodeLineNodeProperties(){return Jy}onAppearanceConstantsUpdated(){this.updateGraphics()}}eA.GRAPHICS_ID_PREFIX="EXPLODE_LINE_GRAPHICS_";const tA=X.default.getManager();class iA extends eA{constructor(e,t){super(e,t)}updateDefinition(e){e.startPosition&&e.center&&e.axis&&e.hasOwnProperty("angle")&&(this.startPosition=e.startPosition,this.arcCenter=e.center,this.arcAxis=e.axis,this.arcAngle=e.angle),this.updateGraphics()}updateGraphics(){const e=ge.S4.subtract(this.startPosition,this.arcCenter,M.create()),t=ge.S4.normalize(e,M.create()),i=ge.S4.length(e),s=this.arcAngle,n=tA.getNumber("EXPLODE_LINE_CIRCLE_SEGMENT_COUNT")*Math.abs(s-0)/(2*Math.PI),r=(0,Yd.QV)(this.arcCenter,i,this.arcAxis,t,0,s,n);(0,Yd.VQ)(1,r),(0,Yd.Ab)(tA.getColor("EXPLODE_LINE_COLOR"),r),(0,Yd.KZ)(tA.getStipple("EXPLODE_LINE_STIPPLE"),r);const a=this.graphicsId+"_MESH_INCREMENT";this.updateMeshIncrement(a,yi.ZJ,r,this.getExplodeLineNodeProperties())}}const sA=X.default.getManager();class nA extends eA{constructor(e,t){super(e,t),this.startPosition=null,this.endPosition=null}updateDefinition(e){this.startPosition=e.startPosition,this.endPosition=e.endPosition,this.updateGraphics()}updateGraphics(){const e=(0,Yd.W5)(this.startPosition,this.endPosition);(0,Yd.VQ)(1,e),(0,Yd.Ab)(sA.getColor("EXPLODE_LINE_COLOR"),e),(0,Yd.KZ)(sA.getStipple("EXPLODE_LINE_STIPPLE"),e);const t=this.graphicsId+"_MESH_INCREMENT";this.updateMeshIncrement(t,yi.ZJ,e,this.getExplodeLineNodeProperties())}}var rA,aA=i(27124),oA=i(4644),hA=i(82630);class cA extends f{constructor(e,t,i,s){super(e,null),this.pass1=t,this.pass2=i,this.predicate=s,this.childPasses=[this.pass1,this.pass2]}setInput(e,t){this.pass1.setInput(e,t),this.pass2.setInput(e,t)}prepareShaders(){this.predicate()?this.pass1.prepareShaders():this.pass2.prepareShaders()}drawInputs(e){this.predicate()?this.pass1.drawInputs(e):this.pass2.drawInputs(e)}preDraw(e){return this.predicate()?this.pass1.preDraw(e):this.pass2.preDraw(e)}justBeforeDraw(e){this.predicate()?this.pass1.justBeforeDraw(e):this.pass2.justBeforeDraw(e)}postDraw(e){this.predicate()?this.pass1.postDraw(e):this.pass2.postDraw(e)}justAfterDraw(e){this.predicate()?this.pass1.justAfterDraw(e):this.pass2.justAfterDraw(e)}draw(e){this.predicate()?this.pass1.draw(e):this.pass2.draw(e)}setEnabled(e){this.pass1.setEnabled(e),this.pass2.setEnabled(e)}destroy(){this.pass1.destroy(),this.pass2.destroy()}setCheckFrameId(e){this.pass1.setCheckFrameId(e),this.pass2.setCheckFrameId(e)}getSceneGraph(){return this.predicate()?this.pass1.getSceneGraph():this.pass2.getSceneGraph()}isPickPass(){return this.predicate()?this.pass1.isPickPass():this.pass2.isPickPass()}isHighlightPass(){return this.predicate()?this.pass1.isHighlightPass():this.pass2.isHighlightPass()}getActiveHighlightType(){return this.predicate()?this.pass1.getActiveHighlightType():this.pass2.getActiveHighlightType()}isShowthroughPass(){return this.predicate()?this.pass1.isShowthroughPass():this.pass2.isShowthroughPass()}forIsolate(){return this.predicate()?this.pass1.forIsolate():this.pass2.forIsolate()}getShaderId(){return this.predicate()?this.pass1.getShaderId():this.pass2.getShaderId()}needsAttribute(e){return this.predicate()?this.pass1.needsAttribute(e):this.pass2.needsAttribute(e)}getPickIteration(){return this.predicate()?this.pass1.getPickIteration():this.pass2.getPickIteration()}nodeFilter(e){return this.predicate()?this.pass1.nodeFilter(e):this.pass2.nodeFilter(e)}getLastRenderedFrame(){return this.predicate()?this.pass1.getLastRenderedFrame():this.pass2.getLastRenderedFrame()}setHideSelectionInterior(e){this.pass1.setHideSelectionInterior(e),this.pass2.setHideSelectionInterior(e)}getPerformIsolationTest(){return this.pass1.getPerformIsolationTest()||this.pass2.getPerformIsolationTest()}setPerformIsolationTest(e){this.pass1.setPerformIsolationTest(e),this.pass2.setPerformIsolationTest(e)}needsFaceAppearances(){return this.predicate()?this.pass1.needsFaceAppearances():this.pass2.needsFaceAppearances()}onAppearanceConstantsUpdated(){this.predicate()?this.pass1.onAppearanceConstantsUpdated():this.pass2.onAppearanceConstantsUpdated()}}class lA extends cA{setExtraMeshNodeFilter(e){this.pass1.setExtraMeshNodeFilter(e),this.pass2.setExtraMeshNodeFilter(e)}setOpacity(e){this.pass1.setOpacity(e),this.pass2.setOpacity(e)}setSceneGraph(e){this.pass1.setSceneGraph(e),this.pass2.setSceneGraph(e)}setEnableColorWrites(e){this.pass1.setEnableColorWrites(e),this.pass2.setEnableColorWrites(e)}setNodeFilter(e){this.pass1.setNodeFilter(e),this.pass2.setNodeFilter(e)}appliesTranslucentAlphaToAll(e){this.pass1.appliesTranslucentAlphaToAll(e),this.pass2.appliesTranslucentAlphaToAll(e)}}class dA extends cA{setShouldEnableSilhouettes(e){this.pass1.setShouldEnableSilhouettes(e)}setDrawNonIsolated(e){this.pass1.setDrawNonIsolated(e)}setEdgesEnabled(e){this.pass1.setEdgesEnabled(e)}appliesTranslucentAlphaToAll(e){this.pass1.appliesTranslucentAlphaToAll(e)}setDepthOpacity(e){this.pass1.setDepthOpacity(e)}setDepthPassEnabled(e){this.pass1.setDepthPassEnabled(e)}setExtraFaceMeshNodeFilter(e){this.pass1.setExtraFaceMeshNodeFilter(e),this.pass2.setExtraMeshNodeFilter(e)}}!function(e){e.ARROWS_ID="arrows",e.NO_SELECTION_ID="",e.WITNESS0_ID="witness0",e.WITNESS1_ID="witness1",e.WITNESS_EXTENSION0_ID="extension0",e.WITNESS_EXTENSION1_ID="extension1",e.DIMENSION_LINE0_ID="dimensionLine0",e.LINE_SELECTION_ID="line",e.ARC_PRIMITIVE_ID="arc",e.ARC_LENGTH_SYMBOL_ID="arc_length",e.VALUE_SELECTION_ID="value",e.RADIUS_SYMBOL="R",e.DIAMETER_SYMBOL="Ø",e.CURVE_LENGTH_SYMBOL="⌒";const t={isVisible:!0,isTwoSided:!0,primitiveType:Ai.MX.LINES};e.LINE_PROPERTIES=[new Gi.hF(Object.assign({isShowThrough:!0,isDepthTested:!1,isPickable:!0,priority:Gi.DO.LOWER,isStencilTested:!1},t)),new Gi.hF(Object.assign({isShowThrough:!0,isDepthTested:!1,isPickable:!1,priority:Gi.DO.LOWER,isStencilTested:!1},t)),new Gi.hF(Object.assign({isShowThrough:!1,isDepthTested:!0,isPickable:!0,priority:Gi.DO.DEFAULT,isStencilTested:!1},t)),new Gi.hF(Object.assign({isShowThrough:!0,isDepthTested:!1,isPickable:!1,priority:Gi.DO.LOWER,isStencilTested:!0},t))];const i={isVisible:!0,isPickable:!1,isTwoSided:!0,material:Vi,primitiveType:Ai.MX.TRIANGLES};e.ARROW_PROPERTIES=[new Gi.hF(Object.assign({isShowThrough:!0,isDepthTested:!1,priority:Gi.DO.LOWER},i)),new Gi.hF(Object.assign({isShowThrough:!0,isDepthTested:!1,priority:Gi.DO.LOWER},i)),new Gi.hF(Object.assign({isShowThrough:!1,isDepthTested:!0,priority:Gi.DO.DEFAULT,isStencilWritten:!0},i)),new Gi.hF(Object.assign({isShowThrough:!0,isDepthTested:!1,priority:Gi.DO.LOWER,isStencilTested:!0},i))]}(rA||(rA={}));const uA=X.default.getManager();class gA{constructor(e,t,i){this.valueWorldSize={height:0,width:0},this.toleranceWorldSize={height:0,width:0},this.combinedWorldSize={height:0,width:0},this.interGap=0,t&&(this.valueWorldSize.height=e*t.filledHeightPx,this.valueWorldSize.width=e*t.filledWidthPx),i&&(this.toleranceWorldSize.height=e*i.filledHeightPx,this.toleranceWorldSize.width=e*i.filledWidthPx),t&&i&&(this.interGap=uA.getNumber("DIMENSION_VALUE_TOLERANCE_OFFSET_PIXELS")*e),this.combinedWorldSize.height=Math.max(this.toleranceWorldSize.height,this.valueWorldSize.height),this.combinedWorldSize.width=this.toleranceWorldSize.width+this.valueWorldSize.width+this.interGap}getValueCorners(e,t,i,s){const n=.5*(this.combinedWorldSize.height-this.valueWorldSize.height),r=M.add(M.create(),M.scale(M.create(),t,n),e);return s&&M.add(r,r,M.scale(M.create(),i,this.toleranceWorldSize.width+this.interGap)),{lowerLeft:r,lowerRight:M.add(M.create(),M.scale(M.create(),i,this.valueWorldSize.width),r),upperLeft:M.add(M.create(),M.scale(M.create(),t,this.valueWorldSize.height),r)}}getToleranceCorners(e,t,i,s){const n=.5*(this.combinedWorldSize.height-this.toleranceWorldSize.height),r=M.add(M.create(),M.scale(M.create(),t,n),e);return s||M.add(r,r,M.scale(M.create(),i,this.valueWorldSize.width+this.interGap)),{lowerLeft:r,lowerRight:M.add(M.create(),M.scale(M.create(),i,this.toleranceWorldSize.width),r),upperLeft:M.add(M.create(),M.scale(M.create(),t,this.toleranceWorldSize.height),r)}}}var pA=i(94199);class mA extends pA.Ro{constructor(e,t,i){super(e,t,i),this.displayData=null,this.id="LinearDimension"}getShouldBeRecreated(e){return!(e instanceof k.Ye1)}updateFromDisplayData(e){e instanceof k.Ye1&&(this.displayData=e),this.isBad=e.isOverDefined,this.isDriven=e.isDriven,this.updateDimensionMatrices(),this.viewer.requestDraw()}setPosition(e){this.displayData.positionX=e[0],this.displayData.positionY=e[1]}getPosition(){return Q.fromValues(this.displayData.positionX,this.displayData.positionY)}getDefaultPrecision(e){return e.getLengthUnitsDisplayPrecision()}getDimensionUnits(e){return e.getLengthUnits()}update(e,t){if(!this.displayData)return;let i;const s=[this.displayData.witnessEndPoint0X,this.displayData.witnessEndPoint0Y],n=[this.displayData.witnessEndPoint1X,this.displayData.witnessEndPoint1Y],r=this.getPosition(),a=e.getPixelSizeAtWorldPoint(this.transformPoint(this.getModelPoint(r[0],r[1]))),o=this.getModelPoint(s[0],s[1]),h=this.getModelPoint(n[0],s[1]),c=this.getModelPoint(s[0],s[1]+n[0]-s[0]);let l=ge.S4.normalize(ge.S4.subtract(h,o)),d=ge.S4.normalize(ge.S4.subtract(c,o));(M.dot(l,l)<Ri.W.ZERO_LENGTH_SQUARED||M.dot(d,d)<Ri.W.ZERO_LENGTH_SQUARED)&&(l=ge.S4.normalize(ge.S4.subtract(this.getModelPoint(1,0),o)),d=ge.S4.normalize(ge.S4.subtract(this.getModelPoint(0,1),o)));const u=this.getVisualRightVector(),g=this.getVisualUpVector(),p=Math.abs(this.displayData.value);let m=this.getConstantsManager().getNumber("DIMENSION_ARROW_HEIGHT_PIXELS")*a,f=this.getConstantsManager().getNumber("DIMENSION_ARROW_WIDTH_PIXELS")*a;const I=f;f>p*this.getConstantsManager().getNumber("DIMENSION_ARROW_MAX_PROPORTION")&&(i=p*this.getConstantsManager().getNumber("DIMENSION_ARROW_MAX_PROPORTION")/f,m*=i,f*=i);const E=[],S=this;function T(e,t,i,s){const n=S.getModelPoint(i,s);return ge.S4.add(n,ge.S4.add(ge.S4.scale(l,e,M.create()),ge.S4.scale(d,t,M.create())))}function D(e,t,i,s){const n=T(e,t,i,s);for(let e=0;e<3;++e)E.push(n[e])}D(0,0,s[0],r[1]),D(f,.5*-m,s[0],r[1]),D(f,.5*m,s[0],r[1]),D(0,0,n[0],r[1]),D(-f,.5*-m,n[0],r[1]),D(-f,.5*m,n[0],r[1]),this.updateDimensionComponent(rA.ARROWS_ID,rA.NO_SELECTION_ID,(0,Yd.ut)(E,[0,1,2,3,4,5],void 0,this.getArrowColor()),rA.ARROW_PROPERTIES);const C=(0,Ir.KZ)(this.displayData.value,t.getLengthUnits());this.updateValueTexture(C,t,this.getValuePrefix(t)),this.updateToleranceTexture(t);const y=this.valueTextureInfo.getTexture(),A=this.toleranceTextureInfo.getTexture(),P=new gA(a,y,A),O=M.scale(M.create(),g,.5*P.combinedWorldSize.height),R=this.getModelPoint(r[0],r[1]);M.subtract(R,R,O);const w=M.scale(M.create(),g,P.combinedWorldSize.height),v=M.scale(M.create(),u,.5*P.combinedWorldSize.width),_=M.subtract(M.create(),R,v),N=M.add(M.create(),R,v),b=M.add(M.create(),_,w),L=M.add(M.create(),N,w),F=zo(e,u,g,this.transform),x=M.add(M.create(),F[0]?N:_,O),B=this.updateIconDimensionComponent(a,x,u,g,F),V=this.getTextGap(l,u,P.combinedWorldSize.width,P.combinedWorldSize.height),U=B>0?this.getValueGapWithIcon(l,u,P.combinedWorldSize.width,P.combinedWorldSize.height,B,this.getIconPadding(a)):V,H=this.getScreenSpaceParameters(t,a);let G=H.extension;V>p&&(G=0);const k=s[1]+(r[1]>s[1]?H.gap:-H.gap),W=n[1]+(r[1]>n[1]?H.gap:-H.gap),z=r[1]+(r[1]>0?G:-G);this.updateDimensionLineComponent(rA.WITNESS0_ID,this.getModelPoint(s[0],k),this.getModelPoint(s[0],z)),this.updateDimensionLineComponent(rA.WITNESS1_ID,this.getModelPoint(n[0],W),this.getModelPoint(n[0],z));let X=s[0],Z=n[0];s[0]>n[0]&&(X=n[0],Z=s[0]);const{leftGapLength:q,rightGapLength:Y}=this.getLeftAndRightGapLengthInDimensionCoordinates(V,U,Q.fromValues(X,r[1]),Q.fromValues(Z,r[1]),F[0]);let K=r[0]+Y/2>Z+f/2,j=r[0]-q/2<X-f/2,$=[];const J=[];function ee(e,t,i,s,n){const r=T(e,t,i,s);n.push(r)}if(K||j?(this.updateDimensionLineComponent(rA.DIMENSION_LINE0_ID,this.getModelPoint(s[0],r[1]),this.getModelPoint(n[0],r[1])),K?this.updateDimensionLineComponent(rA.DIMENSION_LINE0_ID,this.getModelPoint(X,r[1]),this.getModelPoint(r[0]-q/2,r[1])):j&&this.updateDimensionLineComponent(rA.DIMENSION_LINE0_ID,this.getModelPoint(Z,r[1]),this.getModelPoint(r[0]+Y/2,r[1]))):(K=r[0]+Y/2>Z-f/2,j=r[0]-q/2<X+f/2,K?($.push(this.getModelPoint(X,r[1])),$.push(this.getModelPoint(r[0]-q/2,r[1]))):j?($.push(this.getModelPoint(r[0]+Y/2,r[1])),$.push(this.getModelPoint(Z,r[1]))):$=[this.getModelPoint(X,r[1]),this.getModelPoint(r[0]-q/2,r[1]),this.getModelPoint(r[0]+Y/2,r[1]),this.getModelPoint(Z,r[1])]),this.updateZExtensions(Q.fromValues(s[0],s[1]),Q.fromValues(n[0],n[1])),this.updateBasicBox([_,b,L,N]),this.preferences&&this.preferences.displayLimitRangeTicks){const e=this.displayData.value<0?-1:1;if(this.displayData.hasMinimumLimit){if(this.displayData.minimumLimit<0){const t=e<0?n:s;ee(0,0,t[0],t[1],$),ee(e*this.displayData.minimumLimit,0,s[0],s[1],$)}ee(e*this.displayData.minimumLimit,-I,s[0],s[1],J),ee(e*this.displayData.minimumLimit,I,s[0],s[1],J)}if(this.displayData.hasMaximumLimit){if(this.displayData.maximumLimit>0){const t=e<0?s:n;ee(0,0,t[0],t[1],$),ee(e*this.displayData.maximumLimit,0,s[0],r[1],$)}ee(e*this.displayData.maximumLimit,-I,s[0],s[1],J),ee(e*this.displayData.maximumLimit,I,s[0],s[1],J)}}$.length>0&&this.updateDimensionComponent(rA.DIMENSION_LINE0_ID,rA.LINE_SELECTION_ID,(0,Yd.pf)($,void 0,this.getLineColor(),this.getLineWidth(),this.getLineStyle()),rA.LINE_PROPERTIES);const te=rA.DIMENSION_LINE0_ID+"_TICK";if(J.length>0?this.updateDimensionComponent(te,rA.LINE_SELECTION_ID,(0,Yd.pf)(J,void 0,this.getLineColor(),this.getLineWidth()),rA.LINE_PROPERTIES):this.removeDimensionComponent(te),A){const e=P.getValueCorners(_,g,u,F[0]);this.updateValueDimensionComponent(y,e.lowerLeft,e.lowerRight,e.upperLeft,F);const t=P.getToleranceCorners(_,g,u,F[0]);this.updateToleranceDimensionComponent(A,t.lowerLeft,t.lowerRight,t.upperLeft,F)}else this.updateValueDimensionComponent(y,_,N,b,F),this.removeToleranceDimensionComponent();const ie=F[1]?R:M.add(M.create(),R,w);this.updateExpressionDimensionComponent(a,ie,u,g,F)}updateZExtension(e,t,i){if(Math.abs(i)>Ri.W.ZERO_LENGTH){const s=this.createComponentLine(this.getModelPoint(t[0],t[1],0),this.getModelPoint(t[0],t[1],i));(0,Yd.KZ)(this.getConstantsManager().getStipple("DIMENSION_INACTIVE_OCCLUDED_WITNESS_STIPPLE"),s),this.updateDimensionComponent(e,rA.LINE_SELECTION_ID,s,rA.LINE_PROPERTIES)}}updateZExtensions(e,t){this.displayData.hasExtension&&this.getShowZExtensions()?(this.updateZExtension(rA.WITNESS_EXTENSION0_ID,e,this.displayData.witnessExtension0Z),this.updateZExtension(rA.WITNESS_EXTENSION1_ID,t,this.displayData.witnessExtension1Z)):(this.removeDimensionComponent(rA.WITNESS_EXTENSION0_ID),this.removeDimensionComponent(rA.WITNESS_EXTENSION1_ID))}getLeftAndRightGapLengthInDimensionCoordinates(e,t,i,s,n){if(e===t)return{leftGapLength:e,rightGapLength:e};let r=t,a=e;n&&(r=e,a=t);const o=Q.transformMat3(Q.create(),i,this.dimensionMatrix),h=Q.transformMat3(Q.create(),s,this.dimensionMatrix);return o[0]>h[0]?{leftGapLength:a,rightGapLength:r}:{leftGapLength:r,rightGapLength:a}}getLabelPositionInPlane(){return ge.xB.multiplyVec2(this.dimensionMatrix,[this.displayData.positionX,this.displayData.positionY],yh.create())}getFitBounds(){const e=new wi.kB;return this.addPointToBounds(this.getModelPoint(this.displayData.positionX,this.displayData.positionY),e),this.addPointToBounds(this.getModelPoint(this.displayData.witnessEndPoint0X,this.displayData.witnessEndPoint0Y),e),this.addPointToBounds(this.getModelPoint(this.displayData.witnessEndPoint1X,this.displayData.witnessEndPoint1X),e),e}}class fA extends pA.Ro{constructor(e,t,i){super(e,t,i),this.id="PointDimension"}updateFromDisplayData(e){this.isBad=e.isOverDefined,this.isDriven=e.isDriven,this.updateDimensionMatrices(),this.viewer.requestDraw()}isLengthDimension(){return!0}update(e,t){const i=this.getDisplayData();if(!i)return;let s;const n=this.getPosition(),r=e.getPixelSizeAtWorldPoint(this.transformPoint(this.getModelPoint(n[0],n[1]))),a=i.value;let o=this.getConstantsManager().getNumber("DIMENSION_ARROW_HEIGHT_PIXELS")*r,h=this.getConstantsManager().getNumber("DIMENSION_ARROW_WIDTH_PIXELS")*r;h>a*this.getConstantsManager().getNumber("DIMENSION_ARROW_MAX_PROPORTION")&&this.isLengthDimension()&&(s=a*this.getConstantsManager().getNumber("DIMENSION_ARROW_MAX_PROPORTION")/h,o*=s,h*=s);const c=this.getModelPoint(0,0),l=ge.S4.normalize(ge.S4.subtract(this.getModelPoint(1,0),c)),d=ge.S4.normalize(ge.S4.subtract(this.getModelPoint(0,1),c)),u=this.getTextureInfoForLabel(a,t),g=r*u.filledWidthPx,p=r*u.filledHeightPx,m=zo(e,l,d,this.transform),f=this.wantArcLengthSymbol()?this.addArcLengthSymbol(n,g,p,m[1]):.5*p,I=this.getModelPoint(n[0],n[1]),E=M.scale(M.create(),l,.5*g),S=M.scale(M.create(),d,.5*p),T=M.subtract(M.create(),I,E),D=M.add(M.create(),I,E),C=M.subtract(M.create(),T,S),y=M.subtract(M.create(),D,S),A=M.add(M.create(),T,S),P=this.getModelPoint(0,0),O=M.scale(M.create(),d,f),R=this.updateIconDimensionComponent(r,m[0]?D:T,l,d,m),w=R>0?M.scale(M.create(),l,.5*g+R+this.getIconPadding(r)):E,v=[M.subtract(M.create(),I,m[0]?E:w),M.add(M.create(),I,m[0]?w:E),M.subtract(M.create(),I,m[1]?O:S),M.add(M.create(),I,m[1]?S:O)];let _=null,N=null;for(const e of v){const t=M.squaredLength(M.subtract(M.create(),e,P));(!_||t<_)&&(_=t,N=e)}const b=[],L=M.normalize(M.create(),M.subtract(M.create(),N,P)),F=M.transformMat4(M.create(),[0,0,1],this.getPlaneMatrix()),x=M.normalize(M.create(),M.cross(M.create(),L,F)),B=this,V=function(e,t,i,s){const n=B.getModelPoint(i,s),r=M.add(M.create(),n,M.add(M.create(),M.scale(M.create(),L,e),M.scale(M.create(),x,t)));for(let e=0;e<3;++e)b.push(r[e])};V(0,0,0,0),V(h,.5*-o,0,0),V(h,.5*o,0,0),this.updateDimensionComponent(rA.ARROWS_ID,rA.NO_SELECTION_ID,(0,Yd.ut)(b,[0,1,2],void 0,this.getArrowColor()),rA.ARROW_PROPERTIES),this.updateDimensionComponent(rA.WITNESS0_ID,rA.LINE_SELECTION_ID,this.createComponentLine(P,N),rA.LINE_PROPERTIES),this.updateValueDimensionComponent(u,C,y,A,m);const U=m[1]?M.subtract(M.create(),I,O):M.add(M.create(),I,O);this.updateExpressionDimensionComponent(r,U,l,d,m)}getTextureInfoForLabel(e,t){const i=(0,Ir.KZ)(e,t.getLengthUnits());return this.updateValueTexture(i,t),this.valueTextureInfo.getTexture()}getFitBounds(){const e=new wi.kB;this.addPointToBounds(this.getModelPoint(0,0),e);const t=this.getPosition();return this.addPointToBounds(this.getModelPoint(t[0],t[1]),e),e}wantArcLengthSymbol(){return!1}getDisplayData(){return null}addArcLengthSymbol(e,t,i,s){const n=this.getConstantsManager().getNumber("DIMENSION_ARC_LENGTH_SCALE"),r=n*t/2,a=s?-i:i,o=Q.fromValues(e[0]-r,e[1]+a/2),h=Q.fromValues(e[0],e[1]+n*a),c=Q.fromValues(e[0]+r,o[1]),l=new pA.wN;this.makeThreePointArc(o,h,c,l);const d=new eT(Ai.MX.LINES,l.points,l.indices);return(0,Yd.Ab)(this.getLineColor(),d),(0,Yd.VQ)(this.getLineWidth(),d),this.updateDimensionComponent(rA.ARC_LENGTH_SYMBOL_ID,rA.VALUE_SELECTION_ID,d,rA.LINE_PROPERTIES),i*(n+this.getConstantsManager().getNumber("DIMENSION_TEXT_GAP"))}getLabelPositionInPlane(){return ge.xB.multiplyVec2(this.dimensionMatrix,this.getPosition(),yh.create())}}class IA extends pA.Ro{constructor(e,t,i){super(e,t,i)}polarToDimension(e,t){return Q.fromValues(Math.cos(e)*t,Math.sin(e)*t)}getModelPointFromPolar(e,t){return this.getModelPoint(t*Math.cos(e),t*Math.sin(e))}putAngleInRange(e){return e-2*(0,wi.Tc)(e/(2*Math.PI))*Math.PI}putAnglesInRange(e){if(e.length<1)return[];const t=e.map((e=>(0,wi.Tc)(e/(2*Math.PI)))),i=Math.min(...t),s=Math.max(...t);let n=i;return s>i&&(n-=1),e.map((e=>e-2*n*Math.PI))}generateArcParamters(e,t,i){const s=(e+t)/2,n=(0,wi._k)(i,s),r=Math.abs(t-e);let a=0,o=0,h=0;if(2*Math.abs(n-s)>r){h=i;const s=(0,wi._k)(e,h),n=(0,wi._k)(t,h);a=Math.abs(s-h)<Math.abs(n-h)?s:n,o=Math.floor(1+(this.getConstantsManager().getNumber("DIMENSION_ARC_WITNESS_SEGMENTS")-1)*Math.abs(h-a)/(2*Math.PI))}return{firstAngle:a,secondAngle:h,segments:o}}}var EA=i(59403);class SA extends EA.${constructor(e,t,i){super(e,t,i),this.displayData=null,this.id="ArcLengthDimension"}getDisplayValue(e,t){return(0,Ir.KZ)(e,t.getLengthUnits())}getValueSuffix(e){return""}isArcLengthDimension(){return!0}getDimensionUnits(e){return e.getLengthUnits()}addArcLengthAnnotation(e,t,i,s,n,r,a,o){const h=new pA.wN,c=Q.fromValues(t,i),l=Q.fromValues(i,-t),d=this.getConstantsManager().getNumber("DIMENSION_ARC_LENGTH_SCALE"),u=this.polarToDimension(this.displayData.positionT,a);o&&(ge.gv.scale(c,-1),ge.gv.scale(l,-1)),e&&(ge.gv.scale(c,-1),ge.gv.scale(l,-1));const g=Q.create();ge.gv.add(u,ge.gv.scale(c,d*s/2,Q.create()),g),ge.gv.add(g,ge.gv.scale(l,n/2,Q.create()),g);const p=Q.create();ge.gv.add(u,ge.gv.scale(c,-d*s/2,Q.create()),p),ge.gv.add(p,ge.gv.scale(l,n/2,Q.create()),p),ge.gv.add(u,ge.gv.scale(l,n*d,Q.create()),u),this.makeThreePointArc(g,u,p,h);const m=new eT(Ai.MX.LINES,h.points,h.indices);return(0,Yd.Ab)(this.getLineColor(),m),(0,Yd.VQ)(this.getLineWidth(),m),this.updateDimensionComponent(rA.ARC_LENGTH_SYMBOL_ID,rA.VALUE_SELECTION_ID,m,rA.LINE_PROPERTIES),n*(d-.5+this.getConstantsManager().getNumber("DIMENSION_TEXT_GAP"))}}class TA extends fA{constructor(e,t,i){super(e,t,i),this.displayData=null,this.id="BezierDegreeDimension"}isLengthDimension(){return!1}updateFromDisplayData(e){this.displayData=e,super.updateFromDisplayData(e)}getDisplayData(){return this.displayData}getPosition(){return Q.fromValues(this.displayData.positionX,this.displayData.positionY)}setPosition(e){this.displayData.positionX=e[0],this.displayData.positionY=e[1]}getDefaultPrecision(e){return 0}getDimensionUnits(e){return""}getTextureInfoForLabel(e,t){return this.updateValueTexture(e,t,"Deg "),this.valueTextureInfo.getTexture()}canBeDrivenDimension(){return!1}}class DA extends mA{constructor(e,t,i){super(e,t,i),this.id="CenterlineDimension"}getValuePrefix(e){return rA.DIAMETER_SYMBOL}}class CA extends fA{constructor(e,t,i){super(e,t,i),this.displayData=null,this.id="CountDimension"}getTextureInfoForLabel(e,t){return this.updateValueTexture(e,t,void 0,"x"),this.valueTextureInfo.getTexture()}getDefaultPrecision(e){return 0}getDimensionUnits(e){return""}updateFromDisplayData(e){this.displayData=e,super.updateFromDisplayData(e)}getDisplayData(){return this.displayData}getPosition(){return Q.fromValues(this.displayData.positionX,this.displayData.positionY)}setPosition(e){this.displayData.positionX=e[0],this.displayData.positionY=e[1]}canBeDrivenDimension(){return!1}}class MA extends fA{constructor(e,t,i){super(e,t,i),this.displayData=null,this.id="CurveLengthDimension"}wantArcLengthSymbol(){return!0}isLengthDimension(){return!0}getDefaultPrecision(e){return e.getLengthUnitsDisplayPrecision()}getDimensionUnits(e){return e.getLengthUnits()}getTextureInfoForLabel(e,t){if(void 0===e)this.updateRawValueTexture(rA.CURVE_LENGTH_SYMBOL);else{const i=(0,Ir.KZ)(e,t.getLengthUnits());this.updateValueTexture(i,t)}return this.valueTextureInfo.getTexture()}updateFromDisplayData(e){this.displayData=e,super.updateFromDisplayData(e)}getDisplayData(){return this.displayData}getPosition(){return Q.fromValues(this.displayData.positionX,this.displayData.positionY)}setPosition(e){this.displayData.positionX=e[0],this.displayData.positionY=e[1]}}class yA extends mA{constructor(e,t,i){super(e,t,i),this.displayData=null,this.id="EllipseDiameterDimension"}}class AA extends IA{constructor(e,t,i){super(e,t,i),this.displayData=null,this.id="RadialDimension"}updateFromDisplayData(e){this.displayData=e,this.isBad=e.isOverDefined,this.isDriven=e.isDriven,this.updateDimensionMatrices(),this.viewer.requestDraw()}getPosition(){return Q.clone(this.polarToDimension(this.displayData.positionT,this.displayData.positionR))}setPosition(e){this.displayData.positionR=Math.sqrt(e[0]*e[0]+e[1]*e[1]),this.displayData.positionT=Math.atan2(e[1],e[0])}getLabelPositionInPlane(){const e=this.polarToDimension(this.displayData.positionT,this.displayData.positionR);return ge.xB.multiplyVec2(this.dimensionMatrix,[e[0],e[1]],yh.create())}getDefaultPrecision(e){return e.getLengthUnitsDisplayPrecision()}getDimensionUnits(e){return e.getLengthUnits()}update(e,t){if(!this.displayData)return;const i=this.displayData.value,s=this.getPosition(),n=this.polarToDimension(this.displayData.positionT,1),r=e.getPixelSizeAtWorldPoint(this.transformPoint(this.getModelPoint(s[0],s[1]))),a=this.getModelPoint(0,0),o=this.polarToDimension(this.displayData.positionT+Math.PI/2,1),h=ge.S4.normalize(ge.S4.subtract(this.getModelPoint(n[0],n[1]),a)),c=ge.S4.normalize(ge.S4.subtract(this.getModelPoint(o[0],o[1]),a)),l=this.getVisualRightVector(),d=this.getVisualUpVector();let u=this.getConstantsManager().getNumber("DIMENSION_ARROW_HEIGHT_PIXELS")*r,g=this.getConstantsManager().getNumber("DIMENSION_ARROW_WIDTH_PIXELS")*r;if(g>i*this.getConstantsManager().getNumber("DIMENSION_ARROW_MAX_PROPORTION")){const e=i*this.getConstantsManager().getNumber("DIMENSION_ARROW_MAX_PROPORTION")/g;u*=e,g*=e}const p=[],m=this,f=function(e,t,i,s){const n=m.getModelPoint(i,s),r=ge.S4.add(n,ge.S4.add(ge.S4.scale(h,e,M.create()),ge.S4.scale(c,t,M.create())));for(let e=0;e<3;++e)p.push(r[e])};let I=(0,Ir.KZ)(i,t.getLengthUnits()),E=i;const S=this.displayData.radiusDisplay===k.MEf.DIAMETRAL,T=S&&!this.displayData.realDiameter;let D=rA.RADIUS_SYMBOL;S&&(D=rA.DIAMETER_SYMBOL,T?I*=2:E/=2),this.updateValueTexture(I,t,D),this.updateToleranceTexture(t);const C=this.valueTextureInfo.getTexture(),A=this.toleranceTextureInfo.getTexture(),P=new gA(r,C,A),O=M.scale(M.create(),d,.5*P.combinedWorldSize.height),R=this.getModelPoint(s[0],s[1]);M.subtract(R,R,O);const w=M.scale(M.create(),l,.5*P.combinedWorldSize.width),v=M.scale(M.create(),d,P.combinedWorldSize.height),_=M.subtract(M.create(),R,w),N=M.add(M.create(),R,w),b=M.add(M.create(),_,v),L=M.add(M.create(),N,v),F=zo(e,l,d,this.transform),x=M.add(M.create(),F[0]?N:_,O),B=this.updateIconDimensionComponent(r,x,l,d,F);let V,U;const H=this.getTextGap(h,l,P.combinedWorldSize.width,P.combinedWorldSize.height),G=B>0?this.getValueGapWithIcon(h,l,P.combinedWorldSize.width,P.combinedWorldSize.height,B,this.getIconPadding(r)):H,W=F[0]?H:G,z=F[0]?G:H,X=n[0]>0?W:z,Z=n[0]>0?z:W;if(this.displayData.positionR-X/2>E)V=this.polarToDimension(this.displayData.positionT,E),U=this.polarToDimension(this.displayData.positionT,this.displayData.positionR-X/2),f(0,0,V[0],V[1]),f(g,.5*-u,V[0],V[1]),f(g,.5*u,V[0],V[1]),this.updateDimensionComponent(rA.ARROWS_ID,rA.NO_SELECTION_ID,(0,Yd.ut)(p,[0,1,2],void 0,this.getArrowColor()),rA.ARROW_PROPERTIES),this.updateDimensionLineComponent(rA.WITNESS0_ID,this.getModelPoint(V[0],V[1]),this.getModelPoint(U[0],U[1]));else{V=[0,0],S&&(V=this.polarToDimension(Math.PI+this.displayData.positionT,E)),U=this.polarToDimension(this.displayData.positionT,E),f(0,0,V[0],V[1]),f(g,.5*-u,V[0],V[1]),f(g,.5*u,V[0],V[1]),f(0,0,U[0],U[1]),f(-g,.5*-u,U[0],U[1]),f(-g,.5*u,U[0],U[1]),this.updateDimensionComponent(rA.ARROWS_ID,rA.NO_SELECTION_ID,(0,Yd.ut)(p,[0,1,2,3,4,5],void 0,this.getArrowColor()),rA.ARROW_PROPERTIES);const e=this.polarToDimension(this.displayData.positionT,this.displayData.positionR-X/2),t=this.polarToDimension(this.displayData.positionT,this.displayData.positionR+Z/2),i=[],s=this.getModelPoint(V[0],V[1]),n=this.getModelPoint(U[0],U[1]),r=this.getModelPoint(e[0],e[1]),a=this.getModelPoint(t[0],t[1]);(!S&&this.displayData.positionR-X/2>0||S)&&(i.push(s),i.push(r)),this.displayData.positionR+Z/2<E&&(i.push(a),i.push(n)),this.updateDimensionComponent(rA.WITNESS0_ID,rA.LINE_SELECTION_ID,(0,Yd.pf)(i,void 0,this.getLineColor(),this.getLineWidth(),this.getLineStyle()),rA.LINE_PROPERTIES)}if(!S){const e=this.generateArcParamters(this.displayData.witnessEndPoint0t,this.displayData.witnessEndPoint1t,this.displayData.positionT),t=(0,Yd.QV)(a,this.displayData.witnessEndPoint1r,ge.w$.multiplyVec4(this.getPlaneMatrix(),[0,0,1,0],y.create()),l,e.firstAngle,e.secondAngle,e.segments);(0,Yd.Ab)(this.getLineColor(),t),this.getLineStyle()&&(0,Yd.KZ)(this.getLineStyle(),t),this.updateDimensionComponent(rA.WITNESS1_ID,rA.LINE_SELECTION_ID,t,rA.LINE_PROPERTIES)}if(this.updateBasicBox([_,b,L,N]),A){const e=P.getValueCorners(_,d,l,F[0]);this.updateValueDimensionComponent(C,e.lowerLeft,e.lowerRight,e.upperLeft,F);const t=P.getToleranceCorners(_,d,l,F[0]);this.updateToleranceDimensionComponent(A,t.lowerLeft,t.lowerRight,t.upperLeft,F)}else this.updateValueDimensionComponent(C,_,N,b,F),this.removeToleranceDimensionComponent();const q=F[1]?R:M.add(M.create(),R,v);this.updateExpressionDimensionComponent(r,q,l,d,F)}getFitBounds(){const e=new wi.kB;return this.addPointToBounds(this.getModelPointFromPolar(this.displayData.positionT,this.displayData.positionR),e),e}}class PA extends IA{constructor(){super(...arguments),this.displayData=null,this.id="RadialDistanceDimension"}getPosition(){return Q.clone(this.polarToDimension(this.displayData.positionAngle,this.displayData.positionRadius))}setPosition(e){this.displayData.positionRadius=Math.sqrt(e[0]*e[0]+e[1]*e[1]),this.displayData.positionAngle=Math.atan2(e[1],e[0])}getLabelPositionInPlane(){const e=this.polarToDimension(this.displayData.positionAngle,this.displayData.positionRadius);return ge.xB.multiplyVec2(this.dimensionMatrix,[e[0],e[1]],yh.create())}getDimensionUnits(e){return e.getLengthUnits()}getDefaultPrecision(e){return e.getLengthUnitsDisplayPrecision()}getShouldBeRecreated(e){return!(e instanceof k.Z6V)}updateFromDisplayData(e){e instanceof k.Z6V&&(this.displayData=e),this.isBad=e.isOverDefined,this.isDriven=e.isDriven,this.updateDimensionMatrices(),this.viewer.requestDraw()}update(e,t){if(!this.displayData)return;const i=this.displayData.value,s=(0,Ir.KZ)(i,t.getLengthUnits());this.updateValueTexture(s,t),this.updateToleranceTexture(t);const n=this.valueTextureInfo.getTexture(),r=this.toleranceTextureInfo.getTexture(),a=this.getPosition(),o=e.getPixelSizeAtWorldPoint(this.transformPoint(this.getModelPoint(a[0],a[1]))),h=this.getArrowSize(o),c=new gA(o,n,r),l=this.adjustLabelPosition(a,{height:c.combinedWorldSize.height,width:c.combinedWorldSize.width,innerRadius:this.displayData.innerWitnessRadius,outerRadius:this.displayData.outerWitnessRadius,arrowLength:h.length}),d=this.getVisualRightVector(),u=this.getVisualUpVector(),g=M.scale(M.create(),u,.5*c.combinedWorldSize.height),p=this.getModelPoint(l[0],l[1]);M.subtract(p,p,g);const m=M.scale(M.create(),d,.5*c.combinedWorldSize.width),f=M.scale(M.create(),u,c.combinedWorldSize.height),I=M.subtract(M.create(),p,m),E=M.add(M.create(),p,m),S=M.add(M.create(),I,f),T=M.add(M.create(),E,f),D=zo(e,d,u,this.transform),C=M.add(M.create(),D[0]?E:I,g);if(this.updateIconDimensionComponent(o,C,d,u,D),this.updateBasicBox([I,S,T,E]),r){const e=c.getValueCorners(I,u,d,D[0]);this.updateValueDimensionComponent(n,e.lowerLeft,e.lowerRight,e.upperLeft,D);const t=c.getToleranceCorners(I,u,d,D[0]);this.updateToleranceDimensionComponent(r,t.lowerLeft,t.lowerRight,t.upperLeft,D)}else this.updateValueDimensionComponent(n,I,E,S,D),this.removeToleranceDimensionComponent();const y=D[1]?p:M.add(M.create(),p,f);this.updateExpressionDimensionComponent(o,y,d,u,D);const A=this.getModelPoint(0,0);this.updateRadialLeader({origin:A,labelPosition:this.getModelPoint(l[0],l[1]),labelWidth:M.subtract(M.create(),E,I),labelHeight:M.subtract(M.create(),S,I),innerRadius:this.displayData.innerWitnessRadius,outerRadius:this.displayData.outerWitnessRadius,arrowLength:h.length,arrowWidth:h.width}),this.updateLeaderArc(rA.WITNESS0_ID,A,this.displayData.innerWitnessRadius,this.displayData.innerWitnessEndPoint0Angle,this.displayData.innerWitnessEndPoint1Angle,this.displayData.positionAngle),this.updateLeaderArc(rA.WITNESS1_ID,A,this.displayData.outerWitnessRadius,this.displayData.outerWitnessEndPoint0Angle,this.displayData.outerWitnessEndPoint1Angle,this.displayData.positionAngle)}updateLeaderArc(e,t,i,s,n,r){const a=n-s;let o=r-s;if(o<0&&(o+=2*Math.PI),o<a)return void this.removeDimensionComponent(e);const h=this.generateArcParamters(s,n,r),c=(0,Yd.QV)(t,i,this.getVisualNormal(),this.getVisualRightVector(),h.firstAngle,h.secondAngle,h.segments);(0,Yd.Ab)(this.getLineColor(),c),this.getLineStyle()&&(0,Yd.KZ)(this.getLineStyle(),c),this.updateDimensionComponent(e,rA.LINE_SELECTION_ID,c,rA.LINE_PROPERTIES)}updateRadialLeader(e){const t=M.subtract(M.create(),e.labelPosition,e.origin),i=M.normalize(M.create(),t),s=M.add(M.create(),e.origin,M.scale(M.create(),i,e.innerRadius)),n=M.add(M.create(),e.origin,M.scale(M.create(),i,e.outerRadius)),r=M.length(t);r>e.outerRadius?this.updateDimensionLineComponent(rA.DIMENSION_LINE0_ID,s,this.trimRadialLeader(e.labelPosition,s,e.labelWidth,e.labelHeight)):r<e.innerRadius?this.updateDimensionLineComponent(rA.DIMENSION_LINE0_ID,this.trimRadialLeader(e.labelPosition,n,e.labelWidth,e.labelHeight),n):this.updateDimensionComponent(rA.DIMENSION_LINE0_ID,rA.LINE_SELECTION_ID,(0,Yd.pf)([s,this.trimRadialLeader(e.labelPosition,s,e.labelWidth,e.labelHeight),this.trimRadialLeader(e.labelPosition,n,e.labelWidth,e.labelHeight),n],void 0,this.getLineColor(),this.getLineWidth(),this.getLineStyle()),rA.LINE_PROPERTIES);let a=[];const o=M.negate(M.create(),i);a=3*e.arrowLength>e.outerRadius-e.innerRadius?this.createArrowPoints(s,o,e.arrowLength,e.arrowWidth).concat(this.createArrowPoints(n,i,e.arrowLength,e.arrowWidth)):this.createArrowPoints(s,i,e.arrowLength,e.arrowWidth).concat(this.createArrowPoints(n,o,e.arrowLength,e.arrowWidth)),this.updateDimensionComponent(rA.ARROWS_ID,rA.NO_SELECTION_ID,(0,Yd.ut)(a,[0,1,2,3,4,5],void 0,this.getArrowColor()),rA.ARROW_PROPERTIES)}trimRadialLeader(e,t,i,s){const n=M.subtract(M.create(),t,e),r=M.length(i),a=M.length(s),o=M.normalize(M.create(),i),h=M.normalize(M.create(),s),c=Math.abs(M.dot(n,o)),l=Math.abs(M.dot(n,h));return c*a>l*r?M.scaleAndAdd(M.create(),e,n,.5*r/c):M.scaleAndAdd(M.create(),e,n,.5*a/l)}createArrowPoints(e,t,i,s){const n=M.cross(M.create(),t,this.getVisualNormal()),r=M.scaleAndAdd(M.create(),e,t,i);return[e,M.scaleAndAdd(M.create(),r,n,.5*s),M.scaleAndAdd(M.create(),r,n,.5*-s)].flatMap((e=>[...e]))}adjustLabelPosition(e,t){const i=.5*t.height,s=.5*t.width,n=[Q.add(Q.create(),e,Q.fromValues(-s,-i)),Q.add(Q.create(),e,Q.fromValues(s,-i)),Q.add(Q.create(),e,Q.fromValues(-s,i)),Q.add(Q.create(),e,Q.fromValues(s,i))].map((e=>Q.length(e))),r=Math.min(n[0],n[1],n[2],n[3]),a=Math.max(n[0],n[1],n[2],n[3]),o=2*t.arrowLength;if(r>t.outerRadius+o){if(Math.abs(e[0])>s||Math.abs(e[1])>i)return e}else{if(a<t.innerRadius-o)return e;if(r>t.innerRadius+o&&a<t.outerRadius-o)return e}const h=.5*Math.sqrt(t.height*t.height+t.width*t.width),c=Q.length(e)>.5*(t.innerRadius+t.outerRadius),l=h+o>t.innerRadius,d=Q.length(e)>Ri.W.ZERO_LENGTH?Q.normalize(Q.create(),e):Q.fromValues(1,0);return c||l?Q.scale(Q.create(),d,t.outerRadius+o+h):Q.scale(Q.create(),d,t.innerRadius-(o+h))}getArrowSize(e){const t=this.getConstantsManager().getNumber("DIMENSION_ARROW_HEIGHT_PIXELS")*e;return{length:this.getConstantsManager().getNumber("DIMENSION_ARROW_WIDTH_PIXELS")*e,width:t}}}class OA extends fA{constructor(e,t,i){super(e,t,i),this.displayData=null,this.id="RhoDimension"}isLengthDimension(){return!1}updateFromDisplayData(e){this.displayData=e,super.updateFromDisplayData(e)}getDisplayData(){return this.displayData}getPosition(){return Q.fromValues(this.displayData.positionX,this.displayData.positionY)}setPosition(e){this.displayData.positionX=e[0],this.displayData.positionY=e[1]}getDefaultPrecision(e){return e.getLengthUnitsDisplayPrecision()}getDimensionUnits(e){return""}getTextureInfoForLabel(e,t){return this.updateValueTexture(e,t,"Rho "),this.valueTextureInfo.getTexture()}}function RA(e,t,i,s){s||(s={forPreview:void 0,isMateValue:void 0});let n=null;return e instanceof k.Vh_?n=new SA(i,!!s.forPreview,t):e instanceof k.eor?n=new DA(i,!!s.forPreview,t):e instanceof k.ktz?n=new yA(i,!!s.forPreview,t):e instanceof k.Ye1?n=new mA(i,!!s.forPreview,t):e instanceof k.oTb?n=new EA.$(i,!!s.forPreview,t):e instanceof k.lAf?n=new AA(i,!!s.forPreview,t):e instanceof k.oUi?n=new MA(i,!!s.forPreview,t):e instanceof k.ohc?n=new CA(i,!!s.forPreview,t):e instanceof k.Id4?n=new OA(i,!!s.forPreview,t):e instanceof k.jJ2?n=new TA(i,!!s.forPreview,t):e instanceof k.Z6V&&(n=new PA(i,!!s.forPreview,t)),s.isMateValue&&(n.getClearModelSelectionsOnPrehilite=function(){return!1}),n}},27339:function(e,t,i){i.d(t,{a:function(){return r}});class s{constructor(){this.activeManipulator=null}setActiveManipulator(e){this.activeManipulator&&this.activeManipulator.removeDisplacementMeshIncrements(),this.activeManipulator=e}resetActiveManipulator(){this.setActiveManipulator(null)}}let n=null;function r(){return n||(n=new s),n}},51236:function(e,t,i){i.d(t,{$o:function(){return L},AF:function(){return z},Ad:function(){return u},Ao:function(){return S},B$:function(){return ue},CD:function(){return K},CW:function(){return Q},Cu:function(){return Ne},E7:function(){return X},FE:function(){return f},HO:function(){return j},IH:function(){return Ue},KK:function(){return Ve},KU:function(){return b},Kb:function(){return Re},Kf:function(){return we},LK:function(){return Z},Lr:function(){return k},Oh:function(){return N},Ot:function(){return pe},S_:function(){return I},TE:function(){return oe},Tc:function(){return E},Tu:function(){return Oe},Ux:function(){return te},WW:function(){return w},Wm:function(){return Se},Yr:function(){return ee},_O:function(){return Ae},_k:function(){return Pe},bZ:function(){return F},cP:function(){return ve},cl:function(){return se},df:function(){return Ee},dm:function(){return le},eB:function(){return ge},fB:function(){return d},fE:function(){return x},g7:function(){return R},g9:function(){return Me},iD:function(){return ye},iK:function(){return T},iM:function(){return fe},jP:function(){return me},kB:function(){return M},nP:function(){return ie},n_:function(){return ne},o5:function(){return de},qm:function(){return q},r7:function(){return ae},rQ:function(){return P},s9:function(){return m},sc:function(){return _},ss:function(){return W},tO:function(){return D},tV:function(){return re},tl:function(){return p},tm:function(){return g},u3:function(){return ce},uZ:function(){return Y},vG:function(){return Ce},vu:function(){return v},w5:function(){return Be},wd:function(){return he},xV:function(){return _e},zD:function(){return Te},zH:function(){return O},zL:function(){return De}});var s=i(68100),n=i(35589),r=i(81578);if(666==i.j)var a=i(75920);var o=i(9851),h=i(99669),c=i(68434);const l=666==i.j?[0,0,0]:null;function d(e){return s.squaredLength(e)<Math.pow(h.W.MAX_MODEL_SIZE,2)}"undefined"!=typeof window&&(window.glMatrixArrayType=Array);const u=n.create();function g(e,t){return r.squaredLength(c.gv.subtract(e,t,r.create()))<h.W.ZERO_LENGTH_SQUARED}const p=53,m=Number.MAX_SAFE_INTEGER?Number.MAX_SAFE_INTEGER:9007199254740991;function f(e,t,i){const n=s.dot(e,t),r=s.dot(c.S4.cross(e,t,s.create()),c.S4.normalize(i,s.create()));return Math.atan2(r,n)}function I(e){return e<0?Math.floor(e):Math.ceil(e)}function E(e){return e<0?Math.ceil(e):Math.floor(e)}function S(e,t,i,s){return!(e>t||i>s)&&(e<i?i<t-h.W.ZERO_LENGTH:e<s-h.W.ZERO_LENGTH)}var T;!function(e){e[e.LOW=0]="LOW",e[e.MID=.5]="MID",e[e.HIGH=1]="HIGH"}(T||(T={}));class D{constructor(){this.reset()}isInitialized(){for(let e=0;e<2;++e)if(this.min[e]>this.max[e])return!1;return!0}reset(){this.min=[1/0,1/0],this.max=[-1/0,-1/0]}set(e,t){r.copy(this.min,e),r.copy(this.max,t)}copyFrom(e){this.set(e.min,e.max)}add(e){const t=e.length;for(let i=0;i<t;++i)for(let t=0;t<2;++t)e[i][t]<this.min[t]&&(this.min[t]=e[i][t]),e[i][t]>this.max[t]&&(this.max[t]=e[i][t])}addPoint(e){for(let t=0;t<2;++t)e[t]<this.min[t]&&(this.min[t]=e[t]),e[t]>this.max[t]&&(this.max[t]=e[t])}addPointXY(e,t){e<this.min[0]&&(this.min[0]=e),e>this.max[0]&&(this.max[0]=e),t<this.min[1]&&(this.min[1]=t),t>this.max[1]&&(this.max[1]=t)}addBox(e){if(e.isInitialized())for(let t=0;t<2;++t)this.min[t]=Math.min(this.min[t],e.min[t]),this.max[t]=Math.max(this.max[t],e.max[t])}getDimensions(){return c.gv.subtract(this.max,this.min,r.create())}overlapsWith(e){return S(this.min[0],this.max[0],e.min[0],e.max[0])&&S(this.min[1],this.max[1],e.min[1],e.max[1])}contains(e){return e[0]>=this.min[0]&&e[1]>=this.min[1]&&e[0]<=this.max[0]&&e[1]<=this.max[1]}makeCenteredBoxOnPoint(e,t){const i=.5*t;this.min[0]=e[0]-i,this.min[1]=e[1]-i,this.max[0]=e[0]+i,this.max[1]=e[1]+i}center(e){return e=e||r.create(),c.gv.scale(c.gv.add(this.min,this.max,e),.5)}getCorners(e){if(!e){e=[];for(let t=0;t<4;++t)e.push(r.create())}for(let t=0;t<2;++t)for(let i=0;i<2;++i){const s=e[2*i+t];s[0]=0===t?this.min[0]:this.max[0],s[1]=0===i?this.min[1]:this.max[1]}return e}translate(e){c.gv.add(this.min,e,this.min),c.gv.add(this.max,e,this.max)}}const C=[0,0,0];class M{constructor(e,t){this.min=s.create(),this.max=s.create(),void 0!==e&&void 0!==t?this.set(e,t):this.reset()}clone(){return new M(this.min,this.max)}toString(){return"min: "+this.min+", max: "+this.max}makeSceneDebugObject(){let e="BoundingBox: ";if(this.isInitialized()){const t=[],i=[];for(let e=0;e<3;++e)t.push(this.min[e].toFixed(5)),i.push(this.max[e].toFixed(5));e+="(min: "+t+", max: "+i+")"}else e+="(Uninitialized)";return{text:e,children:[]}}getMin(){return s.clone(this.min)}getMax(){return s.clone(this.max)}set(e,t){s.copy(this.min,e),s.copy(this.max,t)}copyFrom(e){this.set(e.min,e.max)}reset(){this.set([1/0,1/0,1/0],[-1/0,-1/0,-1/0])}equals(e){for(let t=0;t<3;++t)if(this.min[t]!==e.min[t]||this.max[t]!==e.max[t])return!1;return!0}setInfinite(){this.set([-1/0,-1/0,-1/0],[1/0,1/0,1/0])}isInitialized(){for(let e=0;e<3;++e)if(this.min[e]>this.max[e])return!1;return!0}isInfinite(){for(let e=0;e<3;++e)if(this.min[e]===-1/0||this.max[e]===1/0)return!0;return!1}isFinite(){return this.isInitialized()&&!this.isInfinite()}areBoundDimensionsSmallerThan(e){for(let t=0;t<3;++t)if(this.max[t]-this.min[t]>=e)return!1;return!0}addPoint(e){for(let t=0;t<3;++t)e[t]<this.min[t]&&(this.min[t]=e[t]),e[t]>this.max[t]&&(this.max[t]=e[t])}addXYZ(e,t,i){e<this.min[0]&&(this.min[0]=e),e>this.max[0]&&(this.max[0]=e),t<this.min[1]&&(this.min[1]=t),t>this.max[1]&&(this.max[1]=t),i<this.min[2]&&(this.min[2]=i),i>this.max[2]&&(this.max[2]=i)}addPointArray(e){for(let t=0;t<e.length;++t)for(let i=0;i<3;++i)e[t][i]<this.min[i]&&(this.min[i]=e[t][i]),e[t][i]>this.max[i]&&(this.max[i]=e[t][i])}createTransformedCopy(e){const t=new M;return t.addBox(this,e),t}addBox(e,t,i){if(e&&e.isInitialized())if(e.isInfinite())this.setInfinite();else{if(i&&y.copyFrom(this),!t||ne(t))this.addXYZ(e.min[0],e.min[1],e.min[2]),this.addXYZ(e.max[0],e.max[1],e.max[2]);else{const i=[e.min,e.max];for(let e=0;e<2;e++)for(let s=0;s<2;s++)for(let n=0;n<2;n++){const r=[i[e][0],i[s][1],i[n][2]];c.w$.multiplyVec3(t,r),this.addPoint(r)}}i&&!P(this)&&this.copyFrom(y)}}getCorners(){const e=[this.min,this.max],t=[];if(!this.isInitialized())return null;for(let i=0;i<2;i++)for(let n=0;n<2;n++)for(let r=0;r<2;r++)t.push(s.fromValues(e[i][0],e[n][1],e[r][2]));return t}getLocationInBox(e,t,i){return[K(this.min[0],this.max[0],e),K(this.min[1],this.max[1],t),K(this.min[2],this.max[2],i)]}isExtensive(){for(let e=0;e<3;e++)if(Math.abs(this.max[e]-this.min[e])>h.W.ZERO_LENGTH)return!0;return!1}center(e){e||(e=s.create());const t=c.S4.add(this.min,this.max,e);return c.S4.scale(t,.5),t}diagonalVector(e){return e||(e=s.create()),c.S4.subtract(this.max,this.min,e)}diameter(){return c.S4.length(c.S4.subtract(this.max,this.min,C))}maxDimension(){const e=c.S4.subtract(this.max,this.min,s.create());return Math.max(Math.abs(e[0]),Math.max(Math.abs(e[1]),Math.abs(e[2])))}scale(e){const t=this.center();c.S4.subtract(this.max,t),c.S4.scale(this.max,e),c.S4.add(this.max,t),c.S4.subtract(this.min,t),c.S4.scale(this.min,e),c.S4.add(this.min,t)}dilate(e){const t=s.fromValues(e,e,e);c.S4.add(this.max,t),c.S4.subtract(this.min,t)}getXyBounds(){const e=new D;return e.set([this.min[0],this.min[1]],[this.max[0],this.max[1]]),e}}const y=new M;let A=!1;function P(e){return!!e&&(!!e.isInitialized()&&(!!e.areBoundDimensionsSmallerThan(h.W.MAX_BOUNDS_DIMENSION)||(A||(o.log.info("Found scenegraph node with very large bounds. It will be omitted from bounds computation"),A=!0),!1)))}class O{constructor(e,t){this.point=s.clone(e),this.direction=c.S4.normalize(t,s.create())}setPoint(e){this.point=s.clone(e)}setDirection(e){this.direction=c.S4.normalize(e,s.create())}evaluate(e,t){return c.S4.add(c.S4.scale(this.direction,e,t||s.create()),this.point)}findClosestPositionToOtherRay(e){const t=s.dot(this.direction,this.direction),i=s.dot(this.direction,e.direction),n=s.dot(e.direction,e.direction),r=t*n-i*i;if(Math.abs(r)<h.W.ZERO_ANGLE)return null;const a=c.S4.subtract(this.point,e.point,s.create()),o=s.dot(this.direction,a);return(i*s.dot(e.direction,a)-n*o)/r}findPositionOfPoint(e){return s.dot(this.direction,c.S4.subtract(e,this.point,s.create()))}}function R(e,t){const i=e[0]*t[0]+e[1]*t[1],s=Math.sqrt(e[0]*e[0]+e[1]*e[1]),n=Math.sqrt(t[0]*t[0]+t[1]*t[1]);if(s<=h.W.ZERO_LENGTH||n<=h.W.ZERO_LENGTH)return null;return i/(s*n)}function w(e,t,i){const s=i[0],n=i[1],r=(s*t[0]-s*e[0]+n*t[1]-n*e[1])/(s*s+n*n);t[0]=s*r+e[0],t[1]=n*r+e[1]}function v(e,t,i){const n=c.S4.subtract(t,e,s.create()),r=(s.dot(i,n)-s.dot(e,n))/s.squaredLength(n);return r<=0?(n[0]=e[0],n[1]=e[1],n[2]=e[2]):r>=1?(n[0]=t[0],n[1]=t[1],n[2]=t[2]):c.S4.add(c.S4.scale(n,r),e),n}function _(e){const t=s.create();t[0]=e[8],t[1]=e[9],t[2]=e[10];const i=s.create();i[0]=e[12],i[1]=e[13],i[2]=e[14];const n=s.dot(t,i),r=a.create();return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=-n,r}function N(e,t){let i=a.create();const s=a.create();return s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=1,i=c.w$.multiplyVec4(t,s,i),[i[0],i[1],i[2]]}function b(e,t){let i=a.create();const s=a.create();return s[0]=e[0],s[1]=e[1],s[2]=0,s[3]=1,i=c.w$.multiplyVec4(t,s,i),[i[0],i[1],i[2]]}function L(e,t){let i=a.create();const s=a.create();return s[0]=e[0],s[1]=e[1],s[2]=0,s[3]=0,i=c.w$.multiplyVec4(t,s,i),[i[0],i[1],i[2]]}function F(e,t,i){return x(e,_(t),i)}function x(e,t,i){const n=s.dot(e.point,t),r=s.dot(e.direction,t);if(i=i||h.W.ZERO_ANGLE,Math.abs(r)<i)return null;{const i=-(n+t[3])/r;return c.S4.linComb(e.point,1,e.direction,i,s.create())}}const B=s.create(),V=s.create(),U=s.create(),H=s.create(),G=s.create();function k(e,t,i){let n,r=!0;const a=B,o=V,h=U;for(n=0;n<3;++n)e.point[n]<t.min[n]?(a[n]=1,h[n]=t.min[n],r=!1):e.point[n]>t.max[n]?(a[n]=0,h[n]=t.max[n],r=!1):a[n]=2;if(r)return i=i||s.create(),s.copy(i,e.point),i;for(n=0;n<3;++n)2!==a[n]&&0!==e.direction[n]?o[n]=(h[n]-e.point[n])/e.direction[n]:o[n]=-1;let c=0;for(n=1;n<3;++n)o[c]<o[n]&&(c=n);if(o[c]<0)return null;for(i=i||s.create(),n=0;n<3;++n)if(c!==n){if(i[n]=e.point[n]+o[c]*e.direction[n],i[n]<t.min[n]||i[n]>t.max[n])return null}else i[n]=h[n];return i}function W(e,t,i,n){const r=s.dot(e.direction,e.direction),a=2*e.direction[0]*(e.point[0]-t[0])+2*e.direction[1]*(e.point[1]-t[1])+2*e.direction[2]*(e.point[2]-t[2]);let o=a*a-4*r*(s.dot(t,t)+s.dot(e.point,e.point)-2*s.dot(t,e.point)-i*i);if(o<-h.W.ZERO_LENGTH_SQUARED)return null;if(Math.abs(o)<h.W.ZERO_LENGTH_SQUARED){const t=-a/2*r;return e.evaluate(t,n)}{o=Math.sqrt(o);const t=(-a-o)/(2*r);return t<0&&(-a+o)/(2*r)<0?null:t<0?s.copy(n||s.create(),e.point):e.evaluate(t,n)}}function z(e,t,i,n){const r=1e-6,a=B,o=V,h=U,l=H,d=G;c.S4.subtract(i,t,a),c.S4.subtract(n,t,o),c.S4.cross(e.direction,o,h);const u=s.dot(a,h);if(u>-r&&u<r)return;const g=1/u;c.S4.subtract(e.point,t,d);const p=s.dot(d,h)*g;if(p<0||p>1)return;c.S4.cross(d,a,l);const m=s.dot(e.direction,l)*g;if(m<0||p+m>1)return;const f=s.dot(o,l);return f>r?f:void 0}function X(e,t){const i=[],n=s.create();return t&&t.isTriangles()&&k(e,t.getBounds(),n)?(t.iteratePrimitives((function(t,s,n){if(!s||!n)return;const r=z(e,t,s,n);void 0!==r&&i.push(r)})),i):i}function Z(e,t,i,n){const r=c.S4.subtract(e,t,s.create());return[s.dot(r,n),s.dot(r,c.S4.cross(i,n,s.create()))]}function q(e,t,i,n){const r=c.S4.normalize(n,s.create()),a=c.S4.scale(r,e[0],s.create()),o=c.S4.scale(c.S4.cross(i,r,s.create()),e[1],s.create());return c.S4.add(t,c.S4.add(a,o,s.create()),s.create())}function Y(e,t,i){return Math.min(i,Math.max(e,t))}function K(e,t,i){return(1-i)*e+i*t}function j(e,t){if(!e||0===e.length)return;const i=(t-Math.floor(t))*e.length,s=Math.floor(i),n=(s+1)%e.length,r=i-s;return K(e[s],e[n],r)}function Q(e,t,i){return(i=Y((i-e)/(t-e),0,1))*i*(3-2*i)}const $=Math.PI/180,J=180/Math.PI;function ee(e){return e*$}function te(e){return e*J}function ie(e,t){if(e===t)return!0;const i=!!e;if(i!==!!t)return!1;if(!i)return!0;if(e.length!==t.length)return!1;for(let i=0;i<e.length;++i)if(Math.abs(e[i]-t[i])>=h.W.ZERO_LENGTH)return!1;return!0}const se=ie;function ne(e){return!!e&&se(e,u)}function re(e,t){return e[0]*t[1]-e[1]*t[0]}function ae(e,t){return[e[0]-t[0],e[1]-t[1]]}function oe(e,t,i,s,n){const r=[];return!!le(e,t,i,s,r)&&(n[0]=e[0]+r[0]*t[0],n[1]=e[1]+r[0]*t[1],!0)}function he(e,t,i,s,n){const r=[];return!!le(e,t,i,[s[0]-i[0],s[1]-i[1]],r)&&(r[0]>=0&&r[1]>=0&&r[1]<=1&&(n[0]=i[0]+r[0]*t[0],n[1]=i[1]+r[0]*t[1],!0))}function ce(e,t,i,s,n){const r=[t[0]-e[0],t[1]-e[1]],a=[];return!!le(e,r,i,[s[0]-i[0],s[1]-i[1]],a)&&(a[0]>=0&&a[0]<=1&&a[1]>=0&&a[1]<=1&&(n[0]=e[0]+a[0]*r[0],n[1]=e[1]+a[0]*r[1],!0))}function le(e,t,i,s,n){const r=re(t,s);if(Math.abs(r)<h.W.ZERO_LENGTH)return!1;const a=ae(i,e);return n[0]=re(a,s)/r,n[1]=re(a,t)/r,!0}function de(e,t,i){const s=[i[0],i[1]];return w(e,s,[t[0]-e[0],t[1]-e[1]]),s[0]<=Math.max(e[0],t[0])&&s[0]>=Math.min(e[0],t[0])&&s[1]<=Math.max(e[1],t[1])&&s[1]>=Math.min(e[1],t[1])?ue(i,s):Math.min(ue(i,e),ue(i,t))}function ue(e,t){return Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)}function ge(e,t,i,s){i[0]=(e[0]+t[0])/2,i[1]=(e[1]+t[1])/2;const n=[t[0]-e[0],t[1]-e[1]],r=[n[1],-n[0]],a=Math.sqrt(r[0]*r[0]+r[1]*r[1]);return!(a<h.W.ZERO_LENGTH)&&(s[0]=r[0]/a,s[1]=r[1]/a,!0)}function pe(e,t){return[e[0],e[1],e[2],t]}function me(e){return Math.abs(1-s.squaredLength(e))<=h.W.ZERO_LENGTH_SQUARED}function fe(e,t){return t||(t=n.create()),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=0,t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=0,t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}const Ie=666==i.j?[0,0,0]:null;function Ee(e,t){if(Me(e,Ie),Math.abs(1-Math.abs(e[2]/Ie[0]))>h.W.ZERO_ANGLE){t[1]=-Math.asin(e[2]/Ie[0]);const i=Math.cos(t[1]);t[0]=Math.atan2(e[6]/(i*Ie[1]),e[10]/(i*Ie[2])),t[2]=Math.atan2(e[1]/(i*Ie[0]),e[0]/(i*Ie[0]))}else t[2]=0,e[2]<0?(t[1]=Math.PI/2,t[0]=t[2]+Math.atan2(e[4]/Ie[1],e[8]/Ie[2])):(t[1]=-Math.PI/2,t[0]=-t[2]+Math.atan2(-e[4]/Ie[1],-e[8]/Ie[2]))}function Se(e){const t=Math.cos(e[0]),i=Math.sin(e[0]),s=Math.cos(e[1]),r=Math.sin(e[1]),a=Math.cos(e[2]),o=Math.sin(e[2]),h=n.create();return h[0]=s*a,h[1]=s*o,h[2]=-r,h[4]=i*r*a-t*o,h[5]=i*r*o+t*a,h[6]=i*s,h[8]=t*r*a+i*o,h[9]=t*r*o-i*a,h[10]=t*s,h}function Te(e,t,i,s){const r=n.create(),a=t[2]/e[2],o=t[3]/e[3];c.w$.scale(r,[a,o,1]);const h=e[0]-i+e[2]/2,l=e[1]-s+e[3]/2,d=1-2*h/t[2],u=2*l/t[3]-1;return c.w$.translate(r,[d,u,0]),r}function De(e,t,i){const s=i-(t[1]+t[3]);return Te(e,t,t[0],s)}function Ce(e,t){return Te(e,t,0,0)}function Me(e,t){for(let i=0;i<3;++i){for(let t=0;t<3;++t)l[t]=e[4*i+t];t[i]=c.S4.length(l)}}function ye(e,t,i){const s=Math.cos(i),n=Math.sin(i);return[e[0]+s*t,e[1]+n*t]}function Ae(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])}function Pe(e,t){return e-2*Math.round((e-t)/(2*Math.PI))*Math.PI}function Oe(e,t){return e-2*Math.floor((e-t)/(2*Math.PI))*Math.PI}function Re(e,t){return e+2*Math.floor((t-e)/(2*Math.PI))*Math.PI}function we(e,t,i,s){let n;return s-i<2*Math.PI?(n=Oe(e,i),n>s&&(n=Oe(n,s)-s>Oe(i,n)-n?i:s)):(n=Pe(e,t),n>s?n=Oe(n,i):n<i&&(n=Re(n,s))),n}function ve(e){let t=1;for(;t<e;)t*=2;return t}function _e(e){return e.length?Ne(e):Number.isFinite(e)}function Ne(e){for(let t=0;t<e.length;++t)if(!Number.isFinite(e[t]))return!1;return!0}const be=666==i.j?1023:null,Le=511,Fe=1/Le;function xe(e){return e>Le?e-1024:e}function Be(e,t){const i=new Float32Array(3*e.length);let s=0;for(let n=0;n<e.length;++n){const r=t?t[n]*Fe:Fe,a=0|e[n];i[s++]=xe(a&be)*r,i[s++]=xe(a>>10&be)*r,i[s++]=xe(a>>20&be)*r}return i}function Ve(e,t,i,s=0,n=100){return s+(n-s)/(i-t)*(e-t)}function Ue(e,t,i,s=0,n=100){const r=Ve(e,t,i,s,n);return r<s?s:r>n?n:r}},54124:function(e,t,i){i.d(t,{$:function(){return A},AD:function(){return R},Ab:function(){return k},Ae:function(){return re},CO:function(){return W},Dw:function(){return L},E3:function(){return p},EK:function(){return g},FT:function(){return z},G0:function(){return ne},Gn:function(){return d},HR:function(){return j},I$:function(){return v},JP:function(){return ie},KE:function(){return w},KJ:function(){return se},KZ:function(){return Z},L4:function(){return E},PF:function(){return K},PU:function(){return b},Pu:function(){return C},QF:function(){return f},QV:function(){return O},Tf:function(){return ee},U0:function(){return V},Ug:function(){return D},VO:function(){return Y},VQ:function(){return X},W5:function(){return I},X:function(){return te},Z4:function(){return m},Zx:function(){return G},aT:function(){return _},b1:function(){return H},dO:function(){return B},fQ:function(){return N},mg:function(){return M},nw:function(){return Q},pf:function(){return T},qT:function(){return S},sp:function(){return u},tn:function(){return U},ut:function(){return q},wK:function(){return ae},y:function(){return P},zl:function(){return y}});var s=i(60559),n=i(29327),r=i(94205);if(666==i.j)var a=i(68100);var o=i(68434),h=i(45345),c=i(22681);const l=s.O.createLogger("meshutilities",c.bVy.GRAPHICS);function d(e){const t=[];let i=!0;for(let s=0;s<e.length-2;s++)e[s+2]!==e[s+1]&&e[s+1]!==e[s]?(i&&(t.push(e[s]),t.push(e[s+1]),i=!1),t.push(e[s]),t.push(e[s+2]),t.push(e[s+1]),t.push(e[s+2])):i=!0;return t}function u(e,t){const i=new h.B7("createEdgesFromTriangleStrip"),s=d(e.indices);return i.report(),new r.MeshIncrement(r.PrimitiveType.LINES,e.points,s,t)}function g(e,t){if(e.primitiveType!==r.PrimitiveType.TRIANGLES)throw new Error("createEdgesFromTriangles can only be called with triangle primitives");const i=[];for(let t=0;t<e.indices.length;t+=3)i.push(e.indices[t]),i.push(e.indices[t+1]),i.push(e.indices[t]),i.push(e.indices[t+2]),i.push(e.indices[t+1]),i.push(e.indices[t+2]);return new r.MeshIncrement(r.PrimitiveType.LINES,e.points,i,t)}function p(e,t){t||(t=12),e||(e=12);const i=[],s=[],n=[],r=function(e,t,n){i.push(e),i.push(t),i.push(n),s.push(e),s.push(t),s.push(n)};let a,o;for(r(0,0,1),a=0;a<t;a++){const i=a*Math.PI*2/t,s=Math.cos(i),n=Math.sin(i);for(o=1;o<=e;o++){const t=o*Math.PI/(e+1),i=Math.sin(t);r(i*s,i*n,Math.cos(t))}}r(0,0,-1);const h=function(i,s){return e*(s%t)+i+1},c=function(){n.push(n[n.length-1])};for(a=0;a<t;a++){for(n.length>1&&c(),n.push(0),o=0;o<e;o++)n.push(h(o,a)),n.push(h(o,a+1));n.push(e*t+1),c(),n.length%2==0&&c()}return Y(i,n,s)}function m(e){(!e||e<3)&&(e=12);const t=[],i=[],s=[],n=function(e){const s=Math.cos(e),n=Math.sin(e);t.push(s),t.push(n),t.push(1),i.push(s),i.push(n),i.push(0),t.push(s),t.push(n),t.push(0),i.push(s),i.push(n),i.push(0)};let r,a;for(r=0;r<e;r++)a=2*Math.PI*r/e,n(a);for(r=0;r<e;r++)s.push(2*r),s.push(2*r+1);return s.push(0),s.push(1),Y(t,s,i)}function f(e){(!e||e<3)&&(e=12);const t=[],i=[],s=[],n=function(e){const s=Math.cos(e),n=Math.sin(e),r=[s,n,1];o.S4.normalize(r),t.push(0),t.push(0),t.push(1),i.push(r[0]),i.push(r[1]),i.push(r[2]),t.push(s),t.push(n),t.push(0),i.push(r[0]),i.push(r[1]),i.push(r[2])};let r,a;for(r=0;r<e;r++)a=2*Math.PI*r/e,n(a);for(r=0;r<e;r++)s.push(2*r),s.push(2*r+1);return s.push(0),s.push(1),Y(t,s,i)}function I(e,t,i,s,n,a){const o=[e[0],e[1],e[2],t[0],t[1],t[2]],h=new r.MeshIncrement(r.PrimitiveType.LINES,o,[0,1],i);return s&&k(s,h),void 0!==n&&X(n,h),a&&Z(a,h),h}function E(e,t,i,s,n,r){e.addIncrement(I(t,i,s,n,r))}function S(e,t,i,s){const n=new Float32Array(3*e.length),a=new Int32Array(2*e.length);for(let t=0;t<e.length;++t){for(let i=0;i<3;++i)n[3*t+i]=e[t][i];a[2*t]=t,a[2*t+1]=(t+1)%e.length}const o=new r.MeshIncrement(r.PrimitiveType.LINES,n,a,t);return i&&k(i,o),void 0!==s&&X(s,o),o}function T(e,t,i,s,n){const a=new Float32Array(3*e.length),o=new Int32Array(e.length);for(let t=0;t<e.length;++t){o[t]=t;for(let i=0;i<3;++i)a[3*t+i]=e[t][i]}const h=new r.MeshIncrement(r.PrimitiveType.LINES,a,o,t);return i&&k(i,h),void 0!==s&&X(s,h),n&&Z(n,h),h}function D(e,t,i,s,n){e.addIncrement(T(t,i,s,n))}function C(e,t,i,s,n){const a=new r.MeshIncrement(r.PrimitiveType.POINTS,e,[0],t);return i&&k(i,a),void 0!==s&&X(s,a),n&&Z(n,a),a}function M(e,t,i,s,n){const a=e.length/3,o=new Int32Array(a);for(let e=0;e<a;e++)o[e]=e;const h=new r.MeshIncrement(r.PrimitiveType.POINTS,e,o,t);return i&&k(i,h),void 0!==s&&X(s,h),n&&Z(n,h),h}function y(e,t,i,s,r,h,c){let l=r;l||(l=a.fromValues(1,0,0),(0,n.areUnitVectorsParallel)(i,l)&&(l=[0,1,0]));const d=o.S4.normalize(o.S4.cross(i,l,a.create()));l=o.S4.normalize(o.S4.cross(d,i,a.create())),void 0===h&&(h=0),void 0===c&&(c=2*Math.PI);const u=new Float32Array(3*(s+1));let g=h;const p=(c-h)/s,m=a.create(),f=a.create(),I=a.create();for(let i=0;i<s+1;++i){const s=t*Math.cos(g),n=t*Math.sin(g);o.S4.add(e,o.S4.add(o.S4.scale(d,n,f),o.S4.scale(l,s,I),m),m);for(let e=0;e<3;++e)u[3*i+e]=m[e];g+=p}return u}function A(e,t,i,s){const n=y(e,t,i,s=Math.floor(Math.max(3,s)));let a;const o=n.length/3,h=new Float32Array(3*o);for(a=0;a<o;++a)for(let e=0;e<3;++e)h[3*a+e]=i[e];const c=s-2,l=new Int32Array(3*c);for(a=0;a<c;++a)l[3*a]=0,l[3*a+1]=a+1,l[3*a+2]=a+2;const d=new r.MeshIncrement(r.PrimitiveType.TRIANGLES,n,l);return d.normals=h,d}function P(e,t,i,s){const n=y(e,t,i,s=Math.floor(Math.max(3,s)));let a;const o=new Int32Array(2*s);for(a=0;a<s;++a)o[2*a]=a,o[2*a+1]=a+1;return o[o.length-1]=0,new r.MeshIncrement(r.PrimitiveType.LINES,n,o)}function O(e,t,i,s,n,a,o){const h=y(e,t,i,o=Math.floor(Math.max(3,o)),s,n,a),c=new Int32Array(2*o);for(let e=0;e<o;++e)c[2*e]=e,c[2*e+1]=e+1;return new r.MeshIncrement(r.PrimitiveType.LINES,h,c)}function R(e,t,i,s,n,r){const h=e,c=o.S4.add(o.S4.scale(t,s,a.create()),h),l=o.S4.add(o.S4.scale(t,n,a.create()),c),d=o.S4.add(o.S4.scale(i,-r,a.create()),c),u=o.S4.add(o.S4.scale(i,r,a.create()),c);return T([h,c,d,u,d,l,u,l])}function w(e,t,i,s,n,r){const h=e,c=o.S4.scale(t,.5*n,a.create()),l=o.S4.add(o.S4.scale(t,s,a.create()),h),d=o.S4.add(c,l,a.create()),u=o.S4.add(o.S4.scale(i,-r,a.create()),l),g=o.S4.add(o.S4.scale(i,r,a.create()),l),p=o.S4.add(o.S4.scale(t,n,a.create()),l),m=o.S4.add(u,c,a.create()),f=o.S4.add(g,c,a.create());return T([h,l,u,g,u,d,g,d,m,f,m,p,f,p])}function v(e,t,i,s,n,a,o,h){h=Math.floor(Math.max(3,h));const c=(0,r.concatenateFloat32Arrays)(y(e,t,s,h,n,a,o),y(e,i,s,h,n,a,o)),l=h+1,d=new Int32Array(2*l);for(let e=0;e<l;++e)d[2*e]=e,d[2*e+1]=l+e;const u=new r.MeshIncrement(r.PrimitiveType.TRIANGLE_STRIP,c,d);return H(s,u),u}function _(e,t,i,s,n,h,c){const l=o.S4.subtract(t,e,a.create()),d=o.S4.subtract(i,e,a.create()),u=o.S4.normalize(o.S4.cross(l,d,a.create())),g=new Float32Array(9),p=new Float32Array(9),m=function(e,t){for(let i=0;i<3;++i)g[3*e+i]=t[i],p[3*e+i]=u[i]};let f;if(m(0,e),m(1,t),m(2,i),n&&h&&c){f=new Float32Array(6);const e=function(e,t,i){f[2*e]=t,f[2*e+1]=i};e(0,n[0],n[1]),e(1,h[0],h[1]),e(2,c[0],c[1])}const I=new r.MeshIncrement(r.PrimitiveType.TRIANGLES,g,[0,1,2],s);return I.normals=p,I.textureCoordinates=f||null,I}function N(e,t,i,s,n,h){const c=o.S4.subtract(t,e,a.create()),l=o.S4.subtract(i,e,a.create()),d=o.S4.normalize(o.S4.cross(c,l,a.create())),u=new Float32Array(12),g=new Float32Array(12),p=function(e,t){for(let i=0;i<3;++i)u[3*e+i]=t[i],g[3*e+i]=d[i]};let m;if(p(0,e),p(1,t),p(2,o.S4.add(t,l,a.create())),p(3,i),n&&h){m=new Float32Array(8);const e=function(e,t,i){m[2*e]=t,m[2*e+1]=i};e(0,n[0],n[1]),e(1,h[0],n[1]),e(2,h[0],h[1]),e(3,n[0],h[1])}const f=new r.MeshIncrement(r.PrimitiveType.TRIANGLES,u,[0,1,2,0,2,3],s);return f.normals=g,f.textureCoordinates=m||null,f}function b(e,t,i,s,n){const r=o.S4.add(e,o.S4.scale(t,-1,a.create()),a.create());o.S4.add(r,i);const h=o.S4.add(r,o.S4.scale(t,2,a.create()),a.create()),c=o.S4.add(r,o.S4.scale(i,-2,a.create()),a.create()),l=o.S4.add(h,o.S4.scale(i,-2,a.create()),a.create());return T([r,c,c,l,l,h,h,r],"outlineLines",s,n)}function L(e,t,i,s,n,h){const c=o.S4.subtract(t,e,a.create()),l=o.S4.subtract(i,e,a.create()),d=o.S4.length(c),u=o.S4.length(l);o.S4.normalize(c),o.S4.normalize(l);const g=o.S4.normalize(o.S4.cross(c,l,a.create())),p=o.S4.add(o.S4.scale(c,d,a.create()),o.S4.scale(l,u,a.create())),m=o.S4.add(e,p,a.create()),f=(o.S4.add(o.S4.scale(p,.5,a.create()),e),o.S4.add(o.S4.add(o.S4.scale(c,s,a.create()),o.S4.scale(l,s,a.create())),e)),I=o.S4.add(o.S4.add(o.S4.scale(c,-s,a.create()),o.S4.scale(l,s,a.create())),t),E=o.S4.add(o.S4.add(o.S4.scale(c,s,a.create()),o.S4.scale(l,-s,a.create())),i),S=o.S4.add(o.S4.add(o.S4.scale(c,-s,a.create()),o.S4.scale(l,-s,a.create())),m),T=4*(n+1),D=new Float32Array(3*T),C=new Float32Array(3*T);let M=0;const A=function(e,t){for(let i=0;i<3;++i)D[3*e+i]=t[i],C[3*e+i]=g[i]},P=function(e,t,i){const r=y(e,s,g,n,c,t,i);for(let e=0;e<r.length/3;++e)A(M++,[r[3*e],r[3*e+1],r[3*e+2]])};P(I,-Math.PI/2,0),P(S,0,Math.PI/2),P(E,Math.PI/2,Math.PI),P(f,-Math.PI,-Math.PI/2);const O=[];for(let e=1;e<T-1;++e)O.push(0),O.push(e),O.push(e+1);const R=new r.MeshIncrement(r.PrimitiveType.TRIANGLES,D,O,h);return R.normals=C,R}const F=666==i.j?[0,1,2,3,3,4,4,5,6,7,7,8,8,9,10,11,11,12,12,13,14,15,15,16,16,17,18,19,19,20,20,21,22,23]:null,x=666==i.j?[-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1]:null;function B(e,t){const i=new Float32Array(72);let s=0;const n=new Float32Array(3),a=function(r,a){n[r]=a?t[r]:e[r];const o=0===r?2:1===r?0:1,h=0===r?1:1===r?2:0;for(let r=0;r<2;++r)for(let c=0;c<2;++c)n[o]=a!==(0===c)?e[o]:t[o],n[h]=0===r?e[h]:t[h],i.set(n,4*s*3+3*(2*r+c));++s};a(0,!1),a(0,!0),a(1,!1),a(1,!0),a(2,!1),a(2,!0);const o=new r.MeshIncrement(r.PrimitiveType.TRIANGLE_STRIP,i,F);return o.normals=x,o}function V(e,t){const i=[],s=[e,t];for(let e=0;e<2;e++)for(let t=0;t<2;t++)for(let n=0;n<2;n++)i.push(a.fromValues(s[e][0],s[t][1],s[n][2]));const n=[];for(let e=0;e<i.length;e++)for(let t=e+1;t<i.length;t++){const s=i[e],r=i[t],a=s[0]===r[0],o=s[1]===r[1],h=s[2]===r[2];(a&&o||a&&h||o&&h)&&(n.push(s),n.push(r))}return T(n)}function U(e,t,i,s,n,r,a){e.addIncrement(N(t,i,s,n,r,a))}function H(e,t){const i=t.vertexCount(),s=new Float32Array(3*i);for(let t=0;t<i;++t)for(let i=0;i<3;++i)s[3*t+i]=e[i];t.normals=s}function G(e,t){const i=t.vertexCount(),s=new Float32Array(2*i);for(let t=0;t<i;++t)for(let i=0;i<2;++i)s[2*t+i]=e[i];t.textureCoordinates=s}function k(e,t){const i=[255,255,255,255];for(let t=0;t<4&&t<e.length;++t)i[t]=255*e[t];W(i,t)}function W(e,t){const i=t.vertexCount(),s=new Uint8Array(4*i);let n;if(4===e.length){for(n=0;n<i;++n)for(let t=0;t<4;++t)s[4*n+t]=e[t];t.colors=s}else l.warn("Tried to add a color with the wrong number of channels to a mesh increment")}function z(e,t){W((0,r.convertIntToUcharArray)(e),t)}function X(e,t){const i=t.vertexCount(),s=new Float32Array(i);for(let t=0;t<i;++t)s[t]=e;t.primitiveSizes=s}function Z(e,t){const i=t.vertexCount(),s=new Uint8Array(r.Attributes.PRIMITIVE_STYLE.dimension*i);let n;const a=[];for(n=0;n<r.Attributes.PRIMITIVE_STYLE.dimension;++n)n<e.length?a.push((0,r.clamp)(Math.round(e[n]),0,255)):a.push(0);for(n=0;n<i;++n)for(let e=0;e<r.Attributes.PRIMITIVE_STYLE.dimension;++e)s[n*r.Attributes.PRIMITIVE_STYLE.dimension+e]=a[e];t.primitiveStyles=s}function q(e,t,i,s){const n=new r.MeshIncrement(r.PrimitiveType.TRIANGLES,e,t,i);return s&&k(s,n),n}function Y(e,t,i,s){const n=new r.MeshIncrement(r.PrimitiveType.TRIANGLE_STRIP,e,t);return i&&(n.normals=i),s&&k(s,n),n}function K(e){return e.toFixed(10).slice(0,12)}function j(e){return Q(e[0],e[1],e[2])}function Q(e,t,i){return K(e)+"_"+K(t)+"_"+K(i)}let $={},J=1;function ee(e,t){let i=a.dot(e,t);i<0&&(i=-i,t=a.fromValues(-t[0],-t[1],-t[2]));const s=j(t)+"_"+K(i);return $[s]||($[s]=J,J=Math.max((J+1)%24,1)),$[s]}function te(e,t){return ie(ee(e,t))}function ie(e){const t=(0,r.convertIntToUcharArray)(1<<e);return t[1]<<8|t[2]<<16|t[3]<<24}function se(e){const t=ie(e),i=(0,r.convertIntToUcharArray)(t);return(0,r.convertRGBA255ToRGBA)(i)}function ne(){$={},J=1}function re(e,t){const i=e.vertexCount(),s=new Uint8Array(4*i);let n,r;for(n=0;n<i;++n)for(let i=0;i<4;++i)r=4*n+i,e.colors?s[r]=e.colors[r]:s[r]=255,(r+1)%4==0&&(s[r]=255*t);return e.colors=s,e}function ae(e){if(e.primitiveType!==r.PrimitiveType.TRIANGLES)return;const t=new Float32Array(3*e.indices.length),i=new Int32Array(e.indices.length),s=new Float32Array(3*e.indices.length),n=a.create(),o=a.create();for(let r=0;r<i.length;r+=3){i[r]=r;const h=e.getPoint(e.indices[r],t.subarray(3*r));i[r+1]=r+1;const c=e.getPoint(e.indices[r+1],t.subarray(3*(r+1)));i[r+2]=r+2;const l=e.getPoint(e.indices[r+2],t.subarray(3*(r+2))),d=a.cross(s.subarray(3*r),a.normalize(n,a.subtract(n,c,h)),a.normalize(o,a.subtract(o,l,h)));a.copy(s.subarray(3*(r+1)),d),a.copy(s.subarray(3*(r+2)),d)}e.points=t,e.indices=i,e.normals=s}},46165:function(e,t,i){i.d(t,{D:function(){return d},z:function(){return l}});var s=i(21512),n=i(64880),r=i(60559),a=i(22681);if(666==i.j)var o=i(81578);var h=i(68434);const c=r.O.createLogger("Pick",a.bVy.GRAPHICS);var l;!function(e){e[e.UNKNOWN=-10]="UNKNOWN",e[e.REDUCED_DIMENSION_PRIORITY=-1]="REDUCED_DIMENSION_PRIORITY",e[e.CONSTRUCTION_PLANE=0]="CONSTRUCTION_PLANE",e[e.CONSTRUCTION_PLANE_EDGE=1]="CONSTRUCTION_PLANE_EDGE",e[e.PART_FACE=5]="PART_FACE",e[e.NON_MODIFIABLE_FACE=7]="NON_MODIFIABLE_FACE",e[e.NON_MODIFIABLE_EDGE=8]="NON_MODIFIABLE_EDGE",e[e.NON_MODIFIABLE_VERTEX=9]="NON_MODIFIABLE_VERTEX",e[e.SKETCH_FACE=10]="SKETCH_FACE",e[e.ORIGIN=15]="ORIGIN",e[e.SECTION_PLANE=16]="SECTION_PLANE",e[e.PART_EDGE=20]="PART_EDGE",e[e.POINT_BODY=25]="POINT_BODY",e[e.PART_VERTEX=30]="PART_VERTEX",e[e.ANNOTATION_LOW=44]="ANNOTATION_LOW",e[e.DIMENSION=45]="DIMENSION",e[e.MATE_CONNECTOR=46]="MATE_CONNECTOR",e[e.DEGENERATE_SKETCH_EDGE=47]="DEGENERATE_SKETCH_EDGE",e[e.SKETCH_EDGE=50]="SKETCH_EDGE",e[e.INACTIVE_SKETCH_VERTEX=59]="INACTIVE_SKETCH_VERTEX",e[e.ACTIVE_SKETCH_VERTEX_CONSTRAINED=60]="ACTIVE_SKETCH_VERTEX_CONSTRAINED",e[e.ACTIVE_SKETCH_VERTEX_UNCONSTRAINED=61]="ACTIVE_SKETCH_VERTEX_UNCONSTRAINED",e[e.ANNOTATION_HIGH=62]="ANNOTATION_HIGH",e[e.UI=70]="UI"}(l||(l={}));class d{constructor(e,t,i,s){this.occurrenceId=t,this.location=i,this.usage=s,this.deterministicId=null,this.partId=null,this.locationCount=1,this.locationsSinceSample=0,this.distance=1,this.coverage=0,this.fromPass=0,this.isFromActiveSketch=!1,this.entityMetaData=null,this.bodyMetaData=null,this.uiSelection=null,this.occurrence=null,this.featureIdList=null,this.isPickThrough=null,this.primitiveId=e.slice(0),this.locationSum=o.clone(i),this.locationSamples=[this.location],this.pickedOccurrenceId=t}incorporateLocation(e){h.gv.add(this.locationSum,e,this.locationSum),++this.locationCount;const t=this.locationSamples.length<10?5:this.locationSamples.length<20?50:500;this.locationsSinceSample>=t?(this.locationSamples.push(e),this.locationsSinceSample=0):++this.locationsSinceSample}determineBestLocation(){const e=h.gv.scale(this.locationSum,1/this.locationCount,o.create());let t=1/0;for(let i=0;i<this.locationSamples.length;++i){const s=h.gv.distanceSquared(e,this.locationSamples[i]);s<t&&(this.location=this.locationSamples[i],t=s)}}isUIPick(){return!!this.uiSelection}getUISelection(){return this.uiSelection?this.uiSelection.uiElement:null}isEntityPick(){return!!this.entityMetaData}isBodyPick(){return!!this.bodyMetaData}isModelPick(){return this.isBodyPick()||this.isEntityPick()}getBodyId(){return this.bodyMetaData?this.bodyMetaData.id:this.entityMetaData?this.entityMetaData.getBodyId():null}getOccurrence(){return this.occurrence}getId(){return this.primitiveId+s.ID_SEPARATOR+this.occurrenceId}getModelSelection(){if(this.isEntityPick())return new n.Y1(a.lQt.ENTITY,this.deterministicId,this.occurrence,{entityMetaData:this.entityMetaData,source:n.Hw.PICK,sourcePick:this,usage:this.usage,featureIdList:this.featureIdList,name:this.entityMetaData.getName()});if(this.isBodyPick())return new n.Y1(a.lQt.BODY,this.deterministicId,this.occurrence,{bodyMetaData:this.bodyMetaData,source:n.Hw.PICK,sourcePick:this,usage:this.usage,name:this.bodyMetaData.getName()});const e=this.isUIPick()?this.uiSelection.getModelSelection():null;return e&&(e.sourcePick||(e.sourcePick=this),e.source=n.Hw.PICK,e.usage=this.usage),e}getPickPriority(){if(this.isUIPick()){const e=this.uiSelection.getPickPriority();return null!==e?e:l.UI}if(this.entityMetaData){if(this.entityMetaData.isFromOrigin())return l.ORIGIN;if(this.entityMetaData.isPointEntity())return l.POINT_BODY;if(this.entityMetaData.isFromSketch()){if(this.entityMetaData.isFace())return l.SKETCH_FACE;if(this.entityMetaData.isEdge())return l.SKETCH_EDGE;if(this.entityMetaData.isDegenerateEdge())return l.DEGENERATE_SKETCH_EDGE;{if(!this.isFromActiveSketch)return l.INACTIVE_SKETCH_VERTEX;const e=this.entityMetaData.getSketchSolveStatus();return e===a.ea7.FIXED||e===a.ea7.OVER_DEFINED||e===a.ea7.WELL_DEFINED?l.ACTIVE_SKETCH_VERTEX_CONSTRAINED:l.ACTIVE_SKETCH_VERTEX_UNCONSTRAINED}}if(this.entityMetaData.isFromBody())return this.entityMetaData.getBodyMetaData()&&!this.entityMetaData.getBodyMetaData().isModifiableBody()?this.entityMetaData.isFace()?l.NON_MODIFIABLE_FACE:this.entityMetaData.isEdge()?l.NON_MODIFIABLE_EDGE:l.NON_MODIFIABLE_VERTEX:this.entityMetaData.isFace()?l.PART_FACE:this.entityMetaData.isEdge()?l.PART_EDGE:l.PART_VERTEX}return l.UNKNOWN}getIncrementId(){if(this.isModelPick()){if(this.deterministicId)return this.deterministicId;c.warn("Found a model pick without a valid entity id")}else{if(this.uiSelection)return this.uiSelection.meshIncrementId;if(this.primitiveId)return this.primitiveId.toString();c.warn("Found a pick without an owner from which to retrieve an increment id")}return""}getEntityMetaData(){if(this.entityMetaData)return this.entityMetaData;const e=this.getModelSelection();return e?e.getEntityMetaData():null}getDeterministicId(){if(this.deterministicId)return this.deterministicId;const e=this.getModelSelection();return e?e.getDeterministicId():""}setIsPickThrough(e){this.isPickThrough=e}canPickThrough(e,t,i){if(i&&i.pickHiddenOccurrences&&t.isPickFromHiddenOccurrence(this))return!0;if(null===this.isPickThrough)if(this.uiSelection)this.isPickThrough=this.uiSelection.canPickThrough();else{const s=this.getEntityMetaData();if(s){let n=s.isTranslucent();if(!!i&&i.altKey&&s.isFromBody()&&s.isFace())if(t.getIsolatedOccurrenceManager()?.isOccurrenceIdTranslucent(this.occurrenceId))n=!0;else{const e=t.getModelViewManagers().getManagerForUsage(this.usage).getPartStudioDataFromOccurrence(this.occurrence).getBodyComponent().getFaceColor(this.deterministicId,this.occurrenceId);n=!!e&&e[3]<1}this.isPickThrough=n&&e!==a.P1.HIDDEN_LINE_REMOVED||s.isFromSketch()}else this.isPickThrough=!1}return this.isPickThrough}getOccurrenceId(){return this.occurrenceId}}},74029:function(e,t,i){i.d(t,{G:function(){return r},Z:function(){return a}});var s=i(64880),n=i(46165);function r(e,t){if(!e&&!t)return 0;if(e&&!t)return-1;if(!e&&t)return 1;const i=e.getPickPriority(),r=t.getPickPriority();if(i>r)return-1;if(i<r)return 1;if(i!==n.z.INACTIVE_SKETCH_VERTEX&&i!==n.z.ACTIVE_SKETCH_VERTEX_CONSTRAINED&&i!==n.z.ACTIVE_SKETCH_VERTEX_UNCONSTRAINED){if(e.fromPass<t.fromPass)return-1;if(e.fromPass>t.fromPass)return 1}const a=(1+e.distance)*(1-e.coverage),o=(1+t.distance)*(1-t.coverage);if(a<o)return-1;if(a>o)return 1;if((i===n.z.INACTIVE_SKETCH_VERTEX||i===n.z.ACTIVE_SKETCH_VERTEX_CONSTRAINED||i===n.z.ACTIVE_SKETCH_VERTEX_UNCONSTRAINED)&&e.deterministicId&&t.deterministicId){const i=s.X8.unpackDetId(e.deterministicId),n=s.X8.unpackDetId(t.deterministicId);if(i.operationIdx<n.operationIdx)return-1;if(i.operationIdx>n.operationIdx)return 1;if(i.entityIdx<n.entityIdx)return-1;if(i.entityIdx>n.entityIdx)return 1}return 0}function a(e,t){return e.sort(((e,i)=>{const s=e.getModelSelection(),n=i.getModelSelection();if(!s||!n)return r(e,i);if(s.isPlane()||n.isPlane())return r(e,i);if(s.isFace()!==n.isFace())return r(e,i);const a=t(e);return a===t(i)?r(e,i):a?1:-1}))}},46560:function(e,t,i){i.d(t,{Y:function(){return s}});class s{constructor(){this.resultRange1=[0,0,null],this.resultRange2=[0,0,null],this.nextResult=null}hasMoreRanges(){return!!this.nextResult}getNextRange(){const e=this.nextResult;return this.nextResult=this.findNextRange(),e}getStorageForNextResult(){const e=this.nextResult===this.resultRange1?this.resultRange2:this.resultRange1;return e[2]=null,e}}},57735:function(e,t,i){i.d(t,{Y:function(){return d}});var s=i(63407),n=i(54124),r=i(89942),a=i(94205);const o=i(32606).default.getManager(),h=new r.hF({primitiveType:a.PrimitiveType.TRIANGLES,isPickable:!1,isHighlightable:!1,isTwoSided:!0,isShowThrough:!1,isDepthTested:!0,zOffset:-1}),c=new r.hF({primitiveType:a.PrimitiveType.TRIANGLES,isPickable:!1,isHighlightable:!1,isTwoSided:!0,isShowThrough:!1,isDepthTested:!0,primitivesHaveTransparency:!0,zOffset:-2}),l=new r.hF({primitiveType:a.PrimitiveType.LINES,isPickable:!1,isHighlightable:!1,isTwoSided:!0,isShowThrough:!1,isDepthTested:!0,zOffset:-3});class d extends(666==i.j?s.u1:null){constructor(e,t,i,s,n,r){super(r),this.checkerboardScale=1,this.showColor=!0,this.needsUpdate=!0,this.showGraphics=!0,this.points=e,this.uvs=t,this.facets=i,this.edges=s,this.distortions=n,this.showFacets=!1,this.showEdges=!0,this.showDistortions=!0,this.showCheckerboard=!1,this.showColor=!0,this.checkerboardTexture=this.createTexture(),this.checkerboardTexture.hasTransparency=!1,this.textureMaterial=(0,a.createTextureMaterial)(),this.textureMaterial.ambientTexture=this.checkerboardTexture}onViewWillDraw(e,t){this.updateGraphics()}updateGraphics(){if(!this.needsUpdate)return;if(this.removeMeshIncrements(),!this.showGraphics)return;const e=[],t=[];for(const t of this.points)e.push(t[0],t[1],t[2]);for(const e of this.uvs)t.push(e[0]*this.checkerboardScale,e[1]*this.checkerboardScale);if(this.showColor||this.showCheckerboard){const i=this.showColor||this.showCheckerboard?o.getColor("FLATTENED_SURFACE_COLOR"):[0,0,0,0],c=(0,n.ut)(e,this.facets,"flattendisp",i);let l;c.textureCoordinates=t,l=this.showCheckerboard?new r.hF({primitiveType:a.PrimitiveType.TRIANGLES,isPickable:!1,isHighlightable:!1,isTwoSided:!0,isShowThrough:!1,isDepthTested:!0,material:this.textureMaterial}):h,this.updateMeshIncrement("flattendispinc",s.ZJ,c,l)}if(this.showDistortions){const t=[];for(const e of this.distortions){let i=[255,0,0,0];e>0?i[3]=e>=1?255:Math.round(255*e):e<0&&(i=[0,0,255,Math.round(255*-e)],e<=-1&&(i[3]=255)),t.push(...i)}const i=(0,n.ut)(e,this.facets,"distortions",[0,0,0,0]);i.colors=t;const r=c;this.updateMeshIncrement("distortioninc",s.ZJ,i,r)}if(this.showFacets){const e=[],t=this.facets.length/3;for(let i=0;i<t;i++){const t=this.facets[3*i],s=this.facets[3*i+1],n=this.facets[3*i+2],r=[t,s,n];if(t!==s&&s!==n&&n!==t)for(let t=0;t<3;t++){const i=this.points[r[t]],s=this.points[r[(t+1)%3]];e.push(i),e.push(s)}}const i=(0,n.pf)(e,"facets",o.getColor("FLATTENED_SURFACE_FACET_COLOR"));this.updateMeshIncrement("facetsinc",s.ZJ,i,l)}if(this.showEdges){const e=[],t=this.edges.length;for(let i=0;i<t;i++){const t=this.points[this.edges[i]];e.push(t)}const i=(0,n.pf)(e,"edges",o.getColor("FLATTENED_SURFACE_EDGE_COLOR"));this.updateMeshIncrement("edgesinc",s.ZJ,i,l)}this.needsUpdate=!1}remove(){this.textureMaterial&&(this.textureMaterial.destroy(),this.textureMaterial=null,this.checkerboardTexture.destroy(),this.checkerboardTexture=null),super.remove()}static createTextureDef(e){const t=[];for(let e=0;e<8;e++)for(let i=0;i<8;i++){const s=e%2==i%2?0:255;t[4*(8*e+i)]=s,t[4*(8*e+i)+1]=s,t[4*(8*e+i)+2]=s,t[4*(8*e+i)+3]=255}const i=new Uint8Array(t),s=new a.TextureDefinition(e);return s.bytes=i,s.width=8,s.height=8,s.wrapS=e.REPEAT,s.wrapT=e.REPEAT,s}createTexture(){return new a.Texture(this.viewer,d.createTextureDef)}touch(){this.needsUpdate=!0,this.viewer?.requestDraw()}getFitBounds(){const e=this.getInstantiatedMeshIncrement("flattendispinc")?.meshIncrement.getBounds();return e}}},89942:function(e,t,i){i.d(t,{DO:function(){return g},Gy:function(){return S},NB:function(){return T},hF:function(){return f},hn:function(){return E}});var s=i(94205),n=i(32606),r=i(36889);if(666==i.j)var a=i(57792);var o=i(60559);if(666==i.j)var h=i(35589);var c=i(68434),l=i(22681);const d=o.O.createLogger("Node",l.bVy.GRAPHICS),u=n.default.getManager();var g;!function(e){e[e.LOWER=0]="LOWER",e[e.DEFAULT=1]="DEFAULT",e[e.HIGHER=2]="HIGHER",e[e.HIGHEST=3]="HIGHEST",e[e.COUNT=4]="COUNT"}(g||(g={}));const p=Math.ceil(Math.log(g.COUNT)/Math.log(2)),m=new s.BitShiftId;class f{constructor(e){this.isVisible=!0,this.isPickable=!0,this.isHighlightable=!0,this.isTwoSided=!1,this.isTintedByCompare=!1,this.isShowThrough=!1,this.isDepthTested=!0,this.isStencilTested=!1,this.isStencilWritten=!0,this.clippedBySectionPlanes=!1,this.addsToSectionMask=!0,this.primitivesHaveTransparency=!1,this.zOffset=0,this.pickZOffset=0,this.addsToBounds=!0,this.includedInBlend=!1,this.debugId="",this.priority=g.DEFAULT,this.primitiveType=s.PrimitiveType.PRIMITIVE_UNKNOWN,this.material=s.DEFAULT_MATERIAL,this.initializeFromProperties(e),this.updateId()}initializeFromProperties(e){e&&(0,r.overwriteMatchingProperties)(this,e),e?.hasOwnProperty("pickZOffset")||(this.pickZOffset=this.zOffset),e?.hasOwnProperty("isStencilWritten")||this.primitiveType!==s.PrimitiveType.TRIANGLES&&this.primitiveType!==s.PrimitiveType.TRIANGLE_STRIP||(this.isStencilWritten=!1)}clone(){return new f(this)}cloneAndModify(e,t){const i=new f(this);return t||(i.debugId=void 0),i.initializeFromProperties(e),i.updateId(),i}toString(e){return e?(this.primitiveType!==s.PrimitiveType.PRIMITIVE_UNKNOWN?"primitiveType:"+(0,s.getPrimitiveTypeDescription)(this.primitiveType):"")+(this.material?",m:"+this.material.id:""):"NodeProperties: primitiveType:"+(0,s.getPrimitiveTypeDescription)(this.primitiveType)+",m:"+(this.material?this.material.id:"null")+",iV:"+this.isVisible+",iP:"+this.isPickable+",iH:"+this.isHighlightable+",iTS:"+this.isTwoSided+",iTBC:"+this.isTintedByCompare+",iShTh:"+this.isShowThrough+",iDT:"+this.isDepthTested+",iStTe:"+this.isStencilTested+",iStWr:"+this.isStencilWritten+",cBSP:"+this.clippedBySectionPlanes+",aTSM:"+this.addsToSectionMask+",pHT:"+this.primitivesHaveTransparency+",p:"+this.priority+",zO:"+this.zOffset+",pZO:"+this.pickZOffset+",aTB:"+this.addsToBounds+",iIB:"+this.includedInBlend}makeSceneDebugObject(){const e=[];return e.push((0,s.createTextDebugObject)("primitiveType",(0,s.getPrimitiveTypeDescription)(this.primitiveType))),e.push(this.material?this.material.makeSceneDebugObject():(0,s.createTextDebugObject)("material",null)),(0,s.addChildDebugObjectsFromProperties)(e,this,{id:!0,primitiveType:!0,material:!0}),{text:"[Node properties] "+this.id+" "+this.toString(!0),children:e}}updateId(){m.reset(),m.addBoolean(this.isVisible),m.addBoolean(this.isPickable),m.addBoolean(this.isHighlightable),m.addBoolean(this.isTwoSided),m.addBoolean(this.isShowThrough),m.addBoolean(this.isDepthTested),m.addBoolean(this.isStencilTested),m.addBoolean(this.isStencilWritten),m.addBoolean(this.clippedBySectionPlanes),m.addBoolean(this.addsToSectionMask),m.addBoolean(this.primitivesHaveTransparency),m.addBoolean(this.includedInBlend),m.addNumber(this.priority,p),m.addNumber(this.primitiveType,s.PRIMITIVE_TYPE_BITS),m.addNumber(this.zOffset+31,6),m.addNumber(this.pickZOffset+31,6),Math.abs(this.zOffset)>31&&d.warn("zOffset "+this.zOffset+" could result in a duplicate node id, resulting in bad z offset state"),Math.abs(this.pickZOffset)>31&&d.warn("pickZOffset "+this.pickZOffset+" could result in a duplicate node id, resulting in bad pick z offset state"),m.addBoolean(this.addsToBounds);let e=m.getId();this.material&&(e=m.getIdWithIdAppended(this.material.id)),this.id=e}}let I=666==i.j?[]:null;function E(e){I.push(e)}function S(){for(let e=0;e<I.length;++e){const t=I[e];t&&!t.getParent()&&t.onPermanentlyRemoved()}I=[]}class T{constructor(e,t,i){this.id=e,this.pose=null,this.children=null,this.childMap={},this.parent=null,this.areBoundsDamaged=!1,this.nodeOccurrences=null,this.usage=void 0!==i?i:s.BTGraphicsUsage.BASE,this.properties=new f(t),this.boundingBox=new s.BoundingBox}integrityCheck(){this.nodeOccurrences&&this.children&&this.children.length>0&&d.error("Found non-leaf scenegraph node with a node occurrences. Node id: "+this.id)}getId(){return this.id}setPose(e){e&&this.pose&&h.equals(e,this.pose)||(this.pose=e,this.damageBounds())}getPose(){return this.pose}damageBounds(){this.areBoundsDamaged||(this.areBoundsDamaged=!0,this.parent&&this.parent.damageBounds())}getUsage(){return this.usage}updateBounds(e){const t=!!e&&!!e.includeHiddenBounds;if(this.areBoundsDamaged||t)if(this.boundingBox.reset(),this.nodeOccurrences){if(this.getAddsToBounds()||t){const t=this.nodeOccurrences.getKeyValues();for(let i=0;i<t.length;i+=2)t[i+1].addBounds(this.boundingBox,e)}this.areBoundsDamaged=!1}else if(this.children){this.areBoundsDamaged=!1;for(let t=0;t<this.children.length;++t){const i=this.children[t].getBoundingBox(e);this.children[t].getIsVisible()&&this.children[t].getAddsToBounds()&&(0,s.isValidForBounding)(i)&&(this.boundingBox.addBox(i,this.pose),this.areBoundsDamaged=this.areBoundsDamaged||this.children[t].areBoundsDamaged)}}}getBoundingBox(e){return(this.areBoundsDamaged||e&&e.includeHiddenBounds)&&this.updateBounds(e),this.boundingBox}getOccurrenceBounds(e,t){if(this.getAddsToBounds())if(this.nodeOccurrences){const i=this.nodeOccurrences.get(e);i&&i.addBounds(t)}else if(this.children)for(let i=0;i<this.children.length;++i)this.children[i].getOccurrenceBounds(e,t)}addChild(e,t){if(e){switch(this.children||(this.children=[]),void 0===t?this.children.push(e):(t=(0,s.clamp)(Math.round(t),0,this.children.length),this.children.splice(t,0,e)),this.childMap[e.id]=e,e.parent=this,e.usage){case s.BTGraphicsUsage.PREVIEW:this.usage!==s.BTGraphicsUsage.PREVIEW&&d.warn("Adding PREVIEW node to non-PREVIEW node (usage "+this.usage+")");break;case s.BTGraphicsUsage.BASE:e.usage=this.usage}this.damageBounds(),this.integrityCheck()}else d.warn("A scenegraph node cannot add a null child")}findOrCreateChildNodeByProperties(e){const t=e.id.toString();let i=this.getChildById(t);return i||(i=new T(t.toString(),e,this.usage),this.addChild(i)),i}addOccurrenceGeometryToNode(e,t,i,s,n,r){const a=this.findOrCreateChildNodeByProperties(e),o=a.findOrCreateNodeOccurrenceByData(t).addStyledMeshRanges(i,s,n,r);return a.damageBounds(),o}findOrCreateNodeOccurrenceByData(e){this.nodeOccurrences||(this.nodeOccurrences=new a.N);let t=this.nodeOccurrences.get(e.getOccurrenceId());return t||(t=new s.NodeOccurrence(this,e),this.nodeOccurrences.set(e.getOccurrenceId(),t)),t}removeOccurrenceFromNode(e,t){const i=e.id.toString(),s=this.getChildById(i);s&&s.removeOccurrence(t),this.cleanEmptyMeshNodes()}hasNonIsolatedOccurrences(){if(this.nodeOccurrences){const e=this.nodeOccurrences.getKeyValues();for(let t=1;t<e.length;t+=2){if(!e[t].occurrenceData.getIsolated())return!0}}return!1}removeOccurrence(e){if(e=+e,this.nodeOccurrences){const t=this.nodeOccurrences.get(e);t&&(t.destroy(),this.nodeOccurrences.delete(e),this.damageBounds())}else{for(let t=0;this.children&&t<this.children.length;++t)this.children[t].removeOccurrence(e);this.cleanEmptyMeshNodes()}}removeMeshGroupFromOccurrence(e,t){if(t=+t,this.isMeshNode()){const i=this.nodeOccurrences.get(t);if(i){i.removeAllChildrenForMeshGroup(e)&&(i.isEmpty&&(i.destroy(),this.nodeOccurrences.delete(t)),this.damageBounds())}}else{for(let i=0;this.children&&i<this.children.length;++i)this.children[i].removeMeshGroupFromOccurrence(e,t);this.cleanEmptyMeshNodes()}}removeChild(e,t){if(!this.children)return;const i=this.children.indexOf(e);i>-1&&(delete this.childMap[e.id],this.children.splice(i,1),e.onRemoved(t),this.damageBounds())}removeChildById(e){if(!this.children)return;const t=this.childMap[e];t&&this.removeChild(t)}removeAllChildren(){if(this.children){for(let e=0;e<this.children.length;++e)this.children[e].onRemoved();this.childMap={},this.children=[],this.damageBounds()}}remove(){this.parent?this.parent.removeChild(this):d.error("Trying to remove parentless child")}onRemoved(e){this.parent=null,e||E(this)}onPermanentlyRemoved(){if(this.children)for(let e=0;e<this.children.length;++e)this.children[e]&&this.children[e].onPermanentlyRemoved();else if(this.nodeOccurrences){const e=this.nodeOccurrences.getKeyValues();for(let t=0;t<e.length;t+=2)e[t+1].destroy();this.nodeOccurrences=null}}cleanEmptyMeshNodes(){if(this.children)for(let e=0;e<this.children.length;++e)this.children[e].isMeshNode()?this.children[e].isEmptyMeshNode()&&this.children[e].remove():this.children[e].cleanEmptyMeshNodes()}getParent(){return this.parent}getChildById(e){return this.children&&this.childMap[e]||null}getChildrenWithPrefix(e){if(!this.children)return null;let t=null;for(const i in this.childMap)0===i.indexOf(e)&&(t=t||[],t.push(this.childMap[i]));return t}getChildByIndex(e){return!this.children||e>=this.children.length||e<0?null:this.children[e]}getChildCount(){return this.children?this.children.length:0}isMeshNode(){return!!this.nodeOccurrences}isEmptyMeshNode(){return this.isMeshNode()&&0===this.nodeOccurrences.size}getPrimitiveType(){return this.properties?this.properties.primitiveType:s.PrimitiveType.PRIMITIVE_UNKNOWN}isFaces(){if(!this.isMeshNode())return!1;const e=this.getPrimitiveType();return e===s.PrimitiveType.TRIANGLES||e===s.PrimitiveType.TRIANGLE_STRIP}isEdges(){if(!this.isMeshNode())return!1;const e=this.getPrimitiveType();return e===s.PrimitiveType.LINES||e===s.PrimitiveType.INFINITE_LINES}isPoints(){if(!this.isMeshNode())return!1;return this.getPrimitiveType()===s.PrimitiveType.POINTS}isSilhouettes(){if(!this.isMeshNode())return!1;return this.getPrimitiveType()===s.PrimitiveType.SILHOUETTES}getProperties(){return this.properties}getMaterial(){return this.properties.material}getIsVisible(){return this.properties.isVisible&&(!this.properties.material||this.properties.material.isVisible)}getIsPickable(){return this.properties.isPickable}getIsHighlightable(){return this.properties.isHighlightable}getIsTwoSided(){return this.properties.isTwoSided}getIsTintedByCompare(){return this.properties.isTintedByCompare}getIsShowThrough(){return this.properties.isShowThrough}getIsDepthTested(){return this.properties.isDepthTested}getIsStencilTested(){return this.properties.isStencilTested}getIsStencilWritten(){return this.properties.isStencilWritten}getClippedBySectionPlanes(){return this.properties.clippedBySectionPlanes}getAddsToSectionMask(){return this.properties.addsToSectionMask}hasTransparency(){return this.properties.primitivesHaveTransparency||!!this.properties.material&&this.properties.material.hasTransparency()}getRenderOrderPriority(){return this.properties.priority}getIncludedInBlend(){return this.properties.includedInBlend}getAddsToBounds(){return this.properties.addsToBounds}getZOffset(){return this.properties.zOffset}getPickZOffset(){return this.properties.pickZOffset}draw(e){if((!e.isHighlighting()||this.getIsHighlightable())&&(e.isHighlighting()||e.isPicking()||this.getIsVisible())&&(this.children||e.nodeFilter(this))){if(this.pose&&e.pushModelViewMatrix(c.w$.multiply(e.getModelViewMatrix(),this.pose,h.create())),this.isMeshNode()){this.properties.material&&e.pushMaterial(this.properties.material),e.activateTopShader();const t=e.getActiveShader();if(!t)return this.properties.material&&e.popMaterial(),void(this.pose&&e.popModelViewMatrix());e.setMaterial(),e.updateModelviewUniforms(),e.setUsage(this.usage);const i=this.nodeOccurrences?this.nodeOccurrences.getKeyValues():null;if(i&&e.isHighlighting()){this.isEdges()?(e.getUseHiddenOpacityForEdgeHighlights()?(t.uniform1f("uHighlightOpacity",u.getNumber("HIGHLIGHT_HIDDEN_EDGE_OPACITY")),t.uniform1f("uHighlightBorderOpacity",u.getNumber("HIGHLIGHT_HIDDEN_EDGE_BORDER_OPACITY"))):(t.uniform1f("uHighlightOpacity",u.getNumber("HIGHLIGHT_EDGE_OPACITY")),t.uniform1f("uHighlightBorderOpacity",u.getNumber("HIGHLIGHT_EDGE_BORDER_OPACITY"))),e.setLineWidth(this.properties.material.lineWidth),e.setLineStipple(this.properties.material.lineStipple)):this.isPoints()&&(t.uniform1f("uHighlightOpacity",u.getNumber("HIGHLIGHT_POINT_OPACITY")),e.setPointSize(this.properties.material.pointSize)),e.setFacesToCull(s.CullFace.NONE);for(let t=0;t<i.length;t+=2)i[t+1].draw(e);e.setFacesToCull(s.CullFace.BACK)}if((this.getIsVisible()||e.isPicking())&&!e.isHighlighting()&&(this.getIsTwoSided()||e.isPickingBackFaces()?e.setFacesToCull(s.CullFace.NONE):e.setFacesToCull(s.CullFace.BACK),this.isPoints()?(e.setPointSize(this.properties.material.pointSize),e.setPointFont(this.properties.material.pointFont)):(this.isEdges()||this.isSilhouettes())&&(e.setLineWidth(this.properties.material.lineWidth),e.setLineStipple(this.properties.material.lineStipple)),t.uniform1i("uClippedBySectionPlanes",this.getClippedBySectionPlanes()?1:0),t.uniform1f("uAddsToSectionMask",this.getAddsToSectionMask()?1:0),i))for(let t=0;t<i.length;t+=2)i[t+1].draw(e);this.properties.material&&e.popMaterial()}else if(this.children)for(let t=0;t<this.children.length;++t)this.children[t].draw(e);this.pose&&e.popModelViewMatrix()}}passesNodeFilter(e){if(e(this))return!0;if(this.children)for(let t=0;t<this.children.length;++t)if(this.children[t].passesNodeFilter(e))return!0;return!1}walk(e){if(e(this))return!0;let t=!1;for(let i=0;i<this.getChildCount()&&!t;++i)t=this.getChildByIndex(i).walk(e);return t}getIdPath(){let e="",t=this;for(;t;)e.length>0&&(e="."+e),e=t.id+e,t=t.parent;return e}makeSceneDebugObject(e){const t=this.properties.debugId;let i="Node: "+(t||this.getId());this.properties.primitiveType!==s.PrimitiveType.PRIMITIVE_UNKNOWN&&(i+=" ",i+=this.properties.toString(!0));const n=[];n.push(this.properties.makeSceneDebugObject());const r=this.getBoundingBox();if(r&&n.push(r.makeSceneDebugObject()),this.isMeshNode()){const t=this.nodeOccurrences.getKeyValues();for(let i=0;i<t.length;i+=2)n.push(t[i+1].makeSceneDebugObject(e+1))}else for(let t=0;t<this.getChildCount();t++)n.push(this.getChildByIndex(t).makeSceneDebugObject(e+1));return{text:i,children:n,state:{opened:e<2}}}setVisible(e){if(this.getIsVisible()!==e){const t=this.properties.cloneAndModify({isVisible:e},!0);this.properties=t}}}},68822:function(e,t,i){i.d(t,{I:function(){return s}});class s{constructor(){this.rangeSet=null,this.index=0}resetForRangeSet(e){this.rangeSet=e,this.index=0}hasMoreRanges(){return!!this.rangeSet&&this.index<this.rangeSet.length}getNextRange(){return this.hasMoreRanges()?this.rangeSet[this.index++]:null}}},27261:function(e,t,i){if(i.d(t,{Gb:function(){return r},TS:function(){return o},bg:function(){return n},d8:function(){return a}}),666==i.j)var s=i(57792);class n{constructor(){this.attributeSettings=new s.N,this.floatUniformSettings=new s.N}copyFrom(e){this.attributeSettings.setAll(e.attributeSettings),this.floatUniformSettings.setAll(e.floatUniformSettings)}clone(){const e=new n;return e.copyFrom(this),e}clear(){this.attributeSettings.clear(),this.floatUniformSettings.clear()}equals(e){return!!e&&(this===e||!!r(this.attributeSettings,e.attributeSettings)&&!!r(this.floatUniformSettings,e.floatUniformSettings))}setAttribute(e,t){this.attributeSettings.set(e,t)}getAttribute(e){return this.attributeSettings.get(e)}setFloatUniform(e,t){this.floatUniformSettings.set(e,t)}applyStyle(e){const t=e.getActiveShader();if(!t)return;const i=this.attributeSettings.getKeyValues();for(let e=0;e<i.length;e+=2)t.setAttribute(i[e],i[e+1]);const s=this.floatUniformSettings.getKeyValues();for(let e=0;e<s.length;e+=2)t.setFloatUniform(s[e],s[e+1])}toString(){let e="Style: ";const t=this.attributeSettings.getKeyValues(),i=", ";for(let s=0;s<t.length;s+=2){const n=t[s],r=t[s+1];s>0&&(e+=i),e+=n.name+": "+r}t.length>0&&(e+=i);const s=this.floatUniformSettings.getKeyValues();for(let t=0;t<s.length;t+=2)t>0&&(e+=i),e+=s[t]+": "+s[t+1];return e}}function r(e,t){if(e.size!==t.size)return!1;const i=e.getKeyValues();for(let e=0;e<i.length;e+=2){const s=i[e],n=i[e+1],r=t.get(s);if(n!==r){if(void 0===r)return!1;if(void 0===n.length&&void 0===r.length)return!1;if(n.length!==r.length)return!1;for(let e=0;e<n.length;++e)if(n[e]!==r[e])return!1}}return!0}function a(e,t){return e&&t?e.equals(t):!(e||t)}function o(e,t,i){return e?t?(i.clear(),i.copyFrom(e),i.copyFrom(t),i):e:t}},7412:function(e,t,i){if(i.d(t,{q:function(){return r}}),666==i.j)var s=i(46560);if(666==i.j)var n=i(27261);class r extends(666==i.j?s.Y:null){constructor(e){super(),this.styleMergeStorage=[],this.currentStyleMergeStoragePointer=0;for(let t=0;t<e;++t)this.styleMergeStorage.push(new n.bg)}getStyleMergeStorage(){const e=this.styleMergeStorage[this.currentStyleMergeStoragePointer];return this.currentStyleMergeStoragePointer=(this.currentStyleMergeStoragePointer+1)%this.styleMergeStorage.length,e}}},1122:function(e,t,i){i.d(t,{C:function(){return S},O:function(){return E}});var s=i(82630),n=i(7037),r=i(94205),a=i(30108);if(666==i.j)var o=i(4644);var h=i(1190),c=i(97511),l=i(13265);if(666==i.j)var d=i(68100);if(666==i.j)var u=i(75920);if(666==i.j)var g=i(35589);var p=i(68434);if(666==i.j)var m=i(4889);if(666==i.j)var f=i(45065);var I=i(64880);class E extends(666==i.j?r.UIElement:null){constructor(e,t,i,s,n,a=1){super(n),this.normal=e,this.tangent=t,this.center=i,this.elementConnection=s,this.faceSize=a,this.isPreSelected=!1,this.isSelected=!1,this.isHiddenFromPick=!1,this.manipulator=null,this.inversePreManipulationMatrix=null,this.preManipulationCenter=null,this.preManipulationNormal=null,this.preManipulationTangent=null,this.inferredCenter=null,this.label=-1,this.isManipulatorRemovedOnDeselection=!0,this.editSubject=new m.x,this.listenTo(this,r.UiEvents.CLICK+o.s_,this.onClick),this.listenTo(this,r.UiEvents.MOUSE_ENTER+o.s_,this.onMouseEnter),this.listenTo(this,r.UiEvents.MOUSE_LEAVE+o.s_,this.onMouseLeave),this.listenTo(this,r.UiEvents.SELECT+o.s_,this.onSelect),this.listenTo(this,r.UiEvents.DESELECT+o.s_,this.onDeselect),this.listenTo(this,r.UiEvents.DOUBLE_CLICK+o.s_,this.onDoubleClick),this.center=d.clone(i),e.length<4?this.normal=u.fromValues(e[0],e[1],e[2],0):this.normal=u.clone(e),t.length<4?this.tangent=u.fromValues(t[0],t[1],t[2],0):this.tangent=u.clone(t)}getSelection(e,t){return new r.UISelection(this,o.s_,"")}getPickPriority(e){return r.PickPriority.SECTION_PLANE}shouldBeClearedWithSelections(){return!1}allowSelection(){const e=this.viewer.getModelViewManagers().getManager().hasActiveSketch(),t=!(0,r.isUsageBase)();return!o.X5&&!e&&!t}onClick(e,t,i){(0,a.Ky)().sectionPlaneToFocus=this,(0,a.Ky)().pickOnSectionPlaneToFocus=e.sourcePick,i.requestSelectedStatus=this.allowSelection()}onTriadDoubleClick(e,t){(0,a.Ky)()?.hasFaceEntities()||this.onDoubleClick(t)}onDoubleClick(e){(0,a.Ky)().sectionPlaneToFocus=this,(0,a.Ky)().pickOnSectionPlaneToFocus=e.sourcePick,(0,c.m)().trigger(l.C.EDIT_SECTION_VIEW)}onMouseEnter(){this.isPreSelected=this.allowSelection(),(0,r.requestDraw)()}onMouseLeave(){this.isPreSelected=!1,(0,r.requestDraw)()}isInteractionEnabled(){return this.allowSelection()}setupManipulator(e){e||(e=this.getSelection()),this.manipulator?this.checkAndCreateInferenceControllerIfNeeded():this.createManipulator(e)}onSelect(e){this.isSelected=!0,this.setupManipulator(e),(0,r.requestDraw)()}listenToManipulator(e){this.listenTo(e,s.w0.DOUBLE_CLICKED,this.onTriadDoubleClick),this.listenTo(e,s.w0.REPOSITION_START,this.onRepositionStart),this.listenTo(e,s.w0.REPOSITION_END,this.onRepositionEnd),this.listenTo(e,s.w0.ENTER_INFERENCE,this.onEnterInference),this.listenTo(e,s.w0.LEAVE_INFERENCE,this.onLeaveInference),this.listenTo(e,h.Wb.CLICKED,this.onManipulatorClicked),this.listenTo(e,s.w0.ROTATION_START,this.onRotationStart),this.listenTo(e,s.w0.ROTATION_CHANGE,this.onRotationChange),this.listenTo(e,s.w0.ROTATION_EDIT,this.onRotationEdit),this.listenTo(e,s.w0.ROTATION_END,this.onRotationEnd),this.listenTo(e,s.w0.TRANSLATION_START,this.onTranslationStart),this.listenTo(e,s.w0.TRANSLATION_CHANGE,this.onTranslationChange),this.listenTo(e,s.w0.TRANSLATION_EDIT,this.onTranslationEdit),this.listenTo(e,s.w0.TRANSLATION_END,this.onTranslationEnd),this.listenTo((0,I.vi)(),"reset",this.onDeselect)}createManipulator(e){let t=this.center;const i=e.sourcePick?e.sourcePick.location:null;if(i){const e=this.viewer.getCamera().getRay(i[0],i[1]),s=(0,r.intersectRayPlane)(e,this.getWorldSpacePlaneEquation());s&&(t=s)}this.manipulator=new r.Triad(this.viewer,h.Ak.PLANE,{displayEditView:!0}),this.manipulator.updateDefinition(this.getWorldSpaceMatrix(t)),this.viewer.getEventDispatcher().trigger(r.CREATE_SECTION_PLANE_INFERENCE_CONTROLLER,this.manipulator,this.elementConnection),this.listenToManipulator(this.manipulator),this.previewStateChangeSubscription=(0,r.getEditState)().stateChangedObservable.pipe((0,f.h)((e=>e===r.Events.PREVIEW_STATE_CHANGE))).subscribe((()=>this.onPreviewStateChange()))}onRepositionStart(){const e=this.checkAndCreateInferenceControllerIfNeeded();null!==e&&e.startInferencing(),this.preManipulationCenter=this.center,this.editSubject.next(!1)}checkAndCreateInferenceControllerIfNeeded(){const e=n._3.getOpenDocumentController();if(!e)return null;const t=e.getSectionPlaneInferenceControllerManager();return t&&t.activeManipulator!==this.manipulator?(this.viewer.getEventDispatcher().trigger(r.CREATE_SECTION_PLANE_INFERENCE_CONTROLLER,this.manipulator,this.elementConnection),t.activeController):null}onRepositionEnd(){this.inferredCenter?(this.center=this.inferredCenter,(0,a.P_)(!0)):this.manipulator.updateOrigin(this.preManipulationCenter),this.inferredCenter=null,this.editSubject.next(!0)}onEnterInference(e){this.inferredCenter=e}onLeaveInference(){this.inferredCenter=null}onPreviewStateChange(){(0,r.isUsageBase)()||this.onDeselect()}onDeselect(){this.manipulator&&(this.getIsManipulatorRemovedOnDeselection()?this.destroyManipulator():this.manipulator.removeEditViewAndHighlights()),this.isSelected=!1,(0,r.requestDraw)()}destroyManipulator(){this.manipulator&&(this.stopListening(this.manipulator),this.previewStateChangeSubscription.unsubscribe(),this.manipulator.remove(),this.manipulator=null,this.viewer.getEventDispatcher().trigger(r.DESTROY_SECTION_PLANE_INFERENCE_CONTROLLER))}getIsManipulatorRemovedOnDeselection(){return this.isManipulatorRemovedOnDeselection}setIsManipulatorRemovedOnDeselection(e){this.isManipulatorRemovedOnDeselection=e}rotationStart(e){this.preManipulationCenter=d.fromValues(this.center[0],this.center[1],this.center[2]),this.preManipulationNormal=u.fromValues(this.normal[0],this.normal[1],this.normal[2],0),this.preManipulationTangent=u.fromValues(this.tangent[0],this.tangent[1],this.tangent[2],0),this.inversePreManipulationMatrix=p.w$.inverse(e,g.create())}onManipulatorClicked(e){if(e instanceof r.Linear){const e=this.manipulator,t=g.clone(e.transform),i=0;e.processUpdateFromAngularManipulator(i,t,Math.PI),this.onRotationEdit(t);const s=e.linearManipulators[0];if(s){const e=s.initialRay;if(e){const t=p.S4.scale(e.direction,-1,d.create());s.initialRay=new r.Ray(e.point,t)}}}}onRotationStart(){this.rotationStart(this.manipulator.transform),this.editSubject.next(!1)}onRotationChange(){const e=p.w$.multiply(this.manipulator.transform,this.inversePreManipulationMatrix,g.create());this.center=p.w$.multiplyVec3(e,this.preManipulationCenter,d.create()),this.normal=p.w$.multiplyVec4(e,this.preManipulationNormal,u.create()),this.tangent=p.w$.multiplyVec4(e,this.preManipulationTangent,u.create()),(0,a.P_)(!0)}onRotationEdit(e){this.rotationStart(e),this.onRotationChange(),this.editSubject.next(!0)}onRotationEnd(){this.editSubject.next(!0)}equals(e){return(0,r.areVectorsEqual)(this.normal,e.normal)&&(0,r.areVectorsEqual)(this.tangent,e.tangent)&&(0,r.areVectorsEqual)(this.center,e.center)}onTranslationStart(){this.preManipulationCenter=d.fromValues(this.center[0],this.center[1],this.center[2]),this.editSubject.next(!1)}onTranslationChange(e){p.S4.add(this.preManipulationCenter,e,this.center),(0,a.P_)(!0)}onTranslationEdit(e){this.onTranslationStart(),this.onTranslationChange(e),this.editSubject.next(!0)}onTranslationEnd(){this.editSubject.next(!0)}onRemove(){this.onDeselect()}getWorldSpacePlaneEquation(){const e=d.dot(this.normal,this.center);return u.fromValues(this.normal[0],this.normal[1],this.normal[2],-e)}getWorldSpaceMatrix(e){const t=p.S4.cross(this.tangent,this.normal,d.create());return g.fromValues(this.tangent[0],this.tangent[1],this.tangent[2],0,t[0],t[1],t[2],0,-this.normal[0],-this.normal[1],-this.normal[2],0,e[0],e[1],e[2],1)}getCameraSpacePlaneEquation(e,t){const i=p.w$.multiplyVec4(e,this.normal,u.create()),s=d.dot(i,t);return u.fromValues(i[0],i[1],i[2],-s)}getCameraSpaceTangent(e){return p.w$.multiplyVec4(e,this.tangent,u.create())}getCameraSpaceCenter(e){return p.w$.multiplyVec3(e,this.center,d.create())}getPlaneMatrix(e){e||(e=g.create()),e[0]=this.tangent[0],e[1]=this.tangent[1],e[2]=this.tangent[2],e[3]=0;const t=d.create(),i=d.create();return p.S4.cross(this.normal,this.tangent,i),p.S4.normalize(i,t),e[4]=t[0],e[5]=t[1],e[6]=t[2],e[7]=0,e[8]=this.normal[0],e[9]=this.normal[1],e[10]=this.normal[2],e[11]=0,e[12]=this.center[0],e[13]=this.center[1],e[14]=this.center[2],e[15]=1,e}getViewManipulatorOrigin(e){return e||(e=d.create()),e[0]=this.manipulator?this.manipulator.transform[12]:this.center[0],e[1]=this.manipulator?this.manipulator.transform[13]:this.center[1],e[2]=this.manipulator?this.manipulator.transform[14]:this.center[2],e}getEditObservable(){return this.editSubject.asObservable()}isMeshIncrementCoplanar({points:e},t){const i=d.create();for(let s=0;s<e.length;s+=3)if(i[0]=e[s]-this.center[0],i[1]=e[s+1]-this.center[1],i[2]=e[s+2]-this.center[2],Math.abs(d.dot(i,this.normal))>t)return!1;return!0}}function S(e){const t=e.getUISelectionManager().getSelection();if(t&&t.selectionId===o.s_&&t.uiElement instanceof E&&(t.uiElement.isSelected||t.uiElement.isPreSelected))return t.uiElement}},30108:function(e,t,i){i.d(t,{aA:function(){return z},oj:function(){return G},cP:function(){return te},ny:function(){return Se},HX:function(){return ne},Lz:function(){return se},tz:function(){return ie},Ky:function(){return Z},nL:function(){return $},j1:function(){return H},tb:function(){return Ee},qT:function(){return ee},ti:function(){return Ae},WC:function(){return re},rv:function(){return Pe},OR:function(){return be},p$:function(){return xe},bm:function(){return Be},Mi:function(){return Re},eQ:function(){return Oe},Wh:function(){return _e},F6:function(){return ye},qf:function(){return ae},v5:function(){return Me},UB:function(){return Ce},X9:function(){return we},o_:function(){return ve},jf:function(){return de},Rb:function(){return Ue},rH:function(){return He},CF:function(){return W},hJ:function(){return Te},N3:function(){return De},P_:function(){return U},qS:function(){return ue},cV:function(){return me},fI:function(){return pe},le:function(){return ge}});var s=i(47061),n=i(32606),r=i(28892),a=i(60559),o=i(64880),h=i(14654),c=i(22681),l=i(65915),d=i(4644),u=i(1122),g=i(16522),p=i(11678),m=i(88155),f=i(36889),I=i(66023),E=i(35589),S=i(68100),T=i(75920),D=i(68434),C=i(97511),M=i(13265),y=i(4889),A=i(51962),P=i(94205),O=i(72372);const R=new P.NodeProperties({primitiveType:P.PrimitiveType.LINES,isPickable:!0,isHighlightable:!0,isTwoSided:!0,isShowThrough:!1,isVisible:!0,zOffset:n.default.getManager().getNumber("SECTION_EDGES_Z_OFFSET")}),w=new P.NodeProperties({primitiveType:P.PrimitiveType.POINTS,isPickable:!0,isHighlightable:!0,isTwoSided:!0,isShowThrough:!1,isVisible:!1,isSectionEntity:!0,zOffset:n.default.getManager().getNumber("SECTION_POINTS_Z_OFFSET")}),v=new P.NodeProperties({primitiveType:P.PrimitiveType.TRIANGLE_STRIP,isPickable:!0,isHighlightable:!0,isVisible:!0,zOffset:n.default.getManager().getNumber("PART_FACES_Z_OFFSET"),pickZOffset:n.default.getManager().getNumber("SECTION_FACES_Z_OFFSET")});let _=null;function N(){return null===_&&(_=new Map([[P.PrimitiveType.LINES,{nodeProperties:R,entityType:c.ZSW.EDGE,pickPriority:P.PickPriority.PART_EDGE}],[P.PrimitiveType.POINTS,{nodeProperties:w,entityType:c.ZSW.VERTEX,pickPriority:P.PickPriority.PART_VERTEX}],[P.PrimitiveType.TRIANGLE_STRIP,{nodeProperties:v,entityType:c.ZSW.FACE,pickPriority:P.PickPriority.PART_FACE}]])),_}class b extends P.UIElement{constructor(e,t,i){super(i),this.elementId=e,this.state=t,this.incrementData=new Map,this.hasFace=!1,this.isCleaningUp=!1,this.selectedEntities=new Set,this.preselectedEntities=new Set,this.secondarySelectedEntities=new Set,this.sectionPlaneSelections=[],this.selectionLists={selection:(0,o.vi)(),preselection:(0,o.Wf)(),secondary:(0,o.wT)()},this.initializePlaneSelectionCounts(),this.listenToSelectionLists(),this.listenTo(this.viewer.getIsolatedOccurrenceManager(),P.IsolatedOccurrencesManager.IS_ISOLATE_FULLY_TRANSPARENT_CHANGED_EVENT,this.updateEntityVisibility)}initializePlaneSelectionCounts(){for(const e of this.state.getSectionPlanes())this.sectionPlaneSelections.push(0)}incrementPlaneSelectionCount(e,t){const i=this.sectionPlaneSelections[e];if(0===i){const i=this.state.getSectionPlanes()[e];i?.onDeselect(),i?.setupManipulator(t)}this.sectionPlaneSelections[e]=i+1}decrementPlaneSelectionCount(e){const t=this.sectionPlaneSelections[e],i=Math.max(0,t-1);if(this.sectionPlaneSelections[e]=i,0===i){const t=this.state.getSectionPlanes()[e];t?.onDeselect()}}getHighlightType(e){return e===this.selectionLists.preselection?P.HighlightType.PRE:e===this.selectionLists.secondary?P.HighlightType.SECONDARY:P.HighlightType.ENTITY}getSelectedSetFromSelectionList(e){return e===this.selectionLists.preselection?this.preselectedEntities:e===this.selectionLists.secondary?this.secondarySelectedEntities:this.selectedEntities}findAssociatedPlaneIndex(e){const t=this.state.getSectionPlanes();let i=-1;return t.forEach(((t,s)=>{t.isMeshIncrementCoplanar(e,1e-5)&&(i=s)})),i}getSelectedFaceEntityForAlignment(){for(const e of this.preselectedEntities)return e;for(const e of this.selectedEntities)return e;return null}onSelectFace(e,t,i){this.getSelectedSetFromSelectionList(i).add(e),this.isCleaningUp||i===this.selectionLists.selection&&this.incrementPlaneSelectionCount(e.associatedPlaneIndex,t)}onDeselectFace(e,t){this.getSelectedSetFromSelectionList(t).delete(e),this.isCleaningUp||t===this.selectionLists.selection&&this.decrementPlaneSelectionCount(e.associatedPlaneIndex)}handleChangeSelectionList({list:e,selection:t,doAdd:i,doDraw:s=!0}){if(!t.isSectionEntity())return;const n=t.getIdString(),r=this.getHighlightType(e),a=this.addHighlightToSection(r,n);i?a?.entityType===c.ZSW.FACE&&this.onSelectFace(a,t,e):(a?.entityType===c.ZSW.FACE&&this.onDeselectFace(a,e),this.removeHighlightFromSection(r,n)),s&&this.viewer.requestDraw()}clearHighlightsOfType(e){for(const t of this.incrementData.values()){const i=t.highlights.get(e);void 0!==i&&(this.removeHighlightFromIncrement(t.incrementId,i),t.highlights.delete(e))}}handleResetSelectionList(e){const t=this.getHighlightType(e);this.clearHighlightsOfType(t);if(this.getSelectedSetFromSelectionList(e).clear(),e===this.selectionLists.selection)for(let e=0;e<this.sectionPlaneSelections.length;e+=1)this.sectionPlaneSelections[e]=0;e.forEach((t=>{this.handleChangeSelectionList({list:e,selection:t,doAdd:!0,doDraw:!1})})),this.viewer.requestDraw()}listenForChangesToSelectionList(e){this.listenTo(e,"add",(t=>{this.handleChangeSelectionList({list:e,selection:t,doAdd:!0})})),this.listenTo(e,"remove",(t=>{this.handleChangeSelectionList({list:e,selection:t,doAdd:!1})})),this.listenTo(e,"reset",(()=>{this.handleResetSelectionList(e)}))}listenToSelectionLists(){this.listenForChangesToSelectionList(this.selectionLists.preselection),this.listenForChangesToSelectionList(this.selectionLists.selection),this.listenForChangesToSelectionList(this.selectionLists.secondary)}getBodyId(e,t){return e.occurrenceList[t]?.getPathAsString()??e.partIds[t]}getFullId(e,t){const i=this.getBodyId(e,t);return`${c.FBt.SECTION_IDENTIFIER}-${i}`}getEntityTypeFromPrimitiveType(e){return N().get(e)?.entityType??c.ZSW.UNKNOWN}getColor(e){const t=this.viewer.getModelViewManagers().getManager();return e.occurrence?t.getOccurrenceColor(e.occurrence):e.partId?t.getPartColor(e.partId):null}isDebugSectionEntitiesDisplay(){return O.Jq.CapabilitiesService.checkDebugCurrentlyEnabled()&&Boolean(JSON.parse(localStorage.getItem("debugSectionEntitiesDisplay")))}populate(e){const t=this.isDebugSectionEntitiesDisplay();e.entities.forEach(((i,s)=>{const r=this.getFullId(e,s);i.forEach(((i,a)=>{i.tessellation.forEach(((i,o)=>{const h=(0,P.createMeshIncrementForEntityData)(i),l=`${c.FBt.ID}${s}-${a}-${o}`;if(t){const e=n.default.getManager().getColor("CPP_RED");(0,P.addColorToIncrement)(e,h)}const d=`${c.FBt.ID}${a}-${o}`,u=`${r}-${d}`,g=N().get(h.primitiveType)?.nodeProperties;if(g){const t={incrementId:l,selectionId:u,primitiveType:g.primitiveType,entityType:this.getEntityTypeFromPrimitiveType(g.primitiveType),highlights:new Map,occurrence:e.occurrenceList[s],partId:e.partIds[s],metadata:this.createEntityMetadata(l,i),meshIncrement:h};if(t.entityType===c.ZSW.FACE){const e=this.findAssociatedPlaneIndex(h);-1!==e&&(t.associatedPlaneIndex=e);const i=this.getColor(t);this.hasFace=!0,i&&(0,P.addColorToIncrement)(i,h)}this.incrementData.set(u,t),this.updateMeshIncrement(l,u,h,g)}}))}))})),this.updateEntityVisibility()}hasFaceEntities(){return this.hasFace}createEntityMetadata(e,t){const i=new c.kdl;return i.setBodyId(e),i.setGeometry(t),i}getMeshIncrementForUISelection(e){const t=this.getInstantiatedMeshIncrement(e.meshIncrementId);return t?.meshIncrement??null}getPickPriority(e){const t=this.getMeshIncrementForUISelection(e);let i=null;return t&&(i=N().get(t.primitiveType)?.pickPriority),i??P.PickPriority.UNKNOWN}getModelSelection(e){const t=new o.Y1(c.lQt.ENTITY,e.selectionId,(0,r._R)()?new c._oC:null,{sourcePick:e.sourcePick}),i=this.findIncrementData(e.selectionId);return i&&(t.setNameFromSectionDetails({entityType:i.entityType,partId:i.partId,occurrence:i.occurrence,elementId:this.elementId}),t.entityMetaData=i.metadata),t}getEntityMetaData(e){return this.findIncrementData(e)?.metadata??null}findIncrementData(e){return this.incrementData.get(e)??null}addHighlightToSection(e,t){const i=this.viewer.getHighlightManager(P.BTGraphicsUsage.BASE).createHighlightForSelection(e,t),s=this.findIncrementData(t);return s?(s.highlights.has(e)&&(this.removeHighlightFromIncrement(s.incrementId,s.highlights.get(e)),s.highlights.delete(e)),this.addHighlightToIncrement(s.incrementId,i),s.highlights.set(e,i),s):null}removeHighlightFromSection(e,t){const i=this.findIncrementData(t);i&&this.removeHighlightFromIncrementData(e,i)}removeHighlightFromIncrementData(e,t){const i=t.highlights.get(e);i&&(this.removeHighlightFromIncrement(t.incrementId,i),t.highlights.delete(e))}clearSelections(e){const t=e.filter((e=>e?.isSectionEntity()));e.remove(t)}remove(){this.isCleaningUp=!0,this.clearSelections((0,o.Wf)()),this.clearSelections((0,o.vi)()),super.remove()}onIsolateChanged(){this.updateEntityVisibility()}updateEntityVisibility(){const e=this.viewer.getModelViewManagers().getManager(),t=this.viewer.getIsolatedOccurrenceManager()?.isInIsolateOrMakeTransparentMode(),i=this.viewer.getIsolatedOccurrenceManager()?.getIsIsolateFullyTransparent();for(const s of this.incrementData.values()){let n;if(s.occurrence){const e=this.viewer.getOccurrenceIdManager().getIdForName(s.occurrence.toString());n=this.viewer.getOccurrenceDataManager().getOccurrenceData(e)}else{const t=e.getDisplayedPartStudio();t&&(n=t.getBodyComponent().getBodyOccurrenceData(s.partId))}t&&n&&i&&!n.getIsolated()?this.hideIncrement(s.incrementId):this.showIncrement(s.incrementId)}}extractMeshIncrement(e){const t=this.findIncrementData(e);return t?.meshIncrement??null}}var L=i(7037);const F=a.O.createLogger("sectionplane_helpers",c.bVy.GRAPHICS),x=n.default.getManager();let B=!1,V=0;function U(e){B=e}function H(){return 3}var G;!function(e){e[e.Excluded=0]="Excluded",e[e.Included=1]="Included"}(G||(G={}));let k=!1;function W(e){k=e,Z()?.setEntitiesEnabled(k)}class z extends s.T{constructor(e=!0){super(),this.sectionPlanes=[],this.sectionedItems=[null,null],this.currentSectionedItemType=G.Excluded,this.isListening=!1,this.elementId="",this.eligibleCompositeParts=[new Set,new Set],this.areEntitiesEnabled=!1,this.entitiesElement=null,this.isRequestingEntities=!1,this.editSubject=new y.x,this.planeEditSubscriptions=new Map,this.hasVisibilityUpdate=!1,e&&this.setEntitiesEnabled(k)}isNotEmpty(){return this.sectionPlanes.length>0||this.sectionedItems[G.Excluded]?.selections.length>0||this.sectionedItems[G.Included]?.selections.length>0}setupListeners(){this.isListening=!0,this.listenTo((0,l.xA)(),l.CD,this.onPartStudioDisplayDataChanged),this.listenTo((0,l.xA)(),l.sJ,this.onPartVisibilityChanged),this.listenTo((0,l.xA)(),l.hj,this.onAssemblyDataProcessed),this.listenTo((0,C.m)(),M.C.EXIT_EDIT_INCONTEXT,this.removeAssemblyParts)}stopListening(e,t,i){this.isListening&&(super.stopListening(e,t,i),this.isListening=!1)}updateEntitiesIfEnabled(){this.areEntitiesEnabled&&this.updateEntities((0,m.uQ)(),this.getElementConnection())}updateEntitiesIfMicroversionChanged(e){e.to.deepEquals(e.from)?this.entitiesElement?.hide():this.updateEntitiesIfEnabled()}onPartStudioDisplayDataChanged(e){this.setAllOccurrencesClippedExceptSelectedOnes(this.getIsExcludingItemsForSection()),(e.hasPartGeometryChanges()||this.hasVisibilityUpdate)&&(this.updateEntitiesIfMicroversionChanged(e.microversionIdAndConfigurationInterval),this.hasVisibilityUpdate=!1)}onPartVisibilityChanged(){this.hasVisibilityUpdate=!0,this.clearEntities()}onAssemblyDataProcessed(e){this.removeDeletedOccurrencesFromSectionedItems(e),this.setAllOccurrencesClippedExceptSelectedOnes(this.getIsExcludingItemsForSection());const t=e.occurrences.length,i=e.deletedOccurrences.length;(t>0||i>0)&&this.updateEntitiesIfMicroversionChanged(e.microversionIdAndConfigurationInterval)}removeDeletedOccurrencesFromSectionedItems(e){if(0===e.deletedOccurrences.length)return;const t=this.getSectionedItems();if(t&&t.length>0){const i=new Set(e.deletedOccurrences.map((e=>e.getPathAsString())));t.reset(t.filter((e=>!i.has(e.getOccurrence()?.getPathAsString()))))}}setAllOccurrencesClippedExceptSelectedOnes(e){const t=(0,m.uQ)(),i=t.getModelViewManagers().getManager(),s=(0,r._R)()?i.getDisplayedAssembly():i.getDisplayedInContextAssembly();if(s){const t=this.getSectionedItemsAsSetOfOccurrencePaths();s.setAreOccurrencesClippedBySectionPlaneExcept(e,t)}if((0,r._B)()){const s=!0,n=this.getSectionedItemsAsSetOfBodyIds(s),r=i.getDisplayedPartStudio();if(r&&r.getBodyComponent().setAreOccurrencesClippedBySectionPlaneExcept(e,n),t.getModelViewManagers().previewManagerExists()){const i=t.getModelViewManagers().getPreviewManager().getDisplayedPartStudio();i&&i.getBodyComponent().setAreOccurrencesClippedBySectionPlaneExcept(e,n)}}}getIsExcludingItemsForSection(){return this.currentSectionedItemType===G.Excluded}getCurrentSectionedItemType(){return this.currentSectionedItemType}getElementConnection(){return L._3.getOpenDocumentController().elementConnection}onSectionPlaneEdit(e,t){if(this.editSubject.next({plane:e,isValidForEntities:t}),this.areEntitiesEnabled)if(t){const e=(0,m.uQ)(),t=this.getElementConnection();this.updateEntities(e,t)}else this.clearEntities()}setIsExcludingItemsForSection(e){this.currentSectionedItemType=e?G.Excluded:G.Included,B=!0,this.setAllOccurrencesClippedExceptSelectedOnes(e);(0,m.uQ)().requestDraw()}getSectionPlanes(){return this.sectionPlanes}clearSectionPlanes(){this.sectionPlanes=[],this.clearEntities()}addSectionPlane(e){this.sectionPlanes.push(e);const t=e.getEditObservable().subscribe((t=>{this.onSectionPlaneEdit(e,t)}));this.planeEditSubscriptions.set(e,t),this.onSectionPlaneEdit(e,!0)}removeSectionPlane(e){this.onSectionPlaneEdit(e,!0),this.sectionPlanes=this.sectionPlanes.filter((t=>t!==e));const t=this.planeEditSubscriptions.get(e);t&&(t.unsubscribe(),this.planeEditSubscriptions.delete(e))}getEditObservable(){return this.editSubject.asObservable()}destroySectionedItems(){this.currentSectionedItemType=G.Excluded,this.sectionedItems.forEach((e=>{e&&e.destroy()})),this.stopListening(),this.sectionedItems=[null,null],this.eligibleCompositeParts.forEach((e=>e.clear())),this.elementId=""}setElementId(e,t){this.elementId!==e&&(""!==this.elementId&&this.destroySectionedItems(),this.elementId=e,this.sectionedItems[G.Excluded]=new h.w(e),this.sectionedItems[G.Included]=new h.w(e),t&&this.setupListeners())}getElementId(){return this.elementId}setIsItemClipped(e,t){if(!e)return;const i=(0,m.uQ)(),s=i.getModelViewManagers().getManager(),n=(0,r._R)()?s.getDisplayedAssembly():s.getDisplayedInContextAssembly();let a=!1;if(n){const i=e.getOccurrence();i&&(n.setAllLeafOccurrencesClippedForOccurrence(i,t),a=!0)}(0,r._B)()&&!a&&s.getDisplayedPartStudio().getBodyComponent().setIsBodyClippedBySectionPlane(e.getBodyId(),t,!1,this.getHasEligibleCompositeParts()?this.getSectionedItemsAsSetOfBodyIds():null),i.requestDraw()}getHasEligibleCompositeParts(e){return e=e??this.currentSectionedItemType,this.eligibleCompositeParts[e].size>0}addSectionedItem(e,t){""!==this.getElementId()?(null==t&&(t=this.currentSectionedItemType),this.getSectionedItems(t)?.add(e),t===this.currentSectionedItemType&&this.setIsItemClipped(e,!this.getIsExcludingItemsForSection()),e.getBodyMetaData()?.isNonGroupingCompositeBody&&this.eligibleCompositeParts[t].add(e.getBodyId()),B=!0):F.warn("SectionViewState.addSectionedItem used without initializing via setElementId")}removeSectionedItem(e,t){if(""===this.getElementId())return void F.warn("SectionViewState.removeSectionedItem used without initializing via setElementId");null==t&&(t=this.currentSectionedItemType);const i=this.getSectionedItems(t)?.remove(e);i&&(t===this.currentSectionedItemType&&this.setIsItemClipped(e,this.getIsExcludingItemsForSection()),e.getBodyMetaData()?.isNonGroupingCompositeBody&&this.eligibleCompositeParts[t].delete(e.getBodyId()),B=!0)}getSectionedItems(e){return""===this.getElementId()?(F.error("SectionViewState.getSectionedItems used without initializing via setElementId"),null):(null==e&&(e=this.currentSectionedItemType),this.sectionedItems[e]?this.sectionedItems[e].selections:null)}getSectionedItemsAsSetOfBodyIds(e){const t=new Set,i=this.getSectionedItems();return i&&i.forEach((i=>{!i||e&&i.getOccurrence()||t.add(i.getBodyId())})),t}getSectionedItemsAsSetOfOccurrencePaths(){const e=new Set,t=this.getSectionedItems();return t&&t.forEach((t=>{const i=t.getOccurrence();i&&e.add(i.getPathAsString())})),e}resetSectionedItems(e,t){if(""===this.getElementId())return void F.warn("SectionViewState.resetSectionedItems used without initializing via setElementId");const i=new o.nZ("newSelectionList",e),s=this.getSectionedItems(t);for(let e=s.length-1;e>=0;--e){const n=s.at(e);i.has(n)||this.removeSectionedItem(n,t)}i.forEach((e=>{s.has(e)||this.addSectionedItem(e,t)}))}destroy(){this.clearEntities(),Ce(!1),this.destroySectionedItems()}static copy(e,t,i){if(e&&t){t.sectionPlanes=[];for(const i of e.sectionPlanes)t.addSectionPlane(i);t.currentSectionedItemType=e.currentSectionedItemType,""!==e.getElementId()&&(t.elementId="",t.setElementId(e.getElementId(),i),t.getSectionedItems(G.Excluded)?.reset(e.getSectionedItems(G.Excluded).toArray()),t.getSectionedItems(G.Included)?.reset(e.getSectionedItems(G.Included).toArray()),t.eligibleCompositeParts[G.Excluded]=new Set(e.eligibleCompositeParts[G.Excluded]),t.eligibleCompositeParts[G.Included]=new Set(e.eligibleCompositeParts[G.Included]))}}clone(e){const t=new z;return z.copy(this,t,e),t}setFrom(e,t){if(!e)return!1;z.copy(e,this,t);const i=this.sectionPlanes.length>0;return i&&(B=!0,this.sectionPlanes.forEach((function(e){e.viewer.getEventDispatcher().trigger(l.Sr,e)}))),i}getSectionedItemsSize(e){return""===this.getElementId()?(F.warn("SectionViewState.getSectionedItemsSize used without initializing via setElementId"),0):this.getSectionedItems(e)?.length??0}removeAssemblyParts(){const e=[],t=t=>{t.occurrence&&e.push(t)};this.sectionedItems[G.Excluded].selections.forEach(t),this.sectionedItems[G.Included].selections.forEach(t),e.forEach((e=>this.removeSectionedItem(e)))}getSerializedSectionPlanes(){return this.getSectionPlanes().map((e=>{const t=new c.hPA;return t.center.updateFromArray(e.center),t.normal.updateFromArray(e.normal),t.tangent.updateFromArray(e.tangent),t}))}clearEntities(){this.setEntitiesElement(null),this.isRequestingEntities=!1}disableEntities(){this.clearEntities(),this.areEntitiesEnabled=!1}updateEntities(e,t){this.areEntitiesEnabled&&this.clearEntities(),this.generateEntities(e,t)}enableEntities(e=!1){const t=(0,m.uQ)(),i=this.getElementConnection();this.areEntitiesEnabled?e&&this.updateEntities(t,i):(this.areEntitiesEnabled=!0,this.generateEntities(t,i))}setEntitiesEnabled(e,t=!1){e?this.enableEntities(t):this.disableEntities()}setEntitiesElement(e){this.entitiesElement?.remove(),this.entitiesElement=e}generateEntities(e,t){if(this.entitiesElement)return;const i=new c.Nsz;if(i.elementId=this.elementId,i.sectionPlanes=this.getSerializedSectionPlanes(),i.currentSectionedItemType=this.getCurrentSectionedItemType(),0===i.sectionPlanes.length)return;const s=[],n=[];this.getSectionedItems()?.forEach((e=>{let t=e.getOccurrence();if(t?.isAssemblyRoot()&&(t=new c._oC),t)return void s.push(t);const i=e.getPartId();i&&n.push(i)})),i.selectedItems=s,i.partIds=n;const r=performance.now(),a=new A.e("sectionplane_helpers.SectionViewState.generateEntities");a.setImportant(i18n("Generating entities")),t.callAndPromiseWithFeedback(i,a).then((t=>{if(!(t instanceof c.FBt))return;if(!this.areEntitiesEnabled||!this.isRequestingEntities)return;const i=performance.now()-r,s=t.occurrenceList.length+t.partIds.length;F.debug(`Toggle section entities time taken ${i}ms. Number of bodies=${s}`),this.setEntitiesElement(new b(this.elementId,this,e)),this.entitiesElement.populate(t)})).catch((e=>{F.error(e),this.clearEntities()})),this.isRequestingEntities=!0}hasEntities(){return!!this.entitiesElement}hasFaceEntities(){return this.entitiesElement?.hasFaceEntities()??!1}getSelectedFaceEntityForAlignment(){return this.entitiesElement?.getSelectedFaceEntityForAlignment()??null}extractMeshIncrement(e){return this.entitiesElement?.extractMeshIncrement(e)??null}getEntityMetaData(e){return this.entitiesElement?.getEntityMetaData(e)??null}}const X=new z(!1);function Z(){return X}const q=E.create(),Y=E.create(),K=E.create();let j=[];const Q=function(){j=$()};function $(){const e=[];return X.getSectionPlanes().forEach((function(t){const i={};i.center=S.clone(t.center),i.tangent=T.clone(t.tangent),i.normal=T.clone(t.normal),e.push(i)})),e}const J=function(e,t){if(!t&&V===e.getFrameId())return;let i,s;const n=X.getSectionPlanes();for(i=0;i<n.length;++i){const t=n[i].getCameraSpaceCenter(e.modelViewMatrix),r=n[i].getCameraSpacePlaneEquation(e.modelViewMatrix,t),a=n[i].getCameraSpaceTangent(e.modelViewMatrix);for(s=0;s<4;++s)q[4*s+i]=r[s],K[4*s+i]=a[s];for(s=0;s<3;++s)Y[4*s+i]=t[s]}t||(V=e.getFrameId())};function ee(e){let t=-1,i=-1;return X.getSectionPlanes().forEach((function(s,n){!1!==e&&s.isPreSelected?t=-1===t?n:-2:s.isSelected&&(i=-1===i?n:-2)})),t>-1?t:i>-1?i:-1}function te(){const e=X.getSectionPlanes();for(let t=0;t<e.length;t++){const i=e[t];if(i.isSelected||i.isPreSelected)return!0}return!1}function ie(e){const t=X.getSectionPlanes();return(e<0||e>=t.length)&&F.warn("attempting to retrieve a section plane with an invalid index"),t[e]}function se(e,t){X.getSectionPlanes().forEach(e,t)}function ne(e,t){return X.getSectionPlanes().filter(e,t)}function re(){const e=[];return X.getSectionPlanes().forEach((function(t){e.push(t.graphicsOccurrenceId)})),e}function ae(){V=-1}const oe=x.getNumber("SECTION_PLANE_ENDCAP_ORTHOGRAPHIC_Z_FIGHTING_FACTOR"),he=x.getNumber("SECTION_PLANE_ENDCAP_PERSPECTIVE_Z_FIGHTING_FACTOR"),ce=x.getNumber("SECTION_PLANE_INTER_ENDCAP_Z_FIGHTING_FACTOR");let le=!1;function de(e){le=e}function ue(e,t,i){const s=e.getRenderContext(),n=s.getActiveShader(),r=X.getSectionPlanes();if(!t||!e.areSectionPlanesEnabled()||0===r.length)return void n.uniform1f("uSectionPlaneCount",0);J(s,i),n.uniformMatrix4fv("uSectionPlaneEquations",!1,q),n.uniform1f("uSectionPlaneCount",r.length);const a=s.getActiveCamera(),o=a.getFarDepth()-a.getNearDepth(),h=o*(a.isOrthographic()?oe:he),c=o*ce;n.uniform1f("uEndcapZFightingThreshold",h),n.uniform1f("uInterEndcapZFightingThreshold",c),n.uniform1f("uUseOccurrenceIdForHatchOffset",le?0:1)}function ge(e,t){const i=X.getSectionPlanes();if(t<0||i.length<=t)return;const s=e.getActiveShader();s.uniformMatrix4fv("uSectionPlaneCenters",!1,Y),s.uniformMatrix4fv("uSectionPlaneTangents",!1,K)}function pe(e,t){const i=X.getSectionPlanes();if(t<0||i.length<=t)return;const s=i[t],n=e.getActiveShader();n.uniform1f("uOccurrenceId",s.graphicsOccurrenceId);const r=[0,0,0,0];for(let e=0;e<i.length;++e)r[e]=i[e].isHiddenFromPick?1:0;n.uniform4fv("uSectionPlaneIsHiddenFromPick",r)}function me(e,t){const i=X.getSectionPlanes();if(t<0||i.length<=t)return;const s=i[t],n=e.getActiveShader();n.uniform1f("uSectionPlaneIsPreSelected",s.isPreSelected?1:0),n.uniform1f("uSectionPlaneIsSelected",s.isSelected?1:0),n.uniform4fv("uSectionPlanePreSelectColor",x.getColor("SECTION_PLANE_PRE_HIGHLIGHT_COLOR")),n.uniform4fv("uSectionPlaneSelectColor",x.getColor("ENTITY_HIGHLIGHT_COLOR1")),n.uniform4fv("uSectionPlaneIntersectingColor",x.getColor("SECTION_PLANE_INTERSECTING_COLOR"));const r=x.getColor("SECTION_PLANE_SELECTOR_COLOR_0"),a=x.getColor("SECTION_PLANE_SELECTOR_COLOR_1"),o=x.getColor("SECTION_PLANE_SELECTOR_COLOR_2"),h=x.getColor("SECTION_PLANE_SELECTOR_COLOR_3");n.uniformMatrix4fv("uSectionPlaneSelectorColor",!1,E.fromValues(r[0],a[0],o[0],h[0],r[1],a[1],o[1],h[1],r[2],a[2],o[2],h[2],r[3],a[3],o[3],h[3]));const l=e.getActiveCamera();if(l.isPerspective()){const e=l.getSceneBounds().diameter(),t=(l.distanceToCenter()+.5*e)/l.getViewportHeight();n.uniform1f("uSectionPlanePatternScale",t*x.getNumber("SECTION_PLANE_PERSPECTIVE_PATTERN_SCALE"))}else{const e=1/(l.projectionMatrix[5]*l.getViewportHeight());n.uniform1f("uSectionPlanePatternScale",e*x.getNumber("SECTION_PLANE_ORTHOGRAPHIC_PATTERN_SCALE"))}n.uniform1f("uSectionPlanePatternFade",x.getNumber("SECTION_PLANE_PATTERN_FADE")),n.uniform1f("uSectionPlanePatternThickness",x.getNumber("SECTION_PLANE_PATTERN_THICKNESS")),n.uniform1f("uSectionPlanePatternPacingVariation",x.getNumber("SECTION_PLANE_PATTERN_PACING_VARIATION"));let d=0,u=1;switch(e.renderingMode){case c.P1.HIDDEN_LINE_REMOVED:case c.P1.HIDDEN_LINE_VISIBLE:case c.P1.WIREFRAME:case c.P1.CURVATURE_VISUALIZATION:d=1;break;case c.P1.TRANSLUCENT:u=x.getNumber("TRANSLUCENT_PASS_ALPHA")}n.uniform1f("uSectionPlanePatternIsBlackAndWhite",d),n.uniform1f("uSectionPlaneEndcapAlpha",u),n.uniform1f("uSectionPlaneIsolateContextOpacity",x.getNumber("ISOLATE_CONTEXT_FACE_TRANSPARENCY")),n.uniform1f("uSectionPlaneIntersectingAdditionalAlpha",x.getNumber("SECTION_PLANE_INTERSECTING_ADDITIONAL_ALPHA"))}const fe=function(e){X.getSectionPlanes().length<3?(X.addSectionPlane(e),B=!0,e.viewer.getEventDispatcher().trigger(l.Sr,e)):e.viewer.getEventDispatcher().trigger(l.F5)},Ie=function(e,t){if(X.getSectionPlanes().length<3){fe(e);const i=new g.i(e,d.s_,"");i.sourcePick=t;e.viewer.getUISelectionManager().setSelection(i)}else e.viewer.getEventDispatcher().trigger(l.F5)};function Ee(){return j}function Se(){j=[]}function Te(e,t,i,s){const n=s.getModelViewManagers().getManager().getMateConnectorGraphics(e,t);if(!n)return;const r=S.clone(n.worldSpacePosition),a=D.w$.multiplyVec4(n.transform,T.fromValues(0,0,1,0),T.create());D.jA.negate(a),D.Jb.normalize(a);const o=D.w$.multiplyVec4(n.transform,T.fromValues(1,0,0,0),T.create());D.Jb.normalize(o),Ie(new u.O(a,o,r,i,s))}function De(e,t,i,s,n){if(!t||s||!i)return;const r=T.fromValues(t[8],t[9],t[10],0),a=T.fromValues(t[0],t[1],t[2],0),o=S.fromValues(t[12],t[13],t[14]),h=S.dot(r,o)-S.dot(i.center(),r),c=D.S4.add(i.center(),D.S4.scale(r,h,S.create()),S.create()),l=(0,p.HB)().getCamera();S.dot(l.direction,r)<0&&(D.S4.negate(r),D.S4.negate(a)),Ie(new u.O(r,a,c,n,e,i.diameter()))}function Ce(e){e?Q():j=[],X.getSectionPlanes().forEach((function(e){Me(e)})),X.clearSectionPlanes(),B=!0}function Me(e){X.removeSectionPlane(e),e.onRemove(),B=!0,e.viewer.getEventDispatcher().trigger(l.zK,e)}function ye(e,t,i,s){Ce(!1),e.forEach((function(e){const n=new u.O(e.normal,e.tangent,e.center,t,i);Z().sectionPlaneToFocus&&Z().sectionPlaneToFocus.equals(n)?(Z().sectionPlaneToFocus=n,Ie(n,Z().pickOnSectionPlaneToFocus)):(fe(n),s&&n.setupManipulator())}))}function Ae(){return X.getSectionPlanes().length}function Pe(){return X.getSectionedItemsSize()}function Oe(){return!(0,f.isEmptyObjectOrArray)(X.getSectionPlanes())}function Re(e){X.getSectionPlanes().forEach((function(t){t.graphicsOccurrenceId===e&&(t.isHiddenFromPick=!0)}))}function we(){X.getSectionPlanes().forEach((function(e){e.isHiddenFromPick=!1}))}function ve(e){if(e!==X.getElementId())return new z(!1);const t=X.clone(!1);return X.destroy(),t}function _e(e,t){if(t!==e.getElementId())return!1;X.destroy();return X.setFrom(e,!0)}let Ne=new c.tS4;function be(){const e=[];return Le(e),e}function Le(e){X.getSerializedSectionPlanes().forEach((t=>{e.push(t)}))}function Fe(){Ne=Ne.clone(),Ne.sectionPlanes=[],Le(Ne.sectionPlanes),Ne.isExcluding=X.getIsExcludingItemsForSection();const e=X.getElementId();return Ne.elementId=e,e.length>0}function xe(){return B&&(Fe()&&Ve(Ne,!1),B=!1),Ne}function Be(){let e=null;return B&&Fe()&&(e=Ve(Ne,!0))?e.then((()=>(B=!1,Ne))):(B=!1,Promise.resolve(Ne))}function Ve(e,t){return t?new Promise((t=>{const i=(0,I.ZU)(X.getSectionedItems(G.Excluded).toArray()),s=(0,I.ZU)(X.getSectionedItems(G.Included).toArray());Promise.all([i,s]).then((i=>{e.selectionsToExclude=i[0],e.selectionsToInclude=i[1],t()}))})):(e.selectionsToExclude=(0,I.xX)(X.getSectionedItems(G.Excluded).toArray()),e.selectionsToInclude=(0,I.xX)(X.getSectionedItems(G.Included).toArray()),null)}function Ue(e,t,i){let s;const n=X.getSectionPlanes();if(e.length===n.length&&e.length>0)for(B=!0,s=0;s<e.length;s++)n[s].center=S.fromValues(e[s].center.x,e[s].center.y,e[s].center.z),n[s].normal=T.fromValues(e[s].normal.x,e[s].normal.y,e[s].normal.z,0),n[s].tangent=T.fromValues(e[s].tangent.x,e[s].tangent.y,e[s].tangent.z,0);else for(n.length>0&&Ce(!1),s=0;s<e.length;s++){const n=S.fromValues(e[s].center.x,e[s].center.y,e[s].center.z),r=T.fromValues(e[s].normal.x,e[s].normal.y,e[s].normal.z,0),a=T.fromValues(e[s].tangent.x,e[s].tangent.y,e[s].tangent.z,0);fe(new u.O(r,a,n,t,i))}}function He(e,t,i){Ue(e.sectionPlanes,t,i),function(e,t){const i=X.getElementId();!e||""===e.elementId||""!==i&&e.elementId!==i||(X.setElementId(e.elementId,!0),X.setIsExcludingItemsForSection(e.isExcluding),(0,I.rP)(e.selectionsToExclude,t).then((e=>{X.resetSectionedItems(e,G.Excluded)})),(0,I.rP)(e.selectionsToInclude,t).then((e=>{X.resetSectionedItems(e,G.Included)})))}(e,i)}},71543:function(e,t,i){i.d(t,{G7:function(){return X},KL:function(){return N},Te:function(){return F},WD:function(){return P},Wt:function(){return q},b2:function(){return x},bt:function(){return W},eL:function(){return O},wg:function(){return Z},wm:function(){return B}});var s=i(32606),n=i(60559),r=i(35851),a=i(19027),o=i(64880),h=i(22681),c=i(93070);if(666==i.j)var l=i(10915);var d=i(4087),u=i(94205),g=i(88155);if(666==i.j)var p=i(68100);if(666==i.j)var m=i(81578);if(666==i.j)var f=i(35589);var I=i(68434),E=i(72372);if(666==i.j)var S=i(58232);if(666==i.j)var T=i(45065);if(666==i.j)var D=i(86405);if(666==i.j)var C=i(88892);var M=i(13265),y=i(97511);const A=n.O.createLogger("SketchInformation",h.bVy.GRAPHICS),P="ellipsis",O=5,R=d.UKE,w={};w[h.U5n.BAD]="BAD",w[h.U5n.DRIVEN]="OK",w[h.U5n.SOLVED]="OK";const v={};v[R.SELECTED]="SELECTED_COLOR",v[R.PREHILITE]="PREHILITE_COLOR",v[R.MUTED]="MUTED_COLOR",v[R.NOT_SELECTED]="COLOR";const _=function(e,t,i,s){switch(t){case h.U5n.BAD:e+=":od";break;case h.U5n.DRIVEN:e+=":dr"}return i===d.UKE.SELECTED?e+=":s":i===d.UKE.PREHILITE?e+=":h":i===d.UKE.MUTED&&(e+=":m"),s&&(e+=":ex"),e};var N;!function(e){e[e.LINE=0]="LINE",e[e.TANGENT_ARC=1]="TANGENT_ARC"}(N||(N={}));const b=new Map([[N.LINE,"Sketch_Constraints_Grayscale_2_line.svg "],[N.TANGENT_ARC,"Sketch_Constraints_Grayscale_2_tangent-arc.svg "]]),L=new Map([[N.LINE,"line"],[N.TANGENT_ARC,"tangent_arc"]]);var F;!function(e){e[e.NOT_REQUIRED=0]="NOT_REQUIRED",e[e.REQUIRED=1]="REQUIRED"}(F||(F={}));class x{constructor(){this.id="",this.selectionId="",this.selected=d.UKE.NOT_SELECTED,this.constraintType=h.dI1.UNKNOWN,this.solveStatus=h.U5n.SOLVED,this._borderState=F.NOT_REQUIRED}static getIcon(e){const t=new x,i=_(L.get(e),h.U5n.UNKNOWN,d.UKE.MUTED,!1);return t.id=i,t}get borderState(){return this._borderState}set borderState(e){this._borderState=e}}const B=1,V=function(e,t,i,s){let n;switch(e){case h.dI1.QUADRANT:n="qad";break;case h.dI1.COINCIDENT:n="coi";break;case h.dI1.PARALLEL:n="par";break;case h.dI1.VERTICAL:n="ver";break;case h.dI1.HORIZONTAL:n="hoz";break;case h.dI1.PERPENDICULAR:n="prp";break;case h.dI1.CONCENTRIC:n="con";break;case h.dI1.MIDPOINT:n="mid";break;case h.dI1.TANGENT:n="tan";break;case h.dI1.PIERCE:n="prc";break;case h.dI1.EQUAL:n="equ";break;case h.dI1.NORMAL:n="nor";break;case h.dI1.FIX:n="fix";break;case h.dI1.PROJECTED:case h.dI1.SILHOUETTED:n="prj";break;case h.dI1.OFFSET:n="off";break;case h.dI1.MIRROR:n="mir";break;case h.dI1.CIRCULAR_PATTERN:n="cpt";break;case h.dI1.LINEAR_PATTERN:n="lin";break;case h.dI1.INTERSECTED:n="int";break;case h.dI1.EQUAL_CURVATURE:n="cur";break;default:n="???",A.error("Found a constraint with no atlas key.")}return _(n,t,i,s)},U=function(e,t,i,n,r){const a=s.default.getManager(),o=new u.ImageData;o.id=e;let c="CONSTRAINT_"+(w[t]||"OK")+"_"+(v[i]||"COLOR");return n&&(c+="_EXTERNAL"),o.backgroundColor=a.getColorString(c),t!==h.U5n.SOLVED||n||i?o.imageName=r:o.svgToStyle=r,o},H=function(e,t,i,s,n){s.forEach((function(s){for(let r=0;r<2;r++){const a=1===r;n.push(U(V(e,t,s,a),t,s,a,i))}}))},G=function(e){const t=[],i=[d.UKE.NOT_SELECTED,d.UKE.PREHILITE,d.UKE.SELECTED,d.UKE.MUTED],n={"Sketch_Constraints_Grayscale_2_Coincident.svg":h.dI1.COINCIDENT,"Sketch_Constraints_Grayscale_2_Parallel.svg":h.dI1.PARALLEL,"Sketch_Constraints_Grayscale_2_Vertical.svg":h.dI1.VERTICAL,"Sketch_Constraints_Grayscale_2_Horizontal.svg":h.dI1.HORIZONTAL,"Sketch_Constraints_Grayscale_2_Perpendicular.svg":h.dI1.PERPENDICULAR,"Sketch_Constraints_Grayscale_2_Concentric.svg":h.dI1.CONCENTRIC,"Sketch_Constraints_Grayscale_2_Midpoint.svg":h.dI1.MIDPOINT,"Sketch_Constraints_Grayscale_2_Tangent.svg":h.dI1.TANGENT,"Sketch_Constraints_Grayscale_2_Equal.svg":h.dI1.EQUAL,"Sketch_Constraints_Grayscale_2_Normal.svg":h.dI1.NORMAL,"Sketch_Constraints_Grayscale_2_Fix.svg":h.dI1.FIX,"Sketch_Constraints_Grayscale_2_Use.svg":h.dI1.PROJECTED,"Sketch_Constraints_Grayscale_2_Offset.svg":h.dI1.OFFSET,"Sketch_Constraints_Grayscale_2_Mirror.svg":h.dI1.MIRROR,"Sketch_Constraints_Grayscale_2_CircularPattern.svg":h.dI1.CIRCULAR_PATTERN,"Sketch_Constraints_Grayscale_2_LinearPattern.svg":h.dI1.LINEAR_PATTERN,"Sketch_Constraints_Grayscale_2_Pierce.svg":h.dI1.PIERCE,"Sketch_Constraints_Grayscale_2_Quadrant.svg":h.dI1.QUADRANT,"Sketch_Constraints_Grayscale_2_Intersection.svg":h.dI1.INTERSECTED,"Sketch_Constraints_Grayscale_2_equal-curvature.svg":h.dI1.EQUAL_CURVATURE};Object.entries(n).forEach((function([e,s]){H(s,h.U5n.SOLVED,e,i,t)}));const r={"Sketch_Constraints_OverDefined_Coincident.svg":h.dI1.COINCIDENT,"Sketch_Constraints_OverDefined_Parallel.svg":h.dI1.PARALLEL,"Sketch_Constraints_OverDefined_Vertical.svg":h.dI1.VERTICAL,"Sketch_Constraints_OverDefined_Horizontal.svg":h.dI1.HORIZONTAL,"Sketch_Constraints_OverDefined_Perpendicular.svg":h.dI1.PERPENDICULAR,"Sketch_Constraints_OverDefined_Concentric.svg":h.dI1.CONCENTRIC,"Sketch_Constraints_OverDefined_Midpoint.svg":h.dI1.MIDPOINT,"Sketch_Constraints_OverDefined_Tangent.svg":h.dI1.TANGENT,"Sketch_Constraints_OverDefined_Equal.svg":h.dI1.EQUAL,"Sketch_Constraints_OverDefined_Normal.svg":h.dI1.NORMAL,"Sketch_Constraints_OverDefined_Fix.svg":h.dI1.FIX,"Sketch_Constraints_OverDefined_Use.svg":h.dI1.PROJECTED,"Sketch_Constraints_OverDefined_Offset.svg":h.dI1.OFFSET,"Sketch_Constraints_OverDefined_Mirror.svg":h.dI1.MIRROR,"Sketch_Constraints_OverDefined_CircularPattern.svg":h.dI1.CIRCULAR_PATTERN,"Sketch_Constraints_OverDefined_LinearPattern.svg":h.dI1.LINEAR_PATTERN,"Sketch_Constraints_OverDefined_Pierce.svg":h.dI1.PIERCE,"Sketch_Constraints_OverDefined_Quadrant.svg":h.dI1.QUADRANT,"Sketch_Constraints_OverDefined_Intersection.svg":h.dI1.INTERSECTED,"Sketch_Constraints_OverDefined_equal-curvature.svg":h.dI1.EQUAL_CURVATURE};Object.entries(r).forEach((function([e,s]){H(s,h.U5n.BAD,e,i,t)})),i.forEach((function(e){t.push(U(_("...",h.U5n.SOLVED,e,!1),h.U5n.SOLVED,e,!1,"Sketch_Constraints_Ellipsis.svg"))}));const a=Object.values(N).filter((e=>"string"==typeof e));for(const e in a){const i=parseInt(e);t.push(U(_(L.get(i),h.U5n.UNKNOWN,d.UKE.MUTED,!1),h.U5n.UNKNOWN,d.UKE.MUTED,!1,b.get(i)))}const o=s.default.getManager().getNumber("CONSTRAINT_MAX_INDICATOR_SIZE")*(0,C.x_)();return(0,u.createAtlasFromResources)(e,o,t,{sourcesHaveTransparency:!1})};let k=0;function W(e){if(e.getResources().constraintAtlasCreationInitiated)return;e.getResources().constraintAtlasCreationInitiated=!0;const t=k++;e.getResources().constraintAtlasCreationId=t;e.getTextureAtlasFactory().getAtlas(u.SKETCH_CONSTRAINT_TEXTURE_ATLAS,G.bind(void 0,e)).then((function(i){t===e.getResources().constraintAtlasCreationId&&(i?(e.getResources().constraintAtlas=i,e.getResources().constraintMaterial.ambientTexture=i.texture,(0,u.requestDraw)()):A.warn("Could not load texture atlas"))}),(function(e){A.error(e)}))}const z=function(e){return e.selected===d.UKE.SELECTED};class X extends(666==i.j?u.UIElement:null){constructor(e,t,i,n,r,a){super(a,u.HUD_SCENEGRAPH_ID),this.permanent=r,this.activated=!1,this.isExpanded=!1,this.lastCameraXform=null,this.lastProjectionXform=null,this.hasLeader=!1,this.lastMouseDelta=null,this.isForInference=!1,this.material=a.getResources().constraintMaterial,this.nodeProperties=this.viewer.getResources().typeToNodeProperties[u.sketchinformation.nodePropertiesTypes.OK],this.leaderProperties=new u.NodeProperties({isPickable:!1,primitiveType:u.PrimitiveType.LINES,zOffset:5}),this.borderProperties=this.leaderProperties.clone(),this.model=e,this.reference=this.model.getReference(t),this.referenceIdsChangedSubscription=this.reference.getReferenceIdsChangedObservable().subscribe((([e,t])=>this.onReferenceConstraintIdsChanged(e,t))),this.anchorChangedSubscription=this.reference.getAnchorChangedObservable().subscribe((e=>this.resetLocation(e)));const o=this.reference.constraintIds,h=(0,S.T)(...o.map((e=>this.model.getConstraint(e))).filter((e=>!!e)).map((e=>e.getConstraintChangedObservable())));this.changeSolveStatusSubscription=h.pipe((0,T.h)((e=>"change:solveStatus"===e.name)),(0,D.U)((e=>e.constraint))).subscribe((e=>this.onConstraintStatusChanged(e))),this.changeTypeSubscription=h.pipe((0,T.h)((e=>"change:type"===e.name)),(0,D.U)((e=>e.constraint))).subscribe((e=>this.onConstraintTypeChanged(e))),this.changeBorderSubscription=h.pipe((0,T.h)((e=>"change:border"===e.name)),(0,D.U)((e=>e.constraint))).subscribe((e=>this.onConstraintBorderChanged(e))),this.iconData=[],this.worldLocation=i,this.leaderOffset=p.fromValues(0,0,0),this.ellipsisIcon=new x,this.ellipsisIcon.id=P,this.ellipsisIcon.selectionId=P;const c=s.default.getManager();this.iconSizeConstantName=r?"CONSTRAINT_PERMANENT_INDICATOR_PIXEL_SIZE":"CONSTRAINT_INDICATOR_PIXEL_SIZE",this.iconSize=c.getNumber(this.iconSizeConstantName),this.leaderColor=c.getColor("CONSTRAINT_INDICATOR_LEADER_COLOR"),this.borderColor=c.getColor("CONSTRAINT_INDICATOR_BORDER_COLOR");const l=E.Jq.CapabilitiesService.checkConstraintManagerCurrentlyEnabled();this.borderSize=l?c.getNumber("CONSTRAINT_INDICATOR_BORDER_SIZE"):0,this.borderSizeScaledToIconSize=this.borderSize/this.iconSize,this.userOffset=m.fromValues(0,0),this.worldGeometryDirection=n,this.model.constraints.forEach((e=>this.onConstraintAdded(e))),this.listenTo(this.viewer.getEventDispatcher(),u.VIEW_WILL_PICK,this.onViewWillDraw),this.showOnlyOverDefinedSubscription=this.model.showOnlyOverDefinedObservable().subscribe((()=>this.onShowOnlyOverdefinedChanged())),this.showAllConstraintsSubscription=this.model.showAllConstraintsObservable().subscribe((()=>this.onShowAllConstraintsChanged())),W(this.viewer)}showLeader(){this.hasLeader=!0}setUserOffset(e){this.userOffset=m.fromValues(e[0],-e[1]),this.invalidateDisplay()}getUserOffset(){return m.fromValues(this.userOffset[0],-this.userOffset[1])}setLocation(e){this.worldLocation=e,this.invalidateDisplay()}setMouseDelta(e){this.lastMouseDelta=e}onConstraintAdded(e){this.reference.constraintIds.indexOf(e.id)>=0&&this.addConstraintIcon(e)}invalidateDisplay(){this.lastCameraXform=null,this.lastProjectionXform=null,this.removeMeshIncrements(),(0,u.requestDraw)()}onConstraintStatusChanged(e){if(this.reference.constraintIds.indexOf(e.id)<0)return;const t=this.iconData.find((t=>t.id===e.id));t&&(t.solveStatus=e.displayStatus,t.constraintType=e.type,this.invalidateDisplay())}onReferenceConstraintIdsChanged(e,t){const i=(0,a.difference)(e,t),s=(0,a.difference)(t,e);i.length>0&&this.invalidateDisplay(),i.forEach((e=>{const t=this.iconData.findIndex((t=>t.id===e));t>-1&&this.iconData.splice(t,1)})),s.forEach((e=>{const t=this.model.getConstraint(e);this.addConstraintIcon(t)}))}onConstraintTypeChanged(e){const t=this.iconData.find((t=>t.id===e.id));t&&(t.constraintType=e.type,this.invalidateDisplay())}onConstraintBorderChanged(e){const t=this.iconData.find((t=>t.id===e.id));t&&(t.borderState=e.border,this.invalidateDisplay())}addIcon(e,t,i,s,n){const r=new x;r.id=e,t&&(r.constraintType=t),i&&(r.solveStatus=i),r.isExternal=!!s,n&&(r.borderState=n),this.iconData.push(r),this.invalidateDisplay()}getOffset(e,t){let i;if(this.isForInference)i=m.fromValues(1,-1);else if(this.lastMouseDelta)i=this.lastMouseDelta[0]>0?m.fromValues(-this.lastMouseDelta[1],this.lastMouseDelta[0]):m.fromValues(this.lastMouseDelta[1],-this.lastMouseDelta[0]);else{const t=e.projectWorldPointToViewport(this.worldLocation),s=I.S4.add(this.worldLocation,this.worldGeometryDirection,p.create()),n=e.projectWorldPointToViewport(s),r=I.S4.subtract(n,t,p.create());r[2]=0,i=I.S4.length(r)<B?m.fromValues(-1,1):m.fromValues(r[1],-r[0])}I.gv.normalize(i);const n=.5*t,r=function(e,t){return m.dot(m.fromValues(e,t),i)},a=-Math.abs(r(n,.5)),o=-Math.abs(r(n,-.5)),h=s.default.getManager(),c=(this.permanent?h.getNumber("PERMANENT_INFERENCE_OFFSET"):h.getNumber("TEMPORARY_INFERENCE_OFFSET"))-Math.min(a,o),l=-.99*(0,u.getHudLayerDepthRange)(e.getViewport())[1];return[i[0]*c,i[1]*c,l]}onDevicePixelRatioChanged(e){const t=s.default.getManager();this.iconSize=t.getNumber(this.iconSizeConstantName),W(this.viewer),this.invalidateDisplay()}onAppearanceConstantsUpdated(){W(this.viewer),this.leaderColor=s.default.getManager().getColor("CONSTRAINT_INDICATOR_LEADER_COLOR"),this.invalidateDisplay()}onViewWillDraw(e,t){if(!this.viewer.getResources().constraintAtlas)return;const i=e.getViewMatrixInverse(),s=e.getProjectionMatrix();if(this.lastCameraXform&&this.lastProjectionXform&&f.equals(i,this.lastCameraXform)&&f.equals(s,this.lastProjectionXform))return;this.lastCameraXform=i,this.lastProjectionXform=s;let n=e.projectWorldPointToViewport(this.worldLocation);n[2]=0;const r=p.fromValues(this.userOffset[0],this.userOffset[1],0);n=I.S4.add(n,r);const a=I.w$.translate(f.create(),n),o=this.iconSize;I.w$.scale(a,[o,o,1]);const h=this.getVisibleIcons(),c=this.getOffset(e,this.getDisplayedIconCount(h));I.w$.translate(a,c),a[12]=Math.floor(a[12]),a[13]=Math.floor(a[13]),this.leaderOffset=I.S4.subtract(I.S4.scale(r,-1/o,p.create()),c),this.leaderOffset[2]=0,this.setTransform(a),this.hasMeshIncrements()||this.updateIconGraphics(h),this.updateLeaderGraphics(h)}getNodePropertyType(e){let t=NaN;switch(e.solveStatus){case h.U5n.SOLVED:t=e.isExternal?u.sketchinformation.nodePropertiesTypes.EXTERNAL_AND_OK:u.sketchinformation.nodePropertiesTypes.OK;break;case h.U5n.BAD:t=u.sketchinformation.nodePropertiesTypes.OVERDEFINED;break;case h.U5n.DRIVEN:t=u.sketchinformation.nodePropertiesTypes.DRIVEN}return t}updateNodeProperties(e){if(this.isForInference)return void(this.nodeProperties=this.viewer.getResources().inferenceNodeProperties);this.nodeProperties=this.viewer.getResources().typeToNodeProperties[u.sketchinformation.nodePropertiesTypes.OK];let t=u.sketchinformation.nodePropertiesTypes.DRIVEN;const i=this;e.forEach((function(e){const s=i.getNodePropertyType(e);s<t&&(t=s)})),this.nodeProperties=this.viewer.getResources().typeToNodeProperties[t]}onShowOnlyOverdefinedChanged(){this.invalidateDisplay()}onShowAllConstraintsChanged(){this.model.constraintVisibilityOverride=[],this.invalidateDisplay()}showIconIfPermanent(e,t,i,s){return!!e&&(!!t&&(s||i&&e.solveStatus===h.U5n.BAD))}getVisibleIcons(){let e=[];if(this.isForInference)e=this.iconData;else{const t=this.reference.constraintVisibilities,i=this.reference.constraintIds;for(let s=0;s<i.length;s++){const n=this.iconData.find((e=>e.id===i[s]));if(!n)continue;if(0!==this.model.constraintVisibilityOverride.length&&!1===this.model.showAllConstraints){-1!==this.model.constraintVisibilityOverride.findIndex((e=>e===i[s]))&&e.push(n)}else this.permanent===this.showIconIfPermanent(n,t[s],this.model.showOnlyOverdefined,this.model.showAllConstraints)&&e.push(n)}}return(0,l.Z)(e,(function(e){return-2*e.solveStatus-(e.isExternal?1:0)}))}getDisplayedIconCount(e){return this.isExpanded?e.length:Math.min(e.length,O+1)}updateIconGraphics(e){if(!this.viewer.getResources().constraintAtlas)return;this.updateNodeProperties(e),this.viewer.getResources().constraintMaterial.ambientTexture=this.viewer.getResources().constraintAtlas.texture;const t=e.length>O+1&&!this.isExpanded,i=.5*-this.getDisplayedIconCount(e);e.forEach(((e,s)=>{if(e.selectionId=""+s,t){if(s>O)return void this.removeMeshIncrement(e.id);s===O&&(this.removeMeshIncrement(e.id),e=this.ellipsisIcon)}let n,r=e.selected;if(this.activated||(r=d.UKE.MUTED),e.id===P)n=_("...",h.U5n.SOLVED,r,!1);else{const t=e.constraintType,i=e.solveStatus,s=e.isExternal;n=V(t,i,r,s)}const a=this.viewer.getResources().constraintAtlas.getTextureCoords(n);if(!a)return;s+=s*this.borderSizeScaledToIconSize;const o=(0,u.createQuad)([i+s,-.5,0],[i+s+1,-.5,0],[i+s,.5,0],e.id,[a.lowS,a.highT],[a.highS,a.lowT]);this.updateMeshIncrement(e.id,e.selectionId,o,this.nodeProperties);const c=e.id+".border";if(!(e.borderState===F.REQUIRED))return void this.removeMeshIncrement(c);const l=this.borderSizeScaledToIconSize,g=l/2,p=[[i+s-l,-.5-g,0],[i+s+1+l,-.5-g,0],[i+s+1+g,-.5-l,0],[i+s+1+g,.5+l,0],[i+s+1+l,.5+g,0],[i+s-l,.5+g,0],[i+s-g,.5+l,0],[i+s-g,-.5-l,0]],m=(0,u.createLines)(p,c,this.borderColor,this.borderSize);this.updateMeshIncrement(c,u.NO_SELECTION_ID,m,this.borderProperties)}))}updateLeaderGraphics(e){if(this.hasLeader&&0!==e.length){const e=[0,0,0],t=this.leaderOffset,i=(0,u.createLine)(e,t,"leader",this.leaderColor,1);this.updateMeshIncrement("leader",u.NO_SELECTION_ID,i,this.leaderProperties)}}addConstraintIcon(e){e&&this.addIcon(e.id,e.type,e.displayStatus,e.isExternal,e.border)}onDelete(){if((0,r.yV)())return!1;const e=this.iconData.filter(z);return 0!==e.length&&this.deleteConstraints(e)}deleteConstraints(e){const t=(0,u.getDrawer)(),i=t.getUISelectionManager().getSelection(),s=t.getUISelectionManager().getHoveredSelection();let n=!1;if(e.forEach((e=>{const r=this.model.constraints.find((t=>t.id===e.id));r&&(i&&i.uiElement instanceof X&&i.uiElement.iconData.some((function(t){return t===e}))&&t.getUISelectionManager().setSelection(null),s&&s.uiElement instanceof X&&s.uiElement.iconData.some((function(t){return t===e}))&&t.getUISelectionManager().setHoveredSelection(null,{}),this.model.removeConstraints([r]),n=!0)})),n&&(this.deselectEntities(),!t.getUISelectionManager().getSelection())){const e=(0,g.uQ)().getLastMouseMovedEvent();t.doPick(e.offsetX,e.offsetY,!0,!0,null)}return n}expand(){this.isExpanded=!0,this.removeMeshIncrement(P),this.ellipsisIcon.selectionId="",this.invalidateDisplay()}activate(){this.activated||(this.activated=!0,this.invalidateDisplay())}isSelected(){return!!this.iconData.find((e=>e.selected===d.UKE.SELECTED))}select(e){if(e.selectionId===this.ellipsisIcon.selectionId)return void this.expand();const t=this.iconData.find((t=>t.selectionId===e.selectionId));if(t&&t.selected!==d.UKE.SELECTED){t.selected=d.UKE.SELECTED;E.Jq.CapabilitiesService.checkConstraintManagerCurrentlyEnabled()&&((0,d.xA2)().trigger(d.Mpj,e.sourcePick),(0,y.m)().trigger(M.C.CONSTRAINT_MANAGER_FOCUS_CONSTRAINT,t.id)),this.invalidateDisplay()}}deselectData(e){if(e&&e.selected===d.UKE.SELECTED){e.selected=d.UKE.NOT_SELECTED;E.Jq.CapabilitiesService.checkConstraintManagerCurrentlyEnabled()&&(0,y.m)().trigger(M.C.CONSTRAINT_MANAGER_UNFOCUS_CONSTRAINT,e.id),this.invalidateDisplay()}}deselect(e){const t=this.iconData.find((t=>t.selectionId===e.selectionId));this.deselectData(t)}deselectAll(){for(const e of this.iconData)this.deselectData(e)}hover(e){(0,o.Wf)().reset(),this.highlightConstraintIcon(e.selectionId)}highlightConstraintIcon(e){let t=null;if(e===this.ellipsisIcon.selectionId)t=this.ellipsisIcon;else{const i=Number(e);!isNaN(i)&&i>O&&!this.isExpanded&&this.expand(),t=this.iconData.find((t=>t.selectionId===e))}t&&t.selected===d.UKE.NOT_SELECTED&&(t.selected=d.UKE.PREHILITE,this.invalidateDisplay())}dehover(e){let t=null;t=e.selectionId===this.ellipsisIcon.selectionId?this.ellipsisIcon:this.iconData.find((t=>t.selectionId===e.selectionId)),t&&t.selected===d.UKE.PREHILITE&&(t.selected=d.UKE.NOT_SELECTED,this.invalidateDisplay())}getConstraint(e){const t=this.iconData.find((t=>t.selectionId===e));return t?this.model.getConstraint(t.id):null}deselectEntities(){q()}selectEntities(e){this.deselectEntities();const t=this.model.id;let i;const s=this.getConstraint(e);if(s){i=s.referenceIds;for(const e of i){const i=this.model.getReference(e);i&&(0,r.XZ)(t,i,this.viewer)}}}getClearModelSelectionsOnPrehilite(){return!1}remove(){super.remove(),this.showOnlyOverDefinedSubscription.unsubscribe(),this.showAllConstraintsSubscription.unsubscribe(),this.changeSolveStatusSubscription.unsubscribe(),this.changeTypeSubscription.unsubscribe(),this.changeBorderSubscription.unsubscribe(),this.referenceIdsChangedSubscription.unsubscribe(),this.anchorChangedSubscription.unsubscribe()}resetLocation(e){e&&this.setLocation(e)}}function Z(e,t,i){if(0===t.length)return null;const s=new X((0,c.bo)("inference",t),"inference",e,[0,0,0],!1,i);return s.isForInference=!0,s}function q(){(0,o.Dk)().reset(),(0,o.wT)().reset()}},9283:function(e,t,i){i.d(t,{Bm:function(){return n},Fk:function(){return o},GH:function(){return s},Xh:function(){return r},di:function(){return a}});const s="sketch-constraints",n="mates",r="DIMENSION_ATLAS",a="MBD_ATLAS";class o{constructor(){this.creationPromises=new Map}getAtlas(e,t){let i=this.creationPromises.get(e);return i||(i=t(),this.creationPromises.set(e,i)),i}clearAtlas(e){this.creationPromises.delete(e)}}},91299:function(e,t,i){i.d(t,{L:function(){return u},_:function(){return b}});var s=i(32606),n=i(1190),r=i(82630),a=i(94205);if(666==i.j)var o=i(35589);if(666==i.j)var h=i(68100);if(666==i.j)var c=i(75920);var l=i(68434);const d=s.default.getManager(),u=new Map([[r.vn.X_ROTATION.toString(),r.tF.X],[r.vn.Y_ROTATION.toString(),r.tF.Y],[r.vn.Z_ROTATION.toString(),r.tF.Z]]),g=[{zeroAngle:[0,1,0],axis:[1,0,0]},{zeroAngle:[0,0,1],axis:[0,1,0]},{zeroAngle:[1,0,0],axis:[0,0,1]}],p=[r.vn.X_ROTATION,r.vn.Y_ROTATION,r.vn.Z_ROTATION],m=666==i.j?[[1,0,0],[0,1,0],[0,0,1]]:null,f=[r.vn.X_DIRECTION,r.vn.Y_DIRECTION,r.vn.Z_DIRECTION],I=666==i.j?[[[1,0,0],[0,1,0]],[[1,0,0],[0,0,1]],[[0,1,0],[0,0,1]]]:null,E=[r.vn.XY_PLANE,r.vn.XZ_PLANE,r.vn.YZ_PLANE],S=[{zeroAngle:[0,0,1],axis:[1,0,0]},{zeroAngle:[0,0,1],axis:[0,1,0]}],T=[r.vn.X_ROTATION,r.vn.Y_ROTATION],D=666==i.j?[[0,0,1]]:null,C=[r.vn.Z_DIRECTION],M=666==i.j?[]:null,y=666==i.j?[]:null,A=[{zeroAngle:[1,0,0],axis:[0,0,1]}],P=[r.vn.X_ROTATION],O=666==i.j?[[1,0,0],[0,1,0]]:null,R=[r.vn.X_DIRECTION,r.vn.Y_DIRECTION],w=666==i.j?[[[1,0,0],[0,1,0]]]:null,v=[r.vn.XY_PLANE],_=[{scaleDirection:[1,1,0],normal:[0,0,1]}],N=[r.vn.SCALING];class b extends(666==i.j?a.Manipulator:null){constructor(e,t,i){super(e,i),this.angularDirections=[],this.angularNames=[],this.linearDirections=[],this.linearNames=[],this.planarDirections=[],this.planarNames=[],this.scalingDirections=[],this.scalingNames=[],this.initialTransform=null,this.originalTransform=null,this.childComponents=[],this.scalingPreTransform=null,this.freeDragManipulator=null,this.linearManipulators=[],this.planarManipulators=[],this.angularManipulators=[],this.scalingManipulators=[],this.activeManipulator=null,this.preManipulationAngle=0,this.disableInactiveComponents=!0,this.disabledComponents=new Set,t||(t=n.Ak.FULL),i||(i={displayEditView:!1});let s,h=!0;switch(t){case n.Ak.FULL:this.angularDirections=g,this.angularNames=p,this.linearDirections=m,this.linearNames=f,this.planarDirections=I,this.planarNames=E;break;case n.Ak.PLANE:this.angularDirections=S,this.angularNames=T,this.linearDirections=D,this.linearNames=C,this.planarDirections=M,this.planarNames=y;break;case n.Ak.DRAG:this.angularDirections=[],this.angularNames=[],this.linearDirections=m,this.linearNames=f,this.planarDirections=I,this.planarNames=E,h=!1;break;case n.Ak.SKETCH:this.angularDirections=A,this.angularNames=P,this.linearDirections=O,this.linearNames=R,this.planarDirections=w,this.planarNames=v,this.scalingDirections=_,this.scalingNames=N;break;case n.Ak.EXPLODE_CONVENIENCE_MANIPULATOR:this.angularDirections=g,this.angularNames=p,this.linearDirections=m,this.linearNames=f,this.planarDirections=[],this.planarNames=[],h=!0}this.transform=o.create(),h&&(this.freeDragManipulator=new a.FreeDrag(this.viewer,i),this.freeDragManipulator.setId(r.vn.FREE_DRAG),this.freeDragManipulator.setTriadOwnerType(t),this.listenTo(this.freeDragManipulator,n.Wb.VALUE_CHANGED,this.onFreeDragChanged),this.listenTo(this.freeDragManipulator,n.Wb.MANIPULATION_STARTED,this.onFreeDragStarted),this.listenTo(this.freeDragManipulator,n.Wb.MANIPULATION_ENDED,this.onFreeDragEnded),this.childComponents.push(this.freeDragManipulator));const c=this,l=function(e){c.listenTo(c.linearManipulators[e],n.Wb.VALUE_CHANGED,(function(t,i){c.updateFromLinearManipulator(e,i)})),c.listenTo(c.linearManipulators[e],n.Wb.VALUE_EDITED,(function(){c.updateOnEditFromLinearManipulator(e)}))};for(s=0;s<this.linearDirections.length;++s){const e=new a.Linear(this.viewer,i);e.setVisualGap(this.freeDragManipulator?d.getNumber("MANIPULATOR_FREE_DRAG_RADIUS_PX"):0),e.setShaftLength(d.getNumber("MANIPULATOR_TRIAD_LINEAR_SHAFT_LENGTH_PX")),e.setFadeParameters(d.getNumber("MANIPULATOR_TRIAD_LINEAR_FADE_ANGLE_START"),d.getNumber("MANIPULATOR_TRIAD_LINEAR_FADE_ANGLE_END")),e.setId(this.linearNames[s]),e.setTriadOwnerType(t),this.linearManipulators.push(e),this.childComponents.push(e),l(s)}const u=function(e){c.listenTo(c.planarManipulators[e],n.Wb.VALUE_CHANGED,(function(t,i){c.updateFromPlanarManipulator(e,i)}))};for(s=0;s<this.planarDirections.length;++s){const e=new a.Planar(this.viewer,i);e.setVisualGap(d.getNumber("MANIPULATOR_TRIAD_PLANAR_OFFSET_PX")),e.setSideLength(d.getNumber("MANIPULATOR_TRIAD_PLANAR_SIDE_LENGTH_PX")),e.setId(this.planarNames[s]),e.setTriadOwnerType(t),this.planarManipulators.push(e),this.childComponents.push(e),u(s)}const b=function(e){c.listenTo(c.angularManipulators[e],n.Wb.VALUE_CHANGED,(function(){c.updateFromAngularManipulator(e)})),c.listenTo(c.angularManipulators[e],n.Wb.CACHE_TRANSFORM,(function(){c.initialTransform=o.clone(c.transform)})),c.listenTo(c.angularManipulators[e],n.Wb.VALUE_EDITED,(function(){c.updateOnEditFromAngularManipulator(e)}))},L=d.getNumber("MANIPULATOR_TRIAD_ANGULAR_GAP_PX")+d.getNumber("MANIPULATOR_FREE_DRAG_RADIUS_PX")+d.getNumber("MANIPULATOR_LINEAR_HEAD_LENGTH_PX")+d.getNumber("MANIPULATOR_TRIAD_LINEAR_SHAFT_LENGTH_PX");for(s=0;s<this.angularDirections.length;++s){const e=new a.Angular(this.viewer,i);e.setRadialOffset(L),e.setFadeParameters(d.getNumber("MANIPULATOR_TRIAD_ANGULAR_FADE_ANGLE_START"),d.getNumber("MANIPULATOR_TRIAD_ANGULAR_FADE_ANGLE_END")),e.setId(this.angularNames[s]),e.setTriadOwnerType(t),this.angularManipulators.push(e),this.childComponents.push(e),b(s)}const F=function(e){c.listenTo(c.scalingManipulators[e],n.Wb.VALUE_CHANGED,(function(t,i){c.updateFromScalingManipulator(e,i)})),c.listenTo(c.scalingManipulators[e],n.Wb.VALUE_EDITED,(function(){c.updateOnEditFromScalingManipulator(e)}))};for(s=0;s<this.scalingDirections.length;++s){const e=new a.ScalingManipulator(this.viewer,i);e.setGapLength(d.getNumber("MANIPULATOR_TRIAD_LINEAR_SHAFT_LENGTH_PX")*Math.sqrt(2)),e.setHeadLength(d.getNumber("MANIPULATOR_LINEAR_HEAD_LENGTH_PX")),e.setId(this.scalingNames[s]),e.setTriadOwnerType(t),this.scalingManipulators.push(e),this.childComponents.push(e),F(s)}for(s=0;s<this.childComponents.length;++s)this.listenTo(this.childComponents[s],n.Wb.MANIPULATION_STARTED,this.onManipulationStarted),this.listenTo(this.childComponents[s],n.Wb.MANIPULATION_ENDED,this.onManipulationEnded),this.listenTo(this.childComponents[s],a.UiEvents.COMMAND,this.onCommand),this.listenTo(this.childComponents[s],n.Wb.CLICKED,this.onManipulatorClicked),this.listenTo(this.childComponents[s],n.Wb.DOUBLE_CLICKED,this.onManipulatorDoubleClicked);this.preManipulationTransform=o.clone(this.transform),this.updateComponentManipulators()}onDevicePixelRatioChanged(e){for(let e=0;e<this.planarManipulators.length;++e)this.planarManipulators[e].setVisualGap(d.getNumber("MANIPULATOR_TRIAD_PLANAR_OFFSET_PX")),this.planarManipulators[e].setSideLength(d.getNumber("MANIPULATOR_TRIAD_PLANAR_SIDE_LENGTH_PX"));for(let e=0;e<this.linearManipulators.length;++e)this.linearManipulators[e].setVisualGap(this.freeDragManipulator?d.getNumber("MANIPULATOR_FREE_DRAG_RADIUS_PX"):0),this.linearManipulators[e].setShaftLength(d.getNumber("MANIPULATOR_TRIAD_LINEAR_SHAFT_LENGTH_PX"));const t=d.getNumber("MANIPULATOR_TRIAD_ANGULAR_GAP_PX")+d.getNumber("MANIPULATOR_FREE_DRAG_RADIUS_PX")+d.getNumber("MANIPULATOR_LINEAR_HEAD_LENGTH_PX")+d.getNumber("MANIPULATOR_TRIAD_LINEAR_SHAFT_LENGTH_PX");for(let e=0;e<this.angularManipulators.length;++e)this.angularManipulators[e].setRadialOffset(t);for(let e=0;e<this.scalingManipulators.length;++e)this.scalingManipulators[e].setGapLength(d.getNumber("MANIPULATOR_TRIAD_LINEAR_SHAFT_LENGTH_PX")),this.scalingManipulators[e].setHeadLength(d.getNumber("MANIPULATOR_LINEAR_HEAD_LENGTH_PX"))}remove(){super.remove();for(let e=0;e<this.childComponents.length;++e)this.childComponents[e].remove()}setIsEnabled(e){for(let t=0;t<this.childComponents.length;++t)this.childComponents[t].setIsEnabled(e)}setDisableInactiveComponents(e){this.disableInactiveComponents=e}setIsLocked(e){this.freeDragManipulator&&this.freeDragManipulator.setIsLocked(e)}onManipulationStarted(e){if(this.preManipulationTransform=o.clone(this.transform),this.initialTransform||(this.initialTransform=o.clone(this.transform)),this.originalTransform||(this.originalTransform=o.clone(this.transform)),this.activeManipulator=e,e!==this.freeDragManipulator&&this.disableInactiveComponents)for(let t=0;t<this.childComponents.length;++t)this.childComponents[t].setIsEnabled(e===this.childComponents[t]);for(let t=0;t<this.scalingManipulators.length;++t)this.scalingManipulators[t]!==e?(this.scalingManipulators[t].resetScale(),this.scalingPreTransform=void 0):this.scalingPreTransform||(this.scalingPreTransform=o.clone(this.transform));if(e instanceof a.Linear||e instanceof a.Planar)this.trigger(r.w0.TRANSLATION_START);else if(e instanceof a.Angular){const t=e.getAxis().direction;this.preManipulationAngle=e.getAngle();const i=[this.transform[12],this.transform[13],this.transform[14]];this.trigger(r.w0.ROTATION_START,i,t)}else e instanceof a.ScalingManipulator&&this.trigger(r.w0.SCALING_START);this.trigger(n.Wb.MANIPULATION_STARTED)}onManipulationEnded(){this.activeManipulator instanceof a.Angular?this.trigger(r.w0.ROTATION_END,this.transform):this.activeManipulator instanceof a.Linear||this.activeManipulator instanceof a.Planar?this.trigger(r.w0.TRANSLATION_END,this.transform):this.activeManipulator instanceof a.ScalingManipulator&&this.trigger(r.w0.SCALING_END),this.activeManipulator=null,this.preManipulationAngle=0;for(let e=0;e<this.childComponents.length;++e)this.disabledComponents.has(this.childComponents[e].getId())||this.childComponents[e].setIsEnabled(!0);this.updateComponentManipulators(),this.trigger(n.Wb.MANIPULATION_ENDED)}onCommand(e,t){if(t&&e){const i=[];i[r.tF.Origin]=[this.transform[12],this.transform[13],this.transform[14]],i[r.tF.X]=[this.transform[0],this.transform[1],this.transform[2]],i[r.tF.Y]=[this.transform[4],this.transform[5],this.transform[6]],i[r.tF.Z]=[this.transform[8],this.transform[9],this.transform[10]],this.trigger(r.w0.COMMAND,e,t.getId(),i)}}onManipulatorClicked(e){this.trigger(n.Wb.CLICKED,e)}onManipulatorDoubleClicked(e,t){this.trigger(r.w0.DOUBLE_CLICKED,e,t)}updateDefinition(e){this.transform=e,this.updateComponentManipulators()}getTranslationSinceManipulationBegan(){return l.jA.subtract(l.w$.multiplyVec4(this.transform,[0,0,0,1]),l.w$.multiplyVec4(this.preManipulationTransform,[0,0,0,1]))}getMouseRayForFreeDrag(){return this.activeManipulator instanceof a.FreeDrag?this.activeManipulator.getLastMouseRay():null}getActiveRotationAxis(){return this.activeManipulator instanceof a.Angular?this.activeManipulator.getAxis():null}getActiveRotationZeroAngleDirection(){return this.activeManipulator instanceof a.Angular?this.activeManipulator.getZeroAngleDirection():null}getActiveRotationAngle(){return this.activeManipulator instanceof a.Angular?this.activeManipulator.getAngle():0}setActiveRotationAngle(e){if(this.activeManipulator instanceof a.Angular){this.activeManipulator.setAngle(e);const t=l.w$.rotate(o.create(),e,this.activeManipulator.getAxis().direction),i=l.w$.toMat3(this.preManipulationTransform);l.xB.multiply(l.w$.toMat3(t),i,i);for(let e=0;e<3;++e){const t=l.S4.normalize([i[3*e+0],i[3*e+1],i[3*e+2]]);this.transform[4*e+0]=t[0],this.transform[4*e+1]=t[1],this.transform[4*e+2]=t[2]}this.updateComponentManipulators()}}updateFromLinearManipulator(e,t){this.updateOrigin(this.linearManipulators[e].getOffsetPosition()),this.trigger(r.w0.TRANSLATION_CHANGE,this.getTranslationSinceManipulationBegan(),this.linearManipulators[e],t)}updateOnEditFromLinearManipulator(e){const t=this.linearManipulators[e],i=l.S4.subtract(t.getEditOffsetPosition(),t.ray.point,h.create()),s=c.fromValues(i[0],i[1],i[2],0);this.updateOrigin(t.getEditOffsetPosition()),this.trigger(r.w0.TRANSLATION_EDIT,s)}updateFromPlanarManipulator(e,t){this.updateOrigin(this.planarManipulators[e].getOffsetPosition()),this.trigger(r.w0.TRANSLATION_CHANGE,this.getTranslationSinceManipulationBegan(),this.planarManipulators[e],t)}processUpdateFromAngularManipulator(e,t,i){const s=l.w$.rotate(o.create(),i,this.angularManipulators[e].getAxis().direction),n=l.w$.toMat3(t);l.xB.multiply(l.w$.toMat3(s),n,n);for(let e=0;e<3;++e)this.transform[4*e+0]=n[3*e],this.transform[4*e+1]=n[3*e+1],this.transform[4*e+2]=n[3*e+2];this.updateComponentManipulators()}updateFromAngularManipulator(e){this.processUpdateFromAngularManipulator(e,this.preManipulationTransform,this.angularManipulators[e].getAngle()),this.trigger(r.w0.ROTATION_CHANGE,this.getActiveRotationAngle(),this.getActiveRotationAxis(),this.getActiveRotationZeroAngleDirection())}updateOnEditFromAngularManipulator(e){const t=this.angularManipulators[e],i=t.getAxis().direction,s=[this.transform[12],this.transform[13],this.transform[14]],n=o.clone(this.transform),a=t.getEditAngleDisplacement();this.processUpdateFromAngularManipulator(e,this.transform,-a),this.trigger(r.w0.ROTATION_EDIT,n,a,i,s)}processScalingTransform(e,t){const i=o.fromValues(e,0,0,0,0,e,0,0,0,0,e,0,0,0,0,1);this.transform=l.w$.multiply(t,i,o.create())}updateFromScalingManipulator(e,t){this.processScalingTransform(this.scalingManipulators[e].getScale(),this.scalingPreTransform),this.trigger(r.w0.SCALING_CHANGE)}updateOnEditFromScalingManipulator(e){this.processScalingTransform(this.scalingManipulators[e].getScale(),this.scalingPreTransform),this.trigger(r.w0.SCALING_EDIT)}updateOrigin(e){for(let t=0;t<3;++t)this.transform[12+t]=e[t];this.updateComponentManipulators()}getOrigin(){return[this.transform[12],this.transform[13],this.transform[14]]}getOriginalOrigin(){return h.fromValues(this.originalTransform[12],this.originalTransform[13],this.originalTransform[14])}onFreeDragStarted(){this.trigger(r.w0.REPOSITION_START,this.transform)}onFreeDragChanged(e,t,i,s){this.updateOrigin(e),this.trigger(r.w0.REPOSITION,t,i,this.transform,s)}onFreeDragEnded(){this.trigger(r.w0.REPOSITION_END,this.transform)}updateComponentManipulators(){const e=h.fromValues(this.transform[12],this.transform[13],this.transform[14]);let t;this.freeDragManipulator&&(this.freeDragManipulator!==this.activeManipulator||this.freeDragManipulator.getIsLocked())&&this.freeDragManipulator.updateDefinition(e);const i=l.w$.toMat3(this.transform);for(t=0;t<this.linearManipulators.length;++t)if(this.linearManipulators[t]!==this.activeManipulator||this.linearManipulators[t].getIsLocked()){const s=l.S4.normalize(l.xB.multiplyVec3(i,this.linearDirections[t],h.create()));this.linearManipulators[t].updateDefinition(e,s)}for(t=0;t<this.planarManipulators.length;++t)if(this.planarManipulators[t]!==this.activeManipulator||this.planarManipulators[t].getIsLocked()){const s=l.S4.normalize(l.xB.multiplyVec3(i,this.planarDirections[t][0],h.create())),n=l.S4.normalize(l.xB.multiplyVec3(i,this.planarDirections[t][1],h.create()));this.planarManipulators[t].updateDefinition(e,s,n,[0,0])}for(t=0;t<this.angularManipulators.length;++t)(this.angularManipulators[t]!==this.activeManipulator||this.angularManipulators[t].getIsLocked())&&this.angularManipulators[t].updateDefinition(e,l.S4.normalize(l.xB.multiplyVec3(i,this.angularDirections[t].axis,h.create())),l.S4.normalize(l.xB.multiplyVec3(i,this.angularDirections[t].zeroAngle,h.create())),0);for(t=0;t<this.scalingManipulators.length;++t)if(this.scalingManipulators[t]!==this.activeManipulator||this.scalingManipulators[t].getIsLocked()){const s=l.S4.normalize(l.xB.multiplyVec3(i,this.scalingDirections[t].scaleDirection,h.create())),n=l.S4.normalize(l.xB.multiplyVec3(i,this.scalingDirections[t].normal,h.create()));this.scalingManipulators[t].updateDefinition(e,n,s)}}updateAngleRange(e,t){for(let i=0;i<this.angularManipulators.length;++i)this.angularManipulators[i].updateLimits(e,t)}updateEditAngleRange(e,t){for(let i=0;i<this.angularManipulators.length;++i)this.angularManipulators[i].updateEditLimits(e,t)}reset(e){this.originalTransform&&this.updateDefinition(o.clone(this.originalTransform));for(let e=0;e<this.linearManipulators.length;++e){const t=this.linearManipulators[e].initialRay;t&&(t.point=this.getOriginalOrigin())}e.removeEditViewAndHighlights()}disableComponent(e){this.disabledComponents.add(e)}disableXYManipulators(){this.linearManipulators.forEach((e=>{e.getId()!==r.vn.X_DIRECTION&&e.getId()!==r.vn.Y_DIRECTION||e.setIsEnabled(!1)})),this.angularManipulators.forEach((e=>{e.getId()!==r.vn.X_ROTATION&&e.getId()!==r.vn.Y_ROTATION||e.setIsEnabled(!1)})),this.scalingManipulators.forEach((e=>{e.setIsEnabled(!1)})),this.disableComponent(r.vn.X_DIRECTION),this.disableComponent(r.vn.Y_DIRECTION),this.disableComponent(r.vn.X_ROTATION),this.disableComponent(r.vn.Y_ROTATION)}enableXYManipulators(){this.disabledComponents.clear()}}},63407:function(e,t,i){i.d(t,{ZJ:function(){return p},_J:function(){return E},u1:function(){return I},zw:function(){return g}});var s=i(47061),n=i(32606);if(666==i.j)var r=i(35589);if(666==i.j)var a=i(68100);var o=i(60559),h=i(94205),c=i(68434),l=i(22681);const d=o.O.createLogger("ui",l.bVy.GRAPHICS),u=n.default.getManager();var g;!function(e){e.MOUSE_ENTER="mouseenter:",e.MOUSE_MOVE="mousemove:",e.MOUSE_LEAVE="mouseleave:",e.DOUBLE_CLICK="doubleclick:",e.CLICK="click:",e.DRAG_START="dragstart:",e.DRAG="drag:",e.DRAG_STOP="dragstop:",e.SELECT="select:",e.DESELECT="deselect:",e.COMMAND="command:",e.LONG_PRESS_START="longpressstart:",e.LONG_PRESS_END="longpressend:",e.XR_DRAG_START="xrdragstart:",e.XR_DRAG="xrdrag:",e.XR_DRAG_STOP="xrdragstop:"}(g||(g={}));const p="",m=new h.IdManager;class f{constructor(e,t){this.nodeProperties=e,this.meshIncrement=t,this.selectionId=p}}class I extends(666==i.j?s.T:null){constructor(e,t){super(),this.viewer=e,this.SHARED_DELETION_DETAILS={wasHidden:!1,wasHiddenFromPick:!1,highlights:null},this.nameToMeshIncrement={},this.isHidden=!1,this.isTransparent=!1,this.transform=null,this.normalTransform=null,this.isBeingDragged=!1,this.id="",this.incrementRanges={},this.highlights=[],this.allocatedHighlights=[],this.hasBeenRemoved=!1,this.removeHighlightFromOccurrence=e=>{const t=""+this.graphicsOccurrenceId;let i=null,s=-1;for(let n=0;n<this.allocatedHighlights.length;++n){const r=this.allocatedHighlights[n];if(r.selectionId===t&&e===r.highlightType){i=r,s=n;break}}if(!i)return;this.allocatedHighlights.splice(s,1);const n=this.viewer.getHighlightManager(this.getUsage()),r=n.freeHighlightForSelection(i.highlightType,i.selectionId);if((0,h.idIsValid)(r)){const t=n.constructHighlightForTypeAndInstance(e,r);this.occurrenceData.updateOccurrenceHighlight(h.Action.REMOVE,t,this.getUsage())}},(0,h.viewerCheck)(e),this.sceneGraphId=t||h.MAIN_SCENEGRAPH_ID,this.collectionId=h.COLLECTION_ID_PREFIX+m.getId(),this.graphicsOccurrenceId=this.viewer.getOccurrenceIdManager().getOrCreateIdForName(this.collectionId),this.meshOwnerId=(0,h.getNewOwnerId)(),this.occurrenceData=this.viewer.getOccurrenceDataManager().setOccurrenceTransform(this.graphicsOccurrenceId,r.create()),this.idManager=new h.NamedIdManager(h.IdSizes.ENTITY),this.viewer.addUIElement(this),this.listenTo(this.viewer.getEventDispatcher(),h.DEVICE_PIXEL_RATIO_CHANGED,this.onDevicePixelRatioChanged),this.occurrenceData.isUIElement=!0,this.occurrenceData.setIsolated(!0),this.occurrenceData.setCanIsolateChange(!1)}getDebugId(){return"UIElement"}getOccurrenceData(){return this.occurrenceData}setIsolated(e){this.occurrenceData.setIsolated(e)}onDevicePixelRatioChanged(e){}onAppearanceConstantsUpdated(){}remove(){this.hasBeenRemoved?d.warn("Attempted to remove ui element "+this.getDebugId()+"-"+this.meshOwnerId+" multiple times"):(this.hasBeenRemoved=!0,this.stopListening(),this.viewer&&this.viewer.removeUIElement(this),this.viewer.getOccurrenceDataManager().destroyOccurrenceData(this.graphicsOccurrenceId),this.viewer.getOccurrenceIdManager().removeName(this.collectionId),this.removeMeshIncrements(),this.freeAllocatedHighlights())}freeAllocatedHighlights(){const e=this.viewer.getHighlightManager(this.getUsage());for(let t=0;t<this.allocatedHighlights.length;++t){const i=this.allocatedHighlights[t];e.freeHighlightForSelection(i.highlightType,i.selectionId)}}getMeshManager(){return this.viewer.getUiResourceManager().getMeshManager()}getNode(){return this.viewer.getUiResourceManager().getNode(this.sceneGraphId)}getCollectionId(){return this.collectionId}removeMeshIncrements(){for(const e in this.nameToMeshIncrement)this.removeMeshIncrement(e);this.nameToMeshIncrement={},this.viewer.requestDraw()}hasMeshIncrements(){return!(0,h.isMapEmpty)(this.nameToMeshIncrement)}containsMeshIncrementWithName(e){return this.nameToMeshIncrement.hasOwnProperty(e)}getInstantiatedMeshIncrement(e){return this.nameToMeshIncrement[e]||null}getMeshIncrement(e){return this.getInstantiatedMeshIncrement(e)?.meshIncrement}shouldBeClearedWithSelections(){return!0}getId(){return this.id}setId(e){this.id=e}isVisibleToUser(){return!this.isTransparent&&!this.isHidden}hideIncrements(){for(const e in this.nameToMeshIncrement)this.hideInstantiatedMeshIncrement(e,this.nameToMeshIncrement[e])}showIncrements(){for(const e in this.nameToMeshIncrement)this.showInstantiatedMeshIncrement(e,this.nameToMeshIncrement[e])}hideIncrement(e){const t=this.nameToMeshIncrement[e];t&&this.hideInstantiatedMeshIncrement(e,t)}showIncrement(e){const t=this.nameToMeshIncrement[e];t&&this.showInstantiatedMeshIncrement(e,t)}hide(){(0,h.viewerCheck)(this.viewer),this.isVisibleToUser()&&this.hideIncrements(),this.isHidden=!0,this.viewer.requestDraw()}show(){(0,h.viewerCheck)(this.viewer);const e=this.isVisibleToUser();this.isHidden=!1,!e&&this.isVisibleToUser()&&this.showIncrements(),this.viewer.requestDraw()}makeTransparent(){this.isVisibleToUser()&&this.hideIncrements(),this.isTransparent=!0}makeOpaque(){const e=this.isVisibleToUser();this.isTransparent=!1,!e&&this.isVisibleToUser()&&this.showIncrements()}isInteractionEnabled(){return!0}getClearModelSelectionsOnPrehilite(){return!0}getTransform(){return this.transform}setTransform(e){e?(this.transform=r.clone(e),this.viewer.getOccurrenceDataManager().setOccurrenceTransform(this.graphicsOccurrenceId,e)):(this.transform=null,this.viewer.getOccurrenceDataManager().setOccurrenceTransform(this.graphicsOccurrenceId,r.create()))}transformPoint(e){return this.transform?c.w$.multiplyVec3(this.transform,e,a.create()):a.clone(e)}getSelection(e,t){if(this.graphicsOccurrenceId!==e)return d.warn("An attempt was made to get a selection from a ui element with the wrong occurrence id"),null;const i=this.idManager.getNameForId(t);if(!i)return null;const s=this.nameToMeshIncrement[i];return s?new h.UISelection(this,s.selectionId,i):null}canPickThrough(){return!1}getModelSelection(e){return null}getPickPriority(e){return null}getUsage(){return h.BTGraphicsUsage.BASE}setIncrementPickId(e,t){t.pickId=this.idManager.getOrCreateIdForName(e)}updateMeshIncrement(e,t,i,s){if(!s)return;E(i);const n=this.removeMeshIncrement(e);i.id=e,this.setIncrementPickId(e,i);const r=new f(s,i);r.selectionId=t;const a=this.getMeshManager().addMeshIncrement(i,this.meshOwnerId);if(a){let e=this.incrementRanges[s.id];if(!e){this.incrementRanges[s.id]=e=new h.IncrementRanges(this.getDebugId()+" - "+s.toString(!0));const t=new h.Style;this.getNode().addOccurrenceGeometryToNode(s,this.occurrenceData,t,e)}e.onIncrementAdded(a)}this.nameToMeshIncrement[e]=r,n&&(n.wasHidden&&this.hideIncrement(e),n.wasHiddenFromPick&&this.hideIncrementFromPick(e),n.highlights&&n.highlights.forEach((t=>{this.addHighlightToIncrement(e,t)}))),this.viewer.requestDraw()}updateIncrementAttribute(e,t,i){const s=this.nameToMeshIncrement[e];if(s){const e=this.getMeshManager().getMeshForIncrement(s.meshIncrement);e&&e.updateIncrementAttribute(t,s.meshIncrement.getFullId(),i)}}removeMeshIncrement(e){const t=this.nameToMeshIncrement[e];let i=null;return t&&(i=this.removeInstantiatedMeshIncrement(e,t),this.viewer.requestDraw()),i}removeInstantiatedMeshIncrement(e,t){this.idManager.removeName(e);const i=this.getMeshManager().getIncrementDetails(e,this.meshOwnerId),s=this.SHARED_DELETION_DETAILS;if(i){const e=this.getUsage();s.wasHidden=this.occurrenceData.isIncrementHidden(i,e),s.wasHiddenFromPick=this.occurrenceData.isIncrementHiddenFromPick(i,e),s.highlights=this.occurrenceData.getEntityHighlights(i,e),s.highlights&&this.occurrenceData.removeEntityHighlights(i,e)}else s.wasHidden=!1,s.wasHiddenFromPick=!1,s.highlights=null;if(this.getMeshManager().removeMeshIncrement(e,this.meshOwnerId),i){const e=this.incrementRanges[t.nodeProperties.id];e&&(e.onIncrementRemoved(i),e.isEmpty()&&(this.getNode().removeOccurrenceFromNode(t.nodeProperties,this.graphicsOccurrenceId),delete this.incrementRanges[t.nodeProperties.id]))}return delete this.nameToMeshIncrement[e],s}hideInstantiatedMeshIncrement(e,t){const i=this.getMeshManager().getIncrementDetails(e,this.meshOwnerId);i&&this.occurrenceData.hideIncrement(i,this.getUsage())}showInstantiatedMeshIncrement(e,t){const i=this.getMeshManager().getIncrementDetails(e,this.meshOwnerId);i&&this.occurrenceData.showIncrement(i,this.getUsage())}hideIncrementFromPick(e){const t=this.getMeshManager().getIncrementDetails(e,this.meshOwnerId);t&&this.occurrenceData.hideIncrementFromPick(t,this.getUsage())}addHighlight(e){(0,h.addHighlightToList)(e,this.highlights)}removeHighlight(e){return(0,h.removeHighlightFromList)(e,this.highlights,!1)>=0}isHighlighted(){return this.highlights.length>0}getHighlight(){return this.isHighlighted()?this.highlights[this.highlights.length-1]:null}triggerMouseEnter(e,t){this.isBeingDragged||this.trigger(g.MOUSE_ENTER+e.selectionId,e,t)}triggerMouseMove(e,t){this.isBeingDragged||this.trigger(g.MOUSE_MOVE+e.selectionId,e,t)}triggerMouseLeave(e,t){this.isBeingDragged||this.trigger(g.MOUSE_LEAVE+e.selectionId,e,t)}triggerClick(e,t){const i={requestSelectedStatus:!1};return this.trigger(g.CLICK+e.selectionId,e,t,i),i.requestSelectedStatus}triggerDoubleClick(e,t){const i={requestSelectedStatus:!1};return this.trigger(g.DOUBLE_CLICK+e.selectionId,e,t,i),i.requestSelectedStatus}triggerSelect(e){this.trigger(g.SELECT+e.selectionId,e)}triggerDeselect(e){this.trigger(g.DESELECT+e.selectionId,e)}triggerDragStart(e,t){const i={requestDrag:!1};return this.trigger(g.DRAG_START+e.selectionId,e,t,i),this.isBeingDragged=i.requestDrag,i.requestDrag}triggerDrag(e,t){this.trigger(g.DRAG+e.selectionId,e,t)}triggerDragStop(e,t){this.trigger(g.DRAG_STOP+e.selectionId,e,t),this.isBeingDragged=!1}triggerXrDragStart(e,t){const i={requestDrag:!1};return this.trigger(g.XR_DRAG_START+e.selectionId,e,t,i),this.isBeingDragged=i.requestDrag,i.requestDrag}triggerXrDrag(e,t){this.trigger(g.XR_DRAG+e.selectionId,e,t)}triggerXrDragStop(e,t){this.trigger(g.XR_DRAG_STOP+e.selectionId,e,t),this.isBeingDragged=!1}triggerLongPressStart(e,t){this.trigger(g.LONG_PRESS_START+e.selectionId,e,t)}triggerLongPressEnd(e,t){this.trigger(g.LONG_PRESS_END+e.selectionId,e,t)}addHighlightToIncrement(e,t){const i=this.getMeshManager().getIncrementDetails(e,this.meshOwnerId);i&&(this.occurrenceData.updateEntityHighlight(h.Action.ADD,t,i,this.getUsage()),this.viewer.requestDraw())}removeHighlightFromIncrement(e,t){const i=this.getMeshManager().getIncrementDetails(e,this.meshOwnerId);i&&(this.occurrenceData.updateEntityHighlight(h.Action.REMOVE,t,i,this.getUsage()),this.viewer.requestDraw())}addNewHighlightToIncrement(e,t){const i=e+"."+this.graphicsOccurrenceId,s=this.viewer.getHighlightManager(this.getUsage()).createHighlightForSelection(t,i);return this.addHighlightToIncrement(e,s),this.allocatedHighlights.push({selectionId:i,highlightType:t}),s}addNewHighlightToOccurrence(e){const t=""+this.graphicsOccurrenceId,i=this.viewer.getHighlightManager(this.getUsage()).createHighlightForSelection(e,t);this.occurrenceData.updateOccurrenceHighlight(h.Action.ADD,i,this.getUsage()),this.allocatedHighlights.push({selectionId:t,highlightType:e})}preventsSketching(){return!0}getFitBounds(){return null}onViewWillDraw(e,t){}isViewManipulator(){return!1}onDefaultUnitsChanged(e){}onIsolateChanged(){}isDimension(){return!1}isManipulator(){return!1}isAnnotation(){return!1}onHighlightColorUpdated(){}shouldTreatCtrlClickAsClick(e){return!1}}function E(e){if(e.primitiveType===h.PrimitiveType.TRIANGLES||e.primitiveType===h.PrimitiveType.TRIANGLE_STRIP){if(e.colors||(0,h.addColorToIncrement)(u.getColor("DEFAULT_TRIANGLE_COLOR"),e),!e.textureCoordinates){const t=[0,0];(0,h.addTextureCoordinateToIncrement)(t,e)}e.normals||(0,h.addNormalToIncrement)([0,0,1],e)}else e.primitiveType===h.PrimitiveType.LINES?(e.colors||(0,h.addColorToIncrement)(u.getColor("DEFAULT_MATERIAL_COLOR"),e),e.primitiveSizes||(0,h.addSizeToIncrement)(u.getNumber("DEFAULT_LINE_WIDTH"),e),e.primitiveStyles||(0,h.addStyleToIncrement)(u.getStipple("DEFAULT_LINE_STIPPLE"),e)):e.primitiveType===h.PrimitiveType.POINTS&&(e.colors||(0,h.addColorToIncrement)(u.getColor("DEFAULT_MATERIAL_COLOR"),e),e.primitiveSizes||(0,h.addSizeToIncrement)(u.getNumber("DEFAULT_POINT_SIZE"),e),e.primitiveStyles||(0,h.addStyleToIncrement)(u.getPointFont("DEFAULT_POINT_FONT"),e))}},84853:function(e,t,i){i.d(t,{E:function(){return n},Q:function(){return s}});const s="uielement.";function n(e){return!!e&&0===e.indexOf(s)}},16522:function(e,t,i){i.d(t,{i:function(){return n},z:function(){return r}});var s=i(64880);class n{constructor(e,t,i){this.selectionId=t,this.meshIncrementId=i,this.sourcePick=null,this.uiElement=e}equals(e){return!!e&&(this.uiElement===e.uiElement&&this.selectionId===e.selectionId)}hideFromPick(){this.uiElement.hideIncrementFromPick(this.meshIncrementId)}canPickThrough(){return this.uiElement.canPickThrough()}getModelSelection(){return this.uiElement.getModelSelection(this)}getPickPriority(){return this.uiElement.getPickPriority(this)}isInteractionEnabled(){return this.uiElement.isInteractionEnabled()}preventsSketching(){return this.uiElement.preventsSketching()}}class r{constructor(){this.hoveredSelection=null,this.selection=null}removeSelectionForUiElement(e){this.hoveredSelection&&this.hoveredSelection.uiElement===e&&(this.hoveredSelection.uiElement.triggerMouseLeave(this.hoveredSelection,{}),this.hoveredSelection=null),this.selection&&this.selection.uiElement===e&&(this.selection=null)}reset(){this.hoveredSelection=null,this.selection=null}getHoveredSelection(){return this.hoveredSelection}isHoveringOverViewManipulator(){return!!this.hoveredSelection&&!!this.hoveredSelection.uiElement&&this.hoveredSelection.uiElement.isViewManipulator()}getSelection(){return this.selection}uiSelectionShouldBeClearedWithSelections(){return!!this.selection&&!!this.selection.uiElement&&!!this.selection.uiElement.shouldBeClearedWithSelections()}overrideHoveredSelection(e){this.hoveredSelection&&e&&this.hoveredSelection.equals(e)||!this.hoveredSelection&&!e||(this.hoveredSelection=e)}setHoveredSelection(e,t){this.hoveredSelection&&e&&this.hoveredSelection.equals(e)||!this.hoveredSelection&&!e?this.hoveredSelection&&this.hoveredSelection.uiElement.triggerMouseMove(this.hoveredSelection,t):(this.hoveredSelection&&(t.nextSelection=e,this.hoveredSelection.uiElement.triggerMouseLeave(this.hoveredSelection,t)),this.hoveredSelection=e,this.hoveredSelection&&this.hoveredSelection.uiElement.triggerMouseEnter(this.hoveredSelection,t))}setSelection(e){(this.selection||e)&&(this.selection&&this.selection.uiElement.triggerDeselect(this.selection),e&&e.equals(this.selection)?this.selection=null:(this.selection=e,this.selection&&((0,s.vi)().reset(),this.selection.uiElement.triggerSelect(this.selection))))}processUiPick(e,t){let i=null,s=null,n=!1;e.isUIPick()&&e.uiSelection.isInteractionEnabled()&&(s=e.uiSelection),this.setHoveredSelection(s,t),s&&t.click?n=s.uiElement.triggerClick(s,t):s&&t.doubleClick&&(n=s.uiElement.triggerDoubleClick(s,t)),n&&(i=s);return(t.click||t.doubleClick)&&!(s&&!n)&&this.setSelection(i),!!s}handleEmptyUiPick(e,t){e?this.setHoveredSelection(null,t):t.click&&this.setSelection(null)}}},11678:function(e,t,i){i.d(t,{B2:function(){return me},BG:function(){return z},C2:function(){return Q},Db:function(){return j},Dy:function(){return fe},Dz:function(){return P},EE:function(){return g},EI:function(){return k},Ec:function(){return U},Es:function(){return te},HB:function(){return y},HK:function(){return R},HL:function(){return ge},Ir:function(){return Ce},J5:function(){return E},Jb:function(){return A},Lf:function(){return se},Mz:function(){return ie},NC:function(){return L},NP:function(){return Z},Pm:function(){return Y},R:function(){return re},Rg:function(){return q},SU:function(){return V},Sd:function(){return O},Wj:function(){return ee},XD:function(){return X},XM:function(){return he},Z:function(){return I},Z$:function(){return Ie},_I:function(){return m},bN:function(){return Me},dV:function(){return pe},et:function(){return N},fA:function(){return H},ft:function(){return ye},hW:function(){return K},iq:function(){return ne},jo:function(){return C},km:function(){return B},n9:function(){return d},o0:function(){return W},o3:function(){return de},ow:function(){return G},p7:function(){return ue},pc:function(){return S},q7:function(){return T},rS:function(){return Te},sW:function(){return F},tj:function(){return _},u4:function(){return M},uP:function(){return f},uc:function(){return p},vm:function(){return v},x4:function(){return ce},z4:function(){return De},zF:function(){return $}});var s=i(60559),n=i(72372),r=i(19027),a=i(67386),o=i(94205),h=i(32606),c=i(22681);const l=s.O.createLogger("utilities",c.bVy.GRAPHICS);function d(e,t){t&&e.children.push(t.makeSceneDebugObject())}let u=!0;var g,p;function m(e){switch(e){case g.HIDDEN:return"hidden";case g.VISIBLE:return"visible"}return"unknown"}function f(e){u=e}function I(){return u}function E(e){if(!e)return!1;const t=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT);return!!t&&t.precision>0}function S(e){if((0,a.isPlatformMac)()){const t=(0,o.getRendererInfo)(e);if(new RegExp(".*intel.*[3|4]000.*","i").test(t.glRenderer))return!1}return E(e)}function T(e){return Math.ceil(e.length/5)}!function(e){e[e.HIDDEN=0]="HIDDEN",e[e.VISIBLE=1]="VISIBLE"}(g||(g={})),function(e){e[e.CULLED=0]="CULLED",e[e.VISIBLE=1]="VISIBLE"}(p||(p={}));const D={};function C(e,t){D[e]=t}function M(){return D}function y(){return(0,o.getActiveViewer)()}function A(e){return D[e]}function P(e){delete D[e]}function O(e){for(const t in D)D[t].requestDrawUsingTimer(null,null,e)}function R(e){for(const t in D)D[t].requestDrawUsingAnimationFrame(null,null,e)}let w=666==i.j?O:null;function v(e){return w(e)}function _(){v(!0)}function N(){O()}window.requestAnimationFrame&&(w=R);let b=!1;function L(e,t){b=t}function F(){return b}let x=!1;function B(e){x=e}function V(){return x}function U(){return F()||V()}function H(e){const t=new Uint8Array(4);return t[0]=e>>>24&255,t[1]=e>>>16&255,t[2]=e>>>8&255,t[3]=255&e,t}function G(e){const t=1/255;return[(e>>>24&255)*t,(e>>>16&255)*t,(e>>>8&255)*t,(255&e)*t]}function k(e,t,i,s){return(e<<24)+(t<<16)+(i<<8)+s}const W=666==i.j?[0,0,0,0]:null,z=666==i.j?-1:null,X=666==i.j?[1,1,1,0]:null;function Z(e,t){let i;return t?(i=(e[2]<<16)+(e[1]<<8)+e[0],i/16777215):(i=(e[1]<<8)+e[0],i/16383)}function q(e,t){return 255*X[3]===e[3]?z:Z(e,t)}function Y(e,t){return 0===e[3]?null:Z(e,t)*Math.PI}function K(e){let t;for(t in e)return!1;return!0}function j(e){return[(0,o.clamp)(Math.floor(255*e[0]),0,255),(0,o.clamp)(Math.floor(255*e[1]),0,255),(0,o.clamp)(Math.floor(255*e[2]),0,255),(0,o.clamp)(Math.floor(255*e[3]),0,255)]}function Q(e){return[(0,o.clamp)(Math.floor(255*e[0]),0,255),(0,o.clamp)(Math.floor(255*e[1]),0,255),(0,o.clamp)(Math.floor(255*e[2]),0,255),255]}function $(e){return[e[0]/255,e[1]/255,e[2]/255,e[3]/255]}window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)};let J=null;function ee(){return J()}function te(e){return ee()-e}function ie(e,t){const i=new Float32Array(e.length+t.length);return i.set(e),i.set(t,e.length),i}function se(e,t){const i=new Uint8Array(e.length+t.length);return i.set(e),i.set(t,e.length),i}function ne(e,t){return 0===e.length?[]:0===t.length?e:1===e.length&&1===t.length?e[0]===t[0]?[]:e:(0,r.difference)(e,t)}function re(e,t){const i=new Set;return e.forEach((e=>{t.has(e)||i.add(e)})),i}J=window.performance&&window.performance.now?function(){return window.performance.now()}:function(){return(new Date).getTime()};let ae=!1,oe=!1;function he(){return ae}function ce(){return oe}const le=666==i.j?["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"]:null;function de(e,t){if(e.length<3)return l.warn("Attempting to create a color string with a color of insufficient length"),"#000000";let i="#";for(let s=0;s<3;++s){const n=t?e[s]:0|Math.round(255*e[s]);i+=le[n>>4&15],i+=le[15&n]}return i}function ue(e){const t=[];for(let i=0;i<e.length;++i){const s=!0;t.push(de(e[i],s))}return t}function ge(e,t,i){return e+"."+t+"."+i}function pe(e){const t=e.split(".");return t.length>1?t[1]:""}function me(){n.Jq.CapabilitiesService.isFeatureQLVFacePatternEnabled().then((function(e){ae=!0===e})),n.Jq.CapabilitiesService.isLongPressHandlerEnabled().then((function(e){oe=!0===e})),n.Jq.CapabilitiesService.checkNotifyThirdPartiesToSaveCurrentlyEnabled()}function fe(e,t,i){const s=4*t,n=new Uint8Array(s),r=Math.floor(i/2);for(let t=0;t<r;++t){const r=e.subarray(t*s,(t+1)*s),a=i-1-t,o=e.subarray(a*s,(a+1)*s);n.set(o),o.set(r),r.set(n)}}function Ie(e){const t=document.createElement("canvas"),i=t.getContext("2d");t.width=e.width,t.height=e.height;const s=i.createImageData(e.width,e.height);return s.data.set(e.data),i.putImageData(s,0,0),new Promise(((e,i)=>{t.toBlob((t=>{t?e(t):i("Canvas did not return blob")}),"image/jpeg",h.default.getManager().getNumber("MARKUP_JPG_IMAGE_QUALITY_VALUE"))}))}const Ee=new ArrayBuffer(1e4),Se=new Uint8Array(Ee);function Te(e,t){const i=new Uint8Array(e);for(let e=0;e<t;e+=Se.length){let t=Se;t.length>i.length-e&&(t=new Uint8Array(Ee,0,i.length-e)),i.set(t,e)}}function De(e,t){return{text:e+": ("+t+")",children:[]}}function Ce(e,t,i){for(const s in t)!t.hasOwnProperty(s)||i&&i.hasOwnProperty(s)||e.push(De(s,t[s]));return e}function Me(e,t){return{text:t,children:Ce([],e)}}function ye(e,t,i,s,n){const r=e.getEntityIdManager().getIdForName(i),a=new o.Pick(r,s,[0,0],n);return a.entityMetaData=e.retrieveEntityMetaData(i),a.occurrence=t,a.deterministicId=i,a}},49622:function(e,t,i){i.d(t,{GB:function(){return o},KX:function(){return l},P6:function(){return g},Xs:function(){return m},aN:function(){return h},f1:function(){return p},iM:function(){return r},lp:function(){return d},py:function(){return u},uQ:function(){return a},x:function(){return c}});var s=i(88155),n=i(94205);function r(e){const t=a();t&&t.setForceHideInteriorSelections(e)}function a(){return(0,s.uQ)()}function o(e){const t=a();t&&t.setBaseHighlightsEnabled(e)}function h(){const e=a();return!!e&&!!e.getSketch()}function c(){return a().getOccurrenceDataManager()}function l(){return a().getSceneGraphs()}const d=function(){a()&&a().onBeforePrint()},u=function(){a()&&a().onAfterPrint()};function g(e){const t=a();return t?t.getCanvasCoordinateFromEvent(e):[e.pageX,e.pageY]}function p(e){const t=(0,n.getCurrentActiveViewerSet)();return t?e?e?.useFlattenedView?t.sheetMetalViewer:e?.useRepairView?t.previousVersionViewer:a():a():null}function m(e){if(!(0,n.getCurrentActiveViewerSet)())return null;const t=p(e);return t?e.usePrint?t.retrievePrintedCanvasPixels(e):t.retrieveViewportAsImage(e):null}},34434:function(e,t,i){i.d(t,{G$:function(){return p},TC:function(){return u},cv:function(){return f},fT:function(){return m},jB:function(){return E},w5:function(){return g}});var s=i(44037),n=i(22681),r=i(94205),a=i(94344),o=i(57702);let h=null,c=null;const l="#canvas",d="previous-version-canvas",u=666==i.j?`#${d}`:null;function g(){return h}function p(e){if(e=e||{},h)c=null,o(l).replaceWith(h.mainViewer.$el),h.previousVersionViewer?.$el&&o(u).replaceWith(h.previousVersionViewer.$el),h.mainViewer.onViewerReactivated(),h.previousVersionViewer&&h.previousVersionViewer.onViewerReactivated(),h.sheetMetalViewer&&h.sheetMetalViewer.onViewerReactivated();else{const t={mainViewer:new r.Viewer({el:l,contextMenuMgr:e.contextMenuMgr})};if(t.mainViewer.getWebGlSupport()!==a.c.SUPPORTED)return t;if(e.createSheetMetalViewer){t.partStudioToAlternateMapping=new s.e;const i=o("<canvas/>",{id:"sheetmetalcanvas","data-view-shown":"unknown"});t.sheetMetalViewer=new r.Viewer({el:i,dontSetActive:!0,isForFlattenedDisplay:!0,hidden:!0,contextMenuMgr:e.contextMenuMgr})}h=t}return h}function m(e,t){if(e.previousVersionViewer)return;const i=o("<canvas/>",{id:d,"data-view-shown":"unknown"});e.previousVersionViewer=new r.Viewer({el:i,dontSetActive:!0,isForFlattenedDisplay:!1,isForPreviousVersionDisplay:!0,hidden:!1,contextMenuMgr:t}),e.mainViewer.pairedViewer=e.previousVersionViewer,e.previousVersionViewer.pairedViewer=e.mainViewer,e.previousVersionViewer.setSuppressModelSelection(!0)}function f(e){c=e}function I(e){e&&(e.setActiveElement(null,n.GNh.UNKNOWN,!0,null,null),e.setUnitsReceived(!1),e.$el.detach())}function E(){h&&(I(h.mainViewer),I(h.sheetMetalViewer),I(h.previousVersionViewer))}},32155:function(e,t,i){if(i.d(t,{AA:function(){return h},CR:function(){return l},Dx:function(){return o},Fo:function(){return c},aD:function(){return d},tG:function(){return a}}),666==i.j)var s=i(56098);if(666==i.j)var n=i(97282);let r=null;class a{constructor(){this._zoomModifierEnabled=!1,this.zoomModeEnabledSubject=new s.X(!1)}get zoomModeEnabledObservable(){return this.zoomModeEnabledSubject.asObservable().pipe((0,n.x)())}get zoomModeEnabled(){return this.zoomModeEnabledSubject.getValue()}set zoomModeEnabled(e){this.zoomModeEnabledSubject.next(e)}}function o(){return r||(r=new a),r}function h(){const e=o().zoomModeEnabled;o().zoomModeEnabled=!e}function c(){return o().zoomModeEnabled}function l(e){o().zoomModeEnabled=e}function d(){return c()}}}]);